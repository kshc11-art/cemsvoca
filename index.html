<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="expires" content="0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<meta name="description" content="TOEFL & ì¼ìƒíšŒí™” ì–´íœ˜ í•™ìŠµ - FSRS ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ ë³µìŠµ">
<title>CEMS Vocab Pro v7.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
:root{--primary:#6366f1;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--bg:#0f172a;--bg2:#1e293b;--card:#1e293b;--text:#f1f5f9;--muted:#94a3b8;--border:#334155;--phrasal:#ec4899;--expr:#f97316}
html{background:var(--bg);height:-webkit-fill-available}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:-webkit-fill-available}
.app{max-width:600px;margin:0 auto;padding:16px;padding-top:calc(16px + env(safe-area-inset-top));padding-left:calc(16px + env(safe-area-inset-left));padding-right:calc(16px + env(safe-area-inset-right));padding-bottom:calc(80px + env(safe-area-inset-bottom))}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:6px 0;padding-bottom:calc(6px + env(safe-area-inset-bottom));z-index:9999;opacity:0;transition:opacity .3s}.bottom-nav.visible{opacity:1}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;color:var(--muted);font-size:9px;cursor:pointer;text-decoration:none}
.nav-item.active{color:var(--primary)}
.nav-item svg{width:20px;height:20px;pointer-events:none}
.page{display:none}.page.active{display:block}
.page-header{margin-bottom:20px}.page-header h1{font-size:26px;font-weight:700;margin-bottom:4px}.page-header p{color:var(--muted);font-size:13px}
.card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:12px;border:1px solid var(--border)}
.card-title{font-size:13px;font-weight:600;color:var(--muted);margin-bottom:12px}
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;border:none;cursor:pointer;width:100%}
.btn:active{transform:scale(.98)}.btn-primary{background:var(--primary);color:#fff}.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}.btn-phrasal{background:var(--phrasal);color:#fff}.btn-sm{padding:8px 14px;font-size:12px}
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.stat-grid-2{grid-template-columns:repeat(2,1fr)}.stat-grid-3{grid-template-columns:repeat(3,1fr)}
.stat-item{text-align:center;padding:10px 6px;background:var(--bg);border-radius:10px;cursor:pointer}.stat-item:active{transform:scale(.95)}.stat-value{font-size:22px;font-weight:700;margin-bottom:2px}.stat-value.success{color:var(--success)}.stat-value.warning{color:var(--warning)}.stat-value.danger{color:var(--danger)}.stat-value.phrasal{color:var(--phrasal)}.stat-label{font-size:10px;color:var(--muted)}
.progress-bar{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:6px}.progress-fill{height:100%;background:var(--primary);border-radius:3px;transition:width .3s}.progress-fill.phrasal{background:var(--phrasal)}.progress-text{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
.badge{display:inline-block;padding:3px 8px;font-size:10px;font-weight:600;border-radius:20px}.badge-warning{background:rgba(245,158,11,.2);color:#fbbf24}.badge-danger{background:rgba(239,68,68,.2);color:#f87171}.badge-phrasal{background:rgba(236,72,153,.2);color:#f472b6}
.type-tabs{display:flex;gap:8px;margin-bottom:14px}.type-tab{flex:1;padding:10px;background:var(--bg);border:2px solid var(--border);border-radius:10px;text-align:center;cursor:pointer;font-size:13px;font-weight:600}.type-tab.active{border-color:var(--primary);background:rgba(99,102,241,.1);color:var(--primary)}.type-tab.phrasal.active{border-color:var(--phrasal);background:rgba(236,72,153,.1);color:var(--phrasal)}.type-tab.expr.active{border-color:var(--expr);background:rgba(249,115,22,.1);color:var(--expr)}
.mode-selector{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:8px}.mode-card{padding:12px 8px;background:var(--bg);border-radius:12px;text-align:center;cursor:pointer;border:2px solid transparent}.mode-card.active{border-color:var(--primary);background:rgba(99,102,241,.1)}.mode-card.phrasal.active{border-color:var(--phrasal);background:rgba(236,72,153,.1)}.mode-card.expr.active{border-color:var(--expr);background:rgba(249,115,22,.1)}.mode-card-icon{font-size:24px;margin-bottom:4px}.mode-card-title{font-size:13px;font-weight:600;margin-bottom:2px}.mode-card-desc{font-size:11px;color:var(--muted)}
.range-container{display:flex;align-items:center;gap:16px}.range-slider{flex:1;appearance:none;-webkit-appearance:none;height:6px;background:var(--border);border-radius:3px}.range-slider::-webkit-slider-thumb{appearance:none;-webkit-appearance:none;width:22px;height:22px;background:var(--primary);border-radius:50%}.range-value{font-size:18px;font-weight:700;min-width:60px;text-align:right}
.chip-group{display:flex;flex-wrap:wrap;gap:8px}.chip{padding:8px 14px;background:var(--bg);border-radius:20px;font-size:13px;cursor:pointer;border:1px solid var(--border)}.chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.chip-multi{display:flex;flex-wrap:wrap;gap:6px}.chip-multi .chip{padding:6px 12px;font-size:12px}.chip-multi .chip.checked{background:var(--primary);color:#fff;border-color:var(--primary)}.chip-multi .chip.excluded{background:#ef4444;color:#fff;border-color:#ef4444}
.chip-multi.chip-small .chip{padding:4px 8px;font-size:11px}
.filter-toggle{position:relative;display:inline-block;width:32px;height:18px;background:var(--border);border-radius:9px;cursor:pointer;transition:background .2s;flex-shrink:0}.filter-toggle.active{background:var(--primary)}.filter-toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 2px rgba(0,0,0,.2)}.filter-toggle.active::after{transform:translateX(14px)}
.filter-select{position:relative}.filter-select select{padding-right:28px}.filter-mode{position:absolute;right:4px;top:50%;transform:translateY(-50%);font-size:10px;padding:2px 4px;border-radius:4px;cursor:pointer;background:var(--bg);border:1px solid var(--border)}.filter-mode.exclude{background:#ef4444;color:#fff;border-color:#ef4444}
.form-group{margin-bottom:16px}.form-label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}.form-select{width:100%;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px}
.toggle-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0}.toggle-label{font-size:14px}.toggle-switch{position:relative;width:50px;height:28px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:28px;transition:.3s}.toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}.toggle-switch input:checked+.toggle-slider{background:var(--primary)}.toggle-switch input:checked+.toggle-slider:before{transform:translateX(22px)}
.upload-zone{display:block;border:2px dashed var(--border);border-radius:16px;padding:40px 20px;text-align:center;cursor:pointer}.upload-zone.dragover{border-color:var(--primary);background:rgba(99,102,241,.05)}.upload-zone-icon{font-size:48px;margin-bottom:16px}.upload-zone p{color:var(--muted);font-size:14px}
.search-box{position:relative;margin-bottom:16px}.search-box input{width:100%;padding:12px 16px 12px 44px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px}.search-box svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);width:18px;height:18px;color:var(--muted)}
.quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.quick-action{display:flex;flex-direction:column;align-items:center;padding:16px 8px;background:var(--bg);border-radius:14px;cursor:pointer;position:relative}.quick-action:active{transform:scale(.95)}.quick-action-icon{font-size:28px;margin-bottom:8px}.quick-action-label{font-size:11px;color:var(--muted)}.quick-action-badge{position:absolute;top:8px;right:8px;background:var(--danger);color:#fff;font-size:9px;padding:2px 6px;border-radius:10px}
.streak-banner{background:linear-gradient(135deg,#f59e0b,#ef4444);border-radius:14px;padding:16px;margin-bottom:16px;display:flex;align-items:center;gap:12px}.streak-banner.hidden{display:none}.streak-icon{font-size:36px;animation:flame 0.5s ease-in-out infinite alternate}.streak-days{font-size:24px;font-weight:700}
@keyframes flame{0%{transform:scale(1) rotate(-3deg)}100%{transform:scale(1.1) rotate(3deg)}}
/* í”Œë˜ì‹œì¹´ë“œ - í•µì‹¬ ìˆ˜ì • */
.flashcard-container{perspective:1000px;margin-bottom:20px;min-height:300px}
.flashcard{position:relative;width:100%;height:300px;cursor:pointer;transform-style:preserve-3d;transition:transform .6s}
.flashcard.flipped{transform:rotateY(180deg)}
.flashcard.swipe-left{transform:translateX(-150%) rotate(-20deg);opacity:0;transition:all .4s}
.flashcard.swipe-right{transform:translateX(150%) rotate(20deg);opacity:0;transition:all .4s}
.flashcard-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;-webkit-backface-visibility:hidden;background:var(--card);border-radius:20px;padding:24px;display:flex;flex-direction:column;border:1px solid var(--border);box-shadow:0 20px 40px -12px rgba(0,0,0,.3)}
.flashcard-back{transform:rotateY(180deg)}
/* í•µì‹¬: ë’·ë©´ ë‚´ìš© ìˆ¨ê¹€ */
.flashcard-back-inner{opacity:0;transition:opacity .15s;display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%}.flashcard-back-inner.visible{opacity:1}
.flashcard-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}.tag{font-size:10px;padding:4px 8px;border-radius:10px;font-weight:500}.tag-pos{background:rgba(99,102,241,.2);color:#a5b4fc}.tag-level{background:rgba(16,185,129,.2);color:#6ee7b7}.tag-cat{background:rgba(245,158,11,.2);color:#fcd34d}.tag-phrasal{background:rgba(236,72,153,.2);color:#f472b6}
.flashcard-word{font-size:36px;font-weight:700;text-align:center;margin:auto 0}.flashcard-hint{text-align:center;font-size:13px;color:var(--muted);margin-top:auto}.flashcard-meaning-ko{font-size:26px;font-weight:600;text-align:center;margin-bottom:8px}.flashcard-meaning-en{font-size:14px;text-align:center;color:var(--muted);margin-bottom:16px}.flashcard-example{background:rgba(99,102,241,.1);padding:12px;border-radius:10px;border-left:3px solid var(--primary);font-size:13px;line-height:1.5;margin-bottom:12px}.flashcard-collocation{font-size:13px;color:var(--muted);text-align:center}
.similar-expr-box{background:rgba(249,115,22,.08);border:1px solid rgba(249,115,22,.2);border-radius:10px;padding:10px 12px;margin:10px 0;font-size:12px}.similar-expr-box .similar-title{color:var(--expr);font-weight:600;margin-bottom:6px;font-size:11px}.similar-expr-box .similar-item{color:var(--muted);padding:2px 0}
.swipe-indicator{position:fixed;top:50%;transform:translateY(-50%);font-size:48px;opacity:0;transition:opacity .2s;z-index:50;pointer-events:none}.swipe-indicator.left{left:20px}.swipe-indicator.right{right:20px}.swipe-indicator.show{opacity:1}
.rating-section{margin-bottom:16px}.rating-section.disabled{opacity:.5;pointer-events:none}.rating-hint{text-align:center;font-size:13px;color:var(--muted);margin-bottom:12px}.rating-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.rating-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px 8px;border-radius:12px;font-size:13px;font-weight:600;border:none;cursor:pointer;min-height:70px}.rating-btn:disabled{opacity:.5}.rating-btn.again{background:#fecaca;color:#b91c1c}.rating-btn.hard{background:#fed7aa;color:#c2410c}.rating-btn.good{background:#bbf7d0;color:#15803d}.rating-btn.easy{background:#bfdbfe;color:#1d4ed8}.rating-interval{font-size:10px;opacity:.7;margin-top:4px}
.quiz-options{display:flex;flex-direction:column;gap:10px}.quiz-option{width:100%;padding:16px 20px;background:var(--card);border:2px solid var(--border);border-radius:14px;font-size:15px;color:var(--text);text-align:left;cursor:pointer}.quiz-option:disabled{cursor:default}.quiz-option.correct{background:rgba(16,185,129,.2);border-color:var(--success);color:var(--success)}.quiz-option.wrong{background:rgba(239,68,68,.2);border-color:var(--danger);color:var(--danger)}
.quiz-action-bar{display:flex;gap:6px;margin-top:12px;justify-content:center}.quiz-action-bar button{padding:8px 12px;font-size:12px;min-width:40px}
.retry-banner{background:linear-gradient(135deg,var(--warning),var(--danger));border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;color:#fff}.retry-banner.hidden{display:none}.retry-banner-icon{font-size:24px}.retry-banner-text{flex:1;font-size:14px}.retry-banner-count{font-size:20px;font-weight:700}
.word-table{width:100%;border-collapse:collapse;font-size:13px}.word-table th,.word-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}.word-table th{font-weight:600;color:var(--muted);font-size:11px}.word-table tr:hover{background:var(--bg)}
.table-container{max-height:400px;overflow-y:auto;border-radius:12px;border:1px solid var(--border)}
.leitner-container{display:flex;gap:8px}.leitner-box{flex:1;text-align:center;padding:12px 8px;background:var(--bg);border-radius:10px;border:2px solid var(--border)}.leitner-box.box-1{border-color:#ef4444}.leitner-box.box-2{border-color:#f59e0b}.leitner-box.box-3{border-color:#eab308}.leitner-box.box-4{border-color:#22c55e}.leitner-box.box-5{border-color:#10b981}.leitner-count{font-size:20px;font-weight:700}.leitner-label{font-size:10px;color:var(--muted)}
.chart-container{display:flex;align-items:flex-end;justify-content:space-around;height:150px;padding-top:20px}.chart-bar-wrapper{display:flex;flex-direction:column;align-items:center;gap:4px}.chart-bar{width:28px;background:var(--primary);border-radius:4px 4px 0 0;min-height:4px}.chart-bar.phrasal{background:var(--phrasal)}.chart-bar-label{font-size:10px;color:var(--muted)}.chart-bar-value{font-size:11px;font-weight:600}
.upload-result{margin-top:16px;padding:16px;background:var(--bg);border-radius:12px}.upload-result-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}.upload-result-item:last-child{border-bottom:none}
.blank-word{display:inline-block;min-width:80px;border-bottom:2px dashed var(--primary);margin:0 4px;color:var(--primary);font-weight:600}
.form-input{width:100%;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:18px;text-align:center;font-family:inherit;resize:none}.form-input:focus{border-color:var(--primary);outline:none}.form-input.correct{border-color:var(--success)}.form-input.wrong{border-color:var(--danger)}
.typing-answer{font-size:20px;font-weight:600;margin-top:16px;padding:16px;background:var(--bg);border-radius:12px;text-align:center}.typing-answer.correct{color:var(--success)}.typing-answer.wrong{color:var(--danger)}
.weak-word-item{display:flex;align-items:center;padding:12px;background:var(--bg);border-radius:10px;margin-bottom:8px}.weak-word-text{flex:1}.weak-word-text strong{font-size:15px}.weak-word-text span{font-size:12px;color:var(--muted);display:block;margin-top:2px}.weak-word-stats{text-align:right}.weak-word-rate{font-size:14px;font-weight:600}.weak-word-count{font-size:11px;color:var(--muted)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s;padding:20px}.modal-overlay.show{opacity:1;visibility:visible}.modal{background:var(--card);border-radius:20px;padding:24px;max-width:400px;width:100%;transform:scale(.9);transition:transform .3s}.modal-overlay.show .modal{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.modal-header h3{font-size:20px}.modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--bg);color:var(--muted);font-size:18px;cursor:pointer}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card);color:var(--text);padding:14px 24px;border-radius:30px;font-size:14px;font-weight:500;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:2000;opacity:0;visibility:hidden;pointer-events:none;transition:all .3s}.toast.show{opacity:1;visibility:visible;pointer-events:auto;transform:translateX(-50%) translateY(0)}
.hidden{display:none!important}
.empty-state{text-align:center;padding:32px 16px}.empty-state-icon{font-size:48px;margin-bottom:16px}.empty-state h3{font-size:18px;margin-bottom:8px}.empty-state p{color:var(--muted);font-size:14px}
#splash{position:fixed;inset:0;background:linear-gradient(135deg,#6366f1,#ec4899,#8b5cf6);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}#splash.hidden{opacity:0;visibility:hidden}.splash-icon{font-size:80px;animation:bounce 1s ease infinite}.splash-title{font-size:32px;font-weight:700;color:#fff;margin-top:20px}.splash-sub{font-size:14px;color:rgba(255,255,255,.8);margin-top:8px}.splash-loader{width:40px;height:40px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin-top:40px}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="splash"><div class="splash-icon">ğŸ“š</div><div class="splash-title">CEMS Vocab Pro</div><div class="splash-sub">v7.2 - FSRS-6 Algorithm</div><div class="splash-loader"></div></div>
<div class="app">
<!-- í™ˆ -->
<div id="page-home" class="page active">
<div class="streak-banner hidden" id="streak-banner"><div class="streak-icon">ğŸ”¥</div><div><div style="font-size:13px;opacity:.9">ì—°ì† í•™ìŠµ</div><div class="streak-days"><span id="streak-days">0</span>ì¼ì§¸</div></div></div>
<div class="card" id="daily-goal-card" style="background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(139,92,246,.1))"><div class="card-title"><span>ğŸ¯ ì˜¤ëŠ˜ì˜ ëª©í‘œ</span></div>
<div style="display:flex;gap:6px;margin-bottom:12px">
<div style="flex:1;text-align:center;padding:6px;background:var(--bg);border-radius:8px"><div style="font-size:10px;color:var(--muted)">ğŸ“– ì–´íœ˜</div><div style="font-size:14px;font-weight:600"><span id="daily-vocab-done">0</span>/<span id="daily-vocab-target">20</span></div><div class="progress-bar" style="height:3px;margin-top:4px"><div class="progress-fill" id="daily-vocab-progress" style="width:0%"></div></div></div>
<div style="flex:1;text-align:center;padding:6px;background:var(--bg);border-radius:8px"><div style="font-size:10px;color:var(--muted)">ğŸ”— êµ¬ë™ì‚¬</div><div style="font-size:14px;font-weight:600"><span id="daily-pv-done">0</span>/<span id="daily-pv-target">10</span></div><div class="progress-bar" style="height:3px;margin-top:4px"><div class="progress-fill" id="daily-pv-progress" style="width:0%;background:var(--phrasal)"></div></div></div>
<div style="flex:1;text-align:center;padding:6px;background:var(--bg);border-radius:8px"><div style="font-size:10px;color:var(--muted)">ğŸ’¬ í‘œí˜„</div><div style="font-size:14px;font-weight:600"><span id="daily-expr-done">0</span>/<span id="daily-expr-target">10</span></div><div class="progress-bar" style="height:3px;margin-top:4px"><div class="progress-fill" id="daily-expr-progress" style="width:0%;background:var(--expr)"></div></div></div>
</div>
<div class="progress-bar" style="height:12px;margin-bottom:8px"><div class="progress-fill" id="daily-total-progress" style="width:0%;background:linear-gradient(90deg,#f97316,#fb923c,#fbbf24)"></div></div>
<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:13px;color:var(--muted)">ì „ì²´ <span id="daily-done">0</span> / <span id="daily-target">40</span>ê°œ</span><span id="daily-percent" style="font-size:18px;font-weight:700;color:var(--primary)">0%</span></div></div>
<div class="type-tabs"><div class="type-tab active" data-type="vocab" onclick="switchGlobalType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" data-type="phrasal" onclick="switchGlobalType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" data-type="expr" onclick="switchGlobalType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div id="home-vocab">
<div class="card"><div class="card-title" style="display:flex;align-items:center;justify-content:space-between">âš¡ ë¹ ë¥¸ ì‹œì‘<div style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:normal;color:var(--muted)"><span>ğŸ¯í•„í„°</span><div class="filter-toggle" id="quick-filter-vocab" onclick="toggleQuickFilter('vocab')"></div></div></div><div class="quick-actions"><div class="quick-action" onclick="safeStart(()=>quickStartMode('vocab','flashcard'))"><div class="quick-action-icon">ğŸƒ</div><div class="quick-action-label">í”Œë˜ì‹œì¹´ë“œ</div><span class="quick-action-badge hidden" id="due-badge-vocab">0</span></div><div class="quick-action" onclick="safeStart(()=>quickStartMode('vocab','quiz'))"><div class="quick-action-icon">â“</div><div class="quick-action-label">5ì§€ì„ ë‹¤</div></div><div class="quick-action" onclick="safeStart(()=>startProductionStudy('vocab'))"><div class="quick-action-icon">ğŸ–Šï¸</div><div class="quick-action-label">ì‚°ì¶œ ì—°ìŠµ</div><span class="quick-action-badge hidden" id="prod-badge-vocab">0</span></div><div class="quick-action" onclick="safeStart(()=>startWrongReview('vocab'))"><div class="quick-action-icon">ğŸ“</div><div class="quick-action-label">ì˜¤ë‹µë…¸íŠ¸</div><span class="quick-action-badge hidden" id="wrong-badge-vocab">0</span></div></div></div>
<div class="card"><div class="card-title">ğŸ†• ìƒˆ ë‹¨ì–´ & â­ ë¶ë§ˆí¬</div>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
<button class="btn" onclick="safeStart(()=>startNewWordsStudy('vocab'))" style="flex:1;height:44px;font-size:14px;border-radius:12px;display:flex;align-items:center;justify-content:center;gap:6px;position:relative;background:rgba(99,102,241,0.25);color:#fff;border:1px solid rgba(99,102,241,0.4)">ğŸ†• ì‹ ê·œ í•™ìŠµ<span class="quick-action-badge hidden" id="new-badge-vocab">0</span></button>
<button class="btn btn-secondary" onclick="safeStart(()=>startStarredStudy('vocab'))" style="width:auto;min-width:50px;height:44px;flex:0 0 auto;padding:0 12px;font-size:14px;border-radius:12px" title="â­ ë¶ë§ˆí¬ í•™ìŠµ">â­ <span id="star-badge-vocab">0</span></button>
<select class="form-select" id="home-tag-select" onchange="startTagStudy('vocab')" style="width:100px;flex:0 0 auto;height:44px;font-size:14px"><option value="">ğŸ·ï¸ íƒœê·¸</option></select>
</div>
<div style="display:flex;gap:8px;align-items:center"><button class="btn" onclick="openPasteModal('vocab')" style="width:auto;height:44px;flex:0 0 auto;padding:0 14px;font-size:14px;border-radius:12px;background:rgba(99,102,241,0.25);color:#fff;border:1px solid rgba(99,102,241,0.4)">â• ì¶”ê°€</button><input type="text" id="quick-search-input" placeholder="ê²€ìƒ‰..." style="flex:1 1 auto;min-width:0;height:44px;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:0 14px;font-size:14px;color:var(--text)" onkeyup="if(event.key==='Enter')quickSearch()"><button class="btn btn-secondary" onclick="quickSearch()" style="width:44px;height:44px;flex:0 0 auto;padding:0;font-size:16px;border-radius:12px">ğŸ”</button></div>
<div id="quick-search-result" style="display:none;background:var(--bg);border-radius:12px;padding:12px;margin-top:12px;position:relative">
<button onclick="document.getElementById('quick-search-result').style.display='none'" style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:16px;cursor:pointer;color:var(--muted)">âœ•</button>
<div id="quick-search-found" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong id="qs-word" style="font-size:18px"></strong><button class="btn btn-secondary" style="width:auto;padding:6px 10px;font-size:14px" onclick="speakQSWord()">ğŸ”Š</button></div>
<div style="font-size:15px;margin-bottom:6px" id="qs-meaning"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px" id="qs-info"></div>
<div id="qs-example" style="display:none;font-size:13px;color:var(--muted);background:var(--card);padding:8px 10px;border-radius:8px;border-left:3px solid var(--primary);margin-bottom:10px"></div>
<div style="display:flex;gap:6px;flex-wrap:wrap">
<button id="qs-bookmark-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="quickToggleBookmark()">â˜†</button>
<button id="qs-prod-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="quickToggleProduction()">ğŸ–Šï¸</button>
<button class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="quickEditWord()">âœï¸ ìˆ˜ì •</button>
</div>
<div id="qs-not-this" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"><span style="font-size:12px;color:var(--muted)">ì°¾ëŠ” ë‹¨ì–´ê°€ ì•„ë‹Œê°€ìš”?</span> <button class="btn btn-secondary btn-sm" onclick="showAddNewFromSearch()" style="width:auto;padding:4px 10px;font-size:12px;margin-left:8px">â• "<span id="qs-original-query"></span>" ì¶”ê°€</button></div>
</div>
<div id="quick-search-notfound" style="display:none">
<p style="text-align:center;color:var(--muted);margin-bottom:12px">ğŸ˜• DBì— ì—†ëŠ” ë‹¨ì–´ì…ë‹ˆë‹¤</p>
<div style="margin-bottom:8px"><strong id="qs-new-word" style="font-size:15px"></strong></div>
<input type="text" id="qs-new-meaning" placeholder="ëœ» ì…ë ¥..." style="width:100%;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:14px;color:var(--text);margin-bottom:8px">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px"><label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="qs-add-bookmark" checked> â­ ë¶ë§ˆí¬ì— ì¶”ê°€</label></div>
<div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="quickSaveNewWord()" style="flex:1">ğŸ’¾ ì €ì¥</button><button class="btn btn-secondary btn-sm" onclick="quickAddWord()" style="width:auto;padding:8px 12px">âœï¸ ìƒì„¸</button></div>
</div>
</div></div>
<div class="card"><div class="card-title">ğŸ“Š ì–´íœ˜ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="stat-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="stat-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item" onclick="showWeakWords('vocab')"><div class="stat-value warning" id="stat-weak">0</div><div class="stat-label">ì·¨ì•½</div></div><div class="stat-item" onclick="safeStart(()=>startReviewDue('vocab'))"><div class="stat-value danger" id="stat-due">0</div><div class="stat-label">ë³µìŠµ</div></div></div></div>
</div>
<div id="home-phrasal" class="hidden">
<div class="card"><div class="card-title" style="display:flex;align-items:center;justify-content:space-between">âš¡ ë¹ ë¥¸ ì‹œì‘<div style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:normal;color:var(--muted)"><span>ğŸ¯í•„í„°</span><div class="filter-toggle" id="quick-filter-phrasal" onclick="toggleQuickFilter('phrasal')"></div></div></div><div class="quick-actions"><div class="quick-action" onclick="safeStart(()=>quickStartMode('phrasal','pv-flashcard'))"><div class="quick-action-icon">ğŸƒ</div><div class="quick-action-label">í”Œë˜ì‹œì¹´ë“œ</div><span class="quick-action-badge hidden" id="due-badge-pv">0</span></div><div class="quick-action" onclick="safeStart(()=>quickStartMode('phrasal','pv-particle'))"><div class="quick-action-icon">ğŸ§©</div><div class="quick-action-label">Particle</div></div><div class="quick-action" onclick="safeStart(()=>startProductionStudy('phrasal'))"><div class="quick-action-icon">ğŸ–Šï¸</div><div class="quick-action-label">ì‚°ì¶œ ì—°ìŠµ</div><span class="quick-action-badge hidden" id="prod-badge-pv">0</span></div><div class="quick-action" onclick="safeStart(()=>startWrongReview('phrasal'))"><div class="quick-action-icon">ğŸ“</div><div class="quick-action-label">ì˜¤ë‹µë…¸íŠ¸</div><span class="quick-action-badge hidden" id="wrong-badge-pv">0</span></div></div></div>
<div class="card"><div class="card-title">ğŸ†• ìƒˆ ë‹¨ì–´ & â­ ë¶ë§ˆí¬</div>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
<button class="btn" onclick="safeStart(()=>startNewWordsStudy('phrasal'))" style="flex:1;height:44px;font-size:14px;border-radius:12px;display:flex;align-items:center;justify-content:center;gap:6px;position:relative;background:rgba(236,72,153,0.25);color:#fff;border:1px solid rgba(236,72,153,0.4)">ğŸ†• ì‹ ê·œ í•™ìŠµ<span class="quick-action-badge hidden" id="new-badge-pv">0</span></button>
<button class="btn btn-secondary" onclick="safeStart(()=>startStarredStudy('phrasal'))" style="width:auto;min-width:50px;height:44px;flex:0 0 auto;padding:0 12px;font-size:14px;border-radius:12px" title="â­ ë¶ë§ˆí¬ í•™ìŠµ">â­ <span id="star-badge-pv">0</span></button>
<select class="form-select" id="home-pv-tag-select" onchange="startTagStudy('phrasal')" style="width:100px;flex:0 0 auto;height:44px;font-size:14px"><option value="">ğŸ·ï¸ íƒœê·¸</option></select>
</div>
<div style="display:flex;gap:8px;align-items:center"><button class="btn" onclick="openPasteModal('phrasal')" style="width:auto;height:44px;flex:0 0 auto;padding:0 14px;font-size:14px;border-radius:12px;background:rgba(236,72,153,0.25);color:#fff;border:1px solid rgba(236,72,153,0.4)">â• ì¶”ê°€</button><input type="text" id="pv-quick-search-input" placeholder="ê²€ìƒ‰..." style="flex:1 1 auto;min-width:0;height:44px;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:0 14px;font-size:14px;color:var(--text)" onkeyup="if(event.key==='Enter')pvQuickSearch()"><button class="btn btn-secondary" onclick="pvQuickSearch()" style="width:44px;height:44px;flex:0 0 auto;padding:0;font-size:16px;border-radius:12px">ğŸ”</button></div>
<div id="pv-quick-search-result" style="display:none;background:var(--bg);border-radius:12px;padding:12px;margin-top:12px;position:relative">
<button onclick="document.getElementById('pv-quick-search-result').style.display='none'" style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:16px;cursor:pointer;color:var(--muted)">âœ•</button>
<div id="pv-qs-found" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong id="pv-qs-word" style="font-size:18px"></strong><button class="btn btn-secondary" style="width:auto;padding:6px 10px;font-size:14px" onclick="speakPVQSWord()">ğŸ”Š</button></div>
<div style="font-size:15px;margin-bottom:6px" id="pv-qs-meaning"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px" id="pv-qs-info"></div>
<div id="pv-qs-example" style="display:none;font-size:13px;color:var(--muted);background:var(--card);padding:8px 10px;border-radius:8px;border-left:3px solid var(--phrasal);margin-bottom:10px"></div>
<div style="display:flex;gap:6px;flex-wrap:wrap">
<button id="pv-qs-bookmark-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="pvQSToggleBookmark()">â˜†</button>
<button id="pv-qs-prod-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="pvQSToggleProduction()">ğŸ–Šï¸</button>
<button class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="pvQSEdit()">âœï¸ ìˆ˜ì •</button>
</div>
<div id="pv-qs-not-this" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"><span style="font-size:12px;color:var(--muted)">ì°¾ëŠ” êµ¬ë™ì‚¬ê°€ ì•„ë‹Œê°€ìš”?</span> <button class="btn btn-secondary btn-sm" onclick="showPVAddNew()" style="width:auto;padding:4px 10px;font-size:12px;margin-left:8px">â• "<span id="pv-qs-original"></span>" ì¶”ê°€</button></div>
</div>
<div id="pv-qs-notfound" style="display:none">
<p style="text-align:center;color:var(--muted);margin-bottom:12px">ğŸ˜• DBì— ì—†ëŠ” êµ¬ë™ì‚¬ì…ë‹ˆë‹¤</p>
<div style="margin-bottom:8px"><strong id="pv-qs-new-word" style="font-size:15px"></strong></div>
<input type="text" id="pv-qs-new-meaning" placeholder="ëœ» ì…ë ¥..." style="width:100%;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:14px;color:var(--text);margin-bottom:8px">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px"><label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="pv-qs-add-bookmark" checked> â­ ë¶ë§ˆí¬ì— ì¶”ê°€</label></div>
<div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="pvQSSaveNew()" style="flex:1">ğŸ’¾ ì €ì¥</button><button class="btn btn-secondary btn-sm" onclick="pvQSAddDetail()" style="width:auto;padding:8px 12px">âœï¸ ìƒì„¸</button></div>
</div>
</div>
</div>
<div class="card"><div class="card-title">ğŸ”— êµ¬ë™ì‚¬ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value phrasal" id="pv-stat-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="pv-stat-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item" onclick="showWeakWords('phrasal')"><div class="stat-value warning" id="pv-stat-weak">0</div><div class="stat-label">ì·¨ì•½</div></div><div class="stat-item" onclick="safeStart(()=>startReviewDue('phrasal'))"><div class="stat-value danger" id="pv-stat-due">0</div><div class="stat-label">ë³µìŠµ</div></div></div></div>
</div>
<div id="home-expr" class="hidden">
<div class="card"><div class="card-title" style="display:flex;align-items:center;justify-content:space-between">âš¡ ë¹ ë¥¸ ì‹œì‘<div style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:normal;color:var(--muted)"><span>ğŸ¯í•„í„°</span><div class="filter-toggle" id="quick-filter-expr" onclick="toggleQuickFilter('expr')"></div></div></div><div class="quick-actions"><div class="quick-action" onclick="safeStart(()=>quickStartMode('expr','expr-fc'))"><div class="quick-action-icon">ğŸƒ</div><div class="quick-action-label">í”Œë˜ì‹œì¹´ë“œ</div><span class="quick-action-badge hidden" id="due-badge-expr">0</span></div><div class="quick-action" onclick="safeStart(()=>quickStartMode('expr','expr-quiz'))"><div class="quick-action-icon">â“</div><div class="quick-action-label">5ì§€ì„ ë‹¤</div></div><div class="quick-action" onclick="safeStart(()=>startProductionStudy('expr'))"><div class="quick-action-icon">ğŸ–Šï¸</div><div class="quick-action-label">ì‚°ì¶œ ì—°ìŠµ</div><span class="quick-action-badge hidden" id="prod-badge-expr">0</span></div><div class="quick-action" onclick="safeStart(startExprWrong)"><div class="quick-action-icon">ğŸ“</div><div class="quick-action-label">ì˜¤ë‹µë…¸íŠ¸</div><span class="quick-action-badge hidden" id="wrong-badge-expr">0</span></div></div></div>
<div class="card"><div class="card-title">ğŸ†• ìƒˆ ë‹¨ì–´ & â­ ë¶ë§ˆí¬</div>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
<button class="btn" onclick="safeStart(()=>startNewWordsStudy('expr'))" style="flex:1;height:44px;font-size:14px;border-radius:12px;display:flex;align-items:center;justify-content:center;gap:6px;position:relative;background:rgba(249,115,22,0.25);color:#fff;border:1px solid rgba(249,115,22,0.4)">ğŸ†• ì‹ ê·œ í•™ìŠµ<span class="quick-action-badge hidden" id="new-badge-expr">0</span></button>
<button class="btn btn-secondary" onclick="safeStart(startExprStarred)" style="width:auto;min-width:50px;height:44px;flex:0 0 auto;padding:0 12px;font-size:14px;border-radius:12px" title="â­ ë¶ë§ˆí¬ í•™ìŠµ">â­ <span id="star-badge-expr">0</span></button>
<select class="form-select" id="home-expr-tag-select" onchange="safeStart(startExprTagStudy)" style="width:100px;flex:0 0 auto;height:44px;font-size:14px"><option value="">ğŸ·ï¸ íƒœê·¸</option></select>
</div>
<div style="display:flex;gap:8px;align-items:center"><button class="btn" onclick="openPasteModal('expr')" style="width:auto;height:44px;flex:0 0 auto;padding:0 14px;font-size:14px;border-radius:12px;background:rgba(249,115,22,0.25);color:#fff;border:1px solid rgba(249,115,22,0.4)">â• ì¶”ê°€</button><input type="text" id="expr-search-input" placeholder="ê²€ìƒ‰..." style="flex:1 1 auto;min-width:0;height:44px;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:0 14px;font-size:14px;color:var(--text)" onkeyup="if(event.key==='Enter')exprSearch()"><button class="btn btn-secondary" onclick="exprSearch()" style="width:44px;height:44px;flex:0 0 auto;padding:0;font-size:16px;border-radius:12px">ğŸ”</button></div>
<div id="expr-search-result" style="display:none;background:var(--bg);border-radius:12px;padding:12px;margin-top:12px;position:relative">
<button onclick="document.getElementById('expr-search-result').style.display='none'" style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:16px;cursor:pointer;color:var(--muted)">âœ•</button>
<div id="expr-qs-found" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong id="expr-qs-word" style="font-size:18px"></strong><span id="expr-qs-formality" style="font-size:11px;padding:2px 8px;border-radius:10px;background:rgba(249,115,22,.15);color:var(--expr)"></span></div>
<div style="font-size:14px;margin-bottom:4px" id="expr-qs-func"></div>
<div style="font-size:15px;margin-bottom:6px" id="expr-qs-meaning"></div>
<div id="expr-qs-example" style="display:none;font-size:13px;color:var(--muted);background:var(--card);padding:8px 10px;border-radius:8px;border-left:3px solid var(--expr);margin-bottom:10px"></div>
<div id="expr-qs-similar" style="display:none;font-size:12px;color:var(--muted);margin-bottom:8px">ìœ ì‚¬: <span id="expr-qs-similar-list"></span></div>
<div style="display:flex;gap:6px;flex-wrap:wrap">
<button id="expr-qs-bookmark-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="exprQSToggleBookmark()">â˜†</button>
<button class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="exprQSEdit()">âœï¸ ìˆ˜ì •</button>
</div>
<div id="expr-qs-not-this" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"><span style="font-size:12px;color:var(--muted)">ì°¾ëŠ” í‘œí˜„ì´ ì•„ë‹Œê°€ìš”?</span> <button class="btn btn-secondary btn-sm" onclick="showExprAddNew()" style="width:auto;padding:4px 10px;font-size:12px;margin-left:8px">â• "<span id="expr-qs-original"></span>" ì¶”ê°€</button></div>
</div>
<div id="expr-qs-notfound" style="display:none">
<p style="text-align:center;color:var(--muted);margin-bottom:12px">ğŸ˜• DBì— ì—†ëŠ” í‘œí˜„ì…ë‹ˆë‹¤</p>
<div style="margin-bottom:8px"><strong id="expr-qs-new-word" style="font-size:15px"></strong></div>
<input type="text" id="expr-qs-new-meaning" placeholder="ëœ»/ê¸°ëŠ¥ ì…ë ¥..." style="width:100%;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:14px;color:var(--text);margin-bottom:8px">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px"><label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="expr-qs-add-bookmark" checked> â­ ë¶ë§ˆí¬ì— ì¶”ê°€</label></div>
<div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="exprQSSaveNew()" style="flex:1">ğŸ’¾ ì €ì¥</button><button class="btn btn-secondary btn-sm" onclick="exprQSAddDetail()" style="width:auto;padding:8px 12px">âœï¸ ìƒì„¸</button></div>
</div>
</div>
</div>
<div class="card"><div class="card-title">ğŸ’¬ í‘œí˜„ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="expr-stat-total" style="color:var(--expr)">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="expr-stat-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item" onclick="showWeakWords('expr')"><div class="stat-value warning" id="expr-stat-weak">0</div><div class="stat-label">ì·¨ì•½</div></div><div class="stat-item" onclick="safeStart(startExprDue)"><div class="stat-value danger" id="expr-stat-due">0</div><div class="stat-label">ë³µìŠµ</div></div></div></div>
</div>
<div class="card" id="db-card" onclick="showPage('data')" style="cursor:pointer"><div class="card-title">ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤</div><div id="db-status"><div class="empty-state" style="padding:16px 12px"><div class="empty-state-icon" style="font-size:32px;margin-bottom:8px">ğŸ“¤</div><h3 style="font-size:14px;margin-bottom:4px">DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h3><p style="font-size:12px">íƒ­í•˜ì—¬ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</p></div></div></div>
</div>
<!-- í•™ìŠµ ì„¤ì • -->
<div id="page-study" class="page">
<div class="type-tabs" id="study-type-tabs"><div class="type-tab active" data-type="vocab" onclick="switchGlobalType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" data-type="phrasal" onclick="switchGlobalType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" data-type="expr" onclick="switchGlobalType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div id="study-vocab">
<div class="card"><div class="card-title">ğŸ® í•™ìŠµ ëª¨ë“œ</div><div class="mode-selector"><div class="mode-card active" data-mode="flashcard" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">ğŸƒ</div><div class="mode-card-title">í”Œë˜ì‹œì¹´ë“œ</div><div class="mode-card-desc">ì¹´ë“œ ë’¤ì§‘ê¸°</div></div><div class="mode-card" data-mode="quiz" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">â“</div><div class="mode-card-title">5ì§€ì„ ë‹¤</div><div class="mode-card-desc">ì˜ë¯¸ ë§ì¶”ê¸°</div></div></div><div class="mode-selector"><div class="mode-card" data-mode="reverse" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">ğŸ”„</div><div class="mode-card-title">ì—­ë°©í–¥</div><div class="mode-card-desc">ëœ»â†’ì˜ì–´</div></div><div class="mode-card" data-mode="typing" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">âŒ¨ï¸</div><div class="mode-card-title">íƒ€ì´í•‘</div><div class="mode-card-desc">ìŠ¤í ë§</div></div></div><div class="mode-selector"><div class="mode-card" data-mode="cloze" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">ğŸ“</div><div class="mode-card-title">ë¹ˆì¹¸ì±„ìš°ê¸°</div><div class="mode-card-desc">ë¬¸ì¥ ì™„ì„±</div></div><div class="mode-card" data-mode="collocation" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">ğŸ”—</div><div class="mode-card-title">Collocation</div><div class="mode-card-desc">ì—°ì–´ í•™ìŠµ</div></div></div><div class="mode-selector"><div class="mode-card" data-mode="listening" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">ğŸ§</div><div class="mode-card-title">ë¦¬ìŠ¤ë‹</div><div class="mode-card-desc">ë“£ê³  ëœ» ë§ì¶”ê¸°</div></div><div class="mode-card" data-mode="dictation" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">âœï¸</div><div class="mode-card-title">ë°›ì•„ì“°ê¸°</div><div class="mode-card-desc">ë“£ê³  ìŠ¤í ë§</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“ í•™ìŠµ ë¶„ëŸ‰</div><div class="range-container"><input type="range" class="range-slider" id="study-count" min="5" max="20" value="20" step="1" oninput="document.getElementById('study-count-val').textContent=this.value"><div class="range-value"><span id="study-count-val">20</span>ê°œ</div></div></div>
<div class="card"><div class="card-title">ğŸ¯ í•„í„° <span style="font-size:11px;color:var(--muted);font-weight:normal">(í´ë¦­: í¬í•¨ / ë”ë¸”í´ë¦­: ì œì™¸)</span></div><div class="form-group"><label class="form-label">í•™ìŠµ ìƒíƒœ</label><div class="chip-multi" id="filter-mastery"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="new">ìƒˆ ë‹¨ì–´</span><span class="chip" data-value="weak">ì·¨ì•½</span><span class="chip" data-value="wrong">ì˜¤ë‹µ</span><span class="chip" data-value="starred">â­ë¶ë§ˆí¬</span><span class="chip" data-value="leech">ğŸŒLeech</span></div></div><div class="form-group"><label class="form-label">ğŸ“š CEFR</label><div class="chip-multi chip-small" id="filter-cefr"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="A2">A2</span><span class="chip" data-value="B1">B1</span><span class="chip" data-value="B2">B2</span><span class="chip" data-value="C1">C1</span><span class="chip" data-value="C2">C2</span></div></div><div class="form-group"><label class="form-label">ğŸ“Š ë¹ˆë„</label><div class="chip-multi chip-small" id="filter-freq"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="K1">K1</span><span class="chip" data-value="K2">K2</span><span class="chip" data-value="K3">K3</span><span class="chip" data-value="K4">K4</span><span class="chip" data-value="K5">K5</span><span class="chip" data-value="K6">K6</span></div></div><div class="form-group"><label class="form-label">ğŸ¯ ìš°ì„ ìˆœìœ„</label><div class="chip-multi chip-small" id="filter-priority"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="P1">P1</span><span class="chip" data-value="P2">P2</span><span class="chip" data-value="P3">P3</span></div></div><div class="form-group"><label class="form-label">ğŸ‘” ê²©ì‹ë„ (Formality)</label><div class="chip-multi chip-small" id="filter-formality"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="Formal">Formal</span><span class="chip" data-value="Neutral">Neutral</span><span class="chip" data-value="Informal">Informal</span></div></div><div class="form-group"><label class="form-label">â³ ì‹œëŒ€ì„± (Currency)</label><div class="chip-multi chip-small" id="filter-currency"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="Current">Current</span><span class="chip" data-value="Dated">Dated</span><span class="chip" data-value="Archaic">Archaic</span></div></div><div class="form-group"><label class="form-label">ğŸ“¡ ë§¤ì²´ (Medium)</label><div class="chip-multi chip-small" id="filter-medium"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="Both">Both</span><span class="chip" data-value="Written">Written</span><span class="chip" data-value="Spoken">Spoken</span></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div class="form-group" style="margin-bottom:0"><label class="form-label">ğŸ“ ì¹´í…Œê³ ë¦¬</label><select class="form-select" id="filter-l1"><option value="all">ì „ì²´</option></select></div><div class="form-group" style="margin-bottom:0"><label class="form-label">ğŸ“ TOEFL</label><select class="form-select" id="filter-toefl"><option value="all">ì „ì²´</option></select></div><div class="form-group" style="margin-bottom:0"><label class="form-label">ğŸ“° COCA</label><select class="form-select" id="filter-coca"><option value="all">ì „ì²´</option></select></div></div><div class="form-group" style="margin-top:8px"><label class="form-label">ğŸ·ï¸ íƒœê·¸</label><div class="chip-multi chip-small" id="filter-tag"><span class="chip checked" data-value="all">ì „ì²´</span></div></div><div style="margin-top:12px;display:flex;gap:8px"><button class="btn" style="flex:1;padding:8px;font-size:12px" onclick="resetFilters('vocab')">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="flex:1;padding:8px;font-size:12px" onclick="saveFilters('vocab')">ğŸ’¾ í•„í„° ì €ì¥</button></div></div>
</div>
<div id="study-phrasal" class="hidden">
<div class="card"><div class="card-title">ğŸ® êµ¬ë™ì‚¬ í•™ìŠµ ëª¨ë“œ</div><div class="mode-selector"><div class="mode-card phrasal active" data-mode="pv-flashcard" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">ğŸƒ</div><div class="mode-card-title">í”Œë˜ì‹œì¹´ë“œ</div><div class="mode-card-desc">ì¹´ë“œ ë’¤ì§‘ê¸°</div></div><div class="mode-card phrasal" data-mode="pv-particle" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">ğŸ§©</div><div class="mode-card-title">Particle</div><div class="mode-card-desc">figure ___?</div></div></div><div class="mode-selector"><div class="mode-card phrasal" data-mode="pv-meaning" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">ğŸ’¡</div><div class="mode-card-title">ì˜ë¯¸ ë§ì¶”ê¸°</div><div class="mode-card-desc">êµ¬ë™ì‚¬â†’ëœ»</div></div><div class="mode-card phrasal" data-mode="pv-reverse" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">ğŸ”„</div><div class="mode-card-title">ì—­ë°©í–¥</div><div class="mode-card-desc">ëœ»â†’êµ¬ë™ì‚¬</div></div></div><div class="mode-selector"><div class="mode-card phrasal" data-mode="pv-listening" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">ğŸ§</div><div class="mode-card-title">ë¦¬ìŠ¤ë‹</div><div class="mode-card-desc">ë“£ê³  ëœ» ë§ì¶”ê¸°</div></div><div class="mode-card phrasal" data-mode="pv-dictation" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">âœï¸</div><div class="mode-card-title">ë°›ì•„ì“°ê¸°</div><div class="mode-card-desc">ë“£ê³  ìŠ¤í ë§</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“ í•™ìŠµ ë¶„ëŸ‰</div><div class="range-container"><input type="range" class="range-slider" id="pv-study-count" min="5" max="20" value="15" step="1" oninput="document.getElementById('pv-study-count-val').textContent=this.value"><div class="range-value"><span id="pv-study-count-val">15</span>ê°œ</div></div></div>
<div class="card"><div class="card-title">ğŸ¯ í•„í„° <span style="font-size:11px;color:var(--muted);font-weight:normal">(í´ë¦­: í¬í•¨ / ë”ë¸”í´ë¦­: ì œì™¸)</span></div><div class="form-group"><label class="form-label">í•™ìŠµ ìƒíƒœ</label><div class="chip-multi" id="pv-filter-mastery"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="new">ìƒˆ ë‹¨ì–´</span><span class="chip" data-value="weak">ì·¨ì•½</span><span class="chip" data-value="wrong">ì˜¤ë‹µ</span><span class="chip" data-value="starred">â­ë¶ë§ˆí¬</span><span class="chip" data-value="leech">ğŸŒLeech</span></div></div><div class="form-group"><label class="form-label">ğŸ“š CEFR</label><div class="chip-multi chip-small" id="pv-filter-cefr"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="A2">A2</span><span class="chip" data-value="B1">B1</span><span class="chip" data-value="B2">B2</span><span class="chip" data-value="C1">C1</span><span class="chip" data-value="C2">C2</span></div></div><div class="form-group"><label class="form-label">ğŸ¯ ìš°ì„ ìˆœìœ„</label><div class="chip-multi chip-small" id="pv-filter-priority"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="P1">P1</span><span class="chip" data-value="P2">P2</span><span class="chip" data-value="P3">P3</span></div></div><div class="form-group"><label class="form-label">ğŸ‘” ê²©ì‹ë„</label><div class="chip-multi chip-small" id="pv-filter-formality"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="Formal">Formal</span><span class="chip" data-value="Neutral">Neutral</span><span class="chip" data-value="Informal">Informal</span></div></div><div class="form-group"><label class="form-label">â³ ì‹œëŒ€ì„±</label><div class="chip-multi chip-small" id="pv-filter-currency"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="Current">Current</span><span class="chip" data-value="Dated">Dated</span><span class="chip" data-value="Archaic">Archaic</span></div></div><div class="form-group"><label class="form-label">ğŸ“¡ ë§¤ì²´</label><div class="chip-multi chip-small" id="pv-filter-medium"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="Both">Both</span><span class="chip" data-value="Written">Written</span><span class="chip" data-value="Spoken">Spoken</span></div></div><div class="form-group"><label class="form-label">ğŸ“ ì¹´í…Œê³ ë¦¬</label><select class="form-select" id="pv-filter-cat"><option value="all">ì „ì²´</option></select></div><div class="form-group"><label class="form-label">ğŸ·ï¸ íƒœê·¸</label><div class="chip-multi chip-small" id="pv-filter-tag"><span class="chip checked" data-value="all">ì „ì²´</span></div></div><div style="margin-top:12px;display:flex;gap:8px"><button class="btn" style="flex:1;padding:8px;font-size:12px" onclick="resetFilters('phrasal')">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="flex:1;padding:8px;font-size:12px" onclick="saveFilters('phrasal')">ğŸ’¾ í•„í„° ì €ì¥</button></div></div>
</div>
<div id="study-expr" class="hidden">
<div class="card"><div class="card-title">ğŸ® í‘œí˜„ í•™ìŠµ ëª¨ë“œ</div><div class="mode-selector"><div class="mode-card expr active" data-mode="expr-fc" onclick="selectMode(this,'expr')"><div class="mode-card-icon">ğŸƒ</div><div class="mode-card-title">í”Œë˜ì‹œì¹´ë“œ</div><div class="mode-card-desc">í‘œí˜„ ì•”ê¸°</div></div><div class="mode-card expr" data-mode="expr-quiz" onclick="selectMode(this,'expr')"><div class="mode-card-icon">â“</div><div class="mode-card-title">5ì§€ì„ ë‹¤</div><div class="mode-card-desc">ëœ» ë§ì¶”ê¸°</div></div><div class="mode-card expr" data-mode="expr-cloze" onclick="selectMode(this,'expr')"><div class="mode-card-icon">ğŸ“</div><div class="mode-card-title">ë¹ˆì¹¸ì±„ìš°ê¸°</div><div class="mode-card-desc">ë¬¸ë§¥ í•™ìŠµ</div></div><div class="mode-card expr" data-mode="expr-typing" onclick="selectMode(this,'expr')"><div class="mode-card-icon">âŒ¨ï¸</div><div class="mode-card-title">ì“°ê¸° ì—°ìŠµ</div><div class="mode-card-desc">í‘œí˜„ íƒ€ì´í•‘</div></div></div><div class="mode-selector"><div class="mode-card expr" data-mode="expr-listening" onclick="selectMode(this,'expr')"><div class="mode-card-icon">ğŸ§</div><div class="mode-card-title">ë¦¬ìŠ¤ë‹</div><div class="mode-card-desc">ë“£ê³  ëœ» ë§ì¶”ê¸°</div></div><div class="mode-card expr" data-mode="expr-dictation" onclick="selectMode(this,'expr')"><div class="mode-card-icon">âœï¸</div><div class="mode-card-title">ë°›ì•„ì“°ê¸°</div><div class="mode-card-desc">ë“£ê³  ìŠ¤í ë§</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“ í•™ìŠµ ë¶„ëŸ‰</div><div class="range-container"><input type="range" class="range-slider" id="expr-study-count" min="5" max="20" value="20" step="1" oninput="document.getElementById('expr-study-count-val').textContent=this.value"><div class="range-value"><span id="expr-study-count-val">20</span>ê°œ</div></div></div>
<div class="card"><div class="card-title">ğŸ¯ í•„í„° <span style="font-size:11px;color:var(--muted);font-weight:normal">(í´ë¦­: í¬í•¨ / ë”ë¸”í´ë¦­: ì œì™¸)</span></div><div class="form-group"><label class="form-label">í•™ìŠµ ìƒíƒœ</label><div class="chip-multi" id="expr-filter-mastery"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="new">ìƒˆ í‘œí˜„</span><span class="chip" data-value="weak">ì·¨ì•½</span><span class="chip" data-value="wrong">ì˜¤ë‹µ</span><span class="chip" data-value="starred">â­ë¶ë§ˆí¬</span><span class="chip" data-value="leech">ğŸŒLeech</span></div></div><div class="form-group"><label class="form-label">ğŸ“š CEFR</label><div class="chip-multi chip-small" id="expr-filter-cefr"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="A2">A2</span><span class="chip" data-value="B1">B1</span><span class="chip" data-value="B2">B2</span><span class="chip" data-value="C1">C1</span><span class="chip" data-value="C2">C2</span></div></div><div class="form-group"><label class="form-label">ğŸ¯ ìš°ì„ ìˆœìœ„</label><div class="chip-multi chip-small" id="expr-filter-priority"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="P1">P1</span><span class="chip" data-value="P2">P2</span><span class="chip" data-value="P3">P3</span></div></div><div class="form-group"><label class="form-label">ğŸ‘” ê²©ì‹ë„</label><div class="chip-multi chip-small" id="expr-filter-formality"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="Formal">Formal</span><span class="chip" data-value="Neutral">Neutral</span><span class="chip" data-value="Informal">Informal</span></div></div><div class="form-group"><label class="form-label">â³ ì‹œëŒ€ì„±</label><div class="chip-multi chip-small" id="expr-filter-currency"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="Current">Current</span><span class="chip" data-value="Dated">Dated</span><span class="chip" data-value="Archaic">Archaic</span></div></div><div class="form-group"><label class="form-label">ğŸ“¡ ë§¤ì²´</label><div class="chip-multi chip-small" id="expr-filter-medium"><span class="chip checked" data-value="all">ì „ì²´</span><span class="chip" data-value="Both">Both</span><span class="chip" data-value="Written">Written</span><span class="chip" data-value="Spoken">Spoken</span></div></div><div class="form-group"><label class="form-label">ğŸ·ï¸ íƒœê·¸</label><div class="chip-multi chip-small" id="expr-filter-tag"><span class="chip checked" data-value="all">ì „ì²´</span></div></div><div style="margin-top:12px;display:flex;gap:8px"><button class="btn" style="flex:1;padding:8px;font-size:12px" onclick="resetFilters('expr')">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="flex:1;padding:8px;font-size:12px" onclick="saveFilters('expr')">ğŸ’¾ í•„í„° ì €ì¥</button></div></div>
</div>
<div class="card"><div class="card-title">ğŸ”€ ìˆœì„œ</div><div class="toggle-row"><span class="toggle-label">í•™ìŠµ ìˆœì„œ</span><select class="form-select" id="option-order" style="width:auto"><option value="fsrs">FSRS ìš°ì„ </option><option value="weak">ì·¨ì•½ ìš°ì„ </option><option value="random">ëœë¤</option></select></div></div>
</div>
<!-- í”Œë˜ì‹œì¹´ë“œ -->
<div id="page-flashcard" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="fc-progress"></div></div><div class="progress-text"><span><span id="fc-current">0</span> / <span id="fc-total">0</span></span><span id="fc-timer">0:00</span></div></div>
<div class="retry-banner hidden" id="fc-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">í‹€ë¦° ë‹¨ì–´ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="fc-retry-count">0</div></div>
<div class="swipe-indicator left" id="swipe-left">âŒ</div><div class="swipe-indicator right" id="swipe-right">âœ…</div>
<div class="flashcard-container" id="fc-container"><div class="flashcard" id="flashcard"><div class="flashcard-face flashcard-front"><div class="flashcard-tags" id="fc-tags"></div><div class="flashcard-word" id="fc-word">ë‹¨ì–´</div><div class="flashcard-hint">ğŸ‘† íƒ­: ë’¤ì§‘ê¸° / ë‹¤ì‹œ íƒ­: ì•ë©´</div></div><div class="flashcard-face flashcard-back"><div class="flashcard-back-inner" id="fc-back-inner"><div class="flashcard-meaning-ko" id="fc-meaning-ko"></div><div class="flashcard-meaning-en" id="fc-meaning-en"></div><div class="flashcard-example" id="fc-example"></div><div class="flashcard-collocation" id="fc-collocation"></div></div></div></div></div>
<div class="rating-section disabled" id="rating-section"><div class="rating-grid"><button class="rating-btn again" onclick="rateCard(0)" disabled>ğŸ˜« ëª¨ë¦„<span class="rating-interval">ë‹¤ì‹œ</span></button><button class="rating-btn hard" onclick="rateCard(1)" disabled>ğŸ˜• ì–´ë ¤ì›€<span class="rating-interval">1ì¼</span></button><button class="rating-btn good" onclick="rateCard(2)" disabled>ğŸ™‚ ë³´í†µ<span class="rating-interval">3ì¼</span></button><button class="rating-btn easy" onclick="rateCard(3)" disabled>ğŸ˜Š ì‰¬ì›€<span class="rating-interval">7ì¼+</span></button></div></div>
<div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn btn-secondary btn-sm" id="fc-production-btn" onclick="toggleFCProduction()" style="flex:1;font-size:12px">ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”</button><button class="btn btn-secondary btn-sm" id="fc-tag-btn" onclick="openFCTagMenu()" style="flex:1;font-size:12px">ğŸ·ï¸ íƒœê·¸</button></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary btn-sm" id="fc-prev-btn" onclick="prevCard()" style="flex:0 0 50px" title="ì´ì „ ì¹´ë“œ">â†</button><button class="btn btn-secondary btn-sm" onclick="speakWord()" style="flex:0 0 50px">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="fc-bookmark-btn" onclick="toggleFCBookmark()" style="flex:0 0 50px">â˜†</button><button class="btn btn-secondary btn-sm" onclick="openFCEdit()" style="flex:0 0 50px">âœï¸</button><button class="btn btn-secondary btn-sm" onclick="confirmEndFC()" style="flex:1">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- í€´ì¦ˆ -->
<div id="page-quiz" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="quiz-progress"></div></div><div class="progress-text"><span><span id="quiz-current">0</span> / <span id="quiz-total">0</span></span><span>âœ… <span id="quiz-correct">0</span> âŒ <span id="quiz-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="quiz-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="quiz-retry-count">0</div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center"><div class="flashcard-tags" id="quiz-tags" style="justify-content:center"></div><div class="flashcard-word" id="quiz-word" style="font-size:28px">ë‹¨ì–´</div><div id="quiz-sub" style="font-size:14px;color:var(--muted);text-align:center;margin-top:8px"></div><div id="quiz-example" class="hidden" style="background:rgba(99,102,241,.1);padding:12px;border-radius:10px;border-left:3px solid var(--primary);font-size:13px;margin-top:12px"></div></div>
<div id="quiz-rating-bar" class="hidden" style="margin-bottom:12px;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€</div><div class="rating-grid"><button class="rating-btn again" onclick="rateQuizItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="rateQuizItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="rateQuizItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="rateQuizItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<div class="quiz-options" id="quiz-options"></div>
<div class="quiz-action-bar"><button class="btn btn-secondary btn-sm" onclick="speakQuizWord()">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="quiz-bookmark-btn" onclick="toggleQuizBookmark()">â˜†</button><button class="btn btn-secondary btn-sm" id="quiz-production-btn" onclick="toggleQuizProduction()">ğŸ–Šï¸</button><button class="btn btn-secondary btn-sm" id="quiz-tag-btn" onclick="openQuizTagMenu()">ğŸ·ï¸</button><button class="btn btn-secondary btn-sm" onclick="openQuizEdit()">âœï¸</button></div>
<button class="btn btn-primary hidden" id="quiz-next-btn" onclick="nextQuiz()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndQuiz()">í€´ì¦ˆ ì¢…ë£Œ</button></div>
</div>
<!-- íƒ€ì´í•‘ -->
<div id="page-typing" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="typing-progress"></div></div><div class="progress-text"><span><span id="typing-current">0</span> / <span id="typing-total">0</span></span><span>âœ… <span id="typing-correct">0</span> âŒ <span id="typing-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="typing-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="typing-retry-count">0</div></div>
<div class="card" style="min-height:180px"><div style="text-align:center"><div style="font-size:14px;color:var(--muted);margin-bottom:8px" id="typing-pos"></div><div style="font-size:28px;font-weight:700;margin-bottom:8px" id="typing-meaning">ëœ»</div><div style="font-size:14px;color:var(--muted)" id="typing-en"></div></div><div id="typing-example" class="hidden" style="background:rgba(99,102,241,.1);padding:12px;border-radius:10px;border-left:3px solid var(--primary);font-size:13px;margin-top:12px"></div></div>
<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-secondary btn-sm" id="typing-bookmark-btn" onclick="toggleTypingBookmark()" style="flex:1">â˜†</button><button class="btn btn-secondary btn-sm" onclick="openTypingEdit()" style="flex:1">âœï¸</button></div>
<div class="card"><input type="text" class="form-input" id="typing-input" placeholder="ì˜ì–´ ë‹¨ì–´ ì…ë ¥..." autocomplete="off" autocapitalize="off"><div class="typing-answer hidden" id="typing-answer"></div></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="showTypingHint()" id="typing-hint-btn">ğŸ’¡ íŒíŠ¸</button><button class="btn btn-primary" onclick="checkTyping()" id="typing-submit-btn">í™•ì¸</button></div>
<button class="btn btn-primary hidden" id="typing-next-btn" onclick="nextTyping()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndTyping()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- ë¦¬ìŠ¤ë‹ í€´ì¦ˆ -->
<div id="page-listening" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="listening-progress"></div></div><div class="progress-text"><span><span id="listening-current">0</span> / <span id="listening-total">0</span></span><span>âœ… <span id="listening-correct">0</span> âŒ <span id="listening-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="listening-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="listening-retry-count">0</div></div>
<div class="card" style="min-height:180px;display:flex;flex-direction:column;justify-content:center;align-items:center">
<div style="font-size:64px;margin-bottom:16px">ğŸ§</div>
<div id="listening-word" class="hidden" style="font-size:32px;font-weight:700;color:var(--primary);margin-bottom:8px"></div>
<button class="btn btn-primary" onclick="playCurrentListening()" id="listening-play-btn" style="padding:16px 32px;font-size:18px">ğŸ”Š ë“£ê¸°</button>
<div style="font-size:12px;color:var(--muted);margin-top:8px">ë‹¨ì–´ë¥¼ ë“£ê³  ëœ»ì„ ì„ íƒí•˜ì„¸ìš”</div>
</div>
<div id="listening-rating-bar" class="hidden" style="margin:12px 0;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€</div><div class="rating-grid"><button class="rating-btn again" onclick="rateListeningItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="rateListeningItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="rateListeningItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="rateListeningItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<div class="quiz-options" id="listening-options"></div>
<div class="quiz-action-bar" id="listening-action-bar"><button class="btn btn-secondary btn-sm" onclick="playCurrentListening()">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="listening-bookmark-btn" onclick="toggleListeningBookmark()">â˜†</button><button class="btn btn-secondary btn-sm" id="listening-production-btn" onclick="toggleListeningProduction()">ğŸ–Šï¸</button><button class="btn btn-secondary btn-sm" id="listening-tag-btn" onclick="openListeningTagMenu()">ğŸ·ï¸</button><button class="btn btn-secondary btn-sm" onclick="openListeningEdit()">âœï¸</button></div>
<button class="btn btn-primary hidden" id="listening-next-btn" onclick="nextListeningQ()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndCurrentListening()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- ë°›ì•„ì“°ê¸° (Dictation) -->
<div id="page-dictation" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="dictation-progress"></div></div><div class="progress-text"><span><span id="dictation-current">0</span> / <span id="dictation-total">0</span></span><span>âœ… <span id="dictation-correct">0</span> âŒ <span id="dictation-wrong">0</span></span></div></div>
<div class="card" style="min-height:180px;display:flex;flex-direction:column;justify-content:center;align-items:center">
<div style="font-size:64px;margin-bottom:16px">âœï¸</div>
<button class="btn btn-primary" onclick="playCurrentDictation()" id="dictation-play-btn" style="padding:16px 32px;font-size:18px">ğŸ”Š ë“£ê¸°</button>
<div style="font-size:12px;color:var(--muted);margin-top:8px">ë‹¨ì–´ë¥¼ ë“£ê³  ìŠ¤í ë§ì„ ì…ë ¥í•˜ì„¸ìš”</div>
<div id="dictation-hint" class="hidden" style="font-size:14px;color:var(--warning);margin-top:8px"></div>
</div>
<div class="card"><input type="text" class="form-input" id="dictation-input" placeholder="ë“¤ì€ ë‹¨ì–´ ì…ë ¥..." autocomplete="off" autocapitalize="off"><div class="typing-answer hidden" id="dictation-answer"></div></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="showCurrentDictationHint()">ğŸ’¡ íŒíŠ¸</button><button class="btn btn-primary" onclick="checkCurrentDictation()" id="dictation-submit-btn">í™•ì¸</button></div>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndCurrentDictation()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<div id="page-cloze" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="cloze-progress"></div></div><div class="progress-text"><span><span id="cloze-current">0</span> / <span id="cloze-total">0</span></span><span>âœ… <span id="cloze-correct">0</span> âŒ <span id="cloze-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="cloze-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="cloze-retry-count">0</div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center">
<div style="font-size:14px;color:var(--muted);text-align:center;margin-bottom:8px"><span id="cloze-hint"></span></div>
<div id="cloze-sentence" style="font-size:18px;line-height:1.8;text-align:center;padding:16px"></div>
</div>
<div id="cloze-rating-bar" class="hidden" style="margin:12px 0;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€</div><div class="rating-grid"><button class="rating-btn again" onclick="rateClozeItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="rateClozeItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="rateClozeItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="rateClozeItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<div class="quiz-options" id="cloze-options"></div>
<button class="btn btn-primary hidden" id="cloze-next-btn" onclick="nextCloze()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndCloze()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Collocation -->
<div id="page-collocation" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="colloc-progress"></div></div><div class="progress-text"><span><span id="colloc-current">0</span> / <span id="colloc-total">0</span></span><span>âœ… <span id="colloc-correct">0</span> âŒ <span id="colloc-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="colloc-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="colloc-retry-count">0</div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center">
<div style="font-size:14px;color:var(--muted);text-align:center;margin-bottom:8px">ì–´ë–¤ ë‹¨ì–´ì™€ í•¨ê»˜ ì“°ì¼ê¹Œìš”?</div>
<div id="colloc-question" style="font-size:28px;font-weight:700;text-align:center;padding:16px">_____ + decision</div>
<div style="font-size:14px;color:var(--muted);text-align:center" id="colloc-meaning"></div>
</div>
<div id="colloc-rating-bar" class="hidden" style="margin:12px 0;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€</div><div class="rating-grid"><button class="rating-btn again" onclick="rateCollocItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="rateCollocItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="rateCollocItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="rateCollocItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<div class="quiz-options" id="colloc-options"></div>
<button class="btn btn-primary hidden" id="colloc-next-btn" onclick="nextColloc()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndColloc()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Expression Flashcard -->
<div id="page-expr-fc" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="expr-fc-progress" style="background:linear-gradient(90deg,var(--expr),#5eead4)"></div></div><div class="progress-text"><span><span id="expr-fc-current">0</span> / <span id="expr-fc-total">0</span></span><span id="expr-fc-timer">0:00</span></div></div>
<div class="retry-banner hidden" id="expr-retry-banner" style="border-color:var(--expr)"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">í‹€ë¦° í‘œí˜„ ì¬í•™ìŠµ ì¤‘</div><div class="retry-banner-count" id="expr-retry-count">0</div></div>
<div class="flashcard-container" id="expr-fc-container"><div class="flashcard" id="expr-fc-card">
<div class="flashcard-face flashcard-front">
<div class="flashcard-tags"><span class="tag" id="expr-fc-formality" style="background:rgba(249,115,22,.2);color:var(--expr)">Neutral</span></div>
<div class="flashcard-word" id="expr-fc-word">Expression</div>
<div class="flashcard-hint">ğŸ‘† íƒ­: ë’¤ì§‘ê¸° / ë‹¤ì‹œ íƒ­: ì•ë©´</div>
</div>
<div class="flashcard-face flashcard-back">
<div class="flashcard-back-inner" id="expr-fc-back-inner">
<div id="expr-fc-func" style="font-size:12px;color:var(--expr);text-align:center;margin-bottom:8px"></div>
<div class="flashcard-meaning-ko" id="expr-fc-meaning">ëœ»</div>
<div id="expr-fc-similar" class="similar-expr-box" style="display:none"></div>
<div id="expr-fc-example" class="flashcard-example" style="background:rgba(249,115,22,.1);border-left:3px solid var(--expr)"></div>
</div>
</div>
</div></div>
<div class="rating-section" id="expr-rating-section">
<div class="rating-grid" id="expr-rating-grid">
<button class="rating-btn again" onclick="rateExprCard(0)">ğŸ˜« ëª¨ë¦„<span class="rating-interval">ë‹¤ì‹œ</span></button>
<button class="rating-btn hard" onclick="rateExprCard(1)">ğŸ˜• ì–´ë ¤ì›€<span class="rating-interval">1ì¼</span></button>
<button class="rating-btn good" onclick="rateExprCard(2)">ğŸ™‚ ë³´í†µ<span class="rating-interval">3ì¼</span></button>
<button class="rating-btn easy" onclick="rateExprCard(3)">ğŸ˜Š ì‰¬ì›€<span class="rating-interval">7ì¼+</span></button>
</div>
</div>
<div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn btn-secondary btn-sm" id="expr-fc-production-btn" onclick="toggleExprFCProduction()" style="flex:1;font-size:12px">ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”</button><button class="btn btn-secondary btn-sm" id="expr-fc-tag-btn" onclick="openExprFCTagMenu()" style="flex:1;font-size:12px">ğŸ·ï¸ íƒœê·¸</button></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary btn-sm" id="expr-fc-prev-btn" onclick="prevExprCard()" style="flex:0 0 50px" title="ì´ì „ ì¹´ë“œ">â†</button><button class="btn btn-secondary btn-sm" onclick="speakExpr()" style="flex:0 0 50px">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="expr-fc-bookmark-btn" onclick="toggleExprFCBookmark()" style="flex:0 0 50px">â˜†</button><button class="btn btn-secondary btn-sm" onclick="openExprFCEdit()" style="flex:0 0 50px">âœï¸</button><button class="btn btn-secondary btn-sm" onclick="confirmEndExprFC()" style="flex:1">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Expression Cloze -->
<div id="page-expr-cloze" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="expr-cloze-progress" style="background:linear-gradient(90deg,var(--expr),#5eead4)"></div></div><div class="progress-text"><span><span id="expr-cloze-current">0</span> / <span id="expr-cloze-total">0</span></span><span>âœ… <span id="expr-cloze-correct">0</span> âŒ <span id="expr-cloze-wrong">0</span></span></div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center">
<div style="font-size:14px;color:var(--muted);text-align:center;margin-bottom:8px">ë¹ˆì¹¸ì— ë“¤ì–´ê°ˆ í‘œí˜„ì€?</div>
<div id="expr-cloze-sentence" style="font-size:18px;text-align:center;padding:16px;line-height:1.6"></div>
<div style="font-size:14px;color:var(--expr);text-align:center" id="expr-cloze-hint"></div>
</div>
<div id="expr-cloze-rating-bar" class="hidden" style="margin:12px 0;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€</div><div class="rating-grid"><button class="rating-btn again" onclick="rateExprClozeItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="rateExprClozeItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="rateExprClozeItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="rateExprClozeItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<div class="quiz-options" id="expr-cloze-options"></div>
<div class="quiz-action-bar"><button class="btn btn-secondary btn-sm" onclick="speakExprCloze()">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="expr-cloze-bookmark-btn" onclick="toggleExprClozeBookmark()">â˜†</button><button class="btn btn-secondary btn-sm" id="expr-cloze-production-btn" onclick="toggleExprClozeProduction()">ğŸ–Šï¸</button><button class="btn btn-secondary btn-sm" onclick="openExprClozeEdit()">âœï¸</button></div>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndExprCloze()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Expression Typing -->
<div id="page-expr-typing" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="expr-typing-progress" style="background:linear-gradient(90deg,var(--expr),#5eead4)"></div></div><div class="progress-text"><span><span id="expr-typing-current">0</span> / <span id="expr-typing-total">0</span></span><span>âœ… <span id="expr-typing-correct">0</span> âŒ <span id="expr-typing-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="expr-typing-retry-banner" style="border-color:var(--expr)"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="expr-typing-retry-count">0</div></div>
<div class="card" style="min-height:180px"><div style="text-align:center"><div style="font-size:14px;color:var(--expr);margin-bottom:8px" id="expr-typing-func"></div><div style="font-size:24px;font-weight:700;margin-bottom:8px" id="expr-typing-meaning">ëœ»</div><div style="font-size:13px;color:var(--muted)" id="expr-typing-formality"></div></div><div id="expr-typing-example" class="hidden" style="background:rgba(249,115,22,.1);padding:12px;border-radius:10px;border-left:3px solid var(--expr);font-size:13px;margin-top:12px"></div></div>
<div style="margin:16px 0"><input type="text" id="expr-typing-input" placeholder="í‘œí˜„ì„ ì˜ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”..." style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px;font-size:16px;color:var(--text)" autocomplete="off" autocapitalize="off"><div id="expr-typing-answer" class="hidden" style="text-align:center;font-size:18px;font-weight:600;margin-top:10px;padding:8px;border-radius:8px"></div></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="showExprTypingHint()" id="expr-typing-hint-btn">ğŸ’¡ íŒíŠ¸</button><button class="btn btn-primary" onclick="checkExprTyping()" id="expr-typing-submit-btn" style="background:var(--expr)">í™•ì¸</button></div>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndExprTyping()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Expression Quiz -->
<div id="page-expr-quiz" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="expr-quiz-progress" style="background:linear-gradient(90deg,var(--expr),#5eead4)"></div></div><div class="progress-text"><span><span id="expr-quiz-current">0</span> / <span id="expr-quiz-total">0</span></span><span>âœ… <span id="expr-quiz-correct">0</span> âŒ <span id="expr-quiz-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="expr-quiz-retry-banner" style="border-color:var(--expr)"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="expr-quiz-retry-count">0</div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center">
<div class="flashcard-tags" id="expr-quiz-tags" style="justify-content:center"></div>
<div class="flashcard-word" id="expr-quiz-word" style="font-size:24px">Expression</div>
<div id="expr-quiz-func" style="font-size:13px;color:var(--expr);text-align:center;margin-top:8px;display:none"></div>
</div>
<div id="expr-quiz-rating-bar" class="hidden" style="margin:12px 0;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€</div><div class="rating-grid"><button class="rating-btn again" onclick="rateExprQuizItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="rateExprQuizItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="rateExprQuizItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="rateExprQuizItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<div class="quiz-options" id="expr-quiz-options"></div>
<div class="quiz-action-bar"><button class="btn btn-secondary btn-sm" onclick="speakExprQuiz()">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="expr-quiz-bookmark-btn" onclick="toggleExprQuizBookmark()">â˜†</button><button class="btn btn-secondary btn-sm" id="expr-quiz-production-btn" onclick="toggleExprQuizProduction()">ğŸ–Šï¸</button><button class="btn btn-secondary btn-sm" id="expr-quiz-tag-btn" onclick="openExprQuizTagMenu()">ğŸ·ï¸</button><button class="btn btn-secondary btn-sm" onclick="openExprQuizEdit()">âœï¸</button></div>
<button class="btn btn-primary hidden" id="expr-quiz-next-btn" onclick="nextExprQuiz()" style="margin-top:16px;background:var(--expr)">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndExprQuiz()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- PV Particle -->
<div id="page-pv-particle" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill phrasal" id="pvp-progress"></div></div><div class="progress-text"><span><span id="pvp-current">0</span> / <span id="pvp-total">0</span></span><span>âœ… <span id="pvp-correct">0</span> âŒ <span id="pvp-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="pvp-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="pvp-retry-count">0</div></div>
<div class="card" style="min-height:180px;display:flex;flex-direction:column;justify-content:center"><div style="font-size:14px;color:var(--muted);text-align:center;margin-bottom:8px" id="pvp-meaning"></div><div style="font-size:40px;font-weight:700;color:var(--phrasal);text-align:center;padding:16px" id="pvp-question">verb + <span class="blank-word">?</span></div><div id="pvp-example" class="hidden" style="background:rgba(236,72,153,.1);padding:12px;border-radius:10px;border-left:3px solid var(--phrasal);font-size:13px;margin-top:12px"></div></div>
<div id="pvp-rating-bar" class="hidden" style="margin:12px 0;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€</div><div class="rating-grid"><button class="rating-btn again" onclick="ratePVPItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="ratePVPItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="ratePVPItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="ratePVPItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<div class="quiz-options" id="pvp-options"></div>
<div class="quiz-action-bar"><button class="btn btn-secondary btn-sm" onclick="speakPVP()">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="pvp-bookmark-btn" onclick="togglePVPBookmark()">â˜†</button><button class="btn btn-secondary btn-sm" id="pvp-production-btn" onclick="togglePVPProduction()">ğŸ–Šï¸</button><button class="btn btn-secondary btn-sm" id="pvp-tag-btn" onclick="openPVPTagMenu()">ğŸ·ï¸</button><button class="btn btn-secondary btn-sm" onclick="openPVPEdit()">âœï¸</button></div>
<button class="btn btn-phrasal hidden" id="pvp-next-btn" onclick="nextPVP()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndPVQuiz()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- PV Quiz -->
<div id="page-pv-quiz" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill phrasal" id="pvq-progress"></div></div><div class="progress-text"><span><span id="pvq-current">0</span> / <span id="pvq-total">0</span></span><span>âœ… <span id="pvq-correct">0</span> âŒ <span id="pvq-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="pvq-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="pvq-retry-count">0</div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center"><div class="flashcard-tags" id="pvq-tags" style="justify-content:center"></div><div class="flashcard-word" id="pvq-word" style="font-size:28px">êµ¬ë™ì‚¬</div><div id="pvq-sub" style="font-size:14px;color:var(--muted);text-align:center;margin-top:8px"></div><div id="pvq-example" class="hidden" style="background:rgba(249,115,22,.1);padding:12px;border-radius:10px;border-left:3px solid var(--phrasal);font-size:13px;margin-top:12px"></div></div>
<div id="pvq-rating-bar" class="hidden" style="margin:12px 0;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€</div><div class="rating-grid"><button class="rating-btn again" onclick="ratePVQItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="ratePVQItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="ratePVQItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="ratePVQItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<div class="quiz-options" id="pvq-options"></div>
<div class="quiz-action-bar"><button class="btn btn-secondary btn-sm" onclick="speakPVQ()">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="pvq-bookmark-btn" onclick="togglePVQBookmark()">â˜†</button><button class="btn btn-secondary btn-sm" id="pvq-production-btn" onclick="togglePVQProduction()">ğŸ–Šï¸</button><button class="btn btn-secondary btn-sm" id="pvq-tag-btn" onclick="openPVQTagMenu()">ğŸ·ï¸</button><button class="btn btn-secondary btn-sm" onclick="openPVQEdit()">âœï¸</button></div>
<button class="btn btn-phrasal hidden" id="pvq-next-btn" onclick="nextPVQ()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndPVQuiz()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- ì·¨ì•½ ë‹¨ì–´ -->
<div id="page-weak" class="page">
<div class="page-header" style="margin-bottom:12px"><h1 style="font-size:20px">ğŸ“ <span id="weak-title">ì·¨ì•½ ë‹¨ì–´</span></h1></div>
<div class="card"><div id="weak-list"></div><div class="empty-state hidden" id="weak-empty"><div class="empty-state-icon">âœ…</div><h3>ì·¨ì•½ ë‹¨ì–´ ì—†ìŒ</h3><p>ëª¨ë“  ë‹¨ì–´ë¥¼ ì˜ ì•Œê³  ìˆì–´ìš”!</p></div></div>
<button class="btn btn-primary hidden" id="weak-study-btn" onclick="safeStart(startWeakStudy)" style="margin-bottom:16px">ğŸ¯ ì·¨ì•½ ë‹¨ì–´ í•™ìŠµ</button>
<button class="btn btn-secondary" onclick="showPage('home')">â† ëŒì•„ê°€ê¸°</button>
</div>
<!-- ë¶„ì„ -->
<div id="page-stats" class="page">
<div class="type-tabs"><div class="type-tab active" data-type="vocab" onclick="switchGlobalType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" data-type="phrasal" onclick="switchGlobalType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" data-type="expr" onclick="switchGlobalType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div id="stats-vocab">
<div class="card"><div class="card-title">ğŸ“Š í•™ìŠµ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="stats-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="stats-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item"><div class="stat-value warning" id="stats-learning">0</div><div class="stat-label">í•™ìŠµì¤‘</div></div><div class="stat-item"><div class="stat-value" id="stats-new">0</div><div class="stat-label">ë¯¸í•™ìŠµ</div></div></div></div>
<div class="card"><div class="card-title">ğŸ¯ ì¸í’‹/ì•„ì›ƒí’‹ í•™ìŠµ</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div style="background:rgba(99,102,241,0.1);border-radius:12px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:4px">ğŸ‘ï¸ ì¸í’‹ (ì¸ì§€)</div><div style="font-size:24px;font-weight:700;color:var(--primary)" id="stats-input-count">0</div><div style="font-size:11px;color:var(--muted)">ì½ê¸°/ë“£ê¸°/ì„ íƒ</div><div style="font-size:12px;margin-top:4px"><span id="stats-input-acc" style="color:var(--success)">-</span> ì •ë‹µë¥ </div><div style="font-size:11px;margin-top:2px;color:var(--muted)">ì²«ì‹œë„ <span id="stats-input-first" style="color:var(--primary)">-</span></div></div><div style="background:rgba(34,197,94,0.1);border-radius:12px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:4px">ğŸ–Šï¸ ì•„ì›ƒí’‹ (ì‚°ì¶œ)</div><div style="font-size:24px;font-weight:700;color:var(--success)" id="stats-output-count">0</div><div style="font-size:11px;color:var(--muted)">ì“°ê¸°/ë°›ì•„ì“°ê¸°</div><div style="font-size:12px;margin-top:4px"><span id="stats-output-acc" style="color:var(--success)">-</span> ì •ë‹µë¥ </div><div style="font-size:11px;margin-top:2px;color:var(--muted)">ì²«ì‹œë„ <span id="stats-output-first" style="color:var(--success)">-</span></div></div></div><div style="margin-top:12px;font-size:11px;color:var(--muted);text-align:center">ğŸ’¡ ì¸í’‹: í”Œë˜ì‹œì¹´ë“œ, í€´ì¦ˆ, ë¹ˆì¹¸, ë¦¬ìŠ¤ë‹ | ì•„ì›ƒí’‹: íƒ€ì´í•‘, ë°›ì•„ì“°ê¸°</div></div>
<div class="card"><div class="card-title">â±ï¸ í•™ìŠµ ë¶„ì„</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="stats-time" style="font-size:18px">0ë¶„</div><div class="stat-label">ì´ í•™ìŠµì‹œê°„</div></div><div class="stat-item"><div class="stat-value" id="stats-sessions">0</div><div class="stat-label">í•™ìŠµ íšŸìˆ˜</div></div><div class="stat-item"><div class="stat-value" id="stats-avg-acc">0%</div><div class="stat-label">í‰ê·  ì •ë‹µë¥ </div></div><div class="stat-item"><div class="stat-value warning" id="stats-forget">0</div><div class="stat-label">ì˜ˆìƒ ë§ê°</div></div></div></div>
<div class="card"><div class="card-title">ğŸ” ì·¨ì•½ ë¶„ì„</div><div id="weak-analysis" style="font-size:13px;color:var(--muted)">ë¶„ì„ ì¤‘...</div></div>
<div class="card"><div class="card-title">ğŸ“¦ ì¹´ë“œ ìƒíƒœ (Anki ìŠ¤íƒ€ì¼)</div><div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;text-align:center"><div style="background:rgba(99,102,241,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--primary)" id="state-new">0</div><div style="font-size:9px;color:var(--muted)">New</div></div><div style="background:rgba(245,158,11,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--warning)" id="state-learning">0</div><div style="font-size:9px;color:var(--muted)">Learning</div></div><div style="background:rgba(239,68,68,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--danger)" id="state-relearning">0</div><div style="font-size:9px;color:var(--muted)">Relearning</div></div><div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--success)" id="state-young">0</div><div style="font-size:9px;color:var(--muted)">Young</div></div><div style="background:rgba(16,185,129,0.15);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:#10b981" id="state-mature">0</div><div style="font-size:9px;color:var(--muted)">Mature</div></div></div><div style="font-size:10px;color:var(--muted);margin-top:6px;text-align:center">Young: &lt;21ì¼ | Mature: â‰¥21ì¼</div></div>
<div class="card"><div class="card-title">ğŸŒ Leech ì¹´ë“œ <span id="leech-count" style="font-size:12px;color:var(--danger);margin-left:4px"></span></div><div id="leech-list" style="font-size:13px;max-height:120px;overflow-y:auto"></div><div style="font-size:10px;color:var(--muted);margin-top:6px;text-align:center">8íšŒ ì´ìƒ ì‹¤íŒ¨í•œ ì–´ë ¤ìš´ ì¹´ë“œ</div></div>
<div class="card"><div class="card-title">ğŸ“¦ Leitner Box</div><div class="leitner-container" id="leitner-stats"></div></div>
<div class="card"><div class="card-title">ğŸ¯ ì •ë‹µë¥  ë¶„í¬</div><div class="stat-grid stat-grid-3"><div class="stat-item"><div class="stat-value success" id="stats-high">0</div><div class="stat-label">80%+</div></div><div class="stat-item"><div class="stat-value warning" id="stats-mid">0</div><div class="stat-label">50-79%</div></div><div class="stat-item"><div class="stat-value danger" id="stats-low">0</div><div class="stat-label">&lt;50%</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“Š FSRS ì•ˆì •ë„ ë¶„í¬</div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center"><div style="background:rgba(239,68,68,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(0,3,'vocab'))"><div style="font-size:18px;font-weight:700;color:var(--danger)" id="stability-0-3">0</div><div style="font-size:10px;color:var(--muted)">0-3ì¼</div></div><div style="background:rgba(245,158,11,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(3,7,'vocab'))"><div style="font-size:18px;font-weight:700;color:var(--warning)" id="stability-3-7">0</div><div style="font-size:10px;color:var(--muted)">3-7ì¼</div></div><div style="background:rgba(99,102,241,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(7,30,'vocab'))"><div style="font-size:18px;font-weight:700;color:var(--primary)" id="stability-7-30">0</div><div style="font-size:10px;color:var(--muted)">7-30ì¼</div></div><div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(30,999,'vocab'))"><div style="font-size:18px;font-weight:700;color:var(--success)" id="stability-30-plus">0</div><div style="font-size:10px;color:var(--muted)">30ì¼+</div></div></div><div style="font-size:11px;color:var(--muted);margin-top:8px;text-align:center">ğŸ’¡ í´ë¦­í•˜ë©´ í•´ë‹¹ êµ¬ê°„ ì¹´ë“œ í•™ìŠµ</div></div>
<div class="card"><div class="card-title">ğŸ“ˆ 7ì¼ ë¦¬ë·° ì˜ˆì¸¡</div><div class="chart-container" id="forecast-chart" style="height:80px"></div><div style="font-size:11px;color:var(--muted);margin-top:4px;text-align:center">í–¥í›„ 7ì¼ê°„ ì˜ˆìƒ ë³µìŠµ ì¹´ë“œ ìˆ˜</div></div>
<div class="card"><div class="card-title">ğŸ“‰ 30ì¼ ì²«ì‹œë„ ì •ë‹µë¥  ì¶”ì´</div><div class="chart-container" id="first-try-chart" style="height:80px"></div><div style="font-size:11px;color:var(--muted);margin-top:4px;text-align:center">FSRS í’ˆì§ˆ ì§€í‘œ - ë†’ì„ìˆ˜ë¡ ìŠ¤ì¼€ì¤„ë§ì´ íš¨ê³¼ì </div></div>
<div class="card"><div class="card-title">âš ï¸ FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ <span id="fsrs-fail-count" style="font-size:12px;color:var(--danger);margin-left:4px"></span></div><div id="fsrs-fail-list" style="font-size:13px;max-height:150px;overflow-y:auto"></div><div style="margin-top:8px;text-align:center"><button class="btn btn-sm" style="background:var(--danger);color:white" onclick="safeStart(()=>startFSRSFailStudy('vocab'))" id="fsrs-fail-study-btn">ğŸ¯ ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ ì§‘ì¤‘ í•™ìŠµ</button></div></div>
<div class="card"><div class="card-title">ğŸ”„ ì¸ì§€â†”ìƒì‚° ê°­ ë¶„ì„ <span id="gap-count" style="font-size:12px;color:var(--warning);margin-left:4px"></span></div><div id="gap-analysis" style="font-size:13px"></div><div style="margin-top:8px;text-align:center"><button class="btn btn-sm" style="background:var(--warning);color:white" onclick="safeStart(()=>startGapStudy('vocab'))" id="gap-study-btn">ğŸ–Šï¸ ìƒì‚° ì—°ìŠµ í•„ìš” ì¹´ë“œ í•™ìŠµ</button></div></div>
<div class="card"><div class="card-title">ğŸ”¥ Hard Cards Top 10 <button class="btn btn-sm" style="background:var(--danger);color:white;margin-left:auto;font-size:11px" onclick="safeStart(()=>startHardCardsStudy('vocab'))">ì§‘ì¤‘ í•™ìŠµ</button></div><div id="hard-cards-list" style="font-size:13px;max-height:200px;overflow-y:auto"></div></div>
<div class="card"><div class="card-title">ğŸ“… ì£¼ê°„ í•™ìŠµ</div><div class="chart-container" id="weekly-chart"></div></div>
<div class="card"><div class="card-title">ğŸ“† ì›”ê°„ ì¶”ì´</div><div class="chart-container" id="monthly-chart" style="height:100px"></div></div>
</div>
<div id="stats-phrasal" class="hidden">
<div class="card"><div class="card-title">ğŸ”— í•™ìŠµ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="pv-stats-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="pv-stats-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item"><div class="stat-value warning" id="pv-stats-learning">0</div><div class="stat-label">í•™ìŠµì¤‘</div></div><div class="stat-item"><div class="stat-value" id="pv-stats-new">0</div><div class="stat-label">ë¯¸í•™ìŠµ</div></div></div></div>
<div class="card"><div class="card-title">ğŸ¯ ì¸í’‹/ì•„ì›ƒí’‹ í•™ìŠµ</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div style="background:rgba(168,85,247,0.1);border-radius:12px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:4px">ğŸ‘ï¸ ì¸í’‹ (ì¸ì§€)</div><div style="font-size:24px;font-weight:700;color:var(--phrasal)" id="pv-stats-input-count">0</div><div style="font-size:11px;color:var(--muted)">í”Œë˜ì‹œì¹´ë“œ/í€´ì¦ˆ/ë¦¬ìŠ¤ë‹</div><div style="font-size:12px;margin-top:4px"><span id="pv-stats-input-acc" style="color:var(--success)">-</span> ì •ë‹µë¥ </div><div style="font-size:11px;margin-top:2px;color:var(--muted)">ì²«ì‹œë„ <span id="pv-stats-input-first" style="color:var(--phrasal)">-</span></div></div><div style="background:rgba(34,197,94,0.1);border-radius:12px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:4px">ğŸ–Šï¸ ì•„ì›ƒí’‹ (ì‚°ì¶œ)</div><div style="font-size:24px;font-weight:700;color:var(--success)" id="pv-stats-output-count">0</div><div style="font-size:11px;color:var(--muted)">ë°›ì•„ì“°ê¸°</div><div style="font-size:12px;margin-top:4px"><span id="pv-stats-output-acc" style="color:var(--success)">-</span> ì •ë‹µë¥ </div><div style="font-size:11px;margin-top:2px;color:var(--muted)">ì²«ì‹œë„ <span id="pv-stats-output-first" style="color:var(--success)">-</span></div></div></div></div>
<div class="card"><div class="card-title">â±ï¸ í•™ìŠµ ë¶„ì„</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="pv-stats-time" style="font-size:18px">0ë¶„</div><div class="stat-label">ì´ í•™ìŠµì‹œê°„</div></div><div class="stat-item"><div class="stat-value" id="pv-stats-sessions">0</div><div class="stat-label">í•™ìŠµ íšŸìˆ˜</div></div><div class="stat-item"><div class="stat-value" id="pv-stats-avg-acc">0%</div><div class="stat-label">í‰ê·  ì •ë‹µë¥ </div></div><div class="stat-item"><div class="stat-value warning" id="pv-stats-forget">0</div><div class="stat-label">ì˜ˆìƒ ë§ê°</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“¦ ì¹´ë“œ ìƒíƒœ</div><div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;text-align:center"><div style="background:rgba(168,85,247,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--phrasal)" id="pv-state-new">0</div><div style="font-size:9px;color:var(--muted)">New</div></div><div style="background:rgba(245,158,11,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--warning)" id="pv-state-learning">0</div><div style="font-size:9px;color:var(--muted)">Learning</div></div><div style="background:rgba(239,68,68,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--danger)" id="pv-state-relearning">0</div><div style="font-size:9px;color:var(--muted)">Relearning</div></div><div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--success)" id="pv-state-young">0</div><div style="font-size:9px;color:var(--muted)">Young</div></div><div style="background:rgba(16,185,129,0.15);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:#10b981" id="pv-state-mature">0</div><div style="font-size:9px;color:var(--muted)">Mature</div></div></div></div>
<div class="card"><div class="card-title">ğŸŒ Leech ì¹´ë“œ <span id="pv-leech-count" style="font-size:12px;color:var(--danger);margin-left:4px"></span></div><div id="pv-leech-list" style="font-size:13px;max-height:100px;overflow-y:auto"></div></div>
<div class="card"><div class="card-title">ğŸ“¦ Leitner Box</div><div class="leitner-container" id="pv-leitner-stats"></div></div>
<div class="card"><div class="card-title">ğŸ¯ ì •ë‹µë¥  ë¶„í¬</div><div class="stat-grid stat-grid-3"><div class="stat-item"><div class="stat-value success" id="pv-stats-high">0</div><div class="stat-label">80%+</div></div><div class="stat-item"><div class="stat-value warning" id="pv-stats-mid">0</div><div class="stat-label">50-79%</div></div><div class="stat-item"><div class="stat-value danger" id="pv-stats-low">0</div><div class="stat-label">&lt;50%</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“Š FSRS ì•ˆì •ë„ ë¶„í¬</div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center"><div style="background:rgba(239,68,68,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(0,3,'phrasal'))"><div style="font-size:18px;font-weight:700;color:var(--danger)" id="pv-stability-0-3">0</div><div style="font-size:10px;color:var(--muted)">0-3ì¼</div></div><div style="background:rgba(245,158,11,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(3,7,'phrasal'))"><div style="font-size:18px;font-weight:700;color:var(--warning)" id="pv-stability-3-7">0</div><div style="font-size:10px;color:var(--muted)">3-7ì¼</div></div><div style="background:rgba(168,85,247,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(7,30,'phrasal'))"><div style="font-size:18px;font-weight:700;color:var(--phrasal)" id="pv-stability-7-30">0</div><div style="font-size:10px;color:var(--muted)">7-30ì¼</div></div><div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(30,999,'phrasal'))"><div style="font-size:18px;font-weight:700;color:var(--success)" id="pv-stability-30-plus">0</div><div style="font-size:10px;color:var(--muted)">30ì¼+</div></div></div><div style="font-size:11px;color:var(--muted);margin-top:8px;text-align:center">ğŸ’¡ í´ë¦­í•˜ë©´ í•´ë‹¹ êµ¬ê°„ ì¹´ë“œ í•™ìŠµ</div></div>
<div class="card"><div class="card-title">ğŸ“ˆ 7ì¼ ë¦¬ë·° ì˜ˆì¸¡</div><div class="chart-container" id="pv-forecast-chart" style="height:80px"></div></div>
<div class="card"><div class="card-title">ğŸ“‰ 30ì¼ ì²«ì‹œë„ ì •ë‹µë¥  ì¶”ì´</div><div class="chart-container" id="pv-first-try-chart" style="height:80px"></div></div>
<div class="card"><div class="card-title">âš ï¸ FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ <span id="pv-fsrs-fail-count" style="font-size:12px;color:var(--danger);margin-left:4px"></span></div><div id="pv-fsrs-fail-list" style="font-size:13px;max-height:150px;overflow-y:auto"></div><div style="margin-top:8px;text-align:center"><button class="btn btn-sm" style="background:var(--danger);color:white" onclick="safeStart(()=>startFSRSFailStudy('phrasal'))" id="pv-fsrs-fail-study-btn">ğŸ¯ ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ ì§‘ì¤‘ í•™ìŠµ</button></div></div>
<div class="card"><div class="card-title">ğŸ”„ ì¸ì§€â†”ìƒì‚° ê°­ ë¶„ì„ <span id="pv-gap-count" style="font-size:12px;color:var(--warning);margin-left:4px"></span></div><div id="pv-gap-analysis" style="font-size:13px"></div><div style="margin-top:8px;text-align:center"><button class="btn btn-sm" style="background:var(--warning);color:white" onclick="safeStart(()=>startGapStudy('phrasal'))" id="pv-gap-study-btn">ğŸ–Šï¸ ìƒì‚° ì—°ìŠµ í•„ìš” ì¹´ë“œ í•™ìŠµ</button></div></div>
<div class="card"><div class="card-title">ğŸ”¥ Hard Cards Top 10 <button class="btn btn-sm" style="background:var(--danger);color:white;margin-left:auto;font-size:11px" onclick="safeStart(()=>startHardCardsStudy('phrasal'))">ì§‘ì¤‘ í•™ìŠµ</button></div><div id="pv-hard-cards-list" style="font-size:13px;max-height:200px;overflow-y:auto"></div></div>
<div class="card"><div class="card-title">ğŸ“… ì£¼ê°„ í•™ìŠµ</div><div class="chart-container" id="pv-weekly-chart"></div></div>
</div>
<div id="stats-expr" class="hidden">
<div class="card"><div class="card-title">ğŸ’¬ í•™ìŠµ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="expr-stats-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="expr-stats-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item"><div class="stat-value warning" id="expr-stats-learning">0</div><div class="stat-label">í•™ìŠµì¤‘</div></div><div class="stat-item"><div class="stat-value" id="expr-stats-new">0</div><div class="stat-label">ë¯¸í•™ìŠµ</div></div></div></div>
<div class="card"><div class="card-title">ğŸ¯ ì¸í’‹/ì•„ì›ƒí’‹ í•™ìŠµ</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div style="background:rgba(249,115,22,0.1);border-radius:12px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:4px">ğŸ‘ï¸ ì¸í’‹ (ì¸ì§€)</div><div style="font-size:24px;font-weight:700;color:var(--expr)" id="expr-stats-input-count">0</div><div style="font-size:11px;color:var(--muted)">í”Œë˜ì‹œì¹´ë“œ/í€´ì¦ˆ/ë¹ˆì¹¸/ë¦¬ìŠ¤ë‹</div><div style="font-size:12px;margin-top:4px"><span id="expr-stats-input-acc" style="color:var(--success)">-</span> ì •ë‹µë¥ </div><div style="font-size:11px;margin-top:2px;color:var(--muted)">ì²«ì‹œë„ <span id="expr-stats-input-first" style="color:var(--expr)">-</span></div></div><div style="background:rgba(34,197,94,0.1);border-radius:12px;padding:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:4px">ğŸ–Šï¸ ì•„ì›ƒí’‹ (ì‚°ì¶œ)</div><div style="font-size:24px;font-weight:700;color:var(--success)" id="expr-stats-output-count">0</div><div style="font-size:11px;color:var(--muted)">íƒ€ì´í•‘/ë°›ì•„ì“°ê¸°</div><div style="font-size:12px;margin-top:4px"><span id="expr-stats-output-acc" style="color:var(--success)">-</span> ì •ë‹µë¥ </div><div style="font-size:11px;margin-top:2px;color:var(--muted)">ì²«ì‹œë„ <span id="expr-stats-output-first" style="color:var(--success)">-</span></div></div></div></div>
<div class="card"><div class="card-title">â±ï¸ í•™ìŠµ ë¶„ì„</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="expr-stats-time" style="font-size:18px">0ë¶„</div><div class="stat-label">ì´ í•™ìŠµì‹œê°„</div></div><div class="stat-item"><div class="stat-value" id="expr-stats-sessions">0</div><div class="stat-label">í•™ìŠµ íšŸìˆ˜</div></div><div class="stat-item"><div class="stat-value" id="expr-stats-avg-acc">0%</div><div class="stat-label">í‰ê·  ì •ë‹µë¥ </div></div><div class="stat-item"><div class="stat-value warning" id="expr-stats-forget">0</div><div class="stat-label">ì˜ˆìƒ ë§ê°</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“¦ ì¹´ë“œ ìƒíƒœ</div><div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;text-align:center"><div style="background:rgba(249,115,22,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--expr)" id="expr-state-new">0</div><div style="font-size:9px;color:var(--muted)">New</div></div><div style="background:rgba(245,158,11,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--warning)" id="expr-state-learning">0</div><div style="font-size:9px;color:var(--muted)">Learning</div></div><div style="background:rgba(239,68,68,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--danger)" id="expr-state-relearning">0</div><div style="font-size:9px;color:var(--muted)">Relearning</div></div><div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:var(--success)" id="expr-state-young">0</div><div style="font-size:9px;color:var(--muted)">Young</div></div><div style="background:rgba(16,185,129,0.15);border-radius:8px;padding:6px"><div style="font-size:16px;font-weight:700;color:#10b981" id="expr-state-mature">0</div><div style="font-size:9px;color:var(--muted)">Mature</div></div></div></div>
<div class="card"><div class="card-title">ğŸŒ Leech ì¹´ë“œ <span id="expr-leech-count" style="font-size:12px;color:var(--danger);margin-left:4px"></span></div><div id="expr-leech-list" style="font-size:13px;max-height:100px;overflow-y:auto"></div></div>
<div class="card"><div class="card-title">ğŸ“¦ Leitner Box</div><div class="leitner-container" id="expr-leitner-stats"></div></div>
<div class="card"><div class="card-title">ğŸ¯ ì •ë‹µë¥  ë¶„í¬</div><div class="stat-grid stat-grid-3"><div class="stat-item"><div class="stat-value success" id="expr-stats-high">0</div><div class="stat-label">80%+</div></div><div class="stat-item"><div class="stat-value warning" id="expr-stats-mid">0</div><div class="stat-label">50-79%</div></div><div class="stat-item"><div class="stat-value danger" id="expr-stats-low">0</div><div class="stat-label">&lt;50%</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“Š FSRS ì•ˆì •ë„ ë¶„í¬</div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center"><div style="background:rgba(239,68,68,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(0,3,'expr'))"><div style="font-size:18px;font-weight:700;color:var(--danger)" id="expr-stability-0-3">0</div><div style="font-size:10px;color:var(--muted)">0-3ì¼</div></div><div style="background:rgba(245,158,11,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(3,7,'expr'))"><div style="font-size:18px;font-weight:700;color:var(--warning)" id="expr-stability-3-7">0</div><div style="font-size:10px;color:var(--muted)">3-7ì¼</div></div><div style="background:rgba(249,115,22,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(7,30,'expr'))"><div style="font-size:18px;font-weight:700;color:var(--expr)" id="expr-stability-7-30">0</div><div style="font-size:10px;color:var(--muted)">7-30ì¼</div></div><div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:8px;cursor:pointer" onclick="safeStart(()=>startStabilityStudy(30,999,'expr'))"><div style="font-size:18px;font-weight:700;color:var(--success)" id="expr-stability-30-plus">0</div><div style="font-size:10px;color:var(--muted)">30ì¼+</div></div></div><div style="font-size:11px;color:var(--muted);margin-top:8px;text-align:center">ğŸ’¡ í´ë¦­í•˜ë©´ í•´ë‹¹ êµ¬ê°„ ì¹´ë“œ í•™ìŠµ</div></div>
<div class="card"><div class="card-title">ğŸ“ˆ 7ì¼ ë¦¬ë·° ì˜ˆì¸¡</div><div class="chart-container" id="expr-forecast-chart" style="height:80px"></div></div>
<div class="card"><div class="card-title">ğŸ“‰ 30ì¼ ì²«ì‹œë„ ì •ë‹µë¥  ì¶”ì´</div><div class="chart-container" id="expr-first-try-chart" style="height:80px"></div></div>
<div class="card"><div class="card-title">âš ï¸ FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ <span id="expr-fsrs-fail-count" style="font-size:12px;color:var(--danger);margin-left:4px"></span></div><div id="expr-fsrs-fail-list" style="font-size:13px;max-height:150px;overflow-y:auto"></div><div style="margin-top:8px;text-align:center"><button class="btn btn-sm" style="background:var(--danger);color:white" onclick="safeStart(()=>startFSRSFailStudy('expr'))" id="expr-fsrs-fail-study-btn">ğŸ¯ ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ ì§‘ì¤‘ í•™ìŠµ</button></div></div>
<div class="card"><div class="card-title">ğŸ”„ ì¸ì§€â†”ìƒì‚° ê°­ ë¶„ì„ <span id="expr-gap-count" style="font-size:12px;color:var(--warning);margin-left:4px"></span></div><div id="expr-gap-analysis" style="font-size:13px"></div><div style="margin-top:8px;text-align:center"><button class="btn btn-sm" style="background:var(--warning);color:white" onclick="safeStart(()=>startGapStudy('expr'))" id="expr-gap-study-btn">ğŸ–Šï¸ ìƒì‚° ì—°ìŠµ í•„ìš” ì¹´ë“œ í•™ìŠµ</button></div></div>
<div class="card"><div class="card-title">ğŸ”¥ Hard Cards Top 10 <button class="btn btn-sm" style="background:var(--danger);color:white;margin-left:auto;font-size:11px" onclick="safeStart(()=>startHardCardsStudy('expr'))">ì§‘ì¤‘ í•™ìŠµ</button></div><div id="expr-hard-cards-list" style="font-size:13px;max-height:200px;overflow-y:auto"></div></div>
<div class="card"><div class="card-title">ğŸ“… ì£¼ê°„ í•™ìŠµ</div><div class="chart-container" id="expr-weekly-chart"></div></div>
</div>
</div>
<!-- ë°ì´í„° -->
<div id="page-data" class="page">
<div class="type-tabs"><div class="type-tab active" data-type="vocab" onclick="switchGlobalType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" data-type="phrasal" onclick="switchGlobalType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" data-type="expr" onclick="switchGlobalType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div class="card"><div class="card-title">ğŸ“š ë‹¨ì–´ ëª©ë¡ <span id="word-count" style="font-size:12px;opacity:.7;margin-left:8px">0ê°œ</span></div>
<div style="display:flex;gap:8px;margin-bottom:12px"><input type="text" id="word-search" placeholder="ğŸ” ê²€ìƒ‰..." style="flex:1;min-width:0;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:10px 14px;font-size:14px;color:var(--text)" oninput="searchWords()"><button class="btn btn-primary" onclick="openAddWordModal()" style="width:50px;padding:10px">â•</button></div>
<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;font-size:11px">
<select id="data-filter-special" onchange="applyDataFilter()" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px">
<option value="all">ì „ì²´</option>
<option value="new-today">ğŸ“… ì˜¤ëŠ˜ ì¶”ê°€</option>
<option value="duplicate">ğŸ“‘ ì¤‘ë³µë‹¨ì–´</option>
<option value="starred">â­ ë¶ë§ˆí¬</option>
<option value="wrong">âŒ ì˜¤ë‹µë…¸íŠ¸</option>
<option value="no-review">ğŸ†• ë¯¸í•™ìŠµ</option>
</select>
<select id="data-filter-cefr" onchange="applyDataFilter()" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px">
<option value="all">ğŸ“š CEFR</option>
<option value="A2">A2</option>
<option value="B1">B1</option>
<option value="B2">B2</option>
<option value="C1">C1</option>
<option value="C2">C2</option>
</select>
<select id="data-filter-priority" onchange="applyDataFilter()" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px">
<option value="all">ğŸ¯ ìš°ì„ ìˆœìœ„</option>
<option value="P1">P1</option>
<option value="P2">P2</option>
<option value="P3">P3</option>
</select>
<select id="data-filter-l2" onchange="applyDataFilter()" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px">
<option value="all">ğŸ“ L2 ë„ë©”ì¸</option>
</select>
<select id="data-filter-formality" onchange="applyDataFilter()" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px">
<option value="all">ğŸ‘” ê²©ì‹ë„</option>
<option value="Formal">Formal</option>
<option value="Neutral">Neutral</option>
<option value="Informal">Informal</option>
</select>
<select id="data-filter-currency" onchange="applyDataFilter()" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px">
<option value="all">â³ ì‹œëŒ€ì„±</option>
<option value="Current">Current</option>
<option value="Dated">Dated</option>
<option value="Archaic">Archaic</option>
</select>
<select id="data-filter-medium" onchange="applyDataFilter()" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px">
<option value="all">ğŸ“¡ ë§¤ì²´</option>
<option value="Both">Both</option>
<option value="Written">Written</option>
<option value="Spoken">Spoken</option>
</select>
<select id="tag-filter-container" onchange="filterByTag(this.value)" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px">
<option value="all">ğŸ·ï¸ íƒœê·¸</option>
</select>
<select id="data-sort" onchange="applyDataFilter()" style="padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px">
<option value="alpha">ê°€ë‚˜ë‹¤ìˆœ</option>
<option value="acc-asc">ì˜¤ë‹µìœ¨â†‘</option>
<option value="acc-desc">ì •ë‹µìœ¨â†‘</option>
<option value="stability-asc">ë¶ˆì•ˆì •â†‘</option>
<option value="due-first">ë³µìŠµì˜ˆì •â†‘</option>
<option value="review-desc">ë³µìŠµíšŸìˆ˜â†‘</option>
<option value="added-desc">ìµœê·¼ì¶”ê°€â†‘</option>
</select>
</div>
<div class="table-container"><table class="word-table"><thead><tr><th id="col1-h">ë‹¨ì–´</th><th>ëœ»</th><th style="width:60px">ì •ë‹µë¥ </th></tr></thead><tbody id="word-table-body"></tbody></table></div><button class="btn btn-secondary btn-sm" style="margin-top:12px" onclick="loadMoreWords()">ë” ë³´ê¸°</button></div>
<div class="card" style="padding:12px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<span style="font-weight:600;font-size:14px">ğŸ’¾ DB í˜„í™©</span>
<span style="font-size:13px"><span id="db-vocab-count" style="color:var(--primary);font-weight:600">0</span> ì–´íœ˜ Â· <span id="db-pv-count" style="color:var(--phrasal);font-weight:600">0</span> êµ¬ë™ì‚¬ Â· <span id="db-expr-count" style="color:var(--expr);font-weight:600">0</span> í‘œí˜„</span>
</div>
<div id="db-stat-vocab">
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“š CEFR ë¶„í¬</div>
<div id="dist-vocab-cefr" style="margin-bottom:12px"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“ L1 ì¹´í…Œê³ ë¦¬</div>
<div id="dist-vocab-l1"></div>
</div>
<div id="db-stat-pv" style="display:none">
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“š CEFR ë¶„í¬</div>
<div id="dist-pv-cefr" style="margin-bottom:12px"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“ Category</div>
<div id="dist-pv-cat"></div>
</div>
<div id="db-stat-expr" style="display:none">
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“š CEFR ë¶„í¬</div>
<div id="dist-expr-cefr" style="margin-bottom:12px"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ‘” Formality</div>
<div id="dist-expr-formality"></div>
</div>
</div>
<div class="card"><div class="card-title">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</div><div class="upload-zone" id="upload-zone"><div class="upload-zone-icon">ğŸ“„</div><p>íƒ­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”<br><small>Vocabulary / Phrasal_Verbs / Expressions ì‹œíŠ¸ ìë™ ê°ì§€</small></p></div><input type="file" accept=".xlsx,.xls" hidden id="file-input"><div class="upload-result hidden" id="upload-result"></div></div>
<div class="card"><div class="card-title">âš™ï¸ ë°ì´í„° ê´€ë¦¬</div><button class="btn btn-primary" style="margin-bottom:10px" onclick="exportWithStats()">ğŸ“Š í•™ìŠµê¸°ë¡ í¬í•¨ ì—‘ì…€ Export</button><button class="btn btn-secondary" style="margin-bottom:10px" onclick="exportAllData()">ğŸ“¤ ì „ì²´ ë°±ì—… (JSON)</button><button class="btn btn-secondary" style="margin-bottom:10px" onclick="document.getElementById('restore-file-input').click()">ğŸ“¥ ë°ì´í„° ë³µì›</button><input type="file" accept=".json" hidden id="restore-file-input" onchange="handleRestoreFile(this)"><button class="btn btn-secondary" style="margin-bottom:10px" onclick="resetWrongNotes()">ğŸ§¹ ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="margin-bottom:10px;color:var(--warning)" onclick="clearDB('words')">ğŸ—‘ï¸ ì–´íœ˜ ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="margin-bottom:10px;color:var(--phrasal)" onclick="clearDB('phrasal_verbs')">ğŸ—‘ï¸ êµ¬ë™ì‚¬ ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="margin-bottom:10px;color:var(--expr)" onclick="clearDB('expressions')">ğŸ—‘ï¸ í‘œí˜„ ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="color:var(--danger)" onclick="resetAllData()">âš ï¸ ì „ì²´ ì´ˆê¸°í™”</button></div>
</div>
<!-- ì„¤ì • -->
<div id="page-settings" class="page">
<div class="card"><div class="card-title">ğŸ“± ì•± ì„¤ì •</div>
<div class="toggle-row"><span class="toggle-label">ë‹¤í¬ ëª¨ë“œ</span><label class="toggle-switch"><input type="checkbox" id="setting-dark" checked onchange="toggleTheme()"><span class="toggle-slider"></span></label></div>
<div class="toggle-row"><span class="toggle-label">ë°œìŒ ìë™ ì¬ìƒ</span><label class="toggle-switch"><input type="checkbox" id="setting-tts" onchange="saveSetting('tts',this.checked)"><span class="toggle-slider"></span></label></div>
<div class="toggle-row"><span class="toggle-label">ì§„ë™ í”¼ë“œë°± <span style="font-size:11px;color:var(--muted)">(Androidë§Œ)</span></span><label class="toggle-switch"><input type="checkbox" id="setting-vibrate" checked onchange="saveSetting('vibrate',this.checked)"><span class="toggle-slider"></span></label></div>
</div>
<div class="card"><div class="card-title">ğŸ“š í•™ìŠµ</div>
<div class="toggle-row" style="margin-bottom:12px"><span class="toggle-label">ğŸ“ ì˜¤ë‹µ ìë™ í¬í•¨ <span style="font-size:11px;color:var(--muted)">(ëª©í‘œ 5ê°œë‹¹ 1ê°œ)</span></span><label class="toggle-switch"><input type="checkbox" id="setting-wrong-auto" checked onchange="saveSetting('wrongAuto',this.checked)"><span class="toggle-slider"></span></label></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px"><div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“ ì˜¤ë‹µ ì¶”ê°€ í•œë„</div><div class="range-container"><input type="range" class="range-slider" id="setting-wrong-limit" min="1" max="10" value="5" oninput="document.getElementById('wrong-limit-val').textContent=this.value" onchange="saveSetting('wrongLimit',this.value)"><div class="range-value"><span id="wrong-limit-val">5</span>ê°œ</div></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--muted);margin-bottom:6px">ğŸ“– ì–´íœ˜ ì¼ì¼ëª©í‘œ</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><button onclick="adjustGoal('vocab',-5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">âˆ’</button><input type="number" class="form-input" id="setting-vocab-goal" value="20" min="1" max="100" style="width:50px;text-align:center;padding:4px;font-size:16px;font-weight:600" onchange="saveSetting('vocabGoal',this.value)"><button onclick="adjustGoal('vocab',5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">+</button></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--muted);margin-bottom:6px">ğŸ”— êµ¬ë™ì‚¬ ì¼ì¼ëª©í‘œ</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><button onclick="adjustGoal('pv',-5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">âˆ’</button><input type="number" class="form-input" id="setting-pv-goal" value="10" min="1" max="100" style="width:50px;text-align:center;padding:4px;font-size:16px;font-weight:600" onchange="saveSetting('pvGoal',this.value)"><button onclick="adjustGoal('pv',5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">+</button></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--muted);margin-bottom:6px">ğŸ’¬ í‘œí˜„ ì¼ì¼ëª©í‘œ</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><button onclick="adjustGoal('expr',-5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">âˆ’</button><input type="number" class="form-input" id="setting-expr-goal" value="10" min="1" max="100" style="width:50px;text-align:center;padding:4px;font-size:16px;font-weight:600" onchange="saveSetting('exprGoal',this.value)"><button onclick="adjustGoal('expr',5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">+</button></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--muted);margin-bottom:6px">ğŸ“ ê¸°ë³¸ í•™ìŠµë¶„ëŸ‰</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><button onclick="adjustGoal('count',-5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">âˆ’</button><input type="number" class="form-input" id="setting-count" value="20" min="5" max="100" style="width:50px;text-align:center;padding:4px;font-size:16px;font-weight:600" onchange="saveSetting('defaultCount',this.value)"><button onclick="adjustGoal('count',5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">+</button></div></div>
</div></div>
<div class="card"><div class="card-title">ğŸ§  FSRS ìŠ¤ì¼€ì¤„ë§</div>
<div class="toggle-row"><span class="toggle-label">Interval Fuzz <span style="font-size:11px;color:var(--muted)">(Â±5% ëœë¤)</span></span><label class="toggle-switch"><input type="checkbox" id="setting-fuzz" checked onchange="FSRS.intervalFuzz=this.checked;saveSetting('intervalFuzz',this.checked)"><span class="toggle-slider"></span></label></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:6px">ğŸ†• ì¼ì¼ ìƒˆ ì¹´ë“œ</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><input type="number" class="form-input" id="setting-daily-new" value="9999" min="1" max="9999" style="width:60px;text-align:center;padding:4px;font-size:14px" onchange="FSRS.dailyNewLimit=parseInt(this.value);saveSetting('dailyNewLimit',this.value)"></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:6px">ğŸ“– ì¼ì¼ ë³µìŠµ</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><input type="number" class="form-input" id="setting-daily-review" value="9999" min="1" max="9999" style="width:60px;text-align:center;padding:4px;font-size:14px" onchange="FSRS.dailyReviewLimit=parseInt(this.value);saveSetting('dailyReviewLimit',this.value)"></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:6px">ğŸŒ™ ë‹¤ìŒë‚  ì‹œì‘</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><input type="number" class="form-input" id="setting-next-day" value="4" min="0" max="12" style="width:50px;text-align:center;padding:4px;font-size:14px" onchange="FSRS.nextDayStartsAt=parseInt(this.value);saveSetting('nextDayStartsAt',this.value)"><span style="font-size:12px;color:var(--muted)">AM</span></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:6px">ğŸŒ Leech ê¸°ì¤€</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><input type="number" class="form-input" id="setting-leech" value="8" min="4" max="20" style="width:50px;text-align:center;padding:4px;font-size:14px" onchange="FSRS.leechThreshold=parseInt(this.value);saveSetting('leechThreshold',this.value)"><span style="font-size:12px;color:var(--muted)">íšŒ</span></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:6px">ğŸ“… ìµœëŒ€ ê°„ê²©</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><input type="number" class="form-input" id="setting-max-interval" value="365" min="30" max="36500" style="width:60px;text-align:center;padding:4px;font-size:14px" onchange="FSRS.maxInterval=parseInt(this.value);saveSetting('maxInterval',this.value)"><span style="font-size:12px;color:var(--muted)">ì¼</span></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:11px;color:var(--muted);margin-bottom:6px">ğŸ¯ ëª©í‘œ ê¸°ì–µë¥ </div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><input type="number" class="form-input" id="setting-retention" value="90" min="70" max="99" style="width:50px;text-align:center;padding:4px;font-size:14px" onchange="FSRS.requestRetention=parseInt(this.value)/100;saveSetting('requestRetention',this.value)"><span style="font-size:12px;color:var(--muted)">%</span></div></div>
</div>
<div style="font-size:11px;color:var(--muted);margin-top:10px;text-align:center">Learning Steps: 1mâ†’10m | Relearning: 10m</div>
</div>
<div class="card"><div class="card-title">â„¹ï¸ ë²„ì „ ì •ë³´</div><p style="font-size:13px;color:var(--muted);line-height:1.8"><strong>CEMS Vocab Pro v7.2</strong><br>â€¢ ğŸ§  FSRS-6 ì•Œê³ ë¦¬ì¦˜ (Anki í˜¸í™˜)<br>â€¢ ğŸ“Š Card States (Young/Mature)<br>â€¢ ğŸŒ Leech ê°ì§€ ë° ê²½ê³ <br>â€¢ âš™ï¸ ê³ ê¸‰ ìŠ¤ì¼€ì¤„ë§ ì„¤ì •</p></div>
</div>
</div>
<!-- ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="bottom-nav">
<a class="nav-item active" href="javascript:void(0)" onclick="showPage('home')" data-page="home"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>í™ˆ</a>
<a class="nav-item" href="javascript:void(0)" onclick="showPage('study')" data-page="study"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>í•™ìŠµ</a>
<a class="nav-item" href="javascript:void(0)" onclick="showPage('stats')" data-page="stats"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>ë¶„ì„</a>
<a class="nav-item" href="javascript:void(0)" onclick="showPage('data')" data-page="data"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>ë°ì´í„°</a>
<a class="nav-item" href="javascript:void(0)" onclick="showPage('settings')" data-page="settings"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>ì„¤ì •</a>
</nav>
<!-- í† ìŠ¤íŠ¸ & ëª¨ë‹¬ -->
<!-- íƒœê·¸ ëª¨ë‹¬ -->
<div class="modal-overlay" id="tag-modal"><div class="modal"><div class="modal-header"><h3>ğŸ·ï¸ íƒœê·¸ ê´€ë¦¬</h3><button class="modal-close" onclick="closeModal('tag-modal')">âœ•</button></div>
<p style="font-size:13px;color:var(--muted);margin-bottom:12px" id="tag-word-display">ë‹¨ì–´</p>
<div style="font-size:13px;margin-bottom:8px">í˜„ì¬ íƒœê·¸:</div>
<div id="current-tags" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;min-height:30px"></div>
<div style="font-size:13px;margin-bottom:8px">ë¹ ë¥¸ ì¶”ê°€:</div>
<div id="preset-tags" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px"></div>
<div style="display:flex;gap:8px"><input type="text" class="form-input" id="new-tag-input" placeholder="ìƒˆ íƒœê·¸ ì…ë ¥..." style="flex:1"><button class="btn btn-primary btn-sm" onclick="addCustomTag()" style="width:60px">ì¶”ê°€</button></div>
</div></div>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="complete-modal"><div class="modal"><div class="modal-header"><h3>ğŸ‰ í•™ìŠµ ì™„ë£Œ!</h3><button class="modal-close" onclick="closeModal('complete-modal')">âœ•</button></div><div class="stat-grid" style="margin-bottom:20px"><div class="stat-item"><div class="stat-value" id="complete-total">0</div><div class="stat-label">í•™ìŠµ</div></div><div class="stat-item"><div class="stat-value success" id="complete-known">0</div><div class="stat-label">ë³´í†µ+</div></div><div class="stat-item"><div class="stat-value warning" id="complete-unknown">0</div><div class="stat-label">ì–´ë ¤ì›€</div></div><div class="stat-item"><div class="stat-value" id="complete-time">0ë¶„</div><div class="stat-label">ì‹œê°„</div></div></div><div id="complete-wrong-info" class="hidden" style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px;text-align:center"><span style="color:var(--danger)">ğŸ“ <span id="complete-wrong-count">0</span>ê°œ ì˜¤ë‹µë…¸íŠ¸ ì €ì¥</span></div><button class="btn btn-primary" onclick="closeModal('complete-modal');showPage(studyStartPage,true);">í™•ì¸</button></div></div>
<div class="modal-overlay" id="quiz-complete-modal"><div class="modal"><div class="modal-header"><h3>ğŸ¯ í•™ìŠµ ì™„ë£Œ!</h3><button class="modal-close" onclick="closeModal('quiz-complete-modal')">âœ•</button></div><div class="stat-grid" style="margin-bottom:20px"><div class="stat-item"><div class="stat-value" id="qc-total">0</div><div class="stat-label">ë¬¸ì œ</div></div><div class="stat-item"><div class="stat-value success" id="qc-correct">0</div><div class="stat-label">ì •ë‹µ</div></div><div class="stat-item"><div class="stat-value danger" id="qc-wrong">0</div><div class="stat-label">ì˜¤ë‹µ</div></div><div class="stat-item"><div class="stat-value" id="qc-acc">0%</div><div class="stat-label">ì •ë‹µë¥ </div></div></div><div id="qc-wrong-info" class="hidden" style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px;text-align:center"><span style="color:var(--danger)">ğŸ“ <span id="qc-wrong-count">0</span>ê°œ ì˜¤ë‹µë…¸íŠ¸ ì €ì¥</span></div>
<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-secondary" id="qc-wrong-btn" onclick="closeModal('quiz-complete-modal');startWrongReview(lastStudyType||'vocab');" style="flex:1;padding:14px">ğŸ“ ì˜¤ë‹µë³µìŠµ</button><button class="btn btn-secondary" id="qc-prod-btn" onclick="closeModal('quiz-complete-modal');startProductionStudy(lastStudyType||'vocab');" style="flex:1;padding:14px">ğŸ–Šï¸ ì‚°ì¶œì—°ìŠµ</button></div>
<button class="btn btn-primary" onclick="closeModal('quiz-complete-modal');showPage(studyStartPage,true);" style="padding:16px;font-size:16px">âœ“ ëŒì•„ê°€ê¸°</button></div></div>
<div class="modal-overlay" id="confirm-modal" style="z-index:1100"><div class="modal"><div class="modal-header"><h3 id="confirm-title">í™•ì¸</h3><button class="modal-close" onclick="closeModal('confirm-modal')">âœ•</button></div><p id="confirm-msg" style="margin-bottom:20px;color:var(--muted)"></p><div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="closeModal('confirm-modal')" style="flex:1">ì·¨ì†Œ</button><button class="btn btn-primary" id="confirm-btn" style="flex:1">í™•ì¸</button></div></div></div>
<div class="modal-overlay" id="edit-modal"><div class="modal" style="max-height:90vh;overflow-y:auto"><div class="modal-header"><h3>âœï¸ ë‹¨ì–´ í¸ì§‘</h3><button class="modal-close" onclick="closeModal('edit-modal')">âœ•</button></div>
<div class="form-group"><label class="form-label">ë‹¨ì–´/êµ¬ë™ì‚¬</label><input type="text" class="form-input" id="edit-word" readonly style="background:var(--border)"></div>
<div class="form-group"><label class="form-label">ëœ» (í•œêµ­ì–´)</label><input type="text" class="form-input" id="edit-meaning-ko"></div>
<div class="form-group"><label class="form-label">ëœ» (ì˜ì–´)</label><input type="text" class="form-input" id="edit-meaning-en"></div>
<div class="form-group"><label class="form-label">ì˜ˆë¬¸</label><textarea class="form-input" id="edit-example" rows="2" style="text-align:left"></textarea></div>
<div class="form-group" id="edit-pos-group"><label class="form-label" id="edit-pos-label">í’ˆì‚¬ (POS)</label><input type="text" class="form-input" id="edit-pos" placeholder="ì˜ˆ: noun, verb, adj"></div>
<div id="edit-vocab-fields">
<div class="form-group"><label class="form-label">ğŸ“ ë¶„ë¥˜ (L2)</label><select class="form-select" id="edit-l2" onchange="autoSetL1L0()">
<optgroup label="ğŸ“š Academic > Science"><option value="Life">Life (ìƒëª…)</option><option value="Physical">Physical (ë¬¼ë¦¬)</option><option value="Earth">Earth (ì§€êµ¬)</option><option value="Applied">Applied (ì‘ìš©)</option></optgroup>
<optgroup label="ğŸ“š Academic > Society"><option value="Psychology">Psychology (ì‹¬ë¦¬)</option><option value="Culture">Culture (ë¬¸í™”)</option><option value="Economy">Economy (ê²½ì œ)</option><option value="Politics">Politics (ì •ì¹˜)</option><option value="History">History (ì—­ì‚¬)</option></optgroup>
<optgroup label="ğŸ“š Academic > Arts"><option value="Literature">Literature (ë¬¸í•™)</option><option value="Visual">Visual (ì‹œê°)</option><option value="Performing">Performing (ê³µì—°)</option><option value="Ideas">Ideas (ì‚¬ìƒ)</option></optgroup>
<optgroup label="ğŸ“š Academic > General"><option value="Core">Core (í•µì‹¬)</option><option value="Research">Research (ì—°êµ¬)</option><option value="Argument">Argument (ë…¼ì¦)</option></optgroup>
<optgroup label="ğŸ  Daily > Concrete"><option value="Body">Body (ì‹ ì²´)</option><option value="Objects">Objects (ì‚¬ë¬¼)</option><option value="Nature">Nature (ìì—°)</option></optgroup>
<optgroup label="ğŸ  Daily > Activity"><option value="Living">Living (ìƒí™œ)</option><option value="Work">Work (ì§ì¥)</option><option value="Commerce">Commerce (ìƒê±°ë˜)</option><option value="Travel">Travel (ì—¬í–‰)</option><option value="Health">Health (ê±´ê°•)</option></optgroup>
<optgroup label="ğŸ  Daily > Social"><option value="Relationships">Relationships (ê´€ê³„)</option><option value="Leisure">Leisure (ì—¬ê°€)</option></optgroup>
</select></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">CEFR</label><select class="form-select" id="edit-cefr"><option value="A2">A2</option><option value="B1">B1</option><option value="B2">B2</option><option value="C1">C1</option><option value="C2">C2</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ“š í† í”Œ ì—°ê´€ì„±</label><select class="form-select" id="edit-toefl"><option value="">ì„ íƒ</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ”¢ ë¹ˆë„</label><select class="form-select" id="edit-freq"><option value="">ì„ íƒ</option><option value="K1">K1</option><option value="K2">K2</option><option value="K3">K3</option><option value="K4">K4</option><option value="K5+">K5+</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">â­ ìš°ì„ ìˆœìœ„</label><select class="form-select" id="edit-priority"><option value="">ì„ íƒ</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ‘” ê²©ì‹ë„</label><select class="form-select" id="edit-formality"><option value="Formal">Formal</option><option value="Neutral">Neutral</option><option value="Informal">Informal</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">â³ ì‹œëŒ€ì„±</label><select class="form-select" id="edit-currency"><option value="Current">Current</option><option value="Dated">Dated</option><option value="Archaic">Archaic</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ“¡ ë§¤ì²´</label><select class="form-select" id="edit-medium"><option value="Both">Both</option><option value="Written">Written</option><option value="Spoken">Spoken</option></select></div>
</div>
<div class="form-group"><label class="form-label">Key Collocation</label><input type="text" class="form-input" id="edit-collocation"></div>
<div class="form-group"><label class="form-label">ğŸ“ ë‚˜ë§Œì˜ ì˜ˆë¬¸ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label><textarea class="form-input" id="edit-user-examples" rows="2" placeholder="I analyzed the data carefully." style="text-align:left;font-size:13px"></textarea></div>
<div class="form-group"><label class="form-label">ğŸ”— ì¶”ê°€ Collocations (ì‰¼í‘œë¡œ êµ¬ë¶„)</label><input type="text" class="form-input" id="edit-user-collocs" placeholder="analyze data, carefully analyze" style="text-align:left"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ”„ ë™ì˜ì–´</label><input type="text" class="form-input" id="edit-synonyms" placeholder="ì‰¼í‘œë¡œ êµ¬ë¶„" style="text-align:left"></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">â†”ï¸ ë°˜ì˜ì–´</label><input type="text" class="form-input" id="edit-antonyms" placeholder="ì‰¼í‘œë¡œ êµ¬ë¶„" style="text-align:left"></div>
</div>
</div>
<div id="edit-pv-fields" style="display:none">
<div class="form-group"><label class="form-label">Base Verb</label><input type="text" class="form-input" id="edit-base-verb" placeholder="ì˜ˆ: figure, pick, take"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">Category</label><select class="form-select" id="edit-pv-category"><option value="General">General</option><option value="Academic">Academic</option><option value="Daily">Daily</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">CEFR</label><select class="form-select" id="edit-pv-cefr"><option value="A2">A2</option><option value="B1">B1</option><option value="B2">B2</option><option value="C1">C1</option><option value="C2">C2</option></select></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ‘” ê²©ì‹ë„</label><select class="form-select" id="edit-pv-formality"><option value="Formal">Formal</option><option value="Neutral">Neutral</option><option value="Informal">Informal</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">â³ ì‹œëŒ€ì„±</label><select class="form-select" id="edit-pv-currency"><option value="Current">Current</option><option value="Dated">Dated</option><option value="Archaic">Archaic</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ“¡ ë§¤ì²´</label><select class="form-select" id="edit-pv-medium"><option value="Both">Both</option><option value="Written">Written</option><option value="Spoken">Spoken</option></select></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ“š í† í”Œ ì—°ê´€ì„±</label><select class="form-select" id="edit-pv-toefl"><option value="">ì„ íƒ</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">â­ ìš°ì„ ìˆœìœ„</label><select class="form-select" id="edit-pv-priority"><option value="">ì„ íƒ</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
</div>
<div class="form-group"><label class="form-label">Formal Equivalent</label><input type="text" class="form-input" id="edit-formal-equiv" placeholder="ê²©ì‹ì²´ ëŒ€ì²´ í‘œí˜„"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ”„ ë™ì˜ì–´</label><input type="text" class="form-input" id="edit-pv-synonyms" placeholder="ì‰¼í‘œë¡œ êµ¬ë¶„" style="text-align:left"></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">â†”ï¸ ë°˜ì˜ì–´</label><input type="text" class="form-input" id="edit-pv-antonyms" placeholder="ì‰¼í‘œë¡œ êµ¬ë¶„" style="text-align:left"></div>
</div>
</div>
<div class="form-group"><label class="form-label">ğŸ·ï¸ íƒœê·¸</label>
<div class="chip-multi chip-small" id="edit-suggested-tags" style="margin-bottom:8px"><span class="chip" data-value="Academic">Academic</span><span class="chip" data-value="Literary">Literary</span><span class="chip" data-value="Legal">Legal</span><span class="chip" data-value="Business">Business</span><span class="chip" data-value="Technical">Technical</span><span class="chip" data-value="Medical">Medical</span><span class="chip" data-value="BrE">BrE</span><span class="chip" data-value="AmE">AmE</span><span class="chip" data-value="Idiom">Idiom</span><span class="chip" data-value="TOEFL">TOEFL</span></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<input type="text" class="form-input" id="edit-tags" placeholder="ì¶”ê°€ íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)" style="text-align:left">
<input type="text" class="form-input" id="edit-coca" placeholder="ğŸ“Š COCA ì¥ë¥´ (academic, spoken...)" style="text-align:left">
</div>
</div>
<div style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px">
<div class="card-title" style="margin-bottom:12px">ğŸ“Š í•™ìŠµ í†µê³„</div>
<div class="stat-grid stat-grid-3" style="gap:8px">
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-review-count" style="font-size:18px">0</div><div class="stat-label">ë³µìŠµ</div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-accuracy" style="font-size:18px">-</div><div class="stat-label">ì •ë‹µë¥ </div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-box" style="font-size:18px">1</div><div class="stat-label">Box</div></div>
</div>
<div class="stat-grid stat-grid-3" style="gap:8px;margin-top:8px">
<div class="stat-item" style="padding:8px"><div class="stat-value danger" id="edit-wrong-count" style="font-size:18px">0</div><div class="stat-label">ì˜¤ë‹µ</div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-ease" style="font-size:18px">2.5</div><div class="stat-label">Ease</div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-next-review" style="font-size:14px">-</div><div class="stat-label">ë‹¤ìŒë³µìŠµ</div></div>
</div>
</div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="closeModal('edit-modal')" style="flex:1">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveEditedWord()" style="flex:1">ğŸ’¾ ì €ì¥</button></div>
<div style="display:flex;gap:10px;margin-top:10px"><button class="btn btn-secondary" id="edit-bookmark-btn" onclick="toggleBookmark()" style="flex:1">â­ ë¶ë§ˆí¬</button><button class="btn btn-secondary" onclick="shareWord()" style="flex:1">ğŸ“¤ ê³µìœ </button></div>
<div style="display:flex;gap:10px;margin-top:10px"><button class="btn btn-secondary" onclick="copyWord()" style="flex:1">ğŸ“‹ ë³µì‚¬</button><button class="btn btn-secondary" onclick="resetWordStats()" style="flex:1;color:var(--warning)">ğŸ”„ ì´ˆê¸°í™”</button></div>
<button class="btn btn-secondary" onclick="deleteWord()" style="margin-top:10px;color:var(--danger)">ğŸ—‘ï¸ ë‹¨ì–´ ì‚­ì œ</button>
</div></div>
<div class="modal-overlay" id="expr-edit-modal"><div class="modal" style="max-height:90vh;overflow-y:auto"><div class="modal-header"><h3>âœï¸ í‘œí˜„ í¸ì§‘</h3><button class="modal-close" onclick="closeModal('expr-edit-modal')">âœ•</button></div>
<div class="form-group"><label class="form-label">í‘œí˜„</label><input type="text" class="form-input" id="expr-edit-key" readonly style="background:var(--border)"></div>
<div class="form-group"><label class="form-label">ëœ» (í•œêµ­ì–´)</label><input type="text" class="form-input" id="expr-edit-meaning"></div>
<div class="form-group"><label class="form-label">ê¸°ëŠ¥ (Function)</label><input type="text" class="form-input" id="expr-edit-function"></div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ‘” ê²©ì‹ë„</label><select class="form-select" id="expr-edit-formality"><option value="Neutral">Neutral</option><option value="Formal">Formal</option><option value="Informal">Informal</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">â³ ì‹œëŒ€ì„±</label><select class="form-select" id="expr-edit-currency"><option value="Current">Current</option><option value="Dated">Dated</option><option value="Archaic">Archaic</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ“¡ ë§¤ì²´</label><select class="form-select" id="expr-edit-medium"><option value="Both">Both</option><option value="Written">Written</option><option value="Spoken">Spoken</option></select></div>
</div>
<div class="form-group"><label class="form-label">ì˜ˆë¬¸ 1</label><textarea class="form-input" id="expr-edit-example1" rows="2" style="text-align:left"></textarea></div>
<div class="form-group"><label class="form-label">ì˜ˆë¬¸ 2</label><textarea class="form-input" id="expr-edit-example2" rows="2" style="text-align:left"></textarea></div>
<div class="form-group"><label class="form-label">ìœ ì‚¬ í‘œí˜„</label><input type="text" class="form-input" id="expr-edit-similar"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ“š í† í”Œ ì—°ê´€ì„±</label><select class="form-select" id="expr-edit-toefl"><option value="">ì„ íƒ</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">â­ ìš°ì„ ìˆœìœ„</label><select class="form-select" id="expr-edit-priority"><option value="">ì„ íƒ</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
</div>
<div class="form-group"><label class="form-label">íƒœê·¸ L1 / L2 / L3</label><div style="display:flex;gap:8px"><input type="text" class="form-input" id="expr-edit-l1" placeholder="L1" style="flex:1;width:auto"><input type="text" class="form-input" id="expr-edit-l2" placeholder="L2" style="flex:1;width:auto"><input type="text" class="form-input" id="expr-edit-l3" placeholder="L3" style="flex:1;width:auto"></div></div>
<div class="form-group"><label class="form-label">ğŸ·ï¸ íƒœê·¸</label>
<div class="chip-multi chip-small" id="expr-edit-suggested-tags" style="margin-bottom:8px"><span class="chip" data-value="Academic">Academic</span><span class="chip" data-value="Literary">Literary</span><span class="chip" data-value="Legal">Legal</span><span class="chip" data-value="Business">Business</span><span class="chip" data-value="Technical">Technical</span><span class="chip" data-value="Medical">Medical</span><span class="chip" data-value="BrE">BrE</span><span class="chip" data-value="AmE">AmE</span><span class="chip" data-value="Idiom">Idiom</span><span class="chip" data-value="TOEFL">TOEFL</span></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<input type="text" class="form-input" id="expr-edit-tags" placeholder="ì¶”ê°€ íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)" style="text-align:left">
<input type="text" class="form-input" id="expr-edit-coca" placeholder="ğŸ“Š COCA ì¥ë¥´ (academic, spoken...)" style="text-align:left">
</div>
</div>
<div style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px">
<div class="card-title" style="margin-bottom:12px">ğŸ“Š í•™ìŠµ í†µê³„</div>
<div class="stat-grid stat-grid-3" style="gap:8px">
<div class="stat-item" style="padding:8px"><div class="stat-value" id="expr-edit-review" style="font-size:18px">0</div><div class="stat-label">ë³µìŠµ</div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="expr-edit-acc" style="font-size:18px">-</div><div class="stat-label">ì •ë‹µë¥ </div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="expr-edit-next" style="font-size:14px">-</div><div class="stat-label">ë‹¤ìŒë³µìŠµ</div></div>
</div>
</div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="closeModal('expr-edit-modal')" style="flex:1">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveExprEdit()" style="flex:1">ğŸ’¾ ì €ì¥</button></div>
<div style="display:flex;gap:10px;margin-top:10px"><button class="btn btn-secondary" id="expr-edit-bookmark-btn" onclick="toggleExprBookmark()" style="flex:1">â­ ë¶ë§ˆí¬</button><button class="btn btn-secondary" onclick="resetExprStats()" style="flex:1;color:var(--warning)">ğŸ”„ ì´ˆê¸°í™”</button></div>
<button class="btn btn-secondary" onclick="deleteExprItem()" style="margin-top:10px;color:var(--danger)">ğŸ—‘ï¸ í‘œí˜„ ì‚­ì œ</button>
</div></div>
<div class="modal-overlay" id="add-word-modal"><div class="modal" style="max-height:90vh;overflow-y:auto"><div class="modal-header"><h3>â• ë‹¨ì–´ ì¶”ê°€</h3><button class="modal-close" onclick="closeModal('add-word-modal')">âœ•</button></div>
<div class="type-tabs" style="margin-bottom:16px"><div class="type-tab active" id="add-type-vocab" onclick="switchAddType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" id="add-type-phrasal" onclick="switchAddType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" id="add-type-expr" onclick="switchAddType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div class="form-group"><label class="form-label" id="add-word-label">ë‹¨ì–´/êµ¬ë™ì‚¬ *</label><input type="text" class="form-input" id="add-word" placeholder="í•„ìˆ˜ ì…ë ¥"></div>
<div class="form-group"><label class="form-label">ëœ» (í•œêµ­ì–´) *</label><input type="text" class="form-input" id="add-meaning-ko" placeholder="í•„ìˆ˜ ì…ë ¥"></div>
<div class="form-group" id="add-meaning-en-group"><label class="form-label">ëœ» (ì˜ì–´)</label><input type="text" class="form-input" id="add-meaning-en"></div>
<div class="form-group"><label class="form-label">ì˜ˆë¬¸</label><textarea class="form-input" id="add-example" rows="2" style="text-align:left"></textarea></div>
<div class="form-group" id="add-pos-group"><label class="form-label">í’ˆì‚¬ (POS)</label><input type="text" class="form-input" id="add-pos" placeholder="ì˜ˆ: noun, verb, adj"></div>
<div id="add-vocab-fields">
<div class="form-group"><label class="form-label">ë¶„ë¥˜ (L1)</label><select class="form-select" id="add-l1"><optgroup label="ğŸ“š Academic"><option value="Science">Science (ê³¼í•™)</option><option value="Society">Society (ì‚¬íšŒ)</option><option value="Arts">Arts (ì˜ˆìˆ )</option><option value="General" selected>General (ì¼ë°˜í•™ìˆ )</option></optgroup><optgroup label="ğŸ  Daily"><option value="Concrete">Concrete (êµ¬ì²´ë¬¼)</option><option value="Activity">Activity (í™œë™)</option><option value="Social">Social (ì‚¬êµ)</option></optgroup></select></div>
<div class="form-group"><label class="form-label">ì„¸ë¶€ ë¶„ë¥˜ (L2)</label><select class="form-select" id="add-l2">
<optgroup label="Science"><option value="Life">Life (ìƒëª…)</option><option value="Physical">Physical (ë¬¼ë¦¬)</option><option value="Earth">Earth (ì§€êµ¬)</option><option value="Applied">Applied (ì‘ìš©)</option></optgroup>
<optgroup label="Society"><option value="Psychology">Psychology (ì‹¬ë¦¬)</option><option value="Culture">Culture (ë¬¸í™”)</option><option value="Economy">Economy (ê²½ì œ)</option><option value="Politics">Politics (ì •ì¹˜)</option><option value="History">History (ì—­ì‚¬)</option></optgroup>
<optgroup label="Arts"><option value="Literature">Literature (ë¬¸í•™)</option><option value="Visual">Visual (ì‹œê°)</option><option value="Performing">Performing (ê³µì—°)</option><option value="Ideas">Ideas (ì‚¬ìƒ)</option></optgroup>
<optgroup label="General"><option value="Core" selected>Core (í•µì‹¬)</option><option value="Research">Research (ì—°êµ¬)</option><option value="Argument">Argument (ë…¼ì¦)</option></optgroup>
<optgroup label="Concrete"><option value="Body">Body (ì‹ ì²´)</option><option value="Objects">Objects (ì‚¬ë¬¼)</option><option value="Nature">Nature (ìì—°)</option></optgroup>
<optgroup label="Activity"><option value="Living">Living (ìƒí™œ)</option><option value="Work">Work (ì§ì¥)</option><option value="Commerce">Commerce (ìƒê±°ë˜)</option><option value="Travel">Travel (ì—¬í–‰)</option><option value="Health">Health (ê±´ê°•)</option></optgroup>
<optgroup label="Social"><option value="Relationships">Relationships (ê´€ê³„)</option><option value="Leisure">Leisure (ì—¬ê°€)</option></optgroup>
</select></div>
<div class="form-group"><label class="form-label">CEFR ë ˆë²¨</label><select class="form-select" id="add-cefr"><option value="A2">A2</option><option value="B1" selected>B1</option><option value="B2">B2</option><option value="C1">C1</option><option value="C2">C2</option></select></div>
<div class="form-group"><label class="form-label">Key Collocation</label><input type="text" class="form-input" id="add-collocation" placeholder="ì˜ˆ: make a decision"></div>
<div class="form-group"><label class="form-label">ğŸ“ ë‚˜ë§Œì˜ ì˜ˆë¬¸ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label><textarea class="form-input" id="add-user-examples" rows="2" placeholder="ì§ì ‘ ë§Œë“  ì˜ˆë¬¸ì„ ì¶”ê°€í•˜ì„¸ìš”" style="text-align:left;font-size:13px"></textarea></div>
<div class="form-group"><label class="form-label">ğŸ”— ì¶”ê°€ Collocations (ì‰¼í‘œë¡œ êµ¬ë¶„)</label><input type="text" class="form-input" id="add-user-collocs" placeholder="ì˜ˆ: analyze data, carefully analyze" style="text-align:left"></div>
</div>
<div id="add-pv-fields" style="display:none">
<div class="form-group"><label class="form-label">Base Verb / Particle</label><div style="display:flex;gap:8px"><input type="text" class="form-input" id="add-base-verb" placeholder="Base Verb" style="flex:1;width:auto"><input type="text" class="form-input" id="add-particle" placeholder="Particle" style="flex:1;width:auto"></div></div>
<div class="form-group"><label class="form-label">Category</label><select class="form-select" id="add-pv-category"><option value="General">General (ì¤‘ë¦½)</option><option value="Academic">Academic (í•™ìˆ )</option><option value="Daily">Daily (êµ¬ì–´)</option></select></div>
<div class="form-group"><label class="form-label">Formal Equivalent</label><input type="text" class="form-input" id="add-formal-equiv" placeholder="ì˜ˆ: discover, understand"></div>
</div>
<div id="add-expr-fields" style="display:none">
<div class="form-group"><label class="form-label">ê¸°ëŠ¥ (Function)</label><input type="text" class="form-input" id="add-function" placeholder="ì˜ˆ: Expressing opinion, Making suggestions"></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ‘” ê²©ì‹ë„</label><select class="form-select" id="add-formality"><option value="Neutral">Neutral</option><option value="Formal">Formal</option><option value="Informal">Informal</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">â³ ì‹œëŒ€ì„±</label><select class="form-select" id="add-currency"><option value="Current">Current</option><option value="Dated">Dated</option><option value="Archaic">Archaic</option></select></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label">ğŸ“¡ ë§¤ì²´</label><select class="form-select" id="add-medium"><option value="Both">Both</option><option value="Written">Written</option><option value="Spoken">Spoken</option></select></div>
</div>
<div class="form-group"><label class="form-label">ğŸ·ï¸ íƒœê·¸</label>
<div class="chip-multi chip-small" id="add-suggested-tags" style="margin-bottom:8px"><span class="chip" data-value="Academic">Academic</span><span class="chip" data-value="Literary">Literary</span><span class="chip" data-value="Legal">Legal</span><span class="chip" data-value="Business">Business</span><span class="chip" data-value="Technical">Technical</span><span class="chip" data-value="Medical">Medical</span><span class="chip" data-value="BrE">BrE</span><span class="chip" data-value="AmE">AmE</span><span class="chip" data-value="Idiom">Idiom</span><span class="chip" data-value="TOEFL">TOEFL</span></div>
<input type="text" class="form-input" id="add-tags" placeholder="ì¶”ê°€ íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)" style="text-align:left">
</div>
<div class="form-group"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="add-bookmark" checked> â­ ë¶ë§ˆí¬ì— ì¶”ê°€</label></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="closeModal('add-word-modal')" style="flex:1">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveNewWord()" style="flex:1">ğŸ’¾ ì €ì¥</button></div>
</div></div>
<div class="modal-overlay" id="paste-modal"><div class="modal" style="max-height:90vh;overflow-y:auto;max-width:600px">
<div class="modal-header"><h3>â• ë°ì´í„° ì¶”ê°€</h3><button class="modal-close" onclick="closeModal('paste-modal')">âœ•</button></div>
<div class="type-tabs" style="margin-bottom:16px">
<div class="type-tab active" id="add-tab-paste" onclick="switchAddTab('paste')">ğŸ“‹ ë¶™ì—¬ë„£ê¸°</div>
<div class="type-tab" id="add-tab-excel" onclick="switchAddTab('excel')">ğŸ“„ ì—‘ì…€ ì—…ë¡œë“œ</div>
</div>
<div id="add-content-paste">
<div class="form-group">
<label class="form-label">ë°ì´í„° íƒ€ì…</label>
<div class="chip-group" id="paste-type-group">
<span class="chip active" data-value="vocab" onclick="selectPasteType('vocab')">ğŸ“– ì–´íœ˜</span>
<span class="chip" data-value="phrasal" onclick="selectPasteType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</span>
<span class="chip" data-value="expr" onclick="selectPasteType('expr')">ğŸ’¬ í‘œí˜„</span>
</div>
</div>
<div class="form-group">
<label class="form-label">TSV/í‘œ ë°ì´í„° (í—¤ë” í¬í•¨)</label>
<textarea class="form-input" id="paste-data" rows="10" placeholder="Excel, AI í‘œ, ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ëª¨ë‘ ì§€ì›&#10;&#10;âœ“ TSV (íƒ­ êµ¬ë¶„)&#10;âœ“ ë§ˆí¬ë‹¤ìš´ (| êµ¬ë¶„)&#10;&#10;í•„ìˆ˜: word + Meaning1_KO" style="text-align:left;font-family:monospace;font-size:12px"></textarea>
<div style="font-size:11px;color:var(--muted);margin-top:4px">
ğŸ’¡ í•„ìˆ˜ ì»¬ëŸ¼: <strong>word</strong> (ë˜ëŠ” Phrasal_Verb, Expression) + <strong>Meaning1_KO</strong>
</div>
</div>
<div id="paste-preview" style="display:none;background:var(--bg);border-radius:12px;padding:12px;margin-bottom:16px">
<div style="font-size:13px;font-weight:600;margin-bottom:8px">ğŸ“Š ë¯¸ë¦¬ë³´ê¸°</div>
<div style="font-size:12px;color:var(--muted)" id="paste-preview-info"></div>
<div id="paste-preview-sample" style="max-height:150px;overflow-y:auto;font-size:12px;margin-top:8px"></div>
</div>
<div style="display:flex;gap:10px">
<button class="btn btn-secondary" onclick="previewPaste()" style="flex:1">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button>
<button class="btn btn-primary" onclick="confirmPaste()" style="flex:1">âœ… DBì— ì¶”ê°€</button>
</div>
</div>
<div id="add-content-excel" style="display:none">
<div style="background:rgba(99,102,241,.1);border-radius:8px;padding:10px 12px;margin-bottom:12px;font-size:12px;color:var(--primary)">
ğŸ’¡ <strong>ìƒˆ ë‹¨ì–´ ì¶”ê°€ìš©</strong> - ì‹ ê·œ í•™ìŠµ ëª©ë¡ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤
</div>
<div class="upload-zone" id="modal-upload-zone" style="padding:40px 20px;border:2px dashed var(--border);border-radius:12px;text-align:center;cursor:pointer;transition:all .2s" onclick="document.getElementById('modal-file-input').click()">
<div style="font-size:48px;margin-bottom:12px">ğŸ“„</div>
<p style="margin:0;color:var(--text)">íƒ­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
<p style="margin:8px 0 0;font-size:12px;color:var(--muted)">ì–´íœ˜/êµ¬ë™ì‚¬/í‘œí˜„ ì‹œíŠ¸ ìë™ ê°ì§€</p>
</div>
<input type="file" accept=".xlsx,.xls" hidden id="modal-file-input" onchange="processModalExcel(this.files[0])">
<div id="modal-upload-result" style="display:none;margin-top:16px;background:var(--bg);border-radius:12px;padding:12px">
<div style="font-size:13px;font-weight:600;margin-bottom:8px">ğŸ“Š ê°ì§€ëœ ì‹œíŠ¸ (ìƒˆ ë‹¨ì–´ë¡œ ì¶”ê°€)</div>
<div id="modal-upload-info" style="font-size:12px"></div>
</div>
<div id="modal-upload-actions" style="display:none;margin-top:16px">
<button class="btn btn-primary" onclick="confirmModalExcel()" style="width:100%">ğŸ†• ìƒˆ ë‹¨ì–´ë¡œ ì¶”ê°€</button>
</div>
</div>
<button class="btn btn-secondary" onclick="closeModal('paste-modal')" style="margin-top:16px;width:100%">ì·¨ì†Œ</button>
</div></div>
<script>

const DB_NAME='CEMS_VocabDB_v4',DB_VER=2,LEITNER=[1,3,7,14,30],PARTICLES=['up','down','out','in','on','off','away','back','over','through','around','about','along','apart'];

// ========== ê³µí†µ ìœ í‹¸ í•¨ìˆ˜ ==========
// ì •ê·œì‹ íŠ¹ìˆ˜ë¬¸ì escape (C++, (i.e.), end-to-end ë“± ì²˜ë¦¬)
const escapeRegex = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

// íƒ€ì´í•‘/ë°›ì•„ì“°ê¸° ì •ë‹µ íŒì •ìš© ì •ê·œí™” (í—ˆìš© ë³€ì´ ì²˜ë¦¬)
function normalizeAnswer(s) {
  return (s || '')
    .toLowerCase()
    .trim()
    .replace(/[''`]/g, "'")      // ì•„í¬ìŠ¤íŠ¸ë¡œí”¼ í†µì¼
    .replace(/[-â€“â€”]/g, '-')      // ëŒ€ì‹œ í†µì¼
    .replace(/\s+/g, ' ')        // ë‹¤ì¤‘ ê³µë°± ì œê±°
    .replace(/[.?!,;:()"Â«Â»]/g, ''); // êµ¬ë‘ì  ì œê±°
}

// Invalid ì•„ì´í…œ ì•ˆì „ ìŠ¤í‚µ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
function safeSkipInvalid(state, renderFn, endFn, maxSkips = 5) {
  state.skipCount = (state.skipCount || 0) + 1;
  if (state.skipCount >= maxSkips) {
    console.warn('Too many invalid items, ending session');
    state.skipCount = 0;
    return endFn();
  }
  state.idx++;
  if (state.idx >= state.words.length) {
    state.skipCount = 0;
    return endFn();
  }
  return renderFn();
}

// ========== FSRS-4.5 Algorithm ==========
// ì°¸ì¡°: https://github.com/open-spaced-repetition/fsrs4anki
// ì›¹ì•±ìš©ìœ¼ë¡œ ì´ˆê¸° stability ì¡°ì • (w[0]~w[3])
const FSRS = {
  // â˜… FSRS-6 ê¸°ë³¸ íŒŒë¼ë¯¸í„° (21ê°œ) - ê³µì‹ ë¬¸ì„œ ê¸°ì¤€
  // [S0(1), S0(2), S0(3), S0(4), w4, w5, w6, w7, w8, w9, w10, w11, w12, w13, w14, w15, w16, w17, w18, w19, w20]
  w: [0.212, 1.2931, 2.3065, 8.2956, 6.4133, 0.8334, 3.0194, 0.001,
      1.8722, 0.1666, 0.796, 1.4835, 0.0614, 0.2629, 1.6483, 0.6014,
      1.8729, 0.5425, 0.0912, 0.0658, 0.1542],
  requestRetention: 0.9, // ëª©í‘œ ê¸°ì–µë¥  90%
  
  // â˜… Anki ìŠ¤íƒ€ì¼ ì„¤ì • (NEW)
  learningSteps: [1, 10],      // ë¶„ ë‹¨ìœ„ Learning Steps (Anki ê¸°ë³¸: 1m 10m)
  relearningSteps: [10],       // ë¶„ ë‹¨ìœ„ Relearning Steps (Again ì‹œ)
  graduatingInterval: 1,       // Learning ì™„ë£Œ í›„ ì²« ê°„ê²© (ì¼)
  easyInterval: 4,             // Easy ë²„íŠ¼ ì‹œ ê°„ê²© (ì¼)
  intervalFuzz: true,          // ê°„ê²© Â±5% ëœë¤ ë³€ë™
  nextDayStartsAt: 4,          // ë‹¤ìŒ ë‚  ì‹œì‘ ì‹œê° (AM)
  leechThreshold: 8,           // Leech íŒì • lapses ìˆ˜
  dailyNewLimit: 9999,         // ì¼ì¼ ìƒˆ ì¹´ë“œ ì œí•œ (ê¸°ë³¸ ë¬´ì œí•œ)
  dailyReviewLimit: 9999,      // ì¼ì¼ ë³µìŠµ ì œí•œ (ê¸°ë³¸ ë¬´ì œí•œ)
  YOUNG_THRESHOLD: 21,         // Young/Mature êµ¬ë¶„ ê¸°ì¤€ (ì¼)
  maxInterval: 365,            // ìµœëŒ€ ê°„ê²© (ì¼) - ê¸°ë³¸ 1ë…„
  
  // â˜… FSRS-6 factor: R(S,S)=90%ê°€ ë˜ë„ë¡ ì •ì˜
  factor() {
    const w20 = this.w[20];
    return Math.pow(0.9, -1 / w20) - 1;
  },
  
  // ì´ˆê¸° Stability (ìƒˆ ì¹´ë“œ ì²« ë³µìŠµ ì‹œ)
  // S0(G) = w[G-1] (G: 1=Again, 2=Hard, 3=Good, 4=Easy)
  initStability(grade) {
    // grade: 0=Again, 1=Hard, 2=Good, 3=Easy (0-indexed)
    return Math.max(0.1, this.w[grade]);
  },
  
  // â˜… FSRS-5/6 ì´ˆê¸° Difficulty
  // D0(G) = w[4] - e^(w[5]*(G-1)) + 1
  initDifficulty(grade) {
    const G = grade + 1; // 0-indexed â†’ 1-indexed (1~4)
    const d = this.w[4] - Math.exp(this.w[5] * (G - 1)) + 1;
    return Math.min(10, Math.max(1, d));
  },
  
  // â˜… FSRS-6 Retrievability (ê¸°ì–µ í™•ë¥ )
  // R(t,S) = (1 + factor * t/S)^(-w20)
  retrievability(elapsedDays, stability) {
    if (!stability || stability <= 0) return 0;
    const f = this.factor();
    const w20 = this.w[20];
    return Math.pow(1 + f * (elapsedDays / stability), -w20);
  },
  
  // â˜… FSRS-6 ë‹¤ìŒ ë³µìŠµ ê°„ê²©
  // I(r,S) = (S/factor) * (r^(-1/w20) - 1)
  nextInterval(stability) {
    const f = this.factor();
    const w20 = this.w[20];
    const interval = (stability / f) * (Math.pow(this.requestRetention, -1 / w20) - 1);
    return Math.min(this.maxInterval, Math.max(1, Math.round(interval))); // ìµœëŒ€ maxInterval ì œí•œ
  },
  
  // â˜… FSRS-5/6 Difficulty ì—…ë°ì´íŠ¸ (Linear Damping + Mean Reversion to D0(4))
  // Î”D(G) = -w[6] * (G-3)
  // D' = D + Î”D * (10-D)/9  (linear damping)
  // D'' = w[7] * D0(4) + (1-w[7]) * D'  (mean reversion)
  updateDifficulty(D, grade) {
    const G = grade + 1;
    // D0(4) = w[4] - e^(w[5]*(4-1)) + 1
    const D0_easy = this.w[4] - Math.exp(this.w[5] * (4 - 1)) + 1;
    const deltaD = -this.w[6] * (G - 3);
    const D1 = D + deltaD * (10 - D) / 9; // linear damping
    const D2 = this.w[7] * D0_easy + (1 - this.w[7]) * D1; // mean reversion
    return Math.min(10, Math.max(1, D2));
  },
  
  // â˜… Stability ì—…ë°ì´íŠ¸ (ì„±ê³µ: grade 1,2,3 = Hard,Good,Easy) - FSRS v4 ê³µì‹ ìœ ì§€
  // S'r = S * (e^w[8] * (11-D) * S^-w[9] * (e^(w[10]*(1-R)) - 1) * hardPenalty * easyBonus + 1)
  updateStabilitySuccess(D, S, R, grade) {
    const G = grade + 1;
    const hardPenalty = G === 2 ? this.w[15] : 1; // Hard
    const easyBonus = G === 4 ? this.w[16] : 1;   // Easy
    const SInc = Math.exp(this.w[8]) * (11 - D) * Math.pow(S, -this.w[9]) * 
                 (Math.exp(this.w[10] * (1 - R)) - 1) * hardPenalty * easyBonus + 1;
    return Math.max(0.1, S * SInc);
  },
  
  // â˜… Stability ì—…ë°ì´íŠ¸ (ì‹¤íŒ¨: grade 0 = Again)
  // S'f = w[11] * D^-w[12] * ((S+1)^w[13] - 1) * e^(w[14]*(1-R))
  updateStabilityFail(D, S, R) {
    const newS = this.w[11] * Math.pow(D, -this.w[12]) * 
                 (Math.pow(S + 1, this.w[13]) - 1) * Math.exp(this.w[14] * (1 - R));
    return Math.min(Math.max(0.1, newS), S); // ì‹¤íŒ¨ ì‹œ stabilityëŠ” ê¸°ì¡´ë³´ë‹¤ ì‘ì•„ì•¼ í•¨
  },
  
  // â˜… FSRS-6 Same-day Stability ì—…ë°ì´íŠ¸ (ìˆ˜ì •ë¨)
  // S'(S,G) = S * e^(w[17] * (G-3+w[18])) * S^(-w[19])
  // G>=3ì¼ ë•Œ S'>=S ë³´ì¥ í•„ìš”
  updateStabilitySameDay(S, grade) {
    const G = grade + 1;
    const w17 = this.w[17], w18 = this.w[18], w19 = this.w[19];
    // â˜… ìˆ˜ì •: S^(-w19)ê°€ ì§€ìˆ˜ ë°–ì— ìˆì–´ì•¼ í•¨ (ê³±ì…ˆ)
    const SInc = Math.exp(w17 * (G - 3 + w18)) * Math.pow(S, -w19);
    // G>=3 (Good/Easy)ì¼ ë•Œ Sê°€ ê°ì†Œí•˜ì§€ ì•Šë„ë¡ ë³´ì¥
    if (G >= 3) {
      return Math.max(S, S * SInc);
    }
    return Math.max(0.1, S * SInc);
  },
  
  // SM-2/Leitner ë°ì´í„°ë¥¼ FSRSë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
  migrateFromSM2(item) {
    const box = item.leitnerBox || 1;
    const ease = item.ease || 2.5;
    // Leitner Box â†’ Stability ë³€í™˜
    const stabilityMap = {1: 1, 2: 3, 3: 7, 4: 14, 5: 30};
    const stability = (stabilityMap[box] || 1) * (ease / 2.5);
    // Ease â†’ Difficulty ë³€í™˜ (ease 2.5=easy â†’ D=1, ease 1.3=hard â†’ D=10)
    const difficulty = Math.max(1, Math.min(10, 11 - (ease * 4)));
    return { stability, difficulty };
  },
  
  // â˜… Interval Fuzz: Â±5% ëœë¤ ë³€ë™ (ê°™ì€ ë‚  ì¶”ê°€ëœ ì¹´ë“œ ë¶„ì‚°)
  applyFuzz(interval) {
    if (!this.intervalFuzz || interval < 3) return interval;
    const fuzzRange = Math.max(1, Math.round(interval * 0.05));
    const fuzz = Math.floor(Math.random() * (fuzzRange * 2 + 1)) - fuzzRange;
    return Math.max(1, interval + fuzz);
  },
  
  // â˜… ë‹¤ìŒ ë‚  ì‹œì‘ ì‹œê° ê¸°ì¤€ìœ¼ë¡œ ì˜¤ëŠ˜/ë‚´ì¼ íŒì •
  isNextDay(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    // nextDayStartsAt ì‹œê° ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ì¡°ì •
    d1.setHours(d1.getHours() - this.nextDayStartsAt);
    d2.setHours(d2.getHours() - this.nextDayStartsAt);
    return d1.toDateString() !== d2.toDateString();
  },
  
  // â˜… Card State êµ¬ë¶„ (Anki ìŠ¤íƒ€ì¼)
  getCardState(item) {
    if (!item.reps || item.reps === 0) return 'New';
    if (item.fsrsState === 'Learning') return 'Learning';
    if (item.fsrsState === 'Relearning') return 'Relearning';
    const interval = item.interval || 0;
    if (interval >= this.YOUNG_THRESHOLD) return 'Mature';
    return 'Young';
  },
  
  // â˜… Leech íŒì • (8íšŒ ì‹¤íŒ¨ ì‹œ)
  checkLeech(item) {
    const lapses = item.lapses || 0;
    if (lapses >= this.leechThreshold && lapses % (this.leechThreshold / 2) === 0) {
      return true; // Leech ê²½ê³  ë°œìƒ
    }
    return false;
  },
  
  // â˜… Learning Step ê°„ê²© ê³„ì‚° (ë¶„ â†’ ë‹¤ìŒ ë³µìŠµ ì‹œê°„)
  getLearningStepInterval(stepIndex, isRelearning = false) {
    const steps = isRelearning ? this.relearningSteps : this.learningSteps;
    if (stepIndex >= steps.length) {
      return isRelearning ? 1 : this.graduatingInterval; // ì¡¸ì—…
    }
    return steps[stepIndex]; // ë¶„ ë‹¨ìœ„
  }
};

// â˜… ì¼ì¼ í•™ìŠµ ì¹´ìš´í„° (Daily Limits ìš©)
const dailyCounter = {
  date: null,
  newCount: 0,
  reviewCount: 0,
  reset() {
    const today = new Date();
    today.setHours(today.getHours() - FSRS.nextDayStartsAt);
    const todayStr = today.toDateString();
    if (this.date !== todayStr) {
      this.date = todayStr;
      this.newCount = 0;
      this.reviewCount = 0;
    }
  },
  canStudyNew() {
    this.reset();
    return this.newCount < FSRS.dailyNewLimit;
  },
  canStudyReview() {
    this.reset();
    return this.reviewCount < FSRS.dailyReviewLimit;
  },
  addNew() { this.reset(); this.newCount++; },
  addReview() { this.reset(); this.reviewCount++; }
};

// FSRS ê¸°ë°˜ ë‹¤ìŒ ë³µìŠµ ê³„ì‚° (â˜… Anki ìŠ¤íƒ€ì¼ ì—…ê·¸ë ˆì´ë“œ)
function calcNext(item, grade) {
  // grade: 0=Again(ëª¨ë¦„), 1=Hard(ì–´ë ¤ì›€), 2=Good(ë³´í†µ), 3=Easy(ì‰¬ì›€)
  const now = new Date();
  let S = item.stability;
  let D = item.difficulty;
  let learningStep = item.learningStep || 0;
  let fsrsState = item.fsrsState || 'New';
  let lapses = item.lapses || 0;
  let isLeech = item.isLeech || false;
  
  // ìƒˆ ì¹´ë“œ ë˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” (â˜… null ì²´í¬ ì¶”ê°€)
  if (S === undefined || S === null || D === undefined || D === null) {
    if (item.leitnerBox || item.ease) {
      // SM-2 ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
      const migrated = FSRS.migrateFromSM2(item);
      S = migrated.stability;
      D = migrated.difficulty;
      fsrsState = 'Review';
    } else {
      // â˜… ì™„ì „íˆ ìƒˆ ì¹´ë“œ - Learning Steps ì ìš©
      S = FSRS.initStability(grade);
      D = FSRS.initDifficulty(grade);
      
      if (grade === 0) {
        // Again: ì²« ë‹¨ê³„ë¡œ
        learningStep = 0;
        fsrsState = 'Learning';
        const stepMinutes = FSRS.getLearningStepInterval(0, false);
        const nextReview = new Date(now.getTime() + stepMinutes * 60 * 1000);
        return {
          stability: S, difficulty: D, interval: 0,
          nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
          fsrsState: 'Learning', learningStep: 0,
          reps: 1, lapses: 1, isLeech: false,
          leitnerBox: 1
        };
      } else if (grade === 3) {
        // Easy: ë°”ë¡œ ì¡¸ì—… (Easy Interval)
        const interval = FSRS.applyFuzz(FSRS.easyInterval);
        const nextReview = new Date(now);
        nextReview.setDate(nextReview.getDate() + interval);
        return {
          stability: S, difficulty: D, interval: interval,
          nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
          fsrsState: 'Review', learningStep: -1,
          reps: 1, lapses: 0, isLeech: false,
          leitnerBox: stabilityToBox(S)
        };
      } else {
        // Hard/Good: Learning Steps ì§„í–‰
        learningStep = (grade === 1) ? 0 : 1;
        if (learningStep >= FSRS.learningSteps.length) {
          // ì¡¸ì—…
          const interval = FSRS.applyFuzz(FSRS.graduatingInterval);
          const nextReview = new Date(now);
          nextReview.setDate(nextReview.getDate() + interval);
          return {
            stability: S, difficulty: D, interval: interval,
            nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
            fsrsState: 'Review', learningStep: -1,
            reps: 1, lapses: 0, isLeech: false,
            leitnerBox: stabilityToBox(S)
          };
        }
        const stepMinutes = FSRS.getLearningStepInterval(learningStep, false);
        const nextReview = new Date(now.getTime() + stepMinutes * 60 * 1000);
        return {
          stability: S, difficulty: D, interval: 0,
          nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
          fsrsState: 'Learning', learningStep: learningStep,
          reps: 1, lapses: 0, isLeech: false,
          leitnerBox: 1
        };
      }
    }
  }
  
  // â˜… FSRS-6: ê²½ê³¼ì¼ ê³„ì‚° (0 ì´ìƒ í—ˆìš© - same-day ì§€ì›)
  let lastReview = null;
  if (item.lastReview && typeof item.lastReview === 'string' && item.lastReview.trim() !== '') {
    const parsed = new Date(item.lastReview);
    if (!isNaN(parsed.getTime())) {
      lastReview = parsed;
    }
  }
  const elapsedDays = lastReview ? Math.max(0, (now - lastReview) / (1000 * 60 * 60 * 24)) : 1;
  
  // â˜… Learning/Relearning ìƒíƒœ ì²˜ë¦¬
  if (fsrsState === 'Learning' || fsrsState === 'Relearning') {
    const isRelearning = fsrsState === 'Relearning';
    const steps = isRelearning ? FSRS.relearningSteps : FSRS.learningSteps;
    
    if (grade === 0) {
      // Again: ì²« ë‹¨ê³„ë¡œ ë˜ëŒì•„ê°
      learningStep = 0;
      if (isRelearning) lapses++; // Relearningì—ì„œ Againì€ lapses ì¦ê°€ ì•ˆ í•¨ (ì´ë¯¸ ì¦ê°€ë¨)
      const stepMinutes = FSRS.getLearningStepInterval(0, isRelearning);
      const nextReview = new Date(now.getTime() + stepMinutes * 60 * 1000);
      
      // â˜… Leech ì²´í¬
      if (FSRS.checkLeech({...item, lapses})) {
        isLeech = true;
      }
      
      return {
        stability: S, difficulty: D, interval: 0,
        nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
        fsrsState: fsrsState, learningStep: 0,
        reps: (item.reps || 0) + 1, lapses: lapses, isLeech: isLeech,
        leitnerBox: 1
      };
    } else if (grade === 3) {
      // Easy: ë°”ë¡œ ì¡¸ì—…
      D = FSRS.updateDifficulty(D, grade);
      const interval = FSRS.applyFuzz(isRelearning ? 1 : FSRS.easyInterval);
      const nextReview = new Date(now);
      nextReview.setDate(nextReview.getDate() + interval);
      return {
        stability: S, difficulty: D, interval: interval,
        nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
        fsrsState: 'Review', learningStep: -1,
        reps: (item.reps || 0) + 1, lapses: lapses, isLeech: isLeech,
        leitnerBox: stabilityToBox(S)
      };
    } else {
      // Hard/Good: ë‹¤ìŒ ë‹¨ê³„ë¡œ
      learningStep = (grade === 1) ? learningStep : learningStep + 1;
      if (learningStep >= steps.length) {
        // ì¡¸ì—…!
        D = FSRS.updateDifficulty(D, grade);
        const interval = FSRS.applyFuzz(isRelearning ? 1 : FSRS.graduatingInterval);
        const nextReview = new Date(now);
        nextReview.setDate(nextReview.getDate() + interval);
        return {
          stability: S, difficulty: D, interval: interval,
          nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
          fsrsState: 'Review', learningStep: -1,
          reps: (item.reps || 0) + 1, lapses: lapses, isLeech: isLeech,
          leitnerBox: stabilityToBox(S)
        };
      }
      const stepMinutes = FSRS.getLearningStepInterval(learningStep, isRelearning);
      const nextReview = new Date(now.getTime() + stepMinutes * 60 * 1000);
      return {
        stability: S, difficulty: D, interval: 0,
        nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
        fsrsState: fsrsState, learningStep: learningStep,
        reps: (item.reps || 0) + 1, lapses: lapses, isLeech: isLeech,
        leitnerBox: 1
      };
    }
  }
  
  // â˜… Review ìƒíƒœ ì²˜ë¦¬ (FSRS ì•Œê³ ë¦¬ì¦˜ ì ìš©)
  D = FSRS.updateDifficulty(D, grade);
  
  if (elapsedDays < 1) {
    // Same-day review
    if (grade === 0) {
      const R = FSRS.retrievability(Math.max(0.001, elapsedDays), S);
      S = FSRS.updateStabilityFail(D, S, R);
      lapses++;
      
      // â˜… Relearning Steps ì‹œì‘
      const stepMinutes = FSRS.getLearningStepInterval(0, true);
      const nextReview = new Date(now.getTime() + stepMinutes * 60 * 1000);
      
      // â˜… Leech ì²´í¬
      if (FSRS.checkLeech({...item, lapses})) {
        isLeech = true;
      }
      
      return {
        stability: S, difficulty: D, interval: 0,
        nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
        fsrsState: 'Relearning', learningStep: 0,
        reps: (item.reps || 0) + 1, lapses: lapses, isLeech: isLeech,
        leitnerBox: 1
      };
    } else {
      S = FSRS.updateStabilitySameDay(S, grade);
      fsrsState = 'Review';
    }
  } else {
    // Normal review (1ì¼ ì´ìƒ ê²½ê³¼)
    const R = FSRS.retrievability(elapsedDays, S);
    
    if (grade === 0) {
      S = FSRS.updateStabilityFail(D, S, R);
      lapses++;
      
      // â˜… Relearning Steps ì‹œì‘
      const stepMinutes = FSRS.getLearningStepInterval(0, true);
      const nextReview = new Date(now.getTime() + stepMinutes * 60 * 1000);
      
      // â˜… Leech ì²´í¬
      if (FSRS.checkLeech({...item, lapses})) {
        isLeech = true;
      }
      
      return {
        stability: S, difficulty: D, interval: 0,
        nextReview: nextReview.toISOString(), lastReview: now.toISOString(),
        fsrsState: 'Relearning', learningStep: 0,
        reps: (item.reps || 0) + 1, lapses: lapses, isLeech: isLeech,
        leitnerBox: 1
      };
    } else {
      S = FSRS.updateStabilitySuccess(D, S, R, grade);
      fsrsState = 'Review';
    }
  }
  
  // â˜… ë‹¤ìŒ ê°„ê²© ê³„ì‚° (Fuzz ì ìš©)
  let interval = FSRS.nextInterval(S);
  interval = FSRS.applyFuzz(interval);
  const nextReview = new Date(now);
  nextReview.setDate(nextReview.getDate() + interval);
  
  return {
    stability: S,
    difficulty: D,
    interval: interval,
    nextReview: nextReview.toISOString(),
    lastReview: now.toISOString(),
    fsrsState: fsrsState,
    learningStep: -1,
    reps: (item.reps || 0) + 1,
    lapses: lapses,
    isLeech: isLeech,
    leitnerBox: stabilityToBox(S)
  };
}

// Stability â†’ Leitner Box ë³€í™˜ (í˜¸í™˜ì„± ìœ ì§€)
function stabilityToBox(S) {
  // Stability ê¸°ì¤€: Box 1(<2ì¼), 2(2-5ì¼), 3(5-12ì¼), 4(12-25ì¼), 5(25ì¼+)
  if (S < 2) return 1;
  if (S < 5) return 2;
  if (S < 12) return 3;
  if (S < 25) return 4;
  return 5;
}
let db=null,wordOffset=0,currentDataType='vocab',currentStudyType='vocab',currentWeakType='vocab',currentHomeType='vocab';
// í”Œë˜ì‹œì¹´ë“œ ìƒíƒœ
let fcState={words:[],idx:0,flipped:false,start:null,timer:null,stats:{again:0,hard:0,good:0,easy:0},transitioning:false,retryQueue:[],phase:'normal',type:'vocab',savedToWrong:0,allWords:[],originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};
let lastStudyType='vocab';
let studyStartPage='home'; // í•™ìŠµ ì‹œì‘ í˜ì´ì§€ ì¶”ì 
// í€´ì¦ˆ ìƒíƒœ
let quizState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,mode:'quiz',type:'vocab',retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};
// íƒ€ì´í•‘ ìƒíƒœ
let typingState={words:[],idx:0,correct:0,wrong:0,hintUsed:false,answered:false,start:null,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};
// PV í€´ì¦ˆ ìƒíƒœ
let pvState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,mode:'particle',retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};
// Cloze ìƒíƒœ
let clozeState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};
// Collocation ìƒíƒœ
let collocState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};
// Expression ìƒíƒœ
let exprState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,flipped:false,transitioning:false,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,timer:null,stats:{again:0,hard:0,good:0,easy:0},originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};
// Expression íƒ€ì´í•‘ ìƒíƒœ (ë³„ë„ ê´€ë¦¬)
let exprTypingState={words:[],allWords:[],idx:0,correct:0,wrong:0,hintUsed:false,answered:false,start:null,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};

// === DB ===
function openDB(){return new Promise((res,rej)=>{const req=indexedDB.open(DB_NAME,DB_VER);req.onerror=()=>rej(req.error);req.onsuccess=()=>{db=req.result;res(db);};req.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('words'))d.createObjectStore('words',{keyPath:'word'});if(!d.objectStoreNames.contains('phrasal_verbs'))d.createObjectStore('phrasal_verbs',{keyPath:'Phrasal_Verb'});if(!d.objectStoreNames.contains('expressions'))d.createObjectStore('expressions',{keyPath:'Expression'});if(!d.objectStoreNames.contains('sessions'))d.createObjectStore('sessions',{keyPath:'id',autoIncrement:true});};})}
// â˜… Register â†’ Formality/Currency/Medium ë§ˆì´ê·¸ë ˆì´ì…˜
function migrateRegister(item){
  if(!item)return item;
  // ì´ë¯¸ ë§ˆì´ê·¸ë ˆì´ì…˜ëœ ê²½ìš° ìŠ¤í‚µ
  if(item.Formality&&item.Currency&&item.Medium)return item;
  const reg=item.Register||'Neutral';
  // ê¸°ì¡´ Register ê°’ì— ë”°ë¼ ë³€í™˜
  if(reg==='Archaic'){
    item.Formality=item.Formality||'Formal';
    item.Currency=item.Currency||'Archaic';
    item.Medium=item.Medium||'Written';
  }else if(reg==='Slang'){
    item.Formality=item.Formality||'Informal';
    item.Currency=item.Currency||'Current';
    item.Medium=item.Medium||'Spoken';
  }else if(reg==='Formal'){
    item.Formality=item.Formality||'Formal';
    item.Currency=item.Currency||'Current';
    item.Medium=item.Medium||'Both';
  }else if(reg==='Casual'||reg==='Informal'){
    item.Formality=item.Formality||'Informal';
    item.Currency=item.Currency||'Current';
    item.Medium=item.Medium||'Both';
  }else{
    item.Formality=item.Formality||'Neutral';
    item.Currency=item.Currency||'Current';
    item.Medium=item.Medium||'Both';
  }
  return item;
}
async function getAllWords(){return new Promise(r=>{const req=db.transaction('words','readonly').objectStore('words').getAll();req.onsuccess=()=>r((req.result||[]).map(migrateRegister));req.onerror=()=>r([]);})}
async function getAllPV(){return new Promise(r=>{const req=db.transaction('phrasal_verbs','readonly').objectStore('phrasal_verbs').getAll();req.onsuccess=()=>r((req.result||[]).map(migrateRegister));req.onerror=()=>r([]);})}
async function getAllExpr(){return new Promise(r=>{try{const req=db.transaction('expressions','readonly').objectStore('expressions').getAll();req.onsuccess=()=>r((req.result||[]).map(migrateRegister));req.onerror=()=>r([]);}catch(e){r([]);}})}
async function saveWord(w){return new Promise(r=>{const tx=db.transaction('words','readwrite');tx.objectStore('words').put(w);tx.oncomplete=r;})}
async function savePV(p){return new Promise(r=>{const tx=db.transaction('phrasal_verbs','readwrite');tx.objectStore('phrasal_verbs').put(p);tx.oncomplete=r;})}
async function saveExpr(e){return new Promise(r=>{const tx=db.transaction('expressions','readwrite');tx.objectStore('expressions').put(e);tx.oncomplete=r;})}
async function saveSession(s){lastStudyType=s.type||'vocab';return new Promise(r=>{const tx=db.transaction('sessions','readwrite');s.date=new Date().toISOString();tx.objectStore('sessions').add(s);tx.oncomplete=r;})}
async function getSessions(){return new Promise(r=>{const req=db.transaction('sessions','readonly').objectStore('sessions').getAll();req.onsuccess=()=>r(req.result||[]);req.onerror=()=>r([]);})}
async function getWord(w){return new Promise(r=>{try{const req=db.transaction('words','readonly').objectStore('words').get(w);req.onsuccess=()=>r(req.result||null);req.onerror=()=>r(null);}catch(e){r(null);}})}
async function getPV(p){return new Promise(r=>{try{const req=db.transaction('phrasal_verbs','readonly').objectStore('phrasal_verbs').get(p);req.onsuccess=()=>r(req.result||null);req.onerror=()=>r(null);}catch(e){r(null);}})}
async function getExpr(k){return new Promise(r=>{try{const req=db.transaction('expressions','readonly').objectStore('expressions').get(k);req.onsuccess=()=>r(req.result||null);req.onerror=()=>r(null);}catch(e){r(null);}})}
async function deleteExpr(k){return new Promise(r=>{const tx=db.transaction('expressions','readwrite');tx.objectStore('expressions').delete(k);tx.oncomplete=r;})}

// === í—¬í¼ ===
function getMKO(i){return i?.Meaning1_KO||i?.MeaningKO||i?.Meaning_KO||'';}
function getMEN(i){return i?.Meaning1_EN||i?.MeaningEN||i?.Meaning_EN||'';}
function getEx(i){return i?.Example1||i?.Example||'';}
function getW(i){return i?.word||i?.Phrasal_Verb||'';}
// ë‹¤ì˜ì–´ í‘œì‹œ: dash1 â†’ dash<sup>1</sup>, ê²€ìƒ‰ìš©ì€ ìˆ«ì ì œê±°
function displayWord(w, forSearch=false){
  if(!w) return '';
  // ê´„í˜¸ ì œê±°
  let display = (w||'').replace(/\s*\(.*?\)\s*/g, '').trim();
  // ëì˜ ìˆ«ì ì²˜ë¦¬
  if(forSearch) {
    // ê²€ìƒ‰ìš©: ìˆ«ì ì™„ì „ ì œê±°
    return display.replace(/\d+$/, '');
  } else {
    // í‘œì‹œìš©: ìƒë‹¨ ì²¨ìë¡œ ë³€í™˜
    return display.replace(/(\d+)$/, '<sup style="font-size:0.6em;color:var(--muted)">$1</sup>');
  }
}
function getAcc(i){const rc=i?.reviewCount||0;return rc>0?Math.round(((i?.correctCount||0)/rc)*100):null;}
// â˜… ì¸í’‹/ì•„ì›ƒí’‹ ëª¨ë“œ ë¶„ë¥˜ í—¬í¼
// ì•„ì›ƒí’‹: ì§ì ‘ ì“°ê±°ë‚˜ ë§í•˜ëŠ” ëª¨ë“œ (typing, dictation)
// ì¸í’‹: ì½ê±°ë‚˜ ë“£ê³  ì„ íƒí•˜ëŠ” ëª¨ë“œ (ë‚˜ë¨¸ì§€)
function isOutputMode(mode){
return ['typing','dictation','expr-typing'].includes(mode);
}
function getSkillType(mode){
return isOutputMode(mode)?'output':'input';
}
// 4. ì·¨ì•½ ë‹¨ì–´ íŒë³„ ê°œì„  (FSRS stability í™œìš©)
function isWeak(i){
const rc=i?.reviewCount||0;
// â˜… ìˆ˜ì •: ì´ˆê¸° í•™ìŠµ(1-2íšŒ)ì—ì„œ ì˜¤ë‹µì´ë©´ ì·¨ì•½ìœ¼ë¡œ íŒë³„
if(rc>=1&&rc<3){
  // ì´ˆê¸° í•™ìŠµ ë‹¨ê³„: ì •í™•ë„ 50% ë¯¸ë§Œì´ë©´ ì·¨ì•½
  const acc=getAcc(i);
  if(acc!==null&&acc<50)return true;
  // ì—°ì† ì˜¤ë‹µ 1íšŒë¼ë„ ìˆìœ¼ë©´ ì·¨ì•½
  if((i?.consecutiveWrong||0)>=1)return true;
}
if(rc<1)return false; // ì•„ì˜ˆ í•™ìŠµ ì•ˆ í•œ ê±´ ì·¨ì•½ ì•„ë‹˜ (ìƒˆ ë‹¨ì–´)
// ì—°ì† ì˜¤ë‹µ 2íšŒ ì´ìƒ
if((i?.consecutiveWrong||0)>=2)return true;
// FSRS stability ë‚®ìŒ (3ì¼ ë¯¸ë§Œ)
if(i?.stability&&i.stability<3)return true;
// ì •í™•ë„ + ìµœê·¼ì„± ê°€ì¤‘ì¹˜
const acc=getAcc(i);
if(acc===null)return false;
const daysSinceWrong=i?.lastWrongDate?(Date.now()-new Date(i.lastWrongDate))/(1000*60*60*24):999;
const recencyBonus=daysSinceWrong<7?10:0;
return(acc+recencyBonus)<60;
}
function isWrong(i){return(i?.consecutiveWrong||0)>=1;}

// â˜…â˜…â˜… ì‚°ì¶œ ì—°ìŠµ ì§„ì…/í•´ì œ ê³µí†µ í•¨ìˆ˜ (ëª¨ë“ˆí™”) â˜…â˜…â˜…
// mode: 'flashcard', 'quiz', 'typing', 'cloze', 'collocation', 'listening', 'dictation', 'expr-fc', 'expr-quiz', 'expr-cloze', 'expr-typing', 'pv-particle', 'pv-meaning'
// ë°˜í™˜ê°’: { shouldToast: boolean, message: string }
function updateProductionStatus(item, isCorrect, mode) {
  if(!item) return { shouldToast: false };
  
  const outputModes = ['typing', 'expr-typing', 'dictation'];
  const flashcardModes = ['flashcard', 'expr-fc'];
  const inputModes = ['quiz', 'reverse', 'cloze', 'collocation', 'listening', 'pv-particle', 'pv-meaning', 'expr-quiz', 'expr-cloze'];
  
  // 1. íƒ€ì´í•‘/ë°›ì•„ì“°ê¸°(ì‚°ì¶œ ì—°ìŠµ)ì—ì„œ ì„±ê³µ â†’ í•´ì œ
  if(outputModes.includes(mode)) {
    if(isCorrect) {
      item.productionSuccessCount = (item.productionSuccessCount || 0) + 1;
      // 2íšŒ ì—°ì† ì„±ê³µ ì‹œ í•´ì œ
      if(item.productionSuccessCount >= 2 && item.needsProduction) {
        item.needsProduction = false;
        item.productionSuccessCount = 0;
        return { shouldToast: true, message: 'âœ… ì‚°ì¶œ ì—°ìŠµ ì™„ë£Œ!' };
      }
    } else {
      // ì‹¤íŒ¨ ì‹œ ì¹´ìš´íŠ¸ ë¦¬ì…‹ (needsProduction ìœ ì§€)
      item.productionSuccessCount = 0;
    }
    return { shouldToast: false };
  }
  
  // 2. í”Œë˜ì‹œì¹´ë“œëŠ” ìˆœìˆ˜ ì¸í’‹ - ì‚°ì¶œ ì—°ìŠµ ì§„ì… ì•ˆ í•¨
  if(flashcardModes.includes(mode)) {
    // ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ (í‹€ë ¤ë„ ì‚°ì¶œ ì—°ìŠµ ì•ˆ ê°)
    return { shouldToast: false };
  }
  
  // 3. ì¸í’‹ ëª¨ë“œ(í€´ì¦ˆ, ë¹ˆì¹¸ ë“±)ì—ì„œ ì •ë‹µ
  if(inputModes.includes(mode) || !outputModes.includes(mode)) {
    if(isCorrect && !item.needsProduction) {
      item.consecutiveCorrect = (item.consecutiveCorrect || 0) + 1;
      // ì¡°ê±´: 3ì—°ì† ì •ë‹µ + interval 7ì¼ ì´ìƒ (ì¶©ë¶„íˆ ê¸°ì–µí•œ ê²ƒ)
      const intervalOK = (item.interval || 0) >= 7;
      if(item.consecutiveCorrect >= 3 && intervalOK) {
        item.needsProduction = true;
        item.consecutiveCorrect = 0;
        return { shouldToast: true, message: 'ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì— ì¶”ê°€ë¨' };
      }
    } else if(!isCorrect) {
      // ì˜¤ë‹µ ì‹œ ì—°ì† ì •ë‹µ ë¦¬ì…‹ (ì‚°ì¶œ ì—°ìŠµ ì•ˆ ê°!)
      item.consecutiveCorrect = 0;
    }
  }
  
  return { shouldToast: false };
}

// ì·¨ì•½ë„ ì ìˆ˜ (ë‚®ì„ìˆ˜ë¡ ì·¨ì•½)
function getWeaknessScore(i){
const acc=getAcc(i)??50;
const stability=i?.stability||5;
const consWrong=i?.consecutiveWrong||0;
const daysSinceWrong=i?.lastWrongDate?(Date.now()-new Date(i.lastWrongDate))/(1000*60*60*24):30;
return(acc*0.4)+(Math.min(stability,30)*0.3)+(Math.max(0,10-consWrong*3)*0.2)+(Math.min(daysSinceWrong,30)*0.1);
}
// 3. FSRS ìš°ì„ ìˆœìœ„ ì •ë ¬
function sortByFSRSPriority(words,now){
return words.sort((a,b)=>{
const getState=w=>{
if(!w.reviewCount)return'NEW';
if(!w.nextReview)return'UNKNOWN';
return new Date(w.nextReview)<=now?'DUE':'FUTURE';
};
const stateA=getState(a),stateB=getState(b);
const priority={DUE:0,NEW:1,UNKNOWN:2,FUTURE:3};
if(priority[stateA]!==priority[stateB])return priority[stateA]-priority[stateB];
if(stateA==='DUE'){
// â˜… ìˆ˜ì •: ê¸´ê¸‰ë„ = overdueì¼ìˆ˜ / stability (ë†’ì„ìˆ˜ë¡ ê¸‰í•¨)
// ì—°êµ¬ ê·¼ê±°: stabilityê°€ ë‚®ì€ ë‹¨ì–´ëŠ” ê°™ì€ ì§€ì—°ì´ì–´ë„ ë” ë¹ ë¥´ê²Œ ë§ê°
const overA=(now-new Date(a.nextReview))/(1000*60*60*24);
const overB=(now-new Date(b.nextReview))/(1000*60*60*24);
const urgencyA=overA/(a.stability||1);
const urgencyB=overB/(b.stability||1);
return urgencyB-urgencyA; // ê¸´ê¸‰ë„ ë†’ì€ ìˆœ
}
if(stateA==='NEW')return(a.CEFR||'B1').localeCompare(b.CEFR||'B1'); // CEFR ì•ŒíŒŒë²³ìˆœ (A2<B1<B2<C1<C2)
return 0;
});
}
// ì‚¬ì „ ì •ì˜ íƒœê·¸ (ë¹ ë¥¸ íƒœê·¸ ì¶”ê°€ìš©)
const PRESET_TAGS=['ì‹œí—˜ì „','ì•”ê¸°í•„ìˆ˜','ì–´ë ¤ì›€','ë³µìŠµí•„ìš”','ì¤‘ìš”','TOEFL','TOEIC','ë¹„ì¦ˆë‹ˆìŠ¤'];
// ë™ì  í•„í„° ì—…ë°ì´íŠ¸ (TOEFL, COCA, íƒœê·¸)
function updateHomeTagSelects(words,pvs,exprs){
// ì–´íœ˜ í™ˆ íƒœê·¸ ë“œë¡­ë‹¤ìš´
const vocabTags=new Set();
words.forEach(w=>(w.tags||[]).forEach(t=>vocabTags.add(t)));
const homeTagSelect=document.getElementById('home-tag-select');
if(homeTagSelect){
homeTagSelect.innerHTML='<option value="">ğŸ·ï¸ íƒœê·¸ ì„ íƒ...</option>';
[...vocabTags].sort().forEach(t=>{
const count=words.filter(w=>(w.tags||[]).includes(t)).length;
homeTagSelect.innerHTML+=`<option value="${t}">${t} (${count})</option>`;
});
}
// êµ¬ë™ì‚¬ í™ˆ íƒœê·¸ ë“œë¡­ë‹¤ìš´
const pvTags=new Set();
pvs.forEach(p=>(p.tags||[]).forEach(t=>pvTags.add(t)));
const homePvTagSelect=document.getElementById('home-pv-tag-select');
if(homePvTagSelect){
homePvTagSelect.innerHTML='<option value="">ğŸ·ï¸ íƒœê·¸ ì„ íƒ...</option>';
[...pvTags].sort().forEach(t=>{
const count=pvs.filter(p=>(p.tags||[]).includes(t)).length;
homePvTagSelect.innerHTML+=`<option value="${t}">${t} (${count})</option>`;
});
}
// í‘œí˜„ í™ˆ íƒœê·¸ ë“œë¡­ë‹¤ìš´
const exprTags=new Set();
(exprs||[]).forEach(e=>(e.tags||[]).forEach(t=>exprTags.add(t)));
const homeExprTagSelect=document.getElementById('home-expr-tag-select');
if(homeExprTagSelect){
homeExprTagSelect.innerHTML='<option value="">ğŸ·ï¸ íƒœê·¸ ì„ íƒ...</option>';
[...exprTags].sort().forEach(t=>{
const count=(exprs||[]).filter(e=>(e.tags||[]).includes(t)).length;
homeExprTagSelect.innerHTML+=`<option value="${t}">${t} (${count})</option>`;
});
}
}
function updateTagFilters(words,pvs,exprs){
// TOEFL ì—°ê´€ì„± í•„í„° ë™ì  ì—…ë°ì´íŠ¸
const toeflSet=new Set();
words.forEach(w=>{if(w.TOEFL_Rel)toeflSet.add(w.TOEFL_Rel);});
const toeflSelect=document.getElementById('filter-toefl');
if(toeflSelect&&toeflSet.size>0){
const current=toeflSelect.value;
toeflSelect.innerHTML='<option value="all">ì „ì²´</option>';
[...toeflSet].sort().forEach(t=>{
const count=words.filter(w=>w.TOEFL_Rel===t).length;
toeflSelect.innerHTML+=`<option value="${t}">${t} (${count})</option>`;
});
toeflSelect.value=current;
}
// COCA ì¥ë¥´ í•„í„° ë™ì  ì—…ë°ì´íŠ¸
const cocaSet=new Set();
words.forEach(w=>{if(w.COCA_Genre)(w.COCA_Genre.split(/[,_\s]+/)).forEach(g=>{if(g.trim())cocaSet.add(g.trim());});});
const cocaSelect=document.getElementById('filter-coca');
if(cocaSelect&&cocaSet.size>0){
const current=cocaSelect.value;
cocaSelect.innerHTML='<option value="all">ì „ì²´</option>';
[...cocaSet].sort().forEach(g=>{
const count=words.filter(w=>(w.COCA_Genre||'').includes(g)).length;
cocaSelect.innerHTML+=`<option value="${g}">${g} (${count})</option>`;
});
cocaSelect.value=current;
}
// ì–´íœ˜ íƒœê·¸ í•„í„° ë™ì  ì—…ë°ì´íŠ¸ (chip-multi)
const vocabTags=new Set();
words.forEach(w=>(w.tags||[]).forEach(t=>vocabTags.add(t)));
const tagContainer=document.getElementById('filter-tag');
if(tagContainer){
const tagsArr=[...vocabTags].sort();
tagContainer.innerHTML='<span class="chip checked" data-value="all">ì „ì²´</span>'+
tagsArr.map(t=>`<span class="chip" data-value="${t}">${t}</span>`).join('');
initChipMultiEvents(tagContainer);
}
// êµ¬ë™ì‚¬ íƒœê·¸ í•„í„° (chip-multi)
const pvTagContainer=document.getElementById('pv-filter-tag');
if(pvTagContainer&&pvs){
const pvTags=new Set();
pvs.forEach(p=>(p.tags||[]).forEach(t=>pvTags.add(t)));
const tagsArr=[...pvTags].sort();
pvTagContainer.innerHTML='<span class="chip checked" data-value="all">ì „ì²´</span>'+
tagsArr.map(t=>`<span class="chip" data-value="${t}">${t}</span>`).join('');
initChipMultiEvents(pvTagContainer);
}
// í‘œí˜„ íƒœê·¸ í•„í„° (chip-multi)
const exprTagContainer=document.getElementById('expr-filter-tag');
if(exprTagContainer&&exprs){
const exprTags=new Set();
exprs.forEach(e=>(e.tags||[]).forEach(t=>exprTags.add(t)));
const tagsArr=[...exprTags].sort();
exprTagContainer.innerHTML='<span class="chip checked" data-value="all">ì „ì²´</span>'+
tagsArr.map(t=>`<span class="chip" data-value="${t}">${t}</span>`).join('');
initChipMultiEvents(exprTagContainer);
}
}
// â˜… ì˜¤ë‹µë…¸íŠ¸ ì—…ë°ì´íŠ¸ (ì–´íœ˜/êµ¬ë™ì‚¬/í‘œí˜„ ê³µí†µ)
// ëª¨ë“  íƒ€ì…ì—ì„œ ë™ì¼í•œ ì˜¤ë‹µ ì¶”ì  ë¡œì§ ì‚¬ìš© (íƒ€ì…ë³„ ë¶„ë¦¬ ë¶ˆí•„ìš” - í†µê³„ëŠ” ê° ì•„ì´í…œì— ì €ì¥ë¨)
function updateWrong(i,ok){
  if(ok){
    i.consecutiveWrong=0;
  }else{
    i.consecutiveWrong=(i.consecutiveWrong||0)+1;
    i.wrongCount=(i.wrongCount||0)+1;
    i.lastWrongDate=new Date().toISOString();
  }
}
// â˜… ì¸í’‹/ì•„ì›ƒí’‹ë³„ ì •ë‹µë¥  ì¶”ì 
function updateInputOutput(item,isOutput,isCorrect){
  if(isOutput){
    item.outputReviewCount=(item.outputReviewCount||0)+1;
    if(isCorrect)item.outputCorrectCount=(item.outputCorrectCount||0)+1;
  }else{
    item.inputReviewCount=(item.inputReviewCount||0)+1;
    if(isCorrect)item.inputCorrectCount=(item.inputCorrectCount||0)+1;
  }
}
function getInputAcc(item){const r=item.inputReviewCount||0;return r?Math.round(((item.inputCorrectCount||0)/r)*100):null;}
function getOutputAcc(item){const r=item.outputReviewCount||0;return r?Math.round(((item.outputCorrectCount||0)/r)*100):null;}
// 6. Mastery ê³„ì‚° ê°œì„  (FSRS stability + ì •í™•ë„ ê¸°ë°˜)
function updateMastery(item,wasCorrect){
// â˜… ìˆ˜ì •: FSRS stabilityì™€ ì •í™•ë„ë¥¼ í•¨ê»˜ ê³ ë ¤
// ì—°êµ¬ ê·¼ê±°: ì¥ê¸°ê¸°ì–µ ê°•ë„ëŠ” ë§ê°ê³¡ì„ (stability)ê³¼ ì¸ì¶œ ì„±ê³µë¥ ì˜ ì¡°í•©

// 1. ì •í™•ë„ ì—…ë°ì´íŠ¸ (ì§€ìˆ˜ì´ë™í‰ê· )
const alpha=0.3;
const currentScore=wasCorrect?100:0;
const prevAccMastery=item.accMastery||50;
item.accMastery=Math.round(alpha*currentScore+(1-alpha)*prevAccMastery);

// 2. Stability ê¸°ë°˜ ì ìˆ˜ (0-100)
// stability 1ì¼â†’20%, 7ì¼â†’50%, 30ì¼â†’80%, 90ì¼â†’95%
const stability=item.stability||1;
const stabilityScore=Math.min(100,Math.round(100*(1-Math.exp(-stability/30))));

// 3. ìµœì¢… Mastery = stability(60%) + ì •í™•ë„(40%)
// ì´ìœ : ì¥ê¸°ê¸°ì–µì€ ë§ê°ê³¡ì„ ì´ ë” ì¤‘ìš”, ë‹¨ê¸° ì •í™•ë„ëŠ” ë³´ì¡° ì§€í‘œ
item.mastery=Math.round(stabilityScore*0.6+item.accMastery*0.4);
}
function shuffle(a){const arr=[...a];for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}
function vibrate(p=10){if(document.getElementById('setting-vibrate')?.checked&&navigator.vibrate)navigator.vibrate(p);}
function speakWord(t){
const w=displayWord(t||getW(fcState?.words?.[fcState.idx]));
if(!w||!('speechSynthesis'in window))return;
// iOS Safari ë²„ê·¸: cancel() í›„ ë°”ë¡œ speak()í•˜ë©´ ë¬´ìŒ
speechSynthesis.cancel();
// iOSìš© ë”œë ˆì´ ì¶”ê°€
setTimeout(()=>{
const u=new SpeechSynthesisUtterance(w);
u.lang='en-US';
u.rate=0.9;
speechSynthesis.speak(u);
},50);
}
let toastTimer=null;
function showToast(m){const t=document.getElementById('toast');if(!t)return;t.textContent=m;t.classList.add('show');if(toastTimer)clearTimeout(toastTimer);toastTimer=setTimeout(()=>{t.classList.remove('show');toastTimer=null;},2500);}
function showModal(id){document.getElementById(id)?.classList.add('show');}
function closeModal(id){document.getElementById(id)?.classList.remove('show');}
// â˜… ëª¨ë‹¬ ì™¸ë¶€(ì˜¤ë²„ë ˆì´) í´ë¦­ ì‹œ ë‹«ê¸°
document.querySelectorAll('.modal-overlay').forEach(overlay=>{
  overlay.addEventListener('click',e=>{
    // confirm ëª¨ë‹¬ì€ ì œì™¸ (ì¤‘ìš”í•œ í™•ì¸ í•„ìš”)
    if(overlay.id==='confirm-modal')return;
    // í´ë¦­ì´ ì˜¤ë²„ë ˆì´ ìì²´ì—ì„œ ë°œìƒí–ˆì„ ë•Œë§Œ ë‹«ê¸° (ëª¨ë‹¬ ë‚´ë¶€ í´ë¦­ì€ ë¬´ì‹œ)
    if(e.target===overlay)closeModal(overlay.id);
  });
});
function showConfirm(title,msg,fn){const titleEl=document.getElementById('confirm-title');const msgEl=document.getElementById('confirm-msg');const btnEl=document.getElementById('confirm-btn');if(titleEl)titleEl.textContent=title;if(msgEl)msgEl.textContent=msg;if(btnEl)btnEl.onclick=()=>{closeModal('confirm-modal');fn();};showModal('confirm-modal');}
function getChip(id){return document.querySelector('#'+id+' .chip.active')?.dataset.value||'all';}
// â˜… ë‹¤ì¤‘ ì„ íƒ í•„í„° í•¨ìˆ˜ë“¤
function getMultiChip(id){
  const container=document.getElementById(id);
  if(!container)return {include:['all'],exclude:[]};
  const chips=container.querySelectorAll('.chip');
  const include=[],exclude=[];
  chips.forEach(c=>{
    const v=c.dataset.value;
    if(c.classList.contains('checked'))include.push(v);
    if(c.classList.contains('excluded'))exclude.push(v);
  });
  // â˜… UI ìƒíƒœ ê·¸ëŒ€ë¡œ ë°˜í™˜ (í•„í„° ì ìš© ì‹œ checkMultiFilterì—ì„œ ì²˜ë¦¬)
  return {include,exclude};
}
// getMultiFilterValueëŠ” getMultiChipì˜ ë³„ì¹­
const getMultiFilterValue=getMultiChip;
function getFilterValue(id){
  const sel=document.getElementById(id);
  const mode=document.querySelector(`.filter-mode[data-for="${id}"]`);
  const val=sel?.value||'all';
  const isExclude=mode?.classList.contains('exclude');
  return {value:val,exclude:isExclude};
}
function toggleFilterMode(el){
  el.classList.toggle('exclude');
  el.textContent=el.classList.contains('exclude')?'âˆ’':'+';
}
function resetFilters(type){
  const prefix=type==='vocab'?'filter':type==='phrasal'?'pv-filter':'expr-filter';
  // chip-multi ì´ˆê¸°í™” (í•™ìŠµìƒíƒœ, CEFR, ë¹ˆë„, ìš°ì„ ìˆœìœ„, Formality, Currency, Medium, íƒœê·¸)
  const chipGroups=type==='vocab'?['mastery','cefr','freq','priority','formality','currency','medium','tag']:
                   type==='phrasal'?['mastery','cefr','priority','formality','currency','medium','tag']:
                   ['mastery','cefr','priority','formality','currency','medium','tag'];
  chipGroups.forEach(g=>{
    const container=document.getElementById(prefix+'-'+g);
    if(container){
      container.querySelectorAll('.chip').forEach(c=>{
        c.classList.remove('checked','excluded');
        if(c.dataset.value==='all')c.classList.add('checked');
      });
    }
  });
  // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì´ˆê¸°í™” (ì¹´í…Œê³ ë¦¬ ë“± ë™ì  í•„í„°)
  const selects=type==='vocab'?['l1','toefl','coca']:
                type==='phrasal'?['cat']:[];
  selects.forEach(s=>{
    const sel=document.getElementById(prefix+'-'+s);
    if(sel)sel.value='all';
  });
  // â˜… localStorageì—ì„œë„ ì‚­ì œ
  localStorage.removeItem('filter_'+type);
  showToast('ğŸ”„ í•„í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
}
function saveFilters(type){
  try{
    const prefix=type==='vocab'?'filter':type==='phrasal'?'pv-filter':'expr-filter';
    const data={};
    // chip-multi ì €ì¥ (íƒœê·¸ í¬í•¨)
    const chipGroups=type==='vocab'?['mastery','cefr','freq','priority','formality','currency','medium','tag']:
                     type==='phrasal'?['mastery','cefr','priority','formality','currency','medium','tag']:
                     ['mastery','cefr','priority','formality','currency','medium','tag'];
    chipGroups.forEach(g=>{
      data[g]=getMultiChip(prefix+'-'+g);
    });
    // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì €ì¥
    const selects=type==='vocab'?['l1','toefl','coca']:
                  type==='phrasal'?['cat']:[];
    selects.forEach(s=>{
      const sel=document.getElementById(prefix+'-'+s);
      if(sel)data[s]=sel.value;
    });
    localStorage.setItem('filter_'+type,JSON.stringify(data));
    showToast('ğŸ’¾ í•„í„° ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
  }catch(e){
    console.error('saveFilters error:',e);
    showToast('âŒ ì €ì¥ ì‹¤íŒ¨: '+e.message);
  }
}
function loadFilters(type){
  const saved=localStorage.getItem('filter_'+type);
  if(!saved)return;
  try{
    const data=JSON.parse(saved);
    const prefix=type==='vocab'?'filter':type==='phrasal'?'pv-filter':'expr-filter';
    // chip-multi ë³µì› (íƒœê·¸ í¬í•¨)
    const chipGroups=type==='vocab'?['mastery','cefr','freq','priority','formality','currency','medium','tag']:
                     type==='phrasal'?['mastery','cefr','priority','formality','currency','medium','tag']:
                     ['mastery','cefr','priority','formality','currency','medium','tag'];
    chipGroups.forEach(g=>{
      const container=document.getElementById(prefix+'-'+g);
      if(!container)return;
      // ë¨¼ì € ëª¨ë“  chip ì´ˆê¸°í™”
      container.querySelectorAll('.chip').forEach(c=>{
        c.classList.remove('checked','excluded');
      });
      // ì €ì¥ëœ ì„¤ì • ì ìš©
      if(data[g]){
        const {include,exclude}=data[g];
        const hasExclude = exclude && exclude.length > 0;
        const hasInclude = include && include.length > 0;
        
        // include ì ìš©
        if(hasInclude){
          include.forEach(v=>{
            const c=container.querySelector(`.chip[data-value="${v}"]`);
            if(c)c.classList.add('checked');
          });
        }
        // exclude ì ìš©
        if(hasExclude){
          exclude.forEach(v=>{
            const c=container.querySelector(`.chip[data-value="${v}"]`);
            if(c)c.classList.add('excluded');
          });
        }
        // â˜… ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆë˜ì–´ ìˆìœ¼ë©´ 'all' ì„ íƒ
        // excludeë§Œ ìˆìœ¼ë©´ getMultiChipì—ì„œ ìë™ìœ¼ë¡œ 'all'ì„ includeì— ì¶”ê°€í•˜ë¯€ë¡œ UIì—ëŠ” allì„ ì„ íƒí•˜ì§€ ì•ŠìŒ
        if(!hasInclude && !hasExclude){
          const allChip=container.querySelector('.chip[data-value="all"]');
          if(allChip)allChip.classList.add('checked');
        }
      }else{
        // ë°ì´í„° ì—†ìœ¼ë©´ 'all' ì„ íƒ
        const allChip=container.querySelector('.chip[data-value="all"]');
        if(allChip)allChip.classList.add('checked');
      }
    });
    // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë³µì›
    const selects=type==='vocab'?['l1','toefl','coca']:
                  type==='phrasal'?['cat']:[];
    selects.forEach(s=>{
      if(data[s]){
        const sel=document.getElementById(prefix+'-'+s);
        if(sel)sel.value=data[s];
      }
    });
  }catch(e){console.error('loadFilters error:',e);}
}
// í•„í„° ì¡°ê±´ ì²´í¬ í—¬í¼
function checkMasteryFilter(item,mastery){
  const {include,exclude}=mastery;
  // includeê°€ ë¹„ì–´ìˆê±°ë‚˜ 'all'ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì œì™¸ ì¡°ê±´ë§Œ ì²´í¬
  if(include.length===0 || include.includes('all')){
    // ì œì™¸ ì¡°ê±´ ì²´í¬
    for(const ex of exclude){
      if(ex==='new'&&(!item.reviewCount||item.reviewCount===0))return false;
      if(ex==='weak'&&isWeak(item))return false;
      if(ex==='wrong'&&isWrong(item))return false;
      if(ex==='starred'&&item.starred)return false;
      if(ex==='leech'&&item.isLeech)return false;
    }
    return true;
  }
  // í¬í•¨ ì¡°ê±´ ì²´í¬ (OR ì—°ì‚°)
  let pass=false;
  for(const inc of include){
    if(inc==='new'&&(!item.reviewCount||item.reviewCount===0)){pass=true;break;}
    if(inc==='weak'&&isWeak(item)){pass=true;break;}
    if(inc==='wrong'&&isWrong(item)){pass=true;break;}
    if(inc==='starred'&&item.starred){pass=true;break;}
    if(inc==='leech'&&item.isLeech){pass=true;break;}
  }
  if(!pass)return false;
  // ì œì™¸ ì¡°ê±´ ì²´í¬
  for(const ex of exclude){
    if(ex==='new'&&(!item.reviewCount||item.reviewCount===0))return false;
    if(ex==='weak'&&isWeak(item))return false;
    if(ex==='wrong'&&isWrong(item))return false;
    if(ex==='starred'&&item.starred)return false;
    if(ex==='leech'&&item.isLeech)return false;
  }
  return true;
}
function checkSelectFilter(itemValue,filter){
  if(filter.value==='all')return true;
  if(filter.exclude)return itemValue!==filter.value;
  return itemValue===filter.value;
}
// â˜… ë‹¤ì¤‘ ì„ íƒ í•„í„° ì²´í¬ (chip-multiìš©)
function checkMultiFilter(itemValue,multiChip){
  const {include,exclude}=multiChip;
  // includeê°€ ë¹„ì–´ìˆê±°ë‚˜ 'all'ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ëª¨ë“  ê²ƒ í†µê³¼ (excludeë§Œ ì²´í¬)
  if(include.length===0 || include.includes('all')){
    return !exclude.includes(itemValue);
  }
  // í¬í•¨ ì¡°ê±´ ì²´í¬ (OR ì—°ì‚°) - í•˜ë‚˜ë¼ë„ ë§¤ì¹˜í•˜ë©´ í†µê³¼
  if(!include.includes(itemValue))return false;
  // ì œì™¸ ì¡°ê±´ ì²´í¬
  if(exclude.includes(itemValue))return false;
  return true;
}
// â˜… íƒœê·¸ í•„í„° ì²´í¬ (ë°°ì—´ vs chip-multi)
function checkTagFilter(itemTags,multiChip){
  const {include,exclude}=multiChip;
  // ì œì™¸ ì²´í¬: ì•„ì´í…œ íƒœê·¸ ì¤‘ í•˜ë‚˜ë¼ë„ ì œì™¸ ëª©ë¡ì— ìˆìœ¼ë©´ ì œì™¸
  if(exclude.length>0 && itemTags.some(t=>exclude.includes(t)))return false;
  // í¬í•¨ì´ ë¹„ì–´ìˆê±°ë‚˜ 'all'ì´ë©´ í†µê³¼
  if(include.length===0 || include.includes('all'))return true;
  // í¬í•¨ ì²´í¬: ì•„ì´í…œ íƒœê·¸ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ ëª©ë¡ì— ìˆì–´ì•¼ í†µê³¼
  return itemTags.some(t=>include.includes(t));
}
function getDistractors(correct,pool,n=4){
console.log('[getDistractors] pool size:',pool.length,'correct POS:',correct.POS);
if(pool.length===0)return [];
if(pool.length<=n)return shuffle([...pool]);

const correctMeaning=(getMKO(correct)||'').toLowerCase();
const correctWord=displayWord(getW(correct)).toLowerCase();
const correctPOS=(correct.POS||'').toLowerCase();

// 1ë‹¨ê³„: ìœ íš¨í•œ ì„ íƒì§€ í•„í„°ë§
const valid=pool.filter(w=>{
if(getW(w)===getW(correct))return false;
const displayW=displayWord(getW(w)).toLowerCase();
if(displayW===correctWord)return false;
const meaning=(getMKO(w)||'').toLowerCase();
if(!meaning||meaning===correctMeaning)return false;
if(meaning.length>2&&correctMeaning.length>2){
if(meaning.includes(correctMeaning)||correctMeaning.includes(meaning))return false;
}
return true;
});

if(valid.length===0)return shuffle([...pool]).slice(0,n);

// 2ë‹¨ê³„: â˜… ê°™ì€ í’ˆì‚¬ë§Œ ì„ íƒ (VOS í†µì¼)
const samePOS=valid.filter(w=>(w.POS||'').toLowerCase()===correctPOS);
console.log('[getDistractors] samePOS only:',samePOS.length);

// ê°™ì€ í’ˆì‚¬ê°€ ì¶©ë¶„í•˜ë©´ ê·¸ ì¤‘ì—ì„œë§Œ ì„ íƒ
if(samePOS.length>=n){
  const scoredSamePOS=samePOS.map(w=>{
    let score=0;
    if(w.CEFR&&correct.CEFR&&w.CEFR===correct.CEFR)score+=4;
    if(w.L1&&correct.L1&&w.L1===correct.L1)score+=3;
    if(w.Priority&&correct.Priority&&w.Priority===correct.Priority)score+=2;
    const lenDiff=Math.abs(displayWord(getW(w)).length-correctWord.length);
    if(lenDiff<=2)score+=1;
    return{w,score};
  }).sort((a,b)=>b.score-a.score);
  
  return shuffle(scoredSamePOS.slice(0,Math.min(8,scoredSamePOS.length))).slice(0,n).map(x=>x.w);
}

// ê°™ì€ í’ˆì‚¬ê°€ ë¶€ì¡±í•˜ë©´ ìˆëŠ” ë§Œí¼ + ë‹¤ë¥¸ í’ˆì‚¬ë¡œ ì±„ì›€
const diffPOS=valid.filter(w=>(w.POS||'').toLowerCase()!==correctPOS);
let selected=[...shuffle(samePOS)];
if(selected.length<n&&diffPOS.length>0){
  selected.push(...shuffle(diffPOS).slice(0,n-selected.length));
}

console.log('[getDistractors] final selected:',selected.length);
return shuffle(selected).slice(0,n);
}

// â˜… êµ¬ë™ì‚¬ìš© ì„ íƒì§€ ìƒì„±
function getPVDistractors(correct,pool,n=4){
if(pool.length<n)return shuffle(pool).slice(0,n);
const correctMeaning=(getMKO(correct)||'').toLowerCase();
const scored=pool
.filter(p=>{
if(p.Phrasal_Verb===correct.Phrasal_Verb)return false;
const meaning=(getMKO(p)||'').toLowerCase();
if(!meaning||meaning===correctMeaning)return false;
if(meaning.length>2&&correctMeaning.length>2){
if(meaning.includes(correctMeaning)||correctMeaning.includes(meaning))return false;
}
return true;
})
.map(p=>{
let score=0;
// ê°™ì€ ë™ì‚¬ (get up vs get out - í—·ê°ˆë¦¼)
const cVerb=(correct.Phrasal_Verb||'').split(' ')[0].toLowerCase();
const pVerb=(p.Phrasal_Verb||'').split(' ')[0].toLowerCase();
if(cVerb&&pVerb&&cVerb===pVerb)score+=8;
// ê°™ì€ ì „ì¹˜ì‚¬/ë¶€ì‚¬
if(p.Particle&&correct.Particle&&p.Particle===correct.Particle)score+=6;
// ê°™ì€ ì¹´í…Œê³ ë¦¬
if(p.Category&&correct.Category&&p.Category===correct.Category)score+=5;
// ê°™ì€ CEFR
if(p.CEFR&&correct.CEFR&&p.CEFR===correct.CEFR)score+=4;
// ê°™ì€ Formality
if(p.Formality&&correct.Formality&&p.Formality===correct.Formality)score+=3;
return{word:p,score};
});
if(scored.length<n)return shuffle(scored).slice(0,n).map(x=>x.word);
scored.sort((a,b)=>b.score-a.score);
const cutoff=Math.floor(scored.length*0.75);
return shuffle([...shuffle(scored.slice(0,cutoff)).slice(0,n-1),...shuffle(scored.slice(cutoff)).slice(0,1)]).slice(0,n).map(x=>x.word);
}

// â˜… í‘œí˜„ìš© ì„ íƒì§€ ìƒì„±
function getExprDistractors(correct,pool,n=4){
if(pool.length<n)return shuffle(pool).slice(0,n);
const correctMeaning=(getMKO(correct)||'').toLowerCase();
const scored=pool
.filter(e=>{
if(e.Expression===correct.Expression)return false;
const meaning=(getMKO(e)||'').toLowerCase();
if(!meaning||meaning===correctMeaning)return false;
if(meaning.length>2&&correctMeaning.length>2){
if(meaning.includes(correctMeaning)||correctMeaning.includes(meaning))return false;
}
return true;
})
.map(e=>{
let score=0;
// ê°™ì€ Function (ìƒí™©/ìš©ë„)
if(e.Function&&correct.Function&&e.Function===correct.Function)score+=6;
// ê°™ì€ Formality
if(e.Formality&&correct.Formality&&e.Formality===correct.Formality)score+=5;
// ê°™ì€ CEFR
if(e.CEFR&&correct.CEFR&&e.CEFR===correct.CEFR)score+=4;
// ë¹„ìŠ·í•œ ë‹¨ì–´ ìˆ˜
const cLen=correct.Expression.split(' ').length;
const eLen=e.Expression.split(' ').length;
if(Math.abs(cLen-eLen)<=1)score+=3;
// ì²« ë‹¨ì–´ ê°™ìŒ
const cFirst=correct.Expression.split(' ')[0].toLowerCase();
const eFirst=e.Expression.split(' ')[0].toLowerCase();
if(cFirst===eFirst)score+=2;
return{word:e,score};
});
if(scored.length<n)return shuffle(scored).slice(0,n).map(x=>x.word);
scored.sort((a,b)=>b.score-a.score);
const cutoff=Math.floor(scored.length*0.75);
return shuffle([...shuffle(scored.slice(0,cutoff)).slice(0,n-1),...shuffle(scored.slice(cutoff)).slice(0,1)]).slice(0,n).map(x=>x.word);
}

// === UI ì „í™˜ ===
function switchHomeType(t){currentHomeType=t;document.querySelectorAll('#page-home .type-tab').forEach(e=>e.classList.toggle('active',e.dataset.type===t));document.getElementById('home-vocab')?.classList.toggle('hidden',t!=='vocab');document.getElementById('home-phrasal')?.classList.toggle('hidden',t!=='phrasal');document.getElementById('home-expr')?.classList.toggle('hidden',t!=='expr');}
function switchStudyType(t){currentStudyType=t;document.querySelectorAll('#study-type-tabs .type-tab').forEach(e=>e.classList.toggle('active',e.dataset.type===t));document.getElementById('study-vocab')?.classList.toggle('hidden',t!=='vocab');document.getElementById('study-phrasal')?.classList.toggle('hidden',t!=='phrasal');document.getElementById('study-expr')?.classList.toggle('hidden',t!=='expr');}
function switchStatsType(t){document.querySelectorAll('#page-stats .type-tab').forEach(e=>e.classList.toggle('active',e.dataset.type===t));document.getElementById('stats-vocab')?.classList.toggle('hidden',t!=='vocab');document.getElementById('stats-phrasal')?.classList.toggle('hidden',t!=='phrasal');document.getElementById('stats-expr')?.classList.toggle('hidden',t!=='expr');if(t==='phrasal')updatePVStats();if(t==='expr')updateExprStats();}
function switchDataType(t){currentDataType=t;currentSearchQuery='';currentTagFilter='all';const wordSearch=document.getElementById('word-search');if(wordSearch)wordSearch.value='';const dataFilterSpecial=document.getElementById('data-filter-special');if(dataFilterSpecial)dataFilterSpecial.value='all';const dataFilterCefr=document.getElementById('data-filter-cefr');if(dataFilterCefr)dataFilterCefr.value='all';const dataFilterPriority=document.getElementById('data-filter-priority');if(dataFilterPriority)dataFilterPriority.value='all';const dataFilterL2=document.getElementById('data-filter-l2');if(dataFilterL2)dataFilterL2.value='all';const dataFilterFormality=document.getElementById('data-filter-formality');if(dataFilterFormality)dataFilterFormality.value='all';const dataFilterCurrency=document.getElementById('data-filter-currency');if(dataFilterCurrency)dataFilterCurrency.value='all';const dataFilterMedium=document.getElementById('data-filter-medium');if(dataFilterMedium)dataFilterMedium.value='all';const dataSort=document.getElementById('data-sort');if(dataSort)dataSort.value='alpha';document.querySelectorAll('#page-data .type-tab').forEach(e=>e.classList.toggle('active',e.dataset.type===t));const col1h=document.getElementById('col1-h');if(col1h)col1h.textContent=t==='phrasal'?'êµ¬ë™ì‚¬':t==='expr'?'í‘œí˜„':'ë‹¨ì–´';wordOffset=0;updateWordTable();switchDbTab(t==='phrasal'?'pv':t);}
// â˜… ì „ì—­ íƒ€ì… ì—°ë™ - ëª¨ë“  íƒ­ ë™ì‹œ ì „í™˜
function switchGlobalType(t){
switchHomeType(t);
switchStudyType(t);
switchStatsType(t);
switchDataType(t);
}
async function selectMode(el,t){
try{
const container=t==='phrasal'?'#study-phrasal':t==='expr'?'#study-expr':'#study-vocab';
document.querySelectorAll(container+' .mode-card').forEach(c=>c.classList.remove('active'));
el.classList.add('active');
// â˜… í•™ìŠµ ì¤‘ì´ë©´ í™•ì¸ í›„ ì§„í–‰
const mode=el.dataset.mode;
if(isOnStudyPage()){
  showConfirm('í•™ìŠµ ì¢…ë£Œ','í˜„ì¬ í•™ìŠµì„ ì¢…ë£Œí•˜ê³  ìƒˆ í•™ìŠµì„ ì‹œì‘í• ê¹Œìš”?\n(ì§„í–‰ ê¸°ë¡ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤)',async()=>{
    await forceEndCurrentStudy();
    skipStudyCheck=true;
    await doSelectMode(t,mode);
  });
}else{
  await doSelectMode(t,mode);
}
}catch(e){console.error('selectMode error:',e);showToast('âŒ ëª¨ë“œ ì„ íƒ ì˜¤ë¥˜');}
}
async function doSelectMode(t,mode){
try{
  if(t==='expr')await startExprStudyWithMode(mode);
  else if(t==='phrasal')await startPVStudyWithMode(mode);
  else await startVocabStudyWithMode(mode);
}catch(e){
  console.error('[selectMode] Error:',e);
  showToast('âŒ í•™ìŠµ ì‹œì‘ ì˜¤ë¥˜: '+e.message);
}
}
// â˜… ì–´íœ˜ ëª¨ë“œë³„ ì¦‰ì‹œ ì‹œì‘
async function startVocabStudyWithMode(mode){
const w=await getAllWords();if(!w.length){showToast('ğŸ“¤ ë¨¼ì € ì–´íœ˜ DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
// â˜… í•™ìŠµíƒ­ ìŠ¬ë¼ì´ë” ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ì„¤ì •ê°’
const count=parseInt(document.getElementById('study-count')?.value||localStorage.getItem('defaultCount')||'20');
const now=new Date();
// â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
// â˜… í•„í„° ì ìš© (ë‹¤ì¤‘ ì„ íƒ ë° ì œì™¸ ì§€ì›)
const masteryF=getMultiChip('filter-mastery');
const cefrF=getMultiChip('filter-cefr');
const freqF=getMultiChip('filter-freq');
const priorityF=getMultiChip('filter-priority');
const formalityF=getMultiChip('filter-formality');
const currencyF=getMultiChip('filter-currency');
const mediumF=getMultiChip('filter-medium');
// ë™ì  í•„í„° (select ìœ ì§€)
const l1Val=document.getElementById('filter-l1')?.value||'all';
const toeflVal=document.getElementById('filter-toefl')?.value||'all';
const cocaVal=document.getElementById('filter-coca')?.value||'all';
const tagF=getMultiFilterValue('filter-tag');
let filtered=w.filter(x=>{
  // í•™ìŠµ ìƒíƒœ í•„í„° (ë‹¤ì¤‘ ì„ íƒ)
  if(!checkMasteryFilter(x,masteryF))return false;
  // chip-multi í•„í„°ë“¤
  if(!checkMultiFilter(x.CEFR||'B1',cefrF))return false;
  if(!checkMultiFilter(x.Frequency||'K3',freqF))return false;
  if(!checkMultiFilter(x.Priority||'P2',priorityF))return false;
  if(!checkMultiFilter(x.Formality||'Neutral',formalityF))return false;
  if(!checkMultiFilter(x.Currency||'Current',currencyF))return false;
  if(!checkMultiFilter(x.Medium||'Both',mediumF))return false;
  // íƒœê·¸ í•„í„° (chip-multi) - ì•„ì´í…œì˜ íƒœê·¸ ì¤‘ í•˜ë‚˜ë¼ë„ ë§¤ì¹­ë˜ë©´ í†µê³¼
  if(!checkTagFilter(x.tags||[],tagF))return false;
  // ë™ì  ì…€ë ‰íŠ¸ í•„í„°
  if(l1Val!=='all'&&x.L1!==l1Val)return false;
  if(toeflVal!=='all'&&(x.TOEFL_Rel||'').toLowerCase()!==toeflVal.toLowerCase())return false;
  if(cocaVal!=='all'&&!(x.COCA_Genre||'').toLowerCase().includes(cocaVal.toLowerCase()))return false;
  return true;
});
if(!filtered.length){showToast('âš ï¸ í•„í„° ì¡°ê±´ì— ë§ëŠ” ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
// â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„  (ìˆœì„œ ìœ ì§€: DUE â†’ WEAK â†’ NEW)
const dueCount=Math.ceil(count*0.6),weakCount=Math.ceil(count*0.3),newCount=count-dueCount-weakCount;
const dueItems=sortByFSRSPriority(filtered.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
const weakItems=shuffle(filtered.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
const newItems=shuffle(filtered.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
// â˜… ìˆœì„œ ìœ ì§€ + ë¶€ì¡±í•˜ë©´ í•™ìŠµ ê°€ëŠ¥í•œ ë‹¨ì–´ë§Œ ì±„ìš°ê¸°
let sel=[...dueItems,...weakItems,...newItems];
if(sel.length<count){
  const usedWords=new Set(sel.map(x=>x.word));
  // â˜… í•µì‹¬: nextReviewê°€ ë¯¸ë˜ì¸ ë‹¨ì–´ ì œì™¸!
  const remaining=shuffle(filtered.filter(x=>!usedWords.has(x.word)&&isAvailable(x))).slice(0,count-sel.length);
  sel=[...sel,...remaining];
}
console.log('[VocabStudy] ì„ íƒ:',{due:dueItems.length,weak:weakItems.length,new:newItems.length,total:sel.length,availableInDB:filtered.filter(isAvailable).length});
if(!sel.length){showToast('âœ… ì˜¤ëŠ˜ í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}
if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
if(mode==='flashcard')startFC(sel,w,'vocab');
else if(mode==='quiz')startQuiz(sel,w,'quiz','vocab');
else if(mode==='reverse')startQuiz(sel,w,'reverse','vocab');
else if(mode==='typing')startTyping(sel.filter(x=>x.needsProduction||true));
else if(mode==='cloze')startCloze(sel,w);
else if(mode==='collocation')startColloc(sel,w);
else if(mode==='listening')startListening(sel,w,'vocab');
else if(mode==='dictation')startDictation(sel,w,'vocab');
else startFC(sel,w,'vocab');
}
// â˜… êµ¬ë™ì‚¬ ëª¨ë“œë³„ ì¦‰ì‹œ ì‹œì‘
async function startPVStudyWithMode(mode){
const p=await getAllPV();if(!p.length){showToast('ğŸ“¤ ë¨¼ì € êµ¬ë™ì‚¬ DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
// â˜… í•™ìŠµíƒ­ ìŠ¬ë¼ì´ë” ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ì„¤ì •ê°’
const count=parseInt(document.getElementById('pv-study-count')?.value||localStorage.getItem('defaultCount')||'20');
const now=new Date();
// â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
// â˜… í•„í„° ì ìš© (ë‹¤ì¤‘ ì„ íƒ ë° ì œì™¸ ì§€ì›)
const masteryF=getMultiChip('pv-filter-mastery');
const cefrF=getMultiChip('pv-filter-cefr');
const priorityF=getMultiChip('pv-filter-priority');
const formalityF=getMultiChip('pv-filter-formality');
const currencyF=getMultiChip('pv-filter-currency');
const mediumF=getMultiChip('pv-filter-medium');
const catVal=document.getElementById('pv-filter-cat')?.value||'all';
let filtered=p.filter(x=>{
  if(!checkMasteryFilter(x,masteryF))return false;
  if(!checkMultiFilter(x.CEFR||'B1',cefrF))return false;
  if(!checkMultiFilter(x.Priority||'P2',priorityF))return false;
  if(!checkMultiFilter(x.Formality||'Neutral',formalityF))return false;
  if(!checkMultiFilter(x.Currency||'Current',currencyF))return false;
  if(!checkMultiFilter(x.Medium||'Both',mediumF))return false;
  if(catVal!=='all'&&x.Category!==catVal)return false;
  return true;
});
if(!filtered.length){showToast('âš ï¸ í•„í„° ì¡°ê±´ì— ë§ëŠ” êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
// â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ 
const dueCount=Math.ceil(count*0.6),weakCount=Math.ceil(count*0.3),newCount=count-dueCount-weakCount;
const dueItems=sortByFSRSPriority(filtered.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
const weakItems=shuffle(filtered.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
const newItems=shuffle(filtered.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
// â˜… ìˆœì„œ ìœ ì§€ + ë¶€ì¡±í•˜ë©´ í•™ìŠµ ê°€ëŠ¥í•œ ë‹¨ì–´ë§Œ ì±„ìš°ê¸°
let sel=[...dueItems,...weakItems,...newItems];
if(sel.length<count){
  const usedPVs=new Set(sel.map(x=>x.Phrasal_Verb));
  // â˜… í•µì‹¬: nextReviewê°€ ë¯¸ë˜ì¸ ë‹¨ì–´ ì œì™¸!
  const remaining=shuffle(filtered.filter(x=>!usedPVs.has(x.Phrasal_Verb)&&isAvailable(x))).slice(0,count-sel.length);
  sel=[...sel,...remaining];
}
console.log('[PVStudy] ì„ íƒ:',{due:dueItems.length,weak:weakItems.length,new:newItems.length,total:sel.length,availableInDB:filtered.filter(isAvailable).length});
if(!sel.length){showToast('âœ… ì˜¤ëŠ˜ í•™ìŠµí•  êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}
if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
if(mode==='pv-flashcard')startFC(sel,p,'phrasal');
else if(mode==='pv-particle')startPVP(sel,p);
else if(mode==='pv-meaning')startPVQ(sel,p,'meaning');
else if(mode==='pv-reverse')startPVQ(sel,p,'reverse');
else if(mode==='pv-listening')startListening(sel,p,'phrasal');
else if(mode==='pv-dictation')startDictation(sel,p,'phrasal');
else startFC(sel,p,'phrasal');
}
// â˜… í‘œí˜„ ëª¨ë“œë³„ ì¦‰ì‹œ ì‹œì‘
async function startExprStudyWithMode(mode){
const e=await getAllExpr();if(!e.length){showToast('ğŸ“¤ ë¨¼ì € í‘œí˜„ DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
// â˜… í•™ìŠµíƒ­ ìŠ¬ë¼ì´ë” ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ì„¤ì •ê°’
const count=parseInt(document.getElementById('expr-study-count')?.value||localStorage.getItem('defaultCount')||'20');
const now=new Date();
// â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
// â˜… í•„í„° ì ìš© (ë‹¤ì¤‘ ì„ íƒ ë° ì œì™¸ ì§€ì›)
const masteryF=getMultiChip('expr-filter-mastery');
const cefrF=getMultiChip('expr-filter-cefr');
const priorityF=getMultiChip('expr-filter-priority');
const formalityF=getMultiChip('expr-filter-formality');
const currencyF=getMultiChip('expr-filter-currency');
const mediumF=getMultiChip('expr-filter-medium');
const tagF=getMultiFilterValue('expr-filter-tag');
let filtered=e.filter(x=>{
  if(!checkMasteryFilter(x,masteryF))return false;
  if(!checkMultiFilter(x.CEFR||'B1',cefrF))return false;
  if(!checkMultiFilter(x.Priority||'P2',priorityF))return false;
  if(!checkMultiFilter(x.Formality||'Neutral',formalityF))return false;
  if(!checkMultiFilter(x.Currency||'Current',currencyF))return false;
  if(!checkMultiFilter(x.Medium||'Both',mediumF))return false;
  if(!checkTagFilter(x.tags||[],tagF))return false;
  return true;
});
if(!filtered.length){showToast('âš ï¸ í•„í„° ì¡°ê±´ì— ë§ëŠ” í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
// â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ 
const dueCount=Math.ceil(count*0.6),weakCount=Math.ceil(count*0.3),newCount=count-dueCount-weakCount;
const dueItems=sortByFSRSPriority(filtered.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
const weakItems=shuffle(filtered.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
const newItems=shuffle(filtered.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
// â˜… ìˆœì„œ ìœ ì§€ + ë¶€ì¡±í•˜ë©´ í•™ìŠµ ê°€ëŠ¥í•œ ë‹¨ì–´ë§Œ ì±„ìš°ê¸°
let sel=[...dueItems,...weakItems,...newItems];
if(sel.length<count){
  const usedExprs=new Set(sel.map(x=>x.Expression));
  // â˜… í•µì‹¬: nextReviewê°€ ë¯¸ë˜ì¸ ë‹¨ì–´ ì œì™¸!
  const remaining=shuffle(filtered.filter(x=>!usedExprs.has(x.Expression)&&isAvailable(x))).slice(0,count-sel.length);
  sel=[...sel,...remaining];
}
console.log('[ExprStudy] ì„ íƒ:',{due:dueItems.length,weak:weakItems.length,new:newItems.length,total:sel.length,availableInDB:filtered.filter(isAvailable).length});
if(!sel.length){showToast('âœ… ì˜¤ëŠ˜ í•™ìŠµí•  í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
if(mode==='expr-fc')startExprFCWithItems(sel,e);
else if(mode==='expr-quiz')startExprQuiz(sel,e);
else if(mode==='expr-cloze')startExprClozeWithItems(sel,e);
else if(mode==='expr-typing')startExprTyping(sel,e);
else if(mode==='expr-listening')startListening(sel,e,'expr');
else if(mode==='expr-dictation')startDictation(sel,e,'expr');
else startExprFCWithItems(sel,e);
}
// â˜… í™ˆí™”ë©´ ë¹ ë¥¸ì‹œì‘ â†’ ê° ëª¨ë“œë³„ í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ (ì•ˆì •ì„±)
async function quickStartMode(type, mode){
  try{
    currentStudyType=type;
    // â˜… í•„í„° í† ê¸€ ìŠ¤ìœ„ì¹˜ í™•ì¸
    const filterEl = document.getElementById('quick-filter-'+type);
    const useFilter = filterEl?.classList.contains('active');
    
    if(useFilter){
      // â˜… ì €ì¥ëœ í•„í„° ë¡œë“œ í›„ í•™ìŠµíƒ­ì˜ í•„í„° ì ìš© ë¡œì§ ì‚¬ìš©
      loadFilters(type);
      if(type==='expr'){
        const exprMode = mode==='expr-fc'?'flashcard':mode==='expr-quiz'?'quiz':mode==='expr-cloze'?'cloze':'flashcard';
        await startExprStudyWithMode(exprMode);
      }else if(type==='phrasal'){
        const pvMode = mode==='pv-flashcard'?'flashcard':'particle';
        await startPVStudyWithMode(pvMode);
      }else{
        const vocabMode = mode==='quiz'?'quiz':'flashcard';
        await startVocabStudyWithMode(vocabMode);
      }
      return;
    }
    
    // â˜… í•„í„° ë¯¸ì ìš© - ê¸°ì¡´ ë¡œì§ (ì „ì²´ ë‹¨ì–´ ëŒ€ìƒ)
    if(type==='expr'){
      // í‘œí˜„: ê° ëª¨ë“œë³„ ì „ìš© í•¨ìˆ˜ í˜¸ì¶œ
      if(mode==='expr-fc') await startExprFC();
      else if(mode==='expr-quiz') await startExprQuizQuick();
      else if(mode==='expr-cloze') await startExprCloze();
      else await startExprFC();
    }else if(type==='phrasal'){
      // êµ¬ë™ì‚¬: ê° ëª¨ë“œë³„ ì „ìš© í•¨ìˆ˜ í˜¸ì¶œ
      if(mode==='pv-flashcard') await startQuickStudy('phrasal');
      else if(mode==='pv-particle') await startQuickQuiz('phrasal');
      else await startQuickStudy('phrasal');
    }else{
      // ì–´íœ˜: ê° ëª¨ë“œë³„ ì „ìš© í•¨ìˆ˜ í˜¸ì¶œ
      if(mode==='flashcard') await startQuickStudy('vocab');
      else if(mode==='quiz') await startQuickQuiz('vocab');
      else await startQuickStudy('vocab');
    }
  }catch(e){console.error('quickStartMode error:',e);showToast('âš ï¸ í•™ìŠµ ì‹œì‘ ì˜¤ë¥˜');}
}
document.querySelectorAll('.chip-group').forEach(g=>{g.addEventListener('click',e=>{if(e.target.classList.contains('chip')){g.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));e.target.classList.add('active');}});});
// â˜… ë‹¤ì¤‘ ì„ íƒ ì¹© ê·¸ë£¹ ì´ë²¤íŠ¸
// ë™ì ìœ¼ë¡œ ì¶”ê°€ëœ chip-multiì— ì´ë²¤íŠ¸ ì¬ë“±ë¡
function initChipMultiEvents(g){
  g.addEventListener('click',e=>{
    if(!e.target.classList.contains('chip'))return;
    const chip=e.target;
    const val=chip.dataset.value;
    const allChip=g.querySelector('.chip[data-value="all"]');
    if(val==='all'){
      g.querySelectorAll('.chip').forEach(c=>{c.classList.remove('checked','excluded');});
      chip.classList.add('checked');
      return;
    }
    if(allChip)allChip.classList.remove('checked','excluded');
    if(chip.classList.contains('excluded')){chip.classList.remove('excluded');}
    else if(chip.classList.contains('checked')){chip.classList.remove('checked');chip.classList.add('excluded');}
    else{chip.classList.add('checked');}
    const anySelected=g.querySelector('.chip.checked,.chip.excluded');
    if(!anySelected&&allChip)allChip.classList.add('checked');
  });
  g.addEventListener('dblclick',e=>{
    if(!e.target.classList.contains('chip'))return;
    const chip=e.target;
    if(chip.dataset.value==='all')return;
    const allChip=g.querySelector('.chip[data-value="all"]');
    if(allChip)allChip.classList.remove('checked','excluded');
    chip.classList.remove('checked');
    chip.classList.add('excluded');
  });
}
document.querySelectorAll('.chip-multi').forEach(g=>{
  // ì¶”ì²œ íƒœê·¸ëŠ” ë‹¨ìˆœ í† ê¸€ (add-suggested-tags, edit-suggested-tags)
  if(g.id&&g.id.includes('suggested-tags')){
    g.addEventListener('click',e=>{
      if(!e.target.classList.contains('chip'))return;
      e.target.classList.toggle('checked');
    });
    return;
  }
  g.addEventListener('click',e=>{
    if(!e.target.classList.contains('chip'))return;
    const chip=e.target;
    const val=chip.dataset.value;
    const allChip=g.querySelector('.chip[data-value="all"]');
    // 'all' í´ë¦­ ì‹œ ë‹¤ë¥¸ ê²ƒ ëª¨ë‘ í•´ì œ
    if(val==='all'){
      g.querySelectorAll('.chip').forEach(c=>{
        c.classList.remove('checked','excluded');
      });
      chip.classList.add('checked');
      return;
    }
    // ë‹¤ë¥¸ ì¹© í´ë¦­ ì‹œ 'all' í•´ì œ
    if(allChip)allChip.classList.remove('checked','excluded');
    // í† ê¸€ (checked â†’ excluded â†’ í•´ì œ)
    if(chip.classList.contains('excluded')){
      chip.classList.remove('excluded');
    }else if(chip.classList.contains('checked')){
      chip.classList.remove('checked');
      chip.classList.add('excluded');
    }else{
      chip.classList.add('checked');
    }
    // ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆë˜ë©´ 'all' ì„ íƒ
    const anySelected=g.querySelector('.chip.checked,.chip.excluded');
    if(!anySelected&&allChip)allChip.classList.add('checked');
  });
  // ë”ë¸”í´ë¦­ìœ¼ë¡œ ë°”ë¡œ ì œì™¸
  g.addEventListener('dblclick',e=>{
    if(!e.target.classList.contains('chip'))return;
    const chip=e.target;
    const val=chip.dataset.value;
    if(val==='all')return;
    const allChip=g.querySelector('.chip[data-value="all"]');
    if(allChip)allChip.classList.remove('checked','excluded');
    chip.classList.remove('checked');
    chip.classList.add('excluded');
  });
});
// í•„í„° ì„¤ì • ë¡œë“œ
setTimeout(()=>{loadFilters('vocab');loadFilters('phrasal');loadFilters('expr');},500);
// â˜… ë¹ ë¥¸ì‹œì‘ í•„í„° í† ê¸€ ìŠ¤ìœ„ì¹˜
function toggleQuickFilter(type){
  const el=document.getElementById('quick-filter-'+type);
  if(!el)return;
  el.classList.toggle('active');
  localStorage.setItem('quickFilter-'+type,el.classList.contains('active'));
}
// ìƒíƒœ ë³µì›
['vocab','phrasal','expr'].forEach(t=>{
  const el=document.getElementById('quick-filter-'+t);
  if(el&&localStorage.getItem('quickFilter-'+t)==='true'){
    el.classList.add('active');
  }
});
// í•™ìŠµ í˜ì´ì§€ ì—¬ë¶€ í™•ì¸
const studyPages=['flashcard','quiz','typing','listening','dictation','cloze','collocation','expr-fc','expr-cloze','expr-typing','expr-quiz','pv-particle','pv-quiz'];
let skipStudyCheck=false; // forceEnd í›„ ì´ì¤‘ í™•ì¸ ë°©ì§€ í”Œë˜ê·¸
function isOnStudyPage(){const active=document.querySelector('.page.active');if(!active)return false;const id=active.id.replace('page-','');return studyPages.includes(id);}
function getCurrentStudyPage(){const active=document.querySelector('.page.active');if(!active)return null;return active.id.replace('page-','');}
// â˜… í˜„ì¬ í•™ìŠµ ê°•ì œ ì¢…ë£Œ ë° í†µê³„ ì €ì¥
async function forceEndCurrentStudy(){
const page=getCurrentStudyPage();
if(!page)return;
try{
if(page==='flashcard'){
  if(fcState.timer){clearInterval(fcState.timer);fcState.timer=null;}
  const ev=fcState.stats.again+fcState.stats.hard+fcState.stats.good+fcState.stats.easy;
  if(ev>0){
    const known=fcState.stats.good+fcState.stats.easy,unknown=fcState.stats.again+fcState.stats.hard;
    const acc=Math.round((known/ev)*100),dur=Math.round((Date.now()-fcState.start)/1000);
    await saveSession({total:ev,known,unknown,accuracy:acc,duration:dur,mode:'flashcard',type:fcState.type,stats:{...fcState.stats},uniqueTotal:fcState.originalCount,firstTryCorrect:fcState.firstTryCorrect,firstTryWrong:fcState.firstTryWrong});
  }
}else if(page==='quiz'){
  const ans=quizState.correct+quizState.wrong;
  if(ans>0){
    const acc=Math.round((quizState.correct/ans)*100);
    await saveSession({total:ans,correct:quizState.correct,wrong:quizState.wrong,accuracy:acc,mode:quizState.mode,type:quizState.type,duration:Math.round((Date.now()-quizState.start)/1000),uniqueTotal:quizState.originalCount,firstTryCorrect:quizState.firstTryCorrect,firstTryWrong:quizState.firstTryWrong});
  }
}else if(page==='typing'){
  const ans=typingState.correct+typingState.wrong;
  if(ans>0){
    const acc=Math.round((typingState.correct/ans)*100);
    await saveSession({total:ans,correct:typingState.correct,wrong:typingState.wrong,accuracy:acc,mode:'typing',type:'vocab',duration:Math.round((Date.now()-typingState.start)/1000),uniqueTotal:typingState.originalCount,firstTryCorrect:typingState.firstTryCorrect,firstTryWrong:typingState.firstTryWrong});
  }
}else if(page==='listening'){
  const ans=listeningState.correct+listeningState.wrong;
  if(ans>0){
    const acc=Math.round((listeningState.correct/ans)*100);
    await saveSession({total:ans,correct:listeningState.correct,wrong:listeningState.wrong,accuracy:acc,mode:'listening',type:currentListeningType,duration:Math.round((Date.now()-listeningState.start)/1000),uniqueTotal:listeningState.originalCount,firstTryCorrect:listeningState.firstTryCorrect,firstTryWrong:listeningState.firstTryWrong});
  }
}else if(page==='dictation'){
  const ans=dictationState.correct+dictationState.wrong;
  if(ans>0){
    const acc=Math.round((dictationState.correct/ans)*100);
    await saveSession({total:ans,correct:dictationState.correct,wrong:dictationState.wrong,accuracy:acc,mode:'dictation',type:currentListeningType,duration:Math.round((Date.now()-dictationState.start)/1000),uniqueTotal:dictationState.originalCount,firstTryCorrect:dictationState.firstTryCorrect,firstTryWrong:dictationState.firstTryWrong});
  }
}else if(page==='cloze'){
  const ans=clozeState.correct+clozeState.wrong;
  if(ans>0){
    const acc=Math.round((clozeState.correct/ans)*100);
    await saveSession({total:ans,correct:clozeState.correct,wrong:clozeState.wrong,accuracy:acc,mode:'cloze',type:'vocab',duration:Math.round((Date.now()-clozeState.start)/1000),uniqueTotal:clozeState.originalCount,firstTryCorrect:clozeState.firstTryCorrect,firstTryWrong:clozeState.firstTryWrong});
  }
}else if(page==='collocation'){
  const ans=collocState.correct+collocState.wrong;
  if(ans>0){
    const acc=Math.round((collocState.correct/ans)*100);
    await saveSession({total:ans,correct:collocState.correct,wrong:collocState.wrong,accuracy:acc,mode:'collocation',type:'vocab',duration:Math.round((Date.now()-collocState.start)/1000),uniqueTotal:collocState.originalCount,firstTryCorrect:collocState.firstTryCorrect,firstTryWrong:collocState.firstTryWrong});
  }
}else if(page==='expr-fc'){
  if(exprState.timer){clearInterval(exprState.timer);exprState.timer=null;}
  const total=exprState.stats.again+exprState.stats.hard+exprState.stats.good+exprState.stats.easy;
  if(total>0){
    const known=exprState.stats.good+exprState.stats.easy,unknown=exprState.stats.again+exprState.stats.hard;
    const acc=Math.round((known/total)*100),dur=Math.round((Date.now()-exprState.start)/1000);
    await saveSession({total,known,unknown,accuracy:acc,duration:dur,mode:'expr-fc',type:'expr',stats:{...exprState.stats},uniqueTotal:exprState.originalCount,firstTryCorrect:exprState.firstTryCorrect,firstTryWrong:exprState.firstTryWrong});
  }
}else if(page==='expr-quiz'){
  const ans=exprState.correct+exprState.wrong;
  if(ans>0){
    const acc=Math.round((exprState.correct/ans)*100);
    await saveSession({total:ans,correct:exprState.correct,wrong:exprState.wrong,accuracy:acc,mode:'expr-quiz',type:'expr',duration:Math.round((Date.now()-exprState.start)/1000),uniqueTotal:exprState.originalCount,firstTryCorrect:exprState.firstTryCorrect,firstTryWrong:exprState.firstTryWrong});
  }
}else if(page==='expr-cloze'){
  const ans=exprState.correct+exprState.wrong;
  if(ans>0){
    const acc=Math.round((exprState.correct/ans)*100);
    await saveSession({total:ans,correct:exprState.correct,wrong:exprState.wrong,accuracy:acc,mode:'expr-cloze',type:'expr',duration:Math.round((Date.now()-exprState.start)/1000),uniqueTotal:exprState.originalCount,firstTryCorrect:exprState.firstTryCorrect,firstTryWrong:exprState.firstTryWrong});
  }
}else if(page==='expr-typing'){
  const ans=exprTypingState.correct+exprTypingState.wrong;
  if(ans>0){
    const acc=Math.round((exprTypingState.correct/ans)*100);
    await saveSession({total:ans,correct:exprTypingState.correct,wrong:exprTypingState.wrong,accuracy:acc,mode:'expr-typing',type:'expr',duration:Math.round((Date.now()-exprTypingState.start)/1000),uniqueTotal:exprTypingState.originalCount,firstTryCorrect:exprTypingState.firstTryCorrect,firstTryWrong:exprTypingState.firstTryWrong});
  }
}else if(page==='pv-particle'){
  const ans=pvState.correct+pvState.wrong;
  if(ans>0){
    const acc=Math.round((pvState.correct/ans)*100);
    await saveSession({total:ans,correct:pvState.correct,wrong:pvState.wrong,accuracy:acc,mode:'pv-particle',type:'phrasal',duration:Math.round((Date.now()-pvState.start)/1000),uniqueTotal:pvState.originalCount,firstTryCorrect:pvState.firstTryCorrect,firstTryWrong:pvState.firstTryWrong});
  }
}else if(page==='pv-quiz'){
  const ans=pvState.correct+pvState.wrong;
  if(ans>0){
    const acc=Math.round((pvState.correct/ans)*100);
    await saveSession({total:ans,correct:pvState.correct,wrong:pvState.wrong,accuracy:acc,mode:pvState.mode||'pv-meaning',type:'phrasal',duration:Math.round((Date.now()-pvState.start)/1000),uniqueTotal:pvState.originalCount,firstTryCorrect:pvState.firstTryCorrect,firstTryWrong:pvState.firstTryWrong});
  }
}
showToast('ğŸ“Š í•™ìŠµ ê¸°ë¡ ì €ì¥ë¨');
}catch(e){console.error('forceEndCurrentStudy error:',e);}
}
// í•™ìŠµ ì¤‘ì¼ ë•Œ í™•ì¸ í›„ ìƒˆ í•™ìŠµ ì‹œì‘
async function safeStart(fn){
if(isOnStudyPage()){
showConfirm('í•™ìŠµ ì¢…ë£Œ','í˜„ì¬ í•™ìŠµì„ ì¢…ë£Œí•˜ê³  ìƒˆ í•™ìŠµì„ ì‹œì‘í• ê¹Œìš”?\n(ì§„í–‰ ê¸°ë¡ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤)',async()=>{
  await forceEndCurrentStudy();
  skipStudyCheck=true; // ì´ì¤‘ í™•ì¸ ë°©ì§€
  try{await fn();}catch(e){console.error('safeStart error:',e);}
});
}else{try{await fn();}catch(e){console.error('safeStart error:',e);}}
}
function showPage(n,force=false){
// ì´ì¤‘ í™•ì¸ ë°©ì§€ í”Œë˜ê·¸ ì²´í¬
if(skipStudyCheck){skipStudyCheck=false;force=true;}
// í•™ìŠµ ì¤‘ì´ë©´ í™•ì¸
if(!force&&isOnStudyPage()){
showConfirm('í•™ìŠµ ì¢…ë£Œ','í•™ìŠµì„ ì¢…ë£Œí•˜ê³  ì´ë™í• ê¹Œìš”?\n(ì§„í–‰ ê¸°ë¡ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤)',async()=>{
  await forceEndCurrentStudy();
  showPage(n,true);
});
return;
}
// â˜… í•™ìŠµ í˜ì´ì§€ ëª©ë¡ (í•™ìŠµ ì‹œì‘ ì‹œ ì´ì „ í˜ì´ì§€ ì €ì¥)
const studyPages=['flashcard','quiz','typing','cloze','collocation','listening','dictation','pv-particle','pv-quiz','expr-fc','expr-quiz','expr-cloze','expr-typing'];
const tabPages=['home','study','data','stats'];
// â˜… í•™ìŠµ í˜ì´ì§€ë¡œ ì§„ì… ì‹œ í˜„ì¬ íƒ­ ì €ì¥
if(studyPages.includes(n)){
  const currentPage=document.querySelector('.page.active')?.id?.replace('page-','');
  if(tabPages.includes(currentPage))studyStartPage=currentPage;
}
// â˜… ìˆ˜ì •: ëª¨ë“  íƒ€ì´ë¨¸ ì •ë¦¬ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
cleanupAllTimers();
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+n)?.classList.add('active');document.querySelectorAll('.nav-item').forEach(a=>a.classList.toggle('active',a.dataset.page===n));if(n==='home'){updateHomeStats();clearSearchInputs();}if(n==='stats')updateStatsPage();if(n==='data')updateDataPage();if(n==='study')updateStudyPage();}
// â˜… ì¶”ê°€: ëª¨ë“  íƒ€ì´ë¨¸ ì •ë¦¬ í•¨ìˆ˜
function cleanupAllTimers(){
  // ì¸í„°ë²Œ íƒ€ì´ë¨¸
  if(fcState.timer){clearInterval(fcState.timer);fcState.timer=null;}
  if(exprState.timer){clearInterval(exprState.timer);exprState.timer=null;}
  // íƒ€ì„ì•„ì›ƒ íƒ€ì´ë¨¸
  if(quizState?.autoNextTimer){clearTimeout(quizState.autoNextTimer);quizState.autoNextTimer=null;}
  if(clozeState?.autoNextTimer){clearTimeout(clozeState.autoNextTimer);clozeState.autoNextTimer=null;}
  if(collocState?.autoNextTimer){clearTimeout(collocState.autoNextTimer);collocState.autoNextTimer=null;}
  if(pvState?.autoNextTimer){clearTimeout(pvState.autoNextTimer);pvState.autoNextTimer=null;}
  if(exprState?.autoNextTimer){clearTimeout(exprState.autoNextTimer);exprState.autoNextTimer=null;}
  if(typeof listeningRatingTimer!=='undefined'&&listeningRatingTimer){clearTimeout(listeningRatingTimer);listeningRatingTimer=null;}
  if(typeof quizRatingTimer!=='undefined'&&quizRatingTimer){clearTimeout(quizRatingTimer);quizRatingTimer=null;}
  if(typeof toastTimer!=='undefined'&&toastTimer){clearTimeout(toastTimer);toastTimer=null;}
}
// â˜… íƒ­ ë¹„í™œì„±í™” ì‹œ íƒ€ì´ë¨¸ ì •ë¦¬ (ë°°í„°ë¦¬/ë©”ëª¨ë¦¬ ì ˆì•½)
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){cleanupAllTimers();}
});
function clearSearchInputs(){
const inputs=['quick-search-input','pv-quick-search-input','expr-search-input'];
inputs.forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
const results=['quick-search-result','pv-quick-search-result','expr-search-result'];
results.forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
}
async function updateStudyPage(){const w=await getAllWords(),p=await getAllPV(),e=await getAllExpr();if(w.length){const l1s=[...new Set(w.map(x=>x.L1).filter(Boolean))].sort();const filterL1=document.getElementById('filter-l1');if(filterL1)filterL1.innerHTML='<option value="all">ì „ì²´</option>'+l1s.map(l=>`<option value="${l}">${l}</option>`).join('');}if(p.length){const cats=[...new Set(p.map(x=>x.Category).filter(Boolean))].sort();const pvFilterCat=document.getElementById('pv-filter-cat');if(pvFilterCat)pvFilterCat.innerHTML='<option value="all">ì „ì²´</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');}updateTagFilters(w,p,e);}

// === í•™ìŠµ ì‹œì‘ ===
async function startStudySession(){
if(currentStudyType==='phrasal'){await startPVStudySession();return;}
const words=await getAllWords();if(!words.length){showToast('ğŸ“¤ ë¨¼ì € ì–´íœ˜ DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
const count=parseInt(document.getElementById('study-count')?.value||'20'),order=document.getElementById('option-order')?.value||'fsrs';
// â˜… ë‹¤ì¤‘ ì„ íƒ í•„í„° ì ìš©
const masteryF=getMultiChip('filter-mastery');
const cefrF=getMultiChip('filter-cefr');
const freqF=getMultiChip('filter-freq');
const priorityF=getMultiChip('filter-priority');
const formalityF=getMultiChip('filter-formality');
const currencyF=getMultiChip('filter-currency');
const mediumF=getMultiChip('filter-medium');
// ë™ì  í•„í„° (select ìœ ì§€)
const l1Val=document.getElementById('filter-l1')?.value||'all';
const toeflVal=document.getElementById('filter-toefl')?.value||'all';
const cocaVal=document.getElementById('filter-coca')?.value||'all';
const tagF=getMultiFilterValue('filter-tag');
const now=new Date();
const today=now.toDateString();
const mode=document.querySelector('#study-vocab .mode-card.active')?.dataset.mode||'flashcard';
// â˜… íƒ€ì´í•‘ ëª¨ë“œ: needsProduction=trueë©´ SM-2 í•„í„° ë¬´ì‹œ
const isTypingMode=mode==='typing';
// â˜… Priority ê¸°ë°˜ í•™ìŠµ ëª¨ë“œ: P3ë§Œ ì„ íƒí•˜ê³  ì œì™¸ ì•„ë‹Œ ê²½ìš°
const isP3Only=priorityF.include.includes('P3')&&priorityF.include.length===1&&!priorityF.include.includes('all');
let filtered=words.filter(w=>{
// í•™ìŠµ ìƒíƒœ í•„í„° (ë‹¤ì¤‘ ì„ íƒ)
if(!checkMasteryFilter(w,masteryF))return false;
// chip-multi í•„í„°ë“¤
if(!checkMultiFilter(w.CEFR||'B1',cefrF))return false;
if(!checkMultiFilter(w.Frequency||'K3',freqF))return false;
if(!checkMultiFilter(w.Priority||'P2',priorityF))return false;
if(!checkMultiFilter(w.Formality||'Neutral',formalityF))return false;
if(!checkMultiFilter(w.Currency||'Current',currencyF))return false;
if(!checkMultiFilter(w.Medium||'Both',mediumF))return false;
// íƒœê·¸ í•„í„° (chip-multi)
if(!checkTagFilter(w.tags||[],tagF))return false;
// ë™ì  ì…€ë ‰íŠ¸ í•„í„°
if(l1Val!=='all'&&w.L1!==l1Val)return false;
if(toeflVal!=='all'&&(w.TOEFL_Rel||'').toLowerCase()!==toeflVal.toLowerCase())return false;
if(cocaVal!=='all'&&!(w.COCA_Genre||'').toLowerCase().includes(cocaVal.toLowerCase()))return false;
return true;
});
if(!filtered.length){showToast('âš ï¸ í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
// â˜… P3 ê²½ê³ : íƒ€ì´í•‘ ëª¨ë“œ ì‹œ
if(isP3Only&&isTypingMode){showToast('âš ï¸ P3(ì¸ì‹ìš©)ì€ ì‚°ì¶œ ì—°ìŠµ ë¶ˆí•„ìš”');return;}
// â˜… ì˜¤ëŠ˜ ì¶”ê°€ â†’ ê¸°íƒ€ ìƒˆ ë‹¨ì–´ â†’ ê¸°ì¡´ í•™ìŠµ
const todayAdded=shuffle(filtered.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today));
const otherNew=shuffle(filtered.filter(x=>(!x.addedDate||new Date(x.addedDate).toDateString()!==today)&&(!x.reviewCount||x.reviewCount===0)));
const oldW=shuffle(filtered.filter(x=>x.reviewCount>0));
let sel;
if(isTypingMode){
  const prodW=shuffle(filtered.filter(x=>x.needsProduction));
  const otherProd=todayAdded.filter(x=>!x.needsProduction);
  sel=[...prodW,...otherProd,...otherNew,...oldW].slice(0,count);
}else if(order==='random'){
  // ëœë¤: ê·¸ë£¹ ë‚´ì—ì„œë§Œ ì„ê³ , ì˜¤ëŠ˜ì¶”ê°€ â†’ ì‹ ê·œ â†’ ê¸°ì¡´ ìˆœì„œëŠ” ìœ ì§€
  sel=[...todayAdded,...otherNew,...oldW].slice(0,count);
}else if(order==='weak'){
  // ì·¨ì•½ ìš°ì„ : weaknessScore ë‚®ì€ ìˆœ (ë” ì·¨ì•½í•œ ê²ƒ ë¨¼ì €)
  sel=[...todayAdded,...otherNew,...oldW].sort((a,b)=>getWeaknessScore(a)-getWeaknessScore(b)).slice(0,count);
}else{
  // fsrs (ê¸°ë³¸ê°’): ì˜¤ëŠ˜ ì¶”ê°€ â†’ ì‹ ê·œ â†’ FSRS ê¸´ê¸‰ë„ ìˆœ
  const dueW=filtered.filter(x=>x.reviewCount>0&&x.nextReview&&new Date(x.nextReview)<=now);
  const sortedDue=sortByFSRSPriority(dueW,now);
  sel=[...todayAdded,...otherNew,...sortedDue].slice(0,count);
}
if(!sel.length){showToast('âš ï¸ í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
// â˜… ì˜¤ëŠ˜ ì¶”ê°€ í¬í•¨ í† ìŠ¤íŠ¸
if(todayAdded.length>0&&mode!=='typing')showToast(`ğŸ†• ì˜¤ëŠ˜ ì¶”ê°€ ${Math.min(todayAdded.length,count)}ê°œ í¬í•¨`);
// â˜… ì˜¤ë‹µ ìë™ í¬í•¨: ëª©í‘œ 5ê°œë‹¹ 1ê°œ, í•œë„ê¹Œì§€
const wrongAutoEnabled=localStorage.getItem('wrongAuto')!=='false';
if(wrongAutoEnabled&&mode!=='typing'){
const wrongLimit=parseInt(localStorage.getItem('wrongLimit')||'5');
const wrongBonus=Math.min(wrongLimit,Math.floor(count/5));
if(wrongBonus>0){
const wrongWords=words.filter(w=>isWrong(w)&&!sel.includes(w));
const wrongToAdd=shuffle(wrongWords).slice(0,wrongBonus);
if(wrongToAdd.length>0){
// Interleaving: ì˜¤ë‹µì„ ëœë¤ ìœ„ì¹˜ì— ì‚½ì…
wrongToAdd.forEach(w=>{
const insertIdx=Math.floor(Math.random()*(sel.length+1));
sel.splice(insertIdx,0,w);
});
showToast(`ğŸ“ ì˜¤ë‹µ ${wrongToAdd.length}ê°œ í¬í•¨`);
}
}
}
if(mode==='flashcard')startFC(sel,words,'vocab');
else if(mode==='quiz')startQuiz(sel,words,'quiz','vocab');
else if(mode==='reverse')startQuiz(sel,words,'reverse','vocab');
else if(mode==='typing')startTyping(sel);
else if(mode==='cloze')startCloze(sel,words);
else if(mode==='collocation')startColloc(sel,words);
else if(mode==='listening')startListening(sel,words,'vocab');
else if(mode==='dictation')startDictation(sel,words,'vocab');
}
async function startQuickStudy(t){
const now=new Date();
const count=parseInt(localStorage.getItem('defaultCount')||'20');
if(t==='phrasal'){
  const p=await getAllPV();
  if(!p.length){showToast('ğŸ“¤ ë¨¼ì € êµ¬ë™ì‚¬ DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
  // â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ : DUE 60% â†’ WEAK 30% â†’ NEW 10%
  const dueCount=Math.ceil(count*0.6);
  const weakCount=Math.ceil(count*0.3);
  const newCount=count-dueCount-weakCount;
  // â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
  const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
  const dueItems=sortByFSRSPriority(p.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
  const weakItems=shuffle(p.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
  const newItems=shuffle(p.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
  // â˜… ìˆœì„œ ìœ ì§€ + ë¶€ì¡±í•˜ë©´ í•™ìŠµ ê°€ëŠ¥í•œ ë‹¨ì–´ë§Œ ì±„ìš°ê¸°
  let selected=[...dueItems,...weakItems,...newItems];
  if(selected.length<count){
    const usedPVs=new Set(selected.map(x=>x.Phrasal_Verb));
    // â˜… í•µì‹¬ ìˆ˜ì •: nextReviewê°€ ë¯¸ë˜ì¸ ë‹¨ì–´ ì œì™¸!
    const remaining=shuffle(p.filter(x=>!usedPVs.has(x.Phrasal_Verb)&&isAvailable(x))).slice(0,count-selected.length);
    selected=[...selected,...remaining];
  }
  console.log('[QuickStudy PV] FSRSê¸°ë°˜:',{due:dueItems.length,weak:weakItems.length,new:newItems.length,total:selected.length});
  if(!selected.length){showToast('âœ… ì˜¤ëŠ˜ í•™ìŠµí•  êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}
  if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
  startFC(selected,p,'phrasal');
  return;
}
const w=await getAllWords();
if(!w.length){showToast('ğŸ“¤ ë¨¼ì € DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');showPage('data');return;}
// â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ : DUE 60% â†’ WEAK 30% â†’ NEW 10%
const dueCount=Math.ceil(count*0.6);
const weakCount=Math.ceil(count*0.3);
const newCount=count-dueCount-weakCount;
// â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
// â˜… ë””ë²„ê·¸: ê° ë‹¨ì–´ì˜ nextReview ìƒíƒœ í™•ì¸
console.log('[QuickStudy] ì „ì²´ ë‹¨ì–´ ìˆ˜:',w.length);
console.log('[QuickStudy] í•™ìŠµ ê°€ëŠ¥(isAvailable):',w.filter(isAvailable).length);
console.log('[QuickStudy] ë¯¸ë˜ ë³µìŠµ(not available):',w.filter(x=>!isAvailable(x)).map(x=>({word:x.word,nextReview:x.nextReview})));
const dueItems=sortByFSRSPriority(w.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
const weakItems=shuffle(w.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
const newItems=shuffle(w.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
// â˜… ìˆœì„œ ìœ ì§€ + ë¶€ì¡±í•˜ë©´ í•™ìŠµ ê°€ëŠ¥í•œ ë‹¨ì–´ë§Œ ì±„ìš°ê¸°
let selected=[...dueItems,...weakItems,...newItems];
if(selected.length<count){
  const usedWords=new Set(selected.map(x=>x.word));
  // â˜… í•µì‹¬ ìˆ˜ì •: nextReviewê°€ ë¯¸ë˜ì¸ ë‹¨ì–´ ì œì™¸!
  const remaining=shuffle(w.filter(x=>!usedWords.has(x.word)&&isAvailable(x))).slice(0,count-selected.length);
  selected=[...selected,...remaining];
}
console.log('[QuickStudy Vocab] FSRSê¸°ë°˜:',{due:dueItems.length,weak:weakItems.length,new:newItems.length,total:selected.length,available:w.filter(x=>isAvailable(x)).length});
if(!selected.length){showToast('âœ… ì˜¤ëŠ˜ í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤! ë‚´ì¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.');return;}
if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
startFC(selected,w,'vocab');
}
async function startQuickQuiz(t){
const now=new Date();
const count=parseInt(localStorage.getItem('defaultCount')||'20');
// â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
if(t==='phrasal'){
  const p=await getAllPV();
  const valid=p.filter(x=>x.Particle?.trim());
  if(valid.length<5){showToast('âš ï¸ í•™ìŠµí•  êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
  // â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ 
  const dueCount=Math.ceil(count*0.6);
  const weakCount=Math.ceil(count*0.3);
  const newCount=count-dueCount-weakCount;
  const dueItems=sortByFSRSPriority(valid.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
  const weakItems=shuffle(valid.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
  const newItems=shuffle(valid.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
  // â˜… ìˆœì„œ ìœ ì§€ + ë¶€ì¡±í•˜ë©´ í•™ìŠµ ê°€ëŠ¥í•œ ë‹¨ì–´ë§Œ ì±„ìš°ê¸°
  let selected=[...dueItems,...weakItems,...newItems];
  if(selected.length<count){
    const usedPVs=new Set(selected.map(x=>x.Phrasal_Verb));
    const remaining=shuffle(valid.filter(x=>!usedPVs.has(x.Phrasal_Verb)&&isAvailable(x))).slice(0,count-selected.length);
    selected=[...selected,...remaining];
  }
  if(!selected.length){showToast('âœ… ì˜¤ëŠ˜ í•™ìŠµí•  êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}
  if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
  startPVP(selected,p);
  return;
}
const w=await getAllWords();
const valid=w.filter(x=>getMKO(x));
if(valid.length<5){showToast('âš ï¸ í•™ìŠµí•  ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
// â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ 
const dueCount=Math.ceil(count*0.6);
const weakCount=Math.ceil(count*0.3);
const newCount=count-dueCount-weakCount;
const dueItems=sortByFSRSPriority(valid.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
const weakItems=shuffle(valid.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
const newItems=shuffle(valid.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
// â˜… ìˆœì„œ ìœ ì§€ + ë¶€ì¡±í•˜ë©´ í•™ìŠµ ê°€ëŠ¥í•œ ë‹¨ì–´ë§Œ ì±„ìš°ê¸°
let selected=[...dueItems,...weakItems,...newItems];
if(selected.length<count){
  const usedWords=new Set(selected.map(x=>x.word));
  const remaining=shuffle(valid.filter(x=>!usedWords.has(x.word)&&isAvailable(x))).slice(0,count-selected.length);
  selected=[...selected,...remaining];
}
if(!selected.length){showToast('âœ… ì˜¤ëŠ˜ í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}
if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
startQuiz(selected,w,'quiz','vocab');
}
async function startReviewDue(t){const now=new Date();const count=parseInt(localStorage.getItem('defaultCount')||'20');if(t==='phrasal'){const p=await getAllPV();const due=p.filter(x=>x.nextReview&&new Date(x.nextReview)<=now);if(!due.length){showToast('âœ… ë³µìŠµí•  êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}showToast('ğŸ”„ '+due.length+'ê°œ ë³µìŠµ!');const sorted=sortByFSRSPriority([...due],now);startFC(sorted.slice(0,count),p,'phrasal');return;}const w=await getAllWords();const due=w.filter(x=>x.nextReview&&new Date(x.nextReview)<=now);if(!due.length){showToast('âœ… ë³µìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}showToast('ğŸ”„ '+due.length+'ê°œ ë³µìŠµ!');const sorted=sortByFSRSPriority([...due],now);startFC(sorted.slice(0,count),w,'vocab');}
async function startWrongReview(t){const count=parseInt(localStorage.getItem('defaultCount')||'20');if(t==='phrasal'){const p=await getAllPV();const wr=p.filter(x=>isWrong(x));if(!wr.length){showToast('âœ… ì˜¤ë‹µë…¸íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}showToast('ğŸ“ ì˜¤ë‹µ '+wr.length+'ê°œ ë³µìŠµ!');startFC(shuffle(wr).slice(0,count),p,'phrasal');return;}const w=await getAllWords();const wr=w.filter(x=>isWrong(x));if(!wr.length){showToast('âœ… ì˜¤ë‹µë…¸íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}showToast('ğŸ“ ì˜¤ë‹µ '+wr.length+'ê°œ ë³µìŠµ!');startFC(shuffle(wr).slice(0,count),w,'vocab');}
async function startStarredStudy(t){const count=parseInt(localStorage.getItem('defaultCount')||'20');if(t==='phrasal'){const p=await getAllPV();const st=p.filter(x=>x.starred);if(!st.length){showToast('â­ ë¶ë§ˆí¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}showToast('â­ ë¶ë§ˆí¬ '+st.length+'ê°œ í•™ìŠµ!');startFC(shuffle(st).slice(0,count),p,'phrasal');return;}const w=await getAllWords();const st=w.filter(x=>x.starred);if(!st.length){showToast('â­ ë¶ë§ˆí¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}showToast('â­ ë¶ë§ˆí¬ '+st.length+'ê°œ í•™ìŠµ!');startFC(shuffle(st).slice(0,count),w,'vocab');}
async function startTagStudy(t){
const sel=t==='phrasal'?document.getElementById('home-pv-tag-select'):document.getElementById('home-tag-select');
const tag=sel?.value;if(!tag){return;}
const count=parseInt(localStorage.getItem('defaultCount')||'20');
if(t==='phrasal'){
const p=await getAllPV();const tagged=p.filter(x=>(x.tags||[]).includes(tag));
if(!tagged.length){showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤');sel.value='';return;}
showToast('ğŸ·ï¸ '+tag+' '+tagged.length+'ê°œ í•™ìŠµ!');startFC(shuffle(tagged).slice(0,count),p,'phrasal');
}else{
const w=await getAllWords();const tagged=w.filter(x=>(x.tags||[]).includes(tag));
if(!tagged.length){showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤');sel.value='';return;}
showToast('ğŸ·ï¸ '+tag+' '+tagged.length+'ê°œ í•™ìŠµ!');startFC(shuffle(tagged).slice(0,count),w,'vocab');
}
sel.value='';
}
async function startProductionStudy(t){
const count=parseInt(localStorage.getItem('defaultCount')||'20');
if(t==='expr'){
const e=await getAllExpr();const prod=e.filter(x=>x.needsProduction);
if(!prod.length){showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ '+prod.length+'ê°œ!');
// í‘œí˜„ íƒ€ì´í•‘ ëª¨ë“œë¡œ ì‹œì‘
startExprTyping(shuffle(prod).slice(0,count),e);return;
}
if(t==='phrasal'){
const p=await getAllPV();const prod=p.filter(x=>x.needsProduction);
if(!prod.length){showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ '+prod.length+'ê°œ!');
// ì—­ë°©í–¥ í€´ì¦ˆë¡œ ì‹œì‘ (ëœ»â†’êµ¬ë™ì‚¬)
startPVQ(shuffle(prod).slice(0,count),p,'reverse');return;
}
const w=await getAllWords();const prod=w.filter(x=>x.needsProduction);
if(!prod.length){showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ '+prod.length+'ê°œ!');
// íƒ€ì´í•‘ ëª¨ë“œë¡œ ì‹œì‘
startTyping(shuffle(prod).slice(0,count));
}
// â˜… ìƒˆ ë‹¨ì–´ë§Œ í•™ìŠµ (ì˜¤ëŠ˜ ì¶”ê°€ëœ ê²ƒ + ì•„ì§ í•™ìŠµ ì•ˆ í•œ ê²ƒ)
async function startNewWordsStudy(t){
const count=parseInt(localStorage.getItem('defaultCount')||'20');
const today=new Date().toDateString();
if(t==='phrasal'){
  const p=await getAllPV();
  const newW=p.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today&&(!x.reviewCount||x.reviewCount===0));
  if(!newW.length){showToast('ğŸ†• ì˜¤ëŠ˜ ì¶”ê°€ëœ ìƒˆ êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}
  showToast('ğŸ†• ì˜¤ëŠ˜ ì¶”ê°€ '+newW.length+'ê°œ!');
  startFC(shuffle(newW).slice(0,count),p,'phrasal');
  return;
}
if(t==='expr'){
  const e=await getAllExpr();
  const newW=e.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today&&(!x.reviewCount||x.reviewCount===0));
  if(!newW.length){showToast('ğŸ†• ì˜¤ëŠ˜ ì¶”ê°€ëœ ìƒˆ í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
  showToast('ğŸ†• ì˜¤ëŠ˜ ì¶”ê°€ '+newW.length+'ê°œ!');
  startExprFCWithItems(shuffle(newW).slice(0,count),e);
  return;
}
const w=await getAllWords();
const newW=w.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today&&(!x.reviewCount||x.reviewCount===0));
if(!newW.length){showToast('ğŸ†• ì˜¤ëŠ˜ ì¶”ê°€ëœ ìƒˆ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}
showToast('ğŸ†• ì˜¤ëŠ˜ ì¶”ê°€ '+newW.length+'ê°œ!');
startFC(shuffle(newW).slice(0,count),w,'vocab');
}
// í‘œí˜„ í”Œë˜ì‹œì¹´ë“œ (items ì „ë‹¬ ë²„ì „)
async function startExprFCWithItems(items,all){
if(!items.length){showToast('ğŸ’¬ í•™ìŠµí•  í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...items]);
exprState={words:shuffled,allWords:all,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null,originalCount:shuffled.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-fc-total').textContent=shuffled.length;
document.getElementById('expr-fc-current').textContent='0';
document.getElementById('expr-retry-banner').classList.add('hidden');
showPage('expr-fc');startExprTimer();showExprCard();
}
// í‘œí˜„ 5ì§€ì„ ë‹¤ (items ì „ë‹¬ ë²„ì „)
function startExprQuiz(items,all){
if(items.length<5){showToast('âš ï¸ í•™ìŠµí•  í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...items]);
exprState={words:shuffled,allWords:all,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0,originalCount:shuffled.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-quiz-total').textContent=shuffled.length;
document.getElementById('expr-quiz-retry-banner').classList.add('hidden');
showPage('expr-quiz');showExprQuizQ();
}
// í‘œí˜„ ë¹ˆì¹¸ì±„ìš°ê¸° (items ì „ë‹¬ ë²„ì „)
function startExprClozeWithItems(items,all){
let valid=items.filter(e=>{const ex=getEx(e);const expr=(e.Expression||'').toLowerCase();return ex&&expr&&ex.toLowerCase().includes(expr.split(' ')[0]);});
if(!valid.length){showToast('âœ… ë¹ˆì¹¸ì±„ìš°ê¸° ê°€ëŠ¥í•œ í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...valid]);
exprState={words:shuffled,allWords:all,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0,originalCount:shuffled.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-cloze-total').textContent=shuffled.length;
showPage('expr-cloze');showExprClozeQ();
}
// í‘œí˜„ íƒ€ì´í•‘ (items ì „ë‹¬ ë²„ì „)
function startExprTyping(items,all){
try{
let valid=items.filter(e=>{const ex=getEx(e);const expr=(e.Expression||'').toLowerCase();return ex&&expr&&ex.toLowerCase().includes(expr.split(' ')[0]);});
if(!valid.length){valid=items;} // fallback: í•„í„° ì—†ì´ ì „ë¶€
if(!valid.length){showToast('âœ… íƒ€ì´í•‘ ê°€ëŠ¥í•œ í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...valid]);
exprTypingState={words:shuffled,allWords:all,idx:0,correct:0,wrong:0,hintUsed:false,answered:false,start:Date.now(),retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:shuffled.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-typing-total').textContent=shuffled.length;
document.getElementById('expr-typing-retry-banner').classList.add('hidden');
showPage('expr-typing');showExprTypingQ();
}catch(e){console.error('startExprTyping error:',e);showToast('âŒ ì‹œì‘ ì˜¤ë¥˜');}
}
async function showWeakWords(t){const count=parseInt(localStorage.getItem('defaultCount')||'20');currentWeakType=t;const items=t==='phrasal'?await getAllPV():await getAllWords();const weak=items.filter(i=>isWeak(i)).sort((a,b)=>(getAcc(a)||100)-(getAcc(b)||100));document.getElementById('weak-title').textContent=t==='phrasal'?'ì·¨ì•½ êµ¬ë™ì‚¬':'ì·¨ì•½ ë‹¨ì–´';const list=document.getElementById('weak-list'),empty=document.getElementById('weak-empty'),btn=document.getElementById('weak-study-btn');if(!weak.length){list.innerHTML='';empty.classList.remove('hidden');btn.classList.add('hidden');}else{empty.classList.add('hidden');btn.classList.remove('hidden');list.innerHTML=weak.slice(0,count).map(w=>`<div class="weak-word-item"><div class="weak-word-text"><strong>${displayWord(getW(w))}</strong><span>${getMKO(w)}</span></div><div class="weak-word-stats"><div class="weak-word-rate" style="color:var(--danger)">${getAcc(w)!==null?getAcc(w)+'%':'-'}</div><div class="weak-word-count">${w.reviewCount||0}íšŒ</div></div></div>`).join('');}showPage('weak');}
async function startWeakStudy(){const count=parseInt(localStorage.getItem('defaultCount')||'20');const items=currentWeakType==='phrasal'?await getAllPV():await getAllWords();const weak=items.filter(i=>isWeak(i));if(!weak.length){showToast('ì·¨ì•½ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');return;}if(currentWeakType==='phrasal')startFC(shuffle(weak).slice(0,count),items,'phrasal');else startFC(shuffle(weak).slice(0,count),items,'vocab');}

// === í”Œë˜ì‹œì¹´ë“œ (í•µì‹¬) ===
function startFC(items,all,type){
console.log('startFC called:', {itemsCount: items.length, type, firstItem: items[0]});
if(fcState.timer)clearInterval(fcState.timer);
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...items]);
fcState={words:shuffled,idx:0,flipped:false,start:Date.now(),timer:null,stats:{again:0,hard:0,good:0,easy:0},transitioning:false,retryQueue:[],phase:'normal',type,savedToWrong:0,allWords:all,originalCount:shuffled.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
console.log('fcState.words[0]:', fcState.words[0]);
document.getElementById('fc-total').textContent=shuffled.length;
document.getElementById('fc-current').textContent='0';
document.getElementById('fc-progress').style.width='0%';
document.getElementById('fc-retry-banner').classList.add('hidden');
document.getElementById('fc-progress').classList.toggle('phrasal',type==='phrasal');
showPage('flashcard');showCard();startTimer();updateStreak();
}

function showCard(){
try{
const item=fcState.words[fcState.idx];
console.log('showCard item:',item); // ë””ë²„ê¹…
if(!item){
  if(fcState.retryQueue.length>0){
    fcState.words=[...fcState.retryQueue];fcState.retryQueue=[];fcState.idx=0;fcState.phase='retry';
    document.getElementById('fc-retry-banner').classList.remove('hidden');
    document.getElementById('fc-retry-count').textContent=fcState.words.length;
    document.getElementById('fc-total').textContent=fcState.words.length;
    showToast('ğŸ”„ ëª¨ë¦„ '+fcState.words.length+'ê°œ ì¬ì¶œì œ!');
    showCard();return;
  }else{endFC();return;}
}
const fc=document.getElementById('flashcard');
// 1. ë’·ë©´ ë‚´ìš© ì¦‰ì‹œ ìˆ¨ê¹€
document.getElementById('fc-back-inner').classList.remove('visible');
document.getElementById('fc-meaning-ko').textContent='';
document.getElementById('fc-meaning-en').textContent='';
document.getElementById('fc-example').textContent='';
document.getElementById('fc-example').style.display='none';
document.getElementById('fc-collocation').textContent='';
// 2. ì¹´ë“œ ë¦¬ì…‹
fcState.flipped=false;fcState.transitioning=false;fcState.intervalsCalculated=false;
fc.classList.remove('flipped','swipe-left','swipe-right');
setRating(false);
// 3. ì§„í–‰ë¥ : ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
const uniqueCompleted=fcState.completedKeys.size;
document.getElementById('fc-progress').style.width=(uniqueCompleted/fcState.originalCount)*100+'%';
document.getElementById('fc-current').textContent=uniqueCompleted;
document.getElementById('fc-total').textContent=fcState.originalCount;
if(fcState.phase==='retry')document.getElementById('fc-retry-count').textContent=fcState.words.length-fcState.idx;
// 4. ì•ë©´
if(fcState.type==='phrasal'){
  document.getElementById('fc-word').textContent=item.Phrasal_Verb||'(êµ¬ë™ì‚¬)';
  document.getElementById('fc-tags').innerHTML=`<span class="tag tag-phrasal">${item.Particle||''}</span><span class="tag tag-cat">${item.Category||''}</span>`;
}else{
  const wordText=displayWord(item.word)||item.word||'(ë‹¨ì–´ ì—†ìŒ)';
  console.log('Displaying word:',wordText); // ë””ë²„ê¹…
  document.getElementById('fc-word').innerHTML=wordText;
  // â˜… ìƒˆ íƒœê·¸ êµ¬ì¡°: CEFR, Frequency, Priority, Formality
  const cefr=item.CEFR||'B1';
  const freq=item.Frequency||'K3';
  const priority=item.Priority||'P2';
  const formality=item.Formality||'Neutral';
  const priorityColor=priority==='P1'?'var(--danger)':priority==='P2'?'var(--warning)':'var(--muted)';
  document.getElementById('fc-tags').innerHTML=`<span class="tag tag-pos">${item.POS||'n/a'}</span><span class="tag" style="background:var(--primary)">${cefr}</span><span class="tag" style="background:${priorityColor}">${priority}</span><span class="tag tag-cat">${item.L1||'General'}</span>`;
}
if(document.getElementById('setting-tts')?.checked)setTimeout(()=>speakWord(),300);
updateFCBookmarkBtn();
updateFCProductionBtn();
updateFCTagBtn();
updateFCPrevBtn();
}catch(e){
console.error('showCard error:',e);
document.getElementById('fc-word').textContent='[ì˜¤ë¥˜]';
}
}
// ì´ì „ ì¹´ë“œë¡œ ëŒì•„ê°€ê¸°
function prevCard(){
if(fcState.idx<=0)return;
fcState.idx--;
showCard();
}
function updateFCPrevBtn(){
const btn=document.getElementById('fc-prev-btn');
if(btn){
btn.disabled=fcState.idx<=0;
btn.style.opacity=fcState.idx<=0?'0.4':'1';
}
}

// í•µì‹¬: í”Œë¦½ í† ê¸€ (ì¬í”Œë¦½ ê°€ëŠ¥)
function flipCard(){
if(fcState.transitioning)return;
const item=fcState.words[fcState.idx];if(!item)return;
if(fcState.flipped){
// ì¬í”Œë¦½: ì•ë©´ìœ¼ë¡œ
fcState.flipped=false;
document.getElementById('flashcard').classList.remove('flipped');
document.getElementById('fc-back-inner').classList.remove('visible');
setRating(false);
}else{
// í”Œë¦½: ë’·ë©´ìœ¼ë¡œ
document.getElementById('fc-meaning-ko').textContent=getMKO(item)||'(ëœ» ì—†ìŒ)';
document.getElementById('fc-meaning-en').textContent=getMEN(item)||'';
const ex=getEx(item);document.getElementById('fc-example').textContent=ex||'';document.getElementById('fc-example').style.display=ex?'block':'none';
if(fcState.type==='phrasal'){document.getElementById('fc-collocation').innerHTML=item.Formal_Equivalent?`<strong>ğŸ“Œ Formal:</strong> ${item.Formal_Equivalent}`:'';
}else{document.getElementById('fc-collocation').innerHTML=item.Key_Collocation?`<strong>ğŸ“Œ</strong> ${item.Key_Collocation}`:'';}
document.getElementById('fc-back-inner').classList.add('visible');
fcState.flipped=true;
document.getElementById('flashcard').classList.add('flipped');
setRating(true);vibrate(10);
}
}

// â˜… Interval í‘œì‹œ í˜•ì‹ (ë¶„/ì‹œê°„/ì¼ êµ¬ë¶„)
function formatInterval(result) {
  if (!result) return '?';
  const interval = result.interval || 0;
  const state = result.fsrsState || 'Review';
  const step = result.learningStep || 0;
  
  // Learning/Relearning ìƒíƒœ: ë¶„ ë‹¨ìœ„ - calcNextì—ì„œ ì´ë¯¸ ê³„ì‚°ëœ step ì‚¬ìš©
  if (state === 'Learning' || state === 'Relearning') {
    const steps = state === 'Relearning' ? FSRS.relearningSteps : FSRS.learningSteps;
    // â˜… ìˆ˜ì •: calcNextì—ì„œ ì´ë¯¸ ì˜¬ë°”ë¥¸ stepì´ ì„¤ì •ë¨, +1 í•˜ì§€ ì•ŠìŒ
    const mins = steps[step] || steps[steps.length - 1] || 10;
    if (mins < 60) return `${mins}ë¶„`;
    if (mins < 1440) return `${Math.round(mins/60)}ì‹œê°„`;
    return `${Math.round(mins/1440)}ì¼`;
  }
  
  // Review ìƒíƒœ: ì¼ ë‹¨ìœ„
  if (interval === 0) return 'ë‹¤ì‹œ';
  if (interval >= 365) return `${Math.round(interval/365)}ë…„`;
  if (interval >= 30) return `${Math.round(interval/30)}ê°œì›”`;
  return `${interval}ì¼`;
}

function setRating(en){
try{
const sec=document.getElementById('rating-section');
// í•­ìƒ í™œì„±í™” (ë’¤ì§‘ì§€ ì•Šì•„ë„ ì„ íƒ ê°€ëŠ¥)
sec.classList.remove('disabled');
document.querySelectorAll('#rating-section .rating-btn').forEach(b=>b.disabled=false);
// ë™ì  interval í‘œì‹œ (FSRS ê¸°ë°˜) - ì´ë¯¸ ê³„ì‚°ëœ ê²½ìš° ìŠ¤í‚µ
if(fcState.intervalsCalculated)return;
const item=fcState.words[fcState.idx];
if(item){
// ì˜ˆìƒ ê°„ê²© ê³„ì‚° - try-catchë¡œ ì•ˆì „í•˜ê²Œ
try{
const result1 = calcNext({...item}, 1);
const result2 = calcNext({...item}, 2);
const result3 = calcNext({...item}, 3);
const intervals=['ë‹¤ì‹œ',
  formatInterval(result1),
  formatInterval(result2),
  formatInterval(result3)];
document.querySelectorAll('#rating-section .rating-interval').forEach((el,i)=>el.textContent=intervals[i]);
fcState.intervalsCalculated=true; // í”Œë˜ê·¸ ì„¤ì •
}catch(calcErr){
console.warn('calcNext error in setRating:',calcErr);
// ê¸°ë³¸ê°’ í‘œì‹œ
document.querySelectorAll('#rating-section .rating-interval').forEach((el,i)=>el.textContent=['ë‹¤ì‹œ','1ì¼','3ì¼','7ì¼'][i]);
}
}
}catch(e){console.error('setRating error:',e);}
}

async function rateCard(r){
if(fcState.transitioning)return;
fcState.transitioning=true;
try{
const item=fcState.words[fcState.idx];if(!item){fcState.transitioning=false;return;}
if(r===0)fcState.stats.again++;else if(r===1)fcState.stats.hard++;else if(r===2)fcState.stats.good++;else fcState.stats.easy++;
// â˜… ì²« ì‹œë„ ì •ë‹µ/ì˜¤ë‹µ ì¹´ìš´íŠ¸ (isRetryê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
if(!item.isRetry){
  if(r>=2)fcState.firstTryCorrect++;
  else fcState.firstTryWrong++;
}
// â˜… ê³ ìœ  ì¹´ë“œ ì™„ë£Œ ì¶”ì  (ì¬ì¶œì œ ì¹´ë“œ ì œì™¸)
if(!item.isRetry){
  const key=fcState.type==='phrasal'?item.Phrasal_Verb:item.word;
  fcState.completedKeys.add(key);
}
// 6. ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResult = updateProductionStatus(item, r>=2, 'flashcard');
if(prodResult.shouldToast) showToast(prodResult.message);
// 5. ì„¸ì…˜ ë‚´ ì¬í•™ìŠµ: ì˜¤ë‹µ ì‹œ 5~7ë¬¸ì œ í›„ ì¬ì¶œì œ (phase='normal'ì¼ ë•Œë§Œ)
if(r===0&&fcState.phase==='normal'){
const insertIdx=Math.min(fcState.idx+5+Math.floor(Math.random()*3),fcState.words.length);
fcState.words.splice(insertIdx,0,{...item,isRetry:true});
}
// retry phaseì—ì„œ ë˜ í‹€ë¦¬ë©´ ì˜¤ë‹µë…¸íŠ¸ë¡œ
else if(r===0&&fcState.phase==='retry'){updateWrong(item,false);fcState.savedToWrong++;}
else if(r>=2)updateWrong(item,true);
// DB ì—…ë°ì´íŠ¸ - ì¬ì¶œì œ ì¹´ë“œ(isRetry)ëŠ” FSRS ê±´ë„ˆë›°ê¸° (ê°™ì€ ì„¸ì…˜ ë‚´ ì¤‘ë³µ ì—…ë°ì´íŠ¸ ë°©ì§€)
if(!item.isRetry){
item.reviewCount=(item.reviewCount||0)+1;if(r>=2)item.correctCount=(item.correctCount||0)+1;
updateMastery(item,r>=2);
updateInputOutput(item,false,r>=2); // â˜… í”Œë˜ì‹œì¹´ë“œ = ì¸í’‹ ëª¨ë“œ
// FSRS ê³„ì‚° (lastReviewëŠ” calcNext ë‚´ë¶€ì—ì„œ ì„¤ì •)
try{
  const before={nextReview:item.nextReview,interval:item.interval,fsrsState:item.fsrsState};
  Object.assign(item,calcNext(item,r));
  console.log('[rateCard] FSRS ì—…ë°ì´íŠ¸:',{word:item.word||item.Phrasal_Verb,grade:r,before,after:{nextReview:item.nextReview,interval:item.interval,fsrsState:item.fsrsState}});
  if(item.isLeech)showToast('ğŸŒ Leech ì¹´ë“œ! '+((fcState.type==='phrasal')?item.Phrasal_Verb:item.word));
}catch(calcErr){console.error('calcNext error:',calcErr);item.lastReview=new Date().toISOString();}
}else{
// ì¬ì¶œì œ ì¹´ë“œ: reviewCount, correctCountë§Œ ì—…ë°ì´íŠ¸ (FSRSëŠ” ê±´ë„ˆëœ€)
console.log('[rateCard] isRetry card, skipping FSRS update');
}
try{
  if(fcState.type==='phrasal')await savePV(item);else await saveWord(item);
  console.log('[rateCard] DB ì €ì¥ ì™„ë£Œ:',{word:item.word||item.Phrasal_Verb,nextReview:item.nextReview});
}catch(saveErr){console.error('DB save error:',saveErr);}
vibrate(r>=2?10:[50,30,50]);fcState.idx++;
setTimeout(()=>{fcState.transitioning=false;showCard();},200);
}catch(e){
console.error('rateCard error:',e);
fcState.transitioning=false; // â˜… ì—ëŸ¬ ì‹œ ë°˜ë“œì‹œ í•´ì œ
}
}

// í„°ì¹˜ ì´ë²¤íŠ¸
let touchX=0,touchY=0,swiping=false;
document.getElementById('fc-container')?.addEventListener('touchstart',e=>{touchX=e.touches[0].clientX;touchY=e.touches[0].clientY;swiping=false;},{passive:true});
document.getElementById('fc-container')?.addEventListener('touchmove',e=>{if(!fcState.flipped)return;const dx=e.touches[0].clientX-touchX,dy=e.touches[0].clientY-touchY;if(Math.abs(dx)>30&&Math.abs(dx)>Math.abs(dy)){swiping=true;document.getElementById(dx>0?'swipe-right':'swipe-left').classList.add('show');document.getElementById(dx>0?'swipe-left':'swipe-right').classList.remove('show');}else{document.getElementById('swipe-left').classList.remove('show');document.getElementById('swipe-right').classList.remove('show');}},{passive:true});
document.getElementById('fc-container')?.addEventListener('touchend',e=>{document.getElementById('swipe-left').classList.remove('show');document.getElementById('swipe-right').classList.remove('show');if(!fcState.flipped)return;const dx=e.changedTouches[0].clientX-touchX,dy=e.changedTouches[0].clientY-touchY;if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*2){document.getElementById('flashcard').classList.add(dx>0?'swipe-right':'swipe-left');setTimeout(()=>rateCard(dx>0?2:0),300);}});
document.getElementById('flashcard')?.addEventListener('click',()=>{if(!swiping)flipCard();swiping=false;});

// í‘œí˜„ í”Œë˜ì‹œì¹´ë“œ ì´ë²¤íŠ¸
document.getElementById('expr-fc-card')?.addEventListener('click',flipExprCard);

function startTimer(){const el=document.getElementById('fc-timer'),s=Date.now();if(fcState.timer)clearInterval(fcState.timer);fcState.timer=setInterval(()=>{const sec=Math.floor((Date.now()-s)/1000);el.textContent=Math.floor(sec/60)+':'+(sec%60).toString().padStart(2,'0');},1000);}
function confirmEndFC(){const ev=fcState.stats.again+fcState.stats.hard+fcState.stats.good+fcState.stats.easy;if(ev===0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ì•„ì§ í‰ê°€í•œ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',()=>endFC(true));else if(fcState.idx<fcState.words.length||fcState.retryQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë‹¨ì–´ê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endFC);else endFC();}
async function endFC(skip){
if(fcState.timer){clearInterval(fcState.timer);fcState.timer=null;}
const ev=fcState.stats.again+fcState.stats.hard+fcState.stats.good+fcState.stats.easy;
if(ev===0||skip){showPage(studyStartPage,true);showToast('í•™ìŠµì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');return;}
const known=fcState.stats.good+fcState.stats.easy,unknown=fcState.stats.again+fcState.stats.hard,dur=Math.round((Date.now()-fcState.start)/1000);
const acc=Math.round((known/ev)*100);
await saveSession({total:ev,known,unknown,accuracy:acc,duration:dur,mode:'flashcard',type:fcState.type,stats:{...fcState.stats},uniqueTotal:fcState.originalCount,firstTryCorrect:fcState.firstTryCorrect,firstTryWrong:fcState.firstTryWrong});
document.getElementById('complete-total').textContent=ev;
document.getElementById('complete-known').textContent=known;
document.getElementById('complete-unknown').textContent=unknown;
const min=Math.floor(dur/60),sec=dur%60;document.getElementById('complete-time').textContent=min>0?min+'ë¶„ '+sec+'ì´ˆ':sec+'ì´ˆ';
if(fcState.savedToWrong>0){document.getElementById('complete-wrong-info').classList.remove('hidden');document.getElementById('complete-wrong-count').textContent=fcState.savedToWrong;}
else document.getElementById('complete-wrong-info').classList.add('hidden');
showModal('complete-modal');updateHomeStats();
}

// === í€´ì¦ˆ (3ë‹¨ê³„) ===
function startQuiz(words,all,mode,type){
const m=words.filter(w=>getMKO(w));if(m.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...m]);
quizState={words:shuffled,allWords:all||words,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),mode:mode||'quiz',type:type||'vocab',retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:shuffled.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
document.getElementById('quiz-total').textContent=shuffled.length;
document.getElementById('quiz-retry-banner').classList.add('hidden');
showPage('quiz');showQuizQ();updateStreak();
}
function showQuizQ(){
if(quizState.idx>=quizState.words.length){
  if(quizState.retryQueue.length>0&&quizState.phase==='normal'){
    quizState.words=[...quizState.retryQueue];quizState.retryQueue=[];quizState.idx=0;quizState.phase='retry';
    document.getElementById('quiz-retry-banner').classList.remove('hidden');document.getElementById('quiz-retry-count').textContent=quizState.words.length;
    showToast('ğŸ”„ ì˜¤ë‹µ '+quizState.words.length+'ê°œ ì¬ì¶œì œ!');
  }else if(quizState.finalQueue.length>0&&quizState.phase==='retry'){
    quizState.words=[...quizState.finalQueue];quizState.finalQueue=[];quizState.idx=0;quizState.phase='final';
    document.getElementById('quiz-retry-count').textContent=quizState.words.length;showToast('âš ï¸ ìµœì¢… '+quizState.words.length+'ê°œ ì¬ì¶œì œ!');
  }else{endQuiz();return;}
}
const w=quizState.words[quizState.idx];if(!w)return;
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
const quizUniqueCompleted=quizState.completedKeys?.size||0;
document.getElementById('quiz-progress').style.width=(quizUniqueCompleted/quizState.originalCount)*100+'%';
document.getElementById('quiz-current').textContent=quizUniqueCompleted;document.getElementById('quiz-total').textContent=quizState.originalCount;
document.getElementById('quiz-correct').textContent=quizState.correct;document.getElementById('quiz-wrong').textContent=quizState.wrong;
if(quizState.phase!=='normal')document.getElementById('quiz-retry-count').textContent=quizState.words.length-quizState.idx;
const isRev=quizState.mode==='reverse';
if(isRev){document.getElementById('quiz-word').textContent=getMKO(w);document.getElementById('quiz-sub').textContent='ì˜ì–´ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”';document.getElementById('quiz-tags').innerHTML='';}
else{document.getElementById('quiz-word').innerHTML=displayWord(w.word);document.getElementById('quiz-sub').textContent='';document.getElementById('quiz-tags').innerHTML=`<span class="tag tag-pos">${w.POS||''}</span><span class="tag tag-level">${w.CEFR||'B1'}</span>`;}
// â˜… ì„ íƒì§€ ìƒì„± ê°œì„  (ì—­ë°©í–¥ì€ ìˆœìˆ˜ í…ìŠ¤íŠ¸, ì •ë°©í–¥ì€ í•œêµ­ì–´ ëœ»)
const cAns=isRev?displayWord(w.word,true):getMKO(w);
const pool=quizState.allWords.filter(x=>{
  if(x.word===w.word)return false;
  const m=getMKO(x);
  if(!m||m===cAns)return false;
  return true;
});
const dist=getDistractors(w,pool,4);
const wAns=dist.map(x=>isRev?displayWord(x.word,true):getMKO(x)).filter(x=>x&&x!==cAns);
// ì¤‘ë³µ ì œê±°
const uniqueWAns=[...new Set(wAns)].slice(0,4);
const opts=shuffle([cAns,...uniqueWAns]);
console.log('[Quiz]',{word:w.word,POS:w.POS,cAns,distractorCount:dist.length,uniqueCount:uniqueWAns.length});
document.getElementById('quiz-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectQuiz(this)" data-ans="${o===cAns}">${o}</button>`).join('');
quizState.answered=false;quizState.correctAns=cAns;
document.getElementById('quiz-example').classList.add('hidden');
updateQuizBookmarkBtn();
updateQuizProductionBtn();
updateQuizTagBtn();
document.getElementById('quiz-next-btn').classList.add('hidden');
document.getElementById('quiz-rating-bar').classList.add('hidden');
}
function speakQuizWord(){
const w=quizState.words[quizState.idx];
if(w)speakText(displayWord(w.word,true)||w.word);
}
async function selectQuiz(el){
try{
if(quizState.answered)return;quizState.answered=true;
const ok=el.dataset.ans==='true';
const w=quizState.words[quizState.idx];
const isRetry=w.isRetry||false; // ì¬ì¶œì œ ì¹´ë“œ ì—¬ë¶€
// â˜… í†µê³„: ì²« ì‹œë„ë§Œ correct/wrong ì¹´ìš´íŠ¸, firstTry ì¹´ìš´íŠ¸
if(ok){
  if(!isRetry){quizState.correct++;quizState.firstTryCorrect++;}
  if(!isRetry&&quizState.completedKeys){const key=quizState.type==='phrasal'?w.Phrasal_Verb:w.word;quizState.completedKeys.add(key);} // ê³ ìœ  ì¹´ë“œ ì™„ë£Œ
}else{
  if(!isRetry){quizState.wrong++;quizState.firstTryWrong++;}
  // ì¬ì¶œì œ íì— ì¶”ê°€ (completed ì¦ê°€ ì•ˆ í•¨)
  if(quizState.phase==='normal')quizState.retryQueue.push({...w,isRetry:true});
  else if(quizState.phase==='retry')quizState.finalQueue.push({...w,isRetry:true});
  else{updateWrong(w,false);quizState.savedToWrong++;if(!isRetry&&quizState.completedKeys){const key=quizState.type==='phrasal'?w.Phrasal_Verb:w.word;quizState.completedKeys.add(key);}} // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ ì²˜ë¦¬
}
document.querySelectorAll('.quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
// ì¬ì¶œì œ ì¹´ë“œê°€ ì•„ë‹ ë•Œë§Œ ì²˜ë¦¬
if(!isRetry){
w.reviewCount=(w.reviewCount||0)+1;if(ok)w.correctCount=(w.correctCount||0)+1;
updateMastery(w,ok);
updateInputOutput(w,false,ok); // â˜… í€´ì¦ˆ = ì¸í’‹ ëª¨ë“œ
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResult = updateProductionStatus(w, ok, 'quiz');
if(prodResult.shouldToast) showToast(prodResult.message);
// â˜… FSRS: ì˜¤ë‹µë§Œ ë°”ë¡œ Again(0) ì ìš©, ì •ë‹µì€ rating ì„ íƒ ì‹œ ì ìš©
if(!ok){
  try{Object.assign(w,calcNext(w,0));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);await saveWord(w);}catch(e){console.error(e);}
  updateWrong(w,false);
}else{
  updateWrong(w,true);
  try{await saveWord(w);}catch(e){console.error(e);} // í†µê³„ë§Œ ì €ì¥
}
}
vibrate(ok?10:[50,30,50]);
document.getElementById('quiz-correct').textContent=quizState.correct;document.getElementById('quiz-wrong').textContent=quizState.wrong;
const ex=getEx(w);if(ex){document.getElementById('quiz-example').textContent=ex;document.getElementById('quiz-example').classList.remove('hidden');}
// â˜… ì •ë‹µ: rating bar í‘œì‹œ + 2ì´ˆ í›„ Hard(1) FSRS ì ìš© / ì˜¤ë‹µ: 1.5ì´ˆ í›„ ìë™ ë„˜ê¹€
if(ok){
document.getElementById('quiz-rating-bar').classList.remove('hidden');
quizState.autoNextTimer=setTimeout(()=>{
  skipQuizRating(); // Good(2) FSRS ì ìš©
},2000);
}else{
setTimeout(()=>nextQuiz(),1500);
}
}catch(e){console.error('selectQuiz error:',e);quizState.answered=false;}
}
let quizRatingTimer=null;
function showQuizRating(prefix,duration){
document.getElementById(prefix+'-rating-bar').classList.remove('hidden');
// íƒ€ì´ë¨¸ ì—†ì´ ë°”ë¡œ í‘œì‹œ - ì‚¬ìš©ìê°€ ì„ íƒí•˜ê±°ë‚˜ ê±´ë„ˆë›°ê¸°
}
// ê±´ë„ˆë›°ê¸° í•¨ìˆ˜ë“¤ (FSRS ì—…ë°ì´íŠ¸ ì—†ì´ ë‹¤ìŒìœ¼ë¡œ)
function skipQuizRating(){
// â˜… ìŠ¤í‚µ ì‹œ Good(2)ë¡œ FSRS ìë™ ì ìš©
rateQuizItem(2);
}
async function rateQuizItem(grade){
try{
// ìë™ ë„˜ê¹€ íƒ€ì´ë¨¸ ì·¨ì†Œ
if(quizState.autoNextTimer){clearTimeout(quizState.autoNextTimer);quizState.autoNextTimer=null;}
const w=quizState.words[quizState.idx];
// â˜… í†µê³„ëŠ” ì´ë¯¸ selectQuizì—ì„œ ì €ì¥ë¨, ì—¬ê¸°ì„œëŠ” FSRSë§Œ ì ìš©
try{Object.assign(w,calcNext(w,grade));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);await saveWord(w);}catch(e){console.error(e);}
document.getElementById('quiz-rating-bar').classList.add('hidden');
nextQuiz();
}catch(e){console.error('rateQuizItem error:',e);nextQuiz();}
}
function nextQuiz(){quizState.idx++;showQuizQ();}
function confirmEndQuiz(){if(quizState.idx<quizState.words.length||quizState.retryQueue.length>0||quizState.finalQueue.length>0)showConfirm('í€´ì¦ˆ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endQuiz);else endQuiz();}
async function endQuiz(){
const ans=quizState.correct+quizState.wrong;if(ans===0){showPage(studyStartPage,true);return;}
const acc=Math.round((quizState.correct/ans)*100);
await saveSession({total:ans,correct:quizState.correct,wrong:quizState.wrong,accuracy:acc,mode:quizState.mode,type:quizState.type,duration:Math.round((Date.now()-quizState.start)/1000),uniqueTotal:quizState.originalCount,firstTryCorrect:quizState.firstTryCorrect,firstTryWrong:quizState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=quizState.correct;document.getElementById('qc-wrong').textContent=quizState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(quizState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=quizState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// === íƒ€ì´í•‘ (3ë‹¨ê³„) ===
function startTyping(words){
const valid=words.filter(w=>getMKO(w));
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...valid]);
typingState={words:shuffled,idx:0,correct:0,wrong:0,hintUsed:false,answered:false,start:Date.now(),retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:shuffled.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
document.getElementById('typing-total').textContent=shuffled.length;document.getElementById('typing-retry-banner').classList.add('hidden');
showPage('typing');showTypingQ();updateStreak();
}
function showTypingQ(){
if(typingState.idx>=typingState.words.length){
  if(typingState.retryQueue.length>0&&typingState.phase==='normal'){typingState.words=[...typingState.retryQueue];typingState.retryQueue=[];typingState.idx=0;typingState.phase='retry';document.getElementById('typing-retry-banner').classList.remove('hidden');document.getElementById('typing-retry-count').textContent=typingState.words.length;showToast('ğŸ”„ ì˜¤ë‹µ '+typingState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else if(typingState.finalQueue.length>0&&typingState.phase==='retry'){typingState.words=[...typingState.finalQueue];typingState.finalQueue=[];typingState.idx=0;typingState.phase='final';document.getElementById('typing-retry-count').textContent=typingState.words.length;showToast('âš ï¸ ìµœì¢… '+typingState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else{endTyping();return;}
}
const w=typingState.words[typingState.idx];if(!w)return;
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
const typingUniqueCompleted=typingState.completedKeys?.size||0;
document.getElementById('typing-progress').style.width=(typingUniqueCompleted/typingState.originalCount)*100+'%';
document.getElementById('typing-current').textContent=typingUniqueCompleted;document.getElementById('typing-total').textContent=typingState.originalCount;
document.getElementById('typing-correct').textContent=typingState.correct;document.getElementById('typing-wrong').textContent=typingState.wrong;
if(typingState.phase!=='normal')document.getElementById('typing-retry-count').textContent=typingState.words.length-typingState.idx;
document.getElementById('typing-pos').textContent=w.POS||'';document.getElementById('typing-meaning').textContent=getMKO(w)||'(ëœ» ì—†ìŒ)';document.getElementById('typing-en').textContent=getMEN(w)||'';
const inp=document.getElementById('typing-input');inp.value='';inp.classList.remove('correct','wrong');inp.disabled=false;inp.focus();
document.getElementById('typing-answer').classList.add('hidden');document.getElementById('typing-next-btn').classList.add('hidden');
document.getElementById('typing-submit-btn').classList.remove('hidden');document.getElementById('typing-hint-btn').classList.remove('hidden');
typingState.hintUsed=false;typingState.answered=false;
document.getElementById('typing-example').classList.add('hidden');
updateTypingBookmarkBtn();
}
function showTypingHint(){const w=typingState.words[typingState.idx];if(!w||typingState.answered)return;typingState.hintUsed=true;const dw=displayWord(w.word,true);showToast('íŒíŠ¸: '+dw.charAt(0)+'_'.repeat(dw.length-1)+' ('+dw.length+'ê¸€ì)');}
async function checkTyping(){
try{
if(typingState.answered)return;
const w=typingState.words[typingState.idx],inp=document.getElementById('typing-input');
// â˜… normalizeAnswer ì ìš© (í—ˆìš© ë³€ì´ ì²˜ë¦¬: í•˜ì´í”ˆ, ì•„í¬ìŠ¤íŠ¸ë¡œí”¼ ë“±)
const user=normalizeAnswer(inp.value);
const correct=normalizeAnswer(displayWord(w.word,true));
typingState.answered=true;inp.disabled=true;
const ok=user===correct;
const isRetry=w.isRetry||false; // ì¬ì¶œì œ ì¹´ë“œ ì—¬ë¶€
if(ok&&!typingState.hintUsed){
if(!isRetry){typingState.correct++;typingState.firstTryCorrect++;}
if(!isRetry&&typingState.completedKeys)typingState.completedKeys.add(w.word); // ê³ ìœ  ì¹´ë“œ ì™„ë£Œ
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResult = updateProductionStatus(w, true, 'typing');
if(prodResult.shouldToast) showToast(prodResult.message);
}
else{
if(!isRetry){typingState.wrong++;typingState.firstTryWrong++;}
// â˜… ì˜¤ë‹µ ì‹œ ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
updateProductionStatus(w, false, 'typing');
if(typingState.phase==='normal')typingState.retryQueue.push({...w,isRetry:true});
else if(typingState.phase==='retry')typingState.finalQueue.push({...w,isRetry:true});
else{updateWrong(w,false);typingState.savedToWrong++;if(!isRetry&&typingState.completedKeys)typingState.completedKeys.add(w.word);} // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ
}
inp.classList.add(ok?'correct':'wrong');
const ans=document.getElementById('typing-answer');ans.innerHTML=displayWord(w.word);ans.classList.remove('hidden','correct','wrong');ans.classList.add(ok?'correct':'wrong');
// â˜… ì¬ì¶œì œ ì¹´ë“œê°€ ì•„ë‹ ë•Œë§Œ DB ì—…ë°ì´íŠ¸
if(!isRetry){
w.reviewCount=(w.reviewCount||0)+1;if(ok&&!typingState.hintUsed)w.correctCount=(w.correctCount||0)+1;
updateMastery(w,ok);if(ok&&!typingState.hintUsed)updateWrong(w,true);
updateInputOutput(w,true,ok&&!typingState.hintUsed); // â˜… íƒ€ì´í•‘ = ì•„ì›ƒí’‹ ëª¨ë“œ
// Free Recall ë³´ìƒ
try{Object.assign(w,calcNext(w,ok&&!typingState.hintUsed?3:(ok?2:0)));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);await saveWord(w);}catch(e){console.error(e);}
}
vibrate(ok?10:[50,30,50]);
document.getElementById('typing-correct').textContent=typingState.correct;document.getElementById('typing-wrong').textContent=typingState.wrong;
document.getElementById('typing-submit-btn').classList.add('hidden');document.getElementById('typing-hint-btn').classList.add('hidden');
// ì˜ˆë¬¸ í‘œì‹œ
const exT=getEx(w);if(exT){document.getElementById('typing-example').textContent=exT;document.getElementById('typing-example').classList.remove('hidden');}
// ìë™ ì§„í–‰ (2ì´ˆ í›„)
setTimeout(()=>nextTyping(),2000);
}catch(e){console.error('checkTyping error:',e);typingState.answered=false;}
}
document.getElementById('typing-input')?.addEventListener('keypress',e=>{if(e.key==='Enter')checkTyping();});
function nextTyping(){typingState.idx++;showTypingQ();}
function confirmEndTyping(){if(typingState.idx<typingState.words.length||typingState.retryQueue.length>0||typingState.finalQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endTyping);else endTyping();}
async function endTyping(){
const ans=typingState.correct+typingState.wrong;if(ans===0){showPage(studyStartPage,true);return;}
const acc=Math.round((typingState.correct/ans)*100);
await saveSession({total:ans,correct:typingState.correct,wrong:typingState.wrong,accuracy:acc,mode:'typing',type:'vocab',duration:Math.round((Date.now()-typingState.start)/1000),uniqueTotal:typingState.originalCount,firstTryCorrect:typingState.firstTryCorrect,firstTryWrong:typingState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=typingState.correct;document.getElementById('qc-wrong').textContent=typingState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(typingState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=typingState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// === Cloze (ë¹ˆì¹¸ì±„ìš°ê¸°) ===
function startCloze(items,all){
// ì˜ˆë¬¸ì´ ìˆê³  ë‹¨ì–´ê°€ í¬í•¨ëœ ê²½ìš°ë§Œ í•„í„°
const valid=items.filter(w=>{
const ex=getEx(w);
const userEx=w.userExamples||[];
const allEx=[ex,...userEx].filter(e=>e&&e.trim());
// ë‹¨ì–´ê°€ ì‹¤ì œë¡œ ì˜ˆë¬¸ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ì²´í¬ (â˜… escapeRegex ì ìš©)
const regex=new RegExp('\\b'+escapeRegex(w.word)+'\\b','i');
return allEx.some(e=>regex.test(e));
});
if(valid.length<5){showToast('âš ï¸ ìœ íš¨í•œ ì˜ˆë¬¸ì´ ìˆëŠ” ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (5ê°œ ì´ìƒ í•„ìš”)');return;}
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...valid]);
clozeState={words:shuffled,allWords:all,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,autoNextTimer:null,originalCount:shuffled.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
document.getElementById('cloze-total').textContent=shuffled.length;
document.getElementById('cloze-retry-banner').classList.add('hidden');
showPage('cloze');showClozeQ();
}
function showClozeQ(){
if(clozeState.idx>=clozeState.words.length){
if(clozeState.retryQueue.length>0){
  clozeState.words=clozeState.retryQueue;clozeState.retryQueue=[];clozeState.idx=0;clozeState.phase='retry';
  document.getElementById('cloze-retry-banner').classList.remove('hidden');
  document.getElementById('cloze-retry-count').textContent=clozeState.words.length;
  showToast('ğŸ”„ ì˜¤ë‹µ '+clozeState.words.length+'ê°œ ì¬ì¶œì œ!');
  showClozeQ();return;
}
if(clozeState.finalQueue.length>0){
  clozeState.words=clozeState.finalQueue;clozeState.finalQueue=[];clozeState.idx=0;clozeState.phase='final';
  document.getElementById('cloze-retry-count').textContent=clozeState.words.length;
  showToast('âš ï¸ ìµœì¢… '+clozeState.words.length+'ê°œ ì¬ì¶œì œ!');
  showClozeQ();return;
}
endCloze();return;
}
const w=clozeState.words[clozeState.idx];
const wPlain=displayWord(w.word,true); // ìˆ«ì ì œê±°ëœ ë‹¨ì–´
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
const clozeUniqueCompleted=clozeState.completedKeys?.size||0;
document.getElementById('cloze-progress').style.width=((clozeUniqueCompleted/clozeState.originalCount)*100)+'%';
document.getElementById('cloze-current').textContent=clozeUniqueCompleted;
document.getElementById('cloze-correct').textContent=clozeState.correct;
document.getElementById('cloze-wrong').textContent=clozeState.wrong;
if(clozeState.phase!=='normal')document.getElementById('cloze-retry-count').textContent=clozeState.words.length-clozeState.idx;
// ì˜ˆë¬¸ ê°€ì ¸ì˜¤ê¸° (ë‹¨ì–´ê°€ í¬í•¨ëœ ì˜ˆë¬¸ë§Œ) â˜… escapeRegex ì ìš©
const regex=new RegExp('\\b'+escapeRegex(wPlain)+'\\b','gi');
const allEx=[getEx(w),...(w.userExamples||[])].filter(e=>e&&regex.test(e));
const ex=allEx[Math.floor(Math.random()*allEx.length)];
// ë‹¨ì–´ë¥¼ ë¹ˆì¹¸ìœ¼ë¡œ ëŒ€ì²´
const blanked=ex.replace(regex,'<span class="blank-word" style="padding:2px 20px;color:var(--primary)">_____</span>');
document.getElementById('cloze-sentence').innerHTML=blanked;
document.getElementById('cloze-hint').textContent=getMKO(w)||'';
// ì„ íƒì§€ ìƒì„± (í‘œì‹œìš©)
const pool=clozeState.allWords.filter(x=>x.word!==w.word);
const dist=getDistractors(w,pool,4).map(x=>displayWord(x.word,true));
const opts=shuffle([wPlain,...dist]);
document.getElementById('cloze-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectCloze(this,'${o.replace(/'/g,"\\'")}')" data-ans="${o===wPlain}">${o}</button>`).join('');
clozeState.answered=false;clozeState.correctAns=wPlain;
document.getElementById('cloze-next-btn').classList.add('hidden');
document.getElementById('cloze-rating-bar').classList.add('hidden');
}
async function selectCloze(el,selected){
try{
if(clozeState.answered)return;clozeState.answered=true;
const w=clozeState.words[clozeState.idx];
const wPlain=clozeState.correctAns; // ìˆ«ì ì œê±°ëœ ì •ë‹µ
const ok=selected===wPlain;
const isRetry=w.isRetry||false; // ì¬ì¶œì œ ì¹´ë“œ ì—¬ë¶€
// â˜… í†µê³„: ì²« ì‹œë„ë§Œ correct/wrong ì¹´ìš´íŠ¸, firstTry ì¹´ìš´íŠ¸
if(ok){
  if(!isRetry){clozeState.correct++;clozeState.firstTryCorrect++;}
  if(!isRetry&&clozeState.completedKeys)clozeState.completedKeys.add(w.word); // ê³ ìœ  ì¹´ë“œ ì™„ë£Œ
}else{
  if(!isRetry){clozeState.wrong++;clozeState.firstTryWrong++;}
  if(clozeState.phase==='normal')clozeState.retryQueue.push({...w,isRetry:true});
  else if(clozeState.phase==='retry')clozeState.finalQueue.push({...w,isRetry:true});
  else{updateWrong(w,false);clozeState.savedToWrong++;if(!isRetry&&clozeState.completedKeys)clozeState.completedKeys.add(w.word);} // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ
}
document.querySelectorAll('#cloze-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
// ë¹ˆì¹¸ì— ì •ë‹µ í‘œì‹œ
document.querySelectorAll('#cloze-sentence .blank-word').forEach(b=>{b.textContent=wPlain;b.style.color=ok?'var(--success)':'var(--danger)';b.style.borderBottom='none';});
// â˜… ì¬ì¶œì œ ì¹´ë“œê°€ ì•„ë‹ ë•Œë§Œ DB ì—…ë°ì´íŠ¸
if(!isRetry){
w.reviewCount=(w.reviewCount||0)+1;if(ok)w.correctCount=(w.correctCount||0)+1;
updateMastery(w,ok);
updateInputOutput(w,false,ok); // â˜… í´ë¡œì¦ˆ = ì¸í’‹ ëª¨ë“œ
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResult = updateProductionStatus(w, ok, 'cloze');
if(prodResult.shouldToast) showToast(prodResult.message);
// â˜… FSRS: ì˜¤ë‹µë§Œ ë°”ë¡œ Again(0) ì ìš©, ì •ë‹µì€ rating ì„ íƒ ì‹œ ì ìš©
if(!ok){
  try{Object.assign(w,calcNext(w,0));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);await saveWord(w);}catch(e){console.error(e);}
  updateWrong(w,false);
}else{
  updateWrong(w,true);
  try{await saveWord(w);}catch(e){console.error(e);} // í†µê³„ë§Œ ì €ì¥
}
}
vibrate(ok?10:[50,30,50]);
document.getElementById('cloze-correct').textContent=clozeState.correct;
document.getElementById('cloze-wrong').textContent=clozeState.wrong;
// â˜… ì •ë‹µ: rating bar + 2ì´ˆ í›„ Hard(1) FSRS ì ìš© / ì˜¤ë‹µ: 1.5ì´ˆ í›„ ìë™ ë„˜ê¹€
if(ok){
  document.getElementById('cloze-rating-bar').classList.remove('hidden');
  clozeState.autoNextTimer=setTimeout(()=>{
    skipClozeRating(); // Good(2) FSRS ì ìš©
  },2000);
}else{
  setTimeout(()=>nextCloze(),1500);
}
}catch(e){console.error('selectCloze error:',e);clozeState.answered=false;}
}
// ë¹ˆì¹¸ì±„ìš°ê¸° rating í•¨ìˆ˜ë“¤
async function rateClozeItem(grade){
if(clozeState.autoNextTimer){clearTimeout(clozeState.autoNextTimer);clozeState.autoNextTimer=null;}
const w=clozeState.words[clozeState.idx];
try{Object.assign(w,calcNext(w,grade));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);await saveWord(w);}catch(e){console.error(e);}
document.getElementById('cloze-rating-bar').classList.add('hidden');
nextCloze();
}
function skipClozeRating(){
// â˜… ìŠ¤í‚µ ì‹œ Good(2)ë¡œ FSRS ìë™ ì ìš©
rateClozeItem(2);
}
function nextCloze(){clozeState.idx++;showClozeQ();}
function confirmEndCloze(){if(clozeState.idx<clozeState.words.length||clozeState.retryQueue.length>0||clozeState.finalQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endCloze);else endCloze();}
async function endCloze(){
const ans=clozeState.correct+clozeState.wrong;if(ans===0){showPage(studyStartPage,true);return;}
const acc=Math.round((clozeState.correct/ans)*100);
await saveSession({total:ans,correct:clozeState.correct,wrong:clozeState.wrong,accuracy:acc,mode:'cloze',type:'vocab',duration:Math.round((Date.now()-clozeState.start)/1000),uniqueTotal:clozeState.originalCount,firstTryCorrect:clozeState.firstTryCorrect,firstTryWrong:clozeState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=clozeState.correct;document.getElementById('qc-wrong').textContent=clozeState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(clozeState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=clozeState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// === Collocation í€´ì¦ˆ ===
function startColloc(items,all){
// collocationì´ ìˆê³  ë‹¨ì–´ê°€ í¬í•¨ëœ ê²½ìš°ë§Œ í•„í„°
const valid=items.filter(w=>{
const colls=[w.Key_Collocation,...(w.userCollocations||[])].filter(c=>c&&c.trim());
const regex=new RegExp('\\b'+escapeRegex(w.word)+'\\b','i');
return colls.some(c=>regex.test(c));
});
if(valid.length<5){showToast('âš ï¸ ìœ íš¨í•œ Collocationì´ ìˆëŠ” ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (5ê°œ ì´ìƒ í•„ìš”)');return;}
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...valid]);
collocState={words:shuffled,allWords:all,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:shuffled.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
document.getElementById('colloc-total').textContent=shuffled.length;
document.getElementById('colloc-retry-banner').classList.add('hidden');
showPage('collocation');showCollocQ();
}
function showCollocQ(){
if(collocState.idx>=collocState.words.length){
if(collocState.retryQueue.length>0){
  collocState.words=collocState.retryQueue;collocState.retryQueue=[];collocState.idx=0;collocState.phase='retry';
  document.getElementById('colloc-retry-banner').classList.remove('hidden');
  document.getElementById('colloc-retry-count').textContent=collocState.words.length;
  showToast('ğŸ”„ ì˜¤ë‹µ '+collocState.words.length+'ê°œ ì¬ì¶œì œ!');
  showCollocQ();return;
}
if(collocState.finalQueue.length>0){
  collocState.words=collocState.finalQueue;collocState.finalQueue=[];collocState.idx=0;collocState.phase='final';
  document.getElementById('colloc-retry-count').textContent=collocState.words.length;
  showToast('âš ï¸ ìµœì¢… '+collocState.words.length+'ê°œ ì¬ì¶œì œ!');
  showCollocQ();return;
}
endColloc();return;
}
const w=collocState.words[collocState.idx];
const dw=displayWord(w.word); // í‘œì‹œìš© (HTML)
const dwPlain=displayWord(w.word,true); // ë¹„êµìš© (ìˆœìˆ˜ í…ìŠ¤íŠ¸)
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
const collocUniqueCompleted=collocState.completedKeys?.size||0;
document.getElementById('colloc-progress').style.width=((collocUniqueCompleted/collocState.originalCount)*100)+'%';
document.getElementById('colloc-current').textContent=collocUniqueCompleted;
document.getElementById('colloc-correct').textContent=collocState.correct;
document.getElementById('colloc-wrong').textContent=collocState.wrong;
if(collocState.phase!=='normal')document.getElementById('colloc-retry-count').textContent=collocState.words.length-collocState.idx;
// Collocation ê°€ì ¸ì˜¤ê¸° (ë‹¨ì–´ê°€ í¬í•¨ëœ ê²ƒë§Œ) â˜… escapeRegex ì ìš©
const regex=new RegExp('\\b'+escapeRegex(dwPlain)+'\\b','gi');
const allColls=[w.Key_Collocation,...(w.userCollocations||[])].filter(c=>c&&regex.test(c));
const coll=allColls[Math.floor(Math.random()*allColls.length)];
// ë‹¨ì–´ë¥¼ ë¹ˆì¹¸ìœ¼ë¡œ ëŒ€ì²´
const blanked=coll.replace(regex,'_____');
document.getElementById('colloc-question').innerHTML=blanked;
document.getElementById('colloc-meaning').textContent=getMKO(w)||'';
// ì„ íƒì§€ ìƒì„± (ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ ë¹„êµ, HTMLë¡œ í‘œì‹œ)
const pool=collocState.allWords.filter(x=>x.word!==w.word);
const distPlain=getDistractors(w,pool,4).map(x=>displayWord(x.word,true));
const opts=shuffle([dwPlain,...distPlain]);
document.getElementById('colloc-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectColloc(this,'${o.replace(/'/g,"\\'")}')" data-ans="${o===dwPlain}">${o}</button>`).join('');
collocState.answered=false;collocState.correctAns=dwPlain;
document.getElementById('colloc-next-btn').classList.add('hidden');
}
async function selectColloc(el,selected){
try{
if(collocState.answered)return;collocState.answered=true;
const w=collocState.words[collocState.idx];
const dwPlain=collocState.correctAns;
const ok=selected===dwPlain;
const isRetry=w.isRetry||false; // ì¬ì¶œì œ ì¹´ë“œ ì—¬ë¶€
// â˜… í†µê³„: ì²« ì‹œë„ë§Œ correct/wrong ì¹´ìš´íŠ¸, firstTry ì¹´ìš´íŠ¸
if(ok){
  if(!isRetry){collocState.correct++;collocState.firstTryCorrect++;}
  if(!isRetry&&collocState.completedKeys)collocState.completedKeys.add(w.word); // ê³ ìœ  ì¹´ë“œ ì™„ë£Œ
}else{
  if(!isRetry){collocState.wrong++;collocState.firstTryWrong++;}
  if(collocState.phase==='normal')collocState.retryQueue.push({...w,isRetry:true});
  else if(collocState.phase==='retry')collocState.finalQueue.push({...w,isRetry:true});
  else{updateWrong(w,false);collocState.savedToWrong++;if(!isRetry&&collocState.completedKeys)collocState.completedKeys.add(w.word);} // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ
}
document.querySelectorAll('#colloc-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
// ë¹ˆì¹¸ì— ì •ë‹µ í‘œì‹œ
const qEl=document.getElementById('colloc-question');
qEl.innerHTML=qEl.innerHTML.replace('_____',`<span style="color:${ok?'var(--success)':'var(--danger)'};">${dwPlain}</span>`);
// â˜… ì¬ì¶œì œ ì¹´ë“œê°€ ì•„ë‹ ë•Œë§Œ DB ì—…ë°ì´íŠ¸
if(!isRetry){
w.reviewCount=(w.reviewCount||0)+1;if(ok)w.correctCount=(w.correctCount||0)+1;
updateMastery(w,ok);
updateInputOutput(w,false,ok); // â˜… ì—°ì–´ = ì¸í’‹ ëª¨ë“œ
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResult = updateProductionStatus(w, ok, 'collocation');
if(prodResult.shouldToast) showToast(prodResult.message);
// â˜… FSRS: ì˜¤ë‹µë§Œ ë°”ë¡œ Again(0) ì ìš©, ì •ë‹µì€ rating ì„ íƒ ì‹œ ì ìš©
if(!ok){
  try{Object.assign(w,calcNext(w,0));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);await saveWord(w);}catch(e){console.error(e);}
  updateWrong(w,false);
}else{
  updateWrong(w,true);
  try{await saveWord(w);}catch(e){console.error(e);} // í†µê³„ë§Œ ì €ì¥
}
}
vibrate(ok?10:[50,30,50]);
document.getElementById('colloc-correct').textContent=collocState.correct;
document.getElementById('colloc-wrong').textContent=collocState.wrong;
// â˜… ì •ë‹µ: rating bar + 2ì´ˆ í›„ Hard(1) FSRS ì ìš© / ì˜¤ë‹µ: 1.5ì´ˆ í›„ ìë™ ë„˜ê¹€
if(ok){
  document.getElementById('colloc-rating-bar').classList.remove('hidden');
  collocState.autoNextTimer=setTimeout(()=>{
    skipCollocRating(); // Good(2) FSRS ì ìš©
  },2000);
}else{
  setTimeout(()=>nextColloc(),1500);
}
}catch(e){console.error('selectColloc error:',e);collocState.answered=false;}
}
// â˜… Collocation rating í•¨ìˆ˜ë“¤
async function rateCollocItem(grade){
if(collocState.autoNextTimer){clearTimeout(collocState.autoNextTimer);collocState.autoNextTimer=null;}
const w=collocState.words[collocState.idx];
try{Object.assign(w,calcNext(w,grade));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);await saveWord(w);}catch(e){console.error(e);}
document.getElementById('colloc-rating-bar').classList.add('hidden');
nextColloc();
}
function skipCollocRating(){
// â˜… ìŠ¤í‚µ ì‹œ Good(2)ë¡œ FSRS ìë™ ì ìš©
rateCollocItem(2);
}
function nextColloc(){collocState.idx++;showCollocQ();}
function confirmEndColloc(){if(collocState.idx<collocState.words.length||collocState.retryQueue.length>0||collocState.finalQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endColloc);else endColloc();}
async function endColloc(){
const ans=collocState.correct+collocState.wrong;if(ans===0){showPage(studyStartPage,true);return;}
const acc=Math.round((collocState.correct/ans)*100);
await saveSession({total:ans,correct:collocState.correct,wrong:collocState.wrong,accuracy:acc,mode:'collocation',type:'vocab',duration:Math.round((Date.now()-collocState.start)/1000),uniqueTotal:collocState.originalCount,firstTryCorrect:collocState.firstTryCorrect,firstTryWrong:collocState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=collocState.correct;document.getElementById('qc-wrong').textContent=collocState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(collocState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=collocState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// === ë¦¬ìŠ¤ë‹ í€´ì¦ˆ (í†µí•©) ===
let currentListeningType='vocab'; // 'vocab' | 'phrasal' | 'expr'
let currentDictationType='vocab'; // 'vocab' | 'phrasal' | 'expr'
let listeningState={words:[],all:[],idx:0,correct:0,wrong:0,answered:false,start:0,currentWord:null,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};

function startListening(items,all,type){
type=type||'vocab';
currentListeningType=type;
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...items]);
listeningState={words:shuffled,all:all,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),currentWord:null,type:type,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:shuffled.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
document.getElementById('listening-total').textContent=shuffled.length;
document.getElementById('listening-correct').textContent=0;
document.getElementById('listening-wrong').textContent=0;
document.getElementById('listening-retry-banner').classList.add('hidden');
showPage('listening');showListeningQ();
}

// ê³µí†µ í•¸ë“¤ëŸ¬
function playCurrentListening(){
const item=listeningState.currentWord;
if(!item)return;
let text='';
if(currentListeningType==='vocab')text=displayWord(item.word,true)||item.word;
else if(currentListeningType==='phrasal')text=item.Phrasal_Verb;
else if(currentListeningType==='expr')text=item.Expression;
speakText(text);
}

function confirmEndCurrentListening(){
if(listeningState.idx<listeningState.words.length||listeningState.retryQueue.length>0||listeningState.finalQueue.length>0){
showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endCurrentListening);
}else endCurrentListening();
}

async function endCurrentListening(){
const ans=listeningState.correct+listeningState.wrong;
if(ans===0){showPage(studyStartPage,true);return;}
const acc=Math.round((listeningState.correct/ans)*100);
await saveSession({total:ans,correct:listeningState.correct,wrong:listeningState.wrong,accuracy:acc,mode:'listening',type:currentListeningType,duration:Math.round((Date.now()-listeningState.start)/1000),uniqueTotal:listeningState.originalCount,firstTryCorrect:listeningState.firstTryCorrect,firstTryWrong:listeningState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;
document.getElementById('qc-correct').textContent=listeningState.correct;
document.getElementById('qc-wrong').textContent=listeningState.wrong;
document.getElementById('qc-acc').textContent=acc+'%';
document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// ë¦¬ìŠ¤ë‹ ì•¡ì…˜ ë°” í•¸ë“¤ëŸ¬
async function toggleListeningBookmark(){
const item=listeningState.currentWord;if(!item)return;
if(currentListeningType==='vocab'){
const w=await getWord(item.word);if(w){w.starred=!w.starred;await saveWord(w);updateListeningBookmarkBtn();}
}else if(currentListeningType==='phrasal'){
const p=await getPV(item.Phrasal_Verb);if(p){p.starred=!p.starred;await savePV(p);updateListeningBookmarkBtn();}
}else if(currentListeningType==='expr'){
const e=await getExpr(item.Expression);if(e){e.starred=!e.starred;await saveExpr(e);updateListeningBookmarkBtn();}
}
}
async function updateListeningBookmarkBtn(){
const item=listeningState.currentWord;if(!item)return;
let starred=false;
if(currentListeningType==='vocab'){const w=await getWord(item.word);starred=w?.starred;}
else if(currentListeningType==='phrasal'){const p=await getPV(item.Phrasal_Verb);starred=p?.starred;}
else if(currentListeningType==='expr'){const e=await getExpr(item.Expression);starred=e?.starred;}
const btn=document.getElementById('listening-bookmark-btn');
if(btn)btn.textContent=starred?'â˜…':'â˜†';
}
async function toggleListeningProduction(){
const item=listeningState.currentWord;if(!item)return;
if(currentListeningType==='vocab'){
const w=await getWord(item.word);if(w){w.needsProduction=!w.needsProduction;await saveWord(w);updateListeningProductionBtn();}
}else if(currentListeningType==='phrasal'){
const p=await getPV(item.Phrasal_Verb);if(p){p.needsProduction=!p.needsProduction;await savePV(p);updateListeningProductionBtn();}
}else if(currentListeningType==='expr'){
const e=await getExpr(item.Expression);if(e){e.needsProduction=!e.needsProduction;await saveExpr(e);updateListeningProductionBtn();}
}
}
async function updateListeningProductionBtn(){
const item=listeningState.currentWord;if(!item)return;
let needs=false;
if(currentListeningType==='vocab'){const w=await getWord(item.word);needs=w?.needsProduction;}
else if(currentListeningType==='phrasal'){const p=await getPV(item.Phrasal_Verb);needs=p?.needsProduction;}
else if(currentListeningType==='expr'){const e=await getExpr(item.Expression);needs=e?.needsProduction;}
const btn=document.getElementById('listening-production-btn');
if(btn){btn.textContent=needs?'âœ…ğŸ–Šï¸':'ğŸ–Šï¸';btn.style.background=needs?'var(--success)':'';}
}
function openListeningTagMenu(){showToast('ğŸ·ï¸ íƒœê·¸ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘');}
async function openListeningEdit(){
const item=listeningState.currentWord;if(!item)return;
if(currentListeningType==='vocab')await openEditModal(item.word,'vocab');
else if(currentListeningType==='phrasal')await openEditModal(item.Phrasal_Verb,'phrasal');
else if(currentListeningType==='expr')openExprEditFromItem(item);
}

function playCurrentDictation(){
const item=dictationState.currentWord;
if(!item)return;
let text='';
if(currentDictationType==='vocab')text=displayWord(item.word,true)||item.word;
else if(currentDictationType==='phrasal')text=item.Phrasal_Verb;
else if(currentDictationType==='expr')text=item.Expression;
speakText(text);
}

function showCurrentDictationHint(){
const item=dictationState.currentWord;
if(!item||dictationState.answered)return;
dictationState.hintUsed=true;
let text='';
if(currentDictationType==='vocab')text=displayWord(item.word,true)||item.word;
else if(currentDictationType==='phrasal')text=item.Phrasal_Verb;
else if(currentDictationType==='expr')text=item.Expression;
const words=text.split(' ');
const hint=words.map(w=>w.charAt(0)+'_'.repeat(w.length-1)).join(' ');
document.getElementById('dictation-hint').textContent='ğŸ’¡ '+hint;
document.getElementById('dictation-hint').classList.remove('hidden');
}

function checkCurrentDictation(){
// â˜… í†µí•©ëœ checkDictation ì‚¬ìš© (dictationState.typeìœ¼ë¡œ ë¶„ê¸°)
checkDictation();
}

function confirmEndCurrentDictation(){
if(dictationState.idx<dictationState.words.length){
showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endCurrentDictation);
}else endCurrentDictation();
}

async function endCurrentDictation(){
const ans=dictationState.correct+dictationState.wrong;
if(ans===0){showPage(studyStartPage,true);return;}
const acc=Math.round((dictationState.correct/ans)*100);
await saveSession({total:ans,correct:dictationState.correct,wrong:dictationState.wrong,accuracy:acc,mode:'dictation',type:currentDictationType,duration:Math.round((Date.now()-dictationState.start)/1000),uniqueTotal:dictationState.originalCount,firstTryCorrect:dictationState.firstTryCorrect,firstTryWrong:dictationState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;
document.getElementById('qc-correct').textContent=dictationState.correct;
document.getElementById('qc-wrong').textContent=dictationState.wrong;
document.getElementById('qc-acc').textContent=acc+'%';
document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// ì–´íœ˜ ë¦¬ìŠ¤ë‹
function showListeningQ(){
// â˜… ì¬ì¶œì œ ë¡œì§
if(listeningState.idx>=listeningState.words.length){
  if(listeningState.retryQueue.length>0&&listeningState.phase==='normal'){
    listeningState.words=[...listeningState.retryQueue];listeningState.retryQueue=[];listeningState.idx=0;listeningState.phase='retry';
    document.getElementById('listening-retry-banner').classList.remove('hidden');
    document.getElementById('listening-retry-count').textContent=listeningState.words.length;
    showToast('ğŸ”„ ì˜¤ë‹µ '+listeningState.words.length+'ê°œ ì¬ì¶œì œ!');
  }else if(listeningState.finalQueue.length>0&&listeningState.phase==='retry'){
    listeningState.words=[...listeningState.finalQueue];listeningState.finalQueue=[];listeningState.idx=0;listeningState.phase='final';
    document.getElementById('listening-retry-count').textContent=listeningState.words.length;
    showToast('âš ï¸ ìµœì¢… '+listeningState.words.length+'ê°œ ì¬ì¶œì œ!');
  }else{endCurrentListening();return;}
}
const item=listeningState.words[listeningState.idx];
// â˜… íƒ€ì…ë³„ ìœ íš¨ì„± ì²´í¬
const itemKey = currentListeningType==='vocab' ? item?.word : 
                currentListeningType==='phrasal' ? item?.Phrasal_Verb : item?.Expression;
if(!item||!itemKey){
  console.warn('Invalid listening item, skipping:',item,listeningState.idx);
  return safeSkipInvalid(listeningState, showListeningQ, endCurrentListening);
}
listeningState.skipCount=0; // ì •ìƒ ì•„ì´í…œì´ë©´ ì¹´ìš´í„° ë¦¬ì…‹
listeningState.currentWord=item;
listeningState.answered=false;
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
const listeningUniqueCompleted=listeningState.completedKeys?.size||0;
document.getElementById('listening-progress').style.width=(listeningUniqueCompleted/listeningState.originalCount)*100+'%';
document.getElementById('listening-current').textContent=listeningUniqueCompleted;
document.getElementById('listening-total').textContent=listeningState.originalCount;
if(listeningState.phase!=='normal')document.getElementById('listening-retry-count').textContent=listeningState.words.length-listeningState.idx;
document.getElementById('listening-word').textContent='';
document.getElementById('listening-word').classList.add('hidden');
document.getElementById('listening-play-btn').disabled=false;
// â˜… ì„ íƒì§€ ìƒì„± - íƒ€ì…ë³„ ì²˜ë¦¬
const correctMeaning=getMKO(item)||getMEN(item);
const pool=listeningState.all.filter(x=>{
  // íƒ€ì…ë³„ í‚¤ ë¹„êµ
  const xKey = currentListeningType==='vocab' ? x.word : 
               currentListeningType==='phrasal' ? x.Phrasal_Verb : x.Expression;
  if(xKey===itemKey)return false;
  const m=getMKO(x);
  if(!m||m===correctMeaning)return false;
  return true;
});
// â˜… íƒ€ì…ë³„ distractor í•¨ìˆ˜ ì‚¬ìš©
let distractors;
if(currentListeningType==='vocab') distractors=getDistractors(item,pool,4);
else if(currentListeningType==='phrasal') distractors=getPVDistractors(item,pool,4);
else distractors=getExprDistractors(item,pool,4);
// ì¤‘ë³µ ì˜ë¯¸ ì œê±°
const usedMeanings=new Set([correctMeaning]);
const uniqueDistractors=distractors.filter(d=>{
  const m=getMKO(d);
  if(usedMeanings.has(m))return false;
  usedMeanings.add(m);
  return true;
}).slice(0,4);
const allOpts=shuffle([item,...uniqueDistractors]);
console.log('[Listening]',{type:currentListeningType,key:itemKey,distractorCount:uniqueDistractors.length});
document.getElementById('listening-options').innerHTML=allOpts.map((o,i)=>{
const meaning=getMKO(o)||getMEN(o);
// â˜… íƒ€ì…ë³„ ì •ë‹µ ë¹„êµ
const oKey = currentListeningType==='vocab' ? o.word : 
             currentListeningType==='phrasal' ? o.Phrasal_Verb : o.Expression;
const isCorrect=oKey===itemKey;
return `<div class="quiz-option" onclick="selectListeningOption(this,${isCorrect})">${meaning}</div>`;
}).join('');
// ì•¡ì…˜ ë°” ì—…ë°ì´íŠ¸
updateListeningBookmarkBtn();updateListeningProductionBtn();
document.getElementById('listening-rating-bar').classList.add('hidden');
document.getElementById('listening-next-btn').classList.add('hidden');
// ìë™ ì¬ìƒ
setTimeout(()=>playCurrentListening(),500);
}

async function selectListeningOption(el,isCorrect){
if(listeningState.answered)return;
listeningState.answered=true;
const item=listeningState.currentWord;
const opts=document.querySelectorAll('#listening-options .quiz-option');
opts.forEach(o=>{o.style.pointerEvents='none';});
el.classList.add(isCorrect?'correct':'wrong');
if(!isCorrect){
opts.forEach(o=>{
// ì •ë‹µ í‘œì‹œ
const meaning=getMKO(item)||getMEN(item);
if(o.textContent===meaning)o.classList.add('correct');
});
}
// ë‹¨ì–´ í‘œì‹œ
let wordText='';
if(currentListeningType==='vocab')wordText=displayWord(item.word)||item.word;
else if(currentListeningType==='phrasal')wordText=item.Phrasal_Verb;
else if(currentListeningType==='expr')wordText=item.Expression;
document.getElementById('listening-word').innerHTML=wordText;
document.getElementById('listening-word').classList.remove('hidden');

const isRetry=item.isRetry||false; // ì¬ì¶œì œ ì¹´ë“œ ì—¬ë¶€
// â˜… í†µê³„: ì²« ì‹œë„ë§Œ correct/wrong ì¹´ìš´íŠ¸, firstTry ì¹´ìš´íŠ¸
// ê³ ìœ  ì¹´ë“œ í‚¤
const itemKey2=currentListeningType==='vocab'?item.word:currentListeningType==='phrasal'?item.Phrasal_Verb:item.Expression;
if(isCorrect){
  if(!isRetry){listeningState.correct++;listeningState.firstTryCorrect++;}
  if(!isRetry&&listeningState.completedKeys)listeningState.completedKeys.add(itemKey2); // ê³ ìœ  ì¹´ë“œ ì™„ë£Œ
}else{
  if(!isRetry){listeningState.wrong++;listeningState.firstTryWrong++;}
  // ì¬ì¶œì œ íì— ì¶”ê°€
  if(listeningState.phase==='normal')listeningState.retryQueue.push({...item,isRetry:true});
  else if(listeningState.phase==='retry')listeningState.finalQueue.push({...item,isRetry:true});
  else{listeningState.savedToWrong++;if(!isRetry&&listeningState.completedKeys)listeningState.completedKeys.add(itemKey2);} // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ
}

// â˜… ì¬ì¶œì œê°€ ì•„ë‹ ë•Œë§Œ DB ì—…ë°ì´íŠ¸
if(!isRetry){
// â˜… ì •ë‹µ: í†µê³„ ì €ì¥ + FSRSëŠ” ratingì—ì„œ ì ìš©
// â˜… ì˜¤ë‹µ: í†µê³„ ì €ì¥ + FSRS ì¦‰ì‹œ Again(0) ì ìš©
if(currentListeningType==='vocab'){
const w=await getWord(item.word);
if(w){
  w.reviewCount=(w.reviewCount||0)+1;
  if(isCorrect){
    w.correctCount=(w.correctCount||0)+1;
    updateMastery(w,true);
    updateWrong(w,true);
    updateInputOutput(w,false,true); // â˜… ë¦¬ìŠ¤ë‹ = ì¸í’‹ ëª¨ë“œ
    // â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
    const prodResult = updateProductionStatus(w, true, 'listening');
    if(prodResult.shouldToast) showToast(prodResult.message);
    try{await saveWord(w);}catch(e){} // í†µê³„ë§Œ ì €ì¥
  }else{
    updateProductionStatus(w, false, 'listening');
    updateInputOutput(w,false,false); // â˜… ë¦¬ìŠ¤ë‹ ì˜¤ë‹µ
    updateMastery(w,false);
    updateWrong(w,false);
    try{Object.assign(w,calcNext(w,0));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);await saveWord(w);}catch(e){} // ì˜¤ë‹µì€ FSRS ë°”ë¡œ ì ìš©
  }
}
}else if(currentListeningType==='phrasal'){
const pv=await getPV(item.Phrasal_Verb);
if(pv){
  pv.reviewCount=(pv.reviewCount||0)+1;
  if(isCorrect){
    pv.correctCount=(pv.correctCount||0)+1;
    updateMastery(pv,true);
    updateWrong(pv,true);
    updateInputOutput(pv,false,true); // â˜… ë¦¬ìŠ¤ë‹ = ì¸í’‹ ëª¨ë“œ
    // â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
    const prodResult = updateProductionStatus(pv, true, 'listening');
    if(prodResult.shouldToast) showToast(prodResult.message);
    try{await savePV(pv);}catch(e){}
  }else{
    updateProductionStatus(pv, false, 'listening');
    updateMastery(pv,false);
    updateWrong(pv,false);
    updateInputOutput(pv,false,false); // â˜… ë¦¬ìŠ¤ë‹ ì˜¤ë‹µ
    try{Object.assign(pv,calcNext(pv,0));if(pv.isLeech)showToast('ğŸŒ Leech: '+pv.Phrasal_Verb);await savePV(pv);}catch(e){}
  }
}
}else if(currentListeningType==='expr'){
const e=await getExpr(item.Expression);
if(e){
  e.reviewCount=(e.reviewCount||0)+1;
  if(isCorrect){
    e.correctCount=(e.correctCount||0)+1;
    updateMastery(e,true);
    updateWrong(e,true);
    updateInputOutput(e,false,true); // â˜… ë¦¬ìŠ¤ë‹ = ì¸í’‹ ëª¨ë“œ
    try{await saveExpr(e);}catch(e2){}
  }else{
    updateMastery(e,false);
    updateWrong(e,false);
    updateInputOutput(e,false,false); // â˜… ë¦¬ìŠ¤ë‹ ì˜¤ë‹µ
    try{Object.assign(e,calcNext(e,0));if(e.isLeech)showToast('ğŸŒ Leech: '+e.Expression);await saveExpr(e);}catch(e2){}
  }
}
}
} // if(!isRetry)

vibrate(isCorrect?10:[50,30,50]);
document.getElementById('listening-correct').textContent=listeningState.correct;
document.getElementById('listening-wrong').textContent=listeningState.wrong;

if(isCorrect){
// ì •ë‹µ ì‹œ ë‚œì´ë„ í‰ê°€ í‘œì‹œ + 2ì´ˆ í›„ ìë™ ë‹¤ìŒ
showListeningRating();
}else{
// ì˜¤ë‹µ ì‹œ 1.5ì´ˆ í›„ ìë™ ë‹¤ìŒ (ë²„íŠ¼ ì—†ìŒ)
setTimeout(()=>nextListeningQ(),1500);
}
}

// ë¦¬ìŠ¤ë‹ ë‚œì´ë„ í‰ê°€ í‘œì‹œ
let listeningRatingTimer=null;
function showListeningRating(){
// â˜… ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸ ì´ˆê¸°í™”
listeningState.gradeFinalized=false;
const bar=document.getElementById('listening-rating-bar');
bar.classList.remove('hidden');
// â˜… 2ì´ˆ í›„ ìë™ìœ¼ë¡œ Hard(1) FSRS ì ìš© (ì°ê¸° ê°€ëŠ¥ì„± ê³ ë ¤)
if(listeningRatingTimer)clearTimeout(listeningRatingTimer);
listeningRatingTimer=setTimeout(()=>{
  if(!bar.classList.contains('hidden')){
    skipListeningRating(); // Good(2) FSRS ì ìš©
  }
},2000);
}

// ë¦¬ìŠ¤ë‹ ë‚œì´ë„ í‰ê°€
async function rateListeningItem(grade){
try{
// â˜… ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
if(listeningState.gradeFinalized)return;
listeningState.gradeFinalized=true;
// â˜… ìë™ íƒ€ì´ë¨¸ í´ë¦¬ì–´
if(listeningRatingTimer){clearTimeout(listeningRatingTimer);listeningRatingTimer=null;}
const item=listeningState.currentWord;
// â˜… í†µê³„ëŠ” ì´ë¯¸ selectListeningOptionì—ì„œ ì €ì¥ë¨, ì—¬ê¸°ì„œëŠ” FSRSë§Œ ì ìš©
if(currentListeningType==='vocab'){
const w=await getWord(item.word);
if(w){Object.assign(w,calcNext(w,grade));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);await saveWord(w);}
}else if(currentListeningType==='phrasal'){
const pv=await getPV(item.Phrasal_Verb);
if(pv){Object.assign(pv,calcNext(pv,grade));if(pv.isLeech)showToast('ğŸŒ Leech: '+pv.Phrasal_Verb);await savePV(pv);}
}else if(currentListeningType==='expr'){
const e=await getExpr(item.Expression);
if(e){Object.assign(e,calcNext(e,grade));if(e.isLeech)showToast('ğŸŒ Leech: '+e.Expression);await saveExpr(e);}
}
document.getElementById('listening-rating-bar').classList.add('hidden');
nextListeningQ();
}catch(e){console.error('rateListeningItem error:',e);nextListeningQ();}
}

// ë¦¬ìŠ¤ë‹ ê±´ë„ˆë›°ê¸° - Hard(1) FSRS ìë™ ì ìš©
function skipListeningRating(){
// â˜… ìŠ¤í‚µ ì‹œ Good(2)ë¡œ FSRS ìë™ ì ìš©
rateListeningItem(2);
}

// ë‹¤ìŒ ë¦¬ìŠ¤ë‹ ë¬¸ì œ
function nextListeningQ(){
document.getElementById('listening-rating-bar').classList.add('hidden');
document.getElementById('listening-next-btn').classList.add('hidden');
listeningState.idx++;
// â˜… ëª¨ë“  íƒ€ì…ì—ì„œ í†µí•© showListeningQ ì‚¬ìš©
showListeningQ();
}

function speakText(text){
if('speechSynthesis' in window){
window.speechSynthesis.cancel();
const u=new SpeechSynthesisUtterance(text);
u.lang='en-US';u.rate=0.9;
window.speechSynthesis.speak(u);
}
}

// === ë°›ì•„ì“°ê¸° (Dictation) ===
let dictationState={words:[],idx:0,correct:0,wrong:0,answered:false,hintUsed:false,start:0,currentWord:null,originalCount:0,completed:0,firstTryCorrect:0,firstTryWrong:0};
function startDictation(items,all,type){
type=type||'vocab';
currentDictationType=type;
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...items]);
dictationState={words:shuffled,allWords:all,idx:0,correct:0,wrong:0,answered:false,hintUsed:false,start:Date.now(),currentWord:null,type:type,originalCount:shuffled.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('dictation-total').textContent=shuffled.length;
document.getElementById('dictation-current').textContent='0';
document.getElementById('dictation-correct').textContent=0;
document.getElementById('dictation-wrong').textContent=0;
showPage('dictation');showDictationQ();
}
function showDictationQ(){
const item=dictationState.words[dictationState.idx];
if(!item){endCurrentDictation();return;}
dictationState.currentWord=item;
dictationState.answered=false;
dictationState.hintUsed=false;
// ì§„í–‰ë°”: completed/originalCount ê¸°ì¤€
document.getElementById('dictation-progress').style.width=(dictationState.completed/dictationState.originalCount)*100+'%';
document.getElementById('dictation-current').textContent=dictationState.completed;
document.getElementById('dictation-input').value='';
document.getElementById('dictation-input').disabled=false;
document.getElementById('dictation-input').classList.remove('correct','wrong');
document.getElementById('dictation-answer').classList.add('hidden');
document.getElementById('dictation-hint').classList.add('hidden');
document.getElementById('dictation-submit-btn').textContent='í™•ì¸';
// ìë™ ì¬ìƒ
setTimeout(()=>playCurrentDictation(),500);
}
function playDictationWord(){
const item=dictationState.words[dictationState.idx];
if(!item)return;
const type=dictationState.type||'vocab';
let word;
if(type==='vocab')word=displayWord(item.word)||item.word;
else if(type==='phrasal')word=item.Phrasal_Verb;
else word=item.Expression;
speakText(word);
}
function showDictationHint(){
const item=dictationState.words[dictationState.idx];
if(!item||dictationState.answered)return;
dictationState.hintUsed=true;
const type=dictationState.type||'vocab';
let word;
if(type==='vocab')word=displayWord(item.word)||item.word;
else if(type==='phrasal')word=item.Phrasal_Verb;
else word=item.Expression;
const hint=word.charAt(0)+'_'.repeat(word.length-1)+` (${word.length}ê¸€ì)`;
document.getElementById('dictation-hint').textContent='ğŸ’¡ '+hint;
document.getElementById('dictation-hint').classList.remove('hidden');
}
async function checkDictation(){
if(dictationState.answered){dictationState.idx++;showDictationQ();return;}
const item=dictationState.words[dictationState.idx];
const type=dictationState.type||'vocab';
// â˜… íƒ€ì…ë³„ ì •ë‹µ ì¶”ì¶œ
let correctPlain,correctDisplay;
if(type==='vocab'){
  correctPlain=normalizeAnswer(displayWord(item.word,true));
  correctDisplay=displayWord(item.word);
}else if(type==='phrasal'){
  correctPlain=normalizeAnswer(item.Phrasal_Verb);
  correctDisplay=item.Phrasal_Verb;
}else{
  correctPlain=normalizeAnswer(item.Expression);
  correctDisplay=item.Expression;
}
const input=normalizeAnswer(document.getElementById('dictation-input').value);
const ok=input===correctPlain;
dictationState.answered=true;
document.getElementById('dictation-input').disabled=true;
const ansEl=document.getElementById('dictation-answer');
ansEl.classList.remove('hidden');
if(ok){
dictationState.correct++;
dictationState.completed++;
dictationState.firstTryCorrect++;
document.getElementById('dictation-input').classList.add('correct');
ansEl.innerHTML='âœ… ì •ë‹µ! <strong>'+correctDisplay+'</strong>';
ansEl.style.background='rgba(34,197,94,.2)';
ansEl.style.color='var(--success)';
}else{
dictationState.wrong++;
dictationState.completed++;
dictationState.firstTryWrong++;
document.getElementById('dictation-input').classList.add('wrong');
ansEl.innerHTML='âŒ ì˜¤ë‹µ<br><span style="font-size:20px;font-weight:700">'+correctDisplay+'</span><br><span style="font-size:14px;opacity:0.8">'+getMKO(item)+'</span>';
ansEl.style.background='rgba(239,68,68,.2)';
ansEl.style.color='var(--danger)';
}
// â˜… íƒ€ì…ë³„ FSRS ì—…ë°ì´íŠ¸
if(type==='vocab'){
const w=await getWord(item.word);
if(w){
w.reviewCount=(w.reviewCount||0)+1;
if(ok)w.correctCount=(w.correctCount||0)+1;
updateMastery(w,ok);
updateInputOutput(w,true,ok&&!dictationState.hintUsed); // â˜… ë°›ì•„ì“°ê¸° = ì•„ì›ƒí’‹ ëª¨ë“œ
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResultW = updateProductionStatus(w, ok&&!dictationState.hintUsed, 'dictation');
if(prodResultW.shouldToast) showToast(prodResultW.message);
if(ok){updateWrong(w,true);Object.assign(w,calcNext(w,dictationState.hintUsed?2:3));}
else{updateWrong(w,false);Object.assign(w,calcNext(w,0));if(w.isLeech)showToast('ğŸŒ Leech: '+w.word);}
try{await saveWord(w);}catch(e){console.error(e);}
}
}else if(type==='phrasal'){
const p=await getPV(item.Phrasal_Verb);
if(p){
p.reviewCount=(p.reviewCount||0)+1;
if(ok)p.correctCount=(p.correctCount||0)+1;
updateMastery(p,ok);
updateInputOutput(p,true,ok&&!dictationState.hintUsed); // â˜… ë°›ì•„ì“°ê¸° = ì•„ì›ƒí’‹ ëª¨ë“œ
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResultP = updateProductionStatus(p, ok&&!dictationState.hintUsed, 'dictation');
if(prodResultP.shouldToast) showToast(prodResultP.message);
if(ok){updateWrong(p,true);Object.assign(p,calcNext(p,dictationState.hintUsed?2:3));}
else{updateWrong(p,false);Object.assign(p,calcNext(p,0));if(p.isLeech)showToast('ğŸŒ Leech: '+p.Phrasal_Verb);}
try{await savePV(p);}catch(e){console.error(e);}
}
}else{
const e=await getExpr(item.Expression);
if(e){
e.reviewCount=(e.reviewCount||0)+1;
if(ok)e.correctCount=(e.correctCount||0)+1;
updateMastery(e,ok);
updateInputOutput(e,true,ok&&!dictationState.hintUsed); // â˜… ë°›ì•„ì“°ê¸° = ì•„ì›ƒí’‹ ëª¨ë“œ
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResultE = updateProductionStatus(e, ok&&!dictationState.hintUsed, 'dictation');
if(prodResultE.shouldToast) showToast(prodResultE.message);
if(ok){updateWrong(e,true);Object.assign(e,calcNext(e,dictationState.hintUsed?2:3));}
else{updateWrong(e,false);Object.assign(e,calcNext(e,0));if(e.isLeech)showToast('ğŸŒ Leech: '+e.Expression);}
try{await saveExpr(e);}catch(e2){console.error(e2);}
}
}
vibrate(ok?10:[50,30,50]);
document.getElementById('dictation-correct').textContent=dictationState.correct;
document.getElementById('dictation-wrong').textContent=dictationState.wrong;
document.getElementById('dictation-submit-btn').textContent='ë‹¤ìŒ â†’';
}
function confirmEndDictation(){if(dictationState.idx<dictationState.words.length)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endDictation);else endDictation();}
async function endDictation(){
const ans=dictationState.correct+dictationState.wrong;if(ans===0){showPage(studyStartPage,true);return;}
const acc=Math.round((dictationState.correct/ans)*100);
const type=dictationState.type||'vocab';
await saveSession({total:ans,correct:dictationState.correct,wrong:dictationState.wrong,accuracy:acc,mode:'dictation',type:type,duration:Math.round((Date.now()-dictationState.start)/1000),uniqueTotal:dictationState.originalCount,firstTryCorrect:dictationState.firstTryCorrect,firstTryWrong:dictationState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=dictationState.correct;document.getElementById('qc-wrong').textContent=dictationState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
document.getElementById('dictation-input')?.addEventListener('keypress',e=>{if(e.key==='Enter')checkCurrentDictation();});

// === PV í•™ìŠµ ===
async function startPVStudySession(){
const p=await getAllPV();if(!p.length){showToast('ğŸ“¤ ë¨¼ì € êµ¬ë™ì‚¬ DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
const count=parseInt(document.getElementById('pv-study-count').value),order=document.getElementById('option-order').value;
// â˜… ë‹¤ì¤‘ ì„ íƒ í•„í„° ì ìš©
const masteryF=getMultiChip('pv-filter-mastery');
const cefrF=getMultiChip('pv-filter-cefr');
const priorityF=getMultiChip('pv-filter-priority');
const formalityF=getMultiChip('pv-filter-formality');
const currencyF=getMultiChip('pv-filter-currency');
const mediumF=getMultiChip('pv-filter-medium');
const tagF=getMultiFilterValue('pv-filter-tag');
const catVal=document.getElementById('pv-filter-cat')?.value||'all';
const now=new Date();
const today=now.toDateString();
let filtered=p.filter(x=>{
if(!checkMasteryFilter(x,masteryF))return false;
if(!checkMultiFilter(x.CEFR||'B1',cefrF))return false;
if(!checkMultiFilter(x.Priority||'P2',priorityF))return false;
if(!checkMultiFilter(x.Formality||'Neutral',formalityF))return false;
if(!checkMultiFilter(x.Currency||'Current',currencyF))return false;
if(!checkMultiFilter(x.Medium||'Both',mediumF))return false;
if(!checkTagFilter(x.tags||[],tagF))return false;
if(catVal!=='all'&&x.Category!==catVal)return false;
return true;
});
if(!filtered.length){showToast('âš ï¸ í•™ìŠµí•  êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
// â˜… ì˜¤ëŠ˜ ì¶”ê°€ â†’ ê¸°íƒ€ ìƒˆ ë‹¨ì–´ â†’ ê¸°ì¡´ í•™ìŠµ
const todayAdded=shuffle(filtered.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today));
const otherNew=shuffle(filtered.filter(x=>(!x.addedDate||new Date(x.addedDate).toDateString()!==today)&&(!x.reviewCount||x.reviewCount===0)));
const oldW=shuffle(filtered.filter(x=>x.reviewCount>0));
let sel;
if(order==='random'){
  sel=[...todayAdded,...otherNew,...oldW].slice(0,count);
}else if(order==='weak'){
  sel=[...todayAdded,...otherNew,...oldW].sort((a,b)=>getWeaknessScore(a)-getWeaknessScore(b)).slice(0,count);
}else{
  const dueW=filtered.filter(x=>x.reviewCount>0&&x.nextReview&&new Date(x.nextReview)<=now);
  sel=[...todayAdded,...otherNew,...sortByFSRSPriority(dueW,now)].slice(0,count);
}
if(!sel.length){showToast('âš ï¸ í•™ìŠµí•  êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
const mode=document.querySelector('#study-phrasal .mode-card.active')?.dataset.mode||'pv-flashcard';
// ì˜¤ëŠ˜ ì¶”ê°€ í† ìŠ¤íŠ¸
if(todayAdded.length>0)showToast(`ğŸ†• ì˜¤ëŠ˜ ì¶”ê°€ ${Math.min(todayAdded.length,count)}ê°œ í¬í•¨`);
// â˜… ì˜¤ë‹µ ìë™ í¬í•¨
const wrongAutoEnabled=localStorage.getItem('wrongAuto')!=='false';
if(wrongAutoEnabled&&mode==='pv-flashcard'){
const wrongLimit=parseInt(localStorage.getItem('wrongLimit')||'5');
const wrongBonus=Math.min(wrongLimit,Math.floor(count/5));
if(wrongBonus>0){
const wrongPVs=p.filter(x=>isWrong(x)&&!sel.includes(x));
const wrongToAdd=shuffle(wrongPVs).slice(0,wrongBonus);
if(wrongToAdd.length>0){
wrongToAdd.forEach(w=>{
const insertIdx=Math.floor(Math.random()*(sel.length+1));
sel.splice(insertIdx,0,w);
});
showToast(`ğŸ“ ì˜¤ë‹µ ${wrongToAdd.length}ê°œ í¬í•¨`);
}
}
}
if(mode==='pv-flashcard')startFC(sel,p,'phrasal');
else if(mode==='pv-particle'){const v=sel.filter(x=>x.Particle?.trim());if(v.length<5){showToast('âš ï¸ Particleì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}startPVP(v,p);}
else if(mode==='pv-meaning'){const v=sel.filter(x=>getMKO(x));if(v.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}startPVQ(v,p,'meaning');}
else if(mode==='pv-reverse'){const v=sel.filter(x=>getMKO(x));if(v.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}startPVQ(v,p,'reverse');}
else if(mode==='pv-listening')startListening(sel,p,'phrasal');
else if(mode==='pv-dictation')startDictation(sel,p,'phrasal');
}
// PV Particle
function startPVP(items,all){
const v=items.filter(x=>x.Particle?.trim());if(v.length<5){showToast('âš ï¸ Particleì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...v]);
pvState={words:shuffled,allWords:all||items,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),mode:'particle',retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:shuffled.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('pvp-total').textContent=shuffled.length;document.getElementById('pvp-retry-banner').classList.add('hidden');
showPage('pv-particle');showPVPQ();updateStreak();
}
function showPVPQ(){
if(pvState.idx>=pvState.words.length){
  if(pvState.retryQueue.length>0&&pvState.phase==='normal'){pvState.words=[...pvState.retryQueue];pvState.retryQueue=[];pvState.idx=0;pvState.phase='retry';document.getElementById('pvp-retry-banner').classList.remove('hidden');document.getElementById('pvp-retry-count').textContent=pvState.words.length;showToast('ğŸ”„ ì˜¤ë‹µ '+pvState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else if(pvState.finalQueue.length>0&&pvState.phase==='retry'){pvState.words=[...pvState.finalQueue];pvState.finalQueue=[];pvState.idx=0;pvState.phase='final';document.getElementById('pvp-retry-count').textContent=pvState.words.length;showToast('âš ï¸ ìµœì¢… '+pvState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else{endPVQuiz();return;}
}
const pv=pvState.words[pvState.idx];if(!pv)return;
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
document.getElementById('pvp-progress').style.width=(pvState.completed/pvState.originalCount)*100+'%';
document.getElementById('pvp-current').textContent=pvState.completed;document.getElementById('pvp-total').textContent=pvState.originalCount;
document.getElementById('pvp-correct').textContent=pvState.correct;document.getElementById('pvp-wrong').textContent=pvState.wrong;
if(pvState.phase!=='normal')document.getElementById('pvp-retry-count').textContent=pvState.words.length-pvState.idx;
document.getElementById('pvp-meaning').textContent=getMKO(pv)||'';
const base=pv.Base_Verb||pv.Phrasal_Verb?.split(' ')[0]||'';
document.getElementById('pvp-question').innerHTML=base+' + <span class="blank-word">?</span>';
const cP=(pv.Particle||'').trim();const wP=shuffle(PARTICLES.filter(x=>x!==cP)).slice(0,4);
const opts=shuffle([cP,...wP]);
document.getElementById('pvp-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectPVP(this)" data-ans="${o===cP}">${o}</button>`).join('');
pvState.answered=false;pvState.correctAns=cP;document.getElementById('pvp-next-btn').classList.add('hidden');
document.getElementById('pvp-example').classList.add('hidden');
document.getElementById('pvp-rating-bar').classList.add('hidden');
updatePVPBookmarkBtn();updatePVPProductionBtn();
}
async function selectPVP(el){
try{
if(pvState.answered)return;pvState.answered=true;
const ok=el.dataset.ans==='true';
const pv=pvState.words[pvState.idx];
const isRetry=pv.isRetry||false;
// â˜… í†µê³„: ì²« ì‹œë„ë§Œ correct/wrong ì¹´ìš´íŠ¸, firstTry ì¹´ìš´íŠ¸
if(ok){
  if(!isRetry){pvState.correct++;pvState.firstTryCorrect++;}
  pvState.completed++; // ì •ë‹µ = ì¹´ë“œ ì™„ë£Œ
}else{
  if(!isRetry){pvState.wrong++;pvState.firstTryWrong++;}
  if(pvState.phase==='normal')pvState.retryQueue.push({...pv,isRetry:true});
  else if(pvState.phase==='retry')pvState.finalQueue.push({...pv,isRetry:true});
  else{updateWrong(pv,false);pvState.savedToWrong++;pvState.completed++;} // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ
}
document.querySelectorAll('#pvp-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
const blank=document.querySelector('#page-pv-particle .blank-word');if(blank){blank.textContent=pvState.correctAns;blank.style.borderBottom='none';blank.style.color=ok?'var(--success)':'var(--danger)';}
if(!isRetry){
pv.reviewCount=(pv.reviewCount||0)+1;if(ok)pv.correctCount=(pv.correctCount||0)+1;
updateMastery(pv,ok);
updateInputOutput(pv,false,ok); // â˜… PV í€´ì¦ˆ = ì¸í’‹ ëª¨ë“œ
// â˜… FSRS: ì˜¤ë‹µë§Œ ë°”ë¡œ Again(0) ì ìš©, ì •ë‹µì€ rating ì„ íƒ ì‹œ ì ìš©
if(!ok){
  try{Object.assign(pv,calcNext(pv,0));if(pv.isLeech)showToast('ğŸŒ Leech: '+pv.Phrasal_Verb);await savePV(pv);}catch(e){console.error(e);}
  updateWrong(pv,false);
}else{
  updateWrong(pv,true);
  try{await savePV(pv);}catch(e){console.error(e);} // í†µê³„ë§Œ ì €ì¥
}
}
vibrate(ok?10:[50,30,50]);
document.getElementById('pvp-correct').textContent=pvState.correct;document.getElementById('pvp-wrong').textContent=pvState.wrong;
const pvEx=getEx(pv);if(pvEx){document.getElementById('pvp-example').textContent=pvEx;document.getElementById('pvp-example').classList.remove('hidden');}
// â˜… ì •ë‹µ: rating bar + 2ì´ˆ í›„ Hard(1) FSRS ì ìš© / ì˜¤ë‹µ: 1.5ì´ˆ í›„ ìë™ ë„˜ê¹€
if(ok){
document.getElementById('pvp-rating-bar').classList.remove('hidden');
pvState.autoNextTimer=setTimeout(()=>{
  skipPVPRating(); // Good(2) FSRS ì ìš©
},2000);
}else{
setTimeout(()=>nextPVP(),1500);
}
}catch(e){console.error('selectPVP error:',e);pvState.answered=false;}
}
async function ratePVPItem(grade){
try{
// ìë™ ë„˜ê¹€ íƒ€ì´ë¨¸ ì·¨ì†Œ
if(pvState.autoNextTimer){clearTimeout(pvState.autoNextTimer);pvState.autoNextTimer=null;}
const pv=pvState.words[pvState.idx];
// â˜… í†µê³„ëŠ” ì´ë¯¸ selectPVPì—ì„œ ì €ì¥ë¨, ì—¬ê¸°ì„œëŠ” FSRSë§Œ ì ìš©
try{Object.assign(pv,calcNext(pv,grade));if(pv.isLeech)showToast('ğŸŒ Leech: '+pv.Phrasal_Verb);await savePV(pv);}catch(e){console.error(e);}
document.getElementById('pvp-rating-bar').classList.add('hidden');
nextPVP();
}catch(e){console.error('ratePVPItem error:',e);nextPVP();}
}
function skipPVPRating(){
// â˜… ìŠ¤í‚µ ì‹œ Good(2)ë¡œ FSRS ìë™ ì ìš©
ratePVPItem(2);
}
function nextPVP(){pvState.idx++;showPVPQ();}

// PV Quiz
function startPVQ(items,all,mode){
const m=items.filter(x=>getMKO(x));if(m.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
// â˜… ë§¤ë²ˆ ì…”í”Œí•˜ì—¬ ìˆœì„œ ë¬´ì‘ìœ„í™”
const shuffled=shuffle([...m]);
pvState={words:shuffled,allWords:all||items,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),mode,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:shuffled.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('pvq-total').textContent=shuffled.length;document.getElementById('pvq-retry-banner').classList.add('hidden');
showPage('pv-quiz');showPVQQ();updateStreak();
}
function showPVQQ(){
if(pvState.idx>=pvState.words.length){
  if(pvState.retryQueue.length>0&&pvState.phase==='normal'){pvState.words=[...pvState.retryQueue];pvState.retryQueue=[];pvState.idx=0;pvState.phase='retry';document.getElementById('pvq-retry-banner').classList.remove('hidden');document.getElementById('pvq-retry-count').textContent=pvState.words.length;showToast('ğŸ”„ ì˜¤ë‹µ '+pvState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else if(pvState.finalQueue.length>0&&pvState.phase==='retry'){pvState.words=[...pvState.finalQueue];pvState.finalQueue=[];pvState.idx=0;pvState.phase='final';document.getElementById('pvq-retry-count').textContent=pvState.words.length;showToast('âš ï¸ ìµœì¢… '+pvState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else{endPVQuiz();return;}
}
const pv=pvState.words[pvState.idx];if(!pv||!pv.Phrasal_Verb){console.error('Invalid PV:',pv);pvState.idx++;showPVQQ();return;}
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
document.getElementById('pvq-progress').style.width=(pvState.completed/pvState.originalCount)*100+'%';
document.getElementById('pvq-current').textContent=pvState.completed;document.getElementById('pvq-total').textContent=pvState.originalCount;
document.getElementById('pvq-correct').textContent=pvState.correct;document.getElementById('pvq-wrong').textContent=pvState.wrong;
if(pvState.phase!=='normal')document.getElementById('pvq-retry-count').textContent=pvState.words.length-pvState.idx;
const isRev=pvState.mode==='reverse';
if(isRev){document.getElementById('pvq-word').textContent=getMKO(pv);document.getElementById('pvq-sub').textContent='êµ¬ë™ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”';document.getElementById('pvq-tags').innerHTML='';}
else{document.getElementById('pvq-word').textContent=pv.Phrasal_Verb;document.getElementById('pvq-sub').textContent='';document.getElementById('pvq-tags').innerHTML=`<span class="tag tag-phrasal">${pv.Particle||''}</span><span class="tag tag-cat">${pv.Category||''}</span>`;}
// ì„ íƒì§€ ìƒì„±
const cAns=isRev?pv.Phrasal_Verb:getMKO(pv);
if(!cAns){console.error('No answer for PV:',pv);pvState.idx++;showPVQQ();return;}
const pool=pvState.allWords.filter(x=>x.Phrasal_Verb!==pv.Phrasal_Verb&&getMKO(x)&&getMKO(x)!==cAns);
const dist=getPVDistractors(pv,pool,4);
const wAns=dist.map(x=>isRev?x.Phrasal_Verb:getMKO(x)).filter(x=>x&&x!==cAns);
const uniqueWAns=[...new Set(wAns)].slice(0,4);
const opts=shuffle([cAns,...uniqueWAns]);
console.log('[PVQuiz]',{pv:pv.Phrasal_Verb,cAns,distractors:uniqueWAns.length});
document.getElementById('pvq-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectPVQ(this)" data-ans="${o===cAns}">${o}</button>`).join('');
pvState.answered=false;pvState.correctAns=cAns;document.getElementById('pvq-next-btn').classList.add('hidden');
document.getElementById('pvq-example').classList.add('hidden');
document.getElementById('pvq-rating-bar').classList.add('hidden');
updatePVQBookmarkBtn();updatePVQProductionBtn();
}
async function selectPVQ(el){
try{
if(pvState.answered)return;pvState.answered=true;
const ok=el.dataset.ans==='true';
const pv=pvState.words[pvState.idx];
const isRetry=pv.isRetry||false;
// â˜… í†µê³„: ì²« ì‹œë„ë§Œ correct/wrong ì¹´ìš´íŠ¸, firstTry ì¹´ìš´íŠ¸
if(ok){
  if(!isRetry){pvState.correct++;pvState.firstTryCorrect++;}
  pvState.completed++; // ì •ë‹µ = ì¹´ë“œ ì™„ë£Œ
}else{
  if(!isRetry){pvState.wrong++;pvState.firstTryWrong++;}
  if(pvState.phase==='normal')pvState.retryQueue.push({...pv,isRetry:true});
  else if(pvState.phase==='retry')pvState.finalQueue.push({...pv,isRetry:true});
  else{updateWrong(pv,false);pvState.savedToWrong++;pvState.completed++;} // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ
}
document.querySelectorAll('#pvq-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
if(!isRetry){
pv.reviewCount=(pv.reviewCount||0)+1;if(ok)pv.correctCount=(pv.correctCount||0)+1;
updateMastery(pv,ok);
updateInputOutput(pv,false,ok); // â˜… PV ì˜ë¯¸ í€´ì¦ˆ = ì¸í’‹ ëª¨ë“œ
// â˜… FSRS: ì˜¤ë‹µë§Œ ë°”ë¡œ Again(0) ì ìš©, ì •ë‹µì€ rating ì„ íƒ ì‹œ ì ìš©
if(!ok){
  try{Object.assign(pv,calcNext(pv,0));if(pv.isLeech)showToast('ğŸŒ Leech: '+pv.Phrasal_Verb);await savePV(pv);}catch(e){console.error(e);}
  updateWrong(pv,false);
}else{
  updateWrong(pv,true);
  try{await savePV(pv);}catch(e){console.error(e);} // í†µê³„ë§Œ ì €ì¥
}
}
vibrate(ok?10:[50,30,50]);
document.getElementById('pvq-correct').textContent=pvState.correct;document.getElementById('pvq-wrong').textContent=pvState.wrong;
const pvqEx=getEx(pv);if(pvqEx){document.getElementById('pvq-example').textContent=pvqEx;document.getElementById('pvq-example').classList.remove('hidden');}
// â˜… ì •ë‹µ: rating bar + 2ì´ˆ í›„ Hard(1) FSRS ì ìš© / ì˜¤ë‹µ: 1.5ì´ˆ í›„ ìë™ ë„˜ê¹€
if(ok){
document.getElementById('pvq-rating-bar').classList.remove('hidden');
pvState.autoNextTimer=setTimeout(()=>{
  skipPVQRating(); // Good(2) FSRS ì ìš©
},2000);
}else{
setTimeout(()=>nextPVQ(),1500);
}
}catch(e){console.error('selectPVQ error:',e);pvState.answered=false;}
}
async function ratePVQItem(grade){
try{
// ìë™ ë„˜ê¹€ íƒ€ì´ë¨¸ ì·¨ì†Œ
if(pvState.autoNextTimer){clearTimeout(pvState.autoNextTimer);pvState.autoNextTimer=null;}
const pv=pvState.words[pvState.idx];
// â˜… í†µê³„ëŠ” ì´ë¯¸ selectPVQì—ì„œ ì €ì¥ë¨, ì—¬ê¸°ì„œëŠ” FSRSë§Œ ì ìš©
try{Object.assign(pv,calcNext(pv,grade));if(pv.isLeech)showToast('ğŸŒ Leech: '+pv.Phrasal_Verb);await savePV(pv);}catch(e){console.error(e);}
document.getElementById('pvq-rating-bar').classList.add('hidden');
nextPVQ();
}catch(e){console.error('ratePVQItem error:',e);nextPVQ();}
}
function skipPVQRating(){
// â˜… ìŠ¤í‚µ ì‹œ Good(2)ë¡œ FSRS ìë™ ì ìš©
ratePVQItem(2);
}
function nextPVQ(){pvState.idx++;if(pvState.mode==='particle')showPVPQ();else showPVQQ();}
function confirmEndPVQuiz(){if(pvState.idx<pvState.words.length||pvState.retryQueue.length>0||pvState.finalQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endPVQuiz);else endPVQuiz();}
async function endPVQuiz(){
const ans=pvState.correct+pvState.wrong;if(ans===0){showPage(studyStartPage,true);return;}
const acc=Math.round((pvState.correct/ans)*100);
await saveSession({total:ans,correct:pvState.correct,wrong:pvState.wrong,accuracy:acc,mode:'pv-'+pvState.mode,type:'phrasal',duration:Math.round((Date.now()-pvState.start)/1000),uniqueTotal:pvState.originalCount,firstTryCorrect:pvState.firstTryCorrect,firstTryWrong:pvState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=pvState.correct;document.getElementById('qc-wrong').textContent=pvState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(pvState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=pvState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
// === Leitner Box í•™ìŠµ ===
async function startBoxStudy(box,type){
if(type==='phrasal'){
const p=await getAllPV();
const boxItems=p.filter(x=>(x.leitnerBox||1)===box);
if(!boxItems.length){showToast(`âš ï¸ Box ${box}ì— êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤`);return;}
showBoxStudyModal(box,boxItems.length,'phrasal');
}else{
const w=await getAllWords();
const boxItems=w.filter(x=>(x.leitnerBox||1)===box);
if(!boxItems.length){showToast(`âš ï¸ Box ${box}ì— ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤`);return;}
showBoxStudyModal(box,boxItems.length,'vocab');
}
}
// â˜… ê³ ê¸‰ ë¶„ì„ ê¸°ë°˜ í•™ìŠµ í•¨ìˆ˜ë“¤
async function startHardCardsStudy(type){
const count=parseInt(localStorage.getItem('defaultCount')||'20');
if(type==='vocab'){
  const w=await getAllWords();
  const hardCards=w.filter(x=>(x.reviewCount||0)>0&&(x.wrongCount||0)>0)
    .sort((a,b)=>{
      const aRate=a.wrongCount/(a.reviewCount||1);
      const bRate=b.wrongCount/(b.reviewCount||1);
      return (bRate+(b.lapses||0)*0.1)-(aRate+(a.lapses||0)*0.1);
    }).slice(0,count);
  if(!hardCards.length){showToast('âš ï¸ Hard cardsê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  showStudyModeModal('ğŸ”¥ Hard Cards í•™ìŠµ',hardCards.length,'vocab',hardCards,w);
}else if(type==='phrasal'){
  const p=await getAllPV();
  const hardCards=p.filter(x=>(x.reviewCount||0)>0&&(x.wrongCount||0)>0)
    .sort((a,b)=>{
      const aRate=a.wrongCount/(a.reviewCount||1);
      const bRate=b.wrongCount/(b.reviewCount||1);
      return (bRate+(b.lapses||0)*0.1)-(aRate+(a.lapses||0)*0.1);
    }).slice(0,count);
  if(!hardCards.length){showToast('âš ï¸ Hard cardsê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  showStudyModeModal('ğŸ”¥ Hard Cards í•™ìŠµ',hardCards.length,'phrasal',hardCards,p);
}else if(type==='expr'){
  const e=await getAllExpr();
  const hardCards=e.filter(x=>(x.reviewCount||0)>0&&(x.wrongCount||0)>0)
    .sort((a,b)=>{
      const aRate=a.wrongCount/(a.reviewCount||1);
      const bRate=b.wrongCount/(b.reviewCount||1);
      return (bRate+(b.lapses||0)*0.1)-(aRate+(a.lapses||0)*0.1);
    }).slice(0,count);
  if(!hardCards.length){showToast('âš ï¸ Hard cardsê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  showStudyModeModal('ğŸ”¥ Hard Cards í•™ìŠµ',hardCards.length,'expr',hardCards,e);
}
}
async function startFSRSFailStudy(type){
const now=new Date();
const sevenDaysAgo=new Date(now.getTime()-7*24*60*60*1000);
const count=parseInt(localStorage.getItem('defaultCount')||'20');
if(type==='vocab'){
  const w=await getAllWords();
  const failCards=w.filter(x=>{
    if(!x.stability||x.stability<7)return false;
    if(!x.lastWrongDate)return false;
    return new Date(x.lastWrongDate)>=sevenDaysAgo;
  }).sort((a,b)=>b.stability-a.stability).slice(0,count);
  if(!failCards.length){showToast('âœ… FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  showStudyModeModal('âš ï¸ FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ',failCards.length,'vocab',failCards,w);
}else if(type==='phrasal'){
  const p=await getAllPV();
  const failCards=p.filter(x=>{
    if(!x.stability||x.stability<7)return false;
    if(!x.lastWrongDate)return false;
    return new Date(x.lastWrongDate)>=sevenDaysAgo;
  }).sort((a,b)=>b.stability-a.stability).slice(0,count);
  if(!failCards.length){showToast('âœ… FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  showStudyModeModal('âš ï¸ FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ',failCards.length,'phrasal',failCards,p);
}else if(type==='expr'){
  const e=await getAllExpr();
  const failCards=e.filter(x=>{
    if(!x.stability||x.stability<7)return false;
    if(!x.lastWrongDate)return false;
    return new Date(x.lastWrongDate)>=sevenDaysAgo;
  }).sort((a,b)=>b.stability-a.stability).slice(0,count);
  if(!failCards.length){showToast('âœ… FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  showStudyModeModal('âš ï¸ FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ',failCards.length,'expr',failCards,e);
}
}
async function startGapStudy(type){
const count=parseInt(localStorage.getItem('defaultCount')||'20');
if(type==='vocab'){
  const w=await getAllWords();
  // ì¸í’‹ì—ì„œ ì˜ ë§ì¶”ëŠ”ë°(70%+) ì•„ì›ƒí’‹ ê²½í—˜ ì—†ê±°ë‚˜ ì•„ì›ƒí’‹ì—ì„œ ì•½í•œ ì¹´ë“œ
  const gapCards=w.filter(x=>{
    const inputR=x.inputReviewCount||0;
    const outputR=x.outputReviewCount||0;
    const inputAcc=inputR?((x.inputCorrectCount||0)/inputR)*100:null;
    const outputAcc=outputR?((x.outputCorrectCount||0)/outputR)*100:null;
    if(inputAcc!==null&&inputAcc>=70){
      if(outputR===0||outputAcc===null)return true; // ì•„ì›ƒí’‹ ë¯¸ì‹œë„
      if(outputAcc<50)return true; // ì•„ì›ƒí’‹ì—ì„œ ì•½í•¨
    }
    return x.needsProduction&&inputR>0;
  }).sort((a,b)=>{
    // ê°­ì´ í° ìˆœì„œë¡œ ì •ë ¬
    const aInput=(a.inputReviewCount?((a.inputCorrectCount||0)/a.inputReviewCount)*100:0);
    const aOutput=(a.outputReviewCount?((a.outputCorrectCount||0)/a.outputReviewCount)*100:0);
    const bInput=(b.inputReviewCount?((b.inputCorrectCount||0)/b.inputReviewCount)*100:0);
    const bOutput=(b.outputReviewCount?((b.outputCorrectCount||0)/b.outputReviewCount)*100:0);
    return (bInput-bOutput)-(aInput-aOutput);
  }).slice(0,count);
  if(!gapCards.length){showToast('âœ… ìƒì‚° ì—°ìŠµ í•„ìš” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  showGapStudyModal('ğŸ”„ ìƒì‚° ì—°ìŠµ',gapCards.length,'vocab',gapCards,w);
}else if(type==='phrasal'){
  const p=await getAllPV();
  const gapCards=p.filter(x=>{
    const inputR=x.inputReviewCount||0;
    const outputR=x.outputReviewCount||0;
    const inputAcc=inputR?((x.inputCorrectCount||0)/inputR)*100:null;
    const outputAcc=outputR?((x.outputCorrectCount||0)/outputR)*100:null;
    if(inputAcc!==null&&inputAcc>=70){
      if(outputR===0||outputAcc===null)return true;
      if(outputAcc<50)return true;
    }
    return x.needsProduction&&inputR>0;
  }).slice(0,count);
  if(!gapCards.length){showToast('âœ… ìƒì‚° ì—°ìŠµ í•„ìš” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  showGapStudyModal('ğŸ”„ ìƒì‚° ì—°ìŠµ',gapCards.length,'phrasal',gapCards,p);
}else if(type==='expr'){
  const e=await getAllExpr();
  const gapCards=e.filter(x=>{
    const inputR=x.inputReviewCount||0;
    const outputR=x.outputReviewCount||0;
    const inputAcc=inputR?((x.inputCorrectCount||0)/inputR)*100:null;
    const outputAcc=outputR?((x.outputCorrectCount||0)/outputR)*100:null;
    if(inputAcc!==null&&inputAcc>=70){
      if(outputR===0||outputAcc===null)return true;
      if(outputAcc<50)return true;
    }
    return x.needsProduction&&inputR>0;
  }).slice(0,count);
  if(!gapCards.length){showToast('âœ… ìƒì‚° ì—°ìŠµ í•„ìš” ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  showGapStudyModal('ğŸ”„ ìƒì‚° ì—°ìŠµ',gapCards.length,'expr',gapCards,e);
}
}
async function startStabilityStudy(minStab,maxStab,type){
const count=parseInt(localStorage.getItem('defaultCount')||'20');
const label=minStab>=30?'30ì¼+':minStab>=7?'7-30ì¼':minStab>=3?'3-7ì¼':'0-3ì¼';
if(type==='vocab'){
  const w=await getAllWords();
  const stabCards=w.filter(x=>{const s=x.stability||0;return s>=minStab&&s<maxStab;})
    .sort((a,b)=>(a.stability||0)-(b.stability||0)).slice(0,count);
  if(!stabCards.length){showToast(`âš ï¸ ${label} êµ¬ê°„ì— ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤`);return;}
  showStudyModeModal(`ğŸ“Š ì•ˆì •ë„ ${label} í•™ìŠµ`,stabCards.length,'vocab',stabCards,w);
}else if(type==='phrasal'){
  const p=await getAllPV();
  const stabCards=p.filter(x=>{const s=x.stability||0;return s>=minStab&&s<maxStab;})
    .sort((a,b)=>(a.stability||0)-(b.stability||0)).slice(0,count);
  if(!stabCards.length){showToast(`âš ï¸ ${label} êµ¬ê°„ì— ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤`);return;}
  showStudyModeModal(`ğŸ“Š ì•ˆì •ë„ ${label} í•™ìŠµ`,stabCards.length,'phrasal',stabCards,p);
}else if(type==='expr'){
  const e=await getAllExpr();
  const stabCards=e.filter(x=>{const s=x.stability||0;return s>=minStab&&s<maxStab;})
    .sort((a,b)=>(a.stability||0)-(b.stability||0)).slice(0,count);
  if(!stabCards.length){showToast(`âš ï¸ ${label} êµ¬ê°„ì— ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤`);return;}
  showStudyModeModal(`ğŸ“Š ì•ˆì •ë„ ${label} í•™ìŠµ`,stabCards.length,'expr',stabCards,e);
}
}
// í•™ìŠµ ëª¨ë“œ ì„ íƒ ëª¨ë‹¬
let pendingStudyItems=null,pendingStudyAll=null,pendingStudyType=null;
function showStudyModeModal(title,count,type,items,all){
pendingStudyItems=items;pendingStudyAll=all;pendingStudyType=type;
document.getElementById('confirm-title').textContent=title;
document.getElementById('confirm-msg').innerHTML=`<strong>${count}ê°œ</strong> ì¹´ë“œê°€ ìˆìŠµë‹ˆë‹¤.<br><br>
<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px">
<button class="btn btn-secondary" onclick="startPendingFC()" style="flex:1;min-width:45%">ğŸƒ í”Œë˜ì‹œì¹´ë“œ</button>
<button class="btn btn-primary" onclick="startPendingQuiz()" style="flex:1;min-width:45%">â“ í€´ì¦ˆ</button>
<button class="btn" onclick="startPendingTyping()" style="flex:1;min-width:45%;background:var(--success);color:white">âŒ¨ï¸ íƒ€ì´í•‘</button>
</div>`;
document.getElementById('confirm-btn').style.display='none';
showModal('confirm-modal');
}
function showGapStudyModal(title,count,type,items,all){
pendingStudyItems=items;pendingStudyAll=all;pendingStudyType=type;
document.getElementById('confirm-title').textContent=title;
document.getElementById('confirm-msg').innerHTML=`<strong>${count}ê°œ</strong> ìƒì‚° ì—°ìŠµ í•„ìš” ì¹´ë“œ.<br><span style="font-size:12px;color:var(--muted)">ì¸ì§€ì—ì„œëŠ” ì˜ ë§ì¶”ì§€ë§Œ ì“°ê¸° ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.</span><br><br>
<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px">
<button class="btn" onclick="startPendingTyping()" style="flex:1;background:var(--success);color:white">âŒ¨ï¸ íƒ€ì´í•‘ (ê¶Œì¥)</button>
<button class="btn btn-secondary" onclick="startPendingFC()" style="flex:1">ğŸƒ í”Œë˜ì‹œì¹´ë“œ</button>
</div>`;
document.getElementById('confirm-btn').style.display='none';
showModal('confirm-modal');
}
function startPendingFC(){
closeModal('confirm-modal');document.getElementById('confirm-btn').style.display='';
startFC(pendingStudyItems,pendingStudyAll,pendingStudyType);
}
function startPendingQuiz(){
closeModal('confirm-modal');document.getElementById('confirm-btn').style.display='';
if(pendingStudyType==='vocab')startQuiz(pendingStudyItems,pendingStudyAll,'meaning');
else if(pendingStudyType==='phrasal')startPVQ(pendingStudyItems,pendingStudyAll,'meaning');
else if(pendingStudyType==='expr')startExprQuiz(pendingStudyItems,pendingStudyAll);
}
function startPendingTyping(){
closeModal('confirm-modal');document.getElementById('confirm-btn').style.display='';
if(pendingStudyType==='vocab')startTyping(pendingStudyItems,pendingStudyAll);
else if(pendingStudyType==='phrasal'){
  // PV typingì´ ìˆë‹¤ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ dictation
  if(typeof startPVTyping==='function')startPVTyping(pendingStudyItems,pendingStudyAll);
  else startDictation(pendingStudyItems,pendingStudyAll,'phrasal');
}else if(pendingStudyType==='expr')startExprTyping(pendingStudyItems,pendingStudyAll);
}
function showBoxStudyModal(box,count,type){
const title=type==='phrasal'?'êµ¬ë™ì‚¬':'ì–´íœ˜';
document.getElementById('confirm-title').textContent=`ğŸ“¦ Box ${box} í•™ìŠµ`;
document.getElementById('confirm-msg').innerHTML=`<strong>${count}ê°œ</strong> ${title}ê°€ ìˆìŠµë‹ˆë‹¤.<br><br>
<div style="display:flex;gap:10px;margin-top:12px">
<button class="btn btn-secondary" onclick="startBoxFC(${box},'${type}')" style="flex:1">ğŸƒ í”Œë˜ì‹œì¹´ë“œ</button>
<button class="btn btn-primary" onclick="startBoxQuiz(${box},'${type}')" style="flex:1">â“ í€´ì¦ˆ</button>
</div>`;
document.getElementById('confirm-btn').style.display='none';
showModal('confirm-modal');
}
async function startBoxFC(box,type){
closeModal('confirm-modal');
document.getElementById('confirm-btn').style.display='';
const count=parseInt(localStorage.getItem('defaultCount')||'20');
if(type==='phrasal'){
const p=await getAllPV();
const items=shuffle(p.filter(x=>(x.leitnerBox||1)===box)).slice(0,count);
startFC(items,p,'phrasal');
}else{
const w=await getAllWords();
const items=shuffle(w.filter(x=>(x.leitnerBox||1)===box)).slice(0,count);
startFC(items,w,'vocab');
}
}
async function startBoxQuiz(box,type){
closeModal('confirm-modal');
document.getElementById('confirm-btn').style.display='';
const count=parseInt(localStorage.getItem('defaultCount')||'20');
if(type==='phrasal'){
const p=await getAllPV();
const items=shuffle(p.filter(x=>(x.leitnerBox||1)===box&&getMKO(x))).slice(0,count);
if(items.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
startPVQ(items,p,'meaning');
}else{
const w=await getAllWords();
const items=shuffle(w.filter(x=>(x.leitnerBox||1)===box&&getMKO(x))).slice(0,count);
if(items.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
startQuiz(items,w,'quiz','vocab');
}
}

function updateStreak(){const today=new Date().toDateString(),last=localStorage.getItem('lastStudyDate');let streak=parseInt(localStorage.getItem('streak')||'0');if(last!==today){const y=new Date();y.setDate(y.getDate()-1);streak=(last===y.toDateString())?streak+1:1;localStorage.setItem('lastStudyDate',today);localStorage.setItem('streak',streak.toString());}const banner=document.getElementById('streak-banner');if(streak>0){banner.classList.remove('hidden');document.getElementById('streak-days').textContent=streak;}else banner.classList.add('hidden');}

// === ë¹ ë¥¸ ê²€ìƒ‰ & ë¶ë§ˆí¬ ===
let quickSearchResult=null;let quickSearchType=null;let quickSearchQuery='';
async function quickSearch(){
const q=document.getElementById('quick-search-input').value.trim();
const qLower=q.toLowerCase();
quickSearchQuery=q;
if(!q){document.getElementById('quick-search-result').style.display='none';return;}
const words=await getAllWords();
const pvs=await getAllPV();
// í†µí•© Fuzzy Search
const results=fuzzySearch(qLower,[...words.map(w=>({item:w,type:'vocab'})),...pvs.map(p=>({item:p,type:'phrasal'}))]);
if(results.length>0){
const best=results[0];
quickSearchResult=best.item;
quickSearchType=best.type;
showQuickResult(best.item,best.type,best.score>=80);
return;
}
// ëª» ì°¾ìŒ
quickSearchResult=null;quickSearchType=null;
document.getElementById('quick-search-result').style.display='block';
document.getElementById('quick-search-found').style.display='none';
document.getElementById('quick-search-notfound').style.display='block';
document.getElementById('qs-new-word').textContent=q;
document.getElementById('qs-new-meaning').value='';
document.getElementById('qs-add-bookmark').checked=true;
}
// 7. Fuzzy Search í•¨ìˆ˜
function fuzzySearch(query,items){
return items.map(({item,type})=>{
const word=(type==='phrasal'?(item.Phrasal_Verb||''):displayWord(getW(item),true)).toLowerCase();
let score=0;
if(word===query)score=100;
else if(word.startsWith(query))score=80;
else if(word.includes(query))score=60;
else if((getMKO(item)||'').toLowerCase().includes(query))score=40;
else{
// ê°„ë‹¨í•œ Levenshtein ê·¼ì‚¬ (ì˜¤íƒ€ í—ˆìš©)
const dist=Math.abs(word.length-query.length);
const common=[...query].filter(c=>word.includes(c)).length;
const similarity=common/Math.max(word.length,query.length);
if(similarity>0.6)score=30;
else if(similarity>0.4)score=15;
}
return{item,type,score};
}).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
}
async function quickSaveNewWord(){
const word=document.getElementById('qs-new-word').textContent.trim();
const meaning=document.getElementById('qs-new-meaning').value.trim();
if(!word){showToast('âŒ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
if(!meaning){showToast('âŒ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
const addBookmark=document.getElementById('qs-add-bookmark').checked;
const newWord={word:word,Meaning1_KO:meaning,L1:'General',CEFR:'B1',starred:addBookmark,reviewCount:0,correctCount:0,mastery:0,leitnerBox:1,ease:2.5};
await saveWord(newWord);
document.getElementById('quick-search-result').style.display='none';
document.getElementById('quick-search-input').value='';
showToast(addBookmark?'âœ… ì €ì¥ + â­ ë¶ë§ˆí¬ ì¶”ê°€':'âœ… ì €ì¥ ì™„ë£Œ');
updateHomeStats();updateWordTable();
}
function showQuickResult(item,type,isExact){
document.getElementById('quick-search-result').style.display='block';
document.getElementById('quick-search-found').style.display='block';
document.getElementById('quick-search-notfound').style.display='none';
const word=type==='phrasal'?item.Phrasal_Verb:displayWord(item.word);
document.getElementById('qs-word').innerHTML=word;
document.getElementById('qs-meaning').textContent=getMKO(item)||getMEN(item)||'';
const info=type==='phrasal'?`${item.Category||'General'} | ${item.Formal_Equivalent||''}`:`${item.POS||''} | ${item.L1||'General'} | ${item.CEFR||'B1'}`;
document.getElementById('qs-info').textContent=info;
// ì˜ˆë¬¸ í‘œì‹œ
const ex=getEx(item);
const exEl=document.getElementById('qs-example');
if(ex){exEl.textContent=ex;exEl.style.display='block';}else{exEl.style.display='none';}
// ë¶€ë¶„ ì¼ì¹˜ë©´ "ì°¾ëŠ” ë‹¨ì–´ê°€ ì•„ë‹Œê°€ìš”?" í‘œì‹œ
const notThis=document.getElementById('qs-not-this');
if(!isExact && quickSearchQuery.toLowerCase()!==word.toLowerCase()){
notThis.style.display='block';
document.getElementById('qs-original-query').textContent=quickSearchQuery;
}else{
notThis.style.display='none';
}
updateQuickBookmarkBtn();
updateQuickProductionBtn();
}
function showAddNewFromSearch(){
document.getElementById('quick-search-found').style.display='none';
document.getElementById('quick-search-notfound').style.display='block';
document.getElementById('qs-new-word').textContent=quickSearchQuery;
document.getElementById('qs-new-meaning').value='';
document.getElementById('qs-add-bookmark').checked=true;
}
function updateQuickBookmarkBtn(){
if(!quickSearchResult)return;
const btn=document.getElementById('qs-bookmark-btn');
btn.textContent=quickSearchResult.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
btn.style.color=quickSearchResult.starred?'var(--warning)':'';
}
function updateQuickProductionBtn(){
if(!quickSearchResult)return;
const btn=document.getElementById('qs-prod-btn');
btn.textContent=quickSearchResult.needsProduction?'âœ… ì‚°ì¶œí•´ì œ':'ğŸ–Šï¸ ì‚°ì¶œ';
btn.style.color=quickSearchResult.needsProduction?'var(--success)':'';
}
function speakQSWord(){
if(!quickSearchResult)return;
const word=quickSearchType==='phrasal'?quickSearchResult.Phrasal_Verb:quickSearchResult.word;
const u=new SpeechSynthesisUtterance(word);
u.lang='en-US';u.rate=0.9;
speechSynthesis.cancel();speechSynthesis.speak(u);
}
async function quickToggleProduction(){
if(!quickSearchResult)return;
quickSearchResult.needsProduction=!quickSearchResult.needsProduction;
if(quickSearchType==='phrasal')await savePV(quickSearchResult);
else await saveWord(quickSearchResult);
updateQuickProductionBtn();
showToast(quickSearchResult.needsProduction?'ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ì¶”ê°€':'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ');
updateHomeStats();
}
async function quickEditWord(){
if(!quickSearchResult)return;
const key=quickSearchType==='phrasal'?quickSearchResult.Phrasal_Verb:quickSearchResult.word;
document.getElementById('quick-search-result').style.display='none';
await openEditModal(key,quickSearchType);
}
async function quickToggleBookmark(){
if(!quickSearchResult)return;
quickSearchResult.starred=!quickSearchResult.starred;
if(quickSearchType==='phrasal')await savePV(quickSearchResult);
else await saveWord(quickSearchResult);
updateQuickBookmarkBtn();
showToast(quickSearchResult.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}
function quickAddWord(){
const q=document.getElementById('quick-search-input').value.trim();
document.getElementById('quick-search-result').style.display='none';
switchAddType('vocab');
openAddWordModal(q);
}

// === êµ¬ë™ì‚¬ ë¹ ë¥¸ ê²€ìƒ‰ ===
let pvQSResult=null;let pvQSQuery='';
async function pvQuickSearch(){
const q=document.getElementById('pv-quick-search-input').value.trim();
const qLower=q.toLowerCase();
pvQSQuery=q;
if(!q){document.getElementById('pv-quick-search-result').style.display='none';return;}
const pvs=await getAllPV();
// ì •í™• ì¼ì¹˜
let found=pvs.find(p=>(p.Phrasal_Verb||'').toLowerCase()===qLower);
if(found){pvQSResult=found;showPVQSResult(found,true);return;}
// ë¶€ë¶„ ì¼ì¹˜
found=pvs.find(p=>(p.Phrasal_Verb||'').toLowerCase().includes(qLower)||qLower.includes((p.Phrasal_Verb||'').toLowerCase()));
if(found){pvQSResult=found;showPVQSResult(found,false);return;}
// ëª» ì°¾ìŒ
pvQSResult=null;
document.getElementById('pv-quick-search-result').style.display='block';
document.getElementById('pv-qs-found').style.display='none';
document.getElementById('pv-qs-notfound').style.display='block';
document.getElementById('pv-qs-new-word').textContent=q;
document.getElementById('pv-qs-new-meaning').value='';
document.getElementById('pv-qs-add-bookmark').checked=true;
}
function showPVQSResult(item,isExact){
document.getElementById('pv-quick-search-result').style.display='block';
document.getElementById('pv-qs-found').style.display='block';
document.getElementById('pv-qs-notfound').style.display='none';
document.getElementById('pv-qs-word').textContent=item.Phrasal_Verb;
document.getElementById('pv-qs-meaning').textContent=getMKO(item)||getMEN(item)||'';
document.getElementById('pv-qs-info').textContent=`${item.Category||'General'} | ${item.Formal_Equivalent||''}`;
const ex=getEx(item);
const exEl=document.getElementById('pv-qs-example');
if(ex){exEl.textContent=ex;exEl.style.display='block';}else{exEl.style.display='none';}
const notThis=document.getElementById('pv-qs-not-this');
if(!isExact&&pvQSQuery.toLowerCase()!==(item.Phrasal_Verb||'').toLowerCase()){
notThis.style.display='block';
document.getElementById('pv-qs-original').textContent=pvQSQuery;
}else{notThis.style.display='none';}
updatePVQSBtns();
}
function updatePVQSBtns(){
if(!pvQSResult)return;
const bBtn=document.getElementById('pv-qs-bookmark-btn');
bBtn.textContent=pvQSResult.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
bBtn.style.color=pvQSResult.starred?'var(--warning)':'';
const pBtn=document.getElementById('pv-qs-prod-btn');
pBtn.textContent=pvQSResult.needsProduction?'âœ… ì‚°ì¶œí•´ì œ':'ğŸ–Šï¸ ì‚°ì¶œ';
pBtn.style.color=pvQSResult.needsProduction?'var(--success)':'';
}
function speakPVQSWord(){
if(!pvQSResult)return;
const u=new SpeechSynthesisUtterance(pvQSResult.Phrasal_Verb);
u.lang='en-US';u.rate=0.9;
speechSynthesis.cancel();speechSynthesis.speak(u);
}
async function pvQSToggleBookmark(){
if(!pvQSResult)return;
pvQSResult.starred=!pvQSResult.starred;
await savePV(pvQSResult);
updatePVQSBtns();
showToast(pvQSResult.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}
async function pvQSToggleProduction(){
if(!pvQSResult)return;
pvQSResult.needsProduction=!pvQSResult.needsProduction;
await savePV(pvQSResult);
updatePVQSBtns();
showToast(pvQSResult.needsProduction?'ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ì¶”ê°€':'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ');
updateHomeStats();
}
async function pvQSEdit(){
if(!pvQSResult)return;
document.getElementById('pv-quick-search-result').style.display='none';
await openEditModal(pvQSResult.Phrasal_Verb,'phrasal');
}
function showPVAddNew(){
document.getElementById('pv-qs-found').style.display='none';
document.getElementById('pv-qs-notfound').style.display='block';
document.getElementById('pv-qs-new-word').textContent=pvQSQuery;
document.getElementById('pv-qs-new-meaning').value='';
document.getElementById('pv-qs-add-bookmark').checked=true;
}
async function pvQSSaveNew(){
const pv=document.getElementById('pv-qs-new-word').textContent.trim();
const meaning=document.getElementById('pv-qs-new-meaning').value.trim();
if(!pv){showToast('âŒ êµ¬ë™ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
if(!meaning){showToast('âŒ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
const addBookmark=document.getElementById('pv-qs-add-bookmark').checked;
// Base verb, particle ìë™ ì¶”ì¶œ
const parts=pv.split(' ');
const baseVerb=parts[0]||'';
const particle=parts.slice(1).join(' ')||'';
// â˜… ìˆ˜ì •: FSRS ë° í†µê³„ í•„ë“œ ì¶”ê°€ (saveNewWordì™€ ë™ì¼í•˜ê²Œ)
const newPV={
  Phrasal_Verb:pv,
  Base_Verb:baseVerb,
  Particle:particle,
  Meaning1_KO:meaning,
  Category:'General',
  starred:addBookmark,
  tags:[],
  addedDate:new Date().toISOString(),
  // FSRS í•„ë“œ
  stability:null,
  difficulty:null,
  fsrsState:'New',
  reps:0,
  lapses:0,
  // í•™ìŠµ í†µê³„
  reviewCount:0,
  correctCount:0,
  mastery:0,
  consecutiveWrong:0,
  wrongCount:0,
  nextReview:null,
  lastReview:null,
  lastWrongDate:null,
  // ì¸í’‹/ì•„ì›ƒí’‹ í†µê³„
  inputReviewCount:0,
  inputCorrectCount:0,
  outputReviewCount:0,
  outputCorrectCount:0
};
await savePV(newPV);
document.getElementById('pv-quick-search-result').style.display='none';
document.getElementById('pv-quick-search-input').value='';
showToast(addBookmark?'âœ… ì €ì¥ + â­ ë¶ë§ˆí¬ ì¶”ê°€':'âœ… ì €ì¥ ì™„ë£Œ');
updateHomeStats();updateWordTable();
}
function pvQSAddDetail(){
// â˜… ìˆ˜ì •: ì…ë ¥ì°½ì´ ì•„ë‹Œ ì €ì¥ëœ ê²€ìƒ‰ì–´(pvQSQuery) ë˜ëŠ” í‘œì‹œëœ ë‹¨ì–´ ì‚¬ìš©
const q = document.getElementById('pv-qs-new-word')?.textContent?.trim() || pvQSQuery || '';
document.getElementById('pv-quick-search-result').style.display='none';
switchAddType('phrasal');
openAddWordModal(q);
}

// === í‘œí˜„ (Expressions) ===
let exprQSResult=null;let exprQSQuery='';let exprFormalityFilter='all';
async function startExprFC(){
const exprs=await getAllExpr();
if(!exprs.length){showToast('ğŸ’¬ í‘œí˜„ DBê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
let filtered=exprFormalityFilter==='all'?exprs:exprs.filter(e=>e.Formality===exprFormalityFilter);
const now=new Date();
const count=parseInt(localStorage.getItem('defaultCount')||'20');
// â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
// â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ : DUE 60% â†’ WEAK 30% â†’ NEW 10%
const dueCount=Math.ceil(count*0.6);
const weakCount=Math.ceil(count*0.3);
const newCount=count-dueCount-weakCount;
const dueItems=sortByFSRSPriority(filtered.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
const weakItems=shuffle(filtered.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
const newItems=shuffle(filtered.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
let selected=[...dueItems,...weakItems,...newItems];
if(selected.length<count){
  const usedExprs=new Set(selected.map(x=>x.Expression));
  // â˜… í•µì‹¬: nextReviewê°€ ë¯¸ë˜ì¸ ë‹¨ì–´ ì œì™¸!
  const remaining=shuffle(filtered.filter(x=>!usedExprs.has(x.Expression)&&isAvailable(x))).slice(0,count-selected.length);
  selected=[...selected,...remaining];
}
console.log('[ExprFC] ì„ íƒ:',{due:dueItems.length,weak:weakItems.length,new:newItems.length,total:selected.length,availableInDB:filtered.filter(isAvailable).length});
if(!selected.length){showToast('âœ… ì˜¤ëŠ˜ í•™ìŠµí•  í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
exprState={words:selected,allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null,originalCount:selected.length,completed:0,completedKeys:new Set(),firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-fc-total').textContent=selected.length;
document.getElementById('expr-fc-current').textContent='0';
document.getElementById('expr-retry-banner').classList.add('hidden');
showPage('expr-fc');startExprTimer();showExprCard();
}
async function startExprCloze(){
const exprs=await getAllExpr();
let valid=exprs.filter(e=>{const ex=getEx(e);return ex&&ex.toLowerCase().includes(e.Expression.toLowerCase().split(' ')[0]);});
if(!valid.length){showToast('âœ… ë¹ˆì¹¸ì±„ìš°ê¸° ê°€ëŠ¥í•œ í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
const now=new Date();
const count=parseInt(localStorage.getItem('defaultCount')||'20');
// â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
// â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ : DUE 60% â†’ WEAK 30% â†’ NEW 10%
const dueCount=Math.ceil(count*0.6);
const weakCount=Math.ceil(count*0.3);
const newCount=count-dueCount-weakCount;
const dueItems=sortByFSRSPriority(valid.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
const weakItems=shuffle(valid.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
const newItems=shuffle(valid.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
let selected=[...dueItems,...weakItems,...newItems];
if(selected.length<count){
  const usedExprs=new Set(selected.map(x=>x.Expression));
  // â˜… í•µì‹¬: nextReviewê°€ ë¯¸ë˜ì¸ ë‹¨ì–´ ì œì™¸!
  const remaining=shuffle(valid.filter(x=>!usedExprs.has(x.Expression)&&isAvailable(x))).slice(0,count-selected.length);
  selected=[...selected,...remaining];
}
console.log('[ExprCloze] ì„ íƒ:',{due:dueItems.length,weak:weakItems.length,new:newItems.length,total:selected.length,availableInDB:valid.filter(isAvailable).length});
if(selected.length<5){showToast('âš ï¸ ì˜¤ëŠ˜ í•™ìŠµí•  ë¹ˆì¹¸ì±„ìš°ê¸°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
exprState={words:selected,allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0,originalCount:selected.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-cloze-total').textContent=selected.length;
showPage('expr-cloze');showExprClozeQ();
}
async function startExprQuizQuick(){
const exprs=await getAllExpr();
let valid=exprs.filter(e=>getMKO(e));
let filtered=exprFormalityFilter==='all'?valid:valid.filter(e=>e.Formality===exprFormalityFilter);
if(filtered.length<5){showToast('âš ï¸ í•™ìŠµí•  í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
const now=new Date();
const count=parseInt(localStorage.getItem('defaultCount')||'20');
// â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
// â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ : DUE 60% â†’ WEAK 30% â†’ NEW 10%
const dueCount=Math.ceil(count*0.6);
const weakCount=Math.ceil(count*0.3);
const newCount=count-dueCount-weakCount;
const dueItems=sortByFSRSPriority(filtered.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
const weakItems=shuffle(filtered.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
const newItems=shuffle(filtered.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
let selected=[...dueItems,...weakItems,...newItems];
if(selected.length<count){
  const usedExprs=new Set(selected.map(x=>x.Expression));
  // â˜… í•µì‹¬: nextReviewê°€ ë¯¸ë˜ì¸ ë‹¨ì–´ ì œì™¸!
  const remaining=shuffle(filtered.filter(x=>!usedExprs.has(x.Expression)&&isAvailable(x))).slice(0,count-selected.length);
  selected=[...selected,...remaining];
}
console.log('[ExprQuizQuick] ì„ íƒ:',{due:dueItems.length,weak:weakItems.length,new:newItems.length,total:selected.length,availableInDB:filtered.filter(isAvailable).length});
if(selected.length<5){showToast('âš ï¸ ì˜¤ëŠ˜ í•™ìŠµí•  í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
exprState={words:selected,allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0,originalCount:selected.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-quiz-total').textContent=selected.length;
document.getElementById('expr-quiz-retry-banner').classList.add('hidden');
showPage('expr-quiz');showExprQuizQ();
}
async function startExprWrong(){
const exprs=await getAllExpr();
const wrong=exprs.filter(e=>isWrong(e));
if(!wrong.length){showToast('âœ… ì˜¤ë‹µë…¸íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
const count=parseInt(localStorage.getItem('defaultCount')||'20');
const selected=shuffle(wrong).slice(0,count);
exprState={words:selected,allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null,originalCount:selected.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-fc-total').textContent=selected.length;
document.getElementById('expr-fc-current').textContent='0';
document.getElementById('expr-retry-banner').classList.add('hidden');
showToast('ğŸ“ ì˜¤ë‹µ '+wrong.length+'ê°œ ë³µìŠµ!');
showPage('expr-fc');startExprTimer();showExprCard();
}
async function startExprStarred(){
const exprs=await getAllExpr();
const starred=exprs.filter(e=>e.starred);
if(!starred.length){showToast('â­ ë¶ë§ˆí¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
const count=parseInt(localStorage.getItem('defaultCount')||'20');
const selected=shuffle(starred).slice(0,count);
exprState={words:selected,allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null,originalCount:selected.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-fc-total').textContent=selected.length;
document.getElementById('expr-fc-current').textContent='0';
document.getElementById('expr-retry-banner').classList.add('hidden');
showToast('â­ ë¶ë§ˆí¬ '+starred.length+'ê°œ í•™ìŠµ!');
showPage('expr-fc');startExprTimer();showExprCard();
}
async function startExprTagStudy(){
const sel=document.getElementById('home-expr-tag-select');
const tag=sel?.value;if(!tag){return;}
const exprs=await getAllExpr();
const tagged=exprs.filter(e=>(e.tags||[]).includes(tag));
if(!tagged.length){showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤');sel.value='';return;}
const count=parseInt(localStorage.getItem('defaultCount')||'20');
const selected=shuffle(tagged).slice(0,count);
exprState={words:selected,allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null,originalCount:selected.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-fc-total').textContent=selected.length;
document.getElementById('expr-fc-current').textContent='0';
document.getElementById('expr-retry-banner').classList.add('hidden');
showToast('ğŸ·ï¸ '+tag+' '+tagged.length+'ê°œ í•™ìŠµ!');
showPage('expr-fc');startExprTimer();showExprCard();
sel.value='';
}
async function startExprClozeQuick(){
const exprs=await getAllExpr();
const now=new Date();
const valid=exprs.filter(e=>{const ex=getEx(e);return ex&&ex.toLowerCase().includes(e.Expression.toLowerCase().split(' ')[0]);});
if(valid.length<5){showToast('âš ï¸ ë¹ˆì¹¸ì±„ìš°ê¸° ê°€ëŠ¥í•œ í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
const count=parseInt(localStorage.getItem('defaultCount')||'20');
// â˜… ë³µìŠµ í•„ìš” ì—†ëŠ” ë‹¨ì–´(ë¯¸ë˜) ì œì™¸ í•¨ìˆ˜
const isAvailable=x=>!x.nextReview||new Date(x.nextReview)<=now;
// â˜… FSRS ê¸°ë°˜ ë³µìŠµ ìš°ì„ : DUE 60% â†’ WEAK 30% â†’ NEW 10%
const dueCount=Math.ceil(count*0.6);
const weakCount=Math.ceil(count*0.3);
const newCount=count-dueCount-weakCount;
const dueItems=sortByFSRSPriority(valid.filter(x=>x.nextReview&&new Date(x.nextReview)<=now),now).slice(0,dueCount);
const weakItems=shuffle(valid.filter(x=>isWeak(x)&&isAvailable(x)&&!dueItems.includes(x))).slice(0,weakCount);
const newItems=shuffle(valid.filter(x=>!x.reviewCount||x.reviewCount===0)).slice(0,newCount);
let selected=[...dueItems,...weakItems,...newItems];
if(selected.length<count){
  const usedExprs=new Set(selected.map(x=>x.Expression));
  // â˜… í•µì‹¬: nextReviewê°€ ë¯¸ë˜ì¸ ë‹¨ì–´ ì œì™¸!
  const remaining=shuffle(valid.filter(x=>!usedExprs.has(x.Expression)&&isAvailable(x))).slice(0,count-selected.length);
  selected=[...selected,...remaining];
}
console.log('[ExprClozeQuick] ì„ íƒ:',{due:dueItems.length,weak:weakItems.length,new:newItems.length,total:selected.length,availableInDB:valid.filter(isAvailable).length});
if(selected.length<5){showToast('âš ï¸ ì˜¤ëŠ˜ í•™ìŠµí•  ë¹ˆì¹¸ì±„ìš°ê¸°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
if(dueItems.length>0)showToast(`ğŸ”„ ë³µìŠµ ${dueItems.length}ê°œ í¬í•¨`);
exprState={words:selected,allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0,originalCount:selected.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-cloze-total').textContent=selected.length;
showPage('expr-cloze');showExprClozeQ();
}
async function startExprDue(){
const exprs=await getAllExpr();const now=new Date();
const due=exprs.filter(e=>e.nextReview&&new Date(e.nextReview)<=now);
if(!due.length){showToast('âœ… ë³µìŠµí•  í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
const count=parseInt(localStorage.getItem('defaultCount')||'20');
// â˜… FSRS ìš°ì„ ìˆœìœ„ ì •ë ¬
const sorted=sortByFSRSPriority([...due],now);
const selected=sorted.slice(0,count);
exprState={words:selected,allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null,originalCount:selected.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-fc-total').textContent=selected.length;
document.getElementById('expr-fc-current').textContent='0';
document.getElementById('expr-retry-banner').classList.add('hidden');
showToast('ğŸ“… ë³µìŠµ '+due.length+'ê°œ!');
showPage('expr-fc');startExprTimer();showExprCard();
}
function startExprTimer(){
const el=document.getElementById('expr-fc-timer');
const s=Date.now();
if(exprState.timer)clearInterval(exprState.timer);
exprState.timer=setInterval(()=>{
const sec=Math.floor((Date.now()-s)/1000);
el.textContent=Math.floor(sec/60)+':'+(sec%60).toString().padStart(2,'0');
},1000);
}
function showExprCard(){
console.log('[showExprCard] idx:',exprState.idx,'words:',exprState.words?.length);
if(!exprState.words||!exprState.words.length){console.error('[showExprCard] No words!');return;}
const e=exprState.words[exprState.idx];
console.log('[showExprCard] e:',e,'Expression:',e?.Expression);
if(!e){
  if(exprState.retryQueue.length>0){
    exprState.words=[...exprState.retryQueue];exprState.retryQueue=[];exprState.idx=0;exprState.phase='retry';
    document.getElementById('expr-retry-banner').classList.remove('hidden');
    document.getElementById('expr-retry-count').textContent=exprState.words.length;
    document.getElementById('expr-fc-total').textContent=exprState.words.length;
    showToast('ğŸ”„ ëª¨ë¦„ '+exprState.words.length+'ê°œ ì¬ì¶œì œ!');
    showExprCard();return;
  }else{endExprFC();return;}
}
const card=document.getElementById('expr-fc-card');
// 1. ë’·ë©´ ë‚´ìš© ì¦‰ì‹œ ìˆ¨ê¹€
document.getElementById('expr-fc-back-inner').classList.remove('visible');
document.getElementById('expr-fc-meaning').textContent='';
document.getElementById('expr-fc-similar').innerHTML='';
document.getElementById('expr-fc-similar').style.display='none';
document.getElementById('expr-fc-example').textContent='';
document.getElementById('expr-fc-example').style.display='none';
document.getElementById('expr-fc-func').textContent='';
// 2. ì¹´ë“œ ë¦¬ì…‹
exprState.flipped=false;exprState.transitioning=false;exprState.intervalsCalculated=false;
card.classList.remove('flipped');
setExprRating(false);
// 3. ì§„í–‰ë¥ : ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
const exprUniqueCompleted=exprState.completedKeys?.size||0;
document.getElementById('expr-fc-progress').style.width=(exprUniqueCompleted/exprState.originalCount)*100+'%';
document.getElementById('expr-fc-current').textContent=exprUniqueCompleted;
document.getElementById('expr-fc-total').textContent=exprState.originalCount;
if(exprState.phase==='retry')document.getElementById('expr-retry-count').textContent=exprState.words.length-exprState.idx;
// 4. ì•ë©´ - Expression í‘œì‹œ
const exprText=e.Expression||'(í‘œí˜„ ì—†ìŒ)';
console.log('[showExprCard] Expression:',exprText);
document.getElementById('expr-fc-word').textContent=exprText;
document.getElementById('expr-fc-formality').textContent=e.Formality||'Neutral';
if(document.getElementById('setting-tts')?.checked)setTimeout(()=>speakExpr(),300);
updateExprFCBookmarkBtn();
updateExprFCTagBtn();
updateExprFCProductionBtn();
updateExprFCPrevBtn();
}
// ì´ì „ í‘œí˜„ ì¹´ë“œë¡œ ëŒì•„ê°€ê¸°
function prevExprCard(){
if(exprState.idx<=0)return;
exprState.idx--;
showExprCard();
}
function updateExprFCPrevBtn(){
const btn=document.getElementById('expr-fc-prev-btn');
if(btn){
btn.disabled=exprState.idx<=0;
btn.style.opacity=exprState.idx<=0?'0.4':'1';
}
}

function flipExprCard(){
if(exprState.transitioning)return;
const e=exprState.words[exprState.idx];if(!e)return;
if(exprState.flipped){
// ì¬í”Œë¦½: ì•ë©´ìœ¼ë¡œ
exprState.flipped=false;
document.getElementById('expr-fc-card').classList.remove('flipped');
document.getElementById('expr-fc-back-inner').classList.remove('visible');
setExprRating(false);
}else{
// í”Œë¦½: ë’·ë©´ìœ¼ë¡œ
const func=e.Function||e.L1||'';
document.getElementById('expr-fc-func').textContent=func?'[ '+func+' ]':'';
document.getElementById('expr-fc-meaning').textContent=getMKO(e)||e.Meaning_KO||'(ëœ» ì—†ìŒ)';
const sim=e.Similar_Expr;
const simEl=document.getElementById('expr-fc-similar');
if(sim){
const items=sim.split(/[,;]/).map(s=>s.trim()).filter(Boolean);
simEl.innerHTML='<div class="similar-title">ğŸ’¡ ìœ ì‚¬ í‘œí˜„</div>'+items.map(i=>'<div class="similar-item">â€¢ '+i+'</div>').join('');
simEl.style.display='block';
}else{simEl.style.display='none';}
const ex=getEx(e);
if(ex){document.getElementById('expr-fc-example').textContent=ex;document.getElementById('expr-fc-example').style.display='block';}
document.getElementById('expr-fc-back-inner').classList.add('visible');
exprState.flipped=true;
document.getElementById('expr-fc-card').classList.add('flipped');
setExprRating(true);vibrate(10);
}
}

function setExprRating(en){
// ë™ì  interval í‘œì‹œ (FSRS ê¸°ë°˜) - ì´ë¯¸ ê³„ì‚°ëœ ê²½ìš° ìŠ¤í‚µ
if(exprState.intervalsCalculated)return;
const e=exprState.words[exprState.idx];
if(e){
const result0 = calcNext({...e}, 0);
const result1 = calcNext({...e}, 1);
const result2 = calcNext({...e}, 2);
const result3 = calcNext({...e}, 3);
const intervals=['ë‹¤ì‹œ',
  formatInterval(result1),
  formatInterval(result2),
  formatInterval(result3)];
document.querySelectorAll('#expr-rating-grid .rating-interval').forEach((el,i)=>el.textContent=intervals[i]);
exprState.intervalsCalculated=true;
}
}

async function rateExprCard(r){
if(exprState.transitioning)return;
exprState.transitioning=true;
try{
const e=exprState.words[exprState.idx];if(!e){exprState.transitioning=false;return;}
// í†µê³„
if(r===0)exprState.stats.again++;else if(r===1)exprState.stats.hard++;else if(r===2)exprState.stats.good++;else exprState.stats.easy++;
// â˜… ì²« ì‹œë„ ì •ë‹µ/ì˜¤ë‹µ ì¹´ìš´íŠ¸ (isRetryê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
if(!e.isRetry){
  if(r>=2)exprState.firstTryCorrect++;
  else exprState.firstTryWrong++;
}
// â˜… ê³ ìœ  ì¹´ë“œ ì™„ë£Œ ì¶”ì  (ì¬ì¶œì œ ì¹´ë“œ ì œì™¸)
if(!e.isRetry&&exprState.completedKeys){
  exprState.completedKeys.add(e.Expression);
}
// 6. ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResultExpr = updateProductionStatus(e, r>=2, 'expr-fc');
if(prodResultExpr.shouldToast) showToast(prodResultExpr.message);
// 5. ì„¸ì…˜ ë‚´ ì¬í•™ìŠµ: ì˜¤ë‹µ ì‹œ 5~7ë¬¸ì œ í›„ ì¬ì¶œì œ
if(r===0&&exprState.phase==='normal'){
const insertIdx=Math.min(exprState.idx+5+Math.floor(Math.random()*3),exprState.words.length);
exprState.words.splice(insertIdx,0,{...e,isRetry:true});
}
else if(r===0&&exprState.phase==='retry'){updateWrong(e,false);exprState.savedToWrong++;}
else if(r>=2)updateWrong(e,true);
// DB ì—…ë°ì´íŠ¸ - ì¬ì¶œì œ ì¹´ë“œ(isRetry)ëŠ” FSRS ê±´ë„ˆë›°ê¸°
if(!e.isRetry){
try{
const fresh=await getExpr(e.Expression);
if(fresh){
fresh.reviewCount=(fresh.reviewCount||0)+1;
if(r>=2)fresh.correctCount=(fresh.correctCount||0)+1;
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜, eì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨)
updateMastery(fresh,r>=2);
updateInputOutput(fresh,false,r>=2); // â˜… Expr í”Œë˜ì‹œì¹´ë“œ = ì¸í’‹ ëª¨ë“œ
Object.assign(fresh,calcNext(fresh,r));
if(fresh.isLeech)showToast('ğŸŒ Leech: '+fresh.Expression);
await saveExpr(fresh);
Object.assign(e,fresh);
}
}catch(dbErr){console.error('rateExprCard DB error:',dbErr);}
}else{
console.log('[rateExprCard] isRetry card, skipping FSRS update');
}
vibrate(r>=2?10:[50,30,50]);exprState.idx++;
setTimeout(()=>{exprState.transitioning=false;showExprCard();},200);
}catch(e){console.error('rateExprCard error:',e);exprState.transitioning=false;}
}

function confirmEndExprFC(){
const ev=exprState.stats.again+exprState.stats.hard+exprState.stats.good+exprState.stats.easy;
if(ev===0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ì•„ì§ í‰ê°€í•œ í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',()=>{if(exprState.timer)clearInterval(exprState.timer);endExprFC(true);});
else if(exprState.idx<exprState.words.length||exprState.retryQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ í‘œí˜„ì´ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endExprFC);
else endExprFC();
}

async function endExprFC(skip){
if(exprState.timer){clearInterval(exprState.timer);exprState.timer=null;}
const total=exprState.stats.again+exprState.stats.hard+exprState.stats.good+exprState.stats.easy;
if(total===0||skip){showPage(studyStartPage,true);showToast('í•™ìŠµì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');return;}
const known=exprState.stats.good+exprState.stats.easy;
const acc=Math.round((known/total)*100);
await saveSession({total:total,accuracy:acc,mode:'expr-fc',type:'expr',stats:exprState.stats,duration:Math.round((Date.now()-exprState.start)/1000),uniqueTotal:exprState.originalCount,firstTryCorrect:exprState.firstTryCorrect,firstTryWrong:exprState.firstTryWrong});
// ì™„ë£Œ ëª¨ë‹¬
document.getElementById('qc-total').textContent=total;
document.getElementById('qc-correct').textContent=known;
document.getElementById('qc-wrong').textContent=exprState.stats.again;
document.getElementById('qc-acc').textContent=acc+'%';
if(exprState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=exprState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
function updateExprFCBookmarkBtn(){
const e=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-fc-bookmark-btn');
if(btn&&e){btn.textContent=e.starred?'â­':'â˜†';btn.style.color=e.starred?'var(--warning)':'';}
}
function speakExpr(){
const e=exprState.words?.[exprState.idx];if(!e)return;
const u=new SpeechSynthesisUtterance(e.Expression);
u.lang='en-US';u.rate=0.85;
speechSynthesis.cancel();speechSynthesis.speak(u);
}
async function toggleExprFCBookmark(){
const e=exprState.words[exprState.idx];if(!e)return;
const fresh=await getExpr(e.Expression);
if(!fresh)return;
fresh.starred=!fresh.starred;
await saveExpr(fresh);
e.starred=fresh.starred;
updateExprFCBookmarkBtn();
showToast(fresh.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}
async function openExprFCEdit(){
const e=exprState.words[exprState.idx];if(!e)return;
await openExprEditModal(e.Expression);
}
// í‘œí˜„ 5ì§€ì„ ë‹¤ í€´ì¦ˆ
function showExprQuizQ(){
if(exprState.idx>=exprState.words.length){
if(exprState.retryQueue.length>0&&exprState.phase==='normal'){
exprState.words=[...exprState.retryQueue];exprState.retryQueue=[];exprState.idx=0;exprState.phase='retry';
document.getElementById('expr-quiz-retry-banner').classList.remove('hidden');
document.getElementById('expr-quiz-retry-count').textContent=exprState.words.length;
showToast('ğŸ”„ ì˜¤ë‹µ '+exprState.words.length+'ê°œ ì¬ì¶œì œ!');
showExprQuizQ();return;
}else{endExprQuiz();return;}
}
const e=exprState.words[exprState.idx];
console.log('[ExprQuiz] item:',e);
if(!e||!e.Expression){console.error('Invalid expression item:',e);exprState.idx++;showExprQuizQ();return;}
exprState.answered=false;
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
const quizUniqueCompleted=exprState.completedKeys?.size||0;
document.getElementById('expr-quiz-progress').style.width=(quizUniqueCompleted/exprState.originalCount)*100+'%';
document.getElementById('expr-quiz-current').textContent=quizUniqueCompleted;
document.getElementById('expr-quiz-total').textContent=exprState.originalCount;
document.getElementById('expr-quiz-correct').textContent=exprState.correct;
document.getElementById('expr-quiz-wrong').textContent=exprState.wrong;
// í‘œí˜„ í‘œì‹œ
const exprText=e.Expression||'(í‘œí˜„ ì—†ìŒ)';
document.getElementById('expr-quiz-word').textContent=exprText;
document.getElementById('expr-quiz-tags').innerHTML=`<span class="tag" style="background:rgba(249,115,22,.2);color:var(--expr)">${e.Formality||'Neutral'}</span>`;
// Functionì€ ì •ë‹µ í›„ í‘œì‹œ
const funcEl=document.getElementById('expr-quiz-func');
funcEl.textContent=e.Function||'';
funcEl.style.display='none';
// ë³´ê¸° ìƒì„±
const cAns=getMKO(e);
if(!cAns){console.error('No meaning for expression:',e);exprState.idx++;showExprQuizQ();return;}
const pool=exprState.allWords.filter(x=>x.Expression!==e.Expression&&getMKO(x)&&getMKO(x)!==cAns);
const dist=getExprDistractors(e,pool,4);
const wAns=dist.map(d=>getMKO(d)).filter(m=>m&&m!==cAns);
const uniqueWAns=[...new Set(wAns)].slice(0,4);
const opts=shuffle([cAns,...uniqueWAns]);
console.log('[ExprQuiz]',{expr:exprText,cAns,distractors:uniqueWAns.length});
document.getElementById('expr-quiz-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectExprQuiz(this,'${escapeHtml(o)}','${escapeHtml(cAns)}')">${o}</button>`).join('');
document.getElementById('expr-quiz-next-btn').classList.add('hidden');
document.getElementById('expr-quiz-rating-bar').classList.add('hidden');
updateExprQuizBookmarkBtn();
updateExprQuizTagBtn();
updateExprQuizProductionBtn();
}
async function selectExprQuiz(el,sel,ans){
try{
if(exprState.answered)return;
exprState.answered=true;
const ok=sel===ans;
const e=exprState.words[exprState.idx];
const isRetry=e.isRetry||false;
document.querySelectorAll('#expr-quiz-options .quiz-option').forEach(b=>{
b.disabled=true;
if(b.textContent===ans)b.classList.add('correct');
else if(b===el&&!ok)b.classList.add('wrong');
});
const funcEl=document.getElementById('expr-quiz-func');
if(e.Function)funcEl.style.display='block';
// â˜… í†µê³„: ì²« ì‹œë„ë§Œ correct/wrong ì¹´ìš´íŠ¸, firstTry ì¹´ìš´íŠ¸
if(ok){
  if(!isRetry){exprState.correct++;exprState.firstTryCorrect++;}
  if(!isRetry&&exprState.completedKeys)exprState.completedKeys.add(e.Expression); // ê³ ìœ  ì¹´ë“œ ì™„ë£Œ
  vibrate(10);
}else{
  if(!isRetry){exprState.wrong++;exprState.firstTryWrong++;}
  vibrate([50,30,50]);
  if(exprState.phase==='normal')exprState.retryQueue.push({...e,isRetry:true});
  else{updateWrong(e,false);exprState.savedToWrong++;if(!isRetry&&exprState.completedKeys)exprState.completedKeys.add(e.Expression);} // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ
}
if(!isRetry){
try{
const fresh=await getExpr(e.Expression);
if(fresh){
fresh.reviewCount=(fresh.reviewCount||0)+1;
if(ok)fresh.correctCount=(fresh.correctCount||0)+1;
updateMastery(fresh,ok);
updateInputOutput(fresh,false,ok); // â˜… Expr í€´ì¦ˆ = ì¸í’‹ ëª¨ë“œ
// â˜… FSRS: ì˜¤ë‹µë§Œ ë°”ë¡œ Again(0) ì ìš©, ì •ë‹µì€ rating ì„ íƒ ì‹œ ì ìš©
if(!ok){
  Object.assign(fresh,calcNext(fresh,0));
  if(fresh.isLeech)showToast('ğŸŒ Leech: '+fresh.Expression);
  updateWrong(fresh,false);
}else{
  updateWrong(fresh,true);
}
await saveExpr(fresh);
Object.assign(e,fresh);
}
}catch(dbErr){console.error(dbErr);}
}
document.getElementById('expr-quiz-correct').textContent=exprState.correct;
document.getElementById('expr-quiz-wrong').textContent=exprState.wrong;
// â˜… ì •ë‹µ: rating bar í‘œì‹œ + 2ì´ˆ í›„ Hard(1) FSRS ì ìš© / ì˜¤ë‹µ: 1.5ì´ˆ í›„ ìë™ ë„˜ê¹€
if(ok){
document.getElementById('expr-quiz-rating-bar').classList.remove('hidden');
exprState.autoNextTimer=setTimeout(()=>{
  skipExprQuizRating(); // Good(2) FSRS ì ìš©
},2000);
}else{
setTimeout(()=>nextExprQuiz(),1500);
}
}catch(e){console.error('selectExprQuiz error:',e);exprState.answered=false;}
}
async function rateExprQuizItem(grade){
try{
// ìë™ ë„˜ê¹€ íƒ€ì´ë¨¸ ì·¨ì†Œ
if(exprState.autoNextTimer){clearTimeout(exprState.autoNextTimer);exprState.autoNextTimer=null;}
const e=exprState.words[exprState.idx];
// â˜… í†µê³„ëŠ” ì´ë¯¸ selectExprQuizì—ì„œ ì €ì¥ë¨, ì—¬ê¸°ì„œëŠ” FSRSë§Œ ì ìš©
try{
const fresh=await getExpr(e.Expression);
if(fresh){
Object.assign(fresh,calcNext(fresh,grade));
if(fresh.isLeech)showToast('ğŸŒ Leech: '+fresh.Expression);
await saveExpr(fresh);
}
}catch(dbErr){console.error(dbErr);}
document.getElementById('expr-quiz-rating-bar').classList.add('hidden');
nextExprQuiz();
}catch(e){console.error('rateExprQuizItem error:',e);nextExprQuiz();}
}
function skipExprQuizRating(){
// â˜… ìŠ¤í‚µ ì‹œ Good(2)ë¡œ FSRS ìë™ ì ìš©
rateExprQuizItem(2);
}
function nextExprQuiz(){exprState.idx++;showExprQuizQ();}
function confirmEndExprQuiz(){
if(exprState.idx<exprState.words.length||exprState.retryQueue.length>0)
showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endExprQuiz);
else endExprQuiz();
}
async function endExprQuiz(){
const total=exprState.correct+exprState.wrong;
if(!total){showPage(studyStartPage,true);return;}
const acc=Math.round((exprState.correct/total)*100);
await saveSession({total,correct:exprState.correct,wrong:exprState.wrong,accuracy:acc,mode:'expr-quiz',type:'expr',duration:Math.round((Date.now()-exprState.start)/1000),uniqueTotal:exprState.originalCount,firstTryCorrect:exprState.firstTryCorrect,firstTryWrong:exprState.firstTryWrong});
document.getElementById('qc-total').textContent=total;
document.getElementById('qc-correct').textContent=exprState.correct;
document.getElementById('qc-wrong').textContent=exprState.wrong;
document.getElementById('qc-acc').textContent=acc+'%';
if(exprState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=exprState.savedToWrong;}
else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
function speakExprQuiz(){
const e=exprState.words?.[exprState.idx];if(!e)return;
const u=new SpeechSynthesisUtterance(e.Expression);u.lang='en-US';u.rate=0.85;
speechSynthesis.cancel();speechSynthesis.speak(u);
}
function updateExprQuizBookmarkBtn(){
const e=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-quiz-bookmark-btn');
if(btn&&e){btn.textContent=e.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';btn.style.color=e.starred?'var(--warning)':'';}
}
async function toggleExprQuizBookmark(){
const e=exprState.words[exprState.idx];if(!e)return;
const fresh=await getExpr(e.Expression);if(!fresh)return;
fresh.starred=!fresh.starred;
await saveExpr(fresh);
e.starred=fresh.starred;
updateExprQuizBookmarkBtn();
showToast(fresh.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
}
async function openExprQuizEdit(){
const e=exprState.words[exprState.idx];if(!e)return;
await openExprEditModal(e.Expression);
}
function escapeHtml(t){return(t||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');}
// í‘œí˜„ ê²€ìƒ‰
async function exprSearch(){
const q=document.getElementById('expr-search-input').value.trim();
const qLower=q.toLowerCase();
exprQSQuery=q;
if(!q){document.getElementById('expr-search-result').style.display='none';return;}
const exprs=await getAllExpr();
let found=exprs.find(e=>(e.Expression||'').toLowerCase()===qLower);
if(found){exprQSResult=found;showExprQSResult(found,true);return;}
found=exprs.find(e=>(e.Expression||'').toLowerCase().includes(qLower)||qLower.includes((e.Expression||'').toLowerCase()));
if(found){exprQSResult=found;showExprQSResult(found,false);return;}
exprQSResult=null;
document.getElementById('expr-search-result').style.display='block';
document.getElementById('expr-qs-found').style.display='none';
document.getElementById('expr-qs-notfound').style.display='block';
document.getElementById('expr-qs-new-word').textContent=q;
document.getElementById('expr-qs-new-meaning').value='';
document.getElementById('expr-qs-add-bookmark').checked=true;
}
function showExprQSResult(e,isExact){
document.getElementById('expr-search-result').style.display='block';
document.getElementById('expr-qs-found').style.display='block';
document.getElementById('expr-qs-notfound').style.display='none';
document.getElementById('expr-qs-word').textContent=e.Expression;
document.getElementById('expr-qs-formality').textContent=e.Formality||'Neutral';
document.getElementById('expr-qs-func').textContent=e.Function||e.L1+' > '+e.L2||'';
document.getElementById('expr-qs-meaning').textContent=getMKO(e)||'';
const ex=getEx(e);
const exEl=document.getElementById('expr-qs-example');
if(ex){exEl.textContent=ex;exEl.style.display='block';}else{exEl.style.display='none';}
const sim=e.Similar_Expr;
if(sim){document.getElementById('expr-qs-similar-list').textContent=sim;document.getElementById('expr-qs-similar').style.display='block';}else{document.getElementById('expr-qs-similar').style.display='none';}
const notThis=document.getElementById('expr-qs-not-this');
if(!isExact&&exprQSQuery.toLowerCase()!==(e.Expression||'').toLowerCase()){
notThis.style.display='block';document.getElementById('expr-qs-original').textContent=exprQSQuery;
}else{notThis.style.display='none';}
const btn=document.getElementById('expr-qs-bookmark-btn');
btn.textContent=e.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
btn.style.color=e.starred?'var(--warning)':'';
}
async function exprQSToggleBookmark(){
if(!exprQSResult)return;
exprQSResult.starred=!exprQSResult.starred;
await saveExpr(exprQSResult);
const btn=document.getElementById('expr-qs-bookmark-btn');
btn.textContent=exprQSResult.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
btn.style.color=exprQSResult.starred?'var(--warning)':'';
showToast(exprQSResult.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}
async function exprQSEdit(){
if(!exprQSResult)return;
document.getElementById('expr-search-result').style.display='none';
// â˜… ìˆ˜ì •: ì‹¤ì œ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸° (ë¯¸êµ¬í˜„ â†’ êµ¬í˜„)
await openExprEditModal(exprQSResult.Expression);
}
function showExprAddNew(){
document.getElementById('expr-qs-found').style.display='none';
document.getElementById('expr-qs-notfound').style.display='block';
document.getElementById('expr-qs-new-word').textContent=exprQSQuery;
document.getElementById('expr-qs-new-meaning').value='';
document.getElementById('expr-qs-add-bookmark').checked=true;
}
async function exprQSSaveNew(){
const expr=document.getElementById('expr-qs-new-word').textContent.trim();
const meaning=document.getElementById('expr-qs-new-meaning').value.trim();
if(!expr){showToast('âŒ í‘œí˜„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
if(!meaning){showToast('âŒ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
const addBookmark=document.getElementById('expr-qs-add-bookmark').checked;
// â˜… ìˆ˜ì •: FSRS ë° í†µê³„ í•„ë“œ ì¶”ê°€ (saveNewWordì™€ ë™ì¼í•˜ê²Œ)
const newExpr={
  Expression:expr,
  Meaning_KO:meaning,
  Register:'Neutral',
  starred:addBookmark,
  tags:[],
  addedDate:new Date().toISOString(),
  // FSRS í•„ë“œ
  stability:null,
  difficulty:null,
  fsrsState:'New',
  reps:0,
  lapses:0,
  // í•™ìŠµ í†µê³„
  reviewCount:0,
  correctCount:0,
  mastery:0,
  consecutiveWrong:0,
  wrongCount:0,
  nextReview:null,
  lastReview:null,
  lastWrongDate:null,
  // ì¸í’‹/ì•„ì›ƒí’‹ í†µê³„
  inputReviewCount:0,
  inputCorrectCount:0,
  outputReviewCount:0,
  outputCorrectCount:0
};
await saveExpr(newExpr);
document.getElementById('expr-search-result').style.display='none';
document.getElementById('expr-search-input').value='';
showToast(addBookmark?'âœ… ì €ì¥ + â­ ë¶ë§ˆí¬ ì¶”ê°€':'âœ… ì €ì¥ ì™„ë£Œ');
updateHomeStats();
}
function exprQSAddDetail(){
// â˜… ìˆ˜ì •: ì…ë ¥ì°½ì´ ì•„ë‹Œ ì €ì¥ëœ ê²€ìƒ‰ì–´(exprQSQuery) ë˜ëŠ” í‘œì‹œëœ ë‹¨ì–´ ì‚¬ìš©
const q = document.getElementById('expr-qs-new-word')?.textContent?.trim() || exprQSQuery || '';
document.getElementById('expr-search-result').style.display='none';
switchAddType('expr');
openAddWordModal(q);
}
function filterExprRegister(r){
exprFormalityFilter=r;
document.querySelectorAll('#home-expr .chip').forEach(c=>c.classList.toggle('active',c.dataset.filter===r));
}
// í‘œí˜„ ë¹ˆì¹¸ì±„ìš°ê¸°
function showExprClozeQ(){
const e=exprState.words[exprState.idx];
if(!e){endExprCloze();return;}
exprState.answered=false;
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
const clozeUniqueCompleted=exprState.completedKeys?.size||0;
document.getElementById('expr-cloze-progress').style.width=((clozeUniqueCompleted/exprState.originalCount)*100)+'%';
document.getElementById('expr-cloze-current').textContent=clozeUniqueCompleted;
document.getElementById('expr-cloze-total').textContent=exprState.originalCount;
document.getElementById('expr-cloze-correct').textContent=exprState.correct;
document.getElementById('expr-cloze-wrong').textContent=exprState.wrong;
// ì˜ˆë¬¸ì—ì„œ í‘œí˜„ ë¹ˆì¹¸ ì²˜ë¦¬ â˜… escapeRegex ì ìš©
let ex=getEx(e);
const expr=e.Expression;
const firstWord=expr.split(' ')[0].toLowerCase();
const regex=new RegExp('\\b'+escapeRegex(firstWord)+'\\b[^.]*','gi');
const blanked=ex.replace(regex,'________');
document.getElementById('expr-cloze-sentence').innerHTML=blanked;
document.getElementById('expr-cloze-hint').textContent=getMKO(e)||e.Function||'';
// ì„ íƒì§€ ìƒì„±
const correct=expr;
const pool=exprState.allWords.filter(x=>x.Expression!==expr).map(x=>x.Expression);
const distractors=shuffle(pool).slice(0,3);
const options=shuffle([correct,...distractors]);
document.getElementById('expr-cloze-options').innerHTML=options.map(o=>`<button class="quiz-option" onclick="selectExprCloze(this)" data-ans="${o===correct}">${o}</button>`).join('');
updateExprClozeBookmarkBtn();
updateExprClozeProductionBtn();
}
async function selectExprCloze(el){
console.log('[selectExprCloze] called, answered:',exprState.answered);
if(exprState.answered){console.log('[selectExprCloze] already answered, skip');return;}
exprState.answered=true;
const ok=el.dataset.ans==='true';
const e=exprState.words[exprState.idx];
const isRetry=e.isRetry||false;
console.log('[selectExprCloze] e:',e?.Expression,'ok:',ok,'isRetry:',isRetry);
// â˜… í†µê³„: ì²« ì‹œë„ë§Œ correct/wrong ì¹´ìš´íŠ¸, firstTry ì¹´ìš´íŠ¸
if(ok){
  if(!isRetry){exprState.correct++;exprState.firstTryCorrect++;}
  if(!isRetry&&exprState.completedKeys)exprState.completedKeys.add(e.Expression); // ê³ ìœ  ì¹´ë“œ ì™„ë£Œ
}else{
  if(!isRetry){exprState.wrong++;exprState.firstTryWrong++;}
  if(exprState.phase==='normal')exprState.retryQueue.push({...e,isRetry:true});
  else if(!isRetry&&exprState.completedKeys)exprState.completedKeys.add(e.Expression); // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ
}
document.querySelectorAll('#expr-cloze-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
// ì¬ì¶œì œ ì¹´ë“œê°€ ì•„ë‹ ë•Œë§Œ ì²˜ë¦¬
if(!isRetry){
e.reviewCount=(e.reviewCount||0)+1;if(ok)e.correctCount=(e.correctCount||0)+1;
updateMastery(e,ok);
updateInputOutput(e,false,ok); // â˜… Expr í´ë¡œì¦ˆ = ì¸í’‹ ëª¨ë“œ
// â˜… FSRS: ì˜¤ë‹µë§Œ ë°”ë¡œ Again(0) ì ìš©, ì •ë‹µì€ rating ì„ íƒ ì‹œ ì ìš©
if(!ok){
  try{Object.assign(e,calcNext(e,0));if(e.isLeech)showToast('ğŸŒ Leech: '+e.Expression);await saveExpr(e);}catch(err){console.error('[selectExprCloze] save error:',err);}
  updateWrong(e,false);
}else{
  updateWrong(e,true);
  try{await saveExpr(e);}catch(err){console.error('[selectExprCloze] save error:',err);} // í†µê³„ë§Œ ì €ì¥
}
}else{console.log('[selectExprCloze] isRetry card, skipping FSRS');}
document.getElementById('expr-cloze-correct').textContent=exprState.correct;
document.getElementById('expr-cloze-wrong').textContent=exprState.wrong;
// â˜… ì •ë‹µ: rating bar + 2ì´ˆ í›„ Hard(1) FSRS ì ìš© / ì˜¤ë‹µ: 1.5ì´ˆ í›„ ìë™ ë„˜ê¹€
if(ok){
  document.getElementById('expr-cloze-rating-bar').classList.remove('hidden');
  exprState.autoNextTimer=setTimeout(()=>{
    skipExprClozeRating(); // Good(2) FSRS ì ìš©
  },2000);
}else{
  setTimeout(()=>{exprState.idx++;exprState.answered=false;showExprClozeQ();},1500);
}
}
// â˜… Expr-Cloze rating í•¨ìˆ˜ë“¤
async function rateExprClozeItem(grade){
if(exprState.autoNextTimer){clearTimeout(exprState.autoNextTimer);exprState.autoNextTimer=null;}
const e=exprState.words[exprState.idx];
try{Object.assign(e,calcNext(e,grade));if(e.isLeech)showToast('ğŸŒ Leech: '+e.Expression);await saveExpr(e);}catch(err){console.error(err);}
document.getElementById('expr-cloze-rating-bar').classList.add('hidden');
exprState.idx++;exprState.answered=false;showExprClozeQ();
}
function skipExprClozeRating(){
// â˜… ìŠ¤í‚µ ì‹œ Good(2)ë¡œ FSRS ìë™ ì ìš©
rateExprClozeItem(2);
}
async function endExprCloze(){
const ans=exprState.correct+exprState.wrong;if(!ans){showPage(studyStartPage,true);return;}
const acc=Math.round((exprState.correct/ans)*100);
await saveSession({total:ans,correct:exprState.correct,wrong:exprState.wrong,accuracy:acc,mode:'expr-cloze',type:'expr',duration:Math.round((Date.now()-exprState.start)/1000),uniqueTotal:exprState.originalCount,firstTryCorrect:exprState.firstTryCorrect,firstTryWrong:exprState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=exprState.correct;document.getElementById('qc-wrong').textContent=exprState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
function confirmEndExprCloze(){
if(exprState.idx<exprState.words.length)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endExprCloze);
else endExprCloze();
}
// ë¹ˆì¹¸ì±„ìš°ê¸° ì•¡ì…˜ë°” í•¸ë“¤ëŸ¬
function speakExprCloze(){
const e=exprState.words?.[exprState.idx];
if(e)speakText(e.Expression);
}
async function toggleExprClozeBookmark(){
const e=exprState.words?.[exprState.idx];if(!e)return;
const fresh=await getExpr(e.Expression);if(!fresh)return;
fresh.starred=!fresh.starred;
await saveExpr(fresh);
e.starred=fresh.starred;
updateExprClozeBookmarkBtn();
showToast(fresh.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updateExprClozeBookmarkBtn(){
const e=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-cloze-bookmark-btn');
if(btn&&e)btn.textContent=e.starred?'â˜…':'â˜†';
}
async function toggleExprClozeProduction(){
const e=exprState.words?.[exprState.idx];if(!e)return;
const fresh=await getExpr(e.Expression);if(!fresh)return;
fresh.needsProduction=!fresh.needsProduction;
await saveExpr(fresh);
e.needsProduction=fresh.needsProduction;
updateExprClozeProductionBtn();
showToast(fresh.needsProduction?'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”':'âœ… í•´ì œ');
}
function updateExprClozeProductionBtn(){
const e=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-cloze-production-btn');
if(btn&&e){btn.textContent=e.needsProduction?'âœ…ğŸ–Šï¸':'ğŸ–Šï¸';btn.style.background=e.needsProduction?'var(--success)':'';}
}
async function openExprClozeEdit(){
const e=exprState.words?.[exprState.idx];if(!e)return;
await openExprEditModal(e.Expression);
}
// === í‘œí˜„ ì“°ê¸° ëª¨ë“œ ===
// â˜… exprTypingStateëŠ” ìƒë‹¨ì—ì„œ ì„ ì–¸ë¨ (ì¤‘ë³µ ì œê±°)
function showExprTypingQ(){
try{
// â˜… ì¬ì¶œì œ ë¡œì§
if(exprTypingState.idx>=exprTypingState.words.length){
  if(exprTypingState.retryQueue.length>0&&exprTypingState.phase==='normal'){
    exprTypingState.words=[...exprTypingState.retryQueue];exprTypingState.retryQueue=[];exprTypingState.idx=0;exprTypingState.phase='retry';
    document.getElementById('expr-typing-retry-banner')?.classList.remove('hidden');
    const retryCount=document.getElementById('expr-typing-retry-count');if(retryCount)retryCount.textContent=exprTypingState.words.length;
    showToast('ğŸ”„ ì˜¤ë‹µ '+exprTypingState.words.length+'ê°œ ì¬ì¶œì œ!');
  }else if(exprTypingState.finalQueue.length>0&&exprTypingState.phase==='retry'){
    exprTypingState.words=[...exprTypingState.finalQueue];exprTypingState.finalQueue=[];exprTypingState.idx=0;exprTypingState.phase='final';
    const retryCount=document.getElementById('expr-typing-retry-count');if(retryCount)retryCount.textContent=exprTypingState.words.length;
    showToast('âš ï¸ ìµœì¢… '+exprTypingState.words.length+'ê°œ ì¬ì¶œì œ!');
  }else{endExprTyping();return;}
}
const e=exprTypingState.words[exprTypingState.idx];
if(!e){endExprTyping();return;} // â˜… null ì²´í¬
exprTypingState.hintUsed=false;
exprTypingState.answered=false;
// â˜… ì§„í–‰ë°”: ì™„ë£Œëœ ê³ ìœ  ì¹´ë“œ / ì›ë˜ ì¹´ë“œ ìˆ˜
document.getElementById('expr-typing-current').textContent=exprTypingState.completed;
document.getElementById('expr-typing-total').textContent=exprTypingState.originalCount;
document.getElementById('expr-typing-correct').textContent=exprTypingState.correct;
document.getElementById('expr-typing-wrong').textContent=exprTypingState.wrong;
document.getElementById('expr-typing-progress').style.width=((exprTypingState.completed/exprTypingState.originalCount)*100)+'%';
if(exprTypingState.phase!=='normal'){const rc=document.getElementById('expr-typing-retry-count');if(rc)rc.textContent=exprTypingState.words.length-exprTypingState.idx;}
document.getElementById('expr-typing-meaning').textContent=getMKO(e)||'';
document.getElementById('expr-typing-func').textContent=e.Function||'';
document.getElementById('expr-typing-formality').textContent=e.Formality?`[${e.Formality}]`:'';
const ex=getEx(e);
const exEl=document.getElementById('expr-typing-example');
if(ex&&exEl){exEl.textContent=ex.replace(new RegExp(escapeRegex(e.Expression||''),'gi'),'_____');exEl.classList.remove('hidden');}
else if(exEl)exEl.classList.add('hidden');
const inp=document.getElementById('expr-typing-input');if(inp){inp.value='';inp.disabled=false;inp.focus();}
document.getElementById('expr-typing-answer')?.classList.add('hidden');
const btn=document.getElementById('expr-typing-submit-btn');if(btn){btn.textContent='í™•ì¸';btn.onclick=checkExprTyping;}
const hintBtn=document.getElementById('expr-typing-hint-btn');if(hintBtn)hintBtn.disabled=false;
}catch(err){console.error('showExprTypingQ error:',err);showToast('âŒ ë¬¸ì œ í‘œì‹œ ì˜¤ë¥˜');endExprTyping();}
}
function showExprTypingHint(){
if(exprTypingState.hintUsed)return;
exprTypingState.hintUsed=true;
const e=exprTypingState.words[exprTypingState.idx];
const expr=e.Expression;
const hint=expr.substring(0,Math.ceil(expr.length/3))+'...';
document.getElementById('expr-typing-input').placeholder=hint;
document.getElementById('expr-typing-hint-btn').disabled=true;
showToast('ğŸ’¡ íŒíŠ¸: '+hint);
}
async function checkExprTyping(){
try{
if(exprTypingState.answered){exprTypingState.idx++;showExprTypingQ();return;}
const e=exprTypingState.words[exprTypingState.idx];
if(!e){showToast('âš ï¸ ë¬¸ì œ ì˜¤ë¥˜');endExprTyping();return;} // â˜… null ì²´í¬
// â˜… normalizeAnswer ì ìš© (í—ˆìš© ë³€ì´ ì²˜ë¦¬)
const inp=document.getElementById('expr-typing-input');
const input=normalizeAnswer(inp?.value||'');
const correct=normalizeAnswer(e.Expression||'');
// â˜… Alternatives ì§€ì›: ","ì™€ ";" ë‘˜ ë‹¤ êµ¬ë¶„ìë¡œ í—ˆìš©
const alternatives=(e.Alternatives||'').split(/[,;]/).map(a=>normalizeAnswer(a)).filter(a=>a);
const allCorrect=[correct,...alternatives];
const isExactMatch=input===correct;
const isAltMatch=!isExactMatch&&alternatives.some(alt=>input===alt);
const isCorrect=isExactMatch||isAltMatch;
exprTypingState.answered=true;
document.getElementById('expr-typing-input').disabled=true;
const ansEl=document.getElementById('expr-typing-answer');
ansEl.classList.remove('hidden');
const isRetry=e.isRetry||false; // ì¬ì¶œì œ ì¹´ë“œ ì—¬ë¶€
// â˜… í†µê³„: ì²« ì‹œë„ë§Œ correct/wrong ì¹´ìš´íŠ¸, firstTry ì¹´ìš´íŠ¸
if(isCorrect){
  if(!isRetry){exprTypingState.correct++;exprTypingState.firstTryCorrect++;}
  exprTypingState.completed++; // ì •ë‹µ = ì¹´ë“œ ì™„ë£Œ
  if(isAltMatch){
    ansEl.innerHTML='âœ… ì •ë‹µ!<br><span style="font-size:14px;opacity:0.8">ğŸ’¡ í•™ìŠµ í‘œí˜„: <strong>'+e.Expression+'</strong></span>';
  }else{
    ansEl.textContent='âœ… ì •ë‹µ!';
  }
  ansEl.style.background='rgba(34,197,94,.2)';
  ansEl.style.color='var(--success)';
}else{
  if(!isRetry){exprTypingState.wrong++;exprTypingState.firstTryWrong++;}
  // ì¬ì¶œì œ íì— ì¶”ê°€
  if(exprTypingState.phase==='normal')exprTypingState.retryQueue.push({...e,isRetry:true});
  else if(exprTypingState.phase==='retry')exprTypingState.finalQueue.push({...e,isRetry:true});
  else{exprTypingState.savedToWrong++;exprTypingState.completed++;} // finalì—ì„œ í‹€ë ¤ë„ ì™„ë£Œ
  // ì˜¤ë‹µ ì‹œ ëŒ€ì²´ í‘œí˜„ì´ ìˆìœ¼ë©´ í•¨ê»˜ í‘œì‹œ
  let altInfo='';
  if(alternatives.length>0){
    altInfo='<br><span style="font-size:12px;opacity:0.7">ëŒ€ì²´: '+alternatives.slice(0,3).join(', ')+(alternatives.length>3?' ì™¸':'')+'</span>';
  }
  ansEl.innerHTML='âŒ ì˜¤ë‹µ<br><span style="font-size:20px">'+e.Expression+'</span>'+altInfo;
  ansEl.style.background='rgba(239,68,68,.2)';
  ansEl.style.color='var(--danger)';
}
// â˜… ì¬ì¶œì œê°€ ì•„ë‹ ë•Œë§Œ DB ì—…ë°ì´íŠ¸
if(!isRetry){
// DBì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
const fresh=await getExpr(e.Expression);
if(fresh){
fresh.reviewCount=(fresh.reviewCount||0)+1;
if(isCorrect){
fresh.correctCount=(fresh.correctCount||0)+1;
updateMastery(fresh,true);
updateInputOutput(fresh,true,!exprTypingState.hintUsed); // â˜… Expr íƒ€ì´í•‘ = ì•„ì›ƒí’‹ ëª¨ë“œ
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
const prodResult = updateProductionStatus(fresh, !exprTypingState.hintUsed, 'expr-typing');
if(prodResult.shouldToast) showToast(prodResult.message);
if(!exprTypingState.hintUsed){
updateWrong(fresh,true);
// â˜… Free Recall ì •ë‹µ = Easy(3)
Object.assign(fresh,calcNext(fresh,3));
}else{
Object.assign(fresh,calcNext(fresh,2)); // íŒíŠ¸ ì‚¬ìš© = Good
}
}else{
updateMastery(fresh,false);
updateWrong(fresh,false);
updateInputOutput(fresh,true,false); // â˜… ì•„ì›ƒí’‹ ì˜¤ë‹µ
// â˜… ì‚°ì¶œ ì—°ìŠµ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜) - ì˜¤ë‹µì´ë¼ê³  ì‚°ì¶œ ì—°ìŠµ ì•ˆ ê°
updateProductionStatus(fresh, false, 'expr-typing');
Object.assign(fresh,calcNext(fresh,0)); // Again
if(fresh.isLeech)showToast('ğŸŒ Leech: '+fresh.Expression);
}
await saveExpr(fresh);
Object.assign(e,fresh);
}
}
document.getElementById('expr-typing-correct').textContent=exprTypingState.correct;
document.getElementById('expr-typing-wrong').textContent=exprTypingState.wrong;
document.getElementById('expr-typing-submit-btn').textContent='ë‹¤ìŒ â†’';
}catch(err){console.error('checkExprTyping error:',err);showToast('âŒ í™•ì¸ ì˜¤ë¥˜');}
}
function confirmEndExprTyping(){
if(exprTypingState.idx<exprTypingState.words.length||exprTypingState.retryQueue.length>0||exprTypingState.finalQueue.length>0){
  showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endExprTyping);
}else endExprTyping();
}
async function endExprTyping(){
try{
const ans=exprTypingState.correct+exprTypingState.wrong;if(!ans){showPage(studyStartPage,true);return;}
const acc=Math.round((exprTypingState.correct/ans)*100);
await saveSession({total:ans,correct:exprTypingState.correct,wrong:exprTypingState.wrong,accuracy:acc,mode:'expr-typing',type:'expr',duration:Math.round((Date.now()-(exprTypingState.start||Date.now()))/1000),uniqueTotal:exprTypingState.originalCount,firstTryCorrect:exprTypingState.firstTryCorrect,firstTryWrong:exprTypingState.firstTryWrong});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=exprTypingState.correct;document.getElementById('qc-wrong').textContent=exprTypingState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
document.getElementById('qc-wrong-info')?.classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}catch(e){console.error('endExprTyping error:',e);showPage(studyStartPage,true);showToast('âŒ ì¢…ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜');}
}
// í•™ìŠµ ì„¤ì •ì—ì„œ í‘œí˜„ í•™ìŠµ ì‹œì‘
async function startExprStudySession(){
const exprs=await getAllExpr();
if(!exprs.length){showToast('ğŸ’¬ í‘œí˜„ DBê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
const count=parseInt(document.getElementById('expr-study-count').value)||20;
// â˜… chip-multi í•„í„°
const masteryF=getMultiChip('expr-filter-mastery');
const cefrF=getMultiChip('expr-filter-cefr');
const priorityF=getMultiChip('expr-filter-priority');
const formalityF=getMultiChip('expr-filter-formality');
const currencyF=getMultiChip('expr-filter-currency');
const mediumF=getMultiChip('expr-filter-medium');
const order=document.getElementById('option-order').value;
const now=new Date();
const today=now.toDateString();
const mode=document.querySelector('#study-expr .mode-card.active')?.dataset.mode||'expr-fc';
const isTypingMode=mode==='expr-typing';
let filtered=exprs.filter(x=>{
  if(!checkMasteryFilter(x,masteryF))return false;
  if(!checkMultiFilter(x.CEFR||'B1',cefrF))return false;
  if(!checkMultiFilter(x.Priority||'P2',priorityF))return false;
  if(!checkMultiFilter(x.Formality||'Neutral',formalityF))return false;
  if(!checkMultiFilter(x.Currency||'Current',currencyF))return false;
  if(!checkMultiFilter(x.Medium||'Both',mediumF))return false;
  return true;
});
if(!filtered.length){showToast('âš ï¸ í•™ìŠµí•  í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
// â˜… ì˜¤ëŠ˜ ì¶”ê°€ â†’ ê¸°íƒ€ ìƒˆ ë‹¨ì–´ â†’ ê¸°ì¡´ í•™ìŠµ
const todayAdded=shuffle(filtered.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today));
const otherNew=shuffle(filtered.filter(x=>(!x.addedDate||new Date(x.addedDate).toDateString()!==today)&&(!x.reviewCount||x.reviewCount===0)));
const oldW=shuffle(filtered.filter(x=>x.reviewCount>0));
let sel;
if(isTypingMode){
  const prodW=shuffle(filtered.filter(x=>x.needsProduction));
  const otherProd=todayAdded.filter(x=>!x.needsProduction);
  sel=[...prodW,...otherProd,...otherNew,...oldW].slice(0,count);
}else if(order==='random'){
  sel=[...todayAdded,...otherNew,...oldW].slice(0,count);
}else if(order==='weak'){
  sel=[...todayAdded,...otherNew,...oldW].sort((a,b)=>getWeaknessScore(a)-getWeaknessScore(b)).slice(0,count);
}else{
  const dueW=filtered.filter(x=>x.reviewCount>0&&x.nextReview&&new Date(x.nextReview)<=now);
  sel=[...todayAdded,...otherNew,...sortByFSRSPriority(dueW,now)].slice(0,count);
}
if(!sel.length){showToast('âš ï¸ í•™ìŠµí•  í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
// ì˜¤ëŠ˜ ì¶”ê°€ í† ìŠ¤íŠ¸
if(todayAdded.length>0&&!isTypingMode)showToast(`ğŸ†• ì˜¤ëŠ˜ ì¶”ê°€ ${Math.min(todayAdded.length,count)}ê°œ í¬í•¨`);
// â˜… ì˜¤ë‹µ ìë™ í¬í•¨ (íƒ€ì´í•‘ ì œì™¸)
let wrongAdded=0;
const wrongAutoEnabled=localStorage.getItem('wrongAuto')!=='false';
if(wrongAutoEnabled&&!isTypingMode){
const wrongLimit=parseInt(localStorage.getItem('wrongLimit')||'5');
const wrongBonus=Math.min(wrongLimit,Math.floor(count/5));
if(wrongBonus>0){
const wrongExprs=exprs.filter(x=>isWrong(x)&&!sel.some(f=>f.Expression===x.Expression));
const wrongToAdd=shuffle(wrongExprs).slice(0,wrongBonus);
wrongAdded=wrongToAdd.length;
wrongToAdd.forEach(w=>{
const insertIdx=Math.floor(Math.random()*(sel.length+1));
sel.splice(insertIdx,0,w);
});
}
}
if(mode==='expr-cloze'){
const valid=sel.filter(e=>{const ex=getEx(e);return ex&&ex.toLowerCase().includes(e.Expression.toLowerCase().split(' ')[0]);});
if(!valid.length){showToast('âš ï¸ ë¹ˆì¹¸ì±„ìš°ê¸° ê°€ëŠ¥í•œ í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
exprState={words:valid,allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0,originalCount:valid.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
showPage('expr-cloze');showExprClozeQ();
}else if(mode==='expr-quiz'){
const valid=sel.filter(e=>getMKO(e));
if(valid.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
exprState={words:valid,allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0,originalCount:valid.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-quiz-total').textContent=valid.length;
document.getElementById('expr-quiz-retry-banner').classList.add('hidden');
showPage('expr-quiz');showExprQuizQ();
}else if(mode==='expr-typing'){
const valid=sel.filter(e=>getMKO(e));
if(!valid.length){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
exprTypingState={words:valid,idx:0,correct:0,wrong:0,hintUsed:false,answered:false,start:Date.now(),retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,originalCount:valid.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-typing-total').textContent=valid.length;
document.getElementById('expr-typing-retry-banner').classList.add('hidden');
showPage('expr-typing');showExprTypingQ();
}else if(mode==='expr-listening'){
const valid=sel.filter(e=>getMKO(e));
if(valid.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
startListening(valid,exprs,'expr');
}else if(mode==='expr-dictation'){
const valid=sel.filter(e=>getMKO(e));
if(!valid.length){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
startDictation(valid,exprs,'expr');
}else{
exprState={words:sel,allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null,originalCount:sel.length,completed:0,firstTryCorrect:0,firstTryWrong:0};
document.getElementById('expr-fc-total').textContent=sel.length;
document.getElementById('expr-fc-current').textContent='0';
document.getElementById('expr-retry-banner').classList.add('hidden');
if(wrongAdded>0)showToast(`ğŸ“ ì˜¤ë‹µ ${wrongAdded}ê°œ í¬í•¨`);
showPage('expr-fc');startExprTimer();showExprCard();
}
}

// === í†µê³„ ===
async function updateHomeStats(){
try{const w=await getAllWords(),p=await getAllPV(),e=await getAllExpr(),now=new Date();
const today=now.toDateString();
document.getElementById('stat-total').textContent=w.length;document.getElementById('stat-mastered').textContent=w.filter(x=>(x.mastery||0)>=80).length;document.getElementById('stat-weak').textContent=w.filter(x=>isWeak(x)).length;document.getElementById('stat-due').textContent=w.filter(x=>x.nextReview&&new Date(x.nextReview)<=now).length;
const wV=w.filter(x=>isWrong(x)).length,bV=document.getElementById('wrong-badge-vocab');if(wV>0){bV.textContent=wV;bV.classList.remove('hidden');}else bV.classList.add('hidden');
const sV=w.filter(x=>x.starred).length;document.getElementById('star-badge-vocab').textContent=sV;
const pV=w.filter(x=>x.needsProduction).length,pbV=document.getElementById('prod-badge-vocab');if(pV>0){pbV.textContent=pV;pbV.classList.remove('hidden');}else pbV.classList.add('hidden');
// â˜… ìƒˆ ë‹¨ì–´ ë±ƒì§€: ì˜¤ëŠ˜ ì¶”ê°€ëœ ê²ƒ + ì•„ì§ í•™ìŠµ ì•ˆ í•œ ê²ƒ
const newV=w.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today&&(!x.reviewCount||x.reviewCount===0)).length;
const nbV=document.getElementById('new-badge-vocab');if(nbV){if(newV>0){nbV.textContent=newV;nbV.classList.remove('hidden');}else nbV.classList.add('hidden');}
// ë³µìŠµ í•„ìš” ë±ƒì§€ (ì–´íœ˜) - ê¸°ì¡´ í•™ìŠµí•œ ê²ƒ ì¤‘ ë³µìŠµ ì˜ˆì •ì¸ ê²ƒ
const dueV=w.filter(x=>x.reviewCount>0&&x.nextReview&&new Date(x.nextReview)<=now).length;
const dbV=document.getElementById('due-badge-vocab');if(dbV){if(dueV>0){dbV.textContent=dueV>99?'99+':dueV;dbV.classList.remove('hidden');}else dbV.classList.add('hidden');}
document.getElementById('pv-stat-total').textContent=p.length;document.getElementById('pv-stat-mastered').textContent=p.filter(x=>(x.mastery||0)>=80).length;document.getElementById('pv-stat-weak').textContent=p.filter(x=>isWeak(x)).length;document.getElementById('pv-stat-due').textContent=p.filter(x=>x.nextReview&&new Date(x.nextReview)<=now).length;
const wP=p.filter(x=>isWrong(x)).length,bP=document.getElementById('wrong-badge-pv');if(wP>0){bP.textContent=wP;bP.classList.remove('hidden');}else bP.classList.add('hidden');
const sP=p.filter(x=>x.starred).length;document.getElementById('star-badge-pv').textContent=sP;
const pP=p.filter(x=>x.needsProduction).length,pbP=document.getElementById('prod-badge-pv');if(pP>0){pbP.textContent=pP;pbP.classList.remove('hidden');}else pbP.classList.add('hidden');
// â˜… ìƒˆ ë‹¨ì–´ ë±ƒì§€ (êµ¬ë™ì‚¬): ì˜¤ëŠ˜ ì¶”ê°€ëœ ê²ƒ
const newP=p.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today&&(!x.reviewCount||x.reviewCount===0)).length;
const nbP=document.getElementById('new-badge-pv');if(nbP){if(newP>0){nbP.textContent=newP;nbP.classList.remove('hidden');}else nbP.classList.add('hidden');}
// ë³µìŠµ í•„ìš” ë±ƒì§€ (êµ¬ë™ì‚¬)
const dueP=p.filter(x=>x.reviewCount>0&&x.nextReview&&new Date(x.nextReview)<=now).length;
const dbP=document.getElementById('due-badge-pv');if(dbP){if(dueP>0){dbP.textContent=dueP>99?'99+':dueP;dbP.classList.remove('hidden');}else dbP.classList.add('hidden');}
// Expression stats
document.getElementById('expr-stat-total').textContent=e.length;document.getElementById('expr-stat-mastered').textContent=e.filter(x=>(x.mastery||0)>=80).length;document.getElementById('expr-stat-weak').textContent=e.filter(x=>isWeak(x)).length;document.getElementById('expr-stat-due').textContent=e.filter(x=>x.nextReview&&new Date(x.nextReview)<=now).length;
const wE=e.filter(x=>isWrong(x)).length,bE=document.getElementById('wrong-badge-expr');if(wE>0){bE.textContent=wE;bE.classList.remove('hidden');}else bE.classList.add('hidden');
const sE=e.filter(x=>x.starred).length;document.getElementById('star-badge-expr').textContent=sE;
const pE=e.filter(x=>x.needsProduction).length,pbE=document.getElementById('prod-badge-expr');if(pbE){if(pE>0){pbE.textContent=pE;pbE.classList.remove('hidden');}else pbE.classList.add('hidden');}
// â˜… ìƒˆ ë‹¨ì–´ ë±ƒì§€ (í‘œí˜„): ì˜¤ëŠ˜ ì¶”ê°€ëœ ê²ƒ
const newE=e.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today&&(!x.reviewCount||x.reviewCount===0)).length;
const nbE=document.getElementById('new-badge-expr');if(nbE){if(newE>0){nbE.textContent=newE;nbE.classList.remove('hidden');}else nbE.classList.add('hidden');}
// ë³µìŠµ í•„ìš” ë±ƒì§€ (í‘œí˜„)
const dueE=e.filter(x=>x.reviewCount>0&&x.nextReview&&new Date(x.nextReview)<=now).length;
const dbE=document.getElementById('due-badge-expr');if(dbE){if(dueE>0){dbE.textContent=dueE>99?'99+':dueE;dbE.classList.remove('hidden');}else dbE.classList.add('hidden');}
if(w.length>0||p.length>0||e.length>0)document.getElementById('db-status').innerHTML=`<p style="color:var(--success)">âœ… ì–´íœ˜ ${w.length} / êµ¬ë™ì‚¬ ${p.length} / í‘œí˜„ ${e.length}</p>`;
const streak=parseInt(localStorage.getItem('streak')||'0');if(streak>0){document.getElementById('streak-banner').classList.remove('hidden');document.getElementById('streak-days').textContent=streak;}else document.getElementById('streak-banner').classList.add('hidden');
// í™ˆ í™”ë©´ íƒœê·¸ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
updateHomeTagSelects(w,p,e);
// íƒœê·¸ í•„í„° ì—…ë°ì´íŠ¸
updateTagFilters(w,p,e);
await updateDailyGoal();
}catch(e){console.error(e);}}
async function updateStatsPage(){
try{const w=await getAllWords(),s=await getSessions(),now=new Date();
document.getElementById('stats-total').textContent=w.length;document.getElementById('stats-mastered').textContent=w.filter(x=>(x.mastery||0)>=80).length;document.getElementById('stats-learning').textContent=w.filter(x=>(x.reviewCount||0)>0&&(x.mastery||0)<80).length;document.getElementById('stats-new').textContent=w.filter(x=>!(x.reviewCount||0)).length;
let high=0,mid=0,low=0;w.forEach(x=>{const a=getAcc(x);if(a===null)return;if(a>=80)high++;else if(a>=50)mid++;else low++;});
document.getElementById('stats-high').textContent=high;document.getElementById('stats-mid').textContent=mid;document.getElementById('stats-low').textContent=low;
const boxes=[0,0,0,0,0];w.forEach(x=>{const b=Math.min(5,Math.max(1,x.leitnerBox||1));boxes[b-1]++;});
document.getElementById('leitner-stats').innerHTML=boxes.map((c,i)=>`<div class="leitner-box box-${i+1}" onclick="startBoxStudy(${i+1},'vocab')" style="cursor:pointer" title="Box ${i+1} í•™ìŠµ"><div class="leitner-count">${c}</div><div class="leitner-label">Box ${i+1}</div></div>`).join('');
// í•™ìŠµ ë¶„ì„ (ì´ ì‹œê°„, ì„¸ì…˜ ìˆ˜, í‰ê·  ì •ë‹µë¥ , ì˜ˆìƒ ë§ê°)
const vocabSessions=s.filter(x=>x.type==='vocab'||!x.type);
// â˜… ì¸í’‹/ì•„ì›ƒí’‹ í†µê³„
const inputSessions=vocabSessions.filter(x=>!isOutputMode(x.mode));
const outputSessions=vocabSessions.filter(x=>isOutputMode(x.mode));
const inputTotal=inputSessions.reduce((sum,x)=>sum+(x.total||0),0);
const outputTotal=outputSessions.reduce((sum,x)=>sum+(x.total||0),0);
const inputAccs=inputSessions.filter(x=>x.accuracy!==undefined).map(x=>x.accuracy);
const outputAccs=outputSessions.filter(x=>x.accuracy!==undefined).map(x=>x.accuracy);
document.getElementById('stats-input-count').textContent=inputTotal;
document.getElementById('stats-output-count').textContent=outputTotal;
document.getElementById('stats-input-acc').textContent=inputAccs.length?Math.round(inputAccs.reduce((a,b)=>a+b,0)/inputAccs.length)+'%':'-';
document.getElementById('stats-output-acc').textContent=outputAccs.length?Math.round(outputAccs.reduce((a,b)=>a+b,0)/outputAccs.length)+'%':'-';
// â˜… ì²« ì‹œë„ ì •ë‹µë¥  ê³„ì‚°
const inputFirstCorrect=inputSessions.reduce((sum,x)=>sum+(x.firstTryCorrect||0),0);
const inputFirstTotal=inputSessions.reduce((sum,x)=>sum+((x.firstTryCorrect||0)+(x.firstTryWrong||0)),0);
const outputFirstCorrect=outputSessions.reduce((sum,x)=>sum+(x.firstTryCorrect||0),0);
const outputFirstTotal=outputSessions.reduce((sum,x)=>sum+((x.firstTryCorrect||0)+(x.firstTryWrong||0)),0);
document.getElementById('stats-input-first').textContent=inputFirstTotal?Math.round((inputFirstCorrect/inputFirstTotal)*100)+'%':'-';
document.getElementById('stats-output-first').textContent=outputFirstTotal?Math.round((outputFirstCorrect/outputFirstTotal)*100)+'%':'-';
const totalTime=vocabSessions.reduce((sum,x)=>sum+(x.duration||0),0);
const totalMin=Math.floor(totalTime/60);
document.getElementById('stats-time').textContent=totalMin>=60?Math.floor(totalMin/60)+'ì‹œê°„ '+totalMin%60+'ë¶„':totalMin+'ë¶„';
document.getElementById('stats-sessions').textContent=vocabSessions.length;
const accs=vocabSessions.filter(x=>x.accuracy!==undefined).map(x=>x.accuracy);
document.getElementById('stats-avg-acc').textContent=accs.length?Math.round(accs.reduce((a,b)=>a+b,0)/accs.length)+'%':'-';
// ì˜ˆìƒ ë§ê° (í–¥í›„ 7ì¼ ë‚´ retrievability < 0.7)
let forgetCount=0;
w.forEach(x=>{if(x.nextReview&&x.stability){const daysUntil=(new Date(x.nextReview)-now)/(1000*60*60*24);if(daysUntil<=7){const R=FSRS.retrievability(Math.max(0,-daysUntil)+(x.interval||1),x.stability);if(R<0.7)forgetCount++;}}});
document.getElementById('stats-forget').textContent=forgetCount;
// â˜… FSRS ì•ˆì •ë„(Stability) ë¶„í¬
let stab0_3=0,stab3_7=0,stab7_30=0,stab30=0;
w.forEach(x=>{const s=x.stability||0;if(s<3)stab0_3++;else if(s<7)stab3_7++;else if(s<30)stab7_30++;else stab30++;});
document.getElementById('stability-0-3').textContent=stab0_3;
document.getElementById('stability-3-7').textContent=stab3_7;
document.getElementById('stability-7-30').textContent=stab7_30;
document.getElementById('stability-30-plus').textContent=stab30;
// â˜… Card States (Anki ìŠ¤íƒ€ì¼) í†µê³„
let stateNew=0,stateLearning=0,stateRelearning=0,stateYoung=0,stateMature=0;
w.forEach(x=>{
  const state=FSRS.getCardState(x);
  if(state==='New')stateNew++;
  else if(state==='Learning')stateLearning++;
  else if(state==='Relearning')stateRelearning++;
  else if(state==='Young')stateYoung++;
  else if(state==='Mature')stateMature++;
});
document.getElementById('state-new').textContent=stateNew;
document.getElementById('state-learning').textContent=stateLearning;
document.getElementById('state-relearning').textContent=stateRelearning;
document.getElementById('state-young').textContent=stateYoung;
document.getElementById('state-mature').textContent=stateMature;
// â˜… Leech ì¹´ë“œ í†µê³„
const leechCards=w.filter(x=>(x.lapses||0)>=FSRS.leechThreshold||x.isLeech).slice(0,10);
document.getElementById('leech-count').textContent=leechCards.length?`(${leechCards.length}ê°œ)`:'';
document.getElementById('leech-list').innerHTML=leechCards.length?leechCards.map((c,i)=>`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)"><span>${i+1}. ${c.word}</span><span style="color:var(--danger)">${c.lapses||0}íšŒ ì‹¤íŒ¨</span></div>`).join(''):'<div style="color:var(--success);text-align:center;padding:10px">âœ… Leech ì¹´ë“œ ì—†ìŒ</div>';
// â˜… 7ì¼ ë¦¬ë·° ì˜ˆì¸¡ ì°¨íŠ¸
const forecast=[0,0,0,0,0,0,0];
w.forEach(x=>{if(x.nextReview){const d=Math.floor((new Date(x.nextReview)-now)/(1000*60*60*24));if(d>=0&&d<7)forecast[d]++;}});
const maxF=Math.max(...forecast,1);
document.getElementById('forecast-chart').innerHTML=forecast.map((v,i)=>`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar" style="height:${Math.max(4,(v/maxF)*60)}px;background:${v>20?'var(--danger)':v>10?'var(--warning)':'var(--primary)'}"></div><div class="chart-bar-label">${i===0?'ì˜¤ëŠ˜':i===1?'ë‚´ì¼':i+'ì¼í›„'}</div></div>`).join('');
// â˜… Hard Cards Top 10
const hardCards=w.filter(x=>(x.reviewCount||0)>0).map(x=>({word:x.word,wrongRate:x.wrongCount?(x.wrongCount/(x.reviewCount||1)):0,wrongCount:x.wrongCount||0,lapses:x.lapses||0})).sort((a,b)=>(b.wrongRate+b.lapses*0.1)-(a.wrongRate+a.lapses*0.1)).slice(0,10);
document.getElementById('hard-cards-list').innerHTML=hardCards.length?hardCards.map((c,i)=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span>${i+1}. ${c.word}</span><span style="color:var(--danger)">${Math.round(c.wrongRate*100)}% ì˜¤ë‹µ (${c.wrongCount}íšŒ)</span></div>`).join(''):'<div style="color:var(--muted);text-align:center;padding:20px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
// ì·¨ì•½ ë¶„ì„
const posStats={},catStats={};
w.filter(x=>isWeak(x)).forEach(x=>{if(x.POS)posStats[x.POS]=(posStats[x.POS]||0)+1;if(x.L1)catStats[x.L1]=(catStats[x.L1]||0)+1;});
const topPos=Object.entries(posStats).sort((a,b)=>b[1]-a[1]).slice(0,3);
const topCat=Object.entries(catStats).sort((a,b)=>b[1]-a[1]).slice(0,3);
let analysisHTML='';
if(topPos.length)analysisHTML+=`<div style="margin-bottom:8px">ğŸ“ <strong>ì·¨ì•½ í’ˆì‚¬:</strong> ${topPos.map(([k,v])=>`${k}(${v})`).join(', ')}</div>`;
if(topCat.length)analysisHTML+=`<div style="margin-bottom:8px">ğŸ“ <strong>ì·¨ì•½ ì¹´í…Œê³ ë¦¬:</strong> ${topCat.map(([k,v])=>`${k}(${v})`).join(', ')}</div>`;
if(!analysisHTML)analysisHTML='<div style="color:var(--success)">âœ… íŠ¹ë³„íˆ ì·¨ì•½í•œ ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤!</div>';
document.getElementById('weak-analysis').innerHTML=analysisHTML;
// ì£¼ê°„ ì°¨íŠ¸
const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],wd=[0,0,0,0,0,0,0];
const nowDate=new Date(now.toDateString());
vocabSessions.forEach(x=>{
const sessDate=new Date(new Date(x.date).toDateString());
const diff=Math.floor((nowDate-sessDate)/86400000);
if(diff>=0&&diff<7)wd[6-diff]+=(x.total||0);
});
const max=Math.max(...wd,1);document.getElementById('weekly-chart').innerHTML=wd.map((v,i)=>{const d=(now.getDay()-6+i+7)%7;return`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar" style="height:${Math.max(4,(v/max)*120)}px"></div><div class="chart-bar-label">${days[d]}</div></div>`;}).join('');
// ì›”ê°„ ì°¨íŠ¸ (30ì¼)
const md=[0,0,0,0];// 4ì£¼
vocabSessions.forEach(x=>{const diff=Math.floor((nowDate-new Date(new Date(x.date).toDateString()))/86400000);const week=Math.floor(diff/7);if(week>=0&&week<4)md[3-week]+=(x.total||0);});
const maxM=Math.max(...md,1);
document.getElementById('monthly-chart').innerHTML=md.map((v,i)=>`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar" style="height:${Math.max(4,(v/maxM)*80)}px;background:linear-gradient(180deg,#818cf8,#6366f1)"></div><div class="chart-bar-label">${i===3?'ì´ë²ˆì£¼':i===2?'1ì£¼ì „':i===1?'2ì£¼ì „':'3ì£¼ì „'}</div></div>`).join('');
// â˜… 30ì¼ ì²«ì‹œë„ ì •ë‹µë¥  ì¶”ì´ ì°¨íŠ¸
const ftData=[];
for(let i=29;i>=0;i--){
  const targetDate=new Date(nowDate);targetDate.setDate(targetDate.getDate()-i);
  const dateStr=targetDate.toDateString();
  const daySessions=vocabSessions.filter(x=>new Date(x.date).toDateString()===dateStr);
  const ftc=daySessions.reduce((sum,x)=>sum+(x.firstTryCorrect||0),0);
  const ftt=daySessions.reduce((sum,x)=>sum+((x.firstTryCorrect||0)+(x.firstTryWrong||0)),0);
  ftData.push({day:i,acc:ftt>0?Math.round((ftc/ftt)*100):null});
}
const validFt=ftData.filter(x=>x.acc!==null);
const maxFt=Math.max(...validFt.map(x=>x.acc),100);
const ftChart=document.getElementById('first-try-chart');
ftChart.style.justifyContent='flex-start';ftChart.style.gap='2px';ftChart.style.overflowX='auto';ftChart.style.paddingBottom='4px';
ftChart.innerHTML=ftData.map((d,i)=>{
  if(d.acc===null)return`<div style="width:6px;flex-shrink:0"><div class="chart-bar" style="height:2px;width:6px;background:var(--border);border-radius:1px"></div></div>`;
  const color=d.acc>=80?'var(--success)':d.acc>=60?'var(--warning)':'var(--danger)';
  return`<div style="width:6px;flex-shrink:0" title="${29-i}ì¼ì „: ${d.acc}%"><div class="chart-bar" style="height:${Math.max(4,(d.acc/maxFt)*60)}px;width:6px;background:${color};border-radius:2px"></div></div>`;
}).join('');
// â˜… FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ: stability ë†’ì€ë° ìµœê·¼ í‹€ë¦° ì¹´ë“œ
const sevenDaysAgo=new Date(now.getTime()-7*24*60*60*1000);
const fsrsFailCards=w.filter(x=>{
  if(!x.stability||x.stability<7)return false; // ì•ˆì •ë„ 7ì¼ ì´ìƒë§Œ
  if(!x.lastWrongDate)return false;
  const lastWrong=new Date(x.lastWrongDate);
  return lastWrong>=sevenDaysAgo; // ìµœê·¼ 7ì¼ ë‚´ ì˜¤ë‹µ
}).map(x=>{
  const R=x.stability?FSRS.retrievability((now-new Date(x.lastReview||now))/(1000*60*60*24),x.stability):0;
  return{word:x.word,stability:x.stability,R:Math.round(R*100),wrongDate:x.lastWrongDate};
}).sort((a,b)=>b.stability-a.stability).slice(0,10);
document.getElementById('fsrs-fail-count').textContent=fsrsFailCards.length?`(${fsrsFailCards.length}ê°œ)`:'';
document.getElementById('fsrs-fail-list').innerHTML=fsrsFailCards.length?fsrsFailCards.map((c,i)=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span>${i+1}. ${c.word}</span><span style="color:var(--danger)">S:${Math.round(c.stability)}ì¼ R:${c.R}%</span></div>`).join(''):'<div style="color:var(--success);text-align:center;padding:15px">âœ… ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ ì—†ìŒ</div>';
document.getElementById('fsrs-fail-study-btn').style.display=fsrsFailCards.length?'inline-block':'none';
// â˜… ì¸ì§€â†”ìƒì‚° ê°­ ë¶„ì„: ì¸í’‹ì—ì„œëŠ” ì˜ ë§ì¶”ëŠ”ë° ì•„ì›ƒí’‹ì—ì„œ ì•½í•œ ì¹´ë“œ
const gapCards=w.filter(x=>{
  const inputR=x.inputReviewCount||0;
  const outputR=x.outputReviewCount||0;
  const inputAcc=inputR?((x.inputCorrectCount||0)/inputR)*100:null;
  const outputAcc=outputR?((x.outputCorrectCount||0)/outputR)*100:null;
  // ì¡°ê±´1: ì¸í’‹ì—ì„œ 70%+ ë§ì¶”ëŠ”ë° ì•„ì›ƒí’‹ì—ì„œ 50% ë¯¸ë§Œ
  // ì¡°ê±´2: ì¸í’‹ ê²½í—˜ ìˆì§€ë§Œ ì•„ì›ƒí’‹ ê²½í—˜ ì—†ìŒ
  // ì¡°ê±´3: needsProduction í”Œë˜ê·¸
  if(inputAcc!==null&&inputAcc>=70){
    if(outputAcc!==null&&outputAcc<50)return true;
    if(outputR===0)return true;
  }
  return x.needsProduction&&inputR>0;
}).map(x=>{
  const inputR=x.inputReviewCount||0;
  const outputR=x.outputReviewCount||0;
  const inputAcc=inputR?Math.round(((x.inputCorrectCount||0)/inputR)*100):null;
  const outputAcc=outputR?Math.round(((x.outputCorrectCount||0)/outputR)*100):null;
  return{word:x.word,inputAcc,outputAcc,inputR,outputR};
}).sort((a,b)=>{
  // ê°­ì´ í° ìˆœì„œë¡œ ì •ë ¬
  const aGap=(a.inputAcc||0)-(a.outputAcc||0);
  const bGap=(b.inputAcc||0)-(b.outputAcc||0);
  return bGap-aGap;
}).slice(0,10);
const gapCount=w.filter(x=>x.needsProduction||(x.inputReviewCount>0&&!x.outputReviewCount)).length;
document.getElementById('gap-count').textContent=gapCount?`(${gapCount}ê°œ)`:'';
document.getElementById('gap-analysis').innerHTML=gapCards.length?
  `<div style="margin-bottom:8px;color:var(--muted)">ì¸ì§€â†”ìƒì‚° ê²©ì°¨ê°€ í° ì¹´ë“œ:</div>`+
  gapCards.map((c,i)=>{
    const inputStr=c.inputAcc!==null?`ì¸í’‹ ${c.inputAcc}%`:'ì¸í’‹ -';
    const outputStr=c.outputAcc!==null?`ìƒì‚° ${c.outputAcc}%`:(c.inputR>0?'ìƒì‚° ë¯¸ì‹œë„':'');
    return`<div style="display:flex;justify-content:space-between;padding:4px 0"><span>${i+1}. ${c.word}</span><span style="font-size:11px">${inputStr} | ${outputStr}</span></div>`;
  }).join('')
  :'<div style="color:var(--success);text-align:center;padding:15px">âœ… ì¸ì§€â†”ìƒì‚° ê°­ ì—†ìŒ</div>';
document.getElementById('gap-study-btn').style.display=gapCount?'inline-block':'none';
}catch(e){console.error(e);}}
async function updatePVStats(){
try{const p=await getAllPV(),s=await getSessions(),now=new Date();
document.getElementById('pv-stats-total').textContent=p.length;document.getElementById('pv-stats-mastered').textContent=p.filter(x=>(x.mastery||0)>=80).length;document.getElementById('pv-stats-learning').textContent=p.filter(x=>(x.reviewCount||0)>0&&(x.mastery||0)<80).length;document.getElementById('pv-stats-new').textContent=p.filter(x=>!(x.reviewCount||0)).length;
let high=0,mid=0,low=0;p.forEach(x=>{const a=getAcc(x);if(a===null)return;if(a>=80)high++;else if(a>=50)mid++;else low++;});
document.getElementById('pv-stats-high').textContent=high;document.getElementById('pv-stats-mid').textContent=mid;document.getElementById('pv-stats-low').textContent=low;
// â˜… ì¸í’‹/ì•„ì›ƒí’‹ í†µê³„
const pvSessions=s.filter(x=>x.type==='phrasal');
const pvInputSessions=pvSessions.filter(x=>x.mode!=='dictation');
const pvOutputSessions=pvSessions.filter(x=>x.mode==='dictation');
const pvInputTotal=pvInputSessions.reduce((sum,x)=>sum+(x.total||0),0);
const pvOutputTotal=pvOutputSessions.reduce((sum,x)=>sum+(x.total||0),0);
const pvInputAccs=pvInputSessions.filter(x=>x.accuracy!==undefined).map(x=>x.accuracy);
const pvOutputAccs=pvOutputSessions.filter(x=>x.accuracy!==undefined).map(x=>x.accuracy);
document.getElementById('pv-stats-input-count').textContent=pvInputTotal;
document.getElementById('pv-stats-output-count').textContent=pvOutputTotal;
document.getElementById('pv-stats-input-acc').textContent=pvInputAccs.length?Math.round(pvInputAccs.reduce((a,b)=>a+b,0)/pvInputAccs.length)+'%':'-';
document.getElementById('pv-stats-output-acc').textContent=pvOutputAccs.length?Math.round(pvOutputAccs.reduce((a,b)=>a+b,0)/pvOutputAccs.length)+'%':'-';
// â˜… ì²« ì‹œë„ ì •ë‹µë¥  ê³„ì‚°
const pvInputFirstCorrect=pvInputSessions.reduce((sum,x)=>sum+(x.firstTryCorrect||0),0);
const pvInputFirstTotal=pvInputSessions.reduce((sum,x)=>sum+((x.firstTryCorrect||0)+(x.firstTryWrong||0)),0);
const pvOutputFirstCorrect=pvOutputSessions.reduce((sum,x)=>sum+(x.firstTryCorrect||0),0);
const pvOutputFirstTotal=pvOutputSessions.reduce((sum,x)=>sum+((x.firstTryCorrect||0)+(x.firstTryWrong||0)),0);
document.getElementById('pv-stats-input-first').textContent=pvInputFirstTotal?Math.round((pvInputFirstCorrect/pvInputFirstTotal)*100)+'%':'-';
document.getElementById('pv-stats-output-first').textContent=pvOutputFirstTotal?Math.round((pvOutputFirstCorrect/pvOutputFirstTotal)*100)+'%':'-';
// â˜… í•™ìŠµ ë¶„ì„
const totalTime=pvSessions.reduce((sum,x)=>sum+(x.duration||0),0);
const totalMin=Math.floor(totalTime/60);
document.getElementById('pv-stats-time').textContent=totalMin>=60?Math.floor(totalMin/60)+'ì‹œê°„ '+totalMin%60+'ë¶„':totalMin+'ë¶„';
document.getElementById('pv-stats-sessions').textContent=pvSessions.length;
const accs=pvSessions.filter(x=>x.accuracy!==undefined).map(x=>x.accuracy);
document.getElementById('pv-stats-avg-acc').textContent=accs.length?Math.round(accs.reduce((a,b)=>a+b,0)/accs.length)+'%':'-';
// ì˜ˆìƒ ë§ê°
let forgetCount=0;
p.forEach(x=>{if(x.nextReview&&x.stability){const daysUntil=(new Date(x.nextReview)-now)/(1000*60*60*24);if(daysUntil<=7){const R=FSRS.retrievability(Math.max(0,-daysUntil)+(x.interval||1),x.stability);if(R<0.7)forgetCount++;}}});
document.getElementById('pv-stats-forget').textContent=forgetCount;
// â˜… FSRS ì•ˆì •ë„(Stability) ë¶„í¬
let stab0_3=0,stab3_7=0,stab7_30=0,stab30=0;
p.forEach(x=>{const st=x.stability||0;if(st<3)stab0_3++;else if(st<7)stab3_7++;else if(st<30)stab7_30++;else stab30++;});
document.getElementById('pv-stability-0-3').textContent=stab0_3;
document.getElementById('pv-stability-3-7').textContent=stab3_7;
document.getElementById('pv-stability-7-30').textContent=stab7_30;
document.getElementById('pv-stability-30-plus').textContent=stab30;
// â˜… Card States (Anki ìŠ¤íƒ€ì¼) í†µê³„
let pvStateNew=0,pvStateLearning=0,pvStateRelearning=0,pvStateYoung=0,pvStateMature=0;
p.forEach(x=>{
  const state=FSRS.getCardState(x);
  if(state==='New')pvStateNew++;
  else if(state==='Learning')pvStateLearning++;
  else if(state==='Relearning')pvStateRelearning++;
  else if(state==='Young')pvStateYoung++;
  else if(state==='Mature')pvStateMature++;
});
document.getElementById('pv-state-new').textContent=pvStateNew;
document.getElementById('pv-state-learning').textContent=pvStateLearning;
document.getElementById('pv-state-relearning').textContent=pvStateRelearning;
document.getElementById('pv-state-young').textContent=pvStateYoung;
document.getElementById('pv-state-mature').textContent=pvStateMature;
// â˜… Leech ì¹´ë“œ í†µê³„
const pvLeechCards=p.filter(x=>(x.lapses||0)>=FSRS.leechThreshold||x.isLeech).slice(0,10);
document.getElementById('pv-leech-count').textContent=pvLeechCards.length?`(${pvLeechCards.length}ê°œ)`:'';
document.getElementById('pv-leech-list').innerHTML=pvLeechCards.length?pvLeechCards.map((c,i)=>`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)"><span>${i+1}. ${c.Phrasal_Verb}</span><span style="color:var(--danger)">${c.lapses||0}íšŒ</span></div>`).join(''):'<div style="color:var(--success);text-align:center;padding:10px">âœ… Leech ì—†ìŒ</div>';
// â˜… 7ì¼ ë¦¬ë·° ì˜ˆì¸¡ ì°¨íŠ¸
const forecast=[0,0,0,0,0,0,0];
p.forEach(x=>{if(x.nextReview){const d=Math.floor((new Date(x.nextReview)-now)/(1000*60*60*24));if(d>=0&&d<7)forecast[d]++;}});
const maxF=Math.max(...forecast,1);
document.getElementById('pv-forecast-chart').innerHTML=forecast.map((v,i)=>`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar phrasal" style="height:${Math.max(4,(v/maxF)*60)}px"></div><div class="chart-bar-label">${i===0?'ì˜¤ëŠ˜':i===1?'ë‚´ì¼':i+'ì¼í›„'}</div></div>`).join('');
// â˜… Hard Cards Top 10
const hardCards=p.filter(x=>(x.reviewCount||0)>0).map(x=>({word:x.Phrasal_Verb,wrongRate:x.wrongCount?(x.wrongCount/(x.reviewCount||1)):0,wrongCount:x.wrongCount||0,lapses:x.lapses||0})).sort((a,b)=>(b.wrongRate+b.lapses*0.1)-(a.wrongRate+a.lapses*0.1)).slice(0,10);
document.getElementById('pv-hard-cards-list').innerHTML=hardCards.length?hardCards.map((c,i)=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span>${i+1}. ${c.word}</span><span style="color:var(--danger)">${Math.round(c.wrongRate*100)}% ì˜¤ë‹µ (${c.wrongCount}íšŒ)</span></div>`).join(''):'<div style="color:var(--muted);text-align:center;padding:20px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
// Leitner Box
const boxes=[0,0,0,0,0];p.forEach(x=>{const b=Math.min(5,Math.max(1,x.leitnerBox||1));boxes[b-1]++;});
document.getElementById('pv-leitner-stats').innerHTML=boxes.map((c,i)=>`<div class="leitner-box box-${i+1}" onclick="startBoxStudy(${i+1},'phrasal')" style="cursor:pointer" title="Box ${i+1} í•™ìŠµ"><div class="leitner-count">${c}</div><div class="leitner-label">Box ${i+1}</div></div>`).join('');
// ì£¼ê°„ ì°¨íŠ¸
const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],wd=[0,0,0,0,0,0,0];
const nowDate=new Date(now.toDateString());
pvSessions.forEach(x=>{
const sessDate=new Date(new Date(x.date).toDateString());
const diff=Math.floor((nowDate-sessDate)/86400000);
if(diff>=0&&diff<7)wd[6-diff]+=(x.total||0);
});
const max=Math.max(...wd,1);document.getElementById('pv-weekly-chart').innerHTML=wd.map((v,i)=>{const d=(now.getDay()-6+i+7)%7;return`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar phrasal" style="height:${Math.max(4,(v/max)*120)}px"></div><div class="chart-bar-label">${days[d]}</div></div>`;}).join('');
// â˜… 30ì¼ ì²«ì‹œë„ ì •ë‹µë¥  ì¶”ì´ ì°¨íŠ¸
const ftData=[];
for(let i=29;i>=0;i--){
  const targetDate=new Date(nowDate);targetDate.setDate(targetDate.getDate()-i);
  const dateStr=targetDate.toDateString();
  const daySessions=pvSessions.filter(x=>new Date(x.date).toDateString()===dateStr);
  const ftc=daySessions.reduce((sum,x)=>sum+(x.firstTryCorrect||0),0);
  const ftt=daySessions.reduce((sum,x)=>sum+((x.firstTryCorrect||0)+(x.firstTryWrong||0)),0);
  ftData.push({day:i,acc:ftt>0?Math.round((ftc/ftt)*100):null});
}
const validFt=ftData.filter(x=>x.acc!==null);
const maxFt=Math.max(...validFt.map(x=>x.acc),100);
const ftChart=document.getElementById('pv-first-try-chart');
ftChart.style.justifyContent='flex-start';ftChart.style.gap='2px';ftChart.style.overflowX='auto';ftChart.style.paddingBottom='4px';
ftChart.innerHTML=ftData.map((d,i)=>{
  if(d.acc===null)return`<div style="width:6px;flex-shrink:0"><div class="chart-bar" style="height:2px;width:6px;background:var(--border);border-radius:1px"></div></div>`;
  const color=d.acc>=80?'var(--success)':d.acc>=60?'var(--warning)':'var(--danger)';
  return`<div style="width:6px;flex-shrink:0" title="${29-i}ì¼ì „: ${d.acc}%"><div class="chart-bar" style="height:${Math.max(4,(d.acc/maxFt)*60)}px;width:6px;background:${color};border-radius:2px"></div></div>`;
}).join('');
// â˜… FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ
const sevenDaysAgo=new Date(now.getTime()-7*24*60*60*1000);
const fsrsFailCards=p.filter(x=>{
  if(!x.stability||x.stability<7)return false;
  if(!x.lastWrongDate)return false;
  return new Date(x.lastWrongDate)>=sevenDaysAgo;
}).map(x=>{
  const R=x.stability?FSRS.retrievability((now-new Date(x.lastReview||now))/(1000*60*60*24),x.stability):0;
  return{word:x.Phrasal_Verb,stability:x.stability,R:Math.round(R*100)};
}).sort((a,b)=>b.stability-a.stability).slice(0,10);
document.getElementById('pv-fsrs-fail-count').textContent=fsrsFailCards.length?`(${fsrsFailCards.length}ê°œ)`:'';
document.getElementById('pv-fsrs-fail-list').innerHTML=fsrsFailCards.length?fsrsFailCards.map((c,i)=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span>${i+1}. ${c.word}</span><span style="color:var(--danger)">S:${Math.round(c.stability)}ì¼ R:${c.R}%</span></div>`).join(''):'<div style="color:var(--success);text-align:center;padding:15px">âœ… ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ ì—†ìŒ</div>';
document.getElementById('pv-fsrs-fail-study-btn').style.display=fsrsFailCards.length?'inline-block':'none';
// â˜… ì¸ì§€â†”ìƒì‚° ê°­ ë¶„ì„
const gapCards=p.filter(x=>{
  const inputR=x.inputReviewCount||0;
  const outputR=x.outputReviewCount||0;
  const inputAcc=inputR?((x.inputCorrectCount||0)/inputR)*100:null;
  const outputAcc=outputR?((x.outputCorrectCount||0)/outputR)*100:null;
  if(inputAcc!==null&&inputAcc>=70){
    if(outputAcc!==null&&outputAcc<50)return true;
    if(outputR===0)return true;
  }
  return x.needsProduction&&inputR>0;
}).map(x=>{
  const inputR=x.inputReviewCount||0;
  const outputR=x.outputReviewCount||0;
  const inputAcc=inputR?Math.round(((x.inputCorrectCount||0)/inputR)*100):null;
  const outputAcc=outputR?Math.round(((x.outputCorrectCount||0)/outputR)*100):null;
  return{word:x.Phrasal_Verb,inputAcc,outputAcc,inputR,outputR};
}).sort((a,b)=>((b.inputAcc||0)-(b.outputAcc||0))-((a.inputAcc||0)-(a.outputAcc||0))).slice(0,10);
const gapCount=p.filter(x=>x.needsProduction||(x.inputReviewCount>0&&!x.outputReviewCount)).length;
document.getElementById('pv-gap-count').textContent=gapCount?`(${gapCount}ê°œ)`:'';
document.getElementById('pv-gap-analysis').innerHTML=gapCards.length?
  `<div style="margin-bottom:8px;color:var(--muted)">ì¸ì§€â†”ìƒì‚° ê²©ì°¨ê°€ í° ì¹´ë“œ:</div>`+
  gapCards.map((c,i)=>{
    const inputStr=c.inputAcc!==null?`ì¸í’‹ ${c.inputAcc}%`:'ì¸í’‹ -';
    const outputStr=c.outputAcc!==null?`ìƒì‚° ${c.outputAcc}%`:(c.inputR>0?'ìƒì‚° ë¯¸ì‹œë„':'');
    return`<div style="display:flex;justify-content:space-between;padding:4px 0"><span>${i+1}. ${c.word}</span><span style="font-size:11px">${inputStr} | ${outputStr}</span></div>`;
  }).join('')
  :'<div style="color:var(--success);text-align:center;padding:15px">âœ… ì¸ì§€â†”ìƒì‚° ê°­ ì—†ìŒ</div>';
document.getElementById('pv-gap-study-btn').style.display=gapCount?'inline-block':'none';
}catch(e){console.error(e);}}
async function updateExprStats(){
try{const e=await getAllExpr(),s=await getSessions(),now=new Date();
document.getElementById('expr-stats-total').textContent=e.length;
document.getElementById('expr-stats-mastered').textContent=e.filter(x=>(x.mastery||0)>=80).length;
document.getElementById('expr-stats-learning').textContent=e.filter(x=>(x.reviewCount||0)>0&&(x.mastery||0)<80).length;
document.getElementById('expr-stats-new').textContent=e.filter(x=>!(x.reviewCount||0)).length;
let high=0,mid=0,low=0;e.forEach(x=>{const a=getAcc(x);if(a===null)return;if(a>=80)high++;else if(a>=50)mid++;else low++;});
document.getElementById('expr-stats-high').textContent=high;
document.getElementById('expr-stats-mid').textContent=mid;
document.getElementById('expr-stats-low').textContent=low;
// â˜… ì¸í’‹/ì•„ì›ƒí’‹ í†µê³„
const exprSessions=s.filter(x=>x.type==='expr');
const exprOutputModes=['expr-typing','dictation'];
const exprInputSessions=exprSessions.filter(x=>!exprOutputModes.includes(x.mode));
const exprOutputSessions=exprSessions.filter(x=>exprOutputModes.includes(x.mode));
const exprInputTotal=exprInputSessions.reduce((sum,x)=>sum+(x.total||0),0);
const exprOutputTotal=exprOutputSessions.reduce((sum,x)=>sum+(x.total||0),0);
const exprInputAccs=exprInputSessions.filter(x=>x.accuracy!==undefined).map(x=>x.accuracy);
const exprOutputAccs=exprOutputSessions.filter(x=>x.accuracy!==undefined).map(x=>x.accuracy);
document.getElementById('expr-stats-input-count').textContent=exprInputTotal;
document.getElementById('expr-stats-output-count').textContent=exprOutputTotal;
document.getElementById('expr-stats-input-acc').textContent=exprInputAccs.length?Math.round(exprInputAccs.reduce((a,b)=>a+b,0)/exprInputAccs.length)+'%':'-';
document.getElementById('expr-stats-output-acc').textContent=exprOutputAccs.length?Math.round(exprOutputAccs.reduce((a,b)=>a+b,0)/exprOutputAccs.length)+'%':'-';
// â˜… ì²« ì‹œë„ ì •ë‹µë¥  ê³„ì‚°
const exprInputFirstCorrect=exprInputSessions.reduce((sum,x)=>sum+(x.firstTryCorrect||0),0);
const exprInputFirstTotal=exprInputSessions.reduce((sum,x)=>sum+((x.firstTryCorrect||0)+(x.firstTryWrong||0)),0);
const exprOutputFirstCorrect=exprOutputSessions.reduce((sum,x)=>sum+(x.firstTryCorrect||0),0);
const exprOutputFirstTotal=exprOutputSessions.reduce((sum,x)=>sum+((x.firstTryCorrect||0)+(x.firstTryWrong||0)),0);
document.getElementById('expr-stats-input-first').textContent=exprInputFirstTotal?Math.round((exprInputFirstCorrect/exprInputFirstTotal)*100)+'%':'-';
document.getElementById('expr-stats-output-first').textContent=exprOutputFirstTotal?Math.round((exprOutputFirstCorrect/exprOutputFirstTotal)*100)+'%':'-';
// â˜… í•™ìŠµ ë¶„ì„
const totalTime=exprSessions.reduce((sum,x)=>sum+(x.duration||0),0);
const totalMin=Math.floor(totalTime/60);
document.getElementById('expr-stats-time').textContent=totalMin>=60?Math.floor(totalMin/60)+'ì‹œê°„ '+totalMin%60+'ë¶„':totalMin+'ë¶„';
document.getElementById('expr-stats-sessions').textContent=exprSessions.length;
const accs=exprSessions.filter(x=>x.accuracy!==undefined).map(x=>x.accuracy);
document.getElementById('expr-stats-avg-acc').textContent=accs.length?Math.round(accs.reduce((a,b)=>a+b,0)/accs.length)+'%':'-';
// ì˜ˆìƒ ë§ê°
let forgetCount=0;
e.forEach(x=>{if(x.nextReview&&x.stability){const daysUntil=(new Date(x.nextReview)-now)/(1000*60*60*24);if(daysUntil<=7){const R=FSRS.retrievability(Math.max(0,-daysUntil)+(x.interval||1),x.stability);if(R<0.7)forgetCount++;}}});
document.getElementById('expr-stats-forget').textContent=forgetCount;
// â˜… FSRS ì•ˆì •ë„(Stability) ë¶„í¬
let stab0_3=0,stab3_7=0,stab7_30=0,stab30=0;
e.forEach(x=>{const st=x.stability||0;if(st<3)stab0_3++;else if(st<7)stab3_7++;else if(st<30)stab7_30++;else stab30++;});
document.getElementById('expr-stability-0-3').textContent=stab0_3;
document.getElementById('expr-stability-3-7').textContent=stab3_7;
document.getElementById('expr-stability-7-30').textContent=stab7_30;
document.getElementById('expr-stability-30-plus').textContent=stab30;
// â˜… Card States (Anki ìŠ¤íƒ€ì¼) í†µê³„
let exprStateNew=0,exprStateLearning=0,exprStateRelearning=0,exprStateYoung=0,exprStateMature=0;
e.forEach(x=>{
  const state=FSRS.getCardState(x);
  if(state==='New')exprStateNew++;
  else if(state==='Learning')exprStateLearning++;
  else if(state==='Relearning')exprStateRelearning++;
  else if(state==='Young')exprStateYoung++;
  else if(state==='Mature')exprStateMature++;
});
document.getElementById('expr-state-new').textContent=exprStateNew;
document.getElementById('expr-state-learning').textContent=exprStateLearning;
document.getElementById('expr-state-relearning').textContent=exprStateRelearning;
document.getElementById('expr-state-young').textContent=exprStateYoung;
document.getElementById('expr-state-mature').textContent=exprStateMature;
// â˜… Leech ì¹´ë“œ í†µê³„
const exprLeechCards=e.filter(x=>(x.lapses||0)>=FSRS.leechThreshold||x.isLeech).slice(0,10);
document.getElementById('expr-leech-count').textContent=exprLeechCards.length?`(${exprLeechCards.length}ê°œ)`:'';
document.getElementById('expr-leech-list').innerHTML=exprLeechCards.length?exprLeechCards.map((c,i)=>`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)"><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${i+1}. ${c.Expression}</span><span style="color:var(--danger);flex-shrink:0;margin-left:8px">${c.lapses||0}íšŒ</span></div>`).join(''):'<div style="color:var(--success);text-align:center;padding:10px">âœ… Leech ì—†ìŒ</div>';
// â˜… 7ì¼ ë¦¬ë·° ì˜ˆì¸¡ ì°¨íŠ¸
const forecast=[0,0,0,0,0,0,0];
e.forEach(x=>{if(x.nextReview){const d=Math.floor((new Date(x.nextReview)-now)/(1000*60*60*24));if(d>=0&&d<7)forecast[d]++;}});
const maxF=Math.max(...forecast,1);
document.getElementById('expr-forecast-chart').innerHTML=forecast.map((v,i)=>`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar" style="height:${Math.max(4,(v/maxF)*60)}px;background:var(--expr)"></div><div class="chart-bar-label">${i===0?'ì˜¤ëŠ˜':i===1?'ë‚´ì¼':i+'ì¼í›„'}</div></div>`).join('');
// â˜… Hard Cards Top 10
const hardCards=e.filter(x=>(x.reviewCount||0)>0).map(x=>({word:x.Expression,wrongRate:x.wrongCount?(x.wrongCount/(x.reviewCount||1)):0,wrongCount:x.wrongCount||0,lapses:x.lapses||0})).sort((a,b)=>(b.wrongRate+b.lapses*0.1)-(a.wrongRate+a.lapses*0.1)).slice(0,10);
document.getElementById('expr-hard-cards-list').innerHTML=hardCards.length?hardCards.map((c,i)=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${i+1}. ${c.word}</span><span style="color:var(--danger);flex-shrink:0;margin-left:8px">${Math.round(c.wrongRate*100)}%</span></div>`).join(''):'<div style="color:var(--muted);text-align:center;padding:20px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
// Leitner Box
const boxes=[0,0,0,0,0];e.forEach(x=>{const b=Math.min(5,Math.max(1,x.leitnerBox||1));boxes[b-1]++;});
document.getElementById('expr-leitner-stats').innerHTML=boxes.map((c,i)=>`<div class="leitner-box box-${i+1}"><div class="leitner-count">${c}</div><div class="leitner-label">Box ${i+1}</div></div>`).join('');
// ì£¼ê°„ í•™ìŠµ
const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],wd=[0,0,0,0,0,0,0];
const nowDate=new Date(now.toDateString());
exprSessions.forEach(x=>{
const sessDate=new Date(new Date(x.date).toDateString());
const diff=Math.floor((nowDate-sessDate)/86400000);
if(diff>=0&&diff<7)wd[6-diff]+=(x.total||0);
});
const max=Math.max(...wd,1);document.getElementById('expr-weekly-chart').innerHTML=wd.map((v,i)=>{const d=(now.getDay()-6+i+7)%7;return`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar" style="height:${Math.max(4,(v/max)*120)}px;background:var(--expr)"></div><div class="chart-bar-label">${days[d]}</div></div>`;}).join('');
// â˜… 30ì¼ ì²«ì‹œë„ ì •ë‹µë¥  ì¶”ì´ ì°¨íŠ¸
const ftData=[];
for(let i=29;i>=0;i--){
  const targetDate=new Date(nowDate);targetDate.setDate(targetDate.getDate()-i);
  const dateStr=targetDate.toDateString();
  const daySessions=exprSessions.filter(x=>new Date(x.date).toDateString()===dateStr);
  const ftc=daySessions.reduce((sum,x)=>sum+(x.firstTryCorrect||0),0);
  const ftt=daySessions.reduce((sum,x)=>sum+((x.firstTryCorrect||0)+(x.firstTryWrong||0)),0);
  ftData.push({day:i,acc:ftt>0?Math.round((ftc/ftt)*100):null});
}
const validFt=ftData.filter(x=>x.acc!==null);
const maxFt=Math.max(...validFt.map(x=>x.acc),100);
const ftChart=document.getElementById('expr-first-try-chart');
ftChart.style.justifyContent='flex-start';ftChart.style.gap='2px';ftChart.style.overflowX='auto';ftChart.style.paddingBottom='4px';
ftChart.innerHTML=ftData.map((d,i)=>{
  if(d.acc===null)return`<div style="width:6px;flex-shrink:0"><div class="chart-bar" style="height:2px;width:6px;background:var(--border);border-radius:1px"></div></div>`;
  const color=d.acc>=80?'var(--success)':d.acc>=60?'var(--warning)':'var(--danger)';
  return`<div style="width:6px;flex-shrink:0" title="${29-i}ì¼ì „: ${d.acc}%"><div class="chart-bar" style="height:${Math.max(4,(d.acc/maxFt)*60)}px;width:6px;background:${color};border-radius:2px"></div></div>`;
}).join('');
// â˜… FSRS ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ
const sevenDaysAgo=new Date(now.getTime()-7*24*60*60*1000);
const fsrsFailCards=e.filter(x=>{
  if(!x.stability||x.stability<7)return false;
  if(!x.lastWrongDate)return false;
  return new Date(x.lastWrongDate)>=sevenDaysAgo;
}).map(x=>{
  const R=x.stability?FSRS.retrievability((now-new Date(x.lastReview||now))/(1000*60*60*24),x.stability):0;
  return{word:x.Expression,stability:x.stability,R:Math.round(R*100)};
}).sort((a,b)=>b.stability-a.stability).slice(0,10);
document.getElementById('expr-fsrs-fail-count').textContent=fsrsFailCards.length?`(${fsrsFailCards.length}ê°œ)`:'';
document.getElementById('expr-fsrs-fail-list').innerHTML=fsrsFailCards.length?fsrsFailCards.map((c,i)=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${i+1}. ${c.word}</span><span style="color:var(--danger);flex-shrink:0;margin-left:8px">S:${Math.round(c.stability)}ì¼</span></div>`).join(''):'<div style="color:var(--success);text-align:center;padding:15px">âœ… ì˜ˆì¸¡ ì‹¤íŒ¨ ì¹´ë“œ ì—†ìŒ</div>';
document.getElementById('expr-fsrs-fail-study-btn').style.display=fsrsFailCards.length?'inline-block':'none';
// â˜… ì¸ì§€â†”ìƒì‚° ê°­ ë¶„ì„
const gapCards=e.filter(x=>{
  const inputR=x.inputReviewCount||0;
  const outputR=x.outputReviewCount||0;
  const inputAcc=inputR?((x.inputCorrectCount||0)/inputR)*100:null;
  const outputAcc=outputR?((x.outputCorrectCount||0)/outputR)*100:null;
  if(inputAcc!==null&&inputAcc>=70){
    if(outputAcc!==null&&outputAcc<50)return true;
    if(outputR===0)return true;
  }
  return x.needsProduction&&inputR>0;
}).map(x=>{
  const inputR=x.inputReviewCount||0;
  const outputR=x.outputReviewCount||0;
  const inputAcc=inputR?Math.round(((x.inputCorrectCount||0)/inputR)*100):null;
  const outputAcc=outputR?Math.round(((x.outputCorrectCount||0)/outputR)*100):null;
  return{word:x.Expression,inputAcc,outputAcc,inputR,outputR};
}).sort((a,b)=>((b.inputAcc||0)-(b.outputAcc||0))-((a.inputAcc||0)-(a.outputAcc||0))).slice(0,10);
const gapCount=e.filter(x=>x.needsProduction||(x.inputReviewCount>0&&!x.outputReviewCount)).length;
document.getElementById('expr-gap-count').textContent=gapCount?`(${gapCount}ê°œ)`:'';
document.getElementById('expr-gap-analysis').innerHTML=gapCards.length?
  `<div style="margin-bottom:8px;color:var(--muted)">ì¸ì§€â†”ìƒì‚° ê²©ì°¨ê°€ í° ì¹´ë“œ:</div>`+
  gapCards.map((c,i)=>{
    const inputStr=c.inputAcc!==null?`ì¸í’‹ ${c.inputAcc}%`:'ì¸í’‹ -';
    const outputStr=c.outputAcc!==null?`ìƒì‚° ${c.outputAcc}%`:(c.inputR>0?'ìƒì‚° ë¯¸ì‹œë„':'');
    return`<div style="display:flex;justify-content:space-between;padding:4px 0"><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${i+1}. ${c.word}</span><span style="font-size:11px;flex-shrink:0;margin-left:8px">${inputStr} | ${outputStr}</span></div>`;
  }).join('')
  :'<div style="color:var(--success);text-align:center;padding:15px">âœ… ì¸ì§€â†”ìƒì‚° ê°­ ì—†ìŒ</div>';
document.getElementById('expr-gap-study-btn').style.display=gapCount?'inline-block':'none';
}catch(err){console.error(err);}}
let editingExpr=null;
async function openExprEditModal(key){
const e=await getExpr(key);if(!e)return;
editingExpr=e;
document.getElementById('expr-edit-key').value=e.Expression||'';
document.getElementById('expr-edit-meaning').value=getMKO(e)||e.Meaning_KO||'';
document.getElementById('expr-edit-function').value=e.Function||'';
document.getElementById('expr-edit-formality').value=e.Formality||'Neutral';
document.getElementById('expr-edit-currency').value=e.Currency||'Current';
document.getElementById('expr-edit-medium').value=e.Medium||'Both';
document.getElementById('expr-edit-example1').value=e.Example1||'';
document.getElementById('expr-edit-example2').value=e.Example2||'';
document.getElementById('expr-edit-similar').value=e.Similar_Expr||'';
document.getElementById('expr-edit-coca').value=e.COCA_Genre||'';
document.getElementById('expr-edit-toefl').value=e.TOEFL_Rel||'';
document.getElementById('expr-edit-priority').value=e.Priority||'';
document.getElementById('expr-edit-l1').value=e.L1||'';
document.getElementById('expr-edit-l2').value=e.L2||'';
document.getElementById('expr-edit-l3').value=e.L3||'';
// íƒœê·¸ ë¶„ë¦¬ ë¡œë“œ
const SUGGESTED=['Academic','Literary','Legal','Business','Technical','Medical','BrE','AmE','Idiom','TOEFL'];
const existingTags=e.tags||[];
document.querySelectorAll('#expr-edit-suggested-tags .chip').forEach(c=>{
  c.classList.toggle('checked',existingTags.includes(c.dataset.value));
});
const manualTags=existingTags.filter(t=>!SUGGESTED.includes(t));
document.getElementById('expr-edit-tags').value=manualTags.join(', ');
// í†µê³„
document.getElementById('expr-edit-review').textContent=e.reviewCount||0;
const acc=getAcc(e);
document.getElementById('expr-edit-acc').textContent=acc!==null?acc+'%':'-';
document.getElementById('expr-edit-acc').style.color=acc===null?'':acc>=80?'var(--success)':acc<50?'var(--danger)':'var(--warning)';
document.getElementById('expr-edit-next').textContent=e.nextReview?new Date(e.nextReview).toLocaleDateString('ko-KR',{month:'short',day:'numeric'}):'-';
document.getElementById('expr-edit-bookmark-btn').textContent=e.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
showModal('expr-edit-modal');
}
// â˜… ì•„ì´í…œ ê°ì²´ë¡œ ì§ì ‘ ì—´ê¸° (ë¦¬ìŠ¤ë‹ ë“±ì—ì„œ ì‚¬ìš©)
function openExprEditFromItem(item){
if(!item||!item.Expression)return;
openExprEditModal(item.Expression);
}
async function saveExprEdit(){
if(!editingExpr)return;
editingExpr.Meaning_KO=document.getElementById('expr-edit-meaning').value;
editingExpr.Function=document.getElementById('expr-edit-function').value;
editingExpr.Formality=document.getElementById('expr-edit-formality').value;
editingExpr.Currency=document.getElementById('expr-edit-currency').value;
editingExpr.Medium=document.getElementById('expr-edit-medium').value;
editingExpr.Example1=document.getElementById('expr-edit-example1').value;
editingExpr.Example2=document.getElementById('expr-edit-example2').value;
editingExpr.Similar_Expr=document.getElementById('expr-edit-similar').value;
editingExpr.COCA_Genre=document.getElementById('expr-edit-coca').value;
editingExpr.TOEFL_Rel=document.getElementById('expr-edit-toefl').value;
editingExpr.Priority=document.getElementById('expr-edit-priority').value;
editingExpr.L1=document.getElementById('expr-edit-l1').value;
editingExpr.L2=document.getElementById('expr-edit-l2').value;
editingExpr.L3=document.getElementById('expr-edit-l3').value;
// íƒœê·¸ ì €ì¥
const suggestedTags=Array.from(document.querySelectorAll('#expr-edit-suggested-tags .chip.checked')).map(c=>c.dataset.value);
const tagsStr=document.getElementById('expr-edit-tags').value.trim();
const manualTags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):[];
editingExpr.tags=[...new Set([...suggestedTags,...manualTags])];
await saveExpr(editingExpr);
closeModal('expr-edit-modal');showToast('âœ… ì €ì¥ ì™„ë£Œ');updateWordTable();
}
async function toggleExprBookmark(){
if(!editingExpr)return;
editingExpr.starred=!editingExpr.starred;
await saveExpr(editingExpr);
document.getElementById('expr-edit-bookmark-btn').textContent=editingExpr.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
showToast(editingExpr.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
}
async function resetExprStats(){
if(!editingExpr)return;
showConfirm('í†µê³„ ì´ˆê¸°í™”','ì´ í‘œí˜„ì˜ í•™ìŠµ í†µê³„ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?',async()=>{
editingExpr.reviewCount=0;editingExpr.correctCount=0;editingExpr.consecutiveWrong=0;editingExpr.wrongCount=0;
editingExpr.stability=null;editingExpr.difficulty=null;editingExpr.nextReview=null;editingExpr.lastReview=null;
editingExpr.mastery=0;editingExpr.fsrsState='New';
await saveExpr(editingExpr);
closeModal('expr-edit-modal');showToast('ğŸ”„ ì´ˆê¸°í™” ì™„ë£Œ');updateWordTable();updateHomeStats();
});
}
async function deleteExprItem(){
if(!editingExpr)return;
showConfirm('í‘œí˜„ ì‚­ì œ',`"${editingExpr.Expression}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`,async()=>{
await deleteExpr(editingExpr.Expression);
closeModal('expr-edit-modal');showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');updateWordTable();updateHomeStats();
});
}
async function updateDataPage(){try{const w=await getAllWords(),p=await getAllPV(),e=await getAllExpr();document.getElementById('db-vocab-count').textContent=w.length;document.getElementById('db-pv-count').textContent=p.length;document.getElementById('db-expr-count').textContent=e.length;if(w.length){const l1s=[...new Set(w.map(x=>x.L1).filter(Boolean))].sort();document.getElementById('filter-l1').innerHTML='<option value="all">ì „ì²´</option>'+l1s.map(l=>`<option value="${l}">${l}</option>`).join('');}if(p.length){const cats=[...new Set(p.map(x=>x.Category).filter(Boolean))].sort();document.getElementById('pv-filter-cat').innerHTML='<option value="all">ì „ì²´</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');}
// ë¶„í¬ í‘œì‹œ
updateDistribution(w,p,e);
wordOffset=0;updateWordTable();}catch(e){console.error(e);}}
function updateDistribution(w,p,e){
const cefrLabels=['A2','B1','B2','C1','C2'];
const cefrColors=['#60a5fa','#34d399','#fbbf24','#f87171','#a78bfa'];
// ì–´íœ˜ CEFRë³„ ë¶„í¬
const vocabCefrDist={'A2':0,'B1':0,'B2':0,'C1':0,'C2':0};
w.forEach(x=>{const cefr=x.CEFR||'B1';vocabCefrDist[cefr]=(vocabCefrDist[cefr]||0)+1;});
if(w.length>0){
document.getElementById('dist-vocab-cefr').innerHTML=renderDistBar(vocabCefrDist,w.length,cefrColors,cefrLabels);
}else{document.getElementById('dist-vocab-cefr').innerHTML='<span style="font-size:12px;color:var(--muted)">ì–´íœ˜ ì—†ìŒ</span>';}
// ì–´íœ˜ L1ë³„ ë¶„í¬
const l1Dist={};
w.forEach(x=>{const l1=x.L1||'ë¯¸ì§€ì •';l1Dist[l1]=(l1Dist[l1]||0)+1;});
const l1Labels=['Science','Society','Arts','General','Concrete','Activity','Social','ë¯¸ì§€ì •'];
const l1Colors={'Science':'#3b82f6','Society':'#8b5cf6','Arts':'#ec4899','General':'#34d399','Concrete':'#f59e0b','Activity':'#14b8a6','Social':'#f97316','Daily':'#fbbf24','ë¯¸ì§€ì •':'#94a3b8'};
if(w.length>0){
document.getElementById('dist-vocab-l1').innerHTML=renderDistBar(l1Dist,w.length,l1Colors,l1Labels);
}else{document.getElementById('dist-vocab-l1').innerHTML='<span style="font-size:12px;color:var(--muted)">ì–´íœ˜ ì—†ìŒ</span>';}
// êµ¬ë™ì‚¬ CEFRë³„ ë¶„í¬
const pvCefrDist={'A2':0,'B1':0,'B2':0,'C1':0,'C2':0};
p.forEach(x=>{const cefr=x.CEFR||'B1';pvCefrDist[cefr]=(pvCefrDist[cefr]||0)+1;});
if(p.length>0){
document.getElementById('dist-pv-cefr').innerHTML=renderDistBar(pvCefrDist,p.length,cefrColors,cefrLabels);
}else{document.getElementById('dist-pv-cefr').innerHTML='<span style="font-size:12px;color:var(--muted)">êµ¬ë™ì‚¬ ì—†ìŒ</span>';}
// êµ¬ë™ì‚¬ ì¹´í…Œê³ ë¦¬ ë¶„í¬
const pvCatDist={};
p.forEach(x=>{const cat=x.Category||'ë¯¸ì§€ì •';pvCatDist[cat]=(pvCatDist[cat]||0)+1;});
const pvCatLabels=['Academic','General','Daily','ë¯¸ì§€ì •'];
const pvColors={'Academic':'#818cf8','General':'#34d399','Daily':'#fbbf24','ë¯¸ì§€ì •':'#94a3b8'};
if(p.length>0){
document.getElementById('dist-pv-cat').innerHTML=renderDistBar(pvCatDist,p.length,pvColors,pvCatLabels);
}else{document.getElementById('dist-pv-cat').innerHTML='<span style="font-size:12px;color:var(--muted)">êµ¬ë™ì‚¬ ì—†ìŒ</span>';}
// í‘œí˜„ CEFRë³„ ë¶„í¬
const exprCefrDist={'A2':0,'B1':0,'B2':0,'C1':0,'C2':0};
e.forEach(x=>{const cefr=x.CEFR||'B1';exprCefrDist[cefr]=(exprCefrDist[cefr]||0)+1;});
if(e.length>0){
document.getElementById('dist-expr-cefr').innerHTML=renderDistBar(exprCefrDist,e.length,cefrColors,cefrLabels);
}else{document.getElementById('dist-expr-cefr').innerHTML='<span style="font-size:12px;color:var(--muted)">í‘œí˜„ ì—†ìŒ</span>';}
// í‘œí˜„ Formality ë¶„í¬
const exprFormalityDist={};
e.forEach(x=>{const f=x.Formality||'Neutral';exprFormalityDist[f]=(exprFormalityDist[f]||0)+1;});
const formalityLabels=['Formal','Neutral','Informal'];
const formalityColors={'Formal':'#6366f1','Neutral':'#34d399','Informal':'#fbbf24'};
if(e.length>0){
document.getElementById('dist-expr-formality').innerHTML=renderDistBar(exprFormalityDist,e.length,formalityColors,formalityLabels);
}else{document.getElementById('dist-expr-formality').innerHTML='<span style="font-size:12px;color:var(--muted)">í‘œí˜„ ì—†ìŒ</span>';}
}
// DB í˜„í™© íƒ­ ì „í™˜ (ë‹¨ì–´ëª©ë¡ íƒ­ê³¼ ì—°ë™)
function switchDbTab(tab){
// íƒ­ ë²„íŠ¼ ì—†ì´ stat ì˜ì—­ë§Œ ì „í™˜
document.getElementById('db-stat-vocab').style.display=tab==='vocab'?'block':'none';
document.getElementById('db-stat-pv').style.display=tab==='pv'?'block':'none';
document.getElementById('db-stat-expr').style.display=tab==='expr'?'block':'none';
}
function renderDistBar(dist,total,colors,labels){
// labelsê°€ ìˆìœ¼ë©´ labels ìˆœì„œë¡œ, ì—†ìœ¼ë©´ ë°ì´í„°ëŸ‰ ìˆœìœ¼ë¡œ
const entries=labels?labels.map(l=>[l,dist[l]||0]).filter(([k,v])=>v>0):Object.entries(dist).sort((a,b)=>b[1]-a[1]);
if(entries.length===0)return'<span style="font-size:12px;color:var(--muted)">ë°ì´í„° ì—†ìŒ</span>';
// ìŠ¤íƒ ë°”
let stackBar='<div style="display:flex;height:24px;border-radius:8px;overflow:hidden;margin-bottom:8px">';
entries.forEach(([k,v],i)=>{
const pct=(v/total*100).toFixed(1);
const color=Array.isArray(colors)?colors[labels?labels.indexOf(k):i]:(colors[k]||'#94a3b8');
stackBar+=`<div style="width:${pct}%;background:${color};min-width:${v>0?'2px':'0'}" title="${k}: ${v} (${pct}%)"></div>`;
});
stackBar+='</div>';
// ë²”ë¡€
let legend='<div style="display:flex;flex-wrap:wrap;gap:8px;font-size:11px">';
entries.forEach(([k,v],i)=>{
const pct=(v/total*100).toFixed(0);
const color=Array.isArray(colors)?colors[labels?labels.indexOf(k):i]:(colors[k]||'#94a3b8');
legend+=`<span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;border-radius:2px;background:${color}"></span>${k} <strong>${v}</strong><span style="color:var(--muted)">(${pct}%)</span></span>`;
});
legend+='</div>';
return stackBar+legend;
}
let currentSearchQuery='',currentTagFilter='all';
// ë°ì´í„°íƒ­ í•„í„° ì ìš©
function applyDataFilter(){wordOffset=0;updateWordTable();}
// ë°ì´í„°íƒ­ ìŒì„± ì¬ìƒ
function speakDataWord(text,e){
if(e)e.stopPropagation();
if(!text)return;
speechSynthesis.cancel();
const u=new SpeechSynthesisUtterance(text);
u.lang='en-US';u.rate=0.9;
speechSynthesis.speak(u);
}
// L2 í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
async function updateL2FilterOptions(){
const select=document.getElementById('data-filter-l2');
if(currentDataType==='vocab'){
  // ì–´íœ˜: L2 (ë„ë©”ì¸ ë¶„ë¥˜) í•„í„° - ë³´ì´ê¸°
  select.style.display='';
  const currentVal=select.value; // í˜„ì¬ ì„ íƒê°’ ì €ì¥
  const w=await getAllWords();
  const l2s=[...new Set(w.map(x=>x.L2).filter(Boolean))].sort();
  select.innerHTML='<option value="all">ğŸ“ L2 ë„ë©”ì¸</option>'+l2s.map(l=>`<option value="${l}">${l}</option>`).join('');
  // ì´ì „ ì„ íƒê°’ ë³µì› (ì¡´ì¬í•˜ë©´)
  if(currentVal && [...select.options].some(o=>o.value===currentVal)){
    select.value=currentVal;
  }
}else{
  // êµ¬ë™ì‚¬/í‘œí˜„: L2 í•„í„° ìˆ¨ê¸°ê¸° (ê²©ì‹ë„ í•„í„° ë³„ë„ ì¡´ì¬)
  select.style.display='none';
  select.value='all';
}
}
async function updateWordTable(){
const query=currentSearchQuery.toLowerCase().trim();
const tagF=currentTagFilter;
const specialF=document.getElementById('data-filter-special')?.value||'all';
const cefrF=document.getElementById('data-filter-cefr')?.value||'all';
const priorityF=document.getElementById('data-filter-priority')?.value||'all';
const l2F=document.getElementById('data-filter-l2')?.value||'all';
const formalityF=document.getElementById('data-filter-formality')?.value||'all';
const currencyF=document.getElementById('data-filter-currency')?.value||'all';
const mediumF=document.getElementById('data-filter-medium')?.value||'all';
const sortBy=document.getElementById('data-sort')?.value||'alpha';
const today=new Date().toISOString().slice(0,10);

if(currentDataType==='expr'){
let e=await getAllExpr();
// ê²€ìƒ‰ í•„í„°
if(query){
e=e.filter(x=>(x.Expression||'').toLowerCase().includes(query)||(getMKO(x)||'').toLowerCase().includes(query)||(x.Function||'').toLowerCase().includes(query));
// ê²€ìƒ‰ ê²°ê³¼ ì •ë ¬: ì •í™•ì¼ì¹˜ > ì‹œì‘ì¼ì¹˜ > í¬í•¨
e.sort((a,b)=>{
const aWord=(a.Expression||'').toLowerCase();
const bWord=(b.Expression||'').toLowerCase();
const aExact=aWord===query?0:1;
const bExact=bWord===query?0:1;
if(aExact!==bExact)return aExact-bExact;
const aStarts=aWord.startsWith(query)?0:1;
const bStarts=bWord.startsWith(query)?0:1;
if(aStarts!==bStarts)return aStarts-bStarts;
return aWord.localeCompare(bWord);
});
}
// íŠ¹ìˆ˜ í•„í„°
if(specialF==='new-today')e=e.filter(x=>x.addedDate&&x.addedDate.startsWith(today));
else if(specialF==='duplicate')e=e.filter(x=>/[Â¹Â²Â³]/.test(x.Expression)||/[123]$/.test(x.Expression));
else if(specialF==='starred')e=e.filter(x=>x.starred);
else if(specialF==='wrong')e=e.filter(x=>x.wrongNote);
else if(specialF==='no-review')e=e.filter(x=>!x.reviewCount);
// CEFR í•„í„°
if(cefrF!=='all')e=e.filter(x=>(x.CEFR||'B1')===cefrF);
// Priority í•„í„°
if(priorityF!=='all')e=e.filter(x=>(x.Priority||'P2')===priorityF);
// Formality í•„í„°
if(formalityF!=='all')e=e.filter(x=>(x.Formality||'Neutral')===formalityF);
// Currency í•„í„°
if(currencyF!=='all')e=e.filter(x=>(x.Currency||'Current')===currencyF);
// Medium í•„í„°
if(mediumF!=='all')e=e.filter(x=>(x.Medium||'Both')===mediumF);
// íƒœê·¸ í•„í„°
if(tagF!=='all')e=e.filter(x=>(x.tags||[]).includes(tagF));
// ì •ë ¬
if(!query){
if(sortBy==='acc-asc')e=e.filter(x=>x.reviewCount>0).sort((a,b)=>(getAcc(a)||100)-(getAcc(b)||100));
else if(sortBy==='acc-desc')e=e.filter(x=>x.reviewCount>0).sort((a,b)=>(getAcc(b)||0)-(getAcc(a)||0));
else if(sortBy==='stability-asc')e=e.sort((a,b)=>(a.stability||999)-(b.stability||999));
else if(sortBy==='due-first')e=e.filter(x=>x.nextReview).sort((a,b)=>new Date(a.nextReview)-new Date(b.nextReview));
else if(sortBy==='review-desc')e=e.sort((a,b)=>(b.reviewCount||0)-(a.reviewCount||0));
else if(sortBy==='added-desc')e=e.sort((a,b)=>(b.addedDate||'').localeCompare(a.addedDate||''));
else e.sort((a,b)=>(a.Expression||'').localeCompare(b.Expression||''));
}
document.getElementById('word-count').textContent=e.length+'ê°œ';
document.getElementById('word-table-body').innerHTML=e.slice(0,wordOffset+50).map(x=>{
const a=getAcc(x),as=a!==null?a+'%':'-',c=a===null?'':a>=80?'color:var(--success)':a<50?'color:var(--danger)':'color:var(--warning)';
const star=x.starred?'â­ ':'';
const expr=x.Expression.replace(/'/g,"\\'");
const meaning=getMKO(x)||x.Function||'';
return`<tr><td onclick="openExprEditModal('${expr}')" style="cursor:pointer"><strong>${star}${x.Expression}</strong></td><td onclick="openExprEditModal('${expr}')" style="cursor:pointer;word-break:break-word;white-space:normal">${meaning}</td><td onclick="speakDataWord('${expr}')" style="${c};cursor:pointer;min-width:50px" title="ğŸ”Š í´ë¦­í•˜ì—¬ ë°œìŒ">${as}</td></tr>`;
}).join('');

}else if(currentDataType==='phrasal'){
let p=await getAllPV();
// ê²€ìƒ‰ í•„í„°
if(query){
p=p.filter(x=>(x.Phrasal_Verb||'').toLowerCase().includes(query)||(getMKO(x)||'').toLowerCase().includes(query)||(getMEN(x)||'').toLowerCase().includes(query));
// ê²€ìƒ‰ ê²°ê³¼ ì •ë ¬: ì •í™•ì¼ì¹˜ > ì‹œì‘ì¼ì¹˜ > í¬í•¨
p.sort((a,b)=>{
const aWord=(a.Phrasal_Verb||'').toLowerCase();
const bWord=(b.Phrasal_Verb||'').toLowerCase();
const aExact=aWord===query?0:1;
const bExact=bWord===query?0:1;
if(aExact!==bExact)return aExact-bExact;
const aStarts=aWord.startsWith(query)?0:1;
const bStarts=bWord.startsWith(query)?0:1;
if(aStarts!==bStarts)return aStarts-bStarts;
return aWord.localeCompare(bWord);
});
}
// íŠ¹ìˆ˜ í•„í„°
if(specialF==='new-today')p=p.filter(x=>x.addedDate&&x.addedDate.startsWith(today));
else if(specialF==='duplicate')p=p.filter(x=>/[Â¹Â²Â³]/.test(x.Phrasal_Verb)||/[123]$/.test(x.Phrasal_Verb));
else if(specialF==='starred')p=p.filter(x=>x.starred);
else if(specialF==='wrong')p=p.filter(x=>x.wrongNote);
else if(specialF==='no-review')p=p.filter(x=>!x.reviewCount);
// CEFR í•„í„°
if(cefrF!=='all')p=p.filter(x=>(x.CEFR||'B1')===cefrF);
// Priority í•„í„°
if(priorityF!=='all')p=p.filter(x=>(x.Priority||'P2')===priorityF);
// Formality í•„í„°
if(formalityF!=='all')p=p.filter(x=>(x.Formality||'Neutral')===formalityF);
// Currency í•„í„°
if(currencyF!=='all')p=p.filter(x=>(x.Currency||'Current')===currencyF);
// Medium í•„í„°
if(mediumF!=='all')p=p.filter(x=>(x.Medium||'Both')===mediumF);
// íƒœê·¸ í•„í„°
if(tagF!=='all')p=p.filter(x=>(x.tags||[]).includes(tagF));
// ì •ë ¬
if(!query){
if(sortBy==='acc-asc')p=p.filter(x=>x.reviewCount>0).sort((a,b)=>(getAcc(a)||100)-(getAcc(b)||100));
else if(sortBy==='acc-desc')p=p.filter(x=>x.reviewCount>0).sort((a,b)=>(getAcc(b)||0)-(getAcc(a)||0));
else if(sortBy==='stability-asc')p=p.sort((a,b)=>(a.stability||999)-(b.stability||999));
else if(sortBy==='due-first')p=p.filter(x=>x.nextReview).sort((a,b)=>new Date(a.nextReview)-new Date(b.nextReview));
else if(sortBy==='review-desc')p=p.sort((a,b)=>(b.reviewCount||0)-(a.reviewCount||0));
else if(sortBy==='added-desc')p=p.sort((a,b)=>(b.addedDate||'').localeCompare(a.addedDate||''));
else p.sort((a,b)=>(a.Phrasal_Verb||'').localeCompare(b.Phrasal_Verb||''));
}
document.getElementById('word-count').textContent=p.length+'ê°œ';
document.getElementById('word-table-body').innerHTML=p.slice(0,wordOffset+50).map(x=>{
const a=getAcc(x),as=a!==null?a+'%':'-',c=a===null?'':a>=80?'color:var(--success)':a<50?'color:var(--danger)':'color:var(--warning)';
const star=x.starred?'â­ ':'';
const tags=(x.tags||[]).map(t=>`<span style="background:var(--primary);color:#fff;padding:1px 6px;border-radius:8px;font-size:10px;margin-left:4px">${t}</span>`).join('');
const pv=x.Phrasal_Verb.replace(/'/g,"\\'");
return`<tr><td onclick="openEditModal('${pv}','phrasal')" style="cursor:pointer"><strong>${star}${x.Phrasal_Verb}</strong>${tags}</td><td onclick="openEditModal('${pv}','phrasal')" style="cursor:pointer">${getMKO(x)||''}</td><td onclick="speakDataWord('${pv}')" style="${c};cursor:pointer" title="ğŸ”Š í´ë¦­í•˜ì—¬ ë°œìŒ">${as}</td></tr>`;
}).join('');

}else{
let w=await getAllWords();
// ê²€ìƒ‰ í•„í„°
if(query){
w=w.filter(x=>displayWord(x.word||'').toLowerCase().includes(query)||(getMKO(x)||'').toLowerCase().includes(query)||(getMEN(x)||'').toLowerCase().includes(query));
// ê²€ìƒ‰ ê²°ê³¼ ì •ë ¬: ì •í™•ì¼ì¹˜ > ì‹œì‘ì¼ì¹˜ > í¬í•¨
w.sort((a,b)=>{
const aWord=displayWord(a.word||'').toLowerCase();
const bWord=displayWord(b.word||'').toLowerCase();
const aExact=aWord===query?0:1;
const bExact=bWord===query?0:1;
if(aExact!==bExact)return aExact-bExact;
const aStarts=aWord.startsWith(query)?0:1;
const bStarts=bWord.startsWith(query)?0:1;
if(aStarts!==bStarts)return aStarts-bStarts;
return aWord.localeCompare(bWord);
});
}
// íŠ¹ìˆ˜ í•„í„°
if(specialF==='new-today')w=w.filter(x=>x.addedDate&&x.addedDate.startsWith(today));
else if(specialF==='duplicate')w=w.filter(x=>/[Â¹Â²Â³]/.test(x.word)||/[123]$/.test(x.word));
else if(specialF==='starred')w=w.filter(x=>x.starred);
else if(specialF==='wrong')w=w.filter(x=>x.wrongNote);
else if(specialF==='no-review')w=w.filter(x=>!x.reviewCount);
// CEFR í•„í„°
if(cefrF!=='all')w=w.filter(x=>(x.CEFR||'B1')===cefrF);
// Priority í•„í„°
if(priorityF!=='all')w=w.filter(x=>(x.Priority||'P2')===priorityF);
// L2 ë„ë©”ì¸ í•„í„° (ì–´íœ˜ ì „ìš©)
if(l2F!=='all')w=w.filter(x=>(x.L2||'')===l2F);
// Formality í•„í„°
if(formalityF!=='all')w=w.filter(x=>(x.Formality||'Neutral')===formalityF);
// Currency í•„í„°
if(currencyF!=='all')w=w.filter(x=>(x.Currency||'Current')===currencyF);
// Medium í•„í„°
if(mediumF!=='all')w=w.filter(x=>(x.Medium||'Both')===mediumF);
// íƒœê·¸ í•„í„°
if(tagF!=='all')w=w.filter(x=>(x.tags||[]).includes(tagF));
// ì •ë ¬
if(!query){
if(sortBy==='acc-asc')w=w.filter(x=>x.reviewCount>0).sort((a,b)=>(getAcc(a)||100)-(getAcc(b)||100));
else if(sortBy==='acc-desc')w=w.filter(x=>x.reviewCount>0).sort((a,b)=>(getAcc(b)||0)-(getAcc(a)||0));
else if(sortBy==='stability-asc')w=w.sort((a,b)=>(a.stability||999)-(b.stability||999));
else if(sortBy==='due-first')w=w.filter(x=>x.nextReview).sort((a,b)=>new Date(a.nextReview)-new Date(b.nextReview));
else if(sortBy==='review-desc')w=w.sort((a,b)=>(b.reviewCount||0)-(a.reviewCount||0));
else if(sortBy==='added-desc')w=w.sort((a,b)=>(b.addedDate||'').localeCompare(a.addedDate||''));
else w.sort((a,b)=>displayWord(a.word||'').localeCompare(displayWord(b.word||'')));
}
document.getElementById('word-count').textContent=w.length+'ê°œ';
document.getElementById('word-table-body').innerHTML=w.slice(0,wordOffset+50).map(x=>{
const a=getAcc(x),as=a!==null?a+'%':'-',c=a===null?'':a>=80?'color:var(--success)':a<50?'color:var(--danger)':'color:var(--warning)';
const star=x.starred?'â­ ':'';
const tags=(x.tags||[]).map(t=>`<span style="background:var(--primary);color:#fff;padding:1px 6px;border-radius:8px;font-size:10px;margin-left:4px">${t}</span>`).join('');
const wd=x.word.replace(/'/g,"\\'");
const spkWord=displayWord(x.word,true).replace(/'/g,"\\'");
return`<tr><td onclick="openEditModal('${wd}','vocab')" style="cursor:pointer"><strong>${star}${displayWord(x.word)}</strong>${tags}</td><td onclick="openEditModal('${wd}','vocab')" style="cursor:pointer">${getMKO(x)||''}</td><td onclick="speakDataWord('${spkWord}')" style="${c};cursor:pointer" title="ğŸ”Š í´ë¦­í•˜ì—¬ ë°œìŒ">${as}</td></tr>`;
}).join('');
}
await updateTagFilter();
await updateL2FilterOptions();
}
async function loadMoreWords(){wordOffset+=50;updateWordTable();}

// === ê²€ìƒ‰ ê¸°ëŠ¥ ===
function searchWords(){currentSearchQuery=document.getElementById('word-search').value;wordOffset=0;updateWordTable();}

// === íƒœê·¸ í•„í„° ===
async function updateTagFilter(){
const items=currentDataType==='phrasal'?await getAllPV():currentDataType==='expr'?await getAllExpr():await getAllWords();
const allTags=new Set();
items.forEach(x=>(x.tags||[]).forEach(t=>allTags.add(t)));
const container=document.getElementById('tag-filter-container');
const tagsArr=[...allTags].sort();
if(!container)return;
const current=currentTagFilter;
container.innerHTML='<option value="all">ğŸ·ï¸ íƒœê·¸</option>'+
tagsArr.map(t=>`<option value="${t}"${current===t?' selected':''}>${t}</option>`).join('');
}
function filterByTag(tag){currentTagFilter=tag;wordOffset=0;updateWordTable();}

// === ë‹¨ì–´ ì§ì ‘ ì¶”ê°€ ===
let addWordType='vocab';
function openAddWordModal(keepWord=''){
if(!keepWord) addWordType=currentDataType==='expr'?'expr':currentDataType==='phrasal'?'phrasal':'vocab';
document.getElementById('add-type-vocab').classList.toggle('active',addWordType==='vocab');
document.getElementById('add-type-phrasal').classList.toggle('active',addWordType==='phrasal');
document.getElementById('add-type-expr').classList.toggle('active',addWordType==='expr');
document.getElementById('add-vocab-fields').style.display=addWordType==='vocab'?'block':'none';
document.getElementById('add-pv-fields').style.display=addWordType==='phrasal'?'block':'none';
document.getElementById('add-expr-fields').style.display=addWordType==='expr'?'block':'none';
document.getElementById('add-pos-group').style.display=addWordType==='expr'?'none':'block';
document.getElementById('add-meaning-en-group').style.display=addWordType==='expr'?'none':'block';
document.getElementById('add-word-label').textContent=addWordType==='expr'?'í‘œí˜„ *':addWordType==='phrasal'?'êµ¬ë™ì‚¬ *':'ë‹¨ì–´ *';
document.getElementById('add-word').value=keepWord;
document.getElementById('add-meaning-ko').value='';
document.getElementById('add-meaning-en').value='';
document.getElementById('add-example').value='';
document.getElementById('add-pos').value='';
document.getElementById('add-tags').value='';
// ì¶”ì²œ íƒœê·¸ ì´ˆê¸°í™”
document.querySelectorAll('#add-suggested-tags .chip').forEach(c=>c.classList.remove('checked'));
document.getElementById('add-l1').value='General';
document.getElementById('add-cefr').value='B1';
document.getElementById('add-collocation').value='';
document.getElementById('add-user-examples').value='';
document.getElementById('add-user-collocs').value='';
document.getElementById('add-base-verb').value='';
document.getElementById('add-particle').value='';
document.getElementById('add-pv-category').value='General';
document.getElementById('add-formal-equiv').value='';
document.getElementById('add-function').value='';
document.getElementById('add-formality').value='Neutral';
document.getElementById('add-currency').value='Current';
document.getElementById('add-medium').value='Both';
showModal('add-word-modal');
}
function switchAddType(t){
addWordType=t;
document.getElementById('add-type-vocab').classList.toggle('active',t==='vocab');
document.getElementById('add-type-phrasal').classList.toggle('active',t==='phrasal');
document.getElementById('add-type-expr').classList.toggle('active',t==='expr');
document.getElementById('add-vocab-fields').style.display=t==='vocab'?'block':'none';
document.getElementById('add-pv-fields').style.display=t==='phrasal'?'block':'none';
document.getElementById('add-expr-fields').style.display=t==='expr'?'block':'none';
document.getElementById('add-pos-group').style.display=t==='expr'?'none':'block';
document.getElementById('add-meaning-en-group').style.display=t==='expr'?'none':'block';
document.getElementById('add-word-label').textContent=t==='expr'?'í‘œí˜„ *':t==='phrasal'?'êµ¬ë™ì‚¬ *':'ë‹¨ì–´ *';
}
async function saveNewWord(){
const word=document.getElementById('add-word').value.trim();
const meaningKo=document.getElementById('add-meaning-ko').value.trim();
if(!word||!meaningKo){showToast('âš ï¸ ë‹¨ì–´ì™€ ëœ»(í•œêµ­ì–´)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤');return;}
// ì¶”ì²œ íƒœê·¸ (chip-multiì—ì„œ ì„ íƒëœ ê²ƒ)
const suggestedTags=Array.from(document.querySelectorAll('#add-suggested-tags .chip.checked')).map(c=>c.dataset.value);
// ì§ì ‘ ì…ë ¥ íƒœê·¸
const tagsStr=document.getElementById('add-tags').value.trim();
const manualTags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):[];
// í•©ì¹˜ê¸° (ì¤‘ë³µ ì œê±°)
const tags=[...new Set([...suggestedTags,...manualTags])];
const addBookmark=document.getElementById('add-bookmark').checked;
const formality=document.getElementById('add-formality').value;
const currency=document.getElementById('add-currency').value;
const medium=document.getElementById('add-medium').value;
if(addWordType==='expr'){
const exists=await getExpr(word);
if(exists){showToast('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‘œí˜„ì…ë‹ˆë‹¤');return;}
const expr={
Expression:word,
Meaning_KO:meaningKo,
Function:document.getElementById('add-function').value.trim(),
Formality:formality,
Currency:currency,
Medium:medium,
Example1:document.getElementById('add-example').value.trim(),
tags:tags,
starred:addBookmark,
// FSRS í•„ë“œ
stability:null,difficulty:null,fsrsState:'New',reps:0,lapses:0,
// í•™ìŠµ í†µê³„
reviewCount:0,correctCount:0,mastery:0,consecutiveWrong:0,wrongCount:0,
nextReview:null,lastReview:null,lastWrongDate:null
};
await saveExpr(expr);
}else if(addWordType==='phrasal'){
const exists=await getPV(word);
if(exists){showToast('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” êµ¬ë™ì‚¬ì…ë‹ˆë‹¤');return;}
const pv={
Phrasal_Verb:word,
Base_Verb:document.getElementById('add-base-verb').value.trim(),
Particle:document.getElementById('add-particle').value.trim(),
Meaning1_KO:meaningKo,
Meaning1_EN:document.getElementById('add-meaning-en').value.trim(),
Example1:document.getElementById('add-example').value.trim(),
Category:document.getElementById('add-pv-category').value,
Formal_Equivalent:document.getElementById('add-formal-equiv').value.trim(),
Formality:formality,
Currency:currency,
Medium:medium,
tags:tags,
starred:addBookmark,
// FSRS í•„ë“œ
stability:null,difficulty:null,fsrsState:'New',reps:0,lapses:0,
// í•™ìŠµ í†µê³„
reviewCount:0,correctCount:0,mastery:0,consecutiveWrong:0,wrongCount:0,
nextReview:null,lastReview:null,lastWrongDate:null
};
await savePV(pv);
}else{
const exists=await getWord(word);
if(exists){showToast('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹¨ì–´ì…ë‹ˆë‹¤');return;}
const userExStr=document.getElementById('add-user-examples').value.trim();
const userExamples=userExStr?userExStr.split('\n').map(e=>e.trim()).filter(e=>e):[];
const userCollStr=document.getElementById('add-user-collocs').value.trim();
const userCollocations=userCollStr?userCollStr.split(',').map(c=>c.trim()).filter(c=>c):[];
const w={
word:word,
POS:document.getElementById('add-pos').value.trim(),
Meaning1_KO:meaningKo,
Meaning1_EN:document.getElementById('add-meaning-en').value.trim(),
Example1:document.getElementById('add-example').value.trim(),
Key_Collocation:document.getElementById('add-collocation').value.trim(),
L1:document.getElementById('add-l1').value,
L2:document.getElementById('add-l2').value,
CEFR:document.getElementById('add-cefr').value||'B1',
Formality:formality,
Currency:currency,
Medium:medium,
tags:tags,
starred:addBookmark,
userExamples:userExamples,
userCollocations:userCollocations,
// FSRS í•„ë“œ
stability:null,difficulty:null,fsrsState:'New',reps:0,lapses:0,
// í•™ìŠµ í†µê³„
reviewCount:0,correctCount:0,mastery:0,consecutiveWrong:0,wrongCount:0,
nextReview:null,lastReview:null,lastWrongDate:null
};
await saveWord(w);
}
closeModal('add-word-modal');
showToast(addBookmark?'âœ… ì €ì¥ + â­ ë¶ë§ˆí¬ ì¶”ê°€':'âœ… ì¶”ê°€ ì™„ë£Œ');
updateWordTable();
updateHomeStats();
}


// === ì—…ë¡œë“œ ===
function normH(h){return(h||'').toString().toLowerCase().replace(/[_\s\-]/g,'');}
async function processFile(file){
showToast('ğŸ“¤ ì—…ë¡œë“œ ì¤‘...');
try{const data=await file.arrayBuffer(),wb=XLSX.read(data);let vS=null,pS=null,eS=null;
for(const sn of wb.SheetNames){const l=sn.toLowerCase();if(l.includes('phrasal')||l==='pv'||l.includes('êµ¬ë™ì‚¬'))pS=sn;else if(l.includes('express')||l.includes('í‘œí˜„'))eS=sn;else if(l.includes('vocab')||l.includes('word')||l==='ì–´íœ˜')vS=sn;}
if(wb.SheetNames.length>=2){if(vS&&!pS)pS=wb.SheetNames.find(s=>s!==vS&&s!==eS);if(pS&&!vS)vS=wb.SheetNames.find(s=>s!==pS&&s!==eS);}
if(!vS&&!pS&&!eS)vS=wb.SheetNames[0];
let vR=null,pR=null,eR=null;
if(vS){const json=XLSX.utils.sheet_to_json(wb.Sheets[vS],{header:1});let hr=0;for(let i=0;i<Math.min(10,json.length);i++){if(json[i]&&json[i].some(c=>c&&normH(c)==='word')){hr=i;break;}}const headers=(json[hr]||[]).map(h=>(h||'').toString());const colIdx={};headers.forEach((h,i)=>{colIdx[normH(h)]=i;});const wIdx=colIdx['word'];
if(wIdx!==undefined){let nC=0,uC=0,pC=0;const ws=[];const gC=(r,n)=>{const idx=colIdx[normH(n)];return idx!==undefined&&r[idx]!=null?r[idx].toString():'';};
const gN=(r,n)=>{const v=gC(r,n);return v?parseFloat(v):null;}; // ìˆ«ì íŒŒì‹±
const gI=(r,n)=>{const v=gC(r,n);return v?parseInt(v,10):0;}; // ì •ìˆ˜ íŒŒì‹±
// ì—¬ëŸ¬ ì»¬ëŸ¼ëª… ì‹œë„ í—¬í¼
const gM=(r,...names)=>{for(const n of names){const v=gC(r,n);if(v)return v;}return '';};
for(let i=hr+1;i<json.length;i++){const r=json[i];if(!r||!r[wIdx])continue;const wK=r[wIdx].toString().trim();const ex=await getWord(wK);if(ex){uC++;if(ex.reviewCount>0)pC++;}else nC++;const starredVal=gC(r,'starred').toLowerCase();const needsProdVal=gC(r,'needsproduction').toLowerCase();const tagsStr=gC(r,'tags');const tags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):(ex?.tags||[]);
// Synonyms/Antonyms: ì—¬ëŸ¬ ì»¬ëŸ¼ëª… ì§€ì›
const synRaw=gM(r,'Synonyms','Synonyms_EN','SynonymsEN','Synonym');
const antRaw=gM(r,'Antonyms','Antonyms_EN','AntonymsEN','Antonyms_KO','AntonymsKO','Antonym');
ws.push({word:wK,POS:gC(r,'POS')||ex?.POS||'',
Meaning1_EN:gM(r,'Meaning1_EN','MeaningEN','Meaning_EN','Meaning1EN')||ex?.Meaning1_EN||'',
Meaning1_KO:gM(r,'Meaning1_KO','MeaningKO','Meaning_KO','Meaning1KO')||ex?.Meaning1_KO||'',
Meaning2_EN:gC(r,'Meaning2_EN')||ex?.Meaning2_EN||'',
Meaning2_KO:gC(r,'Meaning2_KO')||ex?.Meaning2_KO||'',
Synonyms:synRaw?synRaw.split(',').map(s=>s.trim()).filter(s=>s):(ex?.Synonyms||[]),
Antonyms:antRaw?antRaw.split(',').map(s=>s.trim()).filter(s=>s):(ex?.Antonyms||[]),
Antonyms_EN:gC(r,'Antonyms_EN')||ex?.Antonyms_EN||'',Antonyms_KO:gC(r,'Antonyms_KO')||ex?.Antonyms_KO||'',
L0:gC(r,'L0')||ex?.L0||'Academic',L1:gC(r,'L1')||ex?.L1||'General',L2:gC(r,'L2')||ex?.L2||'',
Formality:gM(r,'Formality','Register')||ex?.Formality||'Neutral',
Currency:gC(r,'Currency')||ex?.Currency||'Current',
Medium:gC(r,'Medium')||ex?.Medium||'Both',
CEFR:gC(r,'CEFR')||ex?.CEFR||'B1',Frequency:gC(r,'Frequency')||ex?.Frequency||'K3',Priority:gC(r,'Priority')||ex?.Priority||'P2',TOEFL_Rel:gC(r,'TOEFL_Rel')||ex?.TOEFL_Rel||'',COCA_Genre:gC(r,'COCA_Genre')||ex?.COCA_Genre||'',
Example1:gM(r,'Example1','Example','Example_1')||ex?.Example1||'',
Example2:gC(r,'Example2')||ex?.Example2||'',
Key_Collocation:gC(r,'Key_Collocation')||ex?.Key_Collocation||'',
Common_Error:gC(r,'Common_Error')||ex?.Common_Error||'',
tags:tags,starred:starredVal==='y'||starredVal==='yes'||ex?.starred||false,needsProduction:needsProdVal==='y'||needsProdVal==='yes'||ex?.needsProduction||false,
// FSRS í•„ë“œ - Excel ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ì¡´ DB, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
stability:gN(r,'stability')||ex?.stability||null,
difficulty:gN(r,'difficulty')||ex?.difficulty||null,
interval:gI(r,'interval')||ex?.interval||1,
fsrsState:gC(r,'fsrsstate')||ex?.fsrsState||'New',
reps:gI(r,'reps')||ex?.reps||0,
lapses:gI(r,'lapses')||ex?.lapses||0,
// í•™ìŠµ í†µê³„ - Excel ê°’ ìš°ì„ 
reviewCount:gI(r,'reviewcount')||ex?.reviewCount||0,
correctCount:gI(r,'correctcount')||ex?.correctCount||0,
mastery:gI(r,'mastery')||ex?.mastery||0,
wrongCount:gI(r,'wrongcount')||ex?.wrongCount||0,
consecutiveWrong:gI(r,'consecutivewrong')||ex?.consecutiveWrong||0,
nextReview:gC(r,'nextreview')||ex?.nextReview||null,
lastReview:gC(r,'lastreview')||ex?.lastReview||null,
lastWrongDate:gC(r,'lastwrongdate')||ex?.lastWrongDate||null,
// ë ˆê±°ì‹œ (í˜¸í™˜ì„±)
ease:gN(r,'ease')||ex?.ease||2.5,
leitnerBox:gI(r,'leitnerbox')||ex?.leitnerBox||1,
// ì‚¬ìš©ì ì •ì˜ ì˜ˆë¬¸/ì½œë¡œì¼€ì´ì…˜ - Excel ê°’ ìš°ì„  (íŒŒì´í”„/ì‰¼í‘œë¡œ êµ¬ë¶„)
userExamples:(()=>{const v=gC(r,'userexamples');return v?v.split(' | ').map(s=>s.trim()).filter(s=>s):(ex?.userExamples||[]);})(),
userCollocations:(()=>{const v=gC(r,'usercollocations');return v?v.split(', ').map(s=>s.trim()).filter(s=>s):(ex?.userCollocations||[]);})()});}
const tx=db.transaction('words','readwrite');ws.forEach(w=>tx.objectStore('words').put(w));await new Promise(r=>{tx.oncomplete=r;});vR={total:ws.length,new:nC,update:uC,preserved:pC,sheet:vS};}}
if(pS){const json=XLSX.utils.sheet_to_json(wb.Sheets[pS],{header:1});let hr=0;for(let i=0;i<Math.min(10,json.length);i++){if(json[i]&&json[i].some(c=>c&&normH(c)==='phrasalverb')){hr=i;break;}}const headers=(json[hr]||[]).map(h=>(h||'').toString());const colIdx={};headers.forEach((h,i)=>{colIdx[normH(h)]=i;});const pvIdx=colIdx['phrasalverb'];
if(pvIdx!==undefined){let nC=0,uC=0,pC=0;const ps=[];const gC=(r,n)=>{const idx=colIdx[normH(n)];return idx!==undefined&&r[idx]!=null?r[idx].toString():'';};
const gN=(r,n)=>{const v=gC(r,n);return v?parseFloat(v):null;};
const gI=(r,n)=>{const v=gC(r,n);return v?parseInt(v,10):0;};
const gM=(r,...names)=>{for(const n of names){const v=gC(r,n);if(v)return v;}return '';};
for(let i=hr+1;i<json.length;i++){const r=json[i];if(!r||!r[pvIdx])continue;const pvK=r[pvIdx].toString().trim();const ex=await getPV(pvK);if(ex){uC++;if(ex.reviewCount>0)pC++;}else nC++;const starredVal=gC(r,'starred').toLowerCase();const needsProdVal=gC(r,'needsproduction').toLowerCase();const tagsStr=gC(r,'tags');const tags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):(ex?.tags||[]);
// Synonyms/Antonyms: ì—¬ëŸ¬ ì»¬ëŸ¼ëª… ì§€ì›
const synRaw=gM(r,'Synonyms','Synonyms_EN','SynonymsEN');
const antRaw=gM(r,'Antonyms','Antonyms_EN','AntonymsEN');
ps.push({Phrasal_Verb:pvK,
Base_Verb:gM(r,'Base_Verb','baseverb','BaseVerb')||ex?.Base_Verb||'',
Particle:gC(r,'Particle')||ex?.Particle||'',
Meaning1_EN:gM(r,'Meaning1_EN','MeaningEN','Meaning_EN')||ex?.Meaning1_EN||'',
Meaning1_KO:gM(r,'Meaning1_KO','MeaningKO','Meaning_KO')||ex?.Meaning1_KO||'',
Meaning2_EN:gC(r,'Meaning2_EN')||ex?.Meaning2_EN||'',
Meaning2_KO:gC(r,'Meaning2_KO')||ex?.Meaning2_KO||'',
Transparency:gC(r,'Transparency')||ex?.Transparency||'',
Particle_Meaning:gC(r,'Particle_Meaning')||ex?.Particle_Meaning||'',
Category:gC(r,'Category')||ex?.Category||'General',
Formality:gM(r,'Formality','Register')||ex?.Formality||'Neutral',
Currency:gC(r,'Currency')||ex?.Currency||'Current',
Medium:gC(r,'Medium')||ex?.Medium||'Both',
Synonyms:synRaw?synRaw.split(',').map(s=>s.trim()).filter(s=>s):(ex?.Synonyms||[]),
Antonyms:antRaw?antRaw.split(',').map(s=>s.trim()).filter(s=>s):(ex?.Antonyms||[]),
Formal_Equivalent:gC(r,'Formal_Equivalent')||ex?.Formal_Equivalent||'',
Separable:gC(r,'Separable')||ex?.Separable||'',
Example1:gM(r,'Example1','Example','Example_1')||ex?.Example1||'',
Example2:gC(r,'Example2')||ex?.Example2||'',
Common_Error:gC(r,'Common_Error')||ex?.Common_Error||'',
CEFR:gC(r,'CEFR')||ex?.CEFR||'B1',Priority:gC(r,'Priority')||ex?.Priority||'P2',Frequency:gC(r,'Frequency')||ex?.Frequency||'K3',tags:tags,starred:starredVal==='y'||starredVal==='yes'||ex?.starred||false,needsProduction:needsProdVal==='y'||needsProdVal==='yes'||ex?.needsProduction||false,
// FSRS í•„ë“œ - Excel ê°’ ìš°ì„ 
stability:gN(r,'stability')||ex?.stability||null,
difficulty:gN(r,'difficulty')||ex?.difficulty||null,
interval:gI(r,'interval')||ex?.interval||1,
fsrsState:gC(r,'fsrsstate')||ex?.fsrsState||'New',
reps:gI(r,'reps')||ex?.reps||0,
lapses:gI(r,'lapses')||ex?.lapses||0,
// í•™ìŠµ í†µê³„ - Excel ê°’ ìš°ì„ 
reviewCount:gI(r,'reviewcount')||ex?.reviewCount||0,
correctCount:gI(r,'correctcount')||ex?.correctCount||0,
mastery:gI(r,'mastery')||ex?.mastery||0,
wrongCount:gI(r,'wrongcount')||ex?.wrongCount||0,
consecutiveWrong:gI(r,'consecutivewrong')||ex?.consecutiveWrong||0,
nextReview:gC(r,'nextreview')||ex?.nextReview||null,
lastReview:gC(r,'lastreview')||ex?.lastReview||null,
lastWrongDate:gC(r,'lastwrongdate')||ex?.lastWrongDate||null,
// ë ˆê±°ì‹œ (í˜¸í™˜ì„±)
ease:gN(r,'ease')||ex?.ease||2.5,
leitnerBox:gI(r,'leitnerbox')||ex?.leitnerBox||1});}
const tx=db.transaction('phrasal_verbs','readwrite');ps.forEach(p=>tx.objectStore('phrasal_verbs').put(p));await new Promise(r=>{tx.oncomplete=r;});pR={total:ps.length,new:nC,update:uC,preserved:pC,sheet:pS};}}
// Expression ì‹œíŠ¸ ì²˜ë¦¬
if(eS){const json=XLSX.utils.sheet_to_json(wb.Sheets[eS],{header:1});let hr=0;for(let i=0;i<Math.min(10,json.length);i++){if(json[i]&&json[i].some(c=>c&&normH(c)==='expression')){hr=i;break;}}const headers=(json[hr]||[]).map(h=>(h||'').toString());const colIdx={};headers.forEach((h,i)=>{colIdx[normH(h)]=i;});const exprIdx=colIdx['expression'];
if(exprIdx!==undefined){let nC=0,uC=0,pC=0;const es=[];const gC=(r,n)=>{const idx=colIdx[normH(n)];return idx!==undefined&&r[idx]!=null?r[idx].toString():'';};
const gN=(r,n)=>{const v=gC(r,n);return v?parseFloat(v):null;};
const gI=(r,n)=>{const v=gC(r,n);return v?parseInt(v,10):0;};
const gM=(r,...names)=>{for(const n of names){const v=gC(r,n);if(v)return v;}return '';};
for(let i=hr+1;i<json.length;i++){const r=json[i];if(!r||!r[exprIdx])continue;const eK=r[exprIdx].toString().trim();const ex=await getExpr(eK);if(ex){uC++;if(ex.reviewCount>0)pC++;}else nC++;const starredVal=gC(r,'starred').toLowerCase();const needsProdVal=gC(r,'needsproduction').toLowerCase();const tagsStr=gC(r,'tags');const tags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):(ex?.tags||[]);es.push({Expression:eK,
L1:gC(r,'L1')||ex?.L1||'',
L2:gC(r,'L2')||ex?.L2||'',
L3:gC(r,'L3')||ex?.L3||'',
Function:gC(r,'Function')||ex?.Function||'',
Meaning_KO:gM(r,'Meaning_KO','MeaningKO','Meaning1_KO')||ex?.Meaning_KO||'',
Meaning_EN:gM(r,'Meaning_EN','MeaningEN','Meaning1_EN')||ex?.Meaning_EN||'',
Register:gM(r,'Register','Formality')||ex?.Register||'Neutral',
Formality:gM(r,'Formality','Register')||ex?.Formality||'Neutral',
Currency:gC(r,'Currency')||ex?.Currency||'Current',
Medium:gC(r,'Medium')||ex?.Medium||'Both',
Example1:gM(r,'Example1','Example','Example_1')||ex?.Example1||'',
Example2:gC(r,'Example2')||ex?.Example2||'',
Similar_Expr:gC(r,'Similar_Expr')||ex?.Similar_Expr||'',
Alternatives:gC(r,'Alternatives')||ex?.Alternatives||'',
Common_Error:gC(r,'Common_Error')||ex?.Common_Error||'',
CEFR:gC(r,'CEFR')||ex?.CEFR||'B1',Priority:gC(r,'Priority')||ex?.Priority||'P2',Frequency:gC(r,'Frequency')||ex?.Frequency||'K3',tags:tags,starred:starredVal==='y'||starredVal==='yes'||ex?.starred||false,needsProduction:needsProdVal==='y'||needsProdVal==='yes'||ex?.needsProduction||false,
// FSRS í•„ë“œ - Excel ê°’ ìš°ì„ 
stability:gN(r,'stability')||ex?.stability||null,
difficulty:gN(r,'difficulty')||ex?.difficulty||null,
interval:gI(r,'interval')||ex?.interval||1,
fsrsState:gC(r,'fsrsstate')||ex?.fsrsState||'New',
reps:gI(r,'reps')||ex?.reps||0,
lapses:gI(r,'lapses')||ex?.lapses||0,
// í•™ìŠµ í†µê³„ - Excel ê°’ ìš°ì„ 
reviewCount:gI(r,'reviewcount')||ex?.reviewCount||0,
correctCount:gI(r,'correctcount')||ex?.correctCount||0,
mastery:gI(r,'mastery')||ex?.mastery||0,
wrongCount:gI(r,'wrongcount')||ex?.wrongCount||0,
consecutiveWrong:gI(r,'consecutivewrong')||ex?.consecutiveWrong||0,
nextReview:gC(r,'nextreview')||ex?.nextReview||null,
lastReview:gC(r,'lastreview')||ex?.lastReview||null,
lastWrongDate:gC(r,'lastwrongdate')||ex?.lastWrongDate||null,
// ë ˆê±°ì‹œ (í˜¸í™˜ì„±)
ease:gN(r,'ease')||ex?.ease||2.5,
leitnerBox:gI(r,'leitnerbox')||ex?.leitnerBox||1});}
const tx=db.transaction('expressions','readwrite');es.forEach(e=>tx.objectStore('expressions').put(e));await new Promise(r=>{tx.oncomplete=r;});eR={total:es.length,new:nC,update:uC,preserved:pC,sheet:eS};}}
let rHTML='';if(vR)rHTML+=`<div class="upload-result-item"><span>ğŸ“– ì–´íœ˜ (${vR.sheet})</span><span>${vR.total}ê°œ (ìƒˆ ${vR.new}, ê°±ì‹  ${vR.update}, ê¸°ë¡ë³´ì¡´ ${vR.preserved})</span></div>`;if(pR)rHTML+=`<div class="upload-result-item"><span>ğŸ”— êµ¬ë™ì‚¬ (${pR.sheet})</span><span>${pR.total}ê°œ (ìƒˆ ${pR.new}, ê°±ì‹  ${pR.update}, ê¸°ë¡ë³´ì¡´ ${pR.preserved})</span></div>`;if(eR)rHTML+=`<div class="upload-result-item"><span>ğŸ’¬ í‘œí˜„ (${eR.sheet})</span><span>${eR.total}ê°œ (ìƒˆ ${eR.new}, ê°±ì‹  ${eR.update}, ê¸°ë¡ë³´ì¡´ ${eR.preserved})</span></div>`;if(!vR&&!pR&&!eR)rHTML=`<div class="upload-result-item"><span>âš ï¸ ì¸ì‹ëœ ë°ì´í„° ì—†ìŒ</span><span>ì‹œíŠ¸: ${wb.SheetNames.join(', ')}</span></div>`;
if(rHTML){document.getElementById('upload-result').innerHTML=rHTML;document.getElementById('upload-result').classList.remove('hidden');}
showToast('âœ… ì—…ë¡œë“œ ì™„ë£Œ!');vibrate();updateHomeStats();updateDataPage();
}catch(e){console.error(e);showToast('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message);}}
const uploadZone=document.getElementById('upload-zone'),fileInput=document.getElementById('file-input');
uploadZone?.addEventListener('click',()=>fileInput?.click());
fileInput?.addEventListener('change',e=>{const file=e.target.files[0];if(file)processFile(file);e.target.value='';});
// ì „ì—­ ë“œë˜ê·¸ ë°©ì§€ (ë¸Œë¼ìš°ì €ê°€ íŒŒì¼ ì—´ê¸° ì‹œë„ ì°¨ë‹¨)
document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',e=>e.preventDefault());
// ì—…ë¡œë“œ ì¡´ ë“œë˜ê·¸ ì•¤ ë“œë¡­
['dragenter','dragover'].forEach(ev=>uploadZone?.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();uploadZone.classList.add('dragover');}));
['dragleave','dragend'].forEach(ev=>uploadZone?.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();uploadZone.classList.remove('dragover');}));
uploadZone?.addEventListener('drop',e=>{e.preventDefault();e.stopPropagation();uploadZone.classList.remove('dragover');const file=e.dataTransfer?.files?.[0];console.log('Drop file:',file?.name);if(file&&(file.name.endsWith('.xlsx')||file.name.endsWith('.xls'))){processFile(file);}else if(file){showToast('âš ï¸ ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');}});
// â˜… ëª¨ë‹¬ ì—…ë¡œë“œ ì¡´ ë“œë˜ê·¸ ì•¤ ë“œë¡­
const modalUploadZone=document.getElementById('modal-upload-zone');
['dragenter','dragover'].forEach(ev=>modalUploadZone?.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();modalUploadZone.style.borderColor='var(--primary)';modalUploadZone.style.background='rgba(99,102,241,.05)';}));
['dragleave','dragend'].forEach(ev=>modalUploadZone?.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();modalUploadZone.style.borderColor='var(--border)';modalUploadZone.style.background='transparent';}));
modalUploadZone?.addEventListener('drop',e=>{e.preventDefault();e.stopPropagation();modalUploadZone.style.borderColor='var(--border)';modalUploadZone.style.background='transparent';const file=e.dataTransfer?.files?.[0];if(file&&(file.name.endsWith('.xlsx')||file.name.endsWith('.xls'))){processModalExcel(file);}else if(file){showToast('âš ï¸ ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');}});

// === ë°ì´í„° ê´€ë¦¬ ===
async function clearDB(store){const name=store==='phrasal_verbs'?'êµ¬ë™ì‚¬':store==='expressions'?'í‘œí˜„':'ì–´íœ˜';showConfirm(name+' ì´ˆê¸°í™”',name+' ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?',async()=>{const tx=db.transaction([store],'readwrite');tx.objectStore(store).clear();await new Promise(r=>{tx.oncomplete=r;});showToast('ğŸ—‘ï¸ '+name+' ì´ˆê¸°í™” ì™„ë£Œ');updateHomeStats();updateDataPage();});}
async function resetWrongNotes(){showConfirm('ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”','ëª¨ë“  ì˜¤ë‹µ ê¸°ë¡ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?',async()=>{const w=await getAllWords(),p=await getAllPV();for(const x of w){x.consecutiveWrong=0;x.wrongCount=0;x.lastWrongDate=null;await saveWord(x);}for(const x of p){x.consecutiveWrong=0;x.wrongCount=0;x.lastWrongDate=null;await savePV(x);}showToast('ğŸ§¹ ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');updateHomeStats();});}
async function exportAllData(){try{const w=await getAllWords(),p=await getAllPV(),e=await getAllExpr(),s=await getSessions();const data={words:w,phrasal_verbs:p,expressions:e,sessions:s,exportDate:new Date().toISOString(),version:'7.0'};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='cems_backup_'+new Date().toISOString().slice(0,10)+'.json';a.click();showToast('ğŸ“¥ ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ');}catch(e){console.error('exportAllData error:',e);showToast('âŒ ë°±ì—… ì‹¤íŒ¨: '+e.message);}}
async function handleRestoreFile(input){
try{
  const file=input.files[0];
  if(!file)return;
  const txt=await file.text();
  const data=JSON.parse(txt);
  if(data.words?.length){const tx=db.transaction('words','readwrite');data.words.forEach(w=>tx.objectStore('words').put(w));await new Promise(r=>{tx.oncomplete=r;});}
  if(data.phrasal_verbs?.length){const tx=db.transaction('phrasal_verbs','readwrite');data.phrasal_verbs.forEach(p=>tx.objectStore('phrasal_verbs').put(p));await new Promise(r=>{tx.oncomplete=r;});}
  if(data.expressions?.length){const tx=db.transaction('expressions','readwrite');data.expressions.forEach(e=>tx.objectStore('expressions').put(e));await new Promise(r=>{tx.oncomplete=r;});}
  if(data.sessions?.length){const tx=db.transaction('sessions','readwrite');data.sessions.forEach(s=>{delete s.id;tx.objectStore('sessions').add(s);});await new Promise(r=>{tx.oncomplete=r;});}
  showToast('âœ… ë°ì´í„° ë³µì› ì™„ë£Œ');
  updateHomeStats();updateDataPage();
}catch(err){console.error(err);showToast('âŒ ë³µì› ì‹¤íŒ¨: '+err.message);}
finally{input.value='';} // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ
}
function resetAllData(){showConfirm('ì „ì²´ ì´ˆê¸°í™”','ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?',()=>{indexedDB.deleteDatabase(DB_NAME);localStorage.clear();showToast('ğŸ—‘ï¸ ì´ˆê¸°í™” ì™„ë£Œ');setTimeout(()=>location.reload(),1000);});}

// === ë‹¨ì–´ í¸ì§‘ ===
let editingItem=null,editingType='vocab';
async function openEditModal(key,type){
editingType=type;
document.getElementById('edit-vocab-fields').style.display=type==='vocab'?'block':'none';
document.getElementById('edit-pv-fields').style.display=type==='phrasal'?'block':'none';
// â˜… êµ¬ë™ì‚¬ì¼ ë•Œ POS í•„ë“œ ìˆ¨ê¸°ê¸°
document.getElementById('edit-pos-group').style.display=type==='phrasal'?'none':'block';
if(type==='phrasal'){editingItem=await getPV(key);if(!editingItem)return;
document.getElementById('edit-word').value=editingItem.Phrasal_Verb||'';
document.getElementById('edit-meaning-ko').value=getMKO(editingItem)||'';
document.getElementById('edit-meaning-en').value=getMEN(editingItem)||'';
document.getElementById('edit-example').value=getEx(editingItem)||'';
document.getElementById('edit-base-verb').value=editingItem.Base_Verb||'';
document.getElementById('edit-pv-category').value=editingItem.Category||'General';
document.getElementById('edit-pv-cefr').value=editingItem.CEFR||'B1';
document.getElementById('edit-pv-formality').value=editingItem.Formality||'Neutral';
document.getElementById('edit-pv-currency').value=editingItem.Currency||'Current';
document.getElementById('edit-pv-medium').value=editingItem.Medium||'Both';
document.getElementById('edit-pv-toefl').value=editingItem.TOEFL_Rel||'';
document.getElementById('edit-pv-priority').value=editingItem.Priority||'';
document.getElementById('edit-coca').value=editingItem.COCA_Genre||'';
document.getElementById('edit-formal-equiv').value=editingItem.Formal_Equivalent||'';
const pvSyn=editingItem.Synonyms;
document.getElementById('edit-pv-synonyms').value=Array.isArray(pvSyn)?pvSyn.join(', '):(pvSyn||'');
const pvAnt=editingItem.Antonyms;
document.getElementById('edit-pv-antonyms').value=Array.isArray(pvAnt)?pvAnt.join(', '):(pvAnt||'');
}else{editingItem=await getWord(key);if(!editingItem)return;
document.getElementById('edit-word').value=editingItem.word||'';
document.getElementById('edit-meaning-ko').value=getMKO(editingItem)||'';
document.getElementById('edit-meaning-en').value=getMEN(editingItem)||'';
document.getElementById('edit-example').value=getEx(editingItem)||'';
document.getElementById('edit-pos').value=editingItem.POS||'';
document.getElementById('edit-l2').value=editingItem.L2||'Core';
document.getElementById('edit-cefr').value=editingItem.CEFR||'B1';
document.getElementById('edit-toefl').value=editingItem.TOEFL_Rel||'';
document.getElementById('edit-freq').value=editingItem.Frequency||'';
document.getElementById('edit-priority').value=editingItem.Priority||'';
document.getElementById('edit-coca').value=editingItem.COCA_Genre||'';
document.getElementById('edit-formality').value=editingItem.Formality||'Neutral';
document.getElementById('edit-currency').value=editingItem.Currency||'Current';
document.getElementById('edit-medium').value=editingItem.Medium||'Both';
document.getElementById('edit-collocation').value=editingItem.Key_Collocation||'';
document.getElementById('edit-user-examples').value=(editingItem.userExamples||[]).join('\n');
document.getElementById('edit-user-collocs').value=(editingItem.userCollocations||[]).join(', ');
// Synonyms/Antonyms: ë°°ì—´ ë˜ëŠ” ë¬¸ìì—´ ì²˜ë¦¬
const syn=editingItem.Synonyms;
document.getElementById('edit-synonyms').value=Array.isArray(syn)?syn.join(', '):(syn||'');
const ant=editingItem.Antonyms;
document.getElementById('edit-antonyms').value=Array.isArray(ant)?ant.join(', '):(ant||'');
}
const acc=getAcc(editingItem);
document.getElementById('edit-review-count').textContent=editingItem.reviewCount||0;
document.getElementById('edit-accuracy').textContent=acc!==null?acc+'%':'-';
document.getElementById('edit-box').textContent=editingItem.leitnerBox||1;
document.getElementById('edit-wrong-count').textContent=editingItem.wrongCount||0;
document.getElementById('edit-ease').textContent=(editingItem.ease||2.5).toFixed(2);
const nextRev=editingItem.nextReview?new Date(editingItem.nextReview):null;
document.getElementById('edit-next-review').textContent=nextRev?`${nextRev.getMonth()+1}/${nextRev.getDate()}`:'-';
document.getElementById('edit-bookmark-btn').textContent=editingItem.starred?'â­ ë¶ë§ˆí¬ í•´ì œ':'â˜† ë¶ë§ˆí¬';
document.getElementById('edit-bookmark-btn').style.color=editingItem.starred?'var(--warning)':'';
// íƒœê·¸ ë¶„ë¦¬ ë¡œë“œ: ì¶”ì²œ íƒœê·¸ëŠ” chip, ë‚˜ë¨¸ì§€ëŠ” ì§ì ‘ ì…ë ¥
const SUGGESTED=['Academic','Literary','Legal','Business','Technical','Medical','BrE','AmE','Idiom','TOEFL'];
const existingTags=editingItem.tags||[];
document.querySelectorAll('#edit-suggested-tags .chip').forEach(c=>{
  c.classList.toggle('checked',existingTags.includes(c.dataset.value));
});
const manualTags=existingTags.filter(t=>!SUGGESTED.includes(t));
document.getElementById('edit-tags').value=manualTags.join(', ');
showModal('edit-modal');
}
async function saveEditedWord(){
if(!editingItem){showToast('âŒ í¸ì§‘í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');return;}
try{
editingItem.Meaning1_KO=document.getElementById('edit-meaning-ko').value;
editingItem.Meaning1_EN=document.getElementById('edit-meaning-en').value;
editingItem.Example1=document.getElementById('edit-example').value;
// ì¶”ì²œ íƒœê·¸ + ì§ì ‘ ì…ë ¥ íƒœê·¸ í•©ì¹˜ê¸°
const suggestedTags=Array.from(document.querySelectorAll('#edit-suggested-tags .chip.checked')).map(c=>c.dataset.value);
const tagsStr=document.getElementById('edit-tags').value.trim();
const manualTags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):[];
editingItem.tags=[...new Set([...suggestedTags,...manualTags])];
if(editingType==='phrasal'){
editingItem.Base_Verb=document.getElementById('edit-base-verb').value;
editingItem.Category=document.getElementById('edit-pv-category').value;
editingItem.CEFR=document.getElementById('edit-pv-cefr').value;
editingItem.Formality=document.getElementById('edit-pv-formality').value;
editingItem.Currency=document.getElementById('edit-pv-currency').value;
editingItem.Medium=document.getElementById('edit-pv-medium').value;
editingItem.TOEFL_Rel=document.getElementById('edit-pv-toefl').value;
editingItem.Priority=document.getElementById('edit-pv-priority').value;
editingItem.COCA_Genre=document.getElementById('edit-coca').value;
editingItem.Formal_Equivalent=document.getElementById('edit-formal-equiv').value;
const pvSynStr=document.getElementById('edit-pv-synonyms').value.trim();
editingItem.Synonyms=pvSynStr?pvSynStr.split(',').map(s=>s.trim()).filter(s=>s):[];
const pvAntStr=document.getElementById('edit-pv-antonyms').value.trim();
editingItem.Antonyms=pvAntStr?pvAntStr.split(',').map(a=>a.trim()).filter(a=>a):[];
await savePV(editingItem);
}else{
editingItem.POS=document.getElementById('edit-pos').value;
// L2 â†’ L1, L0 ìë™ ë§¤í•‘
const l2=document.getElementById('edit-l2').value;
const L2_MAP={
  Life:'Science',Physical:'Science',Earth:'Science',Applied:'Science',
  Psychology:'Society',Culture:'Society',Economy:'Society',Politics:'Society',History:'Society',
  Literature:'Arts',Visual:'Arts',Performing:'Arts',Ideas:'Arts',
  Core:'General',Research:'General',Argument:'General',
  Body:'Concrete',Objects:'Concrete',Nature:'Concrete',
  Living:'Activity',Work:'Activity',Commerce:'Activity',Travel:'Activity',Health:'Activity',
  Relationships:'Social',Leisure:'Social'
};
const L1_DOMAIN={Science:'Academic',Society:'Academic',Arts:'Academic',General:'Academic',Concrete:'Daily',Activity:'Daily',Social:'Daily'};
const l1=L2_MAP[l2]||'General';
editingItem.L2=l2;
editingItem.L1=l1;
editingItem.L0=L1_DOMAIN[l1]||'Academic';
editingItem.CEFR=document.getElementById('edit-cefr').value;
editingItem.TOEFL_Rel=document.getElementById('edit-toefl').value;
editingItem.Frequency=document.getElementById('edit-freq').value;
editingItem.Priority=document.getElementById('edit-priority').value;
editingItem.COCA_Genre=document.getElementById('edit-coca').value;
editingItem.Formality=document.getElementById('edit-formality').value;
editingItem.Currency=document.getElementById('edit-currency').value;
editingItem.Medium=document.getElementById('edit-medium').value;
editingItem.Key_Collocation=document.getElementById('edit-collocation').value;
const userExStr=document.getElementById('edit-user-examples').value.trim();
editingItem.userExamples=userExStr?userExStr.split('\n').map(e=>e.trim()).filter(e=>e):[];
const userCollStr=document.getElementById('edit-user-collocs').value.trim();
editingItem.userCollocations=userCollStr?userCollStr.split(',').map(c=>c.trim()).filter(c=>c):[];
const synStr=document.getElementById('edit-synonyms').value.trim();
editingItem.Synonyms=synStr?synStr.split(',').map(s=>s.trim()).filter(s=>s):[];
const antStr=document.getElementById('edit-antonyms').value.trim();
editingItem.Antonyms=antStr?antStr.split(',').map(a=>a.trim()).filter(a=>a):[];
await saveWord(editingItem);
}
// í•™ìŠµ ì¤‘ ìƒíƒœ ì—…ë°ì´íŠ¸
syncEditToStudyState();
closeModal('edit-modal');showToast('âœ… ì €ì¥ ì™„ë£Œ');
updateWordTable();updateHomeStats();
}catch(e){console.error('Save error:',e);showToast('âŒ ì €ì¥ ì‹¤íŒ¨: '+e.message);}
}
function syncEditToStudyState(){
if(!editingItem)return;
const key=editingType==='phrasal'?editingItem.Phrasal_Verb:editingItem.word;
// í”Œë˜ì‹œì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
if(fcState.words?.length){
const idx=fcState.words.findIndex(w=>getW(w)===key);
if(idx>=0)Object.assign(fcState.words[idx],editingItem);
}
// í€´ì¦ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
if(quizState.words?.length){
const idx=quizState.words.findIndex(w=>getW(w)===key);
if(idx>=0)Object.assign(quizState.words[idx],editingItem);
}
// íƒ€ì´í•‘ ìƒíƒœ ì—…ë°ì´íŠ¸
if(typingState.words?.length){
const idx=typingState.words.findIndex(w=>getW(w)===key);
if(idx>=0)Object.assign(typingState.words[idx],editingItem);
}
}
async function resetWordStats(){
if(!editingItem)return;
showConfirm('í•™ìŠµ ê¸°ë¡ ì´ˆê¸°í™”','ì´ ë‹¨ì–´ì˜ í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?',async()=>{
// FSRS í•„ë“œ ì´ˆê¸°í™”
editingItem.stability=null;editingItem.difficulty=null;
editingItem.fsrsState='New';editingItem.reps=0;editingItem.lapses=0;
// í•™ìŠµ í†µê³„ ì´ˆê¸°í™”
editingItem.reviewCount=0;editingItem.correctCount=0;editingItem.mastery=0;
editingItem.consecutiveWrong=0;editingItem.wrongCount=0;
editingItem.nextReview=null;editingItem.lastReview=null;editingItem.lastWrongDate=null;
// ë ˆê±°ì‹œ í•„ë“œ (í˜¸í™˜ì„±)
editingItem.leitnerBox=1;editingItem.interval=1;editingItem.ease=2.5;
if(editingType==='phrasal')await savePV(editingItem);else await saveWord(editingItem);
closeModal('edit-modal');showToast('ğŸ”„ ì´ˆê¸°í™” ì™„ë£Œ');updateWordTable();updateHomeStats();
});
}

// === í•™ìŠµê¸°ë¡ í¬í•¨ ì—‘ì…€ Export ===
async function exportWithStats(){
showToast('ğŸ“Š ì—‘ì…€ ìƒì„± ì¤‘...');
try{
const words=await getAllWords(),pvs=await getAllPV(),exprs=await getAllExpr();
// ì–´íœ˜ ì‹œíŠ¸ ë°ì´í„° (FSRS í•„ë“œ í¬í•¨)
const vocabData=[['word','POS','Meaning1_KO','Meaning1_EN','Meaning2_KO','Meaning2_EN','Synonyms','Antonyms_EN','Antonyms_KO','L0','L1','L2','Formality','Currency','Medium','CEFR','Frequency','Priority','TOEFL_Rel','COCA_Genre','Example1','Example2','Key_Collocation','Common_Error','Style_Tags','tags','starred','needsProduction','reviewCount','correctCount','accuracy','mastery','wrongCount','consecutiveWrong','lastWrongDate','stability','difficulty','interval','nextReview','lastReview','fsrsState','lapses','reps','leitnerBox','ease','userExamples','userCollocations']];
words.forEach(w=>{const acc=getAcc(w);const syn=Array.isArray(w.Synonyms)?w.Synonyms.join(', '):(w.Synonyms||'');const ant=Array.isArray(w.Antonyms)?w.Antonyms.join(', '):(w.Antonyms||'');vocabData.push([w.word,w.POS||'',getMKO(w),getMEN(w),w.Meaning2_KO||'',w.Meaning2_EN||'',syn,w.Antonyms_EN||'',w.Antonyms_KO||ant,w.L0||'',w.L1||'',w.L2||'',w.Formality||'Neutral',w.Currency||'Current',w.Medium||'Both',w.CEFR||'B1',w.Frequency||'K3',w.Priority||'P2',w.TOEFL_Rel||'',w.COCA_Genre||'',w.Example1||'',w.Example2||'',w.Key_Collocation||'',w.Common_Error||'',w.Style_Tags||'',(w.tags||[]).join(','),w.starred?'Y':'',w.needsProduction?'Y':'',w.reviewCount||0,w.correctCount||0,acc!==null?acc:'',w.mastery||0,w.wrongCount||0,w.consecutiveWrong||0,w.lastWrongDate||'',w.stability||'',w.difficulty||'',w.interval||'',w.nextReview||'',w.lastReview||'',w.fsrsState||'',w.lapses||0,w.reps||0,(w.leitnerBox||1),(w.ease||2.5).toFixed(2),(w.userExamples||[]).join(' | '),(w.userCollocations||[]).join(', ')]);});
// êµ¬ë™ì‚¬ ì‹œíŠ¸ ë°ì´í„° (FSRS í•„ë“œ í¬í•¨)
const pvData=[['Phrasal_Verb','Base_Verb','Particle','Meaning1_KO','Meaning1_EN','Example1','Category','Formality','Currency','Medium','CEFR','Frequency','Priority','Formal_Equivalent','Synonyms','Antonyms','Style_Tags','tags','starred','needsProduction','reviewCount','correctCount','accuracy','mastery','wrongCount','consecutiveWrong','lastWrongDate','stability','difficulty','interval','nextReview','lastReview','fsrsState','lapses','reps','leitnerBox','ease']];
pvs.forEach(p=>{const acc=getAcc(p);const syn=Array.isArray(p.Synonyms)?p.Synonyms.join(', '):(p.Synonyms||'');const ant=Array.isArray(p.Antonyms)?p.Antonyms.join(', '):(p.Antonyms||'');pvData.push([p.Phrasal_Verb,p.Base_Verb||'',p.Particle||'',getMKO(p),getMEN(p),getEx(p),p.Category||'',p.Formality||'Neutral',p.Currency||'Current',p.Medium||'Both',p.CEFR||'B1',p.Frequency||'K3',p.Priority||'P2',p.Formal_Equivalent||'',syn,ant,p.Style_Tags||'',(p.tags||[]).join(','),p.starred?'Y':'',p.needsProduction?'Y':'',p.reviewCount||0,p.correctCount||0,acc!==null?acc:'',p.mastery||0,p.wrongCount||0,p.consecutiveWrong||0,p.lastWrongDate||'',p.stability||'',p.difficulty||'',p.interval||'',p.nextReview||'',p.lastReview||'',p.fsrsState||'',p.lapses||0,p.reps||0,(p.leitnerBox||1),(p.ease||2.5).toFixed(2)]);});
// í‘œí˜„ ì‹œíŠ¸ ë°ì´í„° (FSRS í•„ë“œ í¬í•¨)
const exprData=[['Expression','Meaning_KO','Function','Formality','Currency','Medium','CEFR','Frequency','Priority','Example1','Example2','Similar_Expr','Style_Tags','tags','starred','needsProduction','reviewCount','correctCount','accuracy','mastery','wrongCount','consecutiveWrong','lastWrongDate','stability','difficulty','interval','nextReview','lastReview','fsrsState','lapses','reps','leitnerBox','ease']];
exprs.forEach(e=>{const acc=getAcc(e);exprData.push([e.Expression,getMKO(e),e.Function||'',e.Formality||'Neutral',e.Currency||'Current',e.Medium||'Both',e.CEFR||'B1',e.Frequency||'K3',e.Priority||'P2',e.Example1||'',e.Example2||'',e.Similar_Expr||'',e.Style_Tags||'',(e.tags||[]).join(','),e.starred?'Y':'',e.needsProduction?'Y':'',e.reviewCount||0,e.correctCount||0,acc!==null?acc:'',e.mastery||0,e.wrongCount||0,e.consecutiveWrong||0,e.lastWrongDate||'',e.stability||'',e.difficulty||'',e.interval||'',e.nextReview||'',e.lastReview||'',e.fsrsState||'',e.lapses||0,e.reps||0,(e.leitnerBox||1),(e.ease||2.5).toFixed(2)]);});
// ì›Œí¬ë¶ ìƒì„±
const wb=XLSX.utils.book_new();
if(words.length){const ws1=XLSX.utils.aoa_to_sheet(vocabData);XLSX.utils.book_append_sheet(wb,ws1,'Vocabulary');}
if(pvs.length){const ws2=XLSX.utils.aoa_to_sheet(pvData);XLSX.utils.book_append_sheet(wb,ws2,'Phrasal_Verbs');}
if(exprs.length){const ws3=XLSX.utils.aoa_to_sheet(exprData);XLSX.utils.book_append_sheet(wb,ws3,'Expressions');}
// ë‹¤ìš´ë¡œë“œ
XLSX.writeFile(wb,'CEMS_í•™ìŠµê¸°ë¡_'+new Date().toISOString().slice(0,10)+'.xlsx');
showToast('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}catch(e){console.error(e);showToast('âŒ Export ì‹¤íŒ¨: '+e.message);}
}

// === ë¶ë§ˆí¬ í† ê¸€ ===
async function toggleBookmark(){
if(!editingItem)return;
editingItem.starred=!editingItem.starred;
document.getElementById('edit-bookmark-btn').textContent=editingItem.starred?'â­ ë¶ë§ˆí¬ í•´ì œ':'â˜† ë¶ë§ˆí¬';
document.getElementById('edit-bookmark-btn').style.color=editingItem.starred?'var(--warning)':'';
if(editingType==='phrasal')await savePV(editingItem);else await saveWord(editingItem);
showToast(editingItem.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}

// === ë‹¨ì–´ ê³µìœ /ë³µì‚¬ ===
function getWordText(){
if(!editingItem)return'';
const w=editingType==='phrasal'?editingItem.Phrasal_Verb:editingItem.word;
const m=getMKO(editingItem)||'';
const ex=getEx(editingItem)||'';
let text=`ğŸ“š ${w}\nëœ»: ${m}`;
if(ex)text+=`\nì˜ˆë¬¸: ${ex}`;
return text;
}
async function shareWord(){
if(!editingItem)return;
const text=getWordText();
if(navigator.share){
try{await navigator.share({title:getW(editingItem),text:text});showToast('ğŸ“¤ ê³µìœ  ì™„ë£Œ');}
catch(e){if(e.name!=='AbortError')copyWord();}
}else{copyWord();}
}
function copyWord(){
if(!editingItem)return;
const text=getWordText();
navigator.clipboard.writeText(text).then(()=>showToast('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨')).catch(()=>showToast('âŒ ë³µì‚¬ ì‹¤íŒ¨'));
}

// === ë‹¨ì–´ ì‚­ì œ ===
async function deleteWord(){
if(!editingItem)return;
const key=editingType==='phrasal'?editingItem.Phrasal_Verb:editingItem.word;
showConfirm('ë‹¨ì–´ ì‚­ì œ',`"${key}"ë¥¼ ì‚­ì œí• ê¹Œìš”? í•™ìŠµ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`,async()=>{
try{
const store=editingType==='phrasal'?'phrasal_verbs':'words';
const tx=db.transaction(store,'readwrite');
tx.objectStore(store).delete(key);
await new Promise(r=>{tx.oncomplete=r;});
// í•™ìŠµ ì¤‘ ìƒíƒœì—ì„œ ì‚­ì œ
removeFromStudyState(key);
// ë²ˆí˜¸ ì¬ì •ë ¬ (dash2 ì‚­ì œ ì‹œ dash3 â†’ dash2ë¡œ)
await renumberAfterDelete(key, store);
closeModal('edit-modal');showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
updateWordTable();updateHomeStats();
}catch(e){console.error(e);showToast('âŒ ì‚­ì œ ì‹¤íŒ¨');}
});
}
// ì‚­ì œ í›„ ë²ˆí˜¸ ì¬ì •ë ¬
async function renumberAfterDelete(deletedKey, store){
try{
// ë² ì´ìŠ¤ ë‹¨ì–´ ì¶”ì¶œ (dash2 â†’ dash)
const match=deletedKey.match(/^(.+?)(\d+)$/);
if(!match) return; // ìˆ«ì ì—†ìœ¼ë©´ ì¬ì •ë ¬ ë¶ˆí•„ìš”
const baseWord=match[1];

// í•´ë‹¹ ë² ì´ìŠ¤ì˜ ëª¨ë“  ë²„ì „ ì¡°íšŒ
const allItems=store==='words'?await getAllWords():await getAllPV();
const getKey=x=>x.word||x.Phrasal_Verb;
const versions=allItems.filter(x=>{
  const key=getKey(x);
  const m=key.match(/^(.+?)(\d+)$/);
  return m && m[1]===baseWord;
}).sort((a,b)=>{
  const numA=parseInt(getKey(a).match(/(\d+)$/)[1]);
  const numB=parseInt(getKey(b).match(/(\d+)$/)[1]);
  return numA-numB;
});

if(versions.length===0) return;

// ë²ˆí˜¸ ì¬ì •ë ¬
const tx=db.transaction(store,'readwrite');
const os=tx.objectStore(store);

for(let i=0;i<versions.length;i++){
  const item=versions[i];
  const oldKey=getKey(item);
  const newNum=i+1;
  const newKey=versions.length===1?baseWord:baseWord+newNum; // 1ê°œë§Œ ë‚¨ìœ¼ë©´ ìˆ«ì ì œê±°
  
  if(oldKey!==newKey){
    // ì´ë¦„ ë³€ê²½: ì‚­ì œ í›„ ìƒˆ í‚¤ë¡œ ì €ì¥
    os.delete(oldKey);
    if(store==='words') item.word=newKey;
    else item.Phrasal_Verb=newKey;
    os.put(item);
  }
}
await new Promise(r=>{tx.oncomplete=r;});
}catch(e){console.error('renumber error:',e);}
}
function removeFromStudyState(key){
// í”Œë˜ì‹œì¹´ë“œ
if(fcState.words?.length){
const idx=fcState.words.findIndex(w=>getW(w)===key);
if(idx>=0){fcState.words.splice(idx,1);if(fcState.idx>=fcState.words.length)fcState.idx=Math.max(0,fcState.words.length-1);}
}
// í€´ì¦ˆ
if(quizState.words?.length){
const idx=quizState.words.findIndex(w=>getW(w)===key);
if(idx>=0){quizState.words.splice(idx,1);if(quizState.idx>=quizState.words.length)quizState.idx=Math.max(0,quizState.words.length-1);}
}
// íƒ€ì´í•‘
if(typingState.words?.length){
const idx=typingState.words.findIndex(w=>getW(w)===key);
if(idx>=0){typingState.words.splice(idx,1);if(typingState.idx>=typingState.words.length)typingState.idx=Math.max(0,typingState.words.length-1);}
}
}

// === ì¼ì¼ ëª©í‘œ ì—…ë°ì´íŠ¸ ===
async function updateDailyGoal(){
const today=new Date().toDateString();
const sessions=await getSessions();
const todaySessions=sessions.filter(s=>new Date(s.date).toDateString()===today);
// íƒ€ì…ë³„ ì§‘ê³„
const vocabTotal=todaySessions.filter(s=>s.type==='vocab').reduce((sum,s)=>sum+(s.total||0),0);
const pvTotal=todaySessions.filter(s=>s.type==='phrasal').reduce((sum,s)=>sum+(s.total||0),0);
const exprTotal=todaySessions.filter(s=>s.type==='expr').reduce((sum,s)=>sum+(s.total||0),0);
// ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸°
const vocabGoalSetting=parseInt(localStorage.getItem('vocabGoal')||'20');
const pvGoalSetting=parseInt(localStorage.getItem('pvGoal')||'10');
const exprGoalSetting=parseInt(localStorage.getItem('exprGoal')||'10');
// â˜… ì˜¤ëŠ˜ ì¶”ê°€ëœ ìƒˆ ë‹¨ì–´ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
const allW=await getAllWords(),allP=await getAllPV(),allE=await getAllExpr();
const todayAddedVocab=allW.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today&&(!x.reviewCount||x.reviewCount===0)).length;
const todayAddedPV=allP.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today&&(!x.reviewCount||x.reviewCount===0)).length;
const todayAddedExpr=allE.filter(x=>x.addedDate&&new Date(x.addedDate).toDateString()===today&&(!x.reviewCount||x.reviewCount===0)).length;
// â˜… ëª©í‘œ = max(ì„¤ì •ê°’, ì˜¤ëŠ˜ ì¶”ê°€ëœ ìƒˆ ë‹¨ì–´ ìˆ˜)
const vocabGoal=Math.max(vocabGoalSetting, todayAddedVocab);
const pvGoal=Math.max(pvGoalSetting, todayAddedPV);
const exprGoal=Math.max(exprGoalSetting, todayAddedExpr);
// í¼ì„¼íŠ¸ ê³„ì‚°
const vocabPct=Math.min(100,Math.round((vocabTotal/vocabGoal)*100));
const pvPct=Math.min(100,Math.round((pvTotal/pvGoal)*100));
const exprPct=Math.min(100,Math.round((exprTotal/exprGoal)*100));
// ì–´íœ˜ ëª©í‘œ UI
document.getElementById('daily-vocab-done').textContent=vocabTotal;
document.getElementById('daily-vocab-target').textContent=vocabGoal;
document.getElementById('daily-vocab-progress').style.width=vocabPct+'%';
// êµ¬ë™ì‚¬ ëª©í‘œ UI
document.getElementById('daily-pv-done').textContent=pvTotal;
document.getElementById('daily-pv-target').textContent=pvGoal;
document.getElementById('daily-pv-progress').style.width=pvPct+'%';
// í‘œí˜„ ëª©í‘œ UI
document.getElementById('daily-expr-done').textContent=exprTotal;
document.getElementById('daily-expr-target').textContent=exprGoal;
document.getElementById('daily-expr-progress').style.width=exprPct+'%';
// ì „ì²´ ëª©í‘œ (ê° íƒ€ì… ëª©í‘œê¹Œì§€ë§Œ ì¹´ìš´íŠ¸)
const vocabCapped=Math.min(vocabTotal,vocabGoal);
const pvCapped=Math.min(pvTotal,pvGoal);
const exprCapped=Math.min(exprTotal,exprGoal);
const totalDone=vocabCapped+pvCapped+exprCapped;
const totalGoal=vocabGoal+pvGoal+exprGoal;
const totalPct=Math.min(100,Math.round((totalDone/totalGoal)*100));
document.getElementById('daily-done').textContent=totalDone;
document.getElementById('daily-target').textContent=totalGoal;
document.getElementById('daily-total-progress').style.width=totalPct+'%';
document.getElementById('daily-percent').textContent=totalPct+'%';
document.getElementById('daily-percent').style.color='#f97316';
// ëª©í‘œ ë‹¬ì„± ì¶•í•˜ ë©”ì‹œì§€
const wasComplete=localStorage.getItem('dailyGoalComplete')===today;
if(totalPct>=100&&!wasComplete){
  localStorage.setItem('dailyGoalComplete',today);
  setTimeout(()=>showToast('ğŸ‰ ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œ ë‹¬ì„±! ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!'),500);
}
}

// === í•™ìŠµ ì¤‘ ë¶ë§ˆí¬ í† ê¸€ ===
async function toggleFCBookmark(){
const item=fcState.words[fcState.idx];if(!item)return;
item.starred=!item.starred;
if(fcState.type==='phrasal')await savePV(item);else await saveWord(item);
updateFCBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updateFCBookmarkBtn(){
const item=fcState.words?.[fcState.idx];
const btn=document.getElementById('fc-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â­':'â˜†';btn.style.color=item.starred?'var(--warning)':'';}
}
async function toggleFCProduction(){
const item=fcState.words[fcState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
if(fcState.type==='phrasal')await savePV(item);else await saveWord(item);
updateFCProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì— ì¶”ê°€':'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ');
}
function updateFCProductionBtn(){
const item=fcState.words?.[fcState.idx];
const btn=document.getElementById('fc-production-btn');
if(btn&&item){
btn.textContent=item.needsProduction?'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ':'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”';
btn.style.background=item.needsProduction?'rgba(34,197,94,.2)':'';
btn.style.color=item.needsProduction?'var(--success)':'';
}
}
// === íƒœê·¸ ê´€ë¦¬ ===
let tagContext={item:null,type:'vocab',mode:'fc'};
function openFCTagMenu(){
const item=fcState.words[fcState.idx];if(!item)return;
tagContext={item,type:fcState.type,mode:'fc'};
openTagModal(item,fcState.type);
}
function openQuizTagMenu(){
const item=quizState.words[quizState.idx];if(!item)return;
tagContext={item,type:quizState.type,mode:'quiz'};
openTagModal(item,quizState.type);
}
function openTagModal(item,type){
const word=type==='phrasal'?item.Phrasal_Verb:type==='expr'?item.Expression:displayWord(item.word);
document.getElementById('tag-word-display').innerHTML=word;
renderCurrentTags(item);
renderPresetTags(item);
document.getElementById('new-tag-input').value='';
showModal('tag-modal');
}
function renderCurrentTags(item){
const tags=item.tags||[];
const container=document.getElementById('current-tags');
if(tags.length===0){container.innerHTML='<span style="color:var(--muted);font-size:12px">íƒœê·¸ ì—†ìŒ</span>';return;}
container.innerHTML=tags.map(t=>`<span class="chip active" style="padding:6px 10px;cursor:pointer" onclick="removeTag('${t.replace(/'/g,"\\'")}')">${t} âœ•</span>`).join('');
}
function renderPresetTags(item){
const tags=item.tags||[];
const container=document.getElementById('preset-tags');
container.innerHTML=PRESET_TAGS.filter(t=>!tags.includes(t)).map(t=>`<span class="chip" style="padding:6px 10px;cursor:pointer" onclick="addTag('${t}')">${t}</span>`).join('');
if(container.innerHTML==='')container.innerHTML='<span style="color:var(--muted);font-size:12px">ëª¨ë“  í”„ë¦¬ì…‹ íƒœê·¸ê°€ ì ìš©ë¨</span>';
}
async function addTag(tag){
const item=tagContext.item;if(!item||!tag)return;
if(!item.tags)item.tags=[];
if(item.tags.includes(tag))return;
item.tags.push(tag);
if(tagContext.type==='phrasal')await savePV(item);
else if(tagContext.type==='expr')await saveExpr(item);
else await saveWord(item);
renderCurrentTags(item);
renderPresetTags(item);
if(tagContext.type==='expr'){
if(tagContext.mode==='quiz')updateExprQuizTagBtn();else updateExprFCTagBtn();
}else{
if(tagContext.mode==='quiz')updateQuizTagBtn();else updateFCTagBtn();
}
showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ ì¶”ê°€');
}
async function removeTag(tag){
const item=tagContext.item;if(!item||!item.tags)return;
const idx=item.tags.indexOf(tag);
if(idx>=0)item.tags.splice(idx,1);
if(tagContext.type==='phrasal')await savePV(item);
else if(tagContext.type==='expr')await saveExpr(item);
else await saveWord(item);
renderCurrentTags(item);
renderPresetTags(item);
if(tagContext.type==='expr'){
if(tagContext.mode==='quiz')updateExprQuizTagBtn();else updateExprFCTagBtn();
}else{
if(tagContext.mode==='quiz')updateQuizTagBtn();else updateFCTagBtn();
}
showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ ì œê±°');
}
async function addCustomTag(){
const input=document.getElementById('new-tag-input');
const tag=input.value.trim();
if(!tag){showToast('íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
await addTag(tag);
input.value='';
}
function updateFCTagBtn(){
const item=fcState.words?.[fcState.idx];
const btn=document.getElementById('fc-tag-btn');
if(btn&&item){
const count=(item.tags||[]).length;
btn.textContent=count>0?`ğŸ·ï¸ íƒœê·¸ (${count})`:'ğŸ·ï¸ íƒœê·¸';
btn.style.color=count>0?'var(--primary)':'';
}
}
function updateQuizTagBtn(){
const item=quizState.words?.[quizState.idx];
const btn=document.getElementById('quiz-tag-btn');
if(btn&&item){
const count=(item.tags||[]).length;
btn.textContent=count>0?`ğŸ·ï¸ (${count})`:'ğŸ·ï¸ íƒœê·¸';
btn.style.color=count>0?'var(--primary)':'';
}
}
// í‘œí˜„ íƒœê·¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤
function openExprFCTagMenu(){
const item=exprState.words[exprState.idx];if(!item)return;
tagContext={item,type:'expr',mode:'fc'};
openTagModal(item,'expr');
}
function openExprQuizTagMenu(){
const item=exprState.words[exprState.idx];if(!item)return;
tagContext={item,type:'expr',mode:'quiz'};
openTagModal(item,'expr');
}
function updateExprFCTagBtn(){
const item=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-fc-tag-btn');
if(btn&&item){
const count=(item.tags||[]).length;
btn.textContent=count>0?`ğŸ·ï¸ íƒœê·¸ (${count})`:'ğŸ·ï¸ íƒœê·¸';
btn.style.color=count>0?'var(--primary)':'';
}
}
async function toggleExprFCProduction(){
const item=exprState.words[exprState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
await saveExpr(item);
updateExprFCProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ ëª©ë¡ì— ì¶”ê°€':'âœ… ì“°ê¸° ì—°ìŠµ ëª©ë¡ì—ì„œ ì œê±°');
}
function updateExprFCProductionBtn(){
const item=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-fc-production-btn');
if(btn&&item){
btn.textContent=item.needsProduction?'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ ì¤‘':'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”';
btn.style.color=item.needsProduction?'var(--warning)':'';
}
}
function updateExprQuizTagBtn(){
const item=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-quiz-tag-btn');
if(btn&&item){
const count=(item.tags||[]).length;
btn.textContent=count>0?`ğŸ·ï¸ (${count})`:'ğŸ·ï¸ íƒœê·¸';
btn.style.color=count>0?'var(--primary)':'';
}
}
async function toggleExprQuizProduction(){
const item=exprState.words[exprState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
await saveExpr(item);
updateExprQuizProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ ëª©ë¡ì— ì¶”ê°€':'âœ… ì“°ê¸° ì—°ìŠµ ëª©ë¡ì—ì„œ ì œê±°');
}
function updateExprQuizProductionBtn(){
const item=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-quiz-production-btn');
if(btn&&item){
btn.textContent=item.needsProduction?'ğŸ–Šï¸ ì—°ìŠµì¤‘':'ğŸ–Šï¸ ì“°ê¸°';
btn.style.color=item.needsProduction?'var(--warning)':'';
}
}
async function openFCEdit(){
const item=fcState.words[fcState.idx];if(!item)return;
const key=fcState.type==='phrasal'?item.Phrasal_Verb:item.word;
await openEditModal(key,fcState.type);
}
async function toggleQuizBookmark(){
const item=quizState.words[quizState.idx];if(!item)return;
item.starred=!item.starred;
await saveWord(item);
updateQuizBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updateQuizBookmarkBtn(){
const item=quizState.words?.[quizState.idx];
const btn=document.getElementById('quiz-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';btn.style.color=item.starred?'var(--warning)':'';}
}
async function toggleQuizProduction(){
const item=quizState.words[quizState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
await saveWord(item);
updateQuizProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì— ì¶”ê°€':'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ');
}
function updateQuizProductionBtn(){
const item=quizState.words?.[quizState.idx];
const btn=document.getElementById('quiz-production-btn');
if(btn&&item){
btn.textContent=item.needsProduction?'âœ… í•´ì œ':'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ';
btn.style.background=item.needsProduction?'rgba(34,197,94,.2)':'';
btn.style.color=item.needsProduction?'var(--success)':'';
}
}
async function openQuizEdit(){
const item=quizState.words[quizState.idx];if(!item)return;
await openEditModal(item.word,'vocab');
}
async function toggleTypingBookmark(){
const item=typingState.words[typingState.idx];if(!item)return;
item.starred=!item.starred;
await saveWord(item);
updateTypingBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updateTypingBookmarkBtn(){
const item=typingState.words?.[typingState.idx];
const btn=document.getElementById('typing-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â­ ë¶ë§ˆí¬ í•´ì œ':'â˜† ë¶ë§ˆí¬';btn.style.color=item.starred?'var(--warning)':'';}
}
async function openTypingEdit(){
const item=typingState.words[typingState.idx];if(!item)return;
await openEditModal(item.word,'vocab');
}
async function togglePVPBookmark(){
const item=pvState.words[pvState.idx];if(!item)return;
item.starred=!item.starred;
await savePV(item);
updatePVPBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updatePVPBookmarkBtn(){
const item=pvState.words?.[pvState.idx];
const btn=document.getElementById('pvp-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â˜…':'â˜†';}
}
function speakPVP(){
const item=pvState.words?.[pvState.idx];
if(item)speakText(item.Phrasal_Verb);
}
async function togglePVPProduction(){
const item=pvState.words[pvState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
await savePV(item);
updatePVPProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”':'âœ… ì“°ê¸° ì—°ìŠµ í•´ì œ');
}
function updatePVPProductionBtn(){
const item=pvState.words?.[pvState.idx];
const btn=document.getElementById('pvp-production-btn');
if(btn&&item){btn.textContent=item.needsProduction?'âœ…ğŸ–Šï¸':'ğŸ–Šï¸';btn.style.background=item.needsProduction?'var(--success)':'';}
}
function openPVPTagMenu(){showToast('ğŸ·ï¸ íƒœê·¸ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘');}
async function openPVPEdit(){
const item=pvState.words[pvState.idx];if(!item)return;
await openEditModal(item.Phrasal_Verb,'phrasal');
}
async function togglePVQBookmark(){
const item=pvState.words[pvState.idx];if(!item)return;
item.starred=!item.starred;
await savePV(item);
updatePVQBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updatePVQBookmarkBtn(){
const item=pvState.words?.[pvState.idx];
const btn=document.getElementById('pvq-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â˜…':'â˜†';}
}
function speakPVQ(){
const item=pvState.words?.[pvState.idx];
if(item)speakText(item.Phrasal_Verb);
}
async function togglePVQProduction(){
const item=pvState.words[pvState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
await savePV(item);
updatePVQProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”':'âœ… ì“°ê¸° ì—°ìŠµ í•´ì œ');
}
function updatePVQProductionBtn(){
const item=pvState.words?.[pvState.idx];
const btn=document.getElementById('pvq-production-btn');
if(btn&&item){btn.textContent=item.needsProduction?'âœ…ğŸ–Šï¸':'ğŸ–Šï¸';btn.style.background=item.needsProduction?'var(--success)':'';}
}
function openPVQTagMenu(){showToast('ğŸ·ï¸ íƒœê·¸ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘');}
async function openPVQEdit(){
const item=pvState.words[pvState.idx];if(!item)return;
await openEditModal(item.Phrasal_Verb,'phrasal');
}
function saveSetting(k,v){localStorage.setItem(k,v);if(k.includes('Goal'))updateDailyGoal();if(k==='defaultCount')updateStudyCountSliders(parseInt(v));}
// í•™ìŠµë¶„ëŸ‰ ìŠ¬ë¼ì´ë” max ë° value ì—…ë°ì´íŠ¸
function updateStudyCountSliders(maxCount){
const sliders=[
{id:'study-count',valId:'study-count-val'},
{id:'pv-study-count',valId:'pv-study-count-val'},
{id:'expr-study-count',valId:'expr-study-count-val'}
];
sliders.forEach(s=>{
const el=document.getElementById(s.id);
const valEl=document.getElementById(s.valId);
if(el&&valEl){
el.setAttribute('max',maxCount);
const currentVal=parseInt(el.value)||maxCount;
// í˜„ì¬ ê°’ì´ maxë³´ë‹¤ í¬ë©´ maxë¡œ ì¡°ì •
const newVal=Math.min(currentVal,maxCount);
el.value=newVal;
valEl.textContent=newVal;
}
});
}
function adjustGoal(type,delta){
const map={vocab:'setting-vocab-goal',pv:'setting-pv-goal',expr:'setting-expr-goal',count:'setting-count'};
const keyMap={vocab:'vocabGoal',pv:'pvGoal',expr:'exprGoal',count:'defaultCount'};
const el=document.getElementById(map[type]);if(!el)return;
const min=type==='count'?5:1;
let val=Math.max(min,Math.min(100,parseInt(el.value||min)+delta));
el.value=val;
saveSetting(keyMap[type],val);
}
function toggleTheme(){
const dark=document.getElementById('setting-dark').checked;
const bgColor=dark?'#0f172a':'#f8fafc';
document.documentElement.style.setProperty('--bg',bgColor);
document.documentElement.style.setProperty('--bg2',dark?'#1e293b':'#fff');
document.documentElement.style.setProperty('--card',dark?'#1e293b':'#fff');
document.documentElement.style.setProperty('--text',dark?'#f1f5f9':'#1e293b');
document.documentElement.style.setProperty('--muted',dark?'#94a3b8':'#64748b');
document.documentElement.style.setProperty('--border',dark?'#334155':'#e2e8f0');
// ë…¸ì¹˜ ìƒ‰ìƒë„ ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ
document.querySelector('meta[name="theme-color"]')?.setAttribute('content',bgColor);
localStorage.setItem('theme',dark?'dark':'light');
}
// iOS Safari IndexedDB ë°ì´í„° ì†ì‹¤ ë°©ì§€
async function requestPersistentStorage(){
if(navigator.storage&&navigator.storage.persist){
try{
const isPersisted=await navigator.storage.persisted();
if(!isPersisted){
const granted=await navigator.storage.persist();
console.log('Persistent storage:',granted?'granted':'denied');
}
}catch(e){console.log('Storage persist not supported');}
}
}

async function init(){
// iOS Safari ë°ì´í„° ë³´í˜¸ ìš”ì²­
await requestPersistentStorage();
const theme=localStorage.getItem('theme')||'dark';
// ì €ì¥ëœ í…Œë§ˆì— ë”°ë¼ ì¦‰ì‹œ theme-color ì„¤ì • (ìŠ¤í”Œë˜ì‹œì™€ ë…¸ì¹˜ ì—°ì†ì„±)
const initBgColor=theme==='dark'?'#0f172a':'#f8fafc';
document.querySelector('meta[name="theme-color"]')?.setAttribute('content',initBgColor);
if(theme==='light'){
document.documentElement.style.setProperty('--bg','#f8fafc');
document.documentElement.style.setProperty('--bg2','#fff');
document.documentElement.style.setProperty('--card','#fff');
document.documentElement.style.setProperty('--text','#1e293b');
document.documentElement.style.setProperty('--muted','#64748b');
document.documentElement.style.setProperty('--border','#e2e8f0');
}
document.getElementById('setting-dark').checked=theme==='dark';
// TTS ì„¤ì • ë¡œë“œ
const tts=localStorage.getItem('tts');
document.getElementById('setting-tts').checked=tts==='true';
// ì§„ë™ ì„¤ì • ë¡œë“œ (ê¸°ë³¸ê°’ true)
const vib=localStorage.getItem('vibrate');
document.getElementById('setting-vibrate').checked=vib!=='false';
// í•™ìŠµ ì„¤ì • ë¡œë“œ
const dc=localStorage.getItem('defaultCount')||'20';
document.getElementById('setting-count').value=dc;
// ìŠ¬ë¼ì´ë” maxì™€ value ì„¤ì •
updateStudyCountSliders(parseInt(dc));
const vg=localStorage.getItem('vocabGoal');if(vg)document.getElementById('setting-vocab-goal').value=vg;
const pg=localStorage.getItem('pvGoal');if(pg)document.getElementById('setting-pv-goal').value=pg;
const eg=localStorage.getItem('exprGoal');if(eg)document.getElementById('setting-expr-goal').value=eg;
// ì˜¤ë‹µ ìë™ í¬í•¨ ì„¤ì • ë¡œë“œ
const wa=localStorage.getItem('wrongAuto');
document.getElementById('setting-wrong-auto').checked=wa!=='false';
const wl=localStorage.getItem('wrongLimit')||'5';
document.getElementById('setting-wrong-limit').value=wl;
document.getElementById('wrong-limit-val').textContent=wl;
// â˜… FSRS ì„¤ì • ë¡œë“œ
const fuzz=localStorage.getItem('intervalFuzz');
FSRS.intervalFuzz=fuzz!=='false';
document.getElementById('setting-fuzz').checked=FSRS.intervalFuzz;
const dnl=localStorage.getItem('dailyNewLimit')||'9999';
FSRS.dailyNewLimit=parseInt(dnl);
document.getElementById('setting-daily-new').value=dnl;
const drl=localStorage.getItem('dailyReviewLimit')||'9999';
FSRS.dailyReviewLimit=parseInt(drl);
document.getElementById('setting-daily-review').value=drl;
const nds=localStorage.getItem('nextDayStartsAt')||'4';
FSRS.nextDayStartsAt=parseInt(nds);
document.getElementById('setting-next-day').value=nds;
const lt=localStorage.getItem('leechThreshold')||'8';
FSRS.leechThreshold=parseInt(lt);
document.getElementById('setting-leech').value=lt;
const mi=localStorage.getItem('maxInterval')||'365';
FSRS.maxInterval=parseInt(mi);
document.getElementById('setting-max-interval').value=mi;
const rr=localStorage.getItem('requestRetention')||'90';
FSRS.requestRetention=parseInt(rr)/100;
document.getElementById('setting-retention').value=rr;
try{await openDB();await updateHomeStats();}catch(e){console.error('Init error:',e);showToast('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜: '+e.message);}
// ë¡œë”© ì™„ë£Œ í›„ í•˜ë‹¨ ë„¤ë¹„ ë° ì•± í‘œì‹œ
setTimeout(()=>{
  document.getElementById('splash').classList.add('hidden');
  document.querySelector('.bottom-nav')?.classList.add('visible');
},800);
}

// ========== ì˜¤ëŠ˜ í•™ìŠµ & ë¶™ì—¬ë„£ê¸° ==========
const TODAY_STUDY_DAYS = 3; // ì˜¤ëŠ˜ í•™ìŠµ ìœ ì§€ ê¸°ê°„ (ì¼)
let pasteType = 'vocab';

// â˜… ëª¨ë‹¬ íƒ­ ì „í™˜
function switchAddTab(tab){
  document.getElementById('add-tab-paste').classList.toggle('active',tab==='paste');
  document.getElementById('add-tab-excel').classList.toggle('active',tab==='excel');
  document.getElementById('add-content-paste').style.display=tab==='paste'?'block':'none';
  document.getElementById('add-content-excel').style.display=tab==='excel'?'block':'none';
}

// â˜… ëª¨ë‹¬ ì—‘ì…€ ì—…ë¡œë“œ ì²˜ë¦¬
let modalExcelData={vocab:[],phrasal:[],expr:[]};
async function processModalExcel(file){
  if(!file)return;
  try{
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data);
    modalExcelData={vocab:[],phrasal:[],expr:[]};
    let vS=null,pS=null,eS=null;
    // ì‹œíŠ¸ ê°ì§€
    wb.SheetNames.forEach(s=>{
      const ln=s.toLowerCase();
      if(ln.includes('vocab')||ln.includes('word')||ln==='sheet1')vS=s;
      else if(ln.includes('phrasal')||ln.includes('pv'))pS=s;
      else if(ln.includes('expr')||ln.includes('í‘œí˜„'))eS=s;
    });
    let info=[];
    // ì–´íœ˜ íŒŒì‹±
    if(vS){
      const json=XLSX.utils.sheet_to_json(wb.Sheets[vS],{header:1});
      let hr=0;for(let i=0;i<Math.min(10,json.length);i++){if(json[i]&&json[i].some(c=>c&&String(c).toLowerCase()==='word')){hr=i;break;}}
      const headers=(json[hr]||[]).map(h=>String(h||'').toLowerCase().replace(/[^a-z0-9]/g,''));
      const wIdx=headers.indexOf('word');
      const mIdx=headers.findIndex(h=>h.includes('meaning')&&h.includes('ko'));
      if(wIdx>=0&&mIdx>=0){
        for(let i=hr+1;i<json.length;i++){
          const row=json[i];if(!row||!row[wIdx])continue;
          modalExcelData.vocab.push({word:String(row[wIdx]),Meaning1_KO:String(row[mIdx]||''),_row:row,_headers:headers});
        }
        info.push(`ğŸ“– ì–´íœ˜: ${modalExcelData.vocab.length}ê°œ`);
      }
    }
    // êµ¬ë™ì‚¬ íŒŒì‹±
    if(pS){
      const json=XLSX.utils.sheet_to_json(wb.Sheets[pS],{header:1});
      let hr=0;for(let i=0;i<Math.min(10,json.length);i++){if(json[i]&&json[i].some(c=>c&&String(c).toLowerCase().replace(/[^a-z]/g,'')==='phrasalverb')){hr=i;break;}}
      const headers=(json[hr]||[]).map(h=>String(h||'').toLowerCase().replace(/[^a-z0-9]/g,''));
      const pvIdx=headers.findIndex(h=>h.includes('phrasal'));
      const mIdx=headers.findIndex(h=>h.includes('meaning')&&h.includes('ko'));
      if(pvIdx>=0&&mIdx>=0){
        for(let i=hr+1;i<json.length;i++){
          const row=json[i];if(!row||!row[pvIdx])continue;
          modalExcelData.phrasal.push({Phrasal_Verb:String(row[pvIdx]),Meaning1_KO:String(row[mIdx]||''),_row:row,_headers:headers});
        }
        info.push(`ğŸ”— êµ¬ë™ì‚¬: ${modalExcelData.phrasal.length}ê°œ`);
      }
    }
    // í‘œí˜„ íŒŒì‹±
    if(eS){
      const json=XLSX.utils.sheet_to_json(wb.Sheets[eS],{header:1});
      let hr=0;for(let i=0;i<Math.min(10,json.length);i++){if(json[i]&&json[i].some(c=>c&&String(c).toLowerCase()==='expression')){hr=i;break;}}
      const headers=(json[hr]||[]).map(h=>String(h||'').toLowerCase().replace(/[^a-z0-9]/g,''));
      const exIdx=headers.indexOf('expression');
      const mIdx=headers.findIndex(h=>h.includes('meaning')&&h.includes('ko'));
      if(exIdx>=0&&mIdx>=0){
        for(let i=hr+1;i<json.length;i++){
          const row=json[i];if(!row||!row[exIdx])continue;
          modalExcelData.expr.push({Expression:String(row[exIdx]),Meaning_KO:String(row[mIdx]||''),_row:row,_headers:headers});
        }
        info.push(`ğŸ’¬ í‘œí˜„: ${modalExcelData.expr.length}ê°œ`);
      }
    }
    if(info.length===0){
      document.getElementById('modal-upload-info').innerHTML='âš ï¸ ì¸ì‹ëœ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤<br><small>ì‹œíŠ¸ëª…ì— Vocabulary, Phrasal, Expression í¬í•¨ í•„ìš”</small>';
      document.getElementById('modal-upload-result').style.display='block';
      document.getElementById('modal-upload-actions').style.display='none';
      return;
    }
    document.getElementById('modal-upload-info').innerHTML=info.join('<br>');
    document.getElementById('modal-upload-result').style.display='block';
    document.getElementById('modal-upload-actions').style.display='block';
  }catch(e){
    console.error('Excel parse error:',e);
    showToast('âš ï¸ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜');
  }
}

async function confirmModalExcel(){
  let added=0;
  const today=new Date().toISOString();
  // í—¬í¼: rowì—ì„œ ì»¬ëŸ¼ ê°’ ê°€ì ¸ì˜¤ê¸°
  const getCol=(row,headers,name)=>{
    const norm=name.toLowerCase().replace(/[^a-z0-9]/g,'');
    const idx=headers.indexOf(norm);
    if(idx===-1){
      // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
      const partialIdx=headers.findIndex(h=>h.includes(norm)||norm.includes(h));
      if(partialIdx>=0&&row[partialIdx]!=null)return String(row[partialIdx]);
      return '';
    }
    return row[idx]!=null?String(row[idx]):'';
  };
  const getColMulti=(row,headers,...names)=>{
    for(const n of names){const v=getCol(row,headers,n);if(v)return v;}
    return '';
  };
  // ì–´íœ˜ ì¶”ê°€
  for(const item of modalExcelData.vocab){
    const existing=await getWord(item.word);
    if(!existing){
      const r=item._row||[];
      const h=item._headers||[];
      await saveWord({
        word:item.word,
        POS:getCol(r,h,'POS'),
        Meaning1_KO:item.Meaning1_KO||getColMulti(r,h,'Meaning1_KO','MeaningKO'),
        Meaning1_EN:getColMulti(r,h,'Meaning1_EN','MeaningEN','Meaning_EN'),
        Meaning2_KO:getCol(r,h,'Meaning2_KO'),
        Meaning2_EN:getCol(r,h,'Meaning2_EN'),
        Example1:getColMulti(r,h,'Example1','Example'),
        Example2:getCol(r,h,'Example2'),
        Key_Collocation:getCol(r,h,'Key_Collocation'),
        Synonyms:getColMulti(r,h,'Synonyms','Synonyms_EN'),
        Antonyms:getColMulti(r,h,'Antonyms','Antonyms_EN'),
        L0:getCol(r,h,'L0')||'Academic',
        L1:getCol(r,h,'L1')||'General',
        L2:getCol(r,h,'L2'),
        CEFR:getCol(r,h,'CEFR')||'B1',
        Priority:getCol(r,h,'Priority')||'P2',
        Frequency:getCol(r,h,'Frequency')||'K3',
        Formality:getColMulti(r,h,'Formality','Register')||'Neutral',
        Currency:getCol(r,h,'Currency')||'Current',
        Medium:getCol(r,h,'Medium')||'Both',
        TOEFL_Rel:getCol(r,h,'TOEFL_Rel'),
        COCA_Genre:getCol(r,h,'COCA_Genre'),
        tags:[],addedDate:today,reviewCount:0
      });
      added++;
    }
  }
  // êµ¬ë™ì‚¬ ì¶”ê°€
  for(const item of modalExcelData.phrasal){
    const existing=await getPV(item.Phrasal_Verb);
    if(!existing){
      const r=item._row||[];
      const h=item._headers||[];
      await savePV({
        Phrasal_Verb:item.Phrasal_Verb,
        Base_Verb:getColMulti(r,h,'Base_Verb','BaseVerb'),
        Particle:getCol(r,h,'Particle'),
        Meaning1_KO:item.Meaning1_KO||getColMulti(r,h,'Meaning1_KO','MeaningKO'),
        Meaning1_EN:getColMulti(r,h,'Meaning1_EN','MeaningEN'),
        Example1:getColMulti(r,h,'Example1','Example'),
        Category:getCol(r,h,'Category')||'General',
        CEFR:getCol(r,h,'CEFR')||'B1',
        Priority:getCol(r,h,'Priority')||'P2',
        Formality:getColMulti(r,h,'Formality','Register')||'Neutral',
        Currency:getCol(r,h,'Currency')||'Current',
        Medium:getCol(r,h,'Medium')||'Both',
        Formal_Equivalent:getCol(r,h,'Formal_Equivalent'),
        Synonyms:getCol(r,h,'Synonyms'),
        Antonyms:getCol(r,h,'Antonyms'),
        tags:[],addedDate:today,reviewCount:0
      });
      added++;
    }
  }
  // í‘œí˜„ ì¶”ê°€
  for(const item of modalExcelData.expr){
    const existing=await getExpr(item.Expression);
    if(!existing){
      const r=item._row||[];
      const h=item._headers||[];
      await saveExpr({
        Expression:item.Expression,
        Meaning_KO:item.Meaning_KO||getColMulti(r,h,'Meaning_KO','MeaningKO'),
        Meaning_EN:getColMulti(r,h,'Meaning_EN','MeaningEN'),
        Example:getColMulti(r,h,'Example','Example1'),
        Context:getCol(r,h,'Context'),
        Category:getCol(r,h,'Category')||'General',
        CEFR:getCol(r,h,'CEFR')||'B1',
        Priority:getCol(r,h,'Priority')||'P2',
        Formality:getColMulti(r,h,'Formality','Register')||'Neutral',
        Currency:getCol(r,h,'Currency')||'Current',
        Medium:getCol(r,h,'Medium')||'Both',
        tags:[],addedDate:today,reviewCount:0
      });
      added++;
    }
  }
  showToast(`âœ… ìƒˆ ë‹¨ì–´ ${added}ê°œ ì¶”ê°€ë¨`);
  closeModal('paste-modal');
  updateHomeStats();
}

function openPasteModal(type){
  type=type||'vocab';
  // íƒ­ ì´ˆê¸°í™” (ë¶™ì—¬ë„£ê¸°ë¡œ)
  switchAddTab('paste');
  // ë¶™ì—¬ë„£ê¸° ì´ˆê¸°í™”
  document.getElementById('paste-data').value='';
  document.getElementById('paste-preview').style.display='none';
  pasteType=type;
  document.querySelectorAll('#paste-type-group .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector(`#paste-type-group .chip[data-value="${type}"]`)?.classList.add('active');
  // ì—‘ì…€ ì—…ë¡œë“œ ì´ˆê¸°í™”
  document.getElementById('modal-file-input').value='';
  document.getElementById('modal-upload-result').style.display='none';
  document.getElementById('modal-upload-actions').style.display='none';
  modalExcelData={vocab:[],phrasal:[],expr:[]};
  showModal('paste-modal');
}

function selectPasteType(type){
  pasteType=type;
  document.querySelectorAll('#paste-type-group .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector(`#paste-type-group .chip[data-value="${type}"]`).classList.add('active');
}

function parsePasteData(text, type){
  let lines=text.trim().split('\n').filter(l=>l.trim());
  if(lines.length<2){return {error:'ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (í—¤ë”+ìµœì†Œ 1í–‰ í•„ìš”)'};}
  
  // ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” í˜•ì‹ ê°ì§€ (íŒŒì´í”„ | êµ¬ë¶„)
  const isMarkdown = lines[0].includes('|');
  let delimiter = '\t';
  
  if(isMarkdown){
    delimiter = '|';
    // êµ¬ë¶„ì„  (| --- | --- |) ì œê±°
    lines = lines.filter(l => !l.match(/^\|?\s*[-:]+\s*\|/));
  }
  
  // íŒŒì‹± í•¨ìˆ˜
  const parseLine = (line) => {
    if(isMarkdown){
      // ë§ˆí¬ë‹¤ìš´: ì•ë’¤ íŒŒì´í”„ ì œê±° í›„ split
      return line.replace(/^\||\|$/g, '').split('|').map(c => c.trim());
    } else {
      return line.split('\t').map(c => c.trim());
    }
  };
  
  const headers = parseLine(lines[0]);
  const normalize=h=>(h||'').toLowerCase().replace(/[\s_\-]/g,'');
  const colMap={};
  headers.forEach((h,i)=>colMap[normalize(h)]=i);
  
  // í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
  const keyCol=type==='vocab'?'word':type==='phrasal'?'phrasalverb':'expression';
  const keyIdx=colMap[keyCol]??colMap['word']??colMap['phrasalverb']??colMap['expression'];
  if(keyIdx===undefined){return {error:`í•„ìˆ˜ ì»¬ëŸ¼(${keyCol})ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`};}
  
  const meaningIdx=colMap['meaning1ko']??colMap['meaningko']??colMap['meaning'];
  if(meaningIdx===undefined){return {error:'ëœ» ì»¬ëŸ¼(Meaning1_KO)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'};}
  
  const gC=(cols,name)=>{const idx=colMap[normalize(name)];return idx!==undefined&&cols[idx]!=null?cols[idx].toString().trim():'';};
  
  const items=[];
  const now=new Date().toISOString();
  
  for(let i=1;i<lines.length;i++){
    const cols=parseLine(lines[i]);
    const key=cols[keyIdx]?.trim();
    if(!key)continue;
    
    const base={
      addedDate:now,
      todayStudy:true,
      reviewCount:0,
      correctCount:0,
      mastery:0,
      fsrsState:'New',
      stability:null,
      difficulty:null,
      starred:false,
      tags:[]
    };
    
    if(type==='vocab'){
      items.push({...base,
        word:key,
        POS:gC(cols,'POS'),
        Meaning1_KO:gC(cols,'Meaning1_KO')||gC(cols,'MeaningKO'),
        Meaning1_EN:gC(cols,'Meaning1_EN')||gC(cols,'MeaningEN'),
        Meaning2_KO:gC(cols,'Meaning2_KO'),
        Meaning2_EN:gC(cols,'Meaning2_EN'),
        Synonyms:gC(cols,'Synonyms'),
        Antonyms_EN:gC(cols,'Antonyms_EN'),
        Antonyms_KO:gC(cols,'Antonyms_KO'),
        L1:gC(cols,'L1')||'General',
        L2:gC(cols,'L2'),
        Formality:gC(cols,'Formality')||'Neutral',
        Currency:gC(cols,'Currency')||'Current',
        Medium:gC(cols,'Medium')||'Both',
        Style_Tags:gC(cols,'Style_Tags'),
        CEFR:gC(cols,'CEFR')||'B1',
        Frequency:gC(cols,'Frequency')||'K3',
        Priority:gC(cols,'Priority')||'P2',
        TOEFL_Rel:gC(cols,'TOEFL_Rel'),
        COCA_Genre:gC(cols,'COCA_Genre'),
        Example1:gC(cols,'Example1'),
        Example2:gC(cols,'Example2'),
        Key_Collocation:gC(cols,'Key_Collocation'),
        Common_Error:gC(cols,'Common_Error')
      });
    }else if(type==='phrasal'){
      items.push({...base,
        Phrasal_Verb:key,
        Base_Verb:gC(cols,'Base_Verb'),
        Particle:gC(cols,'Particle'),
        Meaning1_KO:gC(cols,'Meaning1_KO')||gC(cols,'MeaningKO'),
        Meaning1_EN:gC(cols,'Meaning1_EN'),
        Example1:gC(cols,'Example1'),
        Category:gC(cols,'Category')||'General',
        Formality:gC(cols,'Formality')||'Neutral',
        Currency:gC(cols,'Currency')||'Current',
        Medium:gC(cols,'Medium')||'Both',
        Style_Tags:gC(cols,'Style_Tags'),
        CEFR:gC(cols,'CEFR')||'B1',
        Frequency:gC(cols,'Frequency')||'K3',
        Priority:gC(cols,'Priority')||'P2',
        Formal_Equivalent:gC(cols,'Formal_Equivalent')
      });
    }else{
      items.push({...base,
        Expression:key,
        Meaning_KO:gC(cols,'Meaning_KO')||gC(cols,'MeaningKO'),
        Function:gC(cols,'Function'),
        Formality:gC(cols,'Formality')||'Neutral',
        Currency:gC(cols,'Currency')||'Current',
        Medium:gC(cols,'Medium')||'Both',
        Style_Tags:gC(cols,'Style_Tags'),
        CEFR:gC(cols,'CEFR')||'B1',
        Frequency:gC(cols,'Frequency')||'K3',
        Priority:gC(cols,'Priority')||'P2',
        Example1:gC(cols,'Example1'),
        Example2:gC(cols,'Example2'),
        Similar_Expr:gC(cols,'Similar_Expr')
      });
    }
  }
  
  return {items, headers, type};
}

function previewPaste(){
  const text=document.getElementById('paste-data').value;
  if(!text.trim()){showToast('âš ï¸ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”');return;}
  
  const result=parsePasteData(text, pasteType);
  if(result.error){showToast('âŒ '+result.error);return;}
  
  const preview=document.getElementById('paste-preview');
  const info=document.getElementById('paste-preview-info');
  const sample=document.getElementById('paste-preview-sample');
  
  const typeLabel=pasteType==='vocab'?'ì–´íœ˜':pasteType==='phrasal'?'êµ¬ë™ì‚¬':'í‘œí˜„';
  info.innerHTML=`<span style="color:var(--success)">âœ… ${result.items.length}ê°œ ${typeLabel} ì¸ì‹</span><br>ì»¬ëŸ¼: ${result.headers.slice(0,5).join(', ')}${result.headers.length>5?'...':''}`;
  
  // ìƒ˜í”Œ 3ê°œ í‘œì‹œ
  const getKey=item=>item.word||item.Phrasal_Verb||item.Expression;
  const getMeaning=item=>item.Meaning1_KO||item.Meaning_KO;
  sample.innerHTML=result.items.slice(0,3).map(item=>
    `<div style="padding:4px 0;border-bottom:1px solid var(--border)"><strong>${getKey(item)}</strong> - ${getMeaning(item)}</div>`
  ).join('')+(result.items.length>3?`<div style="padding:4px 0;color:var(--muted)">... ì™¸ ${result.items.length-3}ê°œ</div>`:'');
  
  preview.style.display='block';
}

async function confirmPaste(){
  const text=document.getElementById('paste-data').value;
  if(!text.trim()){showToast('âš ï¸ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”');return;}
  
  const result=parsePasteData(text, pasteType);
  if(result.error){showToast('âŒ '+result.error);return;}
  if(!result.items.length){showToast('âš ï¸ ì¶”ê°€í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');return;}
  
  try{
    // ì „ì²´ ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
    let allItems=[];
    if(pasteType==='vocab') allItems=await getAllWords();
    else if(pasteType==='phrasal') allItems=await getAllPV();
    else allItems=await getAllExpr();
    
    const getKey=x=>x.word||x.Phrasal_Verb||x.Expression;
    const existingKeys=new Set(allItems.map(getKey));
    
    // ë² ì´ìŠ¤ ë‹¨ì–´ë³„ ìµœëŒ€ ë²ˆí˜¸ ê³„ì‚°
    const getBaseAndNum=(key)=>{
      const match=key.match(/^(.+?)(\d+)$/);
      if(match) return {base:match[1], num:parseInt(match[2])};
      return {base:key, num:0};
    };
    
    const maxNums={};
    allItems.forEach(item=>{
      const key=getKey(item);
      const {base,num}=getBaseAndNum(key);
      maxNums[base]=Math.max(maxNums[base]||0, num);
    });
    
    const store=pasteType==='vocab'?'words':pasteType==='phrasal'?'phrasal_verbs':'expressions';
    let newCount=0, dupCount=0;
    const itemsToSave=[];
    const renamedExisting=[]; // ê¸°ì¡´ í•­ëª© ì¤‘ ì´ë¦„ ë³€ê²½í•  ê²ƒë“¤
    
    for(const item of result.items){
      let key=getKey(item);
      const {base}=getBaseAndNum(key);
      
      if(existingKeys.has(key)){
        // ì¤‘ë³µ! ê¸°ì¡´ ë‹¨ì–´ì— ìˆ«ìê°€ ì—†ìœ¼ë©´ 1 ë¶™ì´ê¸°
        const existingItem=allItems.find(x=>getKey(x)===key);
        if(existingItem && !/\d+$/.test(key)){
          // ê¸°ì¡´ í•­ëª© ì´ë¦„ ë³€ê²½: dash â†’ dash1
          const oldKey=key;
          const newKey=key+'1';
          if(pasteType==='vocab') existingItem.word=newKey;
          else if(pasteType==='phrasal') existingItem.Phrasal_Verb=newKey;
          else existingItem.Expression=newKey;
          renamedExisting.push({oldKey, item:existingItem});
          existingKeys.delete(oldKey);
          existingKeys.add(newKey);
          maxNums[base]=1;
        }
        
        // ìƒˆ í•­ëª©ì€ ë‹¤ìŒ ë²ˆí˜¸
        const nextNum=(maxNums[base]||0)+1;
        const newKey=base+nextNum;
        if(pasteType==='vocab') item.word=newKey;
        else if(pasteType==='phrasal') item.Phrasal_Verb=newKey;
        else item.Expression=newKey;
        maxNums[base]=nextNum;
        existingKeys.add(newKey);
        dupCount++;
      }else if(maxNums[base]>0){
        // â˜… ê°™ì€ baseë¡œ ë²ˆí˜¸ ë¶™ì€ ë‹¨ì–´ê°€ ì´ë¯¸ ìˆìœ¼ë©´ â†’ ë²ˆí˜¸ ë¶€ì—¬
        const nextNum=maxNums[base]+1;
        const newKey=base+nextNum;
        if(pasteType==='vocab') item.word=newKey;
        else if(pasteType==='phrasal') item.Phrasal_Verb=newKey;
        else item.Expression=newKey;
        maxNums[base]=nextNum;
        existingKeys.add(newKey);
        dupCount++;
      }else{
        newCount++;
      }
      existingKeys.add(getKey(item));
      itemsToSave.push(item);
    }
    
    // DB ì €ì¥
    const tx=db.transaction(store,'readwrite');
    const os=tx.objectStore(store);
    
    // ê¸°ì¡´ í•­ëª© ì´ë¦„ ë³€ê²½ (ì‚­ì œ í›„ ìƒˆ í‚¤ë¡œ ì €ì¥)
    for(const {oldKey, item} of renamedExisting){
      os.delete(oldKey);
      os.put(item);
    }
    
    // ìƒˆ í•­ëª© ì €ì¥
    for(const item of itemsToSave){
      os.put(item);
    }
    
    await new Promise(r=>{tx.oncomplete=r;});
    
    const typeLabel=pasteType==='vocab'?'ì–´íœ˜':pasteType==='phrasal'?'êµ¬ë™ì‚¬':'í‘œí˜„';
    let msg=`âœ… ${typeLabel} ${result.items.length}ê°œ ì¶”ê°€`;
    if(dupCount>0) msg+=` (ì¤‘ë³µ ${dupCount}ê°œ â†’ ë²ˆí˜¸ ë¶€ì—¬)`;
    showToast(msg);
    closeModal('paste-modal');
    updateHomeStats();
    updateDataPage();
  }catch(e){
    console.error(e);
    showToast('âŒ ì €ì¥ ì‹¤íŒ¨: '+e.message);
  }
}

// updateTodayStudyStats, startTodayStudy í•¨ìˆ˜ ì œê±°ë¨ (ì˜¤ëŠ˜ í•™ìŠµ ì¹´ë“œ ê°„ì†Œí™”)

init();
</script>
</body>
</html>
