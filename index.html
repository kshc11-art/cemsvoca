<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="expires" content="0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<meta name="description" content="TOEFL & ì¼ìƒíšŒí™” ì–´íœ˜ í•™ìŠµ - FSRS ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ ë³µìŠµ">
<title>CEMS Vocab Pro v7.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
:root{--primary:#6366f1;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--bg:#0f172a;--bg2:#1e293b;--card:#1e293b;--text:#f1f5f9;--muted:#94a3b8;--border:#334155;--phrasal:#ec4899;--expr:#14b8a6}
html{background:var(--bg);height:-webkit-fill-available}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:-webkit-fill-available}
.app{max-width:600px;margin:0 auto;padding:16px;padding-top:calc(16px + env(safe-area-inset-top));padding-left:calc(16px + env(safe-area-inset-left));padding-right:calc(16px + env(safe-area-inset-right));padding-bottom:calc(80px + env(safe-area-inset-bottom))}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:6px 0;padding-bottom:calc(6px + env(safe-area-inset-bottom));z-index:100}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;color:var(--muted);font-size:9px;cursor:pointer;text-decoration:none}
.nav-item.active{color:var(--primary)}
.nav-item svg{width:20px;height:20px;pointer-events:none}
.page{display:none}.page.active{display:block}
.page-header{margin-bottom:20px}.page-header h1{font-size:26px;font-weight:700;margin-bottom:4px}.page-header p{color:var(--muted);font-size:13px}
.card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:12px;border:1px solid var(--border)}
.card-title{font-size:13px;font-weight:600;color:var(--muted);margin-bottom:12px}
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;border:none;cursor:pointer;width:100%}
.btn:active{transform:scale(.98)}.btn-primary{background:var(--primary);color:#fff}.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}.btn-phrasal{background:var(--phrasal);color:#fff}.btn-sm{padding:8px 14px;font-size:12px}
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.stat-grid-2{grid-template-columns:repeat(2,1fr)}.stat-grid-3{grid-template-columns:repeat(3,1fr)}
.stat-item{text-align:center;padding:10px 6px;background:var(--bg);border-radius:10px;cursor:pointer}.stat-item:active{transform:scale(.95)}.stat-value{font-size:22px;font-weight:700;margin-bottom:2px}.stat-value.success{color:var(--success)}.stat-value.warning{color:var(--warning)}.stat-value.danger{color:var(--danger)}.stat-value.phrasal{color:var(--phrasal)}.stat-label{font-size:10px;color:var(--muted)}
.progress-bar{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:6px}.progress-fill{height:100%;background:var(--primary);border-radius:3px;transition:width .3s}.progress-fill.phrasal{background:var(--phrasal)}.progress-text{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
.badge{display:inline-block;padding:3px 8px;font-size:10px;font-weight:600;border-radius:20px}.badge-warning{background:rgba(245,158,11,.2);color:#fbbf24}.badge-danger{background:rgba(239,68,68,.2);color:#f87171}.badge-phrasal{background:rgba(236,72,153,.2);color:#f472b6}
.type-tabs{display:flex;gap:8px;margin-bottom:14px}.type-tab{flex:1;padding:10px;background:var(--bg);border:2px solid var(--border);border-radius:10px;text-align:center;cursor:pointer;font-size:13px;font-weight:600}.type-tab.active{border-color:var(--primary);background:rgba(99,102,241,.1);color:var(--primary)}.type-tab.phrasal.active{border-color:var(--phrasal);background:rgba(236,72,153,.1);color:var(--phrasal)}.type-tab.expr.active{border-color:var(--expr);background:rgba(20,184,166,.1);color:var(--expr)}
.mode-selector{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:8px}.mode-card{padding:12px 8px;background:var(--bg);border-radius:12px;text-align:center;cursor:pointer;border:2px solid transparent}.mode-card.active{border-color:var(--primary);background:rgba(99,102,241,.1)}.mode-card.phrasal.active{border-color:var(--phrasal);background:rgba(236,72,153,.1)}.mode-card.expr.active{border-color:var(--expr);background:rgba(20,184,166,.1)}.mode-card-icon{font-size:24px;margin-bottom:4px}.mode-card-title{font-size:13px;font-weight:600;margin-bottom:2px}.mode-card-desc{font-size:11px;color:var(--muted)}
.range-container{display:flex;align-items:center;gap:16px}.range-slider{flex:1;-webkit-appearance:none;height:6px;background:var(--border);border-radius:3px}.range-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;background:var(--primary);border-radius:50%}.range-value{font-size:18px;font-weight:700;min-width:60px;text-align:right}
.chip-group{display:flex;flex-wrap:wrap;gap:8px}.chip{padding:8px 14px;background:var(--bg);border-radius:20px;font-size:13px;cursor:pointer;border:1px solid var(--border)}.chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.form-group{margin-bottom:16px}.form-label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}.form-select{width:100%;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px}
.toggle-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0}.toggle-label{font-size:14px}.toggle-switch{position:relative;width:50px;height:28px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:28px;transition:.3s}.toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}.toggle-switch input:checked+.toggle-slider{background:var(--primary)}.toggle-switch input:checked+.toggle-slider:before{transform:translateX(22px)}
.upload-zone{display:block;border:2px dashed var(--border);border-radius:16px;padding:40px 20px;text-align:center;cursor:pointer}.upload-zone.dragover{border-color:var(--primary);background:rgba(99,102,241,.05)}.upload-zone-icon{font-size:48px;margin-bottom:16px}.upload-zone p{color:var(--muted);font-size:14px}
.search-box{position:relative;margin-bottom:16px}.search-box input{width:100%;padding:12px 16px 12px 44px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px}.search-box svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);width:18px;height:18px;color:var(--muted)}
.quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.quick-action{display:flex;flex-direction:column;align-items:center;padding:16px 8px;background:var(--bg);border-radius:14px;cursor:pointer;position:relative}.quick-action:active{transform:scale(.95)}.quick-action-icon{font-size:28px;margin-bottom:8px}.quick-action-label{font-size:11px;color:var(--muted)}.quick-action-badge{position:absolute;top:8px;right:8px;background:var(--danger);color:#fff;font-size:9px;padding:2px 6px;border-radius:10px}
.streak-banner{background:linear-gradient(135deg,#f59e0b,#ef4444);border-radius:14px;padding:16px;margin-bottom:16px;display:flex;align-items:center;gap:12px}.streak-banner.hidden{display:none}.streak-icon{font-size:36px}.streak-days{font-size:24px;font-weight:700}
/* í”Œë˜ì‹œì¹´ë“œ - í•µì‹¬ ìˆ˜ì • */
.flashcard-container{perspective:1000px;margin-bottom:20px;min-height:300px}
.flashcard{position:relative;width:100%;height:300px;cursor:pointer;transform-style:preserve-3d;transition:transform .6s}
.flashcard.flipped{transform:rotateY(180deg)}
.flashcard.swipe-left{transform:translateX(-150%) rotate(-20deg);opacity:0;transition:all .4s}
.flashcard.swipe-right{transform:translateX(150%) rotate(20deg);opacity:0;transition:all .4s}
.flashcard-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;-webkit-backface-visibility:hidden;background:var(--card);border-radius:20px;padding:24px;display:flex;flex-direction:column;border:1px solid var(--border);box-shadow:0 20px 40px -12px rgba(0,0,0,.3)}
.flashcard-back{transform:rotateY(180deg)}
/* í•µì‹¬: ë’·ë©´ ë‚´ìš© ìˆ¨ê¹€ */
.flashcard-back-inner{opacity:0;transition:opacity .15s;display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%}.flashcard-back-inner.visible{opacity:1}
.flashcard-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}.tag{font-size:10px;padding:4px 8px;border-radius:10px;font-weight:500}.tag-pos{background:rgba(99,102,241,.2);color:#a5b4fc}.tag-level{background:rgba(16,185,129,.2);color:#6ee7b7}.tag-cat{background:rgba(245,158,11,.2);color:#fcd34d}.tag-phrasal{background:rgba(236,72,153,.2);color:#f472b6}
.flashcard-word{font-size:36px;font-weight:700;text-align:center;margin:auto 0}.flashcard-hint{text-align:center;font-size:13px;color:var(--muted);margin-top:auto}.flashcard-meaning-ko{font-size:26px;font-weight:600;text-align:center;margin-bottom:8px}.flashcard-meaning-en{font-size:14px;text-align:center;color:var(--muted);margin-bottom:16px}.flashcard-example{background:rgba(99,102,241,.1);padding:12px;border-radius:10px;border-left:3px solid var(--primary);font-size:13px;line-height:1.5;margin-bottom:12px}.flashcard-collocation{font-size:13px;color:var(--muted);text-align:center}
.similar-expr-box{background:rgba(20,184,166,.08);border:1px solid rgba(20,184,166,.2);border-radius:10px;padding:10px 12px;margin:10px 0;font-size:12px}.similar-expr-box .similar-title{color:var(--expr);font-weight:600;margin-bottom:6px;font-size:11px}.similar-expr-box .similar-item{color:var(--muted);padding:2px 0}
.swipe-indicator{position:fixed;top:50%;transform:translateY(-50%);font-size:48px;opacity:0;transition:opacity .2s;z-index:50;pointer-events:none}.swipe-indicator.left{left:20px}.swipe-indicator.right{right:20px}.swipe-indicator.show{opacity:1}
.rating-section{margin-bottom:16px}.rating-section.disabled{opacity:.5;pointer-events:none}.rating-hint{text-align:center;font-size:13px;color:var(--muted);margin-bottom:12px}.rating-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.rating-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px 8px;border-radius:12px;font-size:13px;font-weight:600;border:none;cursor:pointer;min-height:70px}.rating-btn:disabled{opacity:.5}.rating-btn.again{background:#fecaca;color:#b91c1c}.rating-btn.hard{background:#fed7aa;color:#c2410c}.rating-btn.good{background:#bbf7d0;color:#15803d}.rating-btn.easy{background:#bfdbfe;color:#1d4ed8}.rating-interval{font-size:10px;opacity:.7;margin-top:4px}
.quiz-options{display:flex;flex-direction:column;gap:10px}.quiz-option{width:100%;padding:16px 20px;background:var(--card);border:2px solid var(--border);border-radius:14px;font-size:15px;color:var(--text);text-align:left;cursor:pointer}.quiz-option:disabled{cursor:default}.quiz-option.correct{background:rgba(16,185,129,.2);border-color:var(--success);color:var(--success)}.quiz-option.wrong{background:rgba(239,68,68,.2);border-color:var(--danger);color:var(--danger)}
.retry-banner{background:linear-gradient(135deg,var(--warning),var(--danger));border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;color:#fff}.retry-banner.hidden{display:none}.retry-banner-icon{font-size:24px}.retry-banner-text{flex:1;font-size:14px}.retry-banner-count{font-size:20px;font-weight:700}
.word-table{width:100%;border-collapse:collapse;font-size:13px}.word-table th,.word-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}.word-table th{font-weight:600;color:var(--muted);font-size:11px}.word-table tr:hover{background:var(--bg)}
.table-container{max-height:400px;overflow-y:auto;border-radius:12px;border:1px solid var(--border)}
.leitner-container{display:flex;gap:8px}.leitner-box{flex:1;text-align:center;padding:12px 8px;background:var(--bg);border-radius:10px;border:2px solid var(--border)}.leitner-box.box-1{border-color:#ef4444}.leitner-box.box-2{border-color:#f59e0b}.leitner-box.box-3{border-color:#eab308}.leitner-box.box-4{border-color:#22c55e}.leitner-box.box-5{border-color:#10b981}.leitner-count{font-size:20px;font-weight:700}.leitner-label{font-size:10px;color:var(--muted)}
.chart-container{display:flex;align-items:flex-end;justify-content:space-around;height:150px;padding-top:20px}.chart-bar-wrapper{display:flex;flex-direction:column;align-items:center;gap:4px}.chart-bar{width:28px;background:var(--primary);border-radius:4px 4px 0 0;min-height:4px}.chart-bar.phrasal{background:var(--phrasal)}.chart-bar-label{font-size:10px;color:var(--muted)}.chart-bar-value{font-size:11px;font-weight:600}
.upload-result{margin-top:16px;padding:16px;background:var(--bg);border-radius:12px}.upload-result-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}.upload-result-item:last-child{border-bottom:none}
.blank-word{display:inline-block;min-width:80px;border-bottom:2px dashed var(--primary);margin:0 4px;color:var(--primary);font-weight:600}
.form-input{width:100%;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:18px;text-align:center;font-family:inherit;resize:none}.form-input:focus{border-color:var(--primary);outline:none}.form-input.correct{border-color:var(--success)}.form-input.wrong{border-color:var(--danger)}
.typing-answer{font-size:20px;font-weight:600;margin-top:16px;padding:16px;background:var(--bg);border-radius:12px;text-align:center}.typing-answer.correct{color:var(--success)}.typing-answer.wrong{color:var(--danger)}
.weak-word-item{display:flex;align-items:center;padding:12px;background:var(--bg);border-radius:10px;margin-bottom:8px}.weak-word-text{flex:1}.weak-word-text strong{font-size:15px}.weak-word-text span{font-size:12px;color:var(--muted);display:block;margin-top:2px}.weak-word-stats{text-align:right}.weak-word-rate{font-size:14px;font-weight:600}.weak-word-count{font-size:11px;color:var(--muted)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s;padding:20px}.modal-overlay.show{opacity:1;visibility:visible}.modal{background:var(--card);border-radius:20px;padding:24px;max-width:400px;width:100%;transform:scale(.9);transition:transform .3s}.modal-overlay.show .modal{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.modal-header h3{font-size:20px}.modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--bg);color:var(--muted);font-size:18px;cursor:pointer}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card);color:var(--text);padding:14px 24px;border-radius:30px;font-size:14px;font-weight:500;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:2000;opacity:0;transition:all .3s}.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.hidden{display:none!important}
.empty-state{text-align:center;padding:32px 16px}.empty-state-icon{font-size:48px;margin-bottom:16px}.empty-state h3{font-size:18px;margin-bottom:8px}.empty-state p{color:var(--muted);font-size:14px}
#splash{position:fixed;inset:0;background:linear-gradient(135deg,#6366f1,#ec4899,#8b5cf6);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}#splash.hidden{opacity:0;visibility:hidden}.splash-icon{font-size:80px;animation:bounce 1s ease infinite}.splash-title{font-size:32px;font-weight:700;color:#fff;margin-top:20px}.splash-sub{font-size:14px;color:rgba(255,255,255,.8);margin-top:8px}.splash-loader{width:40px;height:40px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin-top:40px}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="splash"><div class="splash-icon">ğŸ“š</div><div class="splash-title">CEMS Vocab Pro</div><div class="splash-sub">v6.5 - Expression Tags</div><div class="splash-loader"></div></div>
<div class="app">
<!-- í™ˆ -->
<div id="page-home" class="page active">
<div class="streak-banner hidden" id="streak-banner"><div class="streak-icon">ğŸ”¥</div><div><div style="font-size:13px;opacity:.9">ì—°ì† í•™ìŠµ</div><div class="streak-days"><span id="streak-days">0</span>ì¼ì§¸</div></div></div>
<div class="card" id="daily-goal-card" style="background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(139,92,246,.1))"><div class="card-title">ğŸ¯ ì˜¤ëŠ˜ì˜ ëª©í‘œ</div>
<div style="display:flex;gap:6px;margin-bottom:12px">
<div style="flex:1;text-align:center;padding:6px;background:var(--bg);border-radius:8px"><div style="font-size:10px;color:var(--muted)">ğŸ“– ì–´íœ˜</div><div style="font-size:14px;font-weight:600"><span id="daily-vocab-done">0</span>/<span id="daily-vocab-target">20</span></div><div class="progress-bar" style="height:3px;margin-top:4px"><div class="progress-fill" id="daily-vocab-progress" style="width:0%"></div></div></div>
<div style="flex:1;text-align:center;padding:6px;background:var(--bg);border-radius:8px"><div style="font-size:10px;color:var(--muted)">ğŸ”— êµ¬ë™ì‚¬</div><div style="font-size:14px;font-weight:600"><span id="daily-pv-done">0</span>/<span id="daily-pv-target">10</span></div><div class="progress-bar" style="height:3px;margin-top:4px"><div class="progress-fill" id="daily-pv-progress" style="width:0%;background:var(--phrasal)"></div></div></div>
<div style="flex:1;text-align:center;padding:6px;background:var(--bg);border-radius:8px"><div style="font-size:10px;color:var(--muted)">ğŸ’¬ í‘œí˜„</div><div style="font-size:14px;font-weight:600"><span id="daily-expr-done">0</span>/<span id="daily-expr-target">10</span></div><div class="progress-bar" style="height:3px;margin-top:4px"><div class="progress-fill" id="daily-expr-progress" style="width:0%;background:var(--expr)"></div></div></div>
</div>
<div class="progress-bar" style="height:12px;margin-bottom:8px"><div class="progress-fill" id="daily-total-progress" style="width:0%;background:linear-gradient(90deg,#f97316,#fb923c,#fbbf24)"></div></div>
<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:13px;color:var(--muted)">ì „ì²´ <span id="daily-done">0</span> / <span id="daily-target">40</span>ê°œ</span><span id="daily-percent" style="font-size:18px;font-weight:700;color:var(--primary)">0%</span></div></div>
<div class="type-tabs"><div class="type-tab active" data-type="vocab" onclick="switchHomeType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" data-type="phrasal" onclick="switchHomeType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" data-type="expr" onclick="switchHomeType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div id="home-vocab">
<div class="card"><div class="card-title">âš¡ ë¹ ë¥¸ ì‹œì‘</div><div class="quick-actions"><div class="quick-action" onclick="startQuickStudy('vocab')"><div class="quick-action-icon">ğŸƒ</div><div class="quick-action-label">í”Œë˜ì‹œì¹´ë“œ</div></div><div class="quick-action" onclick="startQuickQuiz('vocab')"><div class="quick-action-icon">â“</div><div class="quick-action-label">5ì§€ì„ ë‹¤</div></div><div class="quick-action" onclick="startProductionStudy('vocab')"><div class="quick-action-icon">ğŸ–Šï¸</div><div class="quick-action-label">ì‚°ì¶œ ì—°ìŠµ</div><span class="quick-action-badge hidden" id="prod-badge-vocab">0</span></div><div class="quick-action" onclick="startWrongReview('vocab')"><div class="quick-action-icon">ğŸ“</div><div class="quick-action-label">ì˜¤ë‹µë…¸íŠ¸</div><span class="quick-action-badge hidden" id="wrong-badge-vocab">0</span></div></div></div>
<div class="card"><div class="card-title">ğŸ” ê²€ìƒ‰ & ğŸ·ï¸ íƒœê·¸ í•™ìŠµ</div>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><button class="btn btn-secondary" onclick="startStarredStudy('vocab')" style="width:auto;min-width:60px;height:44px;flex:0 0 auto;padding:0 12px;font-size:14px;border-radius:12px" title="â­ ë¶ë§ˆí¬ í•™ìŠµ">â­ <span id="star-badge-vocab">0</span></button><select class="form-select" id="home-tag-select" onchange="startTagStudy('vocab')" style="flex:1;height:44px;font-size:14px"><option value="">ğŸ·ï¸ íƒœê·¸ ì„ íƒ...</option></select></div>
<div style="display:flex;gap:8px;align-items:center"><input type="text" id="quick-search-input" placeholder="ë‹¨ì–´ ê²€ìƒ‰..." style="flex:1 1 auto;min-width:0;height:48px;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:0 14px;font-size:15px;color:var(--text)" onkeyup="if(event.key==='Enter')quickSearch()"><button class="btn btn-primary" onclick="quickSearch()" style="width:48px;height:48px;flex:0 0 auto;padding:0;font-size:18px;border-radius:12px">ğŸ”</button></div>
<div id="quick-search-result" style="display:none;background:var(--bg);border-radius:12px;padding:12px;margin-top:12px;position:relative">
<button onclick="document.getElementById('quick-search-result').style.display='none'" style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:16px;cursor:pointer;color:var(--muted)">âœ•</button>
<div id="quick-search-found" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong id="qs-word" style="font-size:18px"></strong><button class="btn btn-secondary" style="width:auto;padding:6px 10px;font-size:14px" onclick="speakQSWord()">ğŸ”Š</button></div>
<div style="font-size:15px;margin-bottom:6px" id="qs-meaning"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px" id="qs-info"></div>
<div id="qs-example" style="display:none;font-size:13px;color:var(--muted);background:var(--card);padding:8px 10px;border-radius:8px;border-left:3px solid var(--primary);margin-bottom:10px"></div>
<div style="display:flex;gap:6px;flex-wrap:wrap">
<button id="qs-bookmark-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="quickToggleBookmark()">â˜† ë¶ë§ˆí¬</button>
<button id="qs-prod-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="quickToggleProduction()">ğŸ–Šï¸ ì‚°ì¶œ</button>
<button class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="quickEditWord()">âœï¸ ìˆ˜ì •</button>
</div>
<div id="qs-not-this" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"><span style="font-size:12px;color:var(--muted)">ì°¾ëŠ” ë‹¨ì–´ê°€ ì•„ë‹Œê°€ìš”?</span> <button class="btn btn-secondary btn-sm" onclick="showAddNewFromSearch()" style="width:auto;padding:4px 10px;font-size:12px;margin-left:8px">â• "<span id="qs-original-query"></span>" ì¶”ê°€</button></div>
</div>
<div id="quick-search-notfound" style="display:none">
<p style="text-align:center;color:var(--muted);margin-bottom:12px">ğŸ˜• DBì— ì—†ëŠ” ë‹¨ì–´ì…ë‹ˆë‹¤</p>
<div style="margin-bottom:8px"><strong id="qs-new-word" style="font-size:15px"></strong></div>
<input type="text" id="qs-new-meaning" placeholder="ëœ» ì…ë ¥..." style="width:100%;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:14px;color:var(--text);margin-bottom:8px">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px"><label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="qs-add-bookmark" checked> â­ ë¶ë§ˆí¬ì— ì¶”ê°€</label></div>
<div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="quickSaveNewWord()" style="flex:1">ğŸ’¾ ì €ì¥</button><button class="btn btn-secondary btn-sm" onclick="quickAddWord()" style="width:auto;padding:8px 12px">âœï¸ ìƒì„¸</button></div>
</div>
</div></div>
<div class="card"><div class="card-title">ğŸ“Š ì–´íœ˜ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="stat-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="stat-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item" onclick="showWeakWords('vocab')"><div class="stat-value warning" id="stat-weak">0</div><div class="stat-label">ì·¨ì•½</div></div><div class="stat-item" onclick="startReviewDue('vocab')"><div class="stat-value danger" id="stat-due">0</div><div class="stat-label">ë³µìŠµ</div></div></div></div>
</div>
<div id="home-phrasal" class="hidden">
<div class="card"><div class="card-title">âš¡ ë¹ ë¥¸ ì‹œì‘</div><div class="quick-actions"><div class="quick-action" onclick="startQuickStudy('phrasal')"><div class="quick-action-icon">ğŸƒ</div><div class="quick-action-label">í”Œë˜ì‹œì¹´ë“œ</div></div><div class="quick-action" onclick="startQuickQuiz('phrasal')"><div class="quick-action-icon">ğŸ§©</div><div class="quick-action-label">Particle</div></div><div class="quick-action" onclick="startProductionStudy('phrasal')"><div class="quick-action-icon">ğŸ–Šï¸</div><div class="quick-action-label">ì‚°ì¶œ ì—°ìŠµ</div><span class="quick-action-badge hidden" id="prod-badge-pv">0</span></div><div class="quick-action" onclick="startWrongReview('phrasal')"><div class="quick-action-icon">ğŸ“</div><div class="quick-action-label">ì˜¤ë‹µë…¸íŠ¸</div><span class="quick-action-badge hidden" id="wrong-badge-pv">0</span></div></div></div>
<div class="card"><div class="card-title">ğŸ” ê²€ìƒ‰ & ğŸ·ï¸ íƒœê·¸ í•™ìŠµ</div>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><button class="btn btn-secondary" onclick="startStarredStudy('phrasal')" style="width:auto;min-width:60px;height:44px;flex:0 0 auto;padding:0 12px;font-size:14px;border-radius:12px" title="â­ ë¶ë§ˆí¬ í•™ìŠµ">â­ <span id="star-badge-pv">0</span></button><select class="form-select" id="home-pv-tag-select" onchange="startTagStudy('phrasal')" style="flex:1;height:44px;font-size:14px"><option value="">ğŸ·ï¸ íƒœê·¸ ì„ íƒ...</option></select></div>
<div style="display:flex;gap:8px;align-items:center"><input type="text" id="pv-quick-search-input" placeholder="êµ¬ë™ì‚¬ ê²€ìƒ‰..." style="flex:1 1 auto;min-width:0;height:48px;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:0 14px;font-size:15px;color:var(--text)" onkeyup="if(event.key==='Enter')pvQuickSearch()"><button class="btn btn-primary" onclick="pvQuickSearch()" style="width:48px;height:48px;flex:0 0 auto;padding:0;font-size:18px;border-radius:12px">ğŸ”</button></div>
<div id="pv-quick-search-result" style="display:none;background:var(--bg);border-radius:12px;padding:12px;margin-top:12px;position:relative">
<button onclick="document.getElementById('pv-quick-search-result').style.display='none'" style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:16px;cursor:pointer;color:var(--muted)">âœ•</button>
<div id="pv-qs-found" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong id="pv-qs-word" style="font-size:18px"></strong><button class="btn btn-secondary" style="width:auto;padding:6px 10px;font-size:14px" onclick="speakPVQSWord()">ğŸ”Š</button></div>
<div style="font-size:15px;margin-bottom:6px" id="pv-qs-meaning"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px" id="pv-qs-info"></div>
<div id="pv-qs-example" style="display:none;font-size:13px;color:var(--muted);background:var(--card);padding:8px 10px;border-radius:8px;border-left:3px solid var(--phrasal);margin-bottom:10px"></div>
<div style="display:flex;gap:6px;flex-wrap:wrap">
<button id="pv-qs-bookmark-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="pvQSToggleBookmark()">â˜† ë¶ë§ˆí¬</button>
<button id="pv-qs-prod-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="pvQSToggleProduction()">ğŸ–Šï¸ ì‚°ì¶œ</button>
<button class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="pvQSEdit()">âœï¸ ìˆ˜ì •</button>
</div>
<div id="pv-qs-not-this" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"><span style="font-size:12px;color:var(--muted)">ì°¾ëŠ” êµ¬ë™ì‚¬ê°€ ì•„ë‹Œê°€ìš”?</span> <button class="btn btn-secondary btn-sm" onclick="showPVAddNew()" style="width:auto;padding:4px 10px;font-size:12px;margin-left:8px">â• "<span id="pv-qs-original"></span>" ì¶”ê°€</button></div>
</div>
<div id="pv-qs-notfound" style="display:none">
<p style="text-align:center;color:var(--muted);margin-bottom:12px">ğŸ˜• DBì— ì—†ëŠ” êµ¬ë™ì‚¬ì…ë‹ˆë‹¤</p>
<div style="margin-bottom:8px"><strong id="pv-qs-new-word" style="font-size:15px"></strong></div>
<input type="text" id="pv-qs-new-meaning" placeholder="ëœ» ì…ë ¥..." style="width:100%;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:14px;color:var(--text);margin-bottom:8px">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px"><label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="pv-qs-add-bookmark" checked> â­ ë¶ë§ˆí¬ì— ì¶”ê°€</label></div>
<div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="pvQSSaveNew()" style="flex:1">ğŸ’¾ ì €ì¥</button><button class="btn btn-secondary btn-sm" onclick="pvQSAddDetail()" style="width:auto;padding:8px 12px">âœï¸ ìƒì„¸</button></div>
</div>
</div>
</div>
<div class="card"><div class="card-title">ğŸ”— êµ¬ë™ì‚¬ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value phrasal" id="pv-stat-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="pv-stat-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item" onclick="showWeakWords('phrasal')"><div class="stat-value warning" id="pv-stat-weak">0</div><div class="stat-label">ì·¨ì•½</div></div><div class="stat-item" onclick="startReviewDue('phrasal')"><div class="stat-value danger" id="pv-stat-due">0</div><div class="stat-label">ë³µìŠµ</div></div></div></div>
</div>
<div id="home-expr" class="hidden">
<div class="card"><div class="card-title">âš¡ ë¹ ë¥¸ ì‹œì‘</div><div class="quick-actions"><div class="quick-action" onclick="startExprFC()"><div class="quick-action-icon">ğŸƒ</div><div class="quick-action-label">í”Œë˜ì‹œì¹´ë“œ</div></div><div class="quick-action" onclick="startExprQuizQuick()"><div class="quick-action-icon">â“</div><div class="quick-action-label">5ì§€ì„ ë‹¤</div></div><div class="quick-action" onclick="startExprClozeQuick()"><div class="quick-action-icon">ğŸ“</div><div class="quick-action-label">ë¹ˆì¹¸ì±„ìš°ê¸°</div></div><div class="quick-action" onclick="startExprWrong()"><div class="quick-action-icon">ğŸ”„</div><div class="quick-action-label">ì˜¤ë‹µë…¸íŠ¸</div><span class="quick-action-badge hidden" id="wrong-badge-expr">0</span></div></div></div>
<div class="card"><div class="card-title">ğŸ” ê²€ìƒ‰ & ğŸ·ï¸ íƒœê·¸ í•™ìŠµ</div>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><button class="btn btn-secondary" onclick="startExprStarred()" style="width:auto;min-width:60px;height:44px;flex:0 0 auto;padding:0 12px;font-size:14px;border-radius:12px" title="â­ ë¶ë§ˆí¬ í•™ìŠµ">â­ <span id="star-badge-expr">0</span></button><select class="form-select" id="home-expr-tag-select" onchange="startExprTagStudy()" style="flex:1;height:44px;font-size:14px"><option value="">ğŸ·ï¸ íƒœê·¸ ì„ íƒ...</option></select></div>
<div style="display:flex;gap:8px;align-items:center"><input type="text" id="expr-search-input" placeholder="í‘œí˜„ ê²€ìƒ‰..." style="flex:1 1 auto;min-width:0;height:48px;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:0 14px;font-size:15px;color:var(--text)" onkeyup="if(event.key==='Enter')exprSearch()"><button class="btn btn-primary" onclick="exprSearch()" style="width:48px;height:48px;flex:0 0 auto;padding:0;font-size:18px;border-radius:12px">ğŸ”</button></div>
<div id="expr-search-result" style="display:none;background:var(--bg);border-radius:12px;padding:12px;margin-top:12px;position:relative">
<button onclick="document.getElementById('expr-search-result').style.display='none'" style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:16px;cursor:pointer;color:var(--muted)">âœ•</button>
<div id="expr-qs-found" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong id="expr-qs-word" style="font-size:18px"></strong><span id="expr-qs-register" style="font-size:11px;padding:2px 8px;border-radius:10px;background:rgba(20,184,166,.15);color:var(--expr)"></span></div>
<div style="font-size:14px;margin-bottom:4px" id="expr-qs-func"></div>
<div style="font-size:15px;margin-bottom:6px" id="expr-qs-meaning"></div>
<div id="expr-qs-example" style="display:none;font-size:13px;color:var(--muted);background:var(--card);padding:8px 10px;border-radius:8px;border-left:3px solid var(--expr);margin-bottom:10px"></div>
<div id="expr-qs-similar" style="display:none;font-size:12px;color:var(--muted);margin-bottom:8px">ìœ ì‚¬: <span id="expr-qs-similar-list"></span></div>
<div style="display:flex;gap:6px;flex-wrap:wrap">
<button id="expr-qs-bookmark-btn" class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="exprQSToggleBookmark()">â˜† ë¶ë§ˆí¬</button>
<button class="btn btn-secondary btn-sm" style="width:auto;padding:6px 12px" onclick="exprQSEdit()">âœï¸ ìˆ˜ì •</button>
</div>
<div id="expr-qs-not-this" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"><span style="font-size:12px;color:var(--muted)">ì°¾ëŠ” í‘œí˜„ì´ ì•„ë‹Œê°€ìš”?</span> <button class="btn btn-secondary btn-sm" onclick="showExprAddNew()" style="width:auto;padding:4px 10px;font-size:12px;margin-left:8px">â• "<span id="expr-qs-original"></span>" ì¶”ê°€</button></div>
</div>
<div id="expr-qs-notfound" style="display:none">
<p style="text-align:center;color:var(--muted);margin-bottom:12px">ğŸ˜• DBì— ì—†ëŠ” í‘œí˜„ì…ë‹ˆë‹¤</p>
<div style="margin-bottom:8px"><strong id="expr-qs-new-word" style="font-size:15px"></strong></div>
<input type="text" id="expr-qs-new-meaning" placeholder="ëœ»/ê¸°ëŠ¥ ì…ë ¥..." style="width:100%;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:14px;color:var(--text);margin-bottom:8px">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px"><label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="expr-qs-add-bookmark" checked> â­ ë¶ë§ˆí¬ì— ì¶”ê°€</label></div>
<div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="exprQSSaveNew()" style="flex:1">ğŸ’¾ ì €ì¥</button></div>
</div>
</div>
</div>
<div class="card"><div class="card-title">ğŸ’¬ í‘œí˜„ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="expr-stat-total" style="color:var(--expr)">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="expr-stat-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item" onclick="showWeakWords('expr')"><div class="stat-value warning" id="expr-stat-weak">0</div><div class="stat-label">ì·¨ì•½</div></div><div class="stat-item" onclick="startExprDue()"><div class="stat-value danger" id="expr-stat-due">0</div><div class="stat-label">ë³µìŠµ</div></div></div></div>
</div>
<div class="card" id="db-card"><div class="card-title">ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤</div><div id="db-status"><div class="empty-state"><div class="empty-state-icon">ğŸ“¤</div><h3>DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h3><p>CEMS ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´<br>í•™ìŠµì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p></div></div></div>
</div>
<!-- í•™ìŠµ ì„¤ì • -->
<div id="page-study" class="page">
<div class="type-tabs" id="study-type-tabs"><div class="type-tab active" data-type="vocab" onclick="switchStudyType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" data-type="phrasal" onclick="switchStudyType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" data-type="expr" onclick="switchStudyType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div id="study-vocab">
<div class="card"><div class="card-title">ğŸ® í•™ìŠµ ëª¨ë“œ</div><div class="mode-selector"><div class="mode-card active" data-mode="flashcard" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">ğŸƒ</div><div class="mode-card-title">í”Œë˜ì‹œì¹´ë“œ</div><div class="mode-card-desc">ì¹´ë“œ ë’¤ì§‘ê¸°</div></div><div class="mode-card" data-mode="quiz" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">â“</div><div class="mode-card-title">5ì§€ì„ ë‹¤</div><div class="mode-card-desc">ì˜ë¯¸ ë§ì¶”ê¸°</div></div></div><div class="mode-selector"><div class="mode-card" data-mode="reverse" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">ğŸ”„</div><div class="mode-card-title">ì—­ë°©í–¥</div><div class="mode-card-desc">ëœ»â†’ì˜ì–´</div></div><div class="mode-card" data-mode="typing" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">âŒ¨ï¸</div><div class="mode-card-title">íƒ€ì´í•‘</div><div class="mode-card-desc">ìŠ¤í ë§</div></div></div><div class="mode-selector"><div class="mode-card" data-mode="cloze" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">ğŸ“</div><div class="mode-card-title">ë¹ˆì¹¸ì±„ìš°ê¸°</div><div class="mode-card-desc">ë¬¸ì¥ ì™„ì„±</div></div><div class="mode-card" data-mode="collocation" onclick="selectMode(this,'vocab')"><div class="mode-card-icon">ğŸ”—</div><div class="mode-card-title">Collocation</div><div class="mode-card-desc">ì—°ì–´ í•™ìŠµ</div></div></div></div>
<button class="btn btn-primary" onclick="startStudySession()" style="margin-bottom:16px">ğŸ“ í•™ìŠµ ì‹œì‘</button>
<div class="card"><div class="card-title">ğŸ“ í•™ìŠµ ë¶„ëŸ‰</div><div class="range-container"><input type="range" class="range-slider" id="study-count" min="5" max="20" value="20" step="1" oninput="document.getElementById('study-count-val').textContent=this.value"><div class="range-value"><span id="study-count-val">20</span>ê°œ</div></div></div>
<div class="card"><div class="card-title">ğŸ¯ í•„í„°</div><div class="form-group"><label class="form-label">í•™ìŠµ ìƒíƒœ</label><div class="chip-group" id="filter-mastery"><span class="chip active" data-value="all">ì „ì²´</span><span class="chip" data-value="new">ìƒˆ ë‹¨ì–´</span><span class="chip" data-value="weak">ì·¨ì•½</span><span class="chip" data-value="wrong">ì˜¤ë‹µ</span><span class="chip" data-value="starred">â­ë¶ë§ˆí¬</span></div></div><div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬</label><select class="form-select" id="filter-l1"><option value="all">ì „ì²´</option></select></div><div class="form-group"><label class="form-label">ğŸ“ TOEFL ì—°ê´€ì„±</label><select class="form-select" id="filter-toefl"><option value="all">ì „ì²´</option></select></div><div class="form-group"><label class="form-label">ğŸ“Š COCA ì¥ë¥´</label><select class="form-select" id="filter-coca"><option value="all">ì „ì²´</option></select></div><div class="form-group"><label class="form-label">ğŸ·ï¸ íƒœê·¸ í•„í„°</label><select class="form-select" id="filter-tag"><option value="all">ì „ì²´</option></select></div></div>
</div>
<div id="study-phrasal" class="hidden">
<div class="card"><div class="card-title">ğŸ® êµ¬ë™ì‚¬ í•™ìŠµ ëª¨ë“œ</div><div class="mode-selector"><div class="mode-card phrasal active" data-mode="pv-flashcard" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">ğŸƒ</div><div class="mode-card-title">í”Œë˜ì‹œì¹´ë“œ</div><div class="mode-card-desc">ì¹´ë“œ ë’¤ì§‘ê¸°</div></div><div class="mode-card phrasal" data-mode="pv-particle" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">ğŸ§©</div><div class="mode-card-title">Particle</div><div class="mode-card-desc">figure ___?</div></div></div><div class="mode-selector"><div class="mode-card phrasal" data-mode="pv-meaning" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">ğŸ’¡</div><div class="mode-card-title">ì˜ë¯¸ ë§ì¶”ê¸°</div><div class="mode-card-desc">êµ¬ë™ì‚¬â†’ëœ»</div></div><div class="mode-card phrasal" data-mode="pv-reverse" onclick="selectMode(this,'phrasal')"><div class="mode-card-icon">ğŸ”„</div><div class="mode-card-title">ì—­ë°©í–¥</div><div class="mode-card-desc">ëœ»â†’êµ¬ë™ì‚¬</div></div></div></div>
<button class="btn btn-primary phrasal" onclick="startStudySession()" style="margin-bottom:16px">ğŸ“ í•™ìŠµ ì‹œì‘</button>
<div class="card"><div class="card-title">ğŸ“ í•™ìŠµ ë¶„ëŸ‰</div><div class="range-container"><input type="range" class="range-slider" id="pv-study-count" min="5" max="20" value="15" step="1" oninput="document.getElementById('pv-study-count-val').textContent=this.value"><div class="range-value"><span id="pv-study-count-val">15</span>ê°œ</div></div></div>
<div class="card"><div class="card-title">ğŸ¯ í•„í„°</div><div class="form-group"><label class="form-label">í•™ìŠµ ìƒíƒœ</label><div class="chip-group" id="pv-filter-mastery"><span class="chip active" data-value="all">ì „ì²´</span><span class="chip" data-value="new">ìƒˆ ë‹¨ì–´</span><span class="chip" data-value="weak">ì·¨ì•½</span><span class="chip" data-value="wrong">ì˜¤ë‹µ</span><span class="chip" data-value="starred">â­ë¶ë§ˆí¬</span></div></div><div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬</label><select class="form-select" id="pv-filter-cat"><option value="all">ì „ì²´</option></select></div></div>
</div>
<div id="study-expr" class="hidden">
<div class="card"><div class="card-title">ğŸ® í‘œí˜„ í•™ìŠµ ëª¨ë“œ</div><div class="mode-selector"><div class="mode-card expr active" data-mode="expr-fc" onclick="selectMode(this,'expr')"><div class="mode-card-icon">ğŸƒ</div><div class="mode-card-title">í”Œë˜ì‹œì¹´ë“œ</div><div class="mode-card-desc">í‘œí˜„ ì•”ê¸°</div></div><div class="mode-card expr" data-mode="expr-quiz" onclick="selectMode(this,'expr')"><div class="mode-card-icon">â“</div><div class="mode-card-title">5ì§€ì„ ë‹¤</div><div class="mode-card-desc">ëœ» ë§ì¶”ê¸°</div></div><div class="mode-card expr" data-mode="expr-cloze" onclick="selectMode(this,'expr')"><div class="mode-card-icon">ğŸ“</div><div class="mode-card-title">ë¹ˆì¹¸ì±„ìš°ê¸°</div><div class="mode-card-desc">ë¬¸ë§¥ í•™ìŠµ</div></div><div class="mode-card expr" data-mode="expr-typing" onclick="selectMode(this,'expr')"><div class="mode-card-icon">âŒ¨ï¸</div><div class="mode-card-title">ì“°ê¸° ì—°ìŠµ</div><div class="mode-card-desc">í‘œí˜„ íƒ€ì´í•‘</div></div></div></div>
<button class="btn btn-primary" onclick="startExprStudySession()" style="margin-bottom:16px;background:var(--expr)">ğŸ“ í•™ìŠµ ì‹œì‘</button>
<div class="card"><div class="card-title">ğŸ“ í•™ìŠµ ë¶„ëŸ‰</div><div class="range-container"><input type="range" class="range-slider" id="expr-study-count" min="5" max="20" value="20" step="1" oninput="document.getElementById('expr-study-count-val').textContent=this.value"><div class="range-value"><span id="expr-study-count-val">20</span>ê°œ</div></div></div>
<div class="card"><div class="card-title">ğŸ¯ í•„í„°</div><div class="form-group"><label class="form-label">í•™ìŠµ ìƒíƒœ</label><div class="chip-group" id="expr-filter-mastery"><span class="chip active" data-value="all">ì „ì²´</span><span class="chip" data-value="new">ìƒˆ í‘œí˜„</span><span class="chip" data-value="weak">ì·¨ì•½</span><span class="chip" data-value="wrong">ì˜¤ë‹µ</span><span class="chip" data-value="starred">â­ë¶ë§ˆí¬</span></div></div><div class="form-group"><label class="form-label">ê²©ì‹ë„ (Register)</label><select class="form-select" id="expr-filter-register"><option value="all">ì „ì²´</option><option value="Formal">Formal</option><option value="Neutral">Neutral</option><option value="Casual">Casual</option></select></div></div>
</div>
<div class="card"><div class="card-title">ğŸ”€ ìˆœì„œ</div><div class="toggle-row"><span class="toggle-label">í•™ìŠµ ìˆœì„œ</span><select class="form-select" id="option-order" style="width:auto"><option value="random">ëœë¤</option><option value="sm2">SM-2 ìš°ì„ </option><option value="weak">ì·¨ì•½ ìš°ì„ </option></select></div></div>
</div>
<!-- í”Œë˜ì‹œì¹´ë“œ -->
<div id="page-flashcard" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="fc-progress"></div></div><div class="progress-text"><span><span id="fc-current">0</span> / <span id="fc-total">0</span></span><span id="fc-timer">0:00</span></div></div>
<div class="retry-banner hidden" id="fc-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">í‹€ë¦° ë‹¨ì–´ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="fc-retry-count">0</div></div>
<div class="swipe-indicator left" id="swipe-left">âŒ</div><div class="swipe-indicator right" id="swipe-right">âœ…</div>
<div class="flashcard-container" id="fc-container"><div class="flashcard" id="flashcard"><div class="flashcard-face flashcard-front"><div class="flashcard-tags" id="fc-tags"></div><div class="flashcard-word" id="fc-word">ë‹¨ì–´</div><div class="flashcard-hint">ğŸ‘† íƒ­: ë’¤ì§‘ê¸° / ë‹¤ì‹œ íƒ­: ì•ë©´</div></div><div class="flashcard-face flashcard-back"><div class="flashcard-back-inner" id="fc-back-inner"><div class="flashcard-meaning-ko" id="fc-meaning-ko"></div><div class="flashcard-meaning-en" id="fc-meaning-en"></div><div class="flashcard-example" id="fc-example"></div><div class="flashcard-collocation" id="fc-collocation"></div></div></div></div></div>
<div class="rating-section disabled" id="rating-section"><div class="rating-hint" id="rating-hint">ì¹´ë“œë¥¼ ë’¤ì§‘ì€ í›„ í‰ê°€í•˜ì„¸ìš”</div><div class="rating-grid"><button class="rating-btn again" onclick="rateCard(0)" disabled>ğŸ˜« ëª¨ë¦„<span class="rating-interval">ë‹¤ì‹œ</span></button><button class="rating-btn hard" onclick="rateCard(1)" disabled>ğŸ˜• ì–´ë ¤ì›€<span class="rating-interval">1ì¼</span></button><button class="rating-btn good" onclick="rateCard(2)" disabled>ğŸ™‚ ë³´í†µ<span class="rating-interval">3ì¼</span></button><button class="rating-btn easy" onclick="rateCard(3)" disabled>ğŸ˜Š ì‰¬ì›€<span class="rating-interval">7ì¼+</span></button></div></div>
<div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn btn-secondary btn-sm" id="fc-production-btn" onclick="toggleFCProduction()" style="flex:1;font-size:12px">ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”</button><button class="btn btn-secondary btn-sm" id="fc-tag-btn" onclick="openFCTagMenu()" style="flex:1;font-size:12px">ğŸ·ï¸ íƒœê·¸</button></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary btn-sm" id="fc-prev-btn" onclick="prevCard()" style="flex:0 0 50px" title="ì´ì „ ì¹´ë“œ">â†</button><button class="btn btn-secondary btn-sm" onclick="speakWord()" style="flex:0 0 50px">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="fc-bookmark-btn" onclick="toggleFCBookmark()" style="flex:0 0 50px">â˜†</button><button class="btn btn-secondary btn-sm" onclick="openFCEdit()" style="flex:0 0 50px">âœï¸</button><button class="btn btn-secondary btn-sm" onclick="confirmEndFC()" style="flex:1">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- í€´ì¦ˆ -->
<div id="page-quiz" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="quiz-progress"></div></div><div class="progress-text"><span><span id="quiz-current">0</span> / <span id="quiz-total">0</span></span><span>âœ… <span id="quiz-correct">0</span> âŒ <span id="quiz-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="quiz-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="quiz-retry-count">0</div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center"><div class="flashcard-tags" id="quiz-tags" style="justify-content:center"></div><div class="flashcard-word" id="quiz-word" style="font-size:28px">ë‹¨ì–´</div><div id="quiz-sub" style="font-size:14px;color:var(--muted);text-align:center;margin-top:8px"></div><div id="quiz-example" class="hidden" style="background:rgba(99,102,241,.1);padding:12px;border-radius:10px;border-left:3px solid var(--primary);font-size:13px;margin-top:12px"></div></div>
<div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn btn-secondary btn-sm" id="quiz-bookmark-btn" onclick="toggleQuizBookmark()" style="flex:1">â˜† ë¶ë§ˆí¬</button><button class="btn btn-secondary btn-sm" id="quiz-production-btn" onclick="toggleQuizProduction()" style="flex:1">ğŸ–Šï¸ ì“°ê¸°</button><button class="btn btn-secondary btn-sm" id="quiz-tag-btn" onclick="openQuizTagMenu()" style="flex:1">ğŸ·ï¸ íƒœê·¸</button><button class="btn btn-secondary btn-sm" onclick="openQuizEdit()" style="flex:1">âœï¸</button></div>
<div class="quiz-options" id="quiz-options"></div>
<div id="quiz-rating-bar" class="hidden" style="margin-top:12px;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€ <span id="quiz-rating-timer" style="color:var(--primary)"></span></div><div class="rating-grid"><button class="rating-btn again" onclick="rateQuizItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="rateQuizItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="rateQuizItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="rateQuizItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<button class="btn btn-primary hidden" id="quiz-next-btn" onclick="nextQuiz()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndQuiz()">í€´ì¦ˆ ì¢…ë£Œ</button></div>
</div>
<!-- íƒ€ì´í•‘ -->
<div id="page-typing" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="typing-progress"></div></div><div class="progress-text"><span><span id="typing-current">0</span> / <span id="typing-total">0</span></span><span>âœ… <span id="typing-correct">0</span> âŒ <span id="typing-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="typing-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="typing-retry-count">0</div></div>
<div class="card" style="min-height:180px"><div style="text-align:center"><div style="font-size:14px;color:var(--muted);margin-bottom:8px" id="typing-pos"></div><div style="font-size:28px;font-weight:700;margin-bottom:8px" id="typing-meaning">ëœ»</div><div style="font-size:14px;color:var(--muted)" id="typing-en"></div></div><div id="typing-example" class="hidden" style="background:rgba(99,102,241,.1);padding:12px;border-radius:10px;border-left:3px solid var(--primary);font-size:13px;margin-top:12px"></div></div>
<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-secondary btn-sm" id="typing-bookmark-btn" onclick="toggleTypingBookmark()" style="flex:1">â˜† ë¶ë§ˆí¬</button><button class="btn btn-secondary btn-sm" onclick="openTypingEdit()" style="flex:1">âœï¸ ìˆ˜ì •</button></div>
<div class="card"><input type="text" class="form-input" id="typing-input" placeholder="ì˜ì–´ ë‹¨ì–´ ì…ë ¥..." autocomplete="off" autocapitalize="off"><div class="typing-answer hidden" id="typing-answer"></div></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="showTypingHint()" id="typing-hint-btn">ğŸ’¡ íŒíŠ¸</button><button class="btn btn-primary" onclick="checkTyping()" id="typing-submit-btn">í™•ì¸</button></div>
<button class="btn btn-primary hidden" id="typing-next-btn" onclick="nextTyping()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndTyping()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Cloze (ë¹ˆì¹¸ì±„ìš°ê¸°) -->
<div id="page-cloze" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="cloze-progress"></div></div><div class="progress-text"><span><span id="cloze-current">0</span> / <span id="cloze-total">0</span></span><span>âœ… <span id="cloze-correct">0</span> âŒ <span id="cloze-wrong">0</span></span></div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center">
<div style="font-size:14px;color:var(--muted);text-align:center;margin-bottom:8px"><span id="cloze-hint"></span></div>
<div id="cloze-sentence" style="font-size:18px;line-height:1.8;text-align:center;padding:16px"></div>
</div>
<div class="quiz-options" id="cloze-options"></div>
<button class="btn btn-primary hidden" id="cloze-next-btn" onclick="nextCloze()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndCloze()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Collocation -->
<div id="page-collocation" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="colloc-progress"></div></div><div class="progress-text"><span><span id="colloc-current">0</span> / <span id="colloc-total">0</span></span><span>âœ… <span id="colloc-correct">0</span> âŒ <span id="colloc-wrong">0</span></span></div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center">
<div style="font-size:14px;color:var(--muted);text-align:center;margin-bottom:8px">ì–´ë–¤ ë‹¨ì–´ì™€ í•¨ê»˜ ì“°ì¼ê¹Œìš”?</div>
<div id="colloc-question" style="font-size:28px;font-weight:700;text-align:center;padding:16px">_____ + decision</div>
<div style="font-size:14px;color:var(--muted);text-align:center" id="colloc-meaning"></div>
</div>
<div class="quiz-options" id="colloc-options"></div>
<button class="btn btn-primary hidden" id="colloc-next-btn" onclick="nextColloc()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndColloc()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Expression Flashcard -->
<div id="page-expr-fc" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="expr-fc-progress" style="background:linear-gradient(90deg,var(--expr),#5eead4)"></div></div><div class="progress-text"><span><span id="expr-fc-current">0</span> / <span id="expr-fc-total">0</span></span><span id="expr-fc-timer">0:00</span></div></div>
<div class="retry-banner hidden" id="expr-retry-banner" style="border-color:var(--expr)"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">í‹€ë¦° í‘œí˜„ ì¬í•™ìŠµ ì¤‘</div><div class="retry-banner-count" id="expr-retry-count">0</div></div>
<div class="flashcard-container" id="expr-fc-container"><div class="flashcard" id="expr-fc-card">
<div class="flashcard-face flashcard-front">
<div class="flashcard-tags"><span class="tag" id="expr-fc-register" style="background:rgba(20,184,166,.2);color:var(--expr)">Neutral</span></div>
<div class="flashcard-word" id="expr-fc-word">Expression</div>
<div class="flashcard-hint">ğŸ‘† íƒ­: ë’¤ì§‘ê¸° / ë‹¤ì‹œ íƒ­: ì•ë©´</div>
</div>
<div class="flashcard-face flashcard-back">
<div class="flashcard-back-inner" id="expr-fc-back-inner">
<div id="expr-fc-func" style="font-size:12px;color:var(--expr);text-align:center;margin-bottom:8px"></div>
<div class="flashcard-meaning-ko" id="expr-fc-meaning">ëœ»</div>
<div id="expr-fc-similar" class="similar-expr-box" style="display:none"></div>
<div id="expr-fc-example" class="flashcard-example" style="background:rgba(20,184,166,.1);border-left:3px solid var(--expr)"></div>
</div>
</div>
</div></div>
<div class="rating-section" id="expr-rating-section">
<div class="rating-hint" id="expr-rating-hint">ğŸ‘† íƒ­í•˜ì—¬ ëœ» í™•ì¸ (ë˜ëŠ” ë°”ë¡œ í‰ê°€)</div>
<div class="rating-grid" id="expr-rating-grid">
<button class="rating-btn again" onclick="rateExprCard(0)">ğŸ˜« ëª¨ë¦„<span class="rating-interval">ë‹¤ì‹œ</span></button>
<button class="rating-btn hard" onclick="rateExprCard(1)">ğŸ˜• ì–´ë ¤ì›€<span class="rating-interval">1ì¼</span></button>
<button class="rating-btn good" onclick="rateExprCard(2)">ğŸ™‚ ë³´í†µ<span class="rating-interval">3ì¼</span></button>
<button class="rating-btn easy" onclick="rateExprCard(3)">ğŸ˜Š ì‰¬ì›€<span class="rating-interval">7ì¼+</span></button>
</div>
</div>
<div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn btn-secondary btn-sm" id="expr-fc-production-btn" onclick="toggleExprFCProduction()" style="flex:1;font-size:12px">ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”</button><button class="btn btn-secondary btn-sm" id="expr-fc-tag-btn" onclick="openExprFCTagMenu()" style="flex:1;font-size:12px">ğŸ·ï¸ íƒœê·¸</button></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary btn-sm" id="expr-fc-prev-btn" onclick="prevExprCard()" style="flex:0 0 50px" title="ì´ì „ ì¹´ë“œ">â†</button><button class="btn btn-secondary btn-sm" onclick="speakExpr()" style="flex:0 0 50px">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="expr-fc-bookmark-btn" onclick="toggleExprFCBookmark()" style="flex:0 0 50px">â˜†</button><button class="btn btn-secondary btn-sm" onclick="openExprFCEdit()" style="flex:0 0 50px">âœï¸</button><button class="btn btn-secondary btn-sm" onclick="confirmEndExprFC()" style="flex:1">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Expression Cloze -->
<div id="page-expr-cloze" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="expr-cloze-progress" style="background:linear-gradient(90deg,var(--expr),#5eead4)"></div></div><div class="progress-text"><span><span id="expr-cloze-current">0</span> / <span id="expr-cloze-total">0</span></span><span>âœ… <span id="expr-cloze-correct">0</span> âŒ <span id="expr-cloze-wrong">0</span></span></div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center">
<div style="font-size:14px;color:var(--muted);text-align:center;margin-bottom:8px">ë¹ˆì¹¸ì— ë“¤ì–´ê°ˆ í‘œí˜„ì€?</div>
<div id="expr-cloze-sentence" style="font-size:18px;text-align:center;padding:16px;line-height:1.6"></div>
<div style="font-size:14px;color:var(--expr);text-align:center" id="expr-cloze-hint"></div>
</div>
<div class="quiz-options" id="expr-cloze-options"></div>
<button class="btn btn-primary hidden" id="expr-cloze-next-btn" onclick="exprState.idx++;showExprClozeQ();" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="if(confirm('í•™ìŠµì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))endExprCloze();">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Expression Typing -->
<div id="page-expr-typing" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="expr-typing-progress" style="background:linear-gradient(90deg,var(--expr),#5eead4)"></div></div><div class="progress-text"><span><span id="expr-typing-current">0</span> / <span id="expr-typing-total">0</span></span><span>âœ… <span id="expr-typing-correct">0</span> âŒ <span id="expr-typing-wrong">0</span></span></div></div>
<div class="card" style="min-height:180px"><div style="text-align:center"><div style="font-size:14px;color:var(--expr);margin-bottom:8px" id="expr-typing-func"></div><div style="font-size:24px;font-weight:700;margin-bottom:8px" id="expr-typing-meaning">ëœ»</div><div style="font-size:13px;color:var(--muted)" id="expr-typing-register"></div></div><div id="expr-typing-example" class="hidden" style="background:rgba(20,184,166,.1);padding:12px;border-radius:10px;border-left:3px solid var(--expr);font-size:13px;margin-top:12px"></div></div>
<div style="margin:16px 0"><input type="text" id="expr-typing-input" placeholder="í‘œí˜„ì„ ì˜ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”..." style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px;font-size:16px;color:var(--text)" autocomplete="off" autocapitalize="off"><div id="expr-typing-answer" class="hidden" style="text-align:center;font-size:18px;font-weight:600;margin-top:10px;padding:8px;border-radius:8px"></div></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="showExprTypingHint()" id="expr-typing-hint-btn">ğŸ’¡ íŒíŠ¸</button><button class="btn btn-primary" onclick="checkExprTyping()" id="expr-typing-submit-btn" style="background:var(--expr)">í™•ì¸</button></div>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndExprTyping()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- Expression Quiz -->
<div id="page-expr-quiz" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill" id="expr-quiz-progress" style="background:linear-gradient(90deg,var(--expr),#5eead4)"></div></div><div class="progress-text"><span><span id="expr-quiz-current">0</span> / <span id="expr-quiz-total">0</span></span><span>âœ… <span id="expr-quiz-correct">0</span> âŒ <span id="expr-quiz-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="expr-quiz-retry-banner" style="border-color:var(--expr)"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="expr-quiz-retry-count">0</div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center">
<div class="flashcard-tags" id="expr-quiz-tags" style="justify-content:center"></div>
<div class="flashcard-word" id="expr-quiz-word" style="font-size:24px">Expression</div>
<div id="expr-quiz-func" style="font-size:13px;color:var(--expr);text-align:center;margin-top:8px;display:none"></div>
</div>
<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-secondary btn-sm" onclick="speakExprQuiz()" style="flex:0 0 50px">ğŸ”Š</button><button class="btn btn-secondary btn-sm" id="expr-quiz-bookmark-btn" onclick="toggleExprQuizBookmark()" style="flex:1">â˜† ë¶ë§ˆí¬</button><button class="btn btn-secondary btn-sm" id="expr-quiz-production-btn" onclick="toggleExprQuizProduction()" style="flex:1">ğŸ–Šï¸ ì“°ê¸°</button><button class="btn btn-secondary btn-sm" id="expr-quiz-tag-btn" onclick="openExprQuizTagMenu()" style="flex:1">ğŸ·ï¸ íƒœê·¸</button><button class="btn btn-secondary btn-sm" onclick="openExprQuizEdit()" style="flex:1">âœï¸</button></div>
<div class="quiz-options" id="expr-quiz-options"></div>
<div id="expr-quiz-rating-bar" class="hidden" style="margin-top:12px;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€ <span id="expr-quiz-rating-timer" style="color:var(--expr)"></span></div><div class="rating-grid"><button class="rating-btn again" onclick="rateExprQuizItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="rateExprQuizItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="rateExprQuizItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="rateExprQuizItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<button class="btn btn-primary hidden" id="expr-quiz-next-btn" onclick="nextExprQuiz()" style="margin-top:16px;background:var(--expr)">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndExprQuiz()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- PV Particle -->
<div id="page-pv-particle" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill phrasal" id="pvp-progress"></div></div><div class="progress-text"><span><span id="pvp-current">0</span> / <span id="pvp-total">0</span></span><span>âœ… <span id="pvp-correct">0</span> âŒ <span id="pvp-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="pvp-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="pvp-retry-count">0</div></div>
<div class="card" style="min-height:180px;display:flex;flex-direction:column;justify-content:center"><div style="font-size:14px;color:var(--muted);text-align:center;margin-bottom:8px" id="pvp-meaning"></div><div style="font-size:40px;font-weight:700;color:var(--phrasal);text-align:center;padding:16px" id="pvp-question">verb + <span class="blank-word">?</span></div><div id="pvp-example" class="hidden" style="background:rgba(236,72,153,.1);padding:12px;border-radius:10px;border-left:3px solid var(--phrasal);font-size:13px;margin-top:12px"></div></div>
<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-secondary btn-sm" id="pvp-bookmark-btn" onclick="togglePVPBookmark()" style="flex:1">â˜† ë¶ë§ˆí¬</button><button class="btn btn-secondary btn-sm" onclick="openPVPEdit()" style="flex:1">âœï¸ ìˆ˜ì •</button></div>
<div class="quiz-options" id="pvp-options"></div>
<div id="pvp-rating-bar" class="hidden" style="margin-top:12px;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€ <span id="pvp-rating-timer" style="color:var(--phrasal)"></span></div><div class="rating-grid"><button class="rating-btn again" onclick="ratePVPItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="ratePVPItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="ratePVPItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="ratePVPItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<button class="btn btn-phrasal hidden" id="pvp-next-btn" onclick="nextPVP()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndPVQuiz()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- PV Quiz -->
<div id="page-pv-quiz" class="page">
<div style="position:sticky;top:0;z-index:10;background:var(--card);padding:12px 0;margin:-16px -16px 16px -16px;padding:12px 16px"><div class="progress-bar"><div class="progress-fill phrasal" id="pvq-progress"></div></div><div class="progress-text"><span><span id="pvq-current">0</span> / <span id="pvq-total">0</span></span><span>âœ… <span id="pvq-correct">0</span> âŒ <span id="pvq-wrong">0</span></span></div></div>
<div class="retry-banner hidden" id="pvq-retry-banner"><div class="retry-banner-icon">ğŸ”„</div><div class="retry-banner-text">ì˜¤ë‹µ ì¬ì¶œì œ ì¤‘</div><div class="retry-banner-count" id="pvq-retry-count">0</div></div>
<div class="card" style="min-height:150px;display:flex;flex-direction:column;justify-content:center"><div class="flashcard-tags" id="pvq-tags" style="justify-content:center"></div><div class="flashcard-word" id="pvq-word" style="font-size:28px">êµ¬ë™ì‚¬</div><div id="pvq-sub" style="font-size:14px;color:var(--muted);text-align:center;margin-top:8px"></div><div id="pvq-example" class="hidden" style="background:rgba(20,184,166,.1);padding:12px;border-radius:10px;border-left:3px solid var(--phrasal);font-size:13px;margin-top:12px"></div></div>
<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-secondary btn-sm" id="pvq-bookmark-btn" onclick="togglePVQBookmark()" style="flex:1">â˜† ë¶ë§ˆí¬</button><button class="btn btn-secondary btn-sm" onclick="openPVQEdit()" style="flex:1">âœï¸ ìˆ˜ì •</button></div>
<div class="quiz-options" id="pvq-options"></div>
<div id="pvq-rating-bar" class="hidden" style="margin-top:12px;padding:10px;background:var(--bg);border-radius:12px"><div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px">ğŸ“Š ë‚œì´ë„ í‰ê°€ <span id="pvq-rating-timer" style="color:var(--phrasal)"></span></div><div class="rating-grid"><button class="rating-btn again" onclick="ratePVQItem(0)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜« ëª¨ë¦„</button><button class="rating-btn hard" onclick="ratePVQItem(1)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜• ì–´ë ¤ì›€</button><button class="rating-btn good" onclick="ratePVQItem(2)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ™‚ ë³´í†µ</button><button class="rating-btn easy" onclick="ratePVQItem(3)" style="padding:10px 4px;min-height:50px;font-size:11px">ğŸ˜Š ì‰¬ì›€</button></div></div>
<button class="btn btn-phrasal hidden" id="pvq-next-btn" onclick="nextPVQ()" style="margin-top:16px">ë‹¤ìŒ ë¬¸ì œ â†’</button>
<div style="margin-top:16px"><button class="btn btn-secondary btn-sm" onclick="confirmEndPVQuiz()">í•™ìŠµ ì¢…ë£Œ</button></div>
</div>
<!-- ì·¨ì•½ ë‹¨ì–´ -->
<div id="page-weak" class="page">
<div class="page-header" style="margin-bottom:12px"><h1 style="font-size:20px">ğŸ“ <span id="weak-title">ì·¨ì•½ ë‹¨ì–´</span></h1></div>
<div class="card"><div id="weak-list"></div><div class="empty-state hidden" id="weak-empty"><div class="empty-state-icon">âœ…</div><h3>ì·¨ì•½ ë‹¨ì–´ ì—†ìŒ</h3><p>ëª¨ë“  ë‹¨ì–´ë¥¼ ì˜ ì•Œê³  ìˆì–´ìš”!</p></div></div>
<button class="btn btn-primary hidden" id="weak-study-btn" onclick="startWeakStudy()" style="margin-bottom:16px">ğŸ¯ ì·¨ì•½ ë‹¨ì–´ í•™ìŠµ</button>
<button class="btn btn-secondary" onclick="showPage('home')">â† ëŒì•„ê°€ê¸°</button>
</div>
<!-- ë¶„ì„ -->
<div id="page-stats" class="page">
<div class="type-tabs"><div class="type-tab active" data-type="vocab" onclick="switchStatsType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" data-type="phrasal" onclick="switchStatsType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" data-type="expr" onclick="switchStatsType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div id="stats-vocab">
<div class="card"><div class="card-title">ğŸ“Š í•™ìŠµ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="stats-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="stats-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item"><div class="stat-value warning" id="stats-learning">0</div><div class="stat-label">í•™ìŠµì¤‘</div></div><div class="stat-item"><div class="stat-value" id="stats-new">0</div><div class="stat-label">ë¯¸í•™ìŠµ</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“¦ Leitner Box</div><div class="leitner-container" id="leitner-stats"></div></div>
<div class="card"><div class="card-title">ğŸ¯ ì •ë‹µë¥  ë¶„í¬</div><div class="stat-grid stat-grid-3"><div class="stat-item"><div class="stat-value success" id="stats-high">0</div><div class="stat-label">80%+</div></div><div class="stat-item"><div class="stat-value warning" id="stats-mid">0</div><div class="stat-label">50-79%</div></div><div class="stat-item"><div class="stat-value danger" id="stats-low">0</div><div class="stat-label">&lt;50%</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“… ì£¼ê°„ í•™ìŠµ</div><div class="chart-container" id="weekly-chart"></div></div>
</div>
<div id="stats-phrasal" class="hidden">
<div class="card"><div class="card-title">ğŸ”— í•™ìŠµ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="pv-stats-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="pv-stats-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item"><div class="stat-value warning" id="pv-stats-learning">0</div><div class="stat-label">í•™ìŠµì¤‘</div></div><div class="stat-item"><div class="stat-value" id="pv-stats-new">0</div><div class="stat-label">ë¯¸í•™ìŠµ</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“¦ Leitner Box</div><div class="leitner-container" id="pv-leitner-stats"></div></div>
<div class="card"><div class="card-title">ğŸ¯ ì •ë‹µë¥  ë¶„í¬</div><div class="stat-grid stat-grid-3"><div class="stat-item"><div class="stat-value success" id="pv-stats-high">0</div><div class="stat-label">80%+</div></div><div class="stat-item"><div class="stat-value warning" id="pv-stats-mid">0</div><div class="stat-label">50-79%</div></div><div class="stat-item"><div class="stat-value danger" id="pv-stats-low">0</div><div class="stat-label">&lt;50%</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“… ì£¼ê°„ í•™ìŠµ</div><div class="chart-container" id="pv-weekly-chart"></div></div>
</div>
<div id="stats-expr" class="hidden">
<div class="card"><div class="card-title">ğŸ’¬ í•™ìŠµ í˜„í™©</div><div class="stat-grid"><div class="stat-item"><div class="stat-value" id="expr-stats-total">0</div><div class="stat-label">ì „ì²´</div></div><div class="stat-item"><div class="stat-value success" id="expr-stats-mastered">0</div><div class="stat-label">ë§ˆìŠ¤í„°</div></div><div class="stat-item"><div class="stat-value warning" id="expr-stats-learning">0</div><div class="stat-label">í•™ìŠµì¤‘</div></div><div class="stat-item"><div class="stat-value" id="expr-stats-new">0</div><div class="stat-label">ë¯¸í•™ìŠµ</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“¦ Leitner Box</div><div class="leitner-container" id="expr-leitner-stats"></div></div>
<div class="card"><div class="card-title">ğŸ¯ ì •ë‹µë¥  ë¶„í¬</div><div class="stat-grid stat-grid-3"><div class="stat-item"><div class="stat-value success" id="expr-stats-high">0</div><div class="stat-label">80%+</div></div><div class="stat-item"><div class="stat-value warning" id="expr-stats-mid">0</div><div class="stat-label">50-79%</div></div><div class="stat-item"><div class="stat-value danger" id="expr-stats-low">0</div><div class="stat-label">&lt;50%</div></div></div></div>
<div class="card"><div class="card-title">ğŸ“… ì£¼ê°„ í•™ìŠµ</div><div class="chart-container" id="expr-weekly-chart"></div></div>
</div>
</div>
<!-- ë°ì´í„° -->
<div id="page-data" class="page">
<div class="card"><div class="card-title">ğŸ“š ë‹¨ì–´ ëª©ë¡ <span id="word-count" style="font-size:12px;opacity:.7;margin-left:8px">0ê°œ</span></div><div class="type-tabs" style="margin-bottom:12px"><div class="type-tab active" data-type="vocab" onclick="switchDataType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" data-type="phrasal" onclick="switchDataType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" data-type="expr" onclick="switchDataType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div style="display:flex;gap:8px;margin-bottom:12px"><input type="text" id="word-search" placeholder="ğŸ” ê²€ìƒ‰..." style="flex:1;min-width:0;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:10px 14px;font-size:14px;color:var(--text)" oninput="searchWords()"><button class="btn btn-primary" onclick="openAddWordModal()" style="width:50px;padding:10px">â•</button></div>
<div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;font-size:12px" id="tag-filter-container"></div>
<div class="table-container"><table class="word-table"><thead><tr><th id="col1-h">ë‹¨ì–´</th><th>ëœ»</th><th>ì •ë‹µë¥ </th></tr></thead><tbody id="word-table-body"></tbody></table></div><button class="btn btn-secondary btn-sm" style="margin-top:12px" onclick="loadMoreWords()">ë” ë³´ê¸°</button></div>
<div class="card" style="padding:12px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<span style="font-weight:600;font-size:14px">ğŸ’¾ DB í˜„í™©</span>
<span style="font-size:13px"><span id="db-vocab-count" style="color:var(--primary);font-weight:600">0</span> ì–´íœ˜ Â· <span id="db-pv-count" style="color:var(--phrasal);font-weight:600">0</span> êµ¬ë™ì‚¬ Â· <span id="db-expr-count" style="color:var(--expr);font-weight:600">0</span> í‘œí˜„</span>
</div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“š ë‚œì´ë„ë³„ (ì–´íœ˜)</div>
<div id="dist-difficulty" style="margin-bottom:12px"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“ ì¹´í…Œê³ ë¦¬ë³„ (ì–´íœ˜)</div>
<div id="dist-l1" style="margin-bottom:12px"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ”— êµ¬ë™ì‚¬ ì¹´í…Œê³ ë¦¬</div>
<div id="dist-pv-cat" style="margin-bottom:12px"></div>
<div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ’¬ í‘œí˜„ Register</div>
<div id="dist-expr-register"></div>
</div>
<div class="card"><div class="card-title">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</div><div class="upload-zone" id="upload-zone"><div class="upload-zone-icon">ğŸ“„</div><p>íƒ­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”<br><small>Vocabulary / Phrasal_Verbs / Expressions ì‹œíŠ¸ ìë™ ê°ì§€</small></p></div><input type="file" accept=".xlsx,.xls" hidden id="file-input"><div class="upload-result hidden" id="upload-result"></div></div>
<div class="card"><div class="card-title">âš™ï¸ ë°ì´í„° ê´€ë¦¬</div><button class="btn btn-primary" style="margin-bottom:10px" onclick="exportWithStats()">ğŸ“Š í•™ìŠµê¸°ë¡ í¬í•¨ ì—‘ì…€ Export</button><button class="btn btn-secondary" style="margin-bottom:10px" onclick="exportAllData()">ğŸ“¤ ì „ì²´ ë°±ì—… (JSON)</button><button class="btn btn-secondary" style="margin-bottom:10px" onclick="importData()">ğŸ“¥ ë°ì´í„° ë³µì›</button><button class="btn btn-secondary" style="margin-bottom:10px" onclick="resetWrongNotes()">ğŸ§¹ ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="margin-bottom:10px;color:var(--warning)" onclick="clearDB('words')">ğŸ—‘ï¸ ì–´íœ˜ ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="margin-bottom:10px;color:var(--phrasal)" onclick="clearDB('phrasal_verbs')">ğŸ—‘ï¸ êµ¬ë™ì‚¬ ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="margin-bottom:10px;color:var(--expr)" onclick="clearDB('expressions')">ğŸ—‘ï¸ í‘œí˜„ ì´ˆê¸°í™”</button><button class="btn btn-secondary" style="color:var(--danger)" onclick="resetAllData()">âš ï¸ ì „ì²´ ì´ˆê¸°í™”</button></div>
</div>
<!-- ì„¤ì • -->
<div id="page-settings" class="page">
<div class="card"><div class="card-title">ğŸ“± ì•± ì„¤ì •</div>
<div class="toggle-row"><span class="toggle-label">ë‹¤í¬ ëª¨ë“œ</span><label class="toggle-switch"><input type="checkbox" id="setting-dark" checked onchange="toggleTheme()"><span class="toggle-slider"></span></label></div>
<div class="toggle-row"><span class="toggle-label">ë°œìŒ ìë™ ì¬ìƒ</span><label class="toggle-switch"><input type="checkbox" id="setting-tts" onchange="saveSetting('tts',this.checked)"><span class="toggle-slider"></span></label></div>
<div class="toggle-row"><span class="toggle-label">ì§„ë™ í”¼ë“œë°± <span style="font-size:11px;color:var(--muted)">(Androidë§Œ)</span></span><label class="toggle-switch"><input type="checkbox" id="setting-vibrate" checked onchange="saveSetting('vibrate',this.checked)"><span class="toggle-slider"></span></label></div>
</div>
<div class="card"><div class="card-title">ğŸ“š í•™ìŠµ</div>
<div class="toggle-row" style="margin-bottom:12px"><span class="toggle-label">ğŸ“ ì˜¤ë‹µ ìë™ í¬í•¨ <span style="font-size:11px;color:var(--muted)">(ëª©í‘œ 5ê°œë‹¹ 1ê°œ)</span></span><label class="toggle-switch"><input type="checkbox" id="setting-wrong-auto" checked onchange="saveSetting('wrongAuto',this.checked)"><span class="toggle-slider"></span></label></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px"><div style="font-size:12px;color:var(--muted);margin-bottom:8px">ğŸ“ ì˜¤ë‹µ ì¶”ê°€ í•œë„</div><div style="display:flex;align-items:center;gap:8px"><input type="range" id="setting-wrong-limit" min="1" max="10" value="5" style="flex:1" oninput="document.getElementById('wrong-limit-val').textContent=this.value" onchange="saveSetting('wrongLimit',this.value)"><span id="wrong-limit-val" style="min-width:24px;text-align:center;font-weight:600">5</span><span style="font-size:12px;color:var(--muted)">ê°œ</span></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--muted);margin-bottom:6px">ğŸ“– ì–´íœ˜ ì¼ì¼ëª©í‘œ</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><button onclick="adjustGoal('vocab',-5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">âˆ’</button><input type="number" class="form-input" id="setting-vocab-goal" value="20" min="1" max="100" style="width:50px;text-align:center;padding:4px;font-size:16px;font-weight:600" onchange="saveSetting('vocabGoal',this.value)"><button onclick="adjustGoal('vocab',5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">+</button></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--muted);margin-bottom:6px">ğŸ”— êµ¬ë™ì‚¬ ì¼ì¼ëª©í‘œ</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><button onclick="adjustGoal('pv',-5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">âˆ’</button><input type="number" class="form-input" id="setting-pv-goal" value="10" min="1" max="100" style="width:50px;text-align:center;padding:4px;font-size:16px;font-weight:600" onchange="saveSetting('pvGoal',this.value)"><button onclick="adjustGoal('pv',5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">+</button></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--muted);margin-bottom:6px">ğŸ’¬ í‘œí˜„ ì¼ì¼ëª©í‘œ</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><button onclick="adjustGoal('expr',-5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">âˆ’</button><input type="number" class="form-input" id="setting-expr-goal" value="10" min="1" max="100" style="width:50px;text-align:center;padding:4px;font-size:16px;font-weight:600" onchange="saveSetting('exprGoal',this.value)"><button onclick="adjustGoal('expr',5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">+</button></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--muted);margin-bottom:6px">ğŸ“ ê¸°ë³¸ í•™ìŠµë¶„ëŸ‰</div><div style="display:flex;align-items:center;justify-content:center;gap:4px"><button onclick="adjustGoal('count',-5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">âˆ’</button><input type="number" class="form-input" id="setting-count" value="20" min="5" max="100" style="width:50px;text-align:center;padding:4px;font-size:16px;font-weight:600" onchange="saveSetting('defaultCount',this.value)"><button onclick="adjustGoal('count',5)" style="width:28px;height:28px;border:none;background:var(--card);color:var(--text);border-radius:6px;cursor:pointer">+</button></div></div>
</div></div>
<div class="card"><div class="card-title">â„¹ï¸ ë²„ì „ ì •ë³´</div><p style="font-size:13px;color:var(--muted);line-height:1.8"><strong>CEMS Vocab Pro v6.5</strong><br>â€¢ ğŸ·ï¸ í‘œí˜„ íƒœê·¸ ì‹œìŠ¤í…œ<br>â€¢ ğŸ¯ íƒ€ì…ë³„ ì¼ì¼ ëª©í‘œ<br>â€¢ ğŸ“ í‘œí˜„ ì“°ê¸° ì—°ìŠµ<br>â€¢ âš¡ ë™í˜•ì´ì˜ì–´ ì§€ì›</p></div>
</div>
</div>
<!-- ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="bottom-nav">
<a class="nav-item active" href="javascript:void(0)" onclick="showPage('home')" data-page="home"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>í™ˆ</a>
<a class="nav-item" href="javascript:void(0)" onclick="showPage('study')" data-page="study"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>í•™ìŠµ</a>
<a class="nav-item" href="javascript:void(0)" onclick="showPage('stats')" data-page="stats"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>ë¶„ì„</a>
<a class="nav-item" href="javascript:void(0)" onclick="showPage('data')" data-page="data"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>ë°ì´í„°</a>
<a class="nav-item" href="javascript:void(0)" onclick="showPage('settings')" data-page="settings"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>ì„¤ì •</a>
</nav>
<!-- í† ìŠ¤íŠ¸ & ëª¨ë‹¬ -->
<!-- íƒœê·¸ ëª¨ë‹¬ -->
<div class="modal-overlay" id="tag-modal"><div class="modal"><div class="modal-header"><h3>ğŸ·ï¸ íƒœê·¸ ê´€ë¦¬</h3><button class="modal-close" onclick="closeModal('tag-modal')">âœ•</button></div>
<p style="font-size:13px;color:var(--muted);margin-bottom:12px" id="tag-word-display">ë‹¨ì–´</p>
<div style="font-size:13px;margin-bottom:8px">í˜„ì¬ íƒœê·¸:</div>
<div id="current-tags" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;min-height:30px"></div>
<div style="font-size:13px;margin-bottom:8px">ë¹ ë¥¸ ì¶”ê°€:</div>
<div id="preset-tags" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px"></div>
<div style="display:flex;gap:8px"><input type="text" class="form-input" id="new-tag-input" placeholder="ìƒˆ íƒœê·¸ ì…ë ¥..." style="flex:1"><button class="btn btn-primary btn-sm" onclick="addCustomTag()" style="width:60px">ì¶”ê°€</button></div>
</div></div>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="complete-modal"><div class="modal"><div class="modal-header"><h3>ğŸ‰ í•™ìŠµ ì™„ë£Œ!</h3><button class="modal-close" onclick="closeModal('complete-modal')">âœ•</button></div><div class="stat-grid" style="margin-bottom:20px"><div class="stat-item"><div class="stat-value" id="complete-total">0</div><div class="stat-label">í•™ìŠµ</div></div><div class="stat-item"><div class="stat-value success" id="complete-known">0</div><div class="stat-label">ë³´í†µ+</div></div><div class="stat-item"><div class="stat-value warning" id="complete-unknown">0</div><div class="stat-label">ì–´ë ¤ì›€</div></div><div class="stat-item"><div class="stat-value" id="complete-time">0ë¶„</div><div class="stat-label">ì‹œê°„</div></div></div><div id="complete-wrong-info" class="hidden" style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px;text-align:center"><span style="color:var(--danger)">ğŸ“ <span id="complete-wrong-count">0</span>ê°œ ì˜¤ë‹µë…¸íŠ¸ ì €ì¥</span></div><button class="btn btn-primary" onclick="closeModal('complete-modal');showPage('home');">í™•ì¸</button></div></div>
<div class="modal-overlay" id="quiz-complete-modal"><div class="modal"><div class="modal-header"><h3>ğŸ¯ í•™ìŠµ ì™„ë£Œ!</h3><button class="modal-close" onclick="closeModal('quiz-complete-modal')">âœ•</button></div><div class="stat-grid" style="margin-bottom:20px"><div class="stat-item"><div class="stat-value" id="qc-total">0</div><div class="stat-label">ë¬¸ì œ</div></div><div class="stat-item"><div class="stat-value success" id="qc-correct">0</div><div class="stat-label">ì •ë‹µ</div></div><div class="stat-item"><div class="stat-value danger" id="qc-wrong">0</div><div class="stat-label">ì˜¤ë‹µ</div></div><div class="stat-item"><div class="stat-value" id="qc-acc">0%</div><div class="stat-label">ì •ë‹µë¥ </div></div></div><div id="qc-wrong-info" class="hidden" style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px;text-align:center"><span style="color:var(--danger)">ğŸ“ <span id="qc-wrong-count">0</span>ê°œ ì˜¤ë‹µë…¸íŠ¸ ì €ì¥</span></div>
<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-secondary btn-sm" id="qc-wrong-btn" onclick="closeModal('quiz-complete-modal');startWrongReview(lastStudyType||'vocab');" style="flex:1">ğŸ“ ì˜¤ë‹µë³µìŠµ</button><button class="btn btn-secondary btn-sm" id="qc-prod-btn" onclick="closeModal('quiz-complete-modal');startProductionStudy(lastStudyType||'vocab');" style="flex:1">ğŸ–Šï¸ ì‚°ì¶œì—°ìŠµ</button></div>
<button class="btn btn-primary" onclick="closeModal('quiz-complete-modal');showPage('home');">ğŸ  í™ˆìœ¼ë¡œ</button></div></div>
<div class="modal-overlay" id="confirm-modal" style="z-index:1100"><div class="modal"><div class="modal-header"><h3 id="confirm-title">í™•ì¸</h3><button class="modal-close" onclick="closeModal('confirm-modal')">âœ•</button></div><p id="confirm-msg" style="margin-bottom:20px;color:var(--muted)"></p><div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="closeModal('confirm-modal')" style="flex:1">ì·¨ì†Œ</button><button class="btn btn-primary" id="confirm-btn" style="flex:1">í™•ì¸</button></div></div></div>
<div class="modal-overlay" id="edit-modal"><div class="modal" style="max-height:90vh;overflow-y:auto"><div class="modal-header"><h3>âœï¸ ë‹¨ì–´ í¸ì§‘</h3><button class="modal-close" onclick="closeModal('edit-modal')">âœ•</button></div>
<div class="form-group"><label class="form-label">ë‹¨ì–´/êµ¬ë™ì‚¬</label><input type="text" class="form-input" id="edit-word" readonly style="background:var(--border)"></div>
<div class="form-group"><label class="form-label">ëœ» (í•œêµ­ì–´)</label><input type="text" class="form-input" id="edit-meaning-ko"></div>
<div class="form-group"><label class="form-label">ëœ» (ì˜ì–´)</label><input type="text" class="form-input" id="edit-meaning-en"></div>
<div class="form-group"><label class="form-label">ì˜ˆë¬¸</label><textarea class="form-input" id="edit-example" rows="2" style="text-align:left"></textarea></div>
<div class="form-group"><label class="form-label">í’ˆì‚¬ (POS)</label><input type="text" class="form-input" id="edit-pos"></div>
<div id="edit-vocab-fields">
<div class="form-group"><label class="form-label">ë¶„ë¥˜ (Category)</label><select class="form-select" id="edit-l1"><option value="General">General (ì¤‘ë¦½)</option><option value="Academic">Academic (í•™ìˆ )</option><option value="Daily">Daily (êµ¬ì–´)</option></select></div>
<div class="form-group"><label class="form-label">ë‚œì´ë„</label><select class="form-select" id="edit-difficulty"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
<div class="form-group"><label class="form-label">Key Collocation</label><input type="text" class="form-input" id="edit-collocation"></div>
<div class="form-group"><label class="form-label">ğŸ“ ë‚˜ë§Œì˜ ì˜ˆë¬¸ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label><textarea class="form-input" id="edit-user-examples" rows="3" placeholder="I analyzed the data carefully.&#10;The report analyzes market trends." style="text-align:left;font-size:13px"></textarea></div>
<div class="form-group"><label class="form-label">ğŸ”— ì¶”ê°€ Collocations (ì‰¼í‘œë¡œ êµ¬ë¶„)</label><input type="text" class="form-input" id="edit-user-collocs" placeholder="ì˜ˆ: analyze data, carefully analyze, analyze trends" style="text-align:left"></div>
</div>
<div id="edit-pv-fields" style="display:none">
<div class="form-group"><label class="form-label">Category</label><select class="form-select" id="edit-pv-category"><option value="General">General (ì¤‘ë¦½)</option><option value="Academic">Academic (í•™ìˆ )</option><option value="Daily">Daily (êµ¬ì–´)</option></select></div>
<div class="form-group"><label class="form-label">Formal Equivalent</label><input type="text" class="form-input" id="edit-formal-equiv"></div>
</div>
<div class="form-group"><label class="form-label">ğŸ·ï¸ íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label><input type="text" class="form-input" id="edit-tags" placeholder="ì˜ˆ: ì¤‘ìš”, TOEIC, ë¹„ì¦ˆë‹ˆìŠ¤" style="text-align:left"></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px">
<div class="card-title" style="margin-bottom:12px">ğŸ“Š í•™ìŠµ í†µê³„</div>
<div class="stat-grid stat-grid-3" style="gap:8px">
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-review-count" style="font-size:18px">0</div><div class="stat-label">ë³µìŠµ</div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-accuracy" style="font-size:18px">-</div><div class="stat-label">ì •ë‹µë¥ </div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-box" style="font-size:18px">1</div><div class="stat-label">Box</div></div>
</div>
<div class="stat-grid stat-grid-3" style="gap:8px;margin-top:8px">
<div class="stat-item" style="padding:8px"><div class="stat-value danger" id="edit-wrong-count" style="font-size:18px">0</div><div class="stat-label">ì˜¤ë‹µ</div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-ease" style="font-size:18px">2.5</div><div class="stat-label">Ease</div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="edit-next-review" style="font-size:14px">-</div><div class="stat-label">ë‹¤ìŒë³µìŠµ</div></div>
</div>
</div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="closeModal('edit-modal')" style="flex:1">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveEditedWord()" style="flex:1">ğŸ’¾ ì €ì¥</button></div>
<div style="display:flex;gap:10px;margin-top:10px"><button class="btn btn-secondary" id="edit-bookmark-btn" onclick="toggleBookmark()" style="flex:1">â­ ë¶ë§ˆí¬</button><button class="btn btn-secondary" onclick="shareWord()" style="flex:1">ğŸ“¤ ê³µìœ </button></div>
<div style="display:flex;gap:10px;margin-top:10px"><button class="btn btn-secondary" onclick="copyWord()" style="flex:1">ğŸ“‹ ë³µì‚¬</button><button class="btn btn-secondary" onclick="resetWordStats()" style="flex:1;color:var(--warning)">ğŸ”„ ì´ˆê¸°í™”</button></div>
<button class="btn btn-secondary" onclick="deleteWord()" style="margin-top:10px;color:var(--danger)">ğŸ—‘ï¸ ë‹¨ì–´ ì‚­ì œ</button>
</div></div>
<div class="modal-overlay" id="expr-edit-modal"><div class="modal" style="max-height:90vh;overflow-y:auto"><div class="modal-header"><h3>âœï¸ í‘œí˜„ í¸ì§‘</h3><button class="modal-close" onclick="closeModal('expr-edit-modal')">âœ•</button></div>
<div class="form-group"><label class="form-label">í‘œí˜„</label><input type="text" class="form-input" id="expr-edit-key" readonly style="background:var(--border)"></div>
<div class="form-group"><label class="form-label">ëœ» (í•œêµ­ì–´)</label><input type="text" class="form-input" id="expr-edit-meaning"></div>
<div class="form-group"><label class="form-label">ê¸°ëŠ¥ (Function)</label><input type="text" class="form-input" id="expr-edit-function"></div>
<div class="form-group"><label class="form-label">ê²©ì‹ë„ (Register)</label><select class="form-select" id="expr-edit-register"><option value="Neutral">Neutral (ì¤‘ë¦½)</option><option value="Formal">Formal (ê²©ì‹)</option><option value="Casual">Casual (ë¹„ê²©ì‹)</option></select></div>
<div class="form-group"><label class="form-label">ì˜ˆë¬¸ 1</label><textarea class="form-input" id="expr-edit-example1" rows="2" style="text-align:left"></textarea></div>
<div class="form-group"><label class="form-label">ì˜ˆë¬¸ 2</label><textarea class="form-input" id="expr-edit-example2" rows="2" style="text-align:left"></textarea></div>
<div class="form-group"><label class="form-label">ìœ ì‚¬ í‘œí˜„</label><input type="text" class="form-input" id="expr-edit-similar"></div>
<div class="form-group"><label class="form-label">íƒœê·¸ L1 / L2 / L3</label><div style="display:flex;gap:8px"><input type="text" class="form-input" id="expr-edit-l1" placeholder="L1" style="flex:1;width:auto"><input type="text" class="form-input" id="expr-edit-l2" placeholder="L2" style="flex:1;width:auto"><input type="text" class="form-input" id="expr-edit-l3" placeholder="L3" style="flex:1;width:auto"></div></div>
<div style="background:var(--bg);padding:12px;border-radius:12px;margin-bottom:16px">
<div class="card-title" style="margin-bottom:12px">ğŸ“Š í•™ìŠµ í†µê³„</div>
<div class="stat-grid stat-grid-3" style="gap:8px">
<div class="stat-item" style="padding:8px"><div class="stat-value" id="expr-edit-review" style="font-size:18px">0</div><div class="stat-label">ë³µìŠµ</div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="expr-edit-acc" style="font-size:18px">-</div><div class="stat-label">ì •ë‹µë¥ </div></div>
<div class="stat-item" style="padding:8px"><div class="stat-value" id="expr-edit-next" style="font-size:14px">-</div><div class="stat-label">ë‹¤ìŒë³µìŠµ</div></div>
</div>
</div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="closeModal('expr-edit-modal')" style="flex:1">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveExprEdit()" style="flex:1">ğŸ’¾ ì €ì¥</button></div>
<div style="display:flex;gap:10px;margin-top:10px"><button class="btn btn-secondary" id="expr-edit-bookmark-btn" onclick="toggleExprBookmark()" style="flex:1">â­ ë¶ë§ˆí¬</button><button class="btn btn-secondary" onclick="resetExprStats()" style="flex:1;color:var(--warning)">ğŸ”„ ì´ˆê¸°í™”</button></div>
<button class="btn btn-secondary" onclick="deleteExprItem()" style="margin-top:10px;color:var(--danger)">ğŸ—‘ï¸ í‘œí˜„ ì‚­ì œ</button>
</div></div>
<div class="modal-overlay" id="add-word-modal"><div class="modal" style="max-height:90vh;overflow-y:auto"><div class="modal-header"><h3>â• ë‹¨ì–´ ì¶”ê°€</h3><button class="modal-close" onclick="closeModal('add-word-modal')">âœ•</button></div>
<div class="type-tabs" style="margin-bottom:16px"><div class="type-tab active" id="add-type-vocab" onclick="switchAddType('vocab')">ğŸ“– ì–´íœ˜</div><div class="type-tab phrasal" id="add-type-phrasal" onclick="switchAddType('phrasal')">ğŸ”— êµ¬ë™ì‚¬</div><div class="type-tab expr" id="add-type-expr" onclick="switchAddType('expr')">ğŸ’¬ í‘œí˜„</div></div>
<div class="form-group"><label class="form-label" id="add-word-label">ë‹¨ì–´/êµ¬ë™ì‚¬ *</label><input type="text" class="form-input" id="add-word" placeholder="í•„ìˆ˜ ì…ë ¥"></div>
<div class="form-group"><label class="form-label">ëœ» (í•œêµ­ì–´) *</label><input type="text" class="form-input" id="add-meaning-ko" placeholder="í•„ìˆ˜ ì…ë ¥"></div>
<div class="form-group" id="add-meaning-en-group"><label class="form-label">ëœ» (ì˜ì–´)</label><input type="text" class="form-input" id="add-meaning-en"></div>
<div class="form-group"><label class="form-label">ì˜ˆë¬¸</label><textarea class="form-input" id="add-example" rows="2" style="text-align:left"></textarea></div>
<div class="form-group" id="add-pos-group"><label class="form-label">í’ˆì‚¬ (POS)</label><input type="text" class="form-input" id="add-pos" placeholder="ì˜ˆ: noun, verb, adj"></div>
<div id="add-vocab-fields">
<div class="form-group"><label class="form-label">ë¶„ë¥˜ (Category)</label><select class="form-select" id="add-l1"><option value="General">General (ì¤‘ë¦½/ë‘˜ë‹¤)</option><option value="Academic">Academic (í•™ìˆ ìš©)</option><option value="Daily">Daily (êµ¬ì–´ìš©)</option></select></div>
<div class="form-group"><label class="form-label">ë‚œì´ë„</label><select class="form-select" id="add-difficulty"><option value="1">1 - ì´ˆì¤‘í•™ìƒ</option><option value="2" selected>2 - ê³ ë“±í•™ìƒ</option><option value="3">3 - ëŒ€í•™ìƒ</option><option value="4">4 - GRE/ì „ë¬¸ê°€</option><option value="5">5 - í•™ì/í¬ê·€ì–´</option></select></div>
<div class="form-group"><label class="form-label">Key Collocation</label><input type="text" class="form-input" id="add-collocation" placeholder="ì˜ˆ: make a decision"></div>
<div class="form-group"><label class="form-label">ğŸ“ ë‚˜ë§Œì˜ ì˜ˆë¬¸ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label><textarea class="form-input" id="add-user-examples" rows="2" placeholder="ì§ì ‘ ë§Œë“  ì˜ˆë¬¸ì„ ì¶”ê°€í•˜ì„¸ìš”" style="text-align:left;font-size:13px"></textarea></div>
<div class="form-group"><label class="form-label">ğŸ”— ì¶”ê°€ Collocations (ì‰¼í‘œë¡œ êµ¬ë¶„)</label><input type="text" class="form-input" id="add-user-collocs" placeholder="ì˜ˆ: analyze data, carefully analyze" style="text-align:left"></div>
</div>
<div id="add-pv-fields" style="display:none">
<div class="form-group"><label class="form-label">Base Verb / Particle</label><div style="display:flex;gap:8px"><input type="text" class="form-input" id="add-base-verb" placeholder="Base Verb" style="flex:1;width:auto"><input type="text" class="form-input" id="add-particle" placeholder="Particle" style="flex:1;width:auto"></div></div>
<div class="form-group"><label class="form-label">Category</label><select class="form-select" id="add-pv-category"><option value="General">General (ì¤‘ë¦½)</option><option value="Academic">Academic (í•™ìˆ )</option><option value="Daily">Daily (êµ¬ì–´)</option></select></div>
<div class="form-group"><label class="form-label">Formal Equivalent</label><input type="text" class="form-input" id="add-formal-equiv" placeholder="ì˜ˆ: discover, understand"></div>
</div>
<div id="add-expr-fields" style="display:none">
<div class="form-group"><label class="form-label">ê¸°ëŠ¥ (Function)</label><input type="text" class="form-input" id="add-function" placeholder="ì˜ˆ: Expressing opinion, Making suggestions"></div>
<div class="form-group"><label class="form-label">ê²©ì‹ë„ (Register)</label><select class="form-select" id="add-register"><option value="Neutral">Neutral (ì¤‘ë¦½)</option><option value="Formal">Formal (ê²©ì‹)</option><option value="Casual">Casual (ë¹„ê²©ì‹)</option></select></div>
</div>
<div class="form-group"><label class="form-label">ğŸ·ï¸ íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label><input type="text" class="form-input" id="add-tags" placeholder="ì˜ˆ: ì¤‘ìš”, TOEIC, ë¹„ì¦ˆë‹ˆìŠ¤" style="text-align:left"></div>
<div class="form-group"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="add-bookmark" checked> â­ ë¶ë§ˆí¬ì— ì¶”ê°€</label></div>
<div style="display:flex;gap:10px"><button class="btn btn-secondary" onclick="closeModal('add-word-modal')" style="flex:1">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveNewWord()" style="flex:1">ğŸ’¾ ì €ì¥</button></div>
</div></div>
<script>

const DB_NAME='CEMS_VocabDB_v4',DB_VER=2,LEITNER=[1,3,7,14,30],PARTICLES=['up','down','out','in','on','off','away','back','over','through','around','about','along','apart'];

// ========== FSRS-4.5 Algorithm ==========
// ì°¸ì¡°: https://github.com/open-spaced-repetition/fsrs4anki
// ì›¹ì•±ìš©ìœ¼ë¡œ ì´ˆê¸° stability ì¡°ì • (w[0]~w[3])
const FSRS = {
  // ê¸°ë³¸ íŒŒë¼ë¯¸í„° (w[0]~w[3]: ì´ˆê¸° stabilityë¥¼ ì›¹ì•±ì— ë§ê²Œ ì¡°ì •)
  w: [0.2, 1, 3, 7, 4.93, 0.94, 0.86, 0.01, 1.49, 0.14, 0.94, 2.18, 0.05, 0.34, 1.26, 0.29, 2.61, 0.0, 0.0],
  // w[0]=Again: 0.2ì¼(ì¦‰ì‹œ/ê°™ì€ë‚ ), w[1]=Hard: 1ì¼, w[2]=Good: 3ì¼, w[3]=Easy: 7ì¼
  DECAY: -0.5,
  FACTOR: 19/81, // Math.pow(0.9, 1/-0.5) - 1
  requestRetention: 0.9, // ëª©í‘œ ê¸°ì–µë¥  90%
  
  // ì´ˆê¸° Stability (ìƒˆ ì¹´ë“œ ì²« ë³µìŠµ ì‹œ)
  initStability(grade) {
    // grade: 0=Again, 1=Hard, 2=Good, 3=Easy
    return Math.max(0.1, this.w[grade]);
  },
  
  // ì´ˆê¸° Difficulty
  initDifficulty(grade) {
    // grade: 0=Again, 1=Hard, 2=Good, 3=Easy
    const d = this.w[4] - (grade - 2) * this.w[5];
    return Math.min(10, Math.max(1, d));
  },
  
  // Retrievability (ê¸°ì–µ í™•ë¥ ) ê³„ì‚°
  retrievability(elapsedDays, stability) {
    if (stability <= 0) return 0;
    return Math.pow(1 + elapsedDays / (9 * stability), -1);
  },
  
  // ë‹¤ìŒ ë³µìŠµ ê°„ê²© ê³„ì‚°
  nextInterval(stability) {
    const interval = (stability / this.FACTOR) * (Math.pow(this.requestRetention, 1/this.DECAY) - 1);
    return Math.max(1, Math.round(interval));
  },
  
  // Difficulty ì—…ë°ì´íŠ¸
  updateDifficulty(D, grade) {
    const d0 = this.w[4] - (grade - 2) * this.w[5];
    const newD = this.w[7] * d0 + (1 - this.w[7]) * D;
    return Math.min(10, Math.max(1, newD));
  },
  
  // Stability ì—…ë°ì´íŠ¸ (ì„±ê³µ: grade 1,2,3)
  updateStabilitySuccess(D, S, R, grade) {
    const hardPenalty = grade === 1 ? this.w[15] : 1;
    const easyBonus = grade === 3 ? this.w[16] : 1;
    const newS = S * (Math.exp(this.w[8]) * (11 - D) * Math.pow(S, -this.w[9]) * 
                (Math.exp((1 - R) * this.w[10]) - 1) * hardPenalty * easyBonus + 1);
    return Math.max(0.1, newS);
  },
  
  // Stability ì—…ë°ì´íŠ¸ (ì‹¤íŒ¨: grade 0)
  updateStabilityFail(D, S, R) {
    const newS = this.w[11] * Math.pow(D, -this.w[12]) * 
                (Math.pow(S + 1, this.w[13]) - 1) * Math.exp((1 - R) * this.w[14]);
    return Math.min(Math.max(0.1, newS), S); // ì‹¤íŒ¨ ì‹œ stability ê°ì†Œ
  },
  
  // SM-2 ë°ì´í„°ë¥¼ FSRSë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
  migrateFromSM2(item) {
    const box = item.leitnerBox || 1;
    const ease = item.ease || 2.5;
    // Leitner Box â†’ Stability ë³€í™˜
    const stabilityMap = {1: 1, 2: 3, 3: 7, 4: 14, 5: 30};
    const stability = (stabilityMap[box] || 1) * (ease / 2.5);
    // Ease â†’ Difficulty ë³€í™˜ (ease 1.3~2.5 â†’ difficulty 10~1)
    const difficulty = Math.max(1, Math.min(10, 11 - (ease * 4)));
    return { stability, difficulty };
  }
};

// FSRS ê¸°ë°˜ ë‹¤ìŒ ë³µìŠµ ê³„ì‚°
function calcNext(item, grade) {
  // grade: 0=Again(ëª¨ë¦„), 1=Hard(ì–´ë ¤ì›€), 2=Good(ë³´í†µ), 3=Easy(ì‰¬ì›€)
  const now = new Date();
  let S = item.stability;
  let D = item.difficulty;
  
  // ìƒˆ ì¹´ë“œ ë˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”
  if (S === undefined || D === undefined) {
    if (item.leitnerBox || item.ease) {
      // SM-2 ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
      const migrated = FSRS.migrateFromSM2(item);
      S = migrated.stability;
      D = migrated.difficulty;
    } else {
      // ì™„ì „íˆ ìƒˆ ì¹´ë“œ
      S = FSRS.initStability(grade);
      D = FSRS.initDifficulty(grade);
      const interval = grade === 0 ? 0 : FSRS.nextInterval(S);
      const nextReview = new Date(now);
      nextReview.setDate(nextReview.getDate() + interval);
      return {
        stability: S,
        difficulty: D,
        interval: interval,
        nextReview: nextReview.toISOString(),
        lastReview: now.toISOString(),
        fsrsState: 'Learning',
        reps: 1,
        lapses: grade === 0 ? 1 : 0,
        leitnerBox: stabilityToBox(S) // í˜¸í™˜ì„±
      };
    }
  }
  
  // ê²½ê³¼ì¼ ê³„ì‚° (ìµœì†Œ 1ì¼ ë³´ì¥ - ê°™ì€ ë‚  ë³µìŠµí•´ë„ ì˜ë¯¸ ìˆëŠ” ì¦ê°€ ìœ„í•´)
  const lastReview = item.lastReview ? new Date(item.lastReview) : null;
  const elapsedDays = lastReview ? Math.max(1, (now - lastReview) / (1000 * 60 * 60 * 24)) : 1;
  
  // Retrievability ê³„ì‚°
  const R = FSRS.retrievability(elapsedDays, S);
  
  // Difficulty ì—…ë°ì´íŠ¸
  D = FSRS.updateDifficulty(D, grade);
  
  // Stability ì—…ë°ì´íŠ¸
  let lapses = item.lapses || 0;
  let fsrsState = item.fsrsState || 'Review';
  
  if (grade === 0) {
    // Again - ì‹¤íŒ¨
    S = FSRS.updateStabilityFail(D, S, R);
    lapses++;
    fsrsState = 'Relearning';
  } else {
    // Hard/Good/Easy - ì„±ê³µ
    S = FSRS.updateStabilitySuccess(D, S, R, grade);
    fsrsState = 'Review';
  }
  
  // ë‹¤ìŒ ê°„ê²© ê³„ì‚°
  const interval = grade === 0 ? 0 : FSRS.nextInterval(S);
  const nextReview = new Date(now);
  nextReview.setDate(nextReview.getDate() + interval);
  
  return {
    stability: S,
    difficulty: D,
    interval: interval,
    nextReview: nextReview.toISOString(),
    lastReview: now.toISOString(),
    fsrsState: fsrsState,
    reps: (item.reps || 0) + 1,
    lapses: lapses,
    leitnerBox: stabilityToBox(S) // í˜¸í™˜ì„±: stability â†’ box ë³€í™˜
  };
}

// Stability â†’ Leitner Box ë³€í™˜ (í˜¸í™˜ì„± ìœ ì§€)
function stabilityToBox(S) {
  // Stability ê¸°ì¤€: Box 1(<2ì¼), 2(2-5ì¼), 3(5-12ì¼), 4(12-25ì¼), 5(25ì¼+)
  if (S < 2) return 1;
  if (S < 5) return 2;
  if (S < 12) return 3;
  if (S < 25) return 4;
  return 5;
}
let db=null,wordOffset=0,currentDataType='vocab',currentStudyType='vocab',currentWeakType='vocab',currentHomeType='vocab';
// í”Œë˜ì‹œì¹´ë“œ ìƒíƒœ
let fcState={words:[],idx:0,flipped:false,start:null,timer:null,stats:{again:0,hard:0,good:0,easy:0},transitioning:false,retryQueue:[],phase:'normal',type:'vocab',savedToWrong:0,allWords:[]};
let lastStudyType='vocab';
// í€´ì¦ˆ ìƒíƒœ
let quizState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,mode:'quiz',type:'vocab',retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
// íƒ€ì´í•‘ ìƒíƒœ
let typingState={words:[],idx:0,correct:0,wrong:0,hintUsed:false,answered:false,start:null,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
// PV í€´ì¦ˆ ìƒíƒœ
let pvState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,mode:'particle',retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
// Cloze ìƒíƒœ
let clozeState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
// Collocation ìƒíƒœ
let collocState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
// Expression ìƒíƒœ
let exprState={words:[],allWords:[],idx:0,correct:0,wrong:0,answered:false,start:null,flipped:false,transitioning:false,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0,timer:null,stats:{again:0,hard:0,good:0,easy:0}};

// === DB ===
function openDB(){return new Promise((res,rej)=>{const req=indexedDB.open(DB_NAME,DB_VER);req.onerror=()=>rej(req.error);req.onsuccess=()=>{db=req.result;res(db);};req.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('words'))d.createObjectStore('words',{keyPath:'word'});if(!d.objectStoreNames.contains('phrasal_verbs'))d.createObjectStore('phrasal_verbs',{keyPath:'Phrasal_Verb'});if(!d.objectStoreNames.contains('expressions'))d.createObjectStore('expressions',{keyPath:'Expression'});if(!d.objectStoreNames.contains('sessions'))d.createObjectStore('sessions',{keyPath:'id',autoIncrement:true});};})}
async function getAllWords(){return new Promise(r=>{const req=db.transaction('words','readonly').objectStore('words').getAll();req.onsuccess=()=>r(req.result||[]);req.onerror=()=>r([]);})}
async function getAllPV(){return new Promise(r=>{const req=db.transaction('phrasal_verbs','readonly').objectStore('phrasal_verbs').getAll();req.onsuccess=()=>r(req.result||[]);req.onerror=()=>r([]);})}
async function getAllExpr(){return new Promise(r=>{try{const req=db.transaction('expressions','readonly').objectStore('expressions').getAll();req.onsuccess=()=>r(req.result||[]);req.onerror=()=>r([]);}catch(e){r([]);}})}
async function saveWord(w){return new Promise(r=>{const tx=db.transaction('words','readwrite');tx.objectStore('words').put(w);tx.oncomplete=r;})}
async function savePV(p){return new Promise(r=>{const tx=db.transaction('phrasal_verbs','readwrite');tx.objectStore('phrasal_verbs').put(p);tx.oncomplete=r;})}
async function saveExpr(e){return new Promise(r=>{const tx=db.transaction('expressions','readwrite');tx.objectStore('expressions').put(e);tx.oncomplete=r;})}
async function saveSession(s){lastStudyType=s.type||'vocab';return new Promise(r=>{const tx=db.transaction('sessions','readwrite');s.date=new Date().toISOString();tx.objectStore('sessions').add(s);tx.oncomplete=r;})}
async function getSessions(){return new Promise(r=>{const req=db.transaction('sessions','readonly').objectStore('sessions').getAll();req.onsuccess=()=>r(req.result||[]);req.onerror=()=>r([]);})}
async function getWord(w){return new Promise(r=>{try{const req=db.transaction('words','readonly').objectStore('words').get(w);req.onsuccess=()=>r(req.result||null);req.onerror=()=>r(null);}catch(e){r(null);}})}
async function getPV(p){return new Promise(r=>{try{const req=db.transaction('phrasal_verbs','readonly').objectStore('phrasal_verbs').get(p);req.onsuccess=()=>r(req.result||null);req.onerror=()=>r(null);}catch(e){r(null);}})}
async function getExpr(k){return new Promise(r=>{try{const req=db.transaction('expressions','readonly').objectStore('expressions').get(k);req.onsuccess=()=>r(req.result||null);req.onerror=()=>r(null);}catch(e){r([]);}})}
async function deleteExpr(k){return new Promise(r=>{const tx=db.transaction('expressions','readwrite');tx.objectStore('expressions').delete(k);tx.oncomplete=r;})}

// === í—¬í¼ ===
function getMKO(i){return i?.Meaning1_KO||i?.MeaningKO||i?.Meaning_KO||'';}
function getMEN(i){return i?.Meaning1_EN||i?.MeaningEN||i?.Meaning_EN||'';}
function getEx(i){return i?.Example1||i?.Example||'';}
function getW(i){return i?.word||i?.Phrasal_Verb||'';}
function displayWord(w){return (w||'').replace(/_\d+$/,'');} // seal_1 â†’ seal
function getAcc(i){const rc=i?.reviewCount||0;return rc>0?Math.round(((i?.correctCount||0)/rc)*100):null;}
// 4. ì·¨ì•½ ë‹¨ì–´ íŒë³„ ê°œì„  (FSRS stability í™œìš©)
function isWeak(i){
const rc=i?.reviewCount||0;
if(rc<3)return false; // ë°ì´í„° ë¶€ì¡±
// ì—°ì† ì˜¤ë‹µ 2íšŒ ì´ìƒ
if((i?.consecutiveWrong||0)>=2)return true;
// FSRS stability ë‚®ìŒ (3ì¼ ë¯¸ë§Œ)
if(i?.stability&&i.stability<3)return true;
// ì •í™•ë„ + ìµœê·¼ì„± ê°€ì¤‘ì¹˜
const acc=getAcc(i);
if(acc===null)return false;
const daysSinceWrong=i?.lastWrongDate?(Date.now()-new Date(i.lastWrongDate))/(1000*60*60*24):999;
const recencyBonus=daysSinceWrong<7?10:0;
return(acc+recencyBonus)<60;
}
function isWrong(i){return(i?.consecutiveWrong||0)>=1;}
// ì·¨ì•½ë„ ì ìˆ˜ (ë‚®ì„ìˆ˜ë¡ ì·¨ì•½)
function getWeaknessScore(i){
const acc=getAcc(i)??50;
const stability=i?.stability||5;
const consWrong=i?.consecutiveWrong||0;
const daysSinceWrong=i?.lastWrongDate?(Date.now()-new Date(i.lastWrongDate))/(1000*60*60*24):30;
return(acc*0.4)+(Math.min(stability,30)*0.3)+(Math.max(0,10-consWrong*3)*0.2)+(Math.min(daysSinceWrong,30)*0.1);
}
// 3. FSRS ìš°ì„ ìˆœìœ„ ì •ë ¬
function sortByFSRSPriority(words,now){
return words.sort((a,b)=>{
const getState=w=>{
if(!w.reviewCount)return'NEW';
if(!w.nextReview)return'UNKNOWN';
return new Date(w.nextReview)<=now?'DUE':'FUTURE';
};
const stateA=getState(a),stateB=getState(b);
const priority={DUE:0,NEW:1,UNKNOWN:2,FUTURE:3};
if(priority[stateA]!==priority[stateB])return priority[stateA]-priority[stateB];
if(stateA==='DUE'){
// Overdue ì‹¬í•œ ìˆœ (ê¸°ì–µí™•ë¥  ë‚®ì€ ìˆœ)
const overA=(now-new Date(a.nextReview))/(1000*60*60*24);
const overB=(now-new Date(b.nextReview))/(1000*60*60*24);
const rA=FSRS.retrievability(overA+(a.interval||1),a.stability||1);
const rB=FSRS.retrievability(overB+(b.interval||1),b.stability||1);
return rA-rB;
}
if(stateA==='NEW')return(a.Difficulty||2)-(b.Difficulty||2);
return 0;
});
}
// ì‚¬ì „ ì •ì˜ íƒœê·¸ (ë¹ ë¥¸ íƒœê·¸ ì¶”ê°€ìš©)
const PRESET_TAGS=['ì‹œí—˜ì „','ì•”ê¸°í•„ìˆ˜','ì–´ë ¤ì›€','ë³µìŠµí•„ìš”','ì¤‘ìš”','TOEFL','TOEIC','ë¹„ì¦ˆë‹ˆìŠ¤'];
// ë™ì  í•„í„° ì—…ë°ì´íŠ¸ (TOEFL, COCA, íƒœê·¸)
function updateHomeTagSelects(words,pvs,exprs){
// ì–´íœ˜ í™ˆ íƒœê·¸ ë“œë¡­ë‹¤ìš´
const vocabTags=new Set();
words.forEach(w=>(w.tags||[]).forEach(t=>vocabTags.add(t)));
const homeTagSelect=document.getElementById('home-tag-select');
if(homeTagSelect){
homeTagSelect.innerHTML='<option value="">ğŸ·ï¸ íƒœê·¸ ì„ íƒ...</option>';
[...vocabTags].sort().forEach(t=>{
const count=words.filter(w=>(w.tags||[]).includes(t)).length;
homeTagSelect.innerHTML+=`<option value="${t}">${t} (${count})</option>`;
});
}
// êµ¬ë™ì‚¬ í™ˆ íƒœê·¸ ë“œë¡­ë‹¤ìš´
const pvTags=new Set();
pvs.forEach(p=>(p.tags||[]).forEach(t=>pvTags.add(t)));
const homePvTagSelect=document.getElementById('home-pv-tag-select');
if(homePvTagSelect){
homePvTagSelect.innerHTML='<option value="">ğŸ·ï¸ íƒœê·¸ ì„ íƒ...</option>';
[...pvTags].sort().forEach(t=>{
const count=pvs.filter(p=>(p.tags||[]).includes(t)).length;
homePvTagSelect.innerHTML+=`<option value="${t}">${t} (${count})</option>`;
});
}
// í‘œí˜„ í™ˆ íƒœê·¸ ë“œë¡­ë‹¤ìš´
const exprTags=new Set();
(exprs||[]).forEach(e=>(e.tags||[]).forEach(t=>exprTags.add(t)));
const homeExprTagSelect=document.getElementById('home-expr-tag-select');
if(homeExprTagSelect){
homeExprTagSelect.innerHTML='<option value="">ğŸ·ï¸ íƒœê·¸ ì„ íƒ...</option>';
[...exprTags].sort().forEach(t=>{
const count=(exprs||[]).filter(e=>(e.tags||[]).includes(t)).length;
homeExprTagSelect.innerHTML+=`<option value="${t}">${t} (${count})</option>`;
});
}
}
function updateTagFilters(words,pvs){
// TOEFL ì—°ê´€ì„± í•„í„° ë™ì  ì—…ë°ì´íŠ¸
const toeflSet=new Set();
words.forEach(w=>{if(w.TOEFL_Rel)toeflSet.add(w.TOEFL_Rel);});
const toeflSelect=document.getElementById('filter-toefl');
if(toeflSelect&&toeflSet.size>0){
const current=toeflSelect.value;
toeflSelect.innerHTML='<option value="all">ì „ì²´</option>';
[...toeflSet].sort().forEach(t=>{
const count=words.filter(w=>w.TOEFL_Rel===t).length;
toeflSelect.innerHTML+=`<option value="${t}">${t} (${count})</option>`;
});
toeflSelect.value=current;
}
// COCA ì¥ë¥´ í•„í„° ë™ì  ì—…ë°ì´íŠ¸
const cocaSet=new Set();
words.forEach(w=>{if(w.COCA_Genre)(w.COCA_Genre.split(/[,_\s]+/)).forEach(g=>{if(g.trim())cocaSet.add(g.trim());});});
const cocaSelect=document.getElementById('filter-coca');
if(cocaSelect&&cocaSet.size>0){
const current=cocaSelect.value;
cocaSelect.innerHTML='<option value="all">ì „ì²´</option>';
[...cocaSet].sort().forEach(g=>{
const count=words.filter(w=>(w.COCA_Genre||'').includes(g)).length;
cocaSelect.innerHTML+=`<option value="${g}">${g} (${count})</option>`;
});
cocaSelect.value=current;
}
// íƒœê·¸ í•„í„° ë™ì  ì—…ë°ì´íŠ¸
const vocabTags=new Set();
words.forEach(w=>(w.tags||[]).forEach(t=>vocabTags.add(t)));
const tagSelect=document.getElementById('filter-tag');
if(tagSelect){
const current=tagSelect.value;
tagSelect.innerHTML='<option value="all">ì „ì²´</option>';
[...vocabTags].sort().forEach(t=>{
tagSelect.innerHTML+=`<option value="${t}">${t} (${words.filter(w=>(w.tags||[]).includes(t)).length})</option>`;
});
tagSelect.value=current;
}
// êµ¬ë™ì‚¬ íƒœê·¸ í•„í„° (ìˆë‹¤ë©´)
const pvTagSelect=document.getElementById('pv-filter-tag');
if(pvTagSelect){
const pvTags=new Set();
pvs.forEach(p=>(p.tags||[]).forEach(t=>pvTags.add(t)));
pvTagSelect.innerHTML='<option value="all">ì „ì²´</option>';
[...pvTags].sort().forEach(t=>{
pvTagSelect.innerHTML+=`<option value="${t}">${t}</option>`;
});
}
}
function updateWrong(i,ok){if(ok)i.consecutiveWrong=0;else{i.consecutiveWrong=(i.consecutiveWrong||0)+1;i.wrongCount=(i.wrongCount||0)+1;i.lastWrongDate=new Date().toISOString();}}
// 6. Mastery ê³„ì‚° ê°œì„  (ì§€ìˆ˜ì´ë™í‰ê· )
function updateMastery(item,wasCorrect){
const alpha=0.3; // ìµœê·¼ ì„±ê³¼ ë°˜ì˜ ë¹„ìœ¨
const currentScore=wasCorrect?100:0;
const prevMastery=item.mastery||50;
item.mastery=Math.round(alpha*currentScore+(1-alpha)*prevMastery);
}
function shuffle(a){const arr=[...a];for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}
function vibrate(p=10){if(document.getElementById('setting-vibrate')?.checked&&navigator.vibrate)navigator.vibrate(p);}
function speakWord(t){
const w=displayWord(t||getW(fcState?.words?.[fcState.idx]));
if(!w||!('speechSynthesis'in window))return;
// iOS Safari ë²„ê·¸: cancel() í›„ ë°”ë¡œ speak()í•˜ë©´ ë¬´ìŒ
speechSynthesis.cancel();
// iOSìš© ë”œë ˆì´ ì¶”ê°€
setTimeout(()=>{
const u=new SpeechSynthesisUtterance(w);
u.lang='en-US';
u.rate=0.9;
speechSynthesis.speak(u);
},50);
}
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function showModal(id){document.getElementById(id)?.classList.add('show');}
function closeModal(id){document.getElementById(id)?.classList.remove('show');}
function showConfirm(title,msg,fn){document.getElementById('confirm-title').textContent=title;document.getElementById('confirm-msg').textContent=msg;document.getElementById('confirm-btn').onclick=()=>{closeModal('confirm-modal');fn();};showModal('confirm-modal');}
function getChip(id){return document.querySelector('#'+id+' .chip.active')?.dataset.value||'all';}
function getDistractors(correct,pool,n=4){
if(pool.length<n)return shuffle(pool).slice(0,n);
const correctMeaning=(getMKO(correct)||'').toLowerCase();
const correctWord=displayWord(getW(correct)).toLowerCase();

const scored=pool
.filter(w=>{
// ì •ë‹µ ìì²´ ì œì™¸
if(getW(w)===getW(correct))return false;
// ê°™ì€ ëœ» ì œì™¸
const meaning=(getMKO(w)||'').toLowerCase();
if(!meaning)return false;
if(meaning===correctMeaning)return false;
// ëœ» í¬í•¨ê´€ê³„ ì œì™¸ (ì˜ˆ: "ì‹œì‘" vs "ì‹œì‘í•˜ë‹¤")
if(meaning.length>2&&correctMeaning.length>2){
if(meaning.includes(correctMeaning)||correctMeaning.includes(meaning))return false;
}
return true;
})
.map(w=>{
let score=0;
// ê°™ì€ í’ˆì‚¬ (ì¢‹ì€ distractor)
if(w.POS&&correct.POS&&w.POS===correct.POS)score+=5;
// ê°™ì€ ì¹´í…Œê³ ë¦¬
if(w.L1&&correct.L1&&w.L1===correct.L1)score+=4;
if(w.Category&&correct.Category&&w.Category===correct.Category)score+=4;
// ë¹„ìŠ·í•œ ë‚œì´ë„
const diffGap=Math.abs((w.Difficulty||2)-(correct.Difficulty||2));
if(diffGap===0)score+=3;else if(diffGap===1)score+=1;
// ê¸€ì ìˆ˜ ìœ ì‚¬
const word=displayWord(getW(w)).toLowerCase();
const lenDiff=Math.abs(word.length-correctWord.length);
if(lenDiff<=2)score+=2;
// ì²« ê¸€ì ê°™ìŒ
if(word[0]===correctWord[0])score+=1;
return{word:w,score};
});

if(scored.length<n)return shuffle(scored).slice(0,n).map(x=>x.word);
scored.sort((a,b)=>b.score-a.score);
// ìƒìœ„ 75%ì—ì„œ 3ê°œ, í•˜ìœ„ 25%ì—ì„œ 1ê°œ (ë„ˆë¬´ ì‰¬ìš´ ë³´ê¸° ë°©ì§€)
const cutoff=Math.floor(scored.length*0.75);
const top=scored.slice(0,cutoff);
const bottom=scored.slice(cutoff);
const selected=[
...shuffle(top).slice(0,Math.min(n-1,top.length)),
...shuffle(bottom).slice(0,1)
];
return shuffle(selected).slice(0,n).map(x=>x.word);
}

// === UI ì „í™˜ ===
function switchHomeType(t){currentHomeType=t;document.querySelectorAll('#page-home .type-tab').forEach(e=>e.classList.toggle('active',e.dataset.type===t));document.getElementById('home-vocab').classList.toggle('hidden',t!=='vocab');document.getElementById('home-phrasal').classList.toggle('hidden',t!=='phrasal');document.getElementById('home-expr').classList.toggle('hidden',t!=='expr');}
function switchStudyType(t){currentStudyType=t;document.querySelectorAll('#study-type-tabs .type-tab').forEach(e=>e.classList.toggle('active',e.dataset.type===t));document.getElementById('study-vocab').classList.toggle('hidden',t!=='vocab');document.getElementById('study-phrasal').classList.toggle('hidden',t!=='phrasal');document.getElementById('study-expr').classList.toggle('hidden',t!=='expr');}
function switchStatsType(t){document.querySelectorAll('#page-stats .type-tab').forEach(e=>e.classList.toggle('active',e.dataset.type===t));document.getElementById('stats-vocab').classList.toggle('hidden',t!=='vocab');document.getElementById('stats-phrasal').classList.toggle('hidden',t!=='phrasal');document.getElementById('stats-expr').classList.toggle('hidden',t!=='expr');if(t==='phrasal')updatePVStats();if(t==='expr')updateExprStats();}
function switchDataType(t){currentDataType=t;currentSearchQuery='';currentTagFilter='all';document.getElementById('word-search').value='';document.querySelectorAll('#page-data .type-tab').forEach(e=>e.classList.toggle('active',e.dataset.type===t));document.getElementById('col1-h').textContent=t==='phrasal'?'êµ¬ë™ì‚¬':t==='expr'?'í‘œí˜„':'ë‹¨ì–´';wordOffset=0;updateWordTable();}
function selectMode(el,t){const container=t==='phrasal'?'#study-phrasal':t==='expr'?'#study-expr':'#study-vocab';document.querySelectorAll(container+' .mode-card').forEach(c=>c.classList.remove('active'));el.classList.add('active');}
document.querySelectorAll('.chip-group').forEach(g=>{g.addEventListener('click',e=>{if(e.target.classList.contains('chip')){g.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));e.target.classList.add('active');}});});
function showPage(n){if(fcState.timer){clearInterval(fcState.timer);fcState.timer=null;}if(exprState.timer){clearInterval(exprState.timer);exprState.timer=null;}document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+n)?.classList.add('active');document.querySelectorAll('.nav-item').forEach(a=>a.classList.toggle('active',a.dataset.page===n));if(n==='home'){updateHomeStats();clearSearchInputs();}if(n==='stats')updateStatsPage();if(n==='data')updateDataPage();if(n==='study')updateStudyPage();}
function clearSearchInputs(){
const inputs=['quick-search-input','pv-quick-search-input','expr-search-input'];
inputs.forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
const results=['quick-search-result','pv-quick-search-result','expr-search-result'];
results.forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
}
async function updateStudyPage(){const w=await getAllWords(),p=await getAllPV();if(w.length){const l1s=[...new Set(w.map(x=>x.L1).filter(Boolean))].sort();document.getElementById('filter-l1').innerHTML='<option value="all">ì „ì²´</option>'+l1s.map(l=>`<option value="${l}">${l}</option>`).join('');updateTagFilters(w,p);}if(p.length){const cats=[...new Set(p.map(x=>x.Category).filter(Boolean))].sort();document.getElementById('pv-filter-cat').innerHTML='<option value="all">ì „ì²´</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');}}

// === í•™ìŠµ ì‹œì‘ ===
async function startStudySession(){
if(currentStudyType==='phrasal'){await startPVStudySession();return;}
const words=await getAllWords();if(!words.length){showToast('ğŸ“¤ ë¨¼ì € ì–´íœ˜ DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
const count=parseInt(document.getElementById('study-count').value),filter=getChip('filter-mastery'),l1=document.getElementById('filter-l1').value,order=document.getElementById('option-order').value;
const toefl=document.getElementById('filter-toefl').value,coca=document.getElementById('filter-coca').value,tagF=document.getElementById('filter-tag').value;
const now=new Date();
const mode=document.querySelector('#study-vocab .mode-card.active')?.dataset.mode||'flashcard';
// â˜… íƒ€ì´í•‘ ëª¨ë“œ: needsProduction=trueë©´ SM-2 í•„í„° ë¬´ì‹œ
const isTypingMode=mode==='typing';
let filtered=words.filter(w=>{
// ê¸°ë³¸ í•„í„°
if(l1!=='all'&&w.L1!==l1)return false;
if(toefl!=='all'&&(w.TOEFL_Rel||'').toLowerCase()!==toefl.toLowerCase())return false;
if(coca!=='all'&&!(w.COCA_Genre||'').toLowerCase().includes(coca.toLowerCase()))return false;
if(tagF!=='all'&&!(w.tags||[]).includes(tagF))return false;
const rc=w.reviewCount||0;
if(filter==='new'&&rc>0)return false;
if(filter==='weak'&&!isWeak(w))return false;
if(filter==='wrong'&&!isWrong(w))return false;
if(filter==='starred'&&!w.starred)return false;
// â˜… SM-2 í•„í„° (íƒ€ì´í•‘ ëª¨ë“œ + needsProductionì´ë©´ ë¬´ì‹œ)
if(isTypingMode&&w.needsProduction)return true;
if(rc>0&&w.nextReview&&new Date(w.nextReview)>now)return false;
return true;
});
if(!filtered.length){showToast('âš ï¸ ë³µìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
// ì •ë ¬ (íƒ€ì´í•‘ ëª¨ë“œ: needsProduction ìš°ì„ )
if(isTypingMode){
filtered.sort((a,b)=>(b.needsProduction?1:0)-(a.needsProduction?1:0));
}else if(order==='random')filtered=shuffle(filtered);
else if(order==='sm2'){
// FSRS ìš°ì„ ìˆœìœ„: DUE(ê¸°ì–µí™•ë¥ ë‚®ì€ìˆœ) > NEW(ë‚œì´ë„ìˆœ) > FUTURE
filtered=sortByFSRSPriority(filtered,now);
}
else if(order==='weak')filtered.sort((a,b)=>getWeaknessScore(a)-getWeaknessScore(b));
let sel=filtered.slice(0,count);
// â˜… ì˜¤ë‹µ ìë™ í¬í•¨: ëª©í‘œ 5ê°œë‹¹ 1ê°œ, í•œë„ê¹Œì§€
const wrongAutoEnabled=localStorage.getItem('wrongAuto')!=='false';
if(wrongAutoEnabled&&mode!=='typing'){
const wrongLimit=parseInt(localStorage.getItem('wrongLimit')||'5');
const wrongBonus=Math.min(wrongLimit,Math.floor(count/5));
if(wrongBonus>0){
const wrongWords=words.filter(w=>isWrong(w)&&!sel.includes(w));
const wrongToAdd=shuffle(wrongWords).slice(0,wrongBonus);
if(wrongToAdd.length>0){
// Interleaving: ì˜¤ë‹µì„ ëœë¤ ìœ„ì¹˜ì— ì‚½ì…
wrongToAdd.forEach(w=>{
const insertIdx=Math.floor(Math.random()*(sel.length+1));
sel.splice(insertIdx,0,w);
});
showToast(`ğŸ“ ì˜¤ë‹µ ${wrongToAdd.length}ê°œ í¬í•¨`);
}
}
}
if(mode==='flashcard')startFC(sel,words,'vocab');
else if(mode==='quiz')startQuiz(sel,words,'quiz','vocab');
else if(mode==='reverse')startQuiz(sel,words,'reverse','vocab');
else if(mode==='typing')startTyping(sel);
else if(mode==='cloze')startCloze(sel,words);
else if(mode==='collocation')startColloc(sel,words);
}
async function startQuickStudy(t){
const now=new Date();
if(t==='phrasal'){const p=await getAllPV();if(!p.length){showToast('ğŸ“¤ ë¨¼ì € êµ¬ë™ì‚¬ DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
const avail=p.filter(x=>!x.reviewCount||(x.nextReview&&new Date(x.nextReview)<=now));
if(!avail.length){showToast('âœ… ì˜¤ëŠ˜ ë³µìŠµí•  êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}
startFC(shuffle(avail).slice(0,15),p,'phrasal');return;}
const w=await getAllWords();if(!w.length){showToast('ğŸ“¤ ë¨¼ì € DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');showPage('data');return;}
const avail=w.filter(x=>!x.reviewCount||(x.nextReview&&new Date(x.nextReview)<=now));
if(!avail.length){showToast('âœ… ì˜¤ëŠ˜ ë³µìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}
startFC(shuffle(avail).slice(0,parseInt(localStorage.getItem('defaultCount')||'20')),w,'vocab');
}
async function startQuickQuiz(t){
const now=new Date();
if(t==='phrasal'){const p=await getAllPV();const v=p.filter(x=>x.Particle?.trim()&&(!x.reviewCount||(x.nextReview&&new Date(x.nextReview)<=now)));if(v.length<5){showToast('âš ï¸ ë³µìŠµí•  êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}startPVP(shuffle(v).slice(0,15),p);return;}
const w=await getAllWords();const m=w.filter(x=>getMKO(x)&&(!x.reviewCount||(x.nextReview&&new Date(x.nextReview)<=now)));if(m.length<5){showToast('âš ï¸ ë³µìŠµí•  ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}startQuiz(shuffle(m).slice(0,parseInt(localStorage.getItem('defaultCount')||'20')),w,'quiz','vocab');
}
async function startReviewDue(t){const now=new Date();if(t==='phrasal'){const p=await getAllPV();const due=p.filter(x=>x.nextReview&&new Date(x.nextReview)<=now);if(!due.length){showToast('âœ… ë³µìŠµí•  êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}showToast('ğŸ”„ '+due.length+'ê°œ ë³µìŠµ!');startFC(shuffle(due).slice(0,30),p,'phrasal');return;}const w=await getAllWords();const due=w.filter(x=>x.nextReview&&new Date(x.nextReview)<=now);if(!due.length){showToast('âœ… ë³µìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤!');return;}showToast('ğŸ”„ '+due.length+'ê°œ ë³µìŠµ!');startFC(shuffle(due).slice(0,50),w,'vocab');}
async function startWrongReview(t){if(t==='phrasal'){const p=await getAllPV();const wr=p.filter(x=>isWrong(x));if(!wr.length){showToast('âœ… ì˜¤ë‹µë…¸íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}showToast('ğŸ“ ì˜¤ë‹µ '+wr.length+'ê°œ ë³µìŠµ!');startFC(shuffle(wr).slice(0,20),p,'phrasal');return;}const w=await getAllWords();const wr=w.filter(x=>isWrong(x));if(!wr.length){showToast('âœ… ì˜¤ë‹µë…¸íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}showToast('ğŸ“ ì˜¤ë‹µ '+wr.length+'ê°œ ë³µìŠµ!');startFC(shuffle(wr).slice(0,30),w,'vocab');}
async function startStarredStudy(t){if(t==='phrasal'){const p=await getAllPV();const st=p.filter(x=>x.starred);if(!st.length){showToast('â­ ë¶ë§ˆí¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}showToast('â­ ë¶ë§ˆí¬ '+st.length+'ê°œ í•™ìŠµ!');startFC(shuffle(st).slice(0,20),p,'phrasal');return;}const w=await getAllWords();const st=w.filter(x=>x.starred);if(!st.length){showToast('â­ ë¶ë§ˆí¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}showToast('â­ ë¶ë§ˆí¬ '+st.length+'ê°œ í•™ìŠµ!');startFC(shuffle(st).slice(0,30),w,'vocab');}
async function startTagStudy(t){
const sel=t==='phrasal'?document.getElementById('home-pv-tag-select'):document.getElementById('home-tag-select');
const tag=sel?.value;if(!tag){return;}
if(t==='phrasal'){
const p=await getAllPV();const tagged=p.filter(x=>(x.tags||[]).includes(tag));
if(!tagged.length){showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤');sel.value='';return;}
showToast('ğŸ·ï¸ '+tag+' '+tagged.length+'ê°œ í•™ìŠµ!');startFC(shuffle(tagged).slice(0,20),p,'phrasal');
}else{
const w=await getAllWords();const tagged=w.filter(x=>(x.tags||[]).includes(tag));
if(!tagged.length){showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤');sel.value='';return;}
showToast('ğŸ·ï¸ '+tag+' '+tagged.length+'ê°œ í•™ìŠµ!');startFC(shuffle(tagged).slice(0,30),w,'vocab');
}
sel.value='';
}
async function startProductionStudy(t){
if(t==='phrasal'){
const p=await getAllPV();const prod=p.filter(x=>x.needsProduction);
if(!prod.length){showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ '+prod.length+'ê°œ!');
// ì—­ë°©í–¥ í€´ì¦ˆë¡œ ì‹œì‘ (ëœ»â†’êµ¬ë™ì‚¬)
startPVQ(shuffle(prod).slice(0,20),p,'reverse');return;
}
const w=await getAllWords();const prod=w.filter(x=>x.needsProduction);
if(!prod.length){showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
showToast('ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ '+prod.length+'ê°œ!');
// íƒ€ì´í•‘ ëª¨ë“œë¡œ ì‹œì‘
startTyping(shuffle(prod).slice(0,30));
}
async function showWeakWords(t){currentWeakType=t;const items=t==='phrasal'?await getAllPV():await getAllWords();const weak=items.filter(i=>isWeak(i)).sort((a,b)=>(getAcc(a)||100)-(getAcc(b)||100));document.getElementById('weak-title').textContent=t==='phrasal'?'ì·¨ì•½ êµ¬ë™ì‚¬':'ì·¨ì•½ ë‹¨ì–´';const list=document.getElementById('weak-list'),empty=document.getElementById('weak-empty'),btn=document.getElementById('weak-study-btn');if(!weak.length){list.innerHTML='';empty.classList.remove('hidden');btn.classList.add('hidden');}else{empty.classList.add('hidden');btn.classList.remove('hidden');list.innerHTML=weak.slice(0,20).map(w=>`<div class="weak-word-item"><div class="weak-word-text"><strong>${displayWord(getW(w))}</strong><span>${getMKO(w)}</span></div><div class="weak-word-stats"><div class="weak-word-rate" style="color:var(--danger)">${getAcc(w)!==null?getAcc(w)+'%':'-'}</div><div class="weak-word-count">${w.reviewCount||0}íšŒ</div></div></div>`).join('');}showPage('weak');}
async function startWeakStudy(){const items=currentWeakType==='phrasal'?await getAllPV():await getAllWords();const weak=items.filter(i=>isWeak(i));if(!weak.length){showToast('ì·¨ì•½ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤');return;}if(currentWeakType==='phrasal')startFC(shuffle(weak).slice(0,20),items,'phrasal');else startFC(shuffle(weak).slice(0,30),items,'vocab');}

// === í”Œë˜ì‹œì¹´ë“œ (í•µì‹¬) ===
function startFC(items,all,type){
console.log('startFC called:', {itemsCount: items.length, type, firstItem: items[0]});
if(fcState.timer)clearInterval(fcState.timer);
fcState={words:[...items],idx:0,flipped:false,start:Date.now(),timer:null,stats:{again:0,hard:0,good:0,easy:0},transitioning:false,retryQueue:[],phase:'normal',type,savedToWrong:0,allWords:all};
console.log('fcState.words[0]:', fcState.words[0]);
document.getElementById('fc-total').textContent=items.length;
document.getElementById('fc-current').textContent='1';
document.getElementById('fc-progress').style.width='0%';
document.getElementById('fc-retry-banner').classList.add('hidden');
document.getElementById('fc-progress').classList.toggle('phrasal',type==='phrasal');
showPage('flashcard');showCard();startTimer();updateStreak();
}

function showCard(){
const item=fcState.words[fcState.idx];
console.log('showCard item:',item); // ë””ë²„ê¹…
if(!item){
  if(fcState.retryQueue.length>0){
    fcState.words=[...fcState.retryQueue];fcState.retryQueue=[];fcState.idx=0;fcState.phase='retry';
    document.getElementById('fc-retry-banner').classList.remove('hidden');
    document.getElementById('fc-retry-count').textContent=fcState.words.length;
    document.getElementById('fc-total').textContent=fcState.words.length;
    showToast('ğŸ”„ ëª¨ë¦„ '+fcState.words.length+'ê°œ ì¬ì¶œì œ!');
    showCard();return;
  }else{endFC();return;}
}
const fc=document.getElementById('flashcard');
// 1. ë’·ë©´ ë‚´ìš© ì¦‰ì‹œ ìˆ¨ê¹€
document.getElementById('fc-back-inner').classList.remove('visible');
document.getElementById('fc-meaning-ko').textContent='';
document.getElementById('fc-meaning-en').textContent='';
document.getElementById('fc-example').textContent='';
document.getElementById('fc-example').style.display='none';
document.getElementById('fc-collocation').textContent='';
// 2. ì¹´ë“œ ë¦¬ì…‹
fcState.flipped=false;fcState.transitioning=false;
fc.classList.remove('flipped','swipe-left','swipe-right');
setRating(false);
// 3. ì§„í–‰ë¥ 
document.getElementById('fc-progress').style.width=(fcState.idx/fcState.words.length)*100+'%';
document.getElementById('fc-current').textContent=fcState.idx+1;
if(fcState.phase==='retry')document.getElementById('fc-retry-count').textContent=fcState.words.length-fcState.idx;
// 4. ì•ë©´
if(fcState.type==='phrasal'){
  document.getElementById('fc-word').textContent=item.Phrasal_Verb||'(êµ¬ë™ì‚¬)';
  document.getElementById('fc-tags').innerHTML=`<span class="tag tag-phrasal">${item.Particle||''}</span><span class="tag tag-cat">${item.Category||''}</span>`;
}else{
  const wordText=displayWord(item.word)||item.word||'(ë‹¨ì–´ ì—†ìŒ)';
  console.log('Displaying word:',wordText); // ë””ë²„ê¹…
  document.getElementById('fc-word').textContent=wordText;
  document.getElementById('fc-tags').innerHTML=`<span class="tag tag-pos">${item.POS||'n/a'}</span><span class="tag tag-level">Lv.${item.Difficulty||2}</span><span class="tag tag-cat">${item.L1||'General'}</span>`;
}
if(document.getElementById('setting-tts')?.checked)setTimeout(()=>speakWord(),300);
updateFCBookmarkBtn();
updateFCProductionBtn();
updateFCTagBtn();
updateFCPrevBtn();
}
// ì´ì „ ì¹´ë“œë¡œ ëŒì•„ê°€ê¸°
function prevCard(){
if(fcState.idx<=0)return;
fcState.idx--;
showCard();
}
function updateFCPrevBtn(){
const btn=document.getElementById('fc-prev-btn');
if(btn){
btn.disabled=fcState.idx<=0;
btn.style.opacity=fcState.idx<=0?'0.4':'1';
}
}

// í•µì‹¬: í”Œë¦½ í† ê¸€ (ì¬í”Œë¦½ ê°€ëŠ¥)
function flipCard(){
if(fcState.transitioning)return;
const item=fcState.words[fcState.idx];if(!item)return;
if(fcState.flipped){
// ì¬í”Œë¦½: ì•ë©´ìœ¼ë¡œ
fcState.flipped=false;
document.getElementById('flashcard').classList.remove('flipped');
document.getElementById('fc-back-inner').classList.remove('visible');
setRating(false);
}else{
// í”Œë¦½: ë’·ë©´ìœ¼ë¡œ
document.getElementById('fc-meaning-ko').textContent=getMKO(item)||'(ëœ» ì—†ìŒ)';
document.getElementById('fc-meaning-en').textContent=getMEN(item)||'';
const ex=getEx(item);document.getElementById('fc-example').textContent=ex||'';document.getElementById('fc-example').style.display=ex?'block':'none';
if(fcState.type==='phrasal'){document.getElementById('fc-collocation').innerHTML=item.Formal_Equivalent?`<strong>ğŸ“Œ Formal:</strong> ${item.Formal_Equivalent}`:'';
}else{document.getElementById('fc-collocation').innerHTML=item.Key_Collocation?`<strong>ğŸ“Œ</strong> ${item.Key_Collocation}`:'';}
document.getElementById('fc-back-inner').classList.add('visible');
fcState.flipped=true;
document.getElementById('flashcard').classList.add('flipped');
setRating(true);vibrate(10);
}
}

function setRating(en){
const sec=document.getElementById('rating-section'),hint=document.getElementById('rating-hint');
// í•­ìƒ í™œì„±í™” (ë’¤ì§‘ì§€ ì•Šì•„ë„ ì„ íƒ ê°€ëŠ¥)
sec.classList.remove('disabled');
document.querySelectorAll('.rating-btn').forEach(b=>b.disabled=false);
if(en){hint.textContent='ì–¼ë§ˆë‚˜ ì˜ ì•Œê³  ìˆë‚˜ìš”?';}
else{hint.textContent='ğŸ‘† íƒ­í•˜ì—¬ ëœ» í™•ì¸ (ë˜ëŠ” ë°”ë¡œ í‰ê°€)';}
// ë™ì  interval í‘œì‹œ (FSRS ê¸°ë°˜)
const item=fcState.words[fcState.idx];
if(item){
// ì˜ˆìƒ ê°„ê²© ê³„ì‚°
const result0 = calcNext({...item}, 0);
const result1 = calcNext({...item}, 1);
const result2 = calcNext({...item}, 2);
const result3 = calcNext({...item}, 3);
const intervals=['ë‹¤ì‹œ',
  `${result1.interval}ì¼`,
  `${result2.interval}ì¼`,
  `${result3.interval}ì¼`];
document.querySelectorAll('.rating-interval').forEach((el,i)=>el.textContent=intervals[i]);
}
}

async function rateCard(r){
if(fcState.transitioning)return;
fcState.transitioning=true;
const item=fcState.words[fcState.idx];if(!item){fcState.transitioning=false;return;}
if(r===0)fcState.stats.again++;else if(r===1)fcState.stats.hard++;else if(r===2)fcState.stats.good++;else fcState.stats.easy++;
// 6. Hard/Again ì‹œ needsProduction ìë™ ì„¤ì •
if(r<=1)item.needsProduction=true;
// 5. ì„¸ì…˜ ë‚´ ì¬í•™ìŠµ: ì˜¤ë‹µ ì‹œ 5~7ë¬¸ì œ í›„ ì¬ì¶œì œ (phase='normal'ì¼ ë•Œë§Œ)
if(r===0&&fcState.phase==='normal'){
const insertIdx=Math.min(fcState.idx+5+Math.floor(Math.random()*3),fcState.words.length);
fcState.words.splice(insertIdx,0,{...item,isRetry:true});
}
// retry phaseì—ì„œ ë˜ í‹€ë¦¬ë©´ ì˜¤ë‹µë…¸íŠ¸ë¡œ
else if(r===0&&fcState.phase==='retry'){updateWrong(item,false);fcState.savedToWrong++;}
else if(r>=2)updateWrong(item,true);
// DB ì—…ë°ì´íŠ¸
item.reviewCount=(item.reviewCount||0)+1;if(r>=2)item.correctCount=(item.correctCount||0)+1;
updateMastery(item,r>=2);
// FSRS ê³„ì‚° (lastReviewëŠ” calcNext ë‚´ë¶€ì—ì„œ ì„¤ì •)
Object.assign(item,calcNext(item,r));
if(fcState.type==='phrasal')await savePV(item);else await saveWord(item);
vibrate(r>=2?10:[50,30,50]);fcState.idx++;
setTimeout(()=>{fcState.transitioning=false;showCard();},200);
}

// í„°ì¹˜ ì´ë²¤íŠ¸
let touchX=0,touchY=0,swiping=false;
document.getElementById('fc-container')?.addEventListener('touchstart',e=>{touchX=e.touches[0].clientX;touchY=e.touches[0].clientY;swiping=false;},{passive:true});
document.getElementById('fc-container')?.addEventListener('touchmove',e=>{if(!fcState.flipped)return;const dx=e.touches[0].clientX-touchX,dy=e.touches[0].clientY-touchY;if(Math.abs(dx)>30&&Math.abs(dx)>Math.abs(dy)){swiping=true;document.getElementById(dx>0?'swipe-right':'swipe-left').classList.add('show');document.getElementById(dx>0?'swipe-left':'swipe-right').classList.remove('show');}else{document.getElementById('swipe-left').classList.remove('show');document.getElementById('swipe-right').classList.remove('show');}},{passive:true});
document.getElementById('fc-container')?.addEventListener('touchend',e=>{document.getElementById('swipe-left').classList.remove('show');document.getElementById('swipe-right').classList.remove('show');if(!fcState.flipped)return;const dx=e.changedTouches[0].clientX-touchX,dy=e.changedTouches[0].clientY-touchY;if(Math.abs(dx)>100&&Math.abs(dx)>Math.abs(dy)*2){document.getElementById('flashcard').classList.add(dx>0?'swipe-right':'swipe-left');setTimeout(()=>rateCard(dx>0?2:0),300);}});
document.getElementById('flashcard')?.addEventListener('click',()=>{if(!swiping)flipCard();swiping=false;});

// í‘œí˜„ í”Œë˜ì‹œì¹´ë“œ ì´ë²¤íŠ¸
document.getElementById('expr-fc-card')?.addEventListener('click',flipExprCard);

function startTimer(){const el=document.getElementById('fc-timer'),s=Date.now();if(fcState.timer)clearInterval(fcState.timer);fcState.timer=setInterval(()=>{const sec=Math.floor((Date.now()-s)/1000);el.textContent=Math.floor(sec/60)+':'+(sec%60).toString().padStart(2,'0');},1000);}
function confirmEndFC(){const ev=fcState.stats.again+fcState.stats.hard+fcState.stats.good+fcState.stats.easy;if(ev===0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ì•„ì§ í‰ê°€í•œ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',()=>endFC(true));else if(fcState.idx<fcState.words.length||fcState.retryQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë‹¨ì–´ê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endFC);else endFC();}
async function endFC(skip){
if(fcState.timer){clearInterval(fcState.timer);fcState.timer=null;}
const ev=fcState.stats.again+fcState.stats.hard+fcState.stats.good+fcState.stats.easy;
if(ev===0||skip){showPage('home');showToast('í•™ìŠµì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');return;}
const known=fcState.stats.good+fcState.stats.easy,unknown=fcState.stats.again+fcState.stats.hard,dur=Math.round((Date.now()-fcState.start)/1000);
await saveSession({total:ev,known,unknown,duration:dur,mode:'flashcard',type:fcState.type,stats:{...fcState.stats}});
document.getElementById('complete-total').textContent=ev;
document.getElementById('complete-known').textContent=known;
document.getElementById('complete-unknown').textContent=unknown;
const min=Math.floor(dur/60),sec=dur%60;document.getElementById('complete-time').textContent=min>0?min+'ë¶„ '+sec+'ì´ˆ':sec+'ì´ˆ';
if(fcState.savedToWrong>0){document.getElementById('complete-wrong-info').classList.remove('hidden');document.getElementById('complete-wrong-count').textContent=fcState.savedToWrong;}
else document.getElementById('complete-wrong-info').classList.add('hidden');
showModal('complete-modal');updateHomeStats();
}

// === í€´ì¦ˆ (3ë‹¨ê³„) ===
function startQuiz(words,all,mode,type){
const m=words.filter(w=>getMKO(w));if(m.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
quizState={words:[...m],allWords:all||words,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),mode:mode||'quiz',type:type||'vocab',retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
document.getElementById('quiz-total').textContent=m.length;
document.getElementById('quiz-retry-banner').classList.add('hidden');
showPage('quiz');showQuizQ();updateStreak();
}
function showQuizQ(){
if(quizState.idx>=quizState.words.length){
  if(quizState.retryQueue.length>0&&quizState.phase==='normal'){
    quizState.words=[...quizState.retryQueue];quizState.retryQueue=[];quizState.idx=0;quizState.phase='retry';
    document.getElementById('quiz-retry-banner').classList.remove('hidden');document.getElementById('quiz-retry-count').textContent=quizState.words.length;
    showToast('ğŸ”„ ì˜¤ë‹µ '+quizState.words.length+'ê°œ ì¬ì¶œì œ!');
  }else if(quizState.finalQueue.length>0&&quizState.phase==='retry'){
    quizState.words=[...quizState.finalQueue];quizState.finalQueue=[];quizState.idx=0;quizState.phase='final';
    document.getElementById('quiz-retry-count').textContent=quizState.words.length;showToast('âš ï¸ ìµœì¢… '+quizState.words.length+'ê°œ ì¬ì¶œì œ!');
  }else{endQuiz();return;}
}
const w=quizState.words[quizState.idx];if(!w)return;
document.getElementById('quiz-progress').style.width=(quizState.idx/quizState.words.length)*100+'%';
document.getElementById('quiz-current').textContent=quizState.idx+1;document.getElementById('quiz-total').textContent=quizState.words.length;
document.getElementById('quiz-correct').textContent=quizState.correct;document.getElementById('quiz-wrong').textContent=quizState.wrong;
if(quizState.phase!=='normal')document.getElementById('quiz-retry-count').textContent=quizState.words.length-quizState.idx;
const isRev=quizState.mode==='reverse';
if(isRev){document.getElementById('quiz-word').textContent=getMKO(w);document.getElementById('quiz-sub').textContent='ì˜ì–´ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”';document.getElementById('quiz-tags').innerHTML='';}
else{document.getElementById('quiz-word').textContent=displayWord(w.word);document.getElementById('quiz-sub').textContent='';document.getElementById('quiz-tags').innerHTML=`<span class="tag tag-pos">${w.POS||''}</span><span class="tag tag-level">Lv.${w.Difficulty||2}</span>`;}
const pool=quizState.allWords.filter(x=>x.word!==w.word&&getMKO(x)&&getMKO(x)!==getMKO(w));
const dist=getDistractors(w,pool,4);const cAns=isRev?displayWord(w.word):getMKO(w);const wAns=dist.map(x=>isRev?displayWord(x.word):getMKO(x)).filter(x=>x);
const opts=shuffle([cAns,...wAns]);
document.getElementById('quiz-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectQuiz(this)" data-ans="${o===cAns}">${o}</button>`).join('');
quizState.answered=false;quizState.correctAns=cAns;
document.getElementById('quiz-example').classList.add('hidden');
updateQuizBookmarkBtn();
updateQuizProductionBtn();
updateQuizTagBtn();
document.getElementById('quiz-next-btn').classList.add('hidden');
document.getElementById('quiz-rating-bar').classList.add('hidden');
}
async function selectQuiz(el){
if(quizState.answered)return;quizState.answered=true;
const ok=el.dataset.ans==='true';
const w=quizState.words[quizState.idx];
if(ok)quizState.correct++;else{quizState.wrong++;if(quizState.phase==='normal')quizState.retryQueue.push({...w});else if(quizState.phase==='retry')quizState.finalQueue.push({...w});else{updateWrong(w,false);quizState.savedToWrong++;}}
document.querySelectorAll('.quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
w.reviewCount=(w.reviewCount||0)+1;if(ok)w.correctCount=(w.correctCount||0)+1;
updateMastery(w,ok);
// ì˜¤ë‹µ ì‹œì—ë§Œ SM-2 ì—…ë°ì´íŠ¸ (ëª¨ë¦„=0), ì •ë‹µ ì‹œì—ëŠ” í‰ê°€ ë°”ì—ì„œ ì„ íƒ
if(!ok){updateWrong(w,false);Object.assign(w,calcNext(w,0));await saveWord(w);}
vibrate(ok?10:[50,30,50]);
document.getElementById('quiz-correct').textContent=quizState.correct;document.getElementById('quiz-wrong').textContent=quizState.wrong;
const ex=getEx(w);if(ex){document.getElementById('quiz-example').textContent=ex;document.getElementById('quiz-example').classList.remove('hidden');}
if(ok){quizState.pendingRating=true;showQuizRating('quiz',2000);}else{setTimeout(()=>nextQuiz(),1500);}
}
let quizRatingTimer=null;
function showQuizRating(prefix,duration){
document.getElementById(prefix+'-rating-bar').classList.remove('hidden');
let remaining=Math.ceil(duration/1000);
document.getElementById(prefix+'-rating-timer').textContent='('+remaining+'s)';
clearInterval(quizRatingTimer);
quizRatingTimer=setInterval(()=>{
remaining--;
document.getElementById(prefix+'-rating-timer').textContent=remaining>0?'('+remaining+'s)':'';
if(remaining<=0){
clearInterval(quizRatingTimer);
document.getElementById(prefix+'-rating-bar').classList.add('hidden');
// ì‹œê°„ ì´ˆê³¼: í‰ê°€ ì—†ì´ ë‹¤ìŒìœ¼ë¡œ (ì‚¬ìš©ì ìš”ì²­)
if(prefix==='quiz')nextQuiz();
else if(prefix==='pvq')nextPVQ();
else if(prefix==='pvp')nextPVP();
else if(prefix==='expr-quiz')nextExprQuiz();
}
},1000);
}
async function rateQuizItem(grade){
clearInterval(quizRatingTimer);
const w=quizState.words[quizState.idx];
Object.assign(w,calcNext(w,grade));await saveWord(w);
document.getElementById('quiz-rating-bar').classList.add('hidden');
nextQuiz();
}
function nextQuiz(){quizState.idx++;showQuizQ();}
function confirmEndQuiz(){if(quizState.idx<quizState.words.length||quizState.retryQueue.length>0||quizState.finalQueue.length>0)showConfirm('í€´ì¦ˆ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endQuiz);else endQuiz();}
async function endQuiz(){
const ans=quizState.correct+quizState.wrong;if(ans===0){showPage('home');return;}
const acc=Math.round((quizState.correct/ans)*100);
await saveSession({total:ans,correct:quizState.correct,wrong:quizState.wrong,accuracy:acc,mode:quizState.mode,type:quizState.type,duration:Math.round((Date.now()-quizState.start)/1000)});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=quizState.correct;document.getElementById('qc-wrong').textContent=quizState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(quizState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=quizState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// === íƒ€ì´í•‘ (3ë‹¨ê³„) ===
function startTyping(words){
typingState={words:words.filter(w=>getMKO(w)),idx:0,correct:0,wrong:0,hintUsed:false,answered:false,start:Date.now(),retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
document.getElementById('typing-total').textContent=typingState.words.length;document.getElementById('typing-retry-banner').classList.add('hidden');
showPage('typing');showTypingQ();updateStreak();
}
function showTypingQ(){
if(typingState.idx>=typingState.words.length){
  if(typingState.retryQueue.length>0&&typingState.phase==='normal'){typingState.words=[...typingState.retryQueue];typingState.retryQueue=[];typingState.idx=0;typingState.phase='retry';document.getElementById('typing-retry-banner').classList.remove('hidden');document.getElementById('typing-retry-count').textContent=typingState.words.length;showToast('ğŸ”„ ì˜¤ë‹µ '+typingState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else if(typingState.finalQueue.length>0&&typingState.phase==='retry'){typingState.words=[...typingState.finalQueue];typingState.finalQueue=[];typingState.idx=0;typingState.phase='final';document.getElementById('typing-retry-count').textContent=typingState.words.length;showToast('âš ï¸ ìµœì¢… '+typingState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else{endTyping();return;}
}
const w=typingState.words[typingState.idx];if(!w)return;
document.getElementById('typing-progress').style.width=(typingState.idx/typingState.words.length)*100+'%';
document.getElementById('typing-current').textContent=typingState.idx+1;document.getElementById('typing-total').textContent=typingState.words.length;
document.getElementById('typing-correct').textContent=typingState.correct;document.getElementById('typing-wrong').textContent=typingState.wrong;
if(typingState.phase!=='normal')document.getElementById('typing-retry-count').textContent=typingState.words.length-typingState.idx;
document.getElementById('typing-pos').textContent=w.POS||'';document.getElementById('typing-meaning').textContent=getMKO(w)||'(ëœ» ì—†ìŒ)';document.getElementById('typing-en').textContent=getMEN(w)||'';
const inp=document.getElementById('typing-input');inp.value='';inp.classList.remove('correct','wrong');inp.disabled=false;inp.focus();
document.getElementById('typing-answer').classList.add('hidden');document.getElementById('typing-next-btn').classList.add('hidden');
document.getElementById('typing-submit-btn').classList.remove('hidden');document.getElementById('typing-hint-btn').classList.remove('hidden');
typingState.hintUsed=false;typingState.answered=false;
document.getElementById('typing-example').classList.add('hidden');
updateTypingBookmarkBtn();
}
function showTypingHint(){const w=typingState.words[typingState.idx];if(!w||typingState.answered)return;typingState.hintUsed=true;const dw=displayWord(w.word);showToast('íŒíŠ¸: '+dw.charAt(0)+'_'.repeat(dw.length-1)+' ('+dw.length+'ê¸€ì)');}
async function checkTyping(){
if(typingState.answered)return;
const w=typingState.words[typingState.idx],inp=document.getElementById('typing-input'),user=inp.value.trim().toLowerCase(),correct=displayWord(w.word).toLowerCase();
typingState.answered=true;inp.disabled=true;
const ok=user===correct;
if(ok&&!typingState.hintUsed){
typingState.correct++;
// íƒ€ì´í•‘ ì •ë‹µ = ì‚°ì¶œ ì„±ê³µ â†’ ì‚°ì¶œ ì—°ìŠµ í•´ì œ
if(w.needsProduction){w.needsProduction=false;showToast('âœ… ì‚°ì¶œ ì„±ê³µ! ëª©ë¡ì—ì„œ ì œê±°');}
}
else{typingState.wrong++;if(typingState.phase==='normal')typingState.retryQueue.push({...w});else if(typingState.phase==='retry')typingState.finalQueue.push({...w});else{updateWrong(w,false);typingState.savedToWrong++;}}
inp.classList.add(ok?'correct':'wrong');
const ans=document.getElementById('typing-answer');ans.textContent=displayWord(w.word);ans.classList.remove('hidden','correct','wrong');ans.classList.add(ok?'correct':'wrong');
w.reviewCount=(w.reviewCount||0)+1;if(ok&&!typingState.hintUsed)w.correctCount=(w.correctCount||0)+1;
updateMastery(w,ok);if(ok&&!typingState.hintUsed)updateWrong(w,true);
Object.assign(w,calcNext(w,ok&&!typingState.hintUsed?2:(ok?1:0)));await saveWord(w);
vibrate(ok?10:[50,30,50]);
document.getElementById('typing-correct').textContent=typingState.correct;document.getElementById('typing-wrong').textContent=typingState.wrong;
document.getElementById('typing-submit-btn').classList.add('hidden');document.getElementById('typing-hint-btn').classList.add('hidden');
// ì˜ˆë¬¸ í‘œì‹œ
const exT=getEx(w);if(exT){document.getElementById('typing-example').textContent=exT;document.getElementById('typing-example').classList.remove('hidden');}
// ìë™ ì§„í–‰ (2ì´ˆ í›„)
setTimeout(()=>nextTyping(),2000);
}
document.getElementById('typing-input')?.addEventListener('keypress',e=>{if(e.key==='Enter')checkTyping();});
function nextTyping(){typingState.idx++;showTypingQ();}
function confirmEndTyping(){if(typingState.idx<typingState.words.length||typingState.retryQueue.length>0||typingState.finalQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endTyping);else endTyping();}
async function endTyping(){
const ans=typingState.correct+typingState.wrong;if(ans===0){showPage('home');return;}
const acc=Math.round((typingState.correct/ans)*100);
await saveSession({total:ans,correct:typingState.correct,wrong:typingState.wrong,accuracy:acc,mode:'typing',type:'vocab',duration:Math.round((Date.now()-typingState.start)/1000)});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=typingState.correct;document.getElementById('qc-wrong').textContent=typingState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(typingState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=typingState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// === Cloze (ë¹ˆì¹¸ì±„ìš°ê¸°) ===
function startCloze(items,all){
// ì˜ˆë¬¸ì´ ìˆê³  ë‹¨ì–´ê°€ í¬í•¨ëœ ê²½ìš°ë§Œ í•„í„°
const valid=items.filter(w=>{
const ex=getEx(w);
const userEx=w.userExamples||[];
const allEx=[ex,...userEx].filter(e=>e&&e.trim());
// ë‹¨ì–´ê°€ ì‹¤ì œë¡œ ì˜ˆë¬¸ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ì²´í¬
const regex=new RegExp('\\b'+w.word+'\\b','i');
return allEx.some(e=>regex.test(e));
});
if(valid.length<5){showToast('âš ï¸ ìœ íš¨í•œ ì˜ˆë¬¸ì´ ìˆëŠ” ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (5ê°œ ì´ìƒ í•„ìš”)');return;}
clozeState={words:valid,allWords:all,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
document.getElementById('cloze-total').textContent=valid.length;
showPage('cloze');showClozeQ();
}
function showClozeQ(){
if(clozeState.idx>=clozeState.words.length){
if(clozeState.retryQueue.length>0){clozeState.words=clozeState.retryQueue;clozeState.retryQueue=[];clozeState.idx=0;clozeState.phase='retry';showClozeQ();return;}
if(clozeState.finalQueue.length>0){clozeState.words=clozeState.finalQueue;clozeState.finalQueue=[];clozeState.idx=0;clozeState.phase='final';showClozeQ();return;}
endCloze();return;
}
const w=clozeState.words[clozeState.idx];
document.getElementById('cloze-progress').style.width=((clozeState.idx/clozeState.words.length)*100)+'%';
document.getElementById('cloze-current').textContent=clozeState.idx+1;
document.getElementById('cloze-correct').textContent=clozeState.correct;
document.getElementById('cloze-wrong').textContent=clozeState.wrong;
// ì˜ˆë¬¸ ê°€ì ¸ì˜¤ê¸° (ë‹¨ì–´ê°€ í¬í•¨ëœ ì˜ˆë¬¸ë§Œ)
const regex=new RegExp('\\b'+w.word+'\\b','gi');
const allEx=[getEx(w),...(w.userExamples||[])].filter(e=>e&&regex.test(e));
const ex=allEx[Math.floor(Math.random()*allEx.length)];
// ë‹¨ì–´ë¥¼ ë¹ˆì¹¸ìœ¼ë¡œ ëŒ€ì²´
const blanked=ex.replace(regex,'<span class="blank-word" style="border-bottom:2px dashed var(--primary);padding:2px 20px;color:var(--primary)">_____</span>');
document.getElementById('cloze-sentence').innerHTML=blanked;
document.getElementById('cloze-hint').textContent=getMKO(w)||'';
// ì„ íƒì§€ ìƒì„±
const pool=clozeState.allWords.filter(x=>x.word!==w.word);
const dist=getDistractors(w,pool,4).map(x=>x.word);
const opts=shuffle([w.word,...dist]);
document.getElementById('cloze-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectCloze(this,'${o.replace(/'/g,"\\'")}')" data-ans="${o===w.word}">${o}</button>`).join('');
clozeState.answered=false;clozeState.correctAns=w.word;
document.getElementById('cloze-next-btn').classList.add('hidden');
}
async function selectCloze(el,selected){
if(clozeState.answered)return;clozeState.answered=true;
const w=clozeState.words[clozeState.idx];
const ok=selected===w.word;
if(ok)clozeState.correct++;else{clozeState.wrong++;if(clozeState.phase==='normal')clozeState.retryQueue.push({...w});else if(clozeState.phase==='retry')clozeState.finalQueue.push({...w});else{updateWrong(w,false);clozeState.savedToWrong++;}}
document.querySelectorAll('#cloze-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
// ë¹ˆì¹¸ì— ì •ë‹µ í‘œì‹œ
document.querySelectorAll('#cloze-sentence .blank-word').forEach(b=>{b.textContent=w.word;b.style.color=ok?'var(--success)':'var(--danger)';});
w.reviewCount=(w.reviewCount||0)+1;if(ok)w.correctCount=(w.correctCount||0)+1;
updateMastery(w,ok);if(ok)updateWrong(w,true);Object.assign(w,calcNext(w,ok?2:0));await saveWord(w);
vibrate(ok?10:[50,30,50]);
document.getElementById('cloze-correct').textContent=clozeState.correct;
document.getElementById('cloze-wrong').textContent=clozeState.wrong;
setTimeout(()=>nextCloze(),1500);
}
function nextCloze(){clozeState.idx++;showClozeQ();}
function confirmEndCloze(){if(clozeState.idx<clozeState.words.length||clozeState.retryQueue.length>0||clozeState.finalQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endCloze);else endCloze();}
async function endCloze(){
const ans=clozeState.correct+clozeState.wrong;if(ans===0){showPage('home');return;}
const acc=Math.round((clozeState.correct/ans)*100);
await saveSession({total:ans,correct:clozeState.correct,wrong:clozeState.wrong,accuracy:acc,mode:'cloze',type:'vocab',duration:Math.round((Date.now()-clozeState.start)/1000)});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=clozeState.correct;document.getElementById('qc-wrong').textContent=clozeState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(clozeState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=clozeState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// === Collocation í€´ì¦ˆ ===
function startColloc(items,all){
// collocationì´ ìˆê³  ë‹¨ì–´ê°€ í¬í•¨ëœ ê²½ìš°ë§Œ í•„í„°
const valid=items.filter(w=>{
const colls=[w.Key_Collocation,...(w.userCollocations||[])].filter(c=>c&&c.trim());
const regex=new RegExp('\\b'+w.word+'\\b','i');
return colls.some(c=>regex.test(c));
});
if(valid.length<5){showToast('âš ï¸ ìœ íš¨í•œ Collocationì´ ìˆëŠ” ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (5ê°œ ì´ìƒ í•„ìš”)');return;}
collocState={words:valid,allWords:all,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
document.getElementById('colloc-total').textContent=valid.length;
showPage('collocation');showCollocQ();
}
function showCollocQ(){
if(collocState.idx>=collocState.words.length){
if(collocState.retryQueue.length>0){collocState.words=collocState.retryQueue;collocState.retryQueue=[];collocState.idx=0;collocState.phase='retry';showCollocQ();return;}
if(collocState.finalQueue.length>0){collocState.words=collocState.finalQueue;collocState.finalQueue=[];collocState.idx=0;collocState.phase='final';showCollocQ();return;}
endColloc();return;
}
const w=collocState.words[collocState.idx];
const dw=displayWord(w.word); // í‘œì‹œìš© ë‹¨ì–´
document.getElementById('colloc-progress').style.width=((collocState.idx/collocState.words.length)*100)+'%';
document.getElementById('colloc-current').textContent=collocState.idx+1;
document.getElementById('colloc-correct').textContent=collocState.correct;
document.getElementById('colloc-wrong').textContent=collocState.wrong;
// Collocation ê°€ì ¸ì˜¤ê¸° (ë‹¨ì–´ê°€ í¬í•¨ëœ ê²ƒë§Œ)
const regex=new RegExp('\\b'+dw+'\\b','gi');
const allColls=[w.Key_Collocation,...(w.userCollocations||[])].filter(c=>c&&regex.test(c));
const coll=allColls[Math.floor(Math.random()*allColls.length)];
// ë‹¨ì–´ë¥¼ ë¹ˆì¹¸ìœ¼ë¡œ ëŒ€ì²´
const blanked=coll.replace(regex,'_____');
document.getElementById('colloc-question').innerHTML=blanked;
document.getElementById('colloc-meaning').textContent=getMKO(w)||'';
// ì„ íƒì§€ ìƒì„±
const pool=collocState.allWords.filter(x=>x.word!==w.word);
const dist=getDistractors(w,pool,4).map(x=>displayWord(x.word));
const opts=shuffle([dw,...dist]);
document.getElementById('colloc-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectColloc(this,'${o.replace(/'/g,"\\'")}')" data-ans="${o===dw}">${o}</button>`).join('');
collocState.answered=false;collocState.correctAns=dw;
document.getElementById('colloc-next-btn').classList.add('hidden');
}
async function selectColloc(el,selected){
if(collocState.answered)return;collocState.answered=true;
const w=collocState.words[collocState.idx];
const dw=displayWord(w.word);
const ok=selected===dw;
if(ok)collocState.correct++;else{collocState.wrong++;if(collocState.phase==='normal')collocState.retryQueue.push({...w});else if(collocState.phase==='retry')collocState.finalQueue.push({...w});else{updateWrong(w,false);collocState.savedToWrong++;}}
document.querySelectorAll('#colloc-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
// ë¹ˆì¹¸ì— ì •ë‹µ í‘œì‹œ
const qEl=document.getElementById('colloc-question');
qEl.innerHTML=qEl.innerHTML.replace('_____',`<span style="color:${ok?'var(--success)':'var(--danger)'};">${dw}</span>`);
w.reviewCount=(w.reviewCount||0)+1;if(ok)w.correctCount=(w.correctCount||0)+1;
updateMastery(w,ok);if(ok)updateWrong(w,true);Object.assign(w,calcNext(w,ok?2:0));await saveWord(w);
vibrate(ok?10:[50,30,50]);
document.getElementById('colloc-correct').textContent=collocState.correct;
document.getElementById('colloc-wrong').textContent=collocState.wrong;
setTimeout(()=>nextColloc(),1500);
}
function nextColloc(){collocState.idx++;showCollocQ();}
function confirmEndColloc(){if(collocState.idx<collocState.words.length||collocState.retryQueue.length>0||collocState.finalQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endColloc);else endColloc();}
async function endColloc(){
const ans=collocState.correct+collocState.wrong;if(ans===0){showPage('home');return;}
const acc=Math.round((collocState.correct/ans)*100);
await saveSession({total:ans,correct:collocState.correct,wrong:collocState.wrong,accuracy:acc,mode:'collocation',type:'vocab',duration:Math.round((Date.now()-collocState.start)/1000)});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=collocState.correct;document.getElementById('qc-wrong').textContent=collocState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(collocState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=collocState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}

// === PV í•™ìŠµ ===
async function startPVStudySession(){
const p=await getAllPV();if(!p.length){showToast('ğŸ“¤ ë¨¼ì € êµ¬ë™ì‚¬ DBë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
const count=parseInt(document.getElementById('pv-study-count').value),filter=getChip('pv-filter-mastery'),cat=document.getElementById('pv-filter-cat').value,order=document.getElementById('option-order').value;
const now=new Date();
let filtered=p.filter(x=>{
if(cat!=='all'&&x.Category!==cat)return false;
const rc=x.reviewCount||0;
if(filter==='new'&&rc>0)return false;
if(filter==='weak'&&!isWeak(x))return false;
if(filter==='wrong'&&!isWrong(x))return false;
if(filter==='starred'&&!x.starred)return false;
// â˜… ì—„ê²©í•œ SM-2: ìƒˆ ë‹¨ì–´ì´ê±°ë‚˜, ë³µìŠµ ì˜ˆì •ì¼ì´ ì§€ë‚œ ê²ƒë§Œ
if(rc>0&&x.nextReview&&new Date(x.nextReview)>now)return false;
return true;
});
if(!filtered.length){showToast('âš ï¸ ë³µìŠµí•  êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
// ì •ë ¬
if(order==='random')filtered=shuffle(filtered);
else if(order==='sm2'){
filtered=sortByFSRSPriority(filtered,now);
}
else if(order==='weak')filtered.sort((a,b)=>getWeaknessScore(a)-getWeaknessScore(b));
let sel=filtered.slice(0,count);
const mode=document.querySelector('#study-phrasal .mode-card.active')?.dataset.mode||'pv-flashcard';
// â˜… ì˜¤ë‹µ ìë™ í¬í•¨
const wrongAutoEnabled=localStorage.getItem('wrongAuto')!=='false';
if(wrongAutoEnabled&&mode==='pv-flashcard'){
const wrongLimit=parseInt(localStorage.getItem('wrongLimit')||'5');
const wrongBonus=Math.min(wrongLimit,Math.floor(count/5));
if(wrongBonus>0){
const wrongPVs=p.filter(x=>isWrong(x)&&!sel.includes(x));
const wrongToAdd=shuffle(wrongPVs).slice(0,wrongBonus);
if(wrongToAdd.length>0){
wrongToAdd.forEach(w=>{
const insertIdx=Math.floor(Math.random()*(sel.length+1));
sel.splice(insertIdx,0,w);
});
showToast(`ğŸ“ ì˜¤ë‹µ ${wrongToAdd.length}ê°œ í¬í•¨`);
}
}
}
if(mode==='pv-flashcard')startFC(sel,p,'phrasal');
else if(mode==='pv-particle'){const v=sel.filter(x=>x.Particle?.trim());if(v.length<5){showToast('âš ï¸ Particleì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}startPVP(v,p);}
else if(mode==='pv-meaning'){const v=sel.filter(x=>getMKO(x));if(v.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}startPVQ(v,p,'meaning');}
else if(mode==='pv-reverse'){const v=sel.filter(x=>getMKO(x));if(v.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}startPVQ(v,p,'reverse');}
}
// PV Particle
function startPVP(items,all){
const v=items.filter(x=>x.Particle?.trim());if(v.length<5){showToast('âš ï¸ Particleì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
pvState={words:[...v],allWords:all||items,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),mode:'particle',retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
document.getElementById('pvp-total').textContent=v.length;document.getElementById('pvp-retry-banner').classList.add('hidden');
showPage('pv-particle');showPVPQ();updateStreak();
}
function showPVPQ(){
if(pvState.idx>=pvState.words.length){
  if(pvState.retryQueue.length>0&&pvState.phase==='normal'){pvState.words=[...pvState.retryQueue];pvState.retryQueue=[];pvState.idx=0;pvState.phase='retry';document.getElementById('pvp-retry-banner').classList.remove('hidden');document.getElementById('pvp-retry-count').textContent=pvState.words.length;showToast('ğŸ”„ ì˜¤ë‹µ '+pvState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else if(pvState.finalQueue.length>0&&pvState.phase==='retry'){pvState.words=[...pvState.finalQueue];pvState.finalQueue=[];pvState.idx=0;pvState.phase='final';document.getElementById('pvp-retry-count').textContent=pvState.words.length;showToast('âš ï¸ ìµœì¢… '+pvState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else{endPVQuiz();return;}
}
const pv=pvState.words[pvState.idx];if(!pv)return;
document.getElementById('pvp-progress').style.width=(pvState.idx/pvState.words.length)*100+'%';
document.getElementById('pvp-current').textContent=pvState.idx+1;document.getElementById('pvp-total').textContent=pvState.words.length;
document.getElementById('pvp-correct').textContent=pvState.correct;document.getElementById('pvp-wrong').textContent=pvState.wrong;
if(pvState.phase!=='normal')document.getElementById('pvp-retry-count').textContent=pvState.words.length-pvState.idx;
document.getElementById('pvp-meaning').textContent=getMKO(pv)||'';
const base=pv.Base_Verb||pv.Phrasal_Verb?.split(' ')[0]||'';
document.getElementById('pvp-question').innerHTML=base+' + <span class="blank-word">?</span>';
const cP=(pv.Particle||'').trim();const wP=shuffle(PARTICLES.filter(x=>x!==cP)).slice(0,4);
const opts=shuffle([cP,...wP]);
document.getElementById('pvp-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectPVP(this)" data-ans="${o===cP}">${o}</button>`).join('');
pvState.answered=false;pvState.correctAns=cP;document.getElementById('pvp-next-btn').classList.add('hidden');
document.getElementById('pvp-example').classList.add('hidden');
document.getElementById('pvp-rating-bar').classList.add('hidden');
updatePVPBookmarkBtn();
}
async function selectPVP(el){
if(pvState.answered)return;pvState.answered=true;
const ok=el.dataset.ans==='true';
const pv=pvState.words[pvState.idx];
if(ok)pvState.correct++;else{pvState.wrong++;if(pvState.phase==='normal')pvState.retryQueue.push({...pv});else if(pvState.phase==='retry')pvState.finalQueue.push({...pv});else{updateWrong(pv,false);pvState.savedToWrong++;}}
document.querySelectorAll('#pvp-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
const blank=document.querySelector('#page-pv-particle .blank-word');if(blank){blank.textContent=pvState.correctAns;blank.style.borderBottom='none';blank.style.color=ok?'var(--success)':'var(--danger)';}
pv.reviewCount=(pv.reviewCount||0)+1;if(ok)pv.correctCount=(pv.correctCount||0)+1;
updateMastery(pv,ok);
if(!ok){updateWrong(pv,false);Object.assign(pv,calcNext(pv,0));await savePV(pv);}
vibrate(ok?10:[50,30,50]);
document.getElementById('pvp-correct').textContent=pvState.correct;document.getElementById('pvp-wrong').textContent=pvState.wrong;
const pvEx=getEx(pv);if(pvEx){document.getElementById('pvp-example').textContent=pvEx;document.getElementById('pvp-example').classList.remove('hidden');}
if(ok){showQuizRating('pvp',2000);}else{setTimeout(()=>nextPVP(),1500);}
}
async function ratePVPItem(grade){
clearInterval(quizRatingTimer);
const pv=pvState.words[pvState.idx];
Object.assign(pv,calcNext(pv,grade));await savePV(pv);
document.getElementById('pvp-rating-bar').classList.add('hidden');
nextPVP();
}
function nextPVP(){pvState.idx++;showPVPQ();}

// PV Quiz
function startPVQ(items,all,mode){
const m=items.filter(x=>getMKO(x));if(m.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
pvState={words:[...m],allWords:all||items,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),mode,retryQueue:[],finalQueue:[],phase:'normal',savedToWrong:0};
document.getElementById('pvq-total').textContent=m.length;document.getElementById('pvq-retry-banner').classList.add('hidden');
showPage('pv-quiz');showPVQQ();updateStreak();
}
function showPVQQ(){
if(pvState.idx>=pvState.words.length){
  if(pvState.retryQueue.length>0&&pvState.phase==='normal'){pvState.words=[...pvState.retryQueue];pvState.retryQueue=[];pvState.idx=0;pvState.phase='retry';document.getElementById('pvq-retry-banner').classList.remove('hidden');document.getElementById('pvq-retry-count').textContent=pvState.words.length;showToast('ğŸ”„ ì˜¤ë‹µ '+pvState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else if(pvState.finalQueue.length>0&&pvState.phase==='retry'){pvState.words=[...pvState.finalQueue];pvState.finalQueue=[];pvState.idx=0;pvState.phase='final';document.getElementById('pvq-retry-count').textContent=pvState.words.length;showToast('âš ï¸ ìµœì¢… '+pvState.words.length+'ê°œ ì¬ì¶œì œ!');}
  else{endPVQuiz();return;}
}
const pv=pvState.words[pvState.idx];if(!pv)return;
document.getElementById('pvq-progress').style.width=(pvState.idx/pvState.words.length)*100+'%';
document.getElementById('pvq-current').textContent=pvState.idx+1;document.getElementById('pvq-total').textContent=pvState.words.length;
document.getElementById('pvq-correct').textContent=pvState.correct;document.getElementById('pvq-wrong').textContent=pvState.wrong;
if(pvState.phase!=='normal')document.getElementById('pvq-retry-count').textContent=pvState.words.length-pvState.idx;
const isRev=pvState.mode==='reverse';
if(isRev){document.getElementById('pvq-word').textContent=getMKO(pv);document.getElementById('pvq-sub').textContent='êµ¬ë™ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”';document.getElementById('pvq-tags').innerHTML='';}
else{document.getElementById('pvq-word').textContent=pv.Phrasal_Verb||'';document.getElementById('pvq-sub').textContent='';document.getElementById('pvq-tags').innerHTML=`<span class="tag tag-phrasal">${pv.Particle||''}</span><span class="tag tag-cat">${pv.Category||''}</span>`;}
const pool=pvState.allWords.filter(x=>x.Phrasal_Verb!==pv.Phrasal_Verb&&getMKO(x));
const dist=getDistractors(pv,pool,4);const cAns=isRev?pv.Phrasal_Verb:getMKO(pv);const wAns=dist.map(x=>isRev?x.Phrasal_Verb:getMKO(x)).filter(x=>x);
const opts=shuffle([cAns,...wAns]);
document.getElementById('pvq-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectPVQ(this)" data-ans="${o===cAns}">${o}</button>`).join('');
pvState.answered=false;pvState.correctAns=cAns;document.getElementById('pvq-next-btn').classList.add('hidden');
document.getElementById('pvq-example').classList.add('hidden');
document.getElementById('pvq-rating-bar').classList.add('hidden');
updatePVQBookmarkBtn();
}
async function selectPVQ(el){
if(pvState.answered)return;pvState.answered=true;
const ok=el.dataset.ans==='true';
const pv=pvState.words[pvState.idx];
if(ok)pvState.correct++;else{pvState.wrong++;if(pvState.phase==='normal')pvState.retryQueue.push({...pv});else if(pvState.phase==='retry')pvState.finalQueue.push({...pv});else{updateWrong(pv,false);pvState.savedToWrong++;}}
document.querySelectorAll('#pvq-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
pv.reviewCount=(pv.reviewCount||0)+1;if(ok)pv.correctCount=(pv.correctCount||0)+1;
updateMastery(pv,ok);
if(!ok){updateWrong(pv,false);Object.assign(pv,calcNext(pv,0));await savePV(pv);}
vibrate(ok?10:[50,30,50]);
document.getElementById('pvq-correct').textContent=pvState.correct;document.getElementById('pvq-wrong').textContent=pvState.wrong;
const pvqEx=getEx(pv);if(pvqEx){document.getElementById('pvq-example').textContent=pvqEx;document.getElementById('pvq-example').classList.remove('hidden');}
if(ok){showQuizRating('pvq',2000);}else{setTimeout(()=>nextPVQ(),1500);}
}
async function ratePVQItem(grade){
clearInterval(quizRatingTimer);
const pv=pvState.words[pvState.idx];
Object.assign(pv,calcNext(pv,grade));await savePV(pv);
document.getElementById('pvq-rating-bar').classList.add('hidden');
nextPVQ();
}
function nextPVQ(){pvState.idx++;if(pvState.mode==='particle')showPVPQ();else showPVQQ();}
function confirmEndPVQuiz(){if(pvState.idx<pvState.words.length||pvState.retryQueue.length>0||pvState.finalQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endPVQuiz);else endPVQuiz();}
async function endPVQuiz(){
const ans=pvState.correct+pvState.wrong;if(ans===0){showPage('home');return;}
const acc=Math.round((pvState.correct/ans)*100);
await saveSession({total:ans,correct:pvState.correct,wrong:pvState.wrong,accuracy:acc,mode:'pv-'+pvState.mode,type:'phrasal',duration:Math.round((Date.now()-pvState.start)/1000)});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=pvState.correct;document.getElementById('qc-wrong').textContent=pvState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
if(pvState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=pvState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
// === Leitner Box í•™ìŠµ ===
async function startBoxStudy(box,type){
if(type==='phrasal'){
const p=await getAllPV();
const boxItems=p.filter(x=>(x.leitnerBox||1)===box);
if(!boxItems.length){showToast(`âš ï¸ Box ${box}ì— êµ¬ë™ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤`);return;}
showBoxStudyModal(box,boxItems.length,'phrasal');
}else{
const w=await getAllWords();
const boxItems=w.filter(x=>(x.leitnerBox||1)===box);
if(!boxItems.length){showToast(`âš ï¸ Box ${box}ì— ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤`);return;}
showBoxStudyModal(box,boxItems.length,'vocab');
}
}
function showBoxStudyModal(box,count,type){
const title=type==='phrasal'?'êµ¬ë™ì‚¬':'ì–´íœ˜';
document.getElementById('confirm-title').textContent=`ğŸ“¦ Box ${box} í•™ìŠµ`;
document.getElementById('confirm-msg').innerHTML=`<strong>${count}ê°œ</strong> ${title}ê°€ ìˆìŠµë‹ˆë‹¤.<br><br>
<div style="display:flex;gap:10px;margin-top:12px">
<button class="btn btn-secondary" onclick="startBoxFC(${box},'${type}')" style="flex:1">ğŸƒ í”Œë˜ì‹œì¹´ë“œ</button>
<button class="btn btn-primary" onclick="startBoxQuiz(${box},'${type}')" style="flex:1">â“ í€´ì¦ˆ</button>
</div>`;
document.getElementById('confirm-btn').style.display='none';
showModal('confirm-modal');
}
async function startBoxFC(box,type){
closeModal('confirm-modal');
document.getElementById('confirm-btn').style.display='';
if(type==='phrasal'){
const p=await getAllPV();
const items=shuffle(p.filter(x=>(x.leitnerBox||1)===box)).slice(0,30);
startFC(items,p,'phrasal');
}else{
const w=await getAllWords();
const items=shuffle(w.filter(x=>(x.leitnerBox||1)===box)).slice(0,30);
startFC(items,w,'vocab');
}
}
async function startBoxQuiz(box,type){
closeModal('confirm-modal');
document.getElementById('confirm-btn').style.display='';
if(type==='phrasal'){
const p=await getAllPV();
const items=shuffle(p.filter(x=>(x.leitnerBox||1)===box&&getMKO(x))).slice(0,20);
if(items.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” êµ¬ë™ì‚¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
startPVQ(items,p,'meaning');
}else{
const w=await getAllWords();
const items=shuffle(w.filter(x=>(x.leitnerBox||1)===box&&getMKO(x))).slice(0,20);
if(items.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
startQuiz(items,w,'quiz','vocab');
}
}

function updateStreak(){const today=new Date().toDateString(),last=localStorage.getItem('lastStudyDate');let streak=parseInt(localStorage.getItem('streak')||'0');if(last!==today){const y=new Date();y.setDate(y.getDate()-1);streak=(last===y.toDateString())?streak+1:1;localStorage.setItem('lastStudyDate',today);localStorage.setItem('streak',streak.toString());}const banner=document.getElementById('streak-banner');if(streak>0){banner.classList.remove('hidden');document.getElementById('streak-days').textContent=streak;}else banner.classList.add('hidden');}

// === ë¹ ë¥¸ ê²€ìƒ‰ & ë¶ë§ˆí¬ ===
let quickSearchResult=null;let quickSearchType=null;let quickSearchQuery='';
async function quickSearch(){
const q=document.getElementById('quick-search-input').value.trim();
const qLower=q.toLowerCase();
quickSearchQuery=q;
if(!q){document.getElementById('quick-search-result').style.display='none';return;}
const words=await getAllWords();
const pvs=await getAllPV();
// í†µí•© Fuzzy Search
const results=fuzzySearch(qLower,[...words.map(w=>({item:w,type:'vocab'})),...pvs.map(p=>({item:p,type:'phrasal'}))]);
if(results.length>0){
const best=results[0];
quickSearchResult=best.item;
quickSearchType=best.type;
showQuickResult(best.item,best.type,best.score>=80);
return;
}
// ëª» ì°¾ìŒ
quickSearchResult=null;quickSearchType=null;
document.getElementById('quick-search-result').style.display='block';
document.getElementById('quick-search-found').style.display='none';
document.getElementById('quick-search-notfound').style.display='block';
document.getElementById('qs-new-word').textContent=q;
document.getElementById('qs-new-meaning').value='';
document.getElementById('qs-add-bookmark').checked=true;
}
// 7. Fuzzy Search í•¨ìˆ˜
function fuzzySearch(query,items){
return items.map(({item,type})=>{
const word=(type==='phrasal'?(item.Phrasal_Verb||''):displayWord(getW(item))).toLowerCase();
let score=0;
if(word===query)score=100;
else if(word.startsWith(query))score=80;
else if(word.includes(query))score=60;
else if((getMKO(item)||'').toLowerCase().includes(query))score=40;
else{
// ê°„ë‹¨í•œ Levenshtein ê·¼ì‚¬ (ì˜¤íƒ€ í—ˆìš©)
const dist=Math.abs(word.length-query.length);
const common=[...query].filter(c=>word.includes(c)).length;
const similarity=common/Math.max(word.length,query.length);
if(similarity>0.6)score=30;
else if(similarity>0.4)score=15;
}
return{item,type,score};
}).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
}
async function quickSaveNewWord(){
const word=document.getElementById('qs-new-word').textContent.trim();
const meaning=document.getElementById('qs-new-meaning').value.trim();
if(!word){showToast('âŒ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
if(!meaning){showToast('âŒ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
const addBookmark=document.getElementById('qs-add-bookmark').checked;
const newWord={word:word,Meaning1_KO:meaning,L1:'General',Difficulty:2,starred:addBookmark,reviewCount:0,correctCount:0,mastery:0,leitnerBox:1,ease:2.5};
await saveWord(newWord);
document.getElementById('quick-search-result').style.display='none';
document.getElementById('quick-search-input').value='';
showToast(addBookmark?'âœ… ì €ì¥ + â­ ë¶ë§ˆí¬ ì¶”ê°€':'âœ… ì €ì¥ ì™„ë£Œ');
updateHomeStats();updateWordTable();
}
function showQuickResult(item,type,isExact){
document.getElementById('quick-search-result').style.display='block';
document.getElementById('quick-search-found').style.display='block';
document.getElementById('quick-search-notfound').style.display='none';
const word=type==='phrasal'?item.Phrasal_Verb:displayWord(item.word);
document.getElementById('qs-word').textContent=word;
document.getElementById('qs-meaning').textContent=getMKO(item)||getMEN(item)||'';
const info=type==='phrasal'?`${item.Category||'General'} | ${item.Formal_Equivalent||''}`:`${item.POS||''} | ${item.L1||'General'} | Lv.${item.Difficulty||2}`;
document.getElementById('qs-info').textContent=info;
// ì˜ˆë¬¸ í‘œì‹œ
const ex=getEx(item);
const exEl=document.getElementById('qs-example');
if(ex){exEl.textContent=ex;exEl.style.display='block';}else{exEl.style.display='none';}
// ë¶€ë¶„ ì¼ì¹˜ë©´ "ì°¾ëŠ” ë‹¨ì–´ê°€ ì•„ë‹Œê°€ìš”?" í‘œì‹œ
const notThis=document.getElementById('qs-not-this');
if(!isExact && quickSearchQuery.toLowerCase()!==word.toLowerCase()){
notThis.style.display='block';
document.getElementById('qs-original-query').textContent=quickSearchQuery;
}else{
notThis.style.display='none';
}
updateQuickBookmarkBtn();
updateQuickProductionBtn();
}
function showAddNewFromSearch(){
document.getElementById('quick-search-found').style.display='none';
document.getElementById('quick-search-notfound').style.display='block';
document.getElementById('qs-new-word').textContent=quickSearchQuery;
document.getElementById('qs-new-meaning').value='';
document.getElementById('qs-add-bookmark').checked=true;
}
function updateQuickBookmarkBtn(){
if(!quickSearchResult)return;
const btn=document.getElementById('qs-bookmark-btn');
btn.textContent=quickSearchResult.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
btn.style.color=quickSearchResult.starred?'var(--warning)':'';
}
function updateQuickProductionBtn(){
if(!quickSearchResult)return;
const btn=document.getElementById('qs-prod-btn');
btn.textContent=quickSearchResult.needsProduction?'âœ… ì‚°ì¶œí•´ì œ':'ğŸ–Šï¸ ì‚°ì¶œ';
btn.style.color=quickSearchResult.needsProduction?'var(--success)':'';
}
function speakQSWord(){
if(!quickSearchResult)return;
const word=quickSearchType==='phrasal'?quickSearchResult.Phrasal_Verb:quickSearchResult.word;
const u=new SpeechSynthesisUtterance(word);
u.lang='en-US';u.rate=0.9;
speechSynthesis.cancel();speechSynthesis.speak(u);
}
async function quickToggleProduction(){
if(!quickSearchResult)return;
quickSearchResult.needsProduction=!quickSearchResult.needsProduction;
if(quickSearchType==='phrasal')await savePV(quickSearchResult);
else await saveWord(quickSearchResult);
updateQuickProductionBtn();
showToast(quickSearchResult.needsProduction?'ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ì¶”ê°€':'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ');
updateHomeStats();
}
async function quickEditWord(){
if(!quickSearchResult)return;
const key=quickSearchType==='phrasal'?quickSearchResult.Phrasal_Verb:quickSearchResult.word;
document.getElementById('quick-search-result').style.display='none';
await openEditModal(key,quickSearchType);
}
async function quickToggleBookmark(){
if(!quickSearchResult)return;
quickSearchResult.starred=!quickSearchResult.starred;
if(quickSearchType==='phrasal')await savePV(quickSearchResult);
else await saveWord(quickSearchResult);
updateQuickBookmarkBtn();
showToast(quickSearchResult.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}
function quickAddWord(){
const q=document.getElementById('quick-search-input').value.trim();
document.getElementById('quick-search-result').style.display='none';
document.getElementById('add-word').value=q;
openAddWordModal();
}

// === êµ¬ë™ì‚¬ ë¹ ë¥¸ ê²€ìƒ‰ ===
let pvQSResult=null;let pvQSQuery='';
async function pvQuickSearch(){
const q=document.getElementById('pv-quick-search-input').value.trim();
const qLower=q.toLowerCase();
pvQSQuery=q;
if(!q){document.getElementById('pv-quick-search-result').style.display='none';return;}
const pvs=await getAllPV();
// ì •í™• ì¼ì¹˜
let found=pvs.find(p=>(p.Phrasal_Verb||'').toLowerCase()===qLower);
if(found){pvQSResult=found;showPVQSResult(found,true);return;}
// ë¶€ë¶„ ì¼ì¹˜
found=pvs.find(p=>(p.Phrasal_Verb||'').toLowerCase().includes(qLower)||qLower.includes((p.Phrasal_Verb||'').toLowerCase()));
if(found){pvQSResult=found;showPVQSResult(found,false);return;}
// ëª» ì°¾ìŒ
pvQSResult=null;
document.getElementById('pv-quick-search-result').style.display='block';
document.getElementById('pv-qs-found').style.display='none';
document.getElementById('pv-qs-notfound').style.display='block';
document.getElementById('pv-qs-new-word').textContent=q;
document.getElementById('pv-qs-new-meaning').value='';
document.getElementById('pv-qs-add-bookmark').checked=true;
}
function showPVQSResult(item,isExact){
document.getElementById('pv-quick-search-result').style.display='block';
document.getElementById('pv-qs-found').style.display='block';
document.getElementById('pv-qs-notfound').style.display='none';
document.getElementById('pv-qs-word').textContent=item.Phrasal_Verb;
document.getElementById('pv-qs-meaning').textContent=getMKO(item)||getMEN(item)||'';
document.getElementById('pv-qs-info').textContent=`${item.Category||'General'} | ${item.Formal_Equivalent||''}`;
const ex=getEx(item);
const exEl=document.getElementById('pv-qs-example');
if(ex){exEl.textContent=ex;exEl.style.display='block';}else{exEl.style.display='none';}
const notThis=document.getElementById('pv-qs-not-this');
if(!isExact&&pvQSQuery.toLowerCase()!==(item.Phrasal_Verb||'').toLowerCase()){
notThis.style.display='block';
document.getElementById('pv-qs-original').textContent=pvQSQuery;
}else{notThis.style.display='none';}
updatePVQSBtns();
}
function updatePVQSBtns(){
if(!pvQSResult)return;
const bBtn=document.getElementById('pv-qs-bookmark-btn');
bBtn.textContent=pvQSResult.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
bBtn.style.color=pvQSResult.starred?'var(--warning)':'';
const pBtn=document.getElementById('pv-qs-prod-btn');
pBtn.textContent=pvQSResult.needsProduction?'âœ… ì‚°ì¶œí•´ì œ':'ğŸ–Šï¸ ì‚°ì¶œ';
pBtn.style.color=pvQSResult.needsProduction?'var(--success)':'';
}
function speakPVQSWord(){
if(!pvQSResult)return;
const u=new SpeechSynthesisUtterance(pvQSResult.Phrasal_Verb);
u.lang='en-US';u.rate=0.9;
speechSynthesis.cancel();speechSynthesis.speak(u);
}
async function pvQSToggleBookmark(){
if(!pvQSResult)return;
pvQSResult.starred=!pvQSResult.starred;
await savePV(pvQSResult);
updatePVQSBtns();
showToast(pvQSResult.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}
async function pvQSToggleProduction(){
if(!pvQSResult)return;
pvQSResult.needsProduction=!pvQSResult.needsProduction;
await savePV(pvQSResult);
updatePVQSBtns();
showToast(pvQSResult.needsProduction?'ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ì¶”ê°€':'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ');
updateHomeStats();
}
async function pvQSEdit(){
if(!pvQSResult)return;
document.getElementById('pv-quick-search-result').style.display='none';
await openEditModal(pvQSResult.Phrasal_Verb,'phrasal');
}
function showPVAddNew(){
document.getElementById('pv-qs-found').style.display='none';
document.getElementById('pv-qs-notfound').style.display='block';
document.getElementById('pv-qs-new-word').textContent=pvQSQuery;
document.getElementById('pv-qs-new-meaning').value='';
document.getElementById('pv-qs-add-bookmark').checked=true;
}
async function pvQSSaveNew(){
const pv=document.getElementById('pv-qs-new-word').textContent.trim();
const meaning=document.getElementById('pv-qs-new-meaning').value.trim();
if(!pv){showToast('âŒ êµ¬ë™ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
if(!meaning){showToast('âŒ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
const addBookmark=document.getElementById('pv-qs-add-bookmark').checked;
// Base verb, particle ìë™ ì¶”ì¶œ
const parts=pv.split(' ');
const baseVerb=parts[0]||'';
const particle=parts.slice(1).join(' ')||'';
const newPV={Phrasal_Verb:pv,Base_Verb:baseVerb,Particle:particle,Meaning1_KO:meaning,Category:'General',starred:addBookmark,reviewCount:0,correctCount:0,mastery:0,leitnerBox:1,ease:2.5};
await savePV(newPV);
document.getElementById('pv-quick-search-result').style.display='none';
document.getElementById('pv-quick-search-input').value='';
showToast(addBookmark?'âœ… ì €ì¥ + â­ ë¶ë§ˆí¬ ì¶”ê°€':'âœ… ì €ì¥ ì™„ë£Œ');
updateHomeStats();updateWordTable();
}
function pvQSAddDetail(){
const q=document.getElementById('pv-quick-search-input').value.trim();
document.getElementById('pv-quick-search-result').style.display='none';
switchAddType('phrasal');
document.getElementById('add-word').value=q;
openAddWordModal();
}

// === í‘œí˜„ (Expressions) ===
let exprQSResult=null;let exprQSQuery='';let exprRegisterFilter='all';
async function startExprFC(){
const exprs=await getAllExpr();
if(!exprs.length){showToast('ğŸ’¬ í‘œí˜„ DBê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
const now=new Date();
let filtered=exprRegisterFilter==='all'?exprs:exprs.filter(e=>e.Register===exprRegisterFilter);
// â˜… ì—„ê²©í•œ SM-2 í•„í„°
filtered=filtered.filter(x=>!x.reviewCount||(x.nextReview&&new Date(x.nextReview)<=now));
if(!filtered.length){showToast('âœ… ì˜¤ëŠ˜ ë³µìŠµí•  í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
exprState={words:shuffle(filtered).slice(0,20),allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null};
document.getElementById('expr-fc-total').textContent=exprState.words.length;
document.getElementById('expr-retry-banner').classList.add('hidden');
showPage('expr-fc');startExprTimer();showExprCard();
}
async function startExprCloze(){
const exprs=await getAllExpr();
const now=new Date();
let valid=exprs.filter(e=>{const ex=getEx(e);return ex&&ex.toLowerCase().includes(e.Expression.toLowerCase().split(' ')[0]);});
valid=valid.filter(x=>!x.reviewCount||(x.nextReview&&new Date(x.nextReview)<=now));
if(!valid.length){showToast('âš ï¸ ë³µìŠµí•  ë¹ˆì¹¸ì±„ìš°ê¸° í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
exprState={words:shuffle(valid).slice(0,20),allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0};
showPage('expr-cloze');showExprClozeQ();
}
async function startExprQuizQuick(){
const exprs=await getAllExpr();
const now=new Date();
let valid=exprs.filter(e=>getMKO(e)&&(!e.reviewCount||(e.nextReview&&new Date(e.nextReview)<=now)));
if(valid.length<5){showToast('âš ï¸ ë³µìŠµí•  í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
let filtered=exprRegisterFilter==='all'?valid:valid.filter(e=>e.Register===exprRegisterFilter);
if(filtered.length<5){showToast('âš ï¸ í•´ë‹¹ í•„í„°ì— ë§ëŠ” í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
exprState={words:shuffle(filtered).slice(0,20),allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0};
document.getElementById('expr-quiz-total').textContent=exprState.words.length;
document.getElementById('expr-quiz-retry-banner').classList.add('hidden');
showPage('expr-quiz');showExprQuizQ();
}
async function startExprWrong(){
const exprs=await getAllExpr();
const wrong=exprs.filter(e=>isWrong(e));
if(!wrong.length){showToast('âœ… ì˜¤ë‹µë…¸íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
exprState={words:shuffle(wrong).slice(0,20),allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null};
document.getElementById('expr-fc-total').textContent=exprState.words.length;
document.getElementById('expr-retry-banner').classList.add('hidden');
showToast('ğŸ“ ì˜¤ë‹µ '+wrong.length+'ê°œ ë³µìŠµ!');
showPage('expr-fc');startExprTimer();showExprCard();
}
async function startExprStarred(){
const exprs=await getAllExpr();
const starred=exprs.filter(e=>e.starred);
if(!starred.length){showToast('â­ ë¶ë§ˆí¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
exprState={words:shuffle(starred).slice(0,20),allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null};
document.getElementById('expr-fc-total').textContent=exprState.words.length;
document.getElementById('expr-retry-banner').classList.add('hidden');
showToast('â­ ë¶ë§ˆí¬ '+starred.length+'ê°œ í•™ìŠµ!');
showPage('expr-fc');startExprTimer();showExprCard();
}
async function startExprTagStudy(){
const sel=document.getElementById('home-expr-tag-select');
const tag=sel?.value;if(!tag){return;}
const exprs=await getAllExpr();
const tagged=exprs.filter(e=>(e.tags||[]).includes(tag));
if(!tagged.length){showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤');sel.value='';return;}
exprState={words:shuffle(tagged).slice(0,20),allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null};
document.getElementById('expr-fc-total').textContent=exprState.words.length;
document.getElementById('expr-retry-banner').classList.add('hidden');
showToast('ğŸ·ï¸ '+tag+' '+tagged.length+'ê°œ í•™ìŠµ!');
showPage('expr-fc');startExprTimer();showExprCard();
sel.value='';
}
async function startExprClozeQuick(){
const exprs=await getAllExpr();
const valid=exprs.filter(e=>{const ex=getEx(e);return ex&&ex.toLowerCase().includes(e.Expression.toLowerCase().split(' ')[0]);});
if(valid.length<5){showToast('âš ï¸ ë¹ˆì¹¸ì±„ìš°ê¸° ê°€ëŠ¥í•œ í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
exprState={words:shuffle(valid).slice(0,20),allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0};
showPage('expr-cloze');showExprClozeQ();
}
async function startExprDue(){
const exprs=await getAllExpr();const now=new Date();
const due=exprs.filter(e=>e.nextReview&&new Date(e.nextReview)<=now);
if(!due.length){showToast('âœ… ë³µìŠµí•  í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤!');return;}
exprState={words:shuffle(due).slice(0,20),allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null};
document.getElementById('expr-fc-total').textContent=exprState.words.length;
document.getElementById('expr-retry-banner').classList.add('hidden');
showToast('ğŸ“… ë³µìŠµ '+due.length+'ê°œ!');
showPage('expr-fc');startExprTimer();showExprCard();
}
function startExprTimer(){
const el=document.getElementById('expr-fc-timer');
const s=Date.now();
if(exprState.timer)clearInterval(exprState.timer);
exprState.timer=setInterval(()=>{
const sec=Math.floor((Date.now()-s)/1000);
el.textContent=Math.floor(sec/60)+':'+(sec%60).toString().padStart(2,'0');
},1000);
}
function showExprCard(){
const e=exprState.words[exprState.idx];
if(!e){
  if(exprState.retryQueue.length>0){
    exprState.words=[...exprState.retryQueue];exprState.retryQueue=[];exprState.idx=0;exprState.phase='retry';
    document.getElementById('expr-retry-banner').classList.remove('hidden');
    document.getElementById('expr-retry-count').textContent=exprState.words.length;
    document.getElementById('expr-fc-total').textContent=exprState.words.length;
    showToast('ğŸ”„ ëª¨ë¦„ '+exprState.words.length+'ê°œ ì¬ì¶œì œ!');
    showExprCard();return;
  }else{endExprFC();return;}
}
const card=document.getElementById('expr-fc-card');
// 1. ë’·ë©´ ë‚´ìš© ì¦‰ì‹œ ìˆ¨ê¹€
document.getElementById('expr-fc-back-inner').classList.remove('visible');
document.getElementById('expr-fc-meaning').textContent='';
document.getElementById('expr-fc-similar').innerHTML='';
document.getElementById('expr-fc-similar').style.display='none';
document.getElementById('expr-fc-example').textContent='';
document.getElementById('expr-fc-example').style.display='none';
document.getElementById('expr-fc-func').textContent='';
// 2. ì¹´ë“œ ë¦¬ì…‹
exprState.flipped=false;exprState.transitioning=false;
card.classList.remove('flipped');
setExprRating(false);
// 3. ì§„í–‰ë¥ 
document.getElementById('expr-fc-progress').style.width=(exprState.idx/exprState.words.length)*100+'%';
document.getElementById('expr-fc-current').textContent=exprState.idx+1;
if(exprState.phase==='retry')document.getElementById('expr-retry-count').textContent=exprState.words.length-exprState.idx;
// 4. ì•ë©´ (Functionì€ ë’·ë©´ì—ì„œë§Œ í‘œì‹œ)
document.getElementById('expr-fc-word').textContent=e.Expression||'';
document.getElementById('expr-fc-register').textContent=e.Register||'Neutral';
if(document.getElementById('setting-tts')?.checked)setTimeout(()=>speakExpr(),300);
updateExprFCBookmarkBtn();
updateExprFCTagBtn();
updateExprFCProductionBtn();
updateExprFCPrevBtn();
}
// ì´ì „ í‘œí˜„ ì¹´ë“œë¡œ ëŒì•„ê°€ê¸°
function prevExprCard(){
if(exprState.idx<=0)return;
exprState.idx--;
showExprCard();
}
function updateExprFCPrevBtn(){
const btn=document.getElementById('expr-fc-prev-btn');
if(btn){
btn.disabled=exprState.idx<=0;
btn.style.opacity=exprState.idx<=0?'0.4':'1';
}
}

function flipExprCard(){
if(exprState.transitioning)return;
const e=exprState.words[exprState.idx];if(!e)return;
if(exprState.flipped){
// ì¬í”Œë¦½: ì•ë©´ìœ¼ë¡œ
exprState.flipped=false;
document.getElementById('expr-fc-card').classList.remove('flipped');
document.getElementById('expr-fc-back-inner').classList.remove('visible');
setExprRating(false);
}else{
// í”Œë¦½: ë’·ë©´ìœ¼ë¡œ
const func=e.Function||e.L1||'';
document.getElementById('expr-fc-func').textContent=func?'[ '+func+' ]':'';
document.getElementById('expr-fc-meaning').textContent=getMKO(e)||e.Meaning_KO||'(ëœ» ì—†ìŒ)';
const sim=e.Similar_Expr;
const simEl=document.getElementById('expr-fc-similar');
if(sim){
const items=sim.split(/[,;]/).map(s=>s.trim()).filter(Boolean);
simEl.innerHTML='<div class="similar-title">ğŸ’¡ ìœ ì‚¬ í‘œí˜„</div>'+items.map(i=>'<div class="similar-item">â€¢ '+i+'</div>').join('');
simEl.style.display='block';
}else{simEl.style.display='none';}
const ex=getEx(e);
if(ex){document.getElementById('expr-fc-example').textContent=ex;document.getElementById('expr-fc-example').style.display='block';}
document.getElementById('expr-fc-back-inner').classList.add('visible');
exprState.flipped=true;
document.getElementById('expr-fc-card').classList.add('flipped');
setExprRating(true);vibrate(10);
}
}

function setExprRating(en){
const hint=document.getElementById('expr-rating-hint');
if(en){hint.textContent='ì–¼ë§ˆë‚˜ ì˜ ì•Œê³  ìˆë‚˜ìš”?';}
else{hint.textContent='ğŸ‘† íƒ­í•˜ì—¬ ëœ» í™•ì¸ (ë˜ëŠ” ë°”ë¡œ í‰ê°€)';}
// ë™ì  interval í‘œì‹œ (FSRS ê¸°ë°˜)
const e=exprState.words[exprState.idx];
if(e){
const result0 = calcNext({...e}, 0);
const result1 = calcNext({...e}, 1);
const result2 = calcNext({...e}, 2);
const result3 = calcNext({...e}, 3);
const intervals=['ë‹¤ì‹œ',
  `${result1.interval}ì¼`,
  `${result2.interval}ì¼`,
  `${result3.interval}ì¼`];
document.querySelectorAll('#expr-rating-grid .rating-interval').forEach((el,i)=>el.textContent=intervals[i]);
}
}

async function rateExprCard(r){
if(exprState.transitioning)return;
exprState.transitioning=true;
const e=exprState.words[exprState.idx];if(!e){exprState.transitioning=false;return;}
// í†µê³„
if(r===0)exprState.stats.again++;else if(r===1)exprState.stats.hard++;else if(r===2)exprState.stats.good++;else exprState.stats.easy++;
// 6. Hard/Again ì‹œ needsProduction ìë™ ì„¤ì •
if(r<=1)e.needsProduction=true;
// 5. ì„¸ì…˜ ë‚´ ì¬í•™ìŠµ: ì˜¤ë‹µ ì‹œ 5~7ë¬¸ì œ í›„ ì¬ì¶œì œ
if(r===0&&exprState.phase==='normal'){
const insertIdx=Math.min(exprState.idx+5+Math.floor(Math.random()*3),exprState.words.length);
exprState.words.splice(insertIdx,0,{...e,isRetry:true});
}
else if(r===0&&exprState.phase==='retry'){updateWrong(e,false);exprState.savedToWrong++;}
else if(r>=2)updateWrong(e,true);
// DB ì—…ë°ì´íŠ¸
const fresh=await getExpr(e.Expression);
if(fresh){
fresh.reviewCount=(fresh.reviewCount||0)+1;
if(r>=2)fresh.correctCount=(fresh.correctCount||0)+1;
if(r<=1)fresh.needsProduction=true;
updateMastery(fresh,r>=2);
// FSRS ê³„ì‚° (lastReviewëŠ” calcNext ë‚´ë¶€ì—ì„œ ì„¤ì •)
Object.assign(fresh,calcNext(fresh,r));
await saveExpr(fresh);
Object.assign(e,fresh);
}
vibrate(r>=2?10:[50,30,50]);exprState.idx++;
setTimeout(()=>{exprState.transitioning=false;showExprCard();},200);
}

function confirmEndExprFC(){
const ev=exprState.stats.again+exprState.stats.hard+exprState.stats.good+exprState.stats.easy;
if(ev===0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ì•„ì§ í‰ê°€í•œ í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',()=>{if(exprState.timer)clearInterval(exprState.timer);endExprFC(true);});
else if(exprState.idx<exprState.words.length||exprState.retryQueue.length>0)showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ í‘œí˜„ì´ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endExprFC);
else endExprFC();
}

async function endExprFC(skip){
if(exprState.timer){clearInterval(exprState.timer);exprState.timer=null;}
const total=exprState.stats.again+exprState.stats.hard+exprState.stats.good+exprState.stats.easy;
if(total===0||skip){showPage('home');showToast('í•™ìŠµì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');return;}
const known=exprState.stats.good+exprState.stats.easy;
await saveSession({total:total,mode:'expr-fc',type:'expr',stats:exprState.stats,duration:Math.round((Date.now()-exprState.start)/1000)});
// ì™„ë£Œ ëª¨ë‹¬
document.getElementById('qc-total').textContent=total;
document.getElementById('qc-correct').textContent=known;
document.getElementById('qc-wrong').textContent=exprState.stats.again;
document.getElementById('qc-acc').textContent=Math.round((known/total)*100)+'%';
if(exprState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=exprState.savedToWrong;}else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
function updateExprFCBookmarkBtn(){
const e=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-fc-bookmark-btn');
if(btn&&e){btn.textContent=e.starred?'â­':'â˜†';btn.style.color=e.starred?'var(--warning)':'';}
}
function speakExpr(){
const e=exprState.words?.[exprState.idx];if(!e)return;
const u=new SpeechSynthesisUtterance(e.Expression);
u.lang='en-US';u.rate=0.85;
speechSynthesis.cancel();speechSynthesis.speak(u);
}
async function toggleExprFCBookmark(){
const e=exprState.words[exprState.idx];if(!e)return;
const fresh=await getExpr(e.Expression);
if(!fresh)return;
fresh.starred=!fresh.starred;
await saveExpr(fresh);
e.starred=fresh.starred;
updateExprFCBookmarkBtn();
showToast(fresh.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}
async function openExprFCEdit(){
const e=exprState.words[exprState.idx];if(!e)return;
await openExprEditModal(e.Expression);
}
// í‘œí˜„ 5ì§€ì„ ë‹¤ í€´ì¦ˆ
function showExprQuizQ(){
if(exprState.idx>=exprState.words.length){
if(exprState.retryQueue.length>0&&exprState.phase==='normal'){
exprState.words=[...exprState.retryQueue];exprState.retryQueue=[];exprState.idx=0;exprState.phase='retry';
document.getElementById('expr-quiz-retry-banner').classList.remove('hidden');
document.getElementById('expr-quiz-retry-count').textContent=exprState.words.length;
showToast('ğŸ”„ ì˜¤ë‹µ '+exprState.words.length+'ê°œ ì¬ì¶œì œ!');
showExprQuizQ();return;
}else{endExprQuiz();return;}
}
const e=exprState.words[exprState.idx];
exprState.answered=false;
document.getElementById('expr-quiz-progress').style.width=(exprState.idx/exprState.words.length)*100+'%';
document.getElementById('expr-quiz-current').textContent=exprState.idx+1;
document.getElementById('expr-quiz-total').textContent=exprState.words.length;
document.getElementById('expr-quiz-correct').textContent=exprState.correct;
document.getElementById('expr-quiz-wrong').textContent=exprState.wrong;
document.getElementById('expr-quiz-word').textContent=e.Expression;
document.getElementById('expr-quiz-tags').innerHTML=`<span class="tag" style="background:rgba(20,184,166,.2);color:var(--expr)">${e.Register||'Neutral'}</span>`;
// Functionì€ ì •ë‹µ í›„ í‘œì‹œ
const funcEl=document.getElementById('expr-quiz-func');
funcEl.textContent=e.Function||'';
funcEl.style.display='none';
// ë³´ê¸° ìƒì„±
const cAns=getMKO(e);
const dist=getExprDistractors(e,exprState.allWords,4);
const opts=shuffle([cAns,...dist.map(d=>getMKO(d))]);
document.getElementById('expr-quiz-options').innerHTML=opts.map(o=>`<button class="quiz-option" onclick="selectExprQuiz(this,'${escapeHtml(o)}','${escapeHtml(cAns)}')">${o}</button>`).join('');
document.getElementById('expr-quiz-next-btn').classList.add('hidden');
document.getElementById('expr-quiz-rating-bar').classList.add('hidden');
updateExprQuizBookmarkBtn();
updateExprQuizTagBtn();
updateExprQuizProductionBtn();
}
function getExprDistractors(c,pool,n=4){
const valid=pool.filter(e=>e.Expression!==c.Expression&&getMKO(e));
if(valid.length<n)return shuffle(valid).slice(0,n);
const scored=valid.map(e=>{let s=0;if(e.Register===c.Register)s+=3;if(e.Function===c.Function)s+=2;if(e.L1===c.L1)s+=1;return{e,s};});
scored.sort((a,b)=>b.s-a.s);
return shuffle(scored.slice(0,Math.min(n*3,scored.length))).slice(0,n).map(x=>x.e);
}
async function selectExprQuiz(el,sel,ans){
if(exprState.answered)return;
exprState.answered=true;
const ok=sel===ans;
const e=exprState.words[exprState.idx];
document.querySelectorAll('#expr-quiz-options .quiz-option').forEach(b=>{
b.disabled=true;
if(b.textContent===ans)b.classList.add('correct');
else if(b===el&&!ok)b.classList.add('wrong');
});
const funcEl=document.getElementById('expr-quiz-func');
if(e.Function)funcEl.style.display='block';
if(ok){exprState.correct++;vibrate(10);}
else{exprState.wrong++;vibrate([50,30,50]);if(exprState.phase==='normal')exprState.retryQueue.push({...e});else{updateWrong(e,false);exprState.savedToWrong++;}}
const fresh=await getExpr(e.Expression);
if(fresh){
fresh.reviewCount=(fresh.reviewCount||0)+1;
if(ok)fresh.correctCount=(fresh.correctCount||0)+1;
updateMastery(fresh,ok);
// ì˜¤ë‹µ ì‹œì—ë§Œ FSRS ì—…ë°ì´íŠ¸ (lastReviewëŠ” calcNext ë‚´ë¶€ì—ì„œ ì„¤ì •)
if(!ok){updateWrong(fresh,false);Object.assign(fresh,calcNext(fresh,0));}
else{fresh.lastReview=new Date().toISOString();} // ì •ë‹µì´ë©´ lastReviewë§Œ ê°±ì‹ 
await saveExpr(fresh);
Object.assign(e,fresh);
}
document.getElementById('expr-quiz-correct').textContent=exprState.correct;
document.getElementById('expr-quiz-wrong').textContent=exprState.wrong;
if(ok){showQuizRating('expr-quiz',2000);}else{document.getElementById('expr-quiz-next-btn').classList.remove('hidden');}
}
async function rateExprQuizItem(grade){
clearInterval(quizRatingTimer);
const e=exprState.words[exprState.idx];
const fresh=await getExpr(e.Expression);
if(fresh){Object.assign(fresh,calcNext(fresh,grade));await saveExpr(fresh);}
document.getElementById('expr-quiz-rating-bar').classList.add('hidden');
nextExprQuiz();
}
function nextExprQuiz(){exprState.idx++;showExprQuizQ();}
function confirmEndExprQuiz(){
if(exprState.idx<exprState.words.length||exprState.retryQueue.length>0)
showConfirm('í•™ìŠµ ì¢…ë£Œ','ë‚¨ì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì¢…ë£Œí• ê¹Œìš”?',endExprQuiz);
else endExprQuiz();
}
async function endExprQuiz(){
const total=exprState.correct+exprState.wrong;
if(!total){showPage('home');return;}
await saveSession({total,correct:exprState.correct,wrong:exprState.wrong,mode:'expr-quiz',type:'expr',duration:Math.round((Date.now()-exprState.start)/1000)});
document.getElementById('qc-total').textContent=total;
document.getElementById('qc-correct').textContent=exprState.correct;
document.getElementById('qc-wrong').textContent=exprState.wrong;
document.getElementById('qc-acc').textContent=Math.round((exprState.correct/total)*100)+'%';
if(exprState.savedToWrong>0){document.getElementById('qc-wrong-info').classList.remove('hidden');document.getElementById('qc-wrong-count').textContent=exprState.savedToWrong;}
else document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
function speakExprQuiz(){
const e=exprState.words?.[exprState.idx];if(!e)return;
const u=new SpeechSynthesisUtterance(e.Expression);u.lang='en-US';u.rate=0.85;
speechSynthesis.cancel();speechSynthesis.speak(u);
}
function updateExprQuizBookmarkBtn(){
const e=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-quiz-bookmark-btn');
if(btn&&e){btn.textContent=e.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';btn.style.color=e.starred?'var(--warning)':'';}
}
async function toggleExprQuizBookmark(){
const e=exprState.words[exprState.idx];if(!e)return;
const fresh=await getExpr(e.Expression);if(!fresh)return;
fresh.starred=!fresh.starred;
await saveExpr(fresh);
e.starred=fresh.starred;
updateExprQuizBookmarkBtn();
showToast(fresh.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
}
async function openExprQuizEdit(){
const e=exprState.words[exprState.idx];if(!e)return;
await openExprEditModal(e.Expression);
}
function escapeHtml(t){return(t||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');}
// í‘œí˜„ ê²€ìƒ‰
async function exprSearch(){
const q=document.getElementById('expr-search-input').value.trim();
const qLower=q.toLowerCase();
exprQSQuery=q;
if(!q){document.getElementById('expr-search-result').style.display='none';return;}
const exprs=await getAllExpr();
let found=exprs.find(e=>(e.Expression||'').toLowerCase()===qLower);
if(found){exprQSResult=found;showExprQSResult(found,true);return;}
found=exprs.find(e=>(e.Expression||'').toLowerCase().includes(qLower)||qLower.includes((e.Expression||'').toLowerCase()));
if(found){exprQSResult=found;showExprQSResult(found,false);return;}
exprQSResult=null;
document.getElementById('expr-search-result').style.display='block';
document.getElementById('expr-qs-found').style.display='none';
document.getElementById('expr-qs-notfound').style.display='block';
document.getElementById('expr-qs-new-word').textContent=q;
document.getElementById('expr-qs-new-meaning').value='';
document.getElementById('expr-qs-add-bookmark').checked=true;
}
function showExprQSResult(e,isExact){
document.getElementById('expr-search-result').style.display='block';
document.getElementById('expr-qs-found').style.display='block';
document.getElementById('expr-qs-notfound').style.display='none';
document.getElementById('expr-qs-word').textContent=e.Expression;
document.getElementById('expr-qs-register').textContent=e.Register||'Neutral';
document.getElementById('expr-qs-func').textContent=e.Function||e.L1+' > '+e.L2||'';
document.getElementById('expr-qs-meaning').textContent=getMKO(e)||'';
const ex=getEx(e);
const exEl=document.getElementById('expr-qs-example');
if(ex){exEl.textContent=ex;exEl.style.display='block';}else{exEl.style.display='none';}
const sim=e.Similar_Expr;
if(sim){document.getElementById('expr-qs-similar-list').textContent=sim;document.getElementById('expr-qs-similar').style.display='block';}else{document.getElementById('expr-qs-similar').style.display='none';}
const notThis=document.getElementById('expr-qs-not-this');
if(!isExact&&exprQSQuery.toLowerCase()!==(e.Expression||'').toLowerCase()){
notThis.style.display='block';document.getElementById('expr-qs-original').textContent=exprQSQuery;
}else{notThis.style.display='none';}
const btn=document.getElementById('expr-qs-bookmark-btn');
btn.textContent=e.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
btn.style.color=e.starred?'var(--warning)':'';
}
async function exprQSToggleBookmark(){
if(!exprQSResult)return;
exprQSResult.starred=!exprQSResult.starred;
await saveExpr(exprQSResult);
const btn=document.getElementById('expr-qs-bookmark-btn');
btn.textContent=exprQSResult.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
btn.style.color=exprQSResult.starred?'var(--warning)':'';
showToast(exprQSResult.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}
async function exprQSEdit(){
if(!exprQSResult)return;
document.getElementById('expr-search-result').style.display='none';
// ê°„ë‹¨í•œ í¸ì§‘ ëª¨ë‹¬ (ì¶”í›„ êµ¬í˜„)
showToast('âœï¸ í‘œí˜„ ìˆ˜ì • ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘');
}
function showExprAddNew(){
document.getElementById('expr-qs-found').style.display='none';
document.getElementById('expr-qs-notfound').style.display='block';
document.getElementById('expr-qs-new-word').textContent=exprQSQuery;
document.getElementById('expr-qs-new-meaning').value='';
document.getElementById('expr-qs-add-bookmark').checked=true;
}
async function exprQSSaveNew(){
const expr=document.getElementById('expr-qs-new-word').textContent.trim();
const meaning=document.getElementById('expr-qs-new-meaning').value.trim();
if(!expr){showToast('âŒ í‘œí˜„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
if(!meaning){showToast('âŒ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
const addBookmark=document.getElementById('expr-qs-add-bookmark').checked;
const newExpr={Expression:expr,Meaning_KO:meaning,Register:'Neutral',starred:addBookmark,reviewCount:0,correctCount:0,mastery:0,leitnerBox:1,ease:2.5};
await saveExpr(newExpr);
document.getElementById('expr-search-result').style.display='none';
document.getElementById('expr-search-input').value='';
showToast(addBookmark?'âœ… ì €ì¥ + â­ ë¶ë§ˆí¬ ì¶”ê°€':'âœ… ì €ì¥ ì™„ë£Œ');
updateHomeStats();
}
function filterExprRegister(r){
exprRegisterFilter=r;
document.querySelectorAll('#home-expr .chip').forEach(c=>c.classList.toggle('active',c.dataset.filter===r));
}
// í‘œí˜„ ë¹ˆì¹¸ì±„ìš°ê¸°
function showExprClozeQ(){
const e=exprState.words[exprState.idx];
if(!e){endExprCloze();return;}
exprState.answered=false;
document.getElementById('expr-cloze-progress').style.width=((exprState.idx/exprState.words.length)*100)+'%';
document.getElementById('expr-cloze-current').textContent=exprState.idx+1;
document.getElementById('expr-cloze-total').textContent=exprState.words.length;
document.getElementById('expr-cloze-correct').textContent=exprState.correct;
document.getElementById('expr-cloze-wrong').textContent=exprState.wrong;
// ì˜ˆë¬¸ì—ì„œ í‘œí˜„ ë¹ˆì¹¸ ì²˜ë¦¬
let ex=getEx(e);
const expr=e.Expression;
const firstWord=expr.split(' ')[0].toLowerCase();
const regex=new RegExp('\\b'+firstWord+'\\b[^.]*','gi');
const blanked=ex.replace(regex,'________');
document.getElementById('expr-cloze-sentence').innerHTML=blanked;
document.getElementById('expr-cloze-hint').textContent=getMKO(e)||e.Function||'';
// ì„ íƒì§€ ìƒì„±
const correct=expr;
const pool=exprState.allWords.filter(x=>x.Expression!==expr).map(x=>x.Expression);
const distractors=shuffle(pool).slice(0,3);
const options=shuffle([correct,...distractors]);
document.getElementById('expr-cloze-options').innerHTML=options.map(o=>`<button class="quiz-option" onclick="selectExprCloze(this)" data-ans="${o===correct}">${o}</button>`).join('');
document.getElementById('expr-cloze-next-btn').classList.add('hidden');
}
async function selectExprCloze(el){
if(exprState.answered)return;exprState.answered=true;
const ok=el.dataset.ans==='true';
const e=exprState.words[exprState.idx];
if(ok)exprState.correct++;else{exprState.wrong++;if(exprState.phase==='normal')exprState.retryQueue.push({...e});}
document.querySelectorAll('#expr-cloze-options .quiz-option').forEach(o=>{o.disabled=true;if(o.dataset.ans==='true')o.classList.add('correct');else if(o===el&&!ok)o.classList.add('wrong');});
e.reviewCount=(e.reviewCount||0)+1;if(ok)e.correctCount=(e.correctCount||0)+1;
updateMastery(e,ok);
Object.assign(e,calcNext(e,ok?2:0));
await saveExpr(e);
document.getElementById('expr-cloze-correct').textContent=exprState.correct;
document.getElementById('expr-cloze-wrong').textContent=exprState.wrong;
setTimeout(()=>{exprState.idx++;showExprClozeQ();},1500);
}
async function endExprCloze(){
const ans=exprState.correct+exprState.wrong;if(!ans){showPage('home');return;}
const acc=Math.round((exprState.correct/ans)*100);
await saveSession({total:ans,correct:exprState.correct,wrong:exprState.wrong,accuracy:acc,mode:'expr-cloze',type:'expr',duration:Math.round((Date.now()-exprState.start)/1000)});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=exprState.correct;document.getElementById('qc-wrong').textContent=exprState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
// === í‘œí˜„ ì“°ê¸° ëª¨ë“œ ===
let exprTypingState={words:[],idx:0,correct:0,wrong:0,hintUsed:false,answered:false,start:null};
function showExprTypingQ(){
if(exprTypingState.idx>=exprTypingState.words.length){endExprTyping();return;}
const e=exprTypingState.words[exprTypingState.idx];
exprTypingState.hintUsed=false;
exprTypingState.answered=false;
document.getElementById('expr-typing-current').textContent=exprTypingState.idx+1;
document.getElementById('expr-typing-correct').textContent=exprTypingState.correct;
document.getElementById('expr-typing-wrong').textContent=exprTypingState.wrong;
document.getElementById('expr-typing-progress').style.width=((exprTypingState.idx/exprTypingState.words.length)*100)+'%';
document.getElementById('expr-typing-meaning').textContent=getMKO(e)||'';
document.getElementById('expr-typing-func').textContent=e.Function||'';
document.getElementById('expr-typing-register').textContent=e.Register?`[${e.Register}]`:'';
const ex=getEx(e);
if(ex){document.getElementById('expr-typing-example').textContent=ex.replace(new RegExp(e.Expression,'gi'),'_____');document.getElementById('expr-typing-example').classList.remove('hidden');}
else document.getElementById('expr-typing-example').classList.add('hidden');
document.getElementById('expr-typing-input').value='';
document.getElementById('expr-typing-input').disabled=false;
document.getElementById('expr-typing-input').focus();
document.getElementById('expr-typing-answer').classList.add('hidden');
document.getElementById('expr-typing-submit-btn').textContent='í™•ì¸';
document.getElementById('expr-typing-submit-btn').onclick=checkExprTyping;
document.getElementById('expr-typing-hint-btn').disabled=false;
}
function showExprTypingHint(){
if(exprTypingState.hintUsed)return;
exprTypingState.hintUsed=true;
const e=exprTypingState.words[exprTypingState.idx];
const expr=e.Expression;
const hint=expr.substring(0,Math.ceil(expr.length/3))+'...';
document.getElementById('expr-typing-input').placeholder=hint;
document.getElementById('expr-typing-hint-btn').disabled=true;
showToast('ğŸ’¡ íŒíŠ¸: '+hint);
}
async function checkExprTyping(){
if(exprTypingState.answered){exprTypingState.idx++;showExprTypingQ();return;}
const e=exprTypingState.words[exprTypingState.idx];
const input=document.getElementById('expr-typing-input').value.trim().toLowerCase();
const correct=e.Expression.toLowerCase();
const isCorrect=input===correct;
exprTypingState.answered=true;
document.getElementById('expr-typing-input').disabled=true;
const ansEl=document.getElementById('expr-typing-answer');
ansEl.classList.remove('hidden');
// DBì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
const fresh=await getExpr(e.Expression);
if(fresh){
fresh.reviewCount=(fresh.reviewCount||0)+1;
if(isCorrect){
exprTypingState.correct++;
ansEl.textContent='âœ… ì •ë‹µ!';
ansEl.style.background='rgba(34,197,94,.2)';
ansEl.style.color='var(--success)';
fresh.correctCount=(fresh.correctCount||0)+1;
updateMastery(fresh,true);
if(!exprTypingState.hintUsed){
updateWrong(fresh,true);
Object.assign(fresh,calcNext(fresh,2)); // Good
}else{
Object.assign(fresh,calcNext(fresh,1)); // Hard (íŒíŠ¸ ì‚¬ìš©)
}
}else{
exprTypingState.wrong++;
ansEl.innerHTML='âŒ ì˜¤ë‹µ<br><span style="font-size:20px">'+e.Expression+'</span>';
ansEl.style.background='rgba(239,68,68,.2)';
ansEl.style.color='var(--danger)';
updateMastery(fresh,false);
updateWrong(fresh,false);
Object.assign(fresh,calcNext(fresh,0)); // Again
fresh.needsProduction=true; // 6. ì˜¤ë‹µ ì‹œ ì‚°ì¶œ ì—°ìŠµ í•„ìš” í‘œì‹œ
}
await saveExpr(fresh);
Object.assign(e,fresh);
}
document.getElementById('expr-typing-correct').textContent=exprTypingState.correct;
document.getElementById('expr-typing-wrong').textContent=exprTypingState.wrong;
document.getElementById('expr-typing-submit-btn').textContent='ë‹¤ìŒ â†’';
}
function confirmEndExprTyping(){if(confirm('í•™ìŠµì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))endExprTyping();}
async function endExprTyping(){
const ans=exprTypingState.correct+exprTypingState.wrong;if(!ans){showPage('home');return;}
const acc=Math.round((exprTypingState.correct/ans)*100);
await saveSession({total:ans,correct:exprTypingState.correct,wrong:exprTypingState.wrong,accuracy:acc,mode:'expr-typing',type:'expr',duration:Math.round((Date.now()-exprTypingState.start)/1000)});
document.getElementById('qc-total').textContent=ans;document.getElementById('qc-correct').textContent=exprTypingState.correct;document.getElementById('qc-wrong').textContent=exprTypingState.wrong;document.getElementById('qc-acc').textContent=acc+'%';
document.getElementById('qc-wrong-info').classList.add('hidden');
showModal('quiz-complete-modal');updateHomeStats();
}
// í•™ìŠµ ì„¤ì •ì—ì„œ í‘œí˜„ í•™ìŠµ ì‹œì‘
async function startExprStudySession(){
const exprs=await getAllExpr();
if(!exprs.length){showToast('ğŸ’¬ í‘œí˜„ DBê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');return;}
const count=parseInt(document.getElementById('expr-study-count').value)||20;
const masteryFilter=document.querySelector('#expr-filter-mastery .chip.active')?.dataset.value||'all';
const registerFilter=document.getElementById('expr-filter-register').value;
const order=document.getElementById('option-order').value;
const now=new Date();
const mode=document.querySelector('#study-expr .mode-card.active')?.dataset.mode||'expr-fc';
const isTypingMode=mode==='expr-typing';
let filtered=exprs;
// ê¸°ë³¸ í•„í„°
if(masteryFilter==='new')filtered=filtered.filter(x=>!(x.reviewCount||0));
else if(masteryFilter==='weak')filtered=filtered.filter(x=>isWeak(x));
else if(masteryFilter==='wrong')filtered=filtered.filter(x=>isWrong(x));
else if(masteryFilter==='starred')filtered=filtered.filter(x=>x.starred);
if(registerFilter!=='all')filtered=filtered.filter(x=>x.Register===registerFilter);
// â˜… SM-2 í•„í„° (íƒ€ì´í•‘ ëª¨ë“œ + needsProductionì´ë©´ ë¬´ì‹œ)
filtered=filtered.filter(x=>{
const rc=x.reviewCount||0;
if(isTypingMode&&x.needsProduction)return true;
if(rc===0)return true;
if(x.nextReview&&new Date(x.nextReview)>now)return false;
return true;
});
if(!filtered.length){showToast('âš ï¸ ë³µìŠµí•  í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
// ì •ë ¬ (íƒ€ì´í•‘ ëª¨ë“œ: needsProduction ìš°ì„ )
if(isTypingMode){
filtered.sort((a,b)=>(b.needsProduction?1:0)-(a.needsProduction?1:0));
}else if(order==='random')filtered=shuffle(filtered);
else if(order==='weak')filtered.sort((a,b)=>getWeaknessScore(a)-getWeaknessScore(b));
else filtered=sortByFSRSPriority(filtered,now);
// â˜… ì˜¤ë‹µ ìë™ í¬í•¨ (íƒ€ì´í•‘ ì œì™¸)
let wrongAdded=0;
const wrongAutoEnabled=localStorage.getItem('wrongAuto')!=='false';
if(wrongAutoEnabled&&!isTypingMode){
const wrongLimit=parseInt(localStorage.getItem('wrongLimit')||'5');
const wrongBonus=Math.min(wrongLimit,Math.floor(count/5));
if(wrongBonus>0){
const wrongExprs=exprs.filter(x=>isWrong(x)&&!filtered.slice(0,count).some(f=>f.Expression===x.Expression));
const wrongToAdd=shuffle(wrongExprs).slice(0,wrongBonus);
wrongAdded=wrongToAdd.length;
// Interleaving
wrongToAdd.forEach(w=>{
const insertIdx=Math.floor(Math.random()*(Math.min(count,filtered.length)+1));
filtered.splice(insertIdx,0,w);
});
}
}
if(mode==='expr-cloze'){
const valid=filtered.filter(e=>{const ex=getEx(e);return ex&&ex.toLowerCase().includes(e.Expression.toLowerCase().split(' ')[0]);});
if(!valid.length){showToast('âš ï¸ ë¹ˆì¹¸ì±„ìš°ê¸° ê°€ëŠ¥í•œ í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
exprState={words:valid.slice(0,count),allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0};
showPage('expr-cloze');showExprClozeQ();
}else if(mode==='expr-quiz'){
const valid=filtered.filter(e=>getMKO(e));
if(valid.length<5){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” í‘œí˜„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');return;}
exprState={words:valid.slice(0,count),allWords:exprs,idx:0,correct:0,wrong:0,answered:false,start:Date.now(),retryQueue:[],phase:'normal',savedToWrong:0};
document.getElementById('expr-quiz-total').textContent=exprState.words.length;
document.getElementById('expr-quiz-retry-banner').classList.add('hidden');
showPage('expr-quiz');showExprQuizQ();
}else if(mode==='expr-typing'){
const valid=filtered.filter(e=>getMKO(e));
if(!valid.length){showToast('âš ï¸ ëœ»ì´ ìˆëŠ” í‘œí˜„ì´ ì—†ìŠµë‹ˆë‹¤');return;}
exprTypingState={words:valid.slice(0,count),idx:0,correct:0,wrong:0,hintUsed:false,answered:false,start:Date.now()};
document.getElementById('expr-typing-total').textContent=exprTypingState.words.length;
showPage('expr-typing');showExprTypingQ();
}else{
const selCount=count+wrongAdded;
exprState={words:filtered.slice(0,selCount),allWords:exprs,idx:0,flipped:false,transitioning:false,start:Date.now(),stats:{again:0,hard:0,good:0,easy:0},retryQueue:[],phase:'normal',savedToWrong:0,timer:null};
document.getElementById('expr-fc-total').textContent=exprState.words.length;
document.getElementById('expr-retry-banner').classList.add('hidden');
if(wrongAdded>0)showToast(`ğŸ“ ì˜¤ë‹µ ${wrongAdded}ê°œ í¬í•¨`);
showPage('expr-fc');startExprTimer();showExprCard();
}
}

// === í†µê³„ ===
async function updateHomeStats(){
try{const w=await getAllWords(),p=await getAllPV(),e=await getAllExpr(),now=new Date();
document.getElementById('stat-total').textContent=w.length;document.getElementById('stat-mastered').textContent=w.filter(x=>(x.mastery||0)>=80).length;document.getElementById('stat-weak').textContent=w.filter(x=>isWeak(x)).length;document.getElementById('stat-due').textContent=w.filter(x=>x.nextReview&&new Date(x.nextReview)<=now).length;
const wV=w.filter(x=>isWrong(x)).length,bV=document.getElementById('wrong-badge-vocab');if(wV>0){bV.textContent=wV;bV.classList.remove('hidden');}else bV.classList.add('hidden');
const sV=w.filter(x=>x.starred).length;document.getElementById('star-badge-vocab').textContent=sV;
const pV=w.filter(x=>x.needsProduction).length,pbV=document.getElementById('prod-badge-vocab');if(pV>0){pbV.textContent=pV;pbV.classList.remove('hidden');}else pbV.classList.add('hidden');
document.getElementById('pv-stat-total').textContent=p.length;document.getElementById('pv-stat-mastered').textContent=p.filter(x=>(x.mastery||0)>=80).length;document.getElementById('pv-stat-weak').textContent=p.filter(x=>isWeak(x)).length;document.getElementById('pv-stat-due').textContent=p.filter(x=>x.nextReview&&new Date(x.nextReview)<=now).length;
const wP=p.filter(x=>isWrong(x)).length,bP=document.getElementById('wrong-badge-pv');if(wP>0){bP.textContent=wP;bP.classList.remove('hidden');}else bP.classList.add('hidden');
const sP=p.filter(x=>x.starred).length;document.getElementById('star-badge-pv').textContent=sP;
const pP=p.filter(x=>x.needsProduction).length,pbP=document.getElementById('prod-badge-pv');if(pP>0){pbP.textContent=pP;pbP.classList.remove('hidden');}else pbP.classList.add('hidden');
// Expression stats
document.getElementById('expr-stat-total').textContent=e.length;document.getElementById('expr-stat-mastered').textContent=e.filter(x=>(x.mastery||0)>=80).length;document.getElementById('expr-stat-weak').textContent=e.filter(x=>isWeak(x)).length;document.getElementById('expr-stat-due').textContent=e.filter(x=>x.nextReview&&new Date(x.nextReview)<=now).length;
const wE=e.filter(x=>isWrong(x)).length,bE=document.getElementById('wrong-badge-expr');if(wE>0){bE.textContent=wE;bE.classList.remove('hidden');}else bE.classList.add('hidden');
const sE=e.filter(x=>x.starred).length;document.getElementById('star-badge-expr').textContent=sE;
if(w.length>0||p.length>0||e.length>0)document.getElementById('db-status').innerHTML=`<p style="color:var(--success)">âœ… ì–´íœ˜ ${w.length} / êµ¬ë™ì‚¬ ${p.length} / í‘œí˜„ ${e.length}</p>`;
const streak=parseInt(localStorage.getItem('streak')||'0');if(streak>0){document.getElementById('streak-banner').classList.remove('hidden');document.getElementById('streak-days').textContent=streak;}else document.getElementById('streak-banner').classList.add('hidden');
// í™ˆ í™”ë©´ íƒœê·¸ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
updateHomeTagSelects(w,p,e);
// íƒœê·¸ í•„í„° ì—…ë°ì´íŠ¸
updateTagFilters(w,p);
await updateDailyGoal();
}catch(e){console.error(e);}}
async function updateStatsPage(){
try{const w=await getAllWords(),s=await getSessions(),now=new Date();
document.getElementById('stats-total').textContent=w.length;document.getElementById('stats-mastered').textContent=w.filter(x=>(x.mastery||0)>=80).length;document.getElementById('stats-learning').textContent=w.filter(x=>(x.reviewCount||0)>0&&(x.mastery||0)<80).length;document.getElementById('stats-new').textContent=w.filter(x=>!(x.reviewCount||0)).length;
let high=0,mid=0,low=0;w.forEach(x=>{const a=getAcc(x);if(a===null)return;if(a>=80)high++;else if(a>=50)mid++;else low++;});
document.getElementById('stats-high').textContent=high;document.getElementById('stats-mid').textContent=mid;document.getElementById('stats-low').textContent=low;
const boxes=[0,0,0,0,0];w.forEach(x=>{const b=Math.min(5,Math.max(1,x.leitnerBox||1));boxes[b-1]++;});
document.getElementById('leitner-stats').innerHTML=boxes.map((c,i)=>`<div class="leitner-box box-${i+1}" onclick="startBoxStudy(${i+1},'vocab')" style="cursor:pointer" title="Box ${i+1} í•™ìŠµ"><div class="leitner-count">${c}</div><div class="leitner-label">Box ${i+1}</div></div>`).join('');
const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],wd=[0,0,0,0,0,0,0];
const nowDate=new Date(now.toDateString());
s.filter(x=>x.type==='vocab'||!x.type).forEach(x=>{
const sessDate=new Date(new Date(x.date).toDateString());
const diff=Math.floor((nowDate-sessDate)/86400000);
if(diff>=0&&diff<7)wd[6-diff]+=(x.total||0);
});
const max=Math.max(...wd,1);document.getElementById('weekly-chart').innerHTML=wd.map((v,i)=>{const d=(now.getDay()-6+i+7)%7;return`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar" style="height:${Math.max(4,(v/max)*120)}px"></div><div class="chart-bar-label">${days[d]}</div></div>`;}).join('');
}catch(e){console.error(e);}}
async function updatePVStats(){
try{const p=await getAllPV(),s=await getSessions(),now=new Date();
document.getElementById('pv-stats-total').textContent=p.length;document.getElementById('pv-stats-mastered').textContent=p.filter(x=>(x.mastery||0)>=80).length;document.getElementById('pv-stats-learning').textContent=p.filter(x=>(x.reviewCount||0)>0&&(x.mastery||0)<80).length;document.getElementById('pv-stats-new').textContent=p.filter(x=>!(x.reviewCount||0)).length;
let high=0,mid=0,low=0;p.forEach(x=>{const a=getAcc(x);if(a===null)return;if(a>=80)high++;else if(a>=50)mid++;else low++;});
document.getElementById('pv-stats-high').textContent=high;document.getElementById('pv-stats-mid').textContent=mid;document.getElementById('pv-stats-low').textContent=low;
const boxes=[0,0,0,0,0];p.forEach(x=>{const b=Math.min(5,Math.max(1,x.leitnerBox||1));boxes[b-1]++;});
document.getElementById('pv-leitner-stats').innerHTML=boxes.map((c,i)=>`<div class="leitner-box box-${i+1}" onclick="startBoxStudy(${i+1},'phrasal')" style="cursor:pointer" title="Box ${i+1} í•™ìŠµ"><div class="leitner-count">${c}</div><div class="leitner-label">Box ${i+1}</div></div>`).join('');
const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],wd=[0,0,0,0,0,0,0];
const nowDate=new Date(now.toDateString());
s.filter(x=>x.type==='phrasal').forEach(x=>{
const sessDate=new Date(new Date(x.date).toDateString());
const diff=Math.floor((nowDate-sessDate)/86400000);
if(diff>=0&&diff<7)wd[6-diff]+=(x.total||0);
});
const max=Math.max(...wd,1);document.getElementById('pv-weekly-chart').innerHTML=wd.map((v,i)=>{const d=(now.getDay()-6+i+7)%7;return`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar phrasal" style="height:${Math.max(4,(v/max)*120)}px"></div><div class="chart-bar-label">${days[d]}</div></div>`;}).join('');
}catch(e){console.error(e);}}
async function updateExprStats(){
try{const e=await getAllExpr(),s=await getSessions(),now=new Date();
document.getElementById('expr-stats-total').textContent=e.length;
document.getElementById('expr-stats-mastered').textContent=e.filter(x=>(x.mastery||0)>=80).length;
document.getElementById('expr-stats-learning').textContent=e.filter(x=>(x.reviewCount||0)>0&&(x.mastery||0)<80).length;
document.getElementById('expr-stats-new').textContent=e.filter(x=>!(x.reviewCount||0)).length;
let high=0,mid=0,low=0;e.forEach(x=>{const a=getAcc(x);if(a===null)return;if(a>=80)high++;else if(a>=50)mid++;else low++;});
document.getElementById('expr-stats-high').textContent=high;
document.getElementById('expr-stats-mid').textContent=mid;
document.getElementById('expr-stats-low').textContent=low;
// Leitner Box (ê¸°ë³¸ ìƒ‰ìƒ)
const boxes=[0,0,0,0,0];e.forEach(x=>{const b=Math.min(5,Math.max(1,x.leitnerBox||1));boxes[b-1]++;});
document.getElementById('expr-leitner-stats').innerHTML=boxes.map((c,i)=>`<div class="leitner-box box-${i+1}"><div class="leitner-count">${c}</div><div class="leitner-label">Box ${i+1}</div></div>`).join('');
// ì£¼ê°„ í•™ìŠµ
const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '],wd=[0,0,0,0,0,0,0];
const nowDate=new Date(now.toDateString());
s.filter(x=>x.type==='expr').forEach(x=>{
const sessDate=new Date(new Date(x.date).toDateString());
const diff=Math.floor((nowDate-sessDate)/86400000);
if(diff>=0&&diff<7)wd[6-diff]+=(x.total||0);
});
const max=Math.max(...wd,1);document.getElementById('expr-weekly-chart').innerHTML=wd.map((v,i)=>{const d=(now.getDay()-6+i+7)%7;return`<div class="chart-bar-wrapper"><div class="chart-bar-value">${v}</div><div class="chart-bar" style="height:${Math.max(4,(v/max)*120)}px;background:var(--expr)"></div><div class="chart-bar-label">${days[d]}</div></div>`;}).join('');
}catch(err){console.error(err);}}
let editingExpr=null;
async function openExprEditModal(key){
const e=await getExpr(key);if(!e)return;
editingExpr=e;
document.getElementById('expr-edit-key').value=e.Expression||'';
document.getElementById('expr-edit-meaning').value=getMKO(e)||e.Meaning_KO||'';
document.getElementById('expr-edit-function').value=e.Function||'';
document.getElementById('expr-edit-register').value=e.Register||'Neutral';
document.getElementById('expr-edit-example1').value=e.Example1||'';
document.getElementById('expr-edit-example2').value=e.Example2||'';
document.getElementById('expr-edit-similar').value=e.Similar_Expr||'';
document.getElementById('expr-edit-l1').value=e.L1||'';
document.getElementById('expr-edit-l2').value=e.L2||'';
document.getElementById('expr-edit-l3').value=e.L3||'';
// í†µê³„
document.getElementById('expr-edit-review').textContent=e.reviewCount||0;
const acc=getAcc(e);
document.getElementById('expr-edit-acc').textContent=acc!==null?acc+'%':'-';
document.getElementById('expr-edit-acc').style.color=acc===null?'':acc>=80?'var(--success)':acc<50?'var(--danger)':'var(--warning)';
document.getElementById('expr-edit-next').textContent=e.nextReview?new Date(e.nextReview).toLocaleDateString('ko-KR',{month:'short',day:'numeric'}):'-';
document.getElementById('expr-edit-bookmark-btn').textContent=e.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
showModal('expr-edit-modal');
}
async function saveExprEdit(){
if(!editingExpr)return;
editingExpr.Meaning_KO=document.getElementById('expr-edit-meaning').value;
editingExpr.Function=document.getElementById('expr-edit-function').value;
editingExpr.Register=document.getElementById('expr-edit-register').value;
editingExpr.Example1=document.getElementById('expr-edit-example1').value;
editingExpr.Example2=document.getElementById('expr-edit-example2').value;
editingExpr.Similar_Expr=document.getElementById('expr-edit-similar').value;
editingExpr.L1=document.getElementById('expr-edit-l1').value;
editingExpr.L2=document.getElementById('expr-edit-l2').value;
editingExpr.L3=document.getElementById('expr-edit-l3').value;
await saveExpr(editingExpr);
closeModal('expr-edit-modal');showToast('âœ… ì €ì¥ ì™„ë£Œ');updateWordTable();
}
async function toggleExprBookmark(){
if(!editingExpr)return;
editingExpr.starred=!editingExpr.starred;
await saveExpr(editingExpr);
document.getElementById('expr-edit-bookmark-btn').textContent=editingExpr.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';
showToast(editingExpr.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'ë¶ë§ˆí¬ í•´ì œ');
}
async function resetExprStats(){
if(!editingExpr)return;
showConfirm('í†µê³„ ì´ˆê¸°í™”','ì´ í‘œí˜„ì˜ í•™ìŠµ í†µê³„ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?',async()=>{
editingExpr.reviewCount=0;editingExpr.correctCount=0;editingExpr.consecutiveWrong=0;editingExpr.wrongCount=0;
editingExpr.stability=null;editingExpr.difficulty=null;editingExpr.nextReview=null;editingExpr.lastReview=null;
editingExpr.mastery=0;editingExpr.fsrsState='New';
await saveExpr(editingExpr);
closeModal('expr-edit-modal');showToast('ğŸ”„ ì´ˆê¸°í™” ì™„ë£Œ');updateWordTable();updateHomeStats();
});
}
async function deleteExprItem(){
if(!editingExpr)return;
showConfirm('í‘œí˜„ ì‚­ì œ',`"${editingExpr.Expression}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`,async()=>{
await deleteExpr(editingExpr.Expression);
closeModal('expr-edit-modal');showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');updateWordTable();updateHomeStats();
});
}
async function updateDataPage(){try{const w=await getAllWords(),p=await getAllPV(),e=await getAllExpr();document.getElementById('db-vocab-count').textContent=w.length;document.getElementById('db-pv-count').textContent=p.length;document.getElementById('db-expr-count').textContent=e.length;if(w.length){const l1s=[...new Set(w.map(x=>x.L1).filter(Boolean))].sort();document.getElementById('filter-l1').innerHTML='<option value="all">ì „ì²´</option>'+l1s.map(l=>`<option value="${l}">${l}</option>`).join('');}if(p.length){const cats=[...new Set(p.map(x=>x.Category).filter(Boolean))].sort();document.getElementById('pv-filter-cat').innerHTML='<option value="all">ì „ì²´</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');}
// ë¶„í¬ í‘œì‹œ
updateDistribution(w,p,e);
wordOffset=0;updateWordTable();}catch(e){console.error(e);}}
function updateDistribution(w,p,e){
const total=w.length||1;
// ë‚œì´ë„ë³„ ë¶„í¬
const diffDist={1:0,2:0,3:0,4:0,5:0};
w.forEach(x=>diffDist[x.Difficulty||2]=(diffDist[x.Difficulty||2]||0)+1);
const diffLabels=['ì´ˆì¤‘','ê³ ë“±','ëŒ€í•™','GRE','í•™ì'];
document.getElementById('dist-difficulty').innerHTML=renderDistBar(diffDist,total,['#60a5fa','#34d399','#fbbf24','#f87171','#a78bfa'],diffLabels);
// L1ë³„ ë¶„í¬
const l1Dist={};
w.forEach(x=>{const l1=x.L1||'ë¯¸ì§€ì •';l1Dist[l1]=(l1Dist[l1]||0)+1;});
const l1Colors={'Academic':'#818cf8','General':'#34d399','Daily':'#fbbf24','ë¯¸ì§€ì •':'#94a3b8'};
document.getElementById('dist-l1').innerHTML=renderDistBar(l1Dist,total,l1Colors);
// êµ¬ë™ì‚¬ ì¹´í…Œê³ ë¦¬ ë¶„í¬
const pvCatDist={};
p.forEach(x=>{const cat=x.Category||'ë¯¸ì§€ì •';pvCatDist[cat]=(pvCatDist[cat]||0)+1;});
const pvColors={'Academic':'#818cf8','General':'#34d399','Daily':'#fbbf24','ë¯¸ì§€ì •':'#94a3b8'};
if(p.length>0){
document.getElementById('dist-pv-cat').innerHTML=renderDistBar(pvCatDist,p.length,pvColors);
}else{document.getElementById('dist-pv-cat').innerHTML='<span style="font-size:12px;color:var(--muted)">êµ¬ë™ì‚¬ ì—†ìŒ</span>';}
// í‘œí˜„ Register ë¶„í¬
const exprRegDist={};
e.forEach(x=>{const reg=x.Register||'Neutral';exprRegDist[reg]=(exprRegDist[reg]||0)+1;});
const exprColors={'Formal':'#6366f1','Neutral':'#14b8a6','Casual':'#f59e0b','ë¯¸ì§€ì •':'#94a3b8'};
if(e.length>0){
document.getElementById('dist-expr-register').innerHTML=renderDistBar(exprRegDist,e.length,exprColors);
}else{document.getElementById('dist-expr-register').innerHTML='<span style="font-size:12px;color:var(--muted)">í‘œí˜„ ì—†ìŒ</span>';}
}
function renderDistBar(dist,total,colors,labels){
const entries=Object.entries(dist).sort((a,b)=>b[1]-a[1]);
if(entries.length===0)return'<span style="font-size:12px;color:var(--muted)">ë°ì´í„° ì—†ìŒ</span>';
// ìŠ¤íƒ ë°”
let stackBar='<div style="display:flex;height:24px;border-radius:8px;overflow:hidden;margin-bottom:8px">';
entries.forEach(([k,v],i)=>{
const pct=(v/total*100).toFixed(1);
const color=Array.isArray(colors)?colors[i%colors.length]:(colors[k]||'#94a3b8');
const label=labels?labels[parseInt(k)-1]||k:k;
stackBar+=`<div style="width:${pct}%;background:${color};min-width:${v>0?'2px':'0'}" title="${label}: ${v} (${pct}%)"></div>`;
});
stackBar+='</div>';
// ë²”ë¡€
let legend='<div style="display:flex;flex-wrap:wrap;gap:8px;font-size:11px">';
entries.forEach(([k,v],i)=>{
const pct=(v/total*100).toFixed(0);
const color=Array.isArray(colors)?colors[i%colors.length]:(colors[k]||'#94a3b8');
const label=labels?labels[parseInt(k)-1]||k:k;
legend+=`<span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;border-radius:2px;background:${color}"></span>${label} <strong>${v}</strong><span style="color:var(--muted)">(${pct}%)</span></span>`;
});
legend+='</div>';
return stackBar+legend;
}
let currentSearchQuery='',currentTagFilter='all';
async function updateWordTable(){
const query=currentSearchQuery.toLowerCase().trim();
const tagF=currentTagFilter;
if(currentDataType==='expr'){
let e=await getAllExpr();
if(query){
e=e.filter(x=>(x.Expression||'').toLowerCase().includes(query)||(getMKO(x)||'').toLowerCase().includes(query)||(x.Function||'').toLowerCase().includes(query));
e.sort((a,b)=>{
const aWord=(a.Expression||'').toLowerCase();
const bWord=(b.Expression||'').toLowerCase();
const aExact=aWord===query?0:1;
const bExact=bWord===query?0:1;
if(aExact!==bExact)return aExact-bExact;
const aStarts=aWord.startsWith(query)?0:1;
const bStarts=bWord.startsWith(query)?0:1;
if(aStarts!==bStarts)return aStarts-bStarts;
return aWord.localeCompare(bWord);
});
}
document.getElementById('word-count').textContent=e.length+'ê°œ';
document.getElementById('word-table-body').innerHTML=e.slice(0,wordOffset+50).map(x=>{const a=getAcc(x),as=a!==null?a+'%':'-',c=a===null?'':a>=80?'color:var(--success)':a<50?'color:var(--danger)':'color:var(--warning)';const star=x.starred?'â­ ':'';const reg=x.Register?`<span style="background:var(--expr);color:#fff;padding:1px 6px;border-radius:8px;font-size:10px;margin-left:4px">${x.Register}</span>`:'';return`<tr onclick="openExprEditModal('${x.Expression.replace(/'/g,"\\'")}')" style="cursor:pointer"><td><strong>${star}${x.Expression}</strong>${reg}</td><td>${getMKO(x)||x.Function||''}</td><td style="${c}">${as}</td></tr>`;}).join('');
}else if(currentDataType==='phrasal'){
let p=await getAllPV();
// ê²€ìƒ‰ í•„í„°
if(query){
p=p.filter(x=>(x.Phrasal_Verb||'').toLowerCase().includes(query)||(getMKO(x)||'').toLowerCase().includes(query)||(getMEN(x)||'').toLowerCase().includes(query));
// ê²€ìƒ‰ ê²°ê³¼ ì •ë ¬: ì •í™•ì¼ì¹˜ > ì‹œì‘ì¼ì¹˜ > í¬í•¨
p.sort((a,b)=>{
const aWord=(a.Phrasal_Verb||'').toLowerCase();
const bWord=(b.Phrasal_Verb||'').toLowerCase();
const aExact=aWord===query?0:1;
const bExact=bWord===query?0:1;
if(aExact!==bExact)return aExact-bExact;
const aStarts=aWord.startsWith(query)?0:1;
const bStarts=bWord.startsWith(query)?0:1;
if(aStarts!==bStarts)return aStarts-bStarts;
return aWord.localeCompare(bWord);
});
}
// íƒœê·¸ í•„í„°
if(tagF!=='all')p=p.filter(x=>(x.tags||[]).includes(tagF));
document.getElementById('word-count').textContent=p.length+'ê°œ';
document.getElementById('word-table-body').innerHTML=p.slice(0,wordOffset+50).map(x=>{const a=getAcc(x),as=a!==null?a+'%':'-',c=a===null?'':a>=80?'color:var(--success)':a<50?'color:var(--danger)':'color:var(--warning)';const star=x.starred?'â­ ':'';const tags=(x.tags||[]).map(t=>`<span style="background:var(--primary);color:#fff;padding:1px 6px;border-radius:8px;font-size:10px;margin-left:4px">${t}</span>`).join('');return`<tr onclick="openEditModal('${x.Phrasal_Verb.replace(/'/g,"\\'")}','phrasal')" style="cursor:pointer"><td><strong>${star}${x.Phrasal_Verb}</strong>${tags}</td><td>${getMKO(x)||''}</td><td style="${c}">${as}</td></tr>`;}).join('');
}else{
let w=await getAllWords();
if(query){
w=w.filter(x=>displayWord(x.word||'').toLowerCase().includes(query)||(getMKO(x)||'').toLowerCase().includes(query)||(getMEN(x)||'').toLowerCase().includes(query));
// ê²€ìƒ‰ ê²°ê³¼ ì •ë ¬: ì •í™•ì¼ì¹˜ > ì‹œì‘ì¼ì¹˜ > í¬í•¨
w.sort((a,b)=>{
const aWord=displayWord(a.word||'').toLowerCase();
const bWord=displayWord(b.word||'').toLowerCase();
const aExact=aWord===query?0:1;
const bExact=bWord===query?0:1;
if(aExact!==bExact)return aExact-bExact;
const aStarts=aWord.startsWith(query)?0:1;
const bStarts=bWord.startsWith(query)?0:1;
if(aStarts!==bStarts)return aStarts-bStarts;
return aWord.localeCompare(bWord);
});
}
if(tagF!=='all')w=w.filter(x=>(x.tags||[]).includes(tagF));
document.getElementById('word-count').textContent=w.length+'ê°œ';
document.getElementById('word-table-body').innerHTML=w.slice(0,wordOffset+50).map(x=>{const a=getAcc(x),as=a!==null?a+'%':'-',c=a===null?'':a>=80?'color:var(--success)':a<50?'color:var(--danger)':'color:var(--warning)';const star=x.starred?'â­ ':'';const tags=(x.tags||[]).map(t=>`<span style="background:var(--primary);color:#fff;padding:1px 6px;border-radius:8px;font-size:10px;margin-left:4px">${t}</span>`).join('');return`<tr onclick="openEditModal('${x.word.replace(/'/g,"\\'")}','vocab')" style="cursor:pointer"><td><strong>${star}${displayWord(x.word)}</strong>${tags}</td><td>${getMKO(x)||''}</td><td style="${c}">${as}</td></tr>`;}).join('');
}
await updateTagFilter();
}
async function loadMoreWords(){wordOffset+=50;updateWordTable();}

// === ê²€ìƒ‰ ê¸°ëŠ¥ ===
function searchWords(){currentSearchQuery=document.getElementById('word-search').value;wordOffset=0;updateWordTable();}

// === íƒœê·¸ í•„í„° ===
async function updateTagFilter(){
const items=currentDataType==='phrasal'?await getAllPV():currentDataType==='expr'?await getAllExpr():await getAllWords();
const allTags=new Set();
items.forEach(x=>(x.tags||[]).forEach(t=>allTags.add(t)));
const container=document.getElementById('tag-filter-container');
const tagsArr=[...allTags].sort();
if(tagsArr.length===0||currentDataType==='expr'){container.innerHTML='';return;}
container.innerHTML=`<span class="chip ${currentTagFilter==='all'?'active':''}" onclick="filterByTag('all')">ì „ì²´</span>`+
tagsArr.map(t=>`<span class="chip ${currentTagFilter===t?'active':''}" onclick="filterByTag('${t.replace(/'/g,"\\'")}')">${t}</span>`).join('');
}
function filterByTag(tag){currentTagFilter=tag;wordOffset=0;updateWordTable();}

// === ë‹¨ì–´ ì§ì ‘ ì¶”ê°€ ===
let addWordType='vocab';
function openAddWordModal(){
addWordType=currentDataType==='expr'?'expr':currentDataType==='phrasal'?'phrasal':'vocab';
document.getElementById('add-type-vocab').classList.toggle('active',addWordType==='vocab');
document.getElementById('add-type-phrasal').classList.toggle('active',addWordType==='phrasal');
document.getElementById('add-type-expr').classList.toggle('active',addWordType==='expr');
document.getElementById('add-vocab-fields').style.display=addWordType==='vocab'?'block':'none';
document.getElementById('add-pv-fields').style.display=addWordType==='phrasal'?'block':'none';
document.getElementById('add-expr-fields').style.display=addWordType==='expr'?'block':'none';
document.getElementById('add-pos-group').style.display=addWordType==='expr'?'none':'block';
document.getElementById('add-meaning-en-group').style.display=addWordType==='expr'?'none':'block';
document.getElementById('add-word-label').textContent=addWordType==='expr'?'í‘œí˜„ *':addWordType==='phrasal'?'êµ¬ë™ì‚¬ *':'ë‹¨ì–´ *';
document.getElementById('add-word').value='';
document.getElementById('add-meaning-ko').value='';
document.getElementById('add-meaning-en').value='';
document.getElementById('add-example').value='';
document.getElementById('add-pos').value='';
document.getElementById('add-tags').value='';
document.getElementById('add-l1').value='General';
document.getElementById('add-difficulty').value='2';
document.getElementById('add-collocation').value='';
document.getElementById('add-user-examples').value='';
document.getElementById('add-user-collocs').value='';
document.getElementById('add-base-verb').value='';
document.getElementById('add-particle').value='';
document.getElementById('add-pv-category').value='General';
document.getElementById('add-formal-equiv').value='';
document.getElementById('add-function').value='';
document.getElementById('add-register').value='Neutral';
showModal('add-word-modal');
}
function switchAddType(t){
addWordType=t;
document.getElementById('add-type-vocab').classList.toggle('active',t==='vocab');
document.getElementById('add-type-phrasal').classList.toggle('active',t==='phrasal');
document.getElementById('add-type-expr').classList.toggle('active',t==='expr');
document.getElementById('add-vocab-fields').style.display=t==='vocab'?'block':'none';
document.getElementById('add-pv-fields').style.display=t==='phrasal'?'block':'none';
document.getElementById('add-expr-fields').style.display=t==='expr'?'block':'none';
document.getElementById('add-pos-group').style.display=t==='expr'?'none':'block';
document.getElementById('add-meaning-en-group').style.display=t==='expr'?'none':'block';
document.getElementById('add-word-label').textContent=t==='expr'?'í‘œí˜„ *':t==='phrasal'?'êµ¬ë™ì‚¬ *':'ë‹¨ì–´ *';
}
async function saveNewWord(){
const word=document.getElementById('add-word').value.trim();
const meaningKo=document.getElementById('add-meaning-ko').value.trim();
if(!word||!meaningKo){showToast('âš ï¸ ë‹¨ì–´ì™€ ëœ»(í•œêµ­ì–´)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤');return;}
const tagsStr=document.getElementById('add-tags').value.trim();
const tags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):[];
const addBookmark=document.getElementById('add-bookmark').checked;
if(addWordType==='expr'){
const exists=await getExpr(word);
if(exists){showToast('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‘œí˜„ì…ë‹ˆë‹¤');return;}
const expr={
Expression:word,
Meaning_KO:meaningKo,
Function:document.getElementById('add-function').value.trim(),
Register:document.getElementById('add-register').value,
Example1:document.getElementById('add-example').value.trim(),
tags:tags,
starred:addBookmark,
// FSRS í•„ë“œ
stability:null,difficulty:null,fsrsState:'New',reps:0,lapses:0,
// í•™ìŠµ í†µê³„
reviewCount:0,correctCount:0,mastery:0,consecutiveWrong:0,wrongCount:0,
nextReview:null,lastReview:null,lastWrongDate:null
};
await saveExpr(expr);
}else if(addWordType==='phrasal'){
const exists=await getPV(word);
if(exists){showToast('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” êµ¬ë™ì‚¬ì…ë‹ˆë‹¤');return;}
const pv={
Phrasal_Verb:word,
Base_Verb:document.getElementById('add-base-verb').value.trim(),
Particle:document.getElementById('add-particle').value.trim(),
Meaning1_KO:meaningKo,
Meaning1_EN:document.getElementById('add-meaning-en').value.trim(),
Example1:document.getElementById('add-example').value.trim(),
Category:document.getElementById('add-pv-category').value,
Formal_Equivalent:document.getElementById('add-formal-equiv').value.trim(),
tags:tags,
starred:addBookmark,
// FSRS í•„ë“œ
stability:null,difficulty:null,fsrsState:'New',reps:0,lapses:0,
// í•™ìŠµ í†µê³„
reviewCount:0,correctCount:0,mastery:0,consecutiveWrong:0,wrongCount:0,
nextReview:null,lastReview:null,lastWrongDate:null
};
await savePV(pv);
}else{
const exists=await getWord(word);
if(exists){showToast('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹¨ì–´ì…ë‹ˆë‹¤');return;}
const userExStr=document.getElementById('add-user-examples').value.trim();
const userExamples=userExStr?userExStr.split('\n').map(e=>e.trim()).filter(e=>e):[];
const userCollStr=document.getElementById('add-user-collocs').value.trim();
const userCollocations=userCollStr?userCollStr.split(',').map(c=>c.trim()).filter(c=>c):[];
const w={
word:word,
POS:document.getElementById('add-pos').value.trim(),
Meaning1_KO:meaningKo,
Meaning1_EN:document.getElementById('add-meaning-en').value.trim(),
Example1:document.getElementById('add-example').value.trim(),
Key_Collocation:document.getElementById('add-collocation').value.trim(),
L1:document.getElementById('add-l1').value,
Difficulty:parseInt(document.getElementById('add-difficulty').value)||2,
tags:tags,
starred:addBookmark,
userExamples:userExamples,
userCollocations:userCollocations,
// FSRS í•„ë“œ
stability:null,difficulty:null,fsrsState:'New',reps:0,lapses:0,
// í•™ìŠµ í†µê³„
reviewCount:0,correctCount:0,mastery:0,consecutiveWrong:0,wrongCount:0,
nextReview:null,lastReview:null,lastWrongDate:null
};
await saveWord(w);
}
closeModal('add-word-modal');
showToast(addBookmark?'âœ… ì €ì¥ + â­ ë¶ë§ˆí¬ ì¶”ê°€':'âœ… ì¶”ê°€ ì™„ë£Œ');
updateWordTable();
updateHomeStats();
}


// === ì—…ë¡œë“œ ===
function normH(h){return(h||'').toString().toLowerCase().replace(/[_\s\-]/g,'');}
async function processFile(file){
showToast('ğŸ“¤ ì—…ë¡œë“œ ì¤‘...');
try{const data=await file.arrayBuffer(),wb=XLSX.read(data);let vS=null,pS=null,eS=null;
for(const sn of wb.SheetNames){const l=sn.toLowerCase();if(l.includes('phrasal')||l==='pv'||l.includes('êµ¬ë™ì‚¬'))pS=sn;else if(l.includes('express')||l.includes('í‘œí˜„'))eS=sn;else if(l.includes('vocab')||l.includes('word')||l==='ì–´íœ˜')vS=sn;}
if(wb.SheetNames.length>=2){if(vS&&!pS)pS=wb.SheetNames.find(s=>s!==vS&&s!==eS);if(pS&&!vS)vS=wb.SheetNames.find(s=>s!==pS&&s!==eS);}
if(!vS&&!pS&&!eS)vS=wb.SheetNames[0];
let vR=null,pR=null,eR=null;
if(vS){const json=XLSX.utils.sheet_to_json(wb.Sheets[vS],{header:1});let hr=0;for(let i=0;i<Math.min(10,json.length);i++){if(json[i]&&json[i].some(c=>c&&normH(c)==='word')){hr=i;break;}}const headers=(json[hr]||[]).map(h=>(h||'').toString());const colIdx={};headers.forEach((h,i)=>{colIdx[normH(h)]=i;});const wIdx=colIdx['word'];
if(wIdx!==undefined){let nC=0,uC=0,pC=0;const ws=[];const gC=(r,n)=>{const idx=colIdx[normH(n)];return idx!==undefined&&r[idx]!=null?r[idx].toString():'';};
for(let i=hr+1;i<json.length;i++){const r=json[i];if(!r||!r[wIdx])continue;const wK=r[wIdx].toString().trim();const ex=await getWord(wK);if(ex){uC++;if(ex.reviewCount>0)pC++;}else nC++;const starredVal=gC(r,'starred').toLowerCase();const tagsStr=gC(r,'tags');const tags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):(ex?.tags||[]);ws.push({word:wK,POS:gC(r,'POS'),Meaning1_EN:gC(r,'Meaning1_EN')||gC(r,'MeaningEN'),Meaning1_KO:gC(r,'Meaning1_KO')||gC(r,'MeaningKO'),Example1:gC(r,'Example1'),Key_Collocation:gC(r,'Key_Collocation'),L1:gC(r,'L1')||ex?.L1||'General',Difficulty:parseInt(gC(r,'Difficulty'))||ex?.Difficulty||2,TOEFL_Rel:gC(r,'TOEFL_Rel')||ex?.TOEFL_Rel||'',COCA_Genre:gC(r,'COCA_Genre')||ex?.COCA_Genre||'',COCA_Rank:parseInt(gC(r,'COCA_Rank'))||ex?.COCA_Rank||0,tags:tags,starred:starredVal==='y'||starredVal==='yes'||ex?.starred||false,
// FSRS í•„ë“œ
stability:ex?.stability||null,difficulty:ex?.difficulty||null,fsrsState:ex?.fsrsState||'New',reps:ex?.reps||0,lapses:ex?.lapses||0,
// ë ˆê±°ì‹œ (í˜¸í™˜ì„±)
interval:ex?.interval||1,ease:ex?.ease||2.5,leitnerBox:ex?.leitnerBox||1,
// í•™ìŠµ í†µê³„
mastery:ex?.mastery||0,reviewCount:ex?.reviewCount||0,correctCount:ex?.correctCount||0,consecutiveWrong:ex?.consecutiveWrong||0,wrongCount:ex?.wrongCount||0,nextReview:ex?.nextReview||null,lastReview:ex?.lastReview||null,lastWrongDate:ex?.lastWrongDate||null});}
const tx=db.transaction('words','readwrite');ws.forEach(w=>tx.objectStore('words').put(w));await new Promise(r=>{tx.oncomplete=r;});vR={total:ws.length,new:nC,update:uC,preserved:pC,sheet:vS};}}
if(pS){const json=XLSX.utils.sheet_to_json(wb.Sheets[pS],{header:1});let hr=0;for(let i=0;i<Math.min(10,json.length);i++){if(json[i]&&json[i].some(c=>c&&normH(c)==='phrasalverb')){hr=i;break;}}const headers=(json[hr]||[]).map(h=>(h||'').toString());const colIdx={};headers.forEach((h,i)=>{colIdx[normH(h)]=i;});const pvIdx=colIdx['phrasalverb'];
if(pvIdx!==undefined){let nC=0,uC=0,pC=0;const ps=[];const gC=(r,n)=>{const idx=colIdx[normH(n)];return idx!==undefined&&r[idx]!=null?r[idx].toString():'';};
for(let i=hr+1;i<json.length;i++){const r=json[i];if(!r||!r[pvIdx])continue;const pvK=r[pvIdx].toString().trim();const ex=await getPV(pvK);if(ex){uC++;if(ex.reviewCount>0)pC++;}else nC++;const starredVal=gC(r,'starred').toLowerCase();const tagsStr=gC(r,'tags');const tags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):(ex?.tags||[]);ps.push({Phrasal_Verb:pvK,Base_Verb:gC(r,'Base_Verb')||gC(r,'baseverb'),Particle:gC(r,'Particle'),Meaning1_EN:gC(r,'Meaning1_EN'),Meaning1_KO:gC(r,'Meaning1_KO'),Meaning2_EN:gC(r,'Meaning2_EN'),Meaning2_KO:gC(r,'Meaning2_KO'),Transparency:gC(r,'Transparency'),Particle_Meaning:gC(r,'Particle_Meaning'),Category:gC(r,'Category'),Register:gC(r,'Register'),Formal_Equivalent:gC(r,'Formal_Equivalent'),Separable:gC(r,'Separable'),Example1:gC(r,'Example1'),Example2:gC(r,'Example2'),Common_Error:gC(r,'Common_Error'),tags:tags,starred:starredVal==='y'||starredVal==='yes'||ex?.starred||false,
// FSRS í•„ë“œ
stability:ex?.stability||null,difficulty:ex?.difficulty||null,fsrsState:ex?.fsrsState||'New',reps:ex?.reps||0,lapses:ex?.lapses||0,
// ë ˆê±°ì‹œ (í˜¸í™˜ì„±)
interval:ex?.interval||1,ease:ex?.ease||2.5,leitnerBox:ex?.leitnerBox||1,
// í•™ìŠµ í†µê³„
mastery:ex?.mastery||0,reviewCount:ex?.reviewCount||0,correctCount:ex?.correctCount||0,consecutiveWrong:ex?.consecutiveWrong||0,wrongCount:ex?.wrongCount||0,nextReview:ex?.nextReview||null,lastReview:ex?.lastReview||null,lastWrongDate:ex?.lastWrongDate||null});}
const tx=db.transaction('phrasal_verbs','readwrite');ps.forEach(p=>tx.objectStore('phrasal_verbs').put(p));await new Promise(r=>{tx.oncomplete=r;});pR={total:ps.length,new:nC,update:uC,preserved:pC,sheet:pS};}}
// Expression ì‹œíŠ¸ ì²˜ë¦¬
if(eS){const json=XLSX.utils.sheet_to_json(wb.Sheets[eS],{header:1});let hr=0;for(let i=0;i<Math.min(10,json.length);i++){if(json[i]&&json[i].some(c=>c&&normH(c)==='expression')){hr=i;break;}}const headers=(json[hr]||[]).map(h=>(h||'').toString());const colIdx={};headers.forEach((h,i)=>{colIdx[normH(h)]=i;});const exprIdx=colIdx['expression'];
if(exprIdx!==undefined){let nC=0,uC=0,pC=0;const es=[];const gC=(r,n)=>{const idx=colIdx[normH(n)];return idx!==undefined&&r[idx]!=null?r[idx].toString():'';};
for(let i=hr+1;i<json.length;i++){const r=json[i];if(!r||!r[exprIdx])continue;const eK=r[exprIdx].toString().trim();const ex=await getExpr(eK);if(ex){uC++;if(ex.reviewCount>0)pC++;}else nC++;const starredVal=gC(r,'starred').toLowerCase();es.push({Expression:eK,L1:gC(r,'L1'),L2:gC(r,'L2'),L3:gC(r,'L3'),Function:gC(r,'Function'),Meaning_KO:gC(r,'Meaning_KO')||gC(r,'MeaningKO'),Register:gC(r,'Register')||'Neutral',Example1:gC(r,'Example1'),Example2:gC(r,'Example2'),Similar_Expr:gC(r,'Similar_Expr'),starred:starredVal==='y'||starredVal==='yes'||ex?.starred||false,
// FSRS í•„ë“œ
stability:ex?.stability||null,difficulty:ex?.difficulty||null,fsrsState:ex?.fsrsState||'New',reps:ex?.reps||0,lapses:ex?.lapses||0,
// ë ˆê±°ì‹œ (í˜¸í™˜ì„±)
interval:ex?.interval||1,ease:ex?.ease||2.5,leitnerBox:ex?.leitnerBox||1,
// í•™ìŠµ í†µê³„
mastery:ex?.mastery||0,reviewCount:ex?.reviewCount||0,correctCount:ex?.correctCount||0,consecutiveWrong:ex?.consecutiveWrong||0,wrongCount:ex?.wrongCount||0,nextReview:ex?.nextReview||null,lastReview:ex?.lastReview||null});}
const tx=db.transaction('expressions','readwrite');es.forEach(e=>tx.objectStore('expressions').put(e));await new Promise(r=>{tx.oncomplete=r;});eR={total:es.length,new:nC,update:uC,preserved:pC,sheet:eS};}}
let rHTML='';if(vR)rHTML+=`<div class="upload-result-item"><span>ğŸ“– ì–´íœ˜ (${vR.sheet})</span><span>${vR.total}ê°œ (ìƒˆ ${vR.new}, ê°±ì‹  ${vR.update}, ê¸°ë¡ë³´ì¡´ ${vR.preserved})</span></div>`;if(pR)rHTML+=`<div class="upload-result-item"><span>ğŸ”— êµ¬ë™ì‚¬ (${pR.sheet})</span><span>${pR.total}ê°œ (ìƒˆ ${pR.new}, ê°±ì‹  ${pR.update}, ê¸°ë¡ë³´ì¡´ ${pR.preserved})</span></div>`;if(eR)rHTML+=`<div class="upload-result-item"><span>ğŸ’¬ í‘œí˜„ (${eR.sheet})</span><span>${eR.total}ê°œ (ìƒˆ ${eR.new}, ê°±ì‹  ${eR.update}, ê¸°ë¡ë³´ì¡´ ${eR.preserved})</span></div>`;if(!vR&&!pR&&!eR)rHTML=`<div class="upload-result-item"><span>âš ï¸ ì¸ì‹ëœ ë°ì´í„° ì—†ìŒ</span><span>ì‹œíŠ¸: ${wb.SheetNames.join(', ')}</span></div>`;
if(rHTML){document.getElementById('upload-result').innerHTML=rHTML;document.getElementById('upload-result').classList.remove('hidden');}
showToast('âœ… ì—…ë¡œë“œ ì™„ë£Œ!');vibrate();updateHomeStats();updateDataPage();
}catch(e){console.error(e);showToast('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message);}}
const uploadZone=document.getElementById('upload-zone'),fileInput=document.getElementById('file-input');
uploadZone?.addEventListener('click',()=>fileInput?.click());
fileInput?.addEventListener('change',e=>{const file=e.target.files[0];if(file)processFile(file);e.target.value='';});
// ì „ì—­ ë“œë˜ê·¸ ë°©ì§€ (ë¸Œë¼ìš°ì €ê°€ íŒŒì¼ ì—´ê¸° ì‹œë„ ì°¨ë‹¨)
document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',e=>e.preventDefault());
// ì—…ë¡œë“œ ì¡´ ë“œë˜ê·¸ ì•¤ ë“œë¡­
['dragenter','dragover'].forEach(ev=>uploadZone?.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();uploadZone.classList.add('dragover');}));
['dragleave','dragend'].forEach(ev=>uploadZone?.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();uploadZone.classList.remove('dragover');}));
uploadZone?.addEventListener('drop',e=>{e.preventDefault();e.stopPropagation();uploadZone.classList.remove('dragover');const file=e.dataTransfer?.files?.[0];console.log('Drop file:',file?.name);if(file&&(file.name.endsWith('.xlsx')||file.name.endsWith('.xls'))){processFile(file);}else if(file){showToast('âš ï¸ ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');}});

// === ë°ì´í„° ê´€ë¦¬ ===
async function clearDB(store){const name=store==='phrasal_verbs'?'êµ¬ë™ì‚¬':store==='expressions'?'í‘œí˜„':'ì–´íœ˜';showConfirm(name+' ì´ˆê¸°í™”',name+' ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?',async()=>{const tx=db.transaction([store],'readwrite');tx.objectStore(store).clear();await new Promise(r=>{tx.oncomplete=r;});showToast('ğŸ—‘ï¸ '+name+' ì´ˆê¸°í™” ì™„ë£Œ');updateHomeStats();updateDataPage();});}
async function resetWrongNotes(){showConfirm('ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”','ëª¨ë“  ì˜¤ë‹µ ê¸°ë¡ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?',async()=>{const w=await getAllWords(),p=await getAllPV();for(const x of w){x.consecutiveWrong=0;x.wrongCount=0;x.lastWrongDate=null;await saveWord(x);}for(const x of p){x.consecutiveWrong=0;x.wrongCount=0;x.lastWrongDate=null;await savePV(x);}showToast('ğŸ§¹ ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');updateHomeStats();});}
async function exportAllData(){const w=await getAllWords(),p=await getAllPV(),e=await getAllExpr(),s=await getSessions();const data={words:w,phrasal_verbs:p,expressions:e,sessions:s,exportDate:new Date().toISOString(),version:'6.0'};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='cems_backup_'+new Date().toISOString().slice(0,10)+'.json';a.click();showToast('ğŸ“¥ ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ');}
function importData(){const input=document.createElement('input');input.type='file';input.accept='.json';input.onchange=async ev=>{try{const txt=await ev.target.files[0].text(),data=JSON.parse(txt);if(data.words?.length){const tx=db.transaction('words','readwrite');data.words.forEach(w=>tx.objectStore('words').put(w));await new Promise(r=>{tx.oncomplete=r;});}if(data.phrasal_verbs?.length){const tx=db.transaction('phrasal_verbs','readwrite');data.phrasal_verbs.forEach(p=>tx.objectStore('phrasal_verbs').put(p));await new Promise(r=>{tx.oncomplete=r;});}if(data.expressions?.length){const tx=db.transaction('expressions','readwrite');data.expressions.forEach(e=>tx.objectStore('expressions').put(e));await new Promise(r=>{tx.oncomplete=r;});}if(data.sessions?.length){const tx=db.transaction('sessions','readwrite');data.sessions.forEach(s=>{delete s.id;tx.objectStore('sessions').add(s);});await new Promise(r=>{tx.oncomplete=r;});}showToast('âœ… ë°ì´í„° ë³µì› ì™„ë£Œ');updateHomeStats();updateDataPage();}catch(err){console.error(err);showToast('âŒ ë³µì› ì‹¤íŒ¨: '+err.message);}};input.click();}
function resetAllData(){showConfirm('ì „ì²´ ì´ˆê¸°í™”','ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?',()=>{indexedDB.deleteDatabase(DB_NAME);localStorage.clear();showToast('ğŸ—‘ï¸ ì´ˆê¸°í™” ì™„ë£Œ');setTimeout(()=>location.reload(),1000);});}

// === ë‹¨ì–´ í¸ì§‘ ===
let editingItem=null,editingType='vocab';
async function openEditModal(key,type){
editingType=type;
document.getElementById('edit-vocab-fields').style.display=type==='vocab'?'block':'none';
document.getElementById('edit-pv-fields').style.display=type==='phrasal'?'block':'none';
if(type==='phrasal'){editingItem=await getPV(key);if(!editingItem)return;
document.getElementById('edit-word').value=editingItem.Phrasal_Verb||'';
document.getElementById('edit-meaning-ko').value=getMKO(editingItem)||'';
document.getElementById('edit-meaning-en').value=getMEN(editingItem)||'';
document.getElementById('edit-example').value=getEx(editingItem)||'';
document.getElementById('edit-pos').value=editingItem.Base_Verb||'';
document.getElementById('edit-pv-category').value=editingItem.Category||'General';
document.getElementById('edit-formal-equiv').value=editingItem.Formal_Equivalent||'';
}else{editingItem=await getWord(key);if(!editingItem)return;
document.getElementById('edit-word').value=editingItem.word||'';
document.getElementById('edit-meaning-ko').value=getMKO(editingItem)||'';
document.getElementById('edit-meaning-en').value=getMEN(editingItem)||'';
document.getElementById('edit-example').value=getEx(editingItem)||'';
document.getElementById('edit-pos').value=editingItem.POS||'';
document.getElementById('edit-l1').value=editingItem.L1||'General';
document.getElementById('edit-difficulty').value=editingItem.Difficulty||2;
document.getElementById('edit-collocation').value=editingItem.Key_Collocation||'';
document.getElementById('edit-user-examples').value=(editingItem.userExamples||[]).join('\n');
document.getElementById('edit-user-collocs').value=(editingItem.userCollocations||[]).join(', ');
}
const acc=getAcc(editingItem);
document.getElementById('edit-review-count').textContent=editingItem.reviewCount||0;
document.getElementById('edit-accuracy').textContent=acc!==null?acc+'%':'-';
document.getElementById('edit-box').textContent=editingItem.leitnerBox||1;
document.getElementById('edit-wrong-count').textContent=editingItem.wrongCount||0;
document.getElementById('edit-ease').textContent=(editingItem.ease||2.5).toFixed(2);
const nextRev=editingItem.nextReview?new Date(editingItem.nextReview):null;
document.getElementById('edit-next-review').textContent=nextRev?`${nextRev.getMonth()+1}/${nextRev.getDate()}`:'-';
document.getElementById('edit-bookmark-btn').textContent=editingItem.starred?'â­ ë¶ë§ˆí¬ í•´ì œ':'â˜† ë¶ë§ˆí¬';
document.getElementById('edit-bookmark-btn').style.color=editingItem.starred?'var(--warning)':'';
document.getElementById('edit-tags').value=(editingItem.tags||[]).join(', ');
showModal('edit-modal');
}
async function saveEditedWord(){
if(!editingItem){showToast('âŒ í¸ì§‘í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');return;}
try{
editingItem.Meaning1_KO=document.getElementById('edit-meaning-ko').value;
editingItem.Meaning1_EN=document.getElementById('edit-meaning-en').value;
editingItem.Example1=document.getElementById('edit-example').value;
const tagsStr=document.getElementById('edit-tags').value.trim();
editingItem.tags=tagsStr?tagsStr.split(',').map(t=>t.trim()).filter(t=>t):[];
if(editingType==='phrasal'){
editingItem.Base_Verb=document.getElementById('edit-pos').value;
editingItem.Category=document.getElementById('edit-pv-category').value;
editingItem.Formal_Equivalent=document.getElementById('edit-formal-equiv').value;
await savePV(editingItem);
}else{
editingItem.POS=document.getElementById('edit-pos').value;
editingItem.L1=document.getElementById('edit-l1').value;
editingItem.Difficulty=parseInt(document.getElementById('edit-difficulty').value)||2;
editingItem.Key_Collocation=document.getElementById('edit-collocation').value;
const userExStr=document.getElementById('edit-user-examples').value.trim();
editingItem.userExamples=userExStr?userExStr.split('\n').map(e=>e.trim()).filter(e=>e):[];
const userCollStr=document.getElementById('edit-user-collocs').value.trim();
editingItem.userCollocations=userCollStr?userCollStr.split(',').map(c=>c.trim()).filter(c=>c):[];
await saveWord(editingItem);
}
// í•™ìŠµ ì¤‘ ìƒíƒœ ì—…ë°ì´íŠ¸
syncEditToStudyState();
closeModal('edit-modal');showToast('âœ… ì €ì¥ ì™„ë£Œ');
updateWordTable();updateHomeStats();
}catch(e){console.error('Save error:',e);showToast('âŒ ì €ì¥ ì‹¤íŒ¨: '+e.message);}
}
function syncEditToStudyState(){
if(!editingItem)return;
const key=editingType==='phrasal'?editingItem.Phrasal_Verb:editingItem.word;
// í”Œë˜ì‹œì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
if(fcState.words?.length){
const idx=fcState.words.findIndex(w=>getW(w)===key);
if(idx>=0)Object.assign(fcState.words[idx],editingItem);
}
// í€´ì¦ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
if(quizState.words?.length){
const idx=quizState.words.findIndex(w=>getW(w)===key);
if(idx>=0)Object.assign(quizState.words[idx],editingItem);
}
// íƒ€ì´í•‘ ìƒíƒœ ì—…ë°ì´íŠ¸
if(typingState.words?.length){
const idx=typingState.words.findIndex(w=>getW(w)===key);
if(idx>=0)Object.assign(typingState.words[idx],editingItem);
}
}
async function resetWordStats(){
if(!editingItem)return;
showConfirm('í•™ìŠµ ê¸°ë¡ ì´ˆê¸°í™”','ì´ ë‹¨ì–´ì˜ í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?',async()=>{
// FSRS í•„ë“œ ì´ˆê¸°í™”
editingItem.stability=null;editingItem.difficulty=null;
editingItem.fsrsState='New';editingItem.reps=0;editingItem.lapses=0;
// í•™ìŠµ í†µê³„ ì´ˆê¸°í™”
editingItem.reviewCount=0;editingItem.correctCount=0;editingItem.mastery=0;
editingItem.consecutiveWrong=0;editingItem.wrongCount=0;
editingItem.nextReview=null;editingItem.lastReview=null;editingItem.lastWrongDate=null;
// ë ˆê±°ì‹œ í•„ë“œ (í˜¸í™˜ì„±)
editingItem.leitnerBox=1;editingItem.interval=1;editingItem.ease=2.5;
if(editingType==='phrasal')await savePV(editingItem);else await saveWord(editingItem);
closeModal('edit-modal');showToast('ğŸ”„ ì´ˆê¸°í™” ì™„ë£Œ');updateWordTable();updateHomeStats();
});
}

// === í•™ìŠµê¸°ë¡ í¬í•¨ ì—‘ì…€ Export ===
async function exportWithStats(){
showToast('ğŸ“Š ì—‘ì…€ ìƒì„± ì¤‘...');
try{
const words=await getAllWords(),pvs=await getAllPV();
// ì–´íœ˜ ì‹œíŠ¸ ë°ì´í„° (TOEFL_Rel, COCA ì¶”ê°€)
const vocabData=[['word','POS','Meaning1_KO','Meaning1_EN','Example1','Key_Collocation','L1','Difficulty','TOEFL_Rel','COCA_Genre','COCA_Rank','tags','starred','needsProduction','reviewCount','correctCount','accuracy','leitnerBox','ease','mastery','wrongCount','consecutiveWrong','nextReview','lastReview','userExamples','userCollocations']];
words.forEach(w=>{const acc=getAcc(w);vocabData.push([w.word,w.POS||'',getMKO(w),getMEN(w),getEx(w),w.Key_Collocation||'',w.L1||'',w.Difficulty||2,w.TOEFL_Rel||'',w.COCA_Genre||'',w.COCA_Rank||'',(w.tags||[]).join(','),w.starred?'Y':'',w.needsProduction?'Y':'',w.reviewCount||0,w.correctCount||0,acc!==null?acc:'',(w.leitnerBox||1),(w.ease||2.5).toFixed(2),w.mastery||0,w.wrongCount||0,w.consecutiveWrong||0,w.nextReview||'',w.lastReview||'',(w.userExamples||[]).join(' | '),(w.userCollocations||[]).join(', ')]);});
// êµ¬ë™ì‚¬ ì‹œíŠ¸ ë°ì´í„°
const pvData=[['Phrasal_Verb','Base_Verb','Particle','Meaning1_KO','Meaning1_EN','Example1','Category','Formal_Equivalent','tags','starred','needsProduction','reviewCount','correctCount','accuracy','leitnerBox','ease','mastery','wrongCount','consecutiveWrong','nextReview','lastReview']];
pvs.forEach(p=>{const acc=getAcc(p);pvData.push([p.Phrasal_Verb,p.Base_Verb||'',p.Particle||'',getMKO(p),getMEN(p),getEx(p),p.Category||'',p.Formal_Equivalent||'',(p.tags||[]).join(','),p.starred?'Y':'',p.needsProduction?'Y':'',p.reviewCount||0,p.correctCount||0,acc!==null?acc:'',(p.leitnerBox||1),(p.ease||2.5).toFixed(2),p.mastery||0,p.wrongCount||0,p.consecutiveWrong||0,p.nextReview||'',p.lastReview||'']);});
// ì›Œí¬ë¶ ìƒì„±
const wb=XLSX.utils.book_new();
if(words.length){const ws1=XLSX.utils.aoa_to_sheet(vocabData);XLSX.utils.book_append_sheet(wb,ws1,'Vocabulary');}
if(pvs.length){const ws2=XLSX.utils.aoa_to_sheet(pvData);XLSX.utils.book_append_sheet(wb,ws2,'Phrasal_Verbs');}
// ë‹¤ìš´ë¡œë“œ
XLSX.writeFile(wb,'CEMS_í•™ìŠµê¸°ë¡_'+new Date().toISOString().slice(0,10)+'.xlsx');
showToast('âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}catch(e){console.error(e);showToast('âŒ Export ì‹¤íŒ¨: '+e.message);}
}

// === ë¶ë§ˆí¬ í† ê¸€ ===
async function toggleBookmark(){
if(!editingItem)return;
editingItem.starred=!editingItem.starred;
document.getElementById('edit-bookmark-btn').textContent=editingItem.starred?'â­ ë¶ë§ˆí¬ í•´ì œ':'â˜† ë¶ë§ˆí¬';
document.getElementById('edit-bookmark-btn').style.color=editingItem.starred?'var(--warning)':'';
if(editingType==='phrasal')await savePV(editingItem);else await saveWord(editingItem);
showToast(editingItem.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
updateHomeStats();
}

// === ë‹¨ì–´ ê³µìœ /ë³µì‚¬ ===
function getWordText(){
if(!editingItem)return'';
const w=editingType==='phrasal'?editingItem.Phrasal_Verb:editingItem.word;
const m=getMKO(editingItem)||'';
const ex=getEx(editingItem)||'';
let text=`ğŸ“š ${w}\nëœ»: ${m}`;
if(ex)text+=`\nì˜ˆë¬¸: ${ex}`;
return text;
}
async function shareWord(){
if(!editingItem)return;
const text=getWordText();
if(navigator.share){
try{await navigator.share({title:getW(editingItem),text:text});showToast('ğŸ“¤ ê³µìœ  ì™„ë£Œ');}
catch(e){if(e.name!=='AbortError')copyWord();}
}else{copyWord();}
}
function copyWord(){
if(!editingItem)return;
const text=getWordText();
navigator.clipboard.writeText(text).then(()=>showToast('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨')).catch(()=>showToast('âŒ ë³µì‚¬ ì‹¤íŒ¨'));
}

// === ë‹¨ì–´ ì‚­ì œ ===
async function deleteWord(){
if(!editingItem)return;
const key=editingType==='phrasal'?editingItem.Phrasal_Verb:editingItem.word;
showConfirm('ë‹¨ì–´ ì‚­ì œ',`"${key}"ë¥¼ ì‚­ì œí• ê¹Œìš”? í•™ìŠµ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`,async()=>{
try{
const store=editingType==='phrasal'?'phrasal_verbs':'words';
const tx=db.transaction(store,'readwrite');
tx.objectStore(store).delete(key);
await new Promise(r=>{tx.oncomplete=r;});
// í•™ìŠµ ì¤‘ ìƒíƒœì—ì„œ ì‚­ì œ
removeFromStudyState(key);
closeModal('edit-modal');showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
updateWordTable();updateHomeStats();
}catch(e){showToast('âŒ ì‚­ì œ ì‹¤íŒ¨');}
});
}
function removeFromStudyState(key){
// í”Œë˜ì‹œì¹´ë“œ
if(fcState.words?.length){
const idx=fcState.words.findIndex(w=>getW(w)===key);
if(idx>=0){fcState.words.splice(idx,1);if(fcState.idx>=fcState.words.length)fcState.idx=Math.max(0,fcState.words.length-1);}
}
// í€´ì¦ˆ
if(quizState.words?.length){
const idx=quizState.words.findIndex(w=>getW(w)===key);
if(idx>=0){quizState.words.splice(idx,1);if(quizState.idx>=quizState.words.length)quizState.idx=Math.max(0,quizState.words.length-1);}
}
// íƒ€ì´í•‘
if(typingState.words?.length){
const idx=typingState.words.findIndex(w=>getW(w)===key);
if(idx>=0){typingState.words.splice(idx,1);if(typingState.idx>=typingState.words.length)typingState.idx=Math.max(0,typingState.words.length-1);}
}
}

// === ì¼ì¼ ëª©í‘œ ì—…ë°ì´íŠ¸ ===
async function updateDailyGoal(){
const today=new Date().toDateString();
const sessions=await getSessions();
const todaySessions=sessions.filter(s=>new Date(s.date).toDateString()===today);
// íƒ€ì…ë³„ ì§‘ê³„
const vocabTotal=todaySessions.filter(s=>s.type==='vocab').reduce((sum,s)=>sum+(s.total||0),0);
const pvTotal=todaySessions.filter(s=>s.type==='phrasal').reduce((sum,s)=>sum+(s.total||0),0);
const exprTotal=todaySessions.filter(s=>s.type==='expr').reduce((sum,s)=>sum+(s.total||0),0);
// ëª©í‘œ ê°€ì ¸ì˜¤ê¸°
const vocabGoal=parseInt(localStorage.getItem('vocabGoal')||'20');
const pvGoal=parseInt(localStorage.getItem('pvGoal')||'10');
const exprGoal=parseInt(localStorage.getItem('exprGoal')||'10');
// í¼ì„¼íŠ¸ ê³„ì‚°
const vocabPct=Math.min(100,Math.round((vocabTotal/vocabGoal)*100));
const pvPct=Math.min(100,Math.round((pvTotal/pvGoal)*100));
const exprPct=Math.min(100,Math.round((exprTotal/exprGoal)*100));
// ì–´íœ˜ ëª©í‘œ UI
document.getElementById('daily-vocab-done').textContent=vocabTotal;
document.getElementById('daily-vocab-target').textContent=vocabGoal;
document.getElementById('daily-vocab-progress').style.width=vocabPct+'%';
// êµ¬ë™ì‚¬ ëª©í‘œ UI
document.getElementById('daily-pv-done').textContent=pvTotal;
document.getElementById('daily-pv-target').textContent=pvGoal;
document.getElementById('daily-pv-progress').style.width=pvPct+'%';
// í‘œí˜„ ëª©í‘œ UI
document.getElementById('daily-expr-done').textContent=exprTotal;
document.getElementById('daily-expr-target').textContent=exprGoal;
document.getElementById('daily-expr-progress').style.width=exprPct+'%';
// ì „ì²´ ëª©í‘œ (ê° íƒ€ì… ëª©í‘œê¹Œì§€ë§Œ ì¹´ìš´íŠ¸)
const vocabCapped=Math.min(vocabTotal,vocabGoal);
const pvCapped=Math.min(pvTotal,pvGoal);
const exprCapped=Math.min(exprTotal,exprGoal);
const totalDone=vocabCapped+pvCapped+exprCapped;
const totalGoal=vocabGoal+pvGoal+exprGoal;
const totalPct=Math.min(100,Math.round((totalDone/totalGoal)*100));
document.getElementById('daily-done').textContent=totalDone;
document.getElementById('daily-target').textContent=totalGoal;
document.getElementById('daily-total-progress').style.width=totalPct+'%';
document.getElementById('daily-percent').textContent=totalPct+'%';
document.getElementById('daily-percent').style.color=totalPct>=100?'var(--success)':'#f97316';
}

// === í•™ìŠµ ì¤‘ ë¶ë§ˆí¬ í† ê¸€ ===
async function toggleFCBookmark(){
const item=fcState.words[fcState.idx];if(!item)return;
item.starred=!item.starred;
if(fcState.type==='phrasal')await savePV(item);else await saveWord(item);
updateFCBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updateFCBookmarkBtn(){
const item=fcState.words?.[fcState.idx];
const btn=document.getElementById('fc-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â­':'â˜†';btn.style.color=item.starred?'var(--warning)':'';}
}
async function toggleFCProduction(){
const item=fcState.words[fcState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
if(fcState.type==='phrasal')await savePV(item);else await saveWord(item);
updateFCProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì— ì¶”ê°€':'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ');
}
function updateFCProductionBtn(){
const item=fcState.words?.[fcState.idx];
const btn=document.getElementById('fc-production-btn');
if(btn&&item){
btn.textContent=item.needsProduction?'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ':'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”';
btn.style.background=item.needsProduction?'rgba(34,197,94,.2)':'';
btn.style.color=item.needsProduction?'var(--success)':'';
}
}
// === íƒœê·¸ ê´€ë¦¬ ===
let tagContext={item:null,type:'vocab',mode:'fc'};
function openFCTagMenu(){
const item=fcState.words[fcState.idx];if(!item)return;
tagContext={item,type:fcState.type,mode:'fc'};
openTagModal(item,fcState.type);
}
function openQuizTagMenu(){
const item=quizState.words[quizState.idx];if(!item)return;
tagContext={item,type:quizState.type,mode:'quiz'};
openTagModal(item,quizState.type);
}
function openTagModal(item,type){
const word=type==='phrasal'?item.Phrasal_Verb:type==='expr'?item.Expression:displayWord(item.word);
document.getElementById('tag-word-display').textContent=word;
renderCurrentTags(item);
renderPresetTags(item);
document.getElementById('new-tag-input').value='';
showModal('tag-modal');
}
function renderCurrentTags(item){
const tags=item.tags||[];
const container=document.getElementById('current-tags');
if(tags.length===0){container.innerHTML='<span style="color:var(--muted);font-size:12px">íƒœê·¸ ì—†ìŒ</span>';return;}
container.innerHTML=tags.map(t=>`<span class="chip active" style="padding:6px 10px;cursor:pointer" onclick="removeTag('${t.replace(/'/g,"\\'")}')">${t} âœ•</span>`).join('');
}
function renderPresetTags(item){
const tags=item.tags||[];
const container=document.getElementById('preset-tags');
container.innerHTML=PRESET_TAGS.filter(t=>!tags.includes(t)).map(t=>`<span class="chip" style="padding:6px 10px;cursor:pointer" onclick="addTag('${t}')">${t}</span>`).join('');
if(container.innerHTML==='')container.innerHTML='<span style="color:var(--muted);font-size:12px">ëª¨ë“  í”„ë¦¬ì…‹ íƒœê·¸ê°€ ì ìš©ë¨</span>';
}
async function addTag(tag){
const item=tagContext.item;if(!item||!tag)return;
if(!item.tags)item.tags=[];
if(item.tags.includes(tag))return;
item.tags.push(tag);
if(tagContext.type==='phrasal')await savePV(item);
else if(tagContext.type==='expr')await saveExpr(item);
else await saveWord(item);
renderCurrentTags(item);
renderPresetTags(item);
if(tagContext.type==='expr'){
if(tagContext.mode==='quiz')updateExprQuizTagBtn();else updateExprFCTagBtn();
}else{
if(tagContext.mode==='quiz')updateQuizTagBtn();else updateFCTagBtn();
}
showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ ì¶”ê°€');
}
async function removeTag(tag){
const item=tagContext.item;if(!item||!item.tags)return;
const idx=item.tags.indexOf(tag);
if(idx>=0)item.tags.splice(idx,1);
if(tagContext.type==='phrasal')await savePV(item);
else if(tagContext.type==='expr')await saveExpr(item);
else await saveWord(item);
renderCurrentTags(item);
renderPresetTags(item);
if(tagContext.type==='expr'){
if(tagContext.mode==='quiz')updateExprQuizTagBtn();else updateExprFCTagBtn();
}else{
if(tagContext.mode==='quiz')updateQuizTagBtn();else updateFCTagBtn();
}
showToast('ğŸ·ï¸ "'+tag+'" íƒœê·¸ ì œê±°');
}
async function addCustomTag(){
const input=document.getElementById('new-tag-input');
const tag=input.value.trim();
if(!tag){showToast('íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
await addTag(tag);
input.value='';
}
function updateFCTagBtn(){
const item=fcState.words?.[fcState.idx];
const btn=document.getElementById('fc-tag-btn');
if(btn&&item){
const count=(item.tags||[]).length;
btn.textContent=count>0?`ğŸ·ï¸ íƒœê·¸ (${count})`:'ğŸ·ï¸ íƒœê·¸';
btn.style.color=count>0?'var(--primary)':'';
}
}
function updateQuizTagBtn(){
const item=quizState.words?.[quizState.idx];
const btn=document.getElementById('quiz-tag-btn');
if(btn&&item){
const count=(item.tags||[]).length;
btn.textContent=count>0?`ğŸ·ï¸ (${count})`:'ğŸ·ï¸ íƒœê·¸';
btn.style.color=count>0?'var(--primary)':'';
}
}
// í‘œí˜„ íƒœê·¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤
function openExprFCTagMenu(){
const item=exprState.words[exprState.idx];if(!item)return;
tagContext={item,type:'expr',mode:'fc'};
openTagModal(item,'expr');
}
function openExprQuizTagMenu(){
const item=exprState.words[exprState.idx];if(!item)return;
tagContext={item,type:'expr',mode:'quiz'};
openTagModal(item,'expr');
}
function updateExprFCTagBtn(){
const item=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-fc-tag-btn');
if(btn&&item){
const count=(item.tags||[]).length;
btn.textContent=count>0?`ğŸ·ï¸ íƒœê·¸ (${count})`:'ğŸ·ï¸ íƒœê·¸';
btn.style.color=count>0?'var(--primary)':'';
}
}
async function toggleExprFCProduction(){
const item=exprState.words[exprState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
await saveExpr(item);
updateExprFCProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ ëª©ë¡ì— ì¶”ê°€':'âœ… ì“°ê¸° ì—°ìŠµ ëª©ë¡ì—ì„œ ì œê±°');
}
function updateExprFCProductionBtn(){
const item=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-fc-production-btn');
if(btn&&item){
btn.textContent=item.needsProduction?'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ ì¤‘':'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ í•„ìš”';
btn.style.color=item.needsProduction?'var(--warning)':'';
}
}
function updateExprQuizTagBtn(){
const item=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-quiz-tag-btn');
if(btn&&item){
const count=(item.tags||[]).length;
btn.textContent=count>0?`ğŸ·ï¸ (${count})`:'ğŸ·ï¸ íƒœê·¸';
btn.style.color=count>0?'var(--primary)':'';
}
}
async function toggleExprQuizProduction(){
const item=exprState.words[exprState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
await saveExpr(item);
updateExprQuizProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ ëª©ë¡ì— ì¶”ê°€':'âœ… ì“°ê¸° ì—°ìŠµ ëª©ë¡ì—ì„œ ì œê±°');
}
function updateExprQuizProductionBtn(){
const item=exprState.words?.[exprState.idx];
const btn=document.getElementById('expr-quiz-production-btn');
if(btn&&item){
btn.textContent=item.needsProduction?'ğŸ–Šï¸ ì—°ìŠµì¤‘':'ğŸ–Šï¸ ì“°ê¸°';
btn.style.color=item.needsProduction?'var(--warning)':'';
}
}
async function openFCEdit(){
const item=fcState.words[fcState.idx];if(!item)return;
const key=fcState.type==='phrasal'?item.Phrasal_Verb:item.word;
await openEditModal(key,fcState.type);
}
async function toggleQuizBookmark(){
const item=quizState.words[quizState.idx];if(!item)return;
item.starred=!item.starred;
await saveWord(item);
updateQuizBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updateQuizBookmarkBtn(){
const item=quizState.words?.[quizState.idx];
const btn=document.getElementById('quiz-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â­ í•´ì œ':'â˜† ë¶ë§ˆí¬';btn.style.color=item.starred?'var(--warning)':'';}
}
async function toggleQuizProduction(){
const item=quizState.words[quizState.idx];if(!item)return;
item.needsProduction=!item.needsProduction;
await saveWord(item);
updateQuizProductionBtn();
showToast(item.needsProduction?'ğŸ–Šï¸ ì‚°ì¶œ ì—°ìŠµ ëª©ë¡ì— ì¶”ê°€':'âœ… ì‚°ì¶œ ì—°ìŠµ í•´ì œ');
}
function updateQuizProductionBtn(){
const item=quizState.words?.[quizState.idx];
const btn=document.getElementById('quiz-production-btn');
if(btn&&item){
btn.textContent=item.needsProduction?'âœ… í•´ì œ':'ğŸ–Šï¸ ì“°ê¸° ì—°ìŠµ';
btn.style.background=item.needsProduction?'rgba(34,197,94,.2)':'';
btn.style.color=item.needsProduction?'var(--success)':'';
}
}
async function openQuizEdit(){
const item=quizState.words[quizState.idx];if(!item)return;
await openEditModal(item.word,'vocab');
}
async function toggleTypingBookmark(){
const item=typingState.words[typingState.idx];if(!item)return;
item.starred=!item.starred;
await saveWord(item);
updateTypingBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updateTypingBookmarkBtn(){
const item=typingState.words?.[typingState.idx];
const btn=document.getElementById('typing-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â­ ë¶ë§ˆí¬ í•´ì œ':'â˜† ë¶ë§ˆí¬';btn.style.color=item.starred?'var(--warning)':'';}
}
async function openTypingEdit(){
const item=typingState.words[typingState.idx];if(!item)return;
await openEditModal(item.word,'vocab');
}
async function togglePVPBookmark(){
const item=pvState.words[pvState.idx];if(!item)return;
item.starred=!item.starred;
await savePV(item);
updatePVPBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updatePVPBookmarkBtn(){
const item=pvState.words?.[pvState.idx];
const btn=document.getElementById('pvp-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â­ ë¶ë§ˆí¬ í•´ì œ':'â˜† ë¶ë§ˆí¬';btn.style.color=item.starred?'var(--warning)':'';}
}
async function openPVPEdit(){
const item=pvState.words[pvState.idx];if(!item)return;
await openEditModal(item.Phrasal_Verb,'phrasal');
}
async function togglePVQBookmark(){
const item=pvState.words[pvState.idx];if(!item)return;
item.starred=!item.starred;
await savePV(item);
updatePVQBookmarkBtn();
showToast(item.starred?'â­ ë¶ë§ˆí¬ ì¶”ê°€':'â˜† ë¶ë§ˆí¬ í•´ì œ');
}
function updatePVQBookmarkBtn(){
const item=pvState.words?.[pvState.idx];
const btn=document.getElementById('pvq-bookmark-btn');
if(btn&&item){btn.textContent=item.starred?'â­ ë¶ë§ˆí¬ í•´ì œ':'â˜† ë¶ë§ˆí¬';btn.style.color=item.starred?'var(--warning)':'';}
}
async function openPVQEdit(){
const item=pvState.words[pvState.idx];if(!item)return;
await openEditModal(item.Phrasal_Verb,'phrasal');
}
function saveSetting(k,v){localStorage.setItem(k,v);if(k.includes('Goal'))updateDailyGoal();if(k==='defaultCount')updateStudyCountSliders(parseInt(v));}
// í•™ìŠµë¶„ëŸ‰ ìŠ¬ë¼ì´ë” max ë° value ì—…ë°ì´íŠ¸
function updateStudyCountSliders(maxCount){
const sliders=[
{id:'study-count',valId:'study-count-val'},
{id:'pv-study-count',valId:'pv-study-count-val'},
{id:'expr-study-count',valId:'expr-study-count-val'}
];
sliders.forEach(s=>{
const el=document.getElementById(s.id);
const valEl=document.getElementById(s.valId);
if(el&&valEl){
el.setAttribute('max',maxCount);
const currentVal=parseInt(el.value)||maxCount;
// í˜„ì¬ ê°’ì´ maxë³´ë‹¤ í¬ë©´ maxë¡œ ì¡°ì •
const newVal=Math.min(currentVal,maxCount);
el.value=newVal;
valEl.textContent=newVal;
}
});
}
function adjustGoal(type,delta){
const map={vocab:'setting-vocab-goal',pv:'setting-pv-goal',expr:'setting-expr-goal',count:'setting-count'};
const keyMap={vocab:'vocabGoal',pv:'pvGoal',expr:'exprGoal',count:'defaultCount'};
const el=document.getElementById(map[type]);if(!el)return;
const min=type==='count'?5:1;
let val=Math.max(min,Math.min(100,parseInt(el.value||min)+delta));
el.value=val;
saveSetting(keyMap[type],val);
}
function toggleTheme(){
const dark=document.getElementById('setting-dark').checked;
const bgColor=dark?'#0f172a':'#f8fafc';
document.documentElement.style.setProperty('--bg',bgColor);
document.documentElement.style.setProperty('--bg2',dark?'#1e293b':'#fff');
document.documentElement.style.setProperty('--card',dark?'#1e293b':'#fff');
document.documentElement.style.setProperty('--text',dark?'#f1f5f9':'#1e293b');
document.documentElement.style.setProperty('--muted',dark?'#94a3b8':'#64748b');
document.documentElement.style.setProperty('--border',dark?'#334155':'#e2e8f0');
// ë…¸ì¹˜ ìƒ‰ìƒë„ ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ
document.querySelector('meta[name="theme-color"]')?.setAttribute('content',bgColor);
localStorage.setItem('theme',dark?'dark':'light');
}
// iOS Safari IndexedDB ë°ì´í„° ì†ì‹¤ ë°©ì§€
async function requestPersistentStorage(){
if(navigator.storage&&navigator.storage.persist){
try{
const isPersisted=await navigator.storage.persisted();
if(!isPersisted){
const granted=await navigator.storage.persist();
console.log('Persistent storage:',granted?'granted':'denied');
}
}catch(e){console.log('Storage persist not supported');}
}
}

async function init(){
// iOS Safari ë°ì´í„° ë³´í˜¸ ìš”ì²­
await requestPersistentStorage();
const theme=localStorage.getItem('theme')||'dark';
// ì €ì¥ëœ í…Œë§ˆì— ë”°ë¼ ì¦‰ì‹œ theme-color ì„¤ì • (ìŠ¤í”Œë˜ì‹œì™€ ë…¸ì¹˜ ì—°ì†ì„±)
const initBgColor=theme==='dark'?'#0f172a':'#f8fafc';
document.querySelector('meta[name="theme-color"]')?.setAttribute('content',initBgColor);
if(theme==='light'){
document.documentElement.style.setProperty('--bg','#f8fafc');
document.documentElement.style.setProperty('--bg2','#fff');
document.documentElement.style.setProperty('--card','#fff');
document.documentElement.style.setProperty('--text','#1e293b');
document.documentElement.style.setProperty('--muted','#64748b');
document.documentElement.style.setProperty('--border','#e2e8f0');
}
document.getElementById('setting-dark').checked=theme==='dark';
// TTS ì„¤ì • ë¡œë“œ
const tts=localStorage.getItem('tts');
document.getElementById('setting-tts').checked=tts==='true';
// ì§„ë™ ì„¤ì • ë¡œë“œ (ê¸°ë³¸ê°’ true)
const vib=localStorage.getItem('vibrate');
document.getElementById('setting-vibrate').checked=vib!=='false';
// í•™ìŠµ ì„¤ì • ë¡œë“œ
const dc=localStorage.getItem('defaultCount')||'20';
document.getElementById('setting-count').value=dc;
// ìŠ¬ë¼ì´ë” maxì™€ value ì„¤ì •
updateStudyCountSliders(parseInt(dc));
const vg=localStorage.getItem('vocabGoal');if(vg)document.getElementById('setting-vocab-goal').value=vg;
const pg=localStorage.getItem('pvGoal');if(pg)document.getElementById('setting-pv-goal').value=pg;
const eg=localStorage.getItem('exprGoal');if(eg)document.getElementById('setting-expr-goal').value=eg;
// ì˜¤ë‹µ ìë™ í¬í•¨ ì„¤ì • ë¡œë“œ
const wa=localStorage.getItem('wrongAuto');
document.getElementById('setting-wrong-auto').checked=wa!=='false';
const wl=localStorage.getItem('wrongLimit')||'5';
document.getElementById('setting-wrong-limit').value=wl;
document.getElementById('wrong-limit-val').textContent=wl;
try{await openDB();await updateHomeStats();}catch(e){console.error('Init error:',e);showToast('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜: '+e.message);}
setTimeout(()=>document.getElementById('splash').classList.add('hidden'),800);
}
init();
</script>
</body>
</html>
